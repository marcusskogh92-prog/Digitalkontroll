[{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\App.js","messages":[{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './Screens/ArbetsberedningScreen': Unexpected token { (46:16)","line":13,"column":35,"nodeType":"Literal","endLine":13,"endColumn":68},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './Screens/ArbetsberedningScreen': Unexpected token { (46:16)","line":13,"column":35,"nodeType":"Literal","endLine":13,"endColumn":68},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './Screens/ArbetsberedningScreen': Unexpected token { (46:16)","line":13,"column":35,"nodeType":"Literal","endLine":13,"endColumn":68},{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './Screens/CameraCapture': Unexpected token { (103:28)","line":14,"column":27,"nodeType":"Literal","endLine":14,"endColumn":52},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './Screens/CameraCapture': Unexpected token { (103:28)","line":14,"column":27,"nodeType":"Literal","endLine":14,"endColumn":52},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './Screens/CameraCapture': Unexpected token { (103:28)","line":14,"column":27,"nodeType":"Literal","endLine":14,"endColumn":52},{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './Screens/ControlDetails': Unexpected token { (61:16)","line":15,"column":28,"nodeType":"Literal","endLine":15,"endColumn":54},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './Screens/ControlDetails': Unexpected token { (61:16)","line":15,"column":28,"nodeType":"Literal","endLine":15,"endColumn":54},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './Screens/ControlDetails': Unexpected token { (61:16)","line":15,"column":28,"nodeType":"Literal","endLine":15,"endColumn":54},{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './Screens/EgenkontrollScreen': Unexpected token { (37:18)","line":17,"column":32,"nodeType":"Literal","endLine":17,"endColumn":62},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './Screens/EgenkontrollScreen': Unexpected token { (37:18)","line":17,"column":32,"nodeType":"Literal","endLine":17,"endColumn":62},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './Screens/EgenkontrollScreen': Unexpected token { (37:18)","line":17,"column":32,"nodeType":"Literal","endLine":17,"endColumn":62}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Inter_400Regular, Inter_600SemiBold, Inter_700Bold, useFonts } from '@expo-google-fonts/inter';\r\nimport { Ionicons } from '@expo/vector-icons';\r\nimport { NavigationContainer } from '@react-navigation/native';\r\nimport { createStackNavigator } from '@react-navigation/stack';\r\nimport { Platform, Text, TouchableOpacity, View } from 'react-native';\r\nimport { GestureHandlerRootView } from 'react-native-gesture-handler';\r\n// AppLoading borttagen, ersätts med View och Text\r\n\r\nimport ErrorBoundary from './components/ErrorBoundary';\r\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo, HomeHeaderSearch } from './components/HeaderComponents';\r\n\r\n// Importera skärmar\r\nimport ArbetsberedningScreen from './Screens/ArbetsberedningScreen';\r\nimport CameraCapture from './Screens/CameraCapture';\r\nimport ControlDetails from './Screens/ControlDetails';\r\nimport ControlForm from './Screens/ControlForm';\r\nimport EgenkontrollScreen from './Screens/EgenkontrollScreen';\r\nimport FuktmätningScreen from './Screens/FuktmätningScreen';\r\nimport HomeScreen from './Screens/HomeScreen';\r\nimport LoginScreen from './Screens/LoginScreen';\r\nimport MottagningskontrollScreen from './Screens/MottagningskontrollScreen';\r\nimport ProjectDetails from './Screens/ProjectDetails';\r\nimport RiskbedömningScreen from './Screens/RiskbedömningScreen';\r\nimport SkyddsrondScreen from './Screens/SkyddsrondScreen';\r\n\r\nconst Stack = createStackNavigator();\r\n\r\nfunction ensureWebTitle() {\r\n  if (Platform.OS !== 'web') return;\r\n  if (typeof document === 'undefined') return;\r\n  document.title = 'DigitalKontroll';\r\n}\r\n\r\n\r\n\r\nexport default function App() {\r\n  let [fontsLoaded] = useFonts({\r\n    Inter_400Regular,\r\n    Inter_700Bold,\r\n    Inter_600SemiBold,\r\n  });\r\n  if (!fontsLoaded) {\r\n    return (\r\n      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#fff' }}>\r\n        <Text style={{ fontSize: 18, color: '#222' }}>Laddar typsnitt...</Text>\r\n      </View>\r\n    );\r\n  }\r\n  return (\r\n    <ErrorBoundary>\r\n      <GestureHandlerRootView style={{ flex: 1 }}>\r\n        <NavigationContainer\r\n          documentTitle={{ enabled: false }}\r\n          onReady={ensureWebTitle}\r\n          onStateChange={ensureWebTitle}\r\n        >\r\n          <Stack.Navigator\r\n            initialRouteName=\"Login\"\r\n            screenOptions={({ route, navigation }) => {\r\n              const edgeNudge = Platform.OS === 'web' ? -144 : 0;\r\n              const dkExtraNudge = Platform.OS === 'web' ? -10 : 0;\r\n              return ({\r\n                headerStyle: { backgroundColor: '#FFFFFF', height: 96, paddingLeft: 0, paddingRight: 0, zIndex: 10, overflow: 'visible' },\r\n                headerTintColor: '#000',\r\n                headerTitleStyle: { fontWeight: 'bold', color: '#000', fontFamily: 'Inter_700Bold' },\r\n                headerTitleAlign: 'center',\r\n                headerTitleContainerStyle: { flex: 1, paddingLeft: 0, paddingRight: 0 },\r\n                headerTitle: () => <HomeHeaderSearch navigation={navigation} route={route} />,\r\n                headerLeft: () => (\r\n                  <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\r\n                    <DigitalKontrollHeaderLogo />\r\n                  </View>\r\n                ),\r\n                headerLeftContainerStyle: { width: 260, alignItems: 'flex-start', justifyContent: 'center', marginLeft: edgeNudge + dkExtraNudge, paddingLeft: 0 },\r\n                headerRight: () => (\r\n                  <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\r\n                    <CompanyHeaderLogo companyId={route?.params?.companyId || ''} />\r\n                  </View>\r\n                ),\r\n                headerRightContainerStyle: { width: 260, alignItems: 'flex-end', justifyContent: 'center', marginRight: edgeNudge, paddingRight: 0 },\r\n                headerBackTitleVisible: false,\r\n              });\r\n            }}\r\n          >\r\n            <Stack.Screen name=\"Login\" component={LoginScreen} options={{ title: 'Logga in' }} />\r\n            <Stack.Screen \r\n              name=\"Home\" \r\n              component={HomeScreen} \r\n              options={({ route, navigation }) => {\r\n                const edgeNudge = Platform.OS === 'web' ? -144 : 0;\r\n                const dkExtraNudge = Platform.OS === 'web' ? -10 : 0;\r\n                return ({\r\n                  headerStyle: { backgroundColor: '#FFFFFF', height: 96, paddingLeft: 0, paddingRight: 0, zIndex: 10, overflow: 'visible' },\r\n                headerTitleAlign: 'center',\r\n                headerTitleContainerStyle: { flex: 1, paddingLeft: 0, paddingRight: 0 },\r\n                headerTitle: () => <HomeHeaderSearch navigation={navigation} route={route} />,\r\n                headerLeft: () => (\r\n                  <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\r\n                    <DigitalKontrollHeaderLogo />\r\n                  </View>\r\n                ),\r\n                headerLeftContainerStyle: { width: 260, alignItems: 'flex-start', justifyContent: 'center', marginLeft: edgeNudge + dkExtraNudge, paddingLeft: 0 },\r\n                headerRight: () => (\r\n                  <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\r\n                    <CompanyHeaderLogo companyId={route?.params?.companyId || ''} />\r\n                  </View>\r\n                ),\r\n                headerRightContainerStyle: { width: 260, alignItems: 'flex-end', justifyContent: 'center', marginRight: edgeNudge, paddingRight: 0 },\r\n                headerBackTitleVisible: false,\r\n                });\r\n              }}\r\n            />\r\n            <Stack.Screen name=\"ControlDetails\" component={ControlDetails} options={{ title: 'Kontrolldetaljer' }} />\r\n            <Stack.Screen name=\"ControlForm\" component={ControlForm} options={({ navigation }) => ({\r\n              headerTitle: () => (\r\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                  <Ionicons name=\"checkbox-outline\" size={28} color=\"#7B1FA2\" style={{ marginRight: 10 }} />\r\n                  <Text style={{ fontSize: 24, fontWeight: 'bold', color: '#222' }}>Mottagningskontroll</Text>\r\n                </View>\r\n              ),\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"ArbetsberedningScreen\" component={ArbetsberedningScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"RiskbedömningScreen\" component={RiskbedömningScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"FuktmätningScreen\" component={FuktmätningScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"EgenkontrollScreen\" component={EgenkontrollScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"ProjectDetails\" component={ProjectDetails} options={{ title: 'Projekt' }} />\r\n            <Stack.Screen name=\"SkyddsrondScreen\" component={SkyddsrondScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n            <Stack.Screen name=\"CameraCapture\" component={CameraCapture} options={{ headerShown: false }} />\r\n            <Stack.Screen name=\"MottagningskontrollScreen\" component={MottagningskontrollScreen} options={({ navigation }) => ({\r\n              headerBackTitleVisible: false,\r\n              headerBackTitle: '',\r\n              headerLeft: () => (\r\n                <TouchableOpacity\r\n                  onPress={() => navigation.goBack()}\r\n                  accessibilityLabel=\"Tillbaka\"\r\n                  hitSlop={{ top: 14, bottom: 14, left: 14, right: 14 }}\r\n                  style={{ width: 56, height: 44, justifyContent: 'center', alignItems: 'center', marginLeft: 6 }}\r\n                >\r\n                  <Ionicons name=\"chevron-back\" size={30} color=\"#000\" />\r\n                </TouchableOpacity>\r\n              ),\r\n            })} />\r\n          </Stack.Navigator>\r\n        </NavigationContainer>\r\n      </GestureHandlerRootView>\r\n    </ErrorBoundary>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\BACKUP FILER\\Login.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\ArbetsberedningScreen.js","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token {","line":46,"column":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useRoute } from '@react-navigation/native';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport BaseControlForm from '../components/BaseControlForm';\r\nimport { saveControlToFirestore } from '../components/firebase';\r\n\r\nconst LABELS = {\r\n  title: 'Arbetsberedning',\r\n  saveButton: 'Spara',\r\n  saveDraftButton: 'Spara och slutför senare',\r\n};\r\n\r\nconst ARBETSBEREDNING_CHECKLIST = [\r\n  { label: 'Arbetsbeskrivning', points: ['Syfte och moment tydligt dokumenterat', 'Tidsplan / uppskattad arbetstid', 'Eventuella start- och stopptider'] },\r\n  { label: 'Riskanalys (RAM)', points: ['Identifierade risker listade', 'Föreslagna åtgärder dokumenterade', 'Ansvarig för åtgärder utsedd'] },\r\n  { label: 'Behörighet & utbildning', points: ['Krävs särskilda certifikat?', 'Personal med rätt kompetens närvarande'] },\r\n  { label: 'Tillstånd & lockout', points: ['Arbetstillstånd på plats (t.ex. heta arbeten)', 'El/isolering eller lockout utförd vid behov'] },\r\n  { label: 'Material & verktyg', points: ['Kontrollerat och godkänt material', 'Verktyg inspekterade och säkra'] },\r\n  { label: 'Maskiner & lyft', points: ['Maskiner besiktigade', 'Lyftplan/riggning kontrollerad', 'Konkret ansvar vid lyft'] },\r\n  { label: 'Personlig skyddsutrustning', points: ['Rätt PPE finns och används', 'Reservutrustning tillgänglig'] },\r\n  { label: 'Trafik & avspärrning', points: ['Skyltning/avspärrning planerad', 'Trafikledning utpekad vid behov'] },\r\n  { label: 'Arbetsområde & ordning', points: ['Fallskydd och räcken på plats', 'Gångvägar fria från hinder', 'Tillräcklig belysning'] },\r\n  { label: 'Kommunikation & ansvar', points: ['Kontaktvägar klara', 'Rollfördelning dokumenterad', 'Radio/telefonnummer testade'] },\r\n  { label: 'Nödlarm & första hjälpen', points: ['Förbandslåda och ansvarig utsedd', 'Evakuering-/larmrutiner klara'] },\r\n  { label: 'Miljöhantering', points: ['Kemikalier/läckagerutiner på plats', 'Avfallshantering och spillplan'] },\r\n  { label: 'Dokumentation & foton', points: ['Signaturer på arbetsberedning', 'Fotos för dokumentation vid start'] },\r\n  { label: 'Avslut & överlämning', points: ['Återställning av plats', 'Borttagning av temporära skydd', 'Överlämningsrapport klar'] },\r\n];\r\n\r\nexport default function ArbetsberedningScreen({ date, participants = [], project: projectProp, initialValues: initialValuesProp, onExit, onFinished }) {\r\n  const route = useRoute();\r\n  const project = projectProp ?? route.params?.project;\r\n  const initialValues = initialValuesProp ?? route.params?.initialValues;\r\n\r\n  const handleSave = async (data) => {\r\n    try {\r\n      const completed = {\r\n        ...data,\r\n        project: data.project || project,\r\n        status: 'UTFÖRD',\r\n        savedAt: new Date().toISOString(),\r\n        type: 'Arbetsberedning',\r\n        id: data.id || uuidv4(),\r\n      };\r\n      // Central helper handles permission-denied and local fallback.\r\n      await saveControlToFirestore(completed);\r\n    } catch(_e {\r\n      alert('Kunde inte spara kontrollen: ' + (e && e.message ? e.message : String(e)));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <BaseControlForm\r\n      date={date}\r\n      controlType=\"Arbetsberedning\"\r\n      checklistConfig={ARBETSBEREDNING_CHECKLIST}\r\n      labels={LABELS}\r\n      participants={participants}\r\n      project={project}\r\n      onSave={handleSave}\r\n      initialValues={initialValues}\r\n      onExit={onExit}\r\n      onFinished={onFinished}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\CameraCapture.js","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token {","line":103,"column":28}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import MaterialIcons from '@expo/vector-icons/MaterialIcons';\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { CommonActions, useNavigation, useRoute } from '@react-navigation/native';\r\nimport * as CameraModule from 'expo-camera';\r\nimport { Camera } from 'expo-camera';\r\nimport * as ImageManipulator from 'expo-image-manipulator';\r\nimport * as ImagePicker from 'expo-image-picker';\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport { Alert, Image, KeyboardAvoidingView, Platform, ScrollView, StyleSheet, Text, TextInput, TouchableOpacity, View } from 'react-native';\r\n\r\nconst PRIMARY = '#263238';\r\n\r\nexport default function CameraCapture() {\r\n  const navigation = useNavigation();\r\n  const route = useRoute();\r\n  const { sectionIdx, pointIdx, project } = route.params || {};\r\n  const [hasPermission, setHasPermission] = useState(null);\r\n  const [cameraRef, setCameraRef] = useState(null);\r\n  const [isCapturing, setIsCapturing] = useState(false);\r\n  const [photoPreview, setPhotoPreview] = useState(null);\r\n  const [photoComment, setPhotoComment] = useState('');\r\n  const [orientation, setOrientation] = useState('portrait');\r\n  const [pictureSize, setPictureSize] = useState(null);\r\n  const cameraViewRef = useRef(null);\r\n  const scrollRef = useRef(null);\r\n  // Resolve Camera component robustly across Expo versions / bundlers\r\n  // We will pick the first entry that is actually a renderable component (function/class)\r\n  let CameraComponent = null;\r\n  let resolvedInfo = { type: 'unknown', keys: [] };\r\n  try {\r\n    // Prefer CameraView if available (some builds expose CameraView as the host component)\r\n    if (CameraModule && CameraModule.CameraView) {\r\n      CameraComponent = CameraModule.CameraView;\r\n      resolvedInfo = { type: 'CameraView', keys: Object.keys(CameraModule || {}) };\r\n    } else if (CameraModule && CameraModule.Camera) {\r\n      CameraComponent = CameraModule.Camera;\r\n      resolvedInfo = { type: 'Camera', keys: Object.keys(CameraModule || {}) };\r\n    } else if (Camera) {\r\n      CameraComponent = Camera;\r\n      resolvedInfo = { type: 'expo-camera Camera', keys: [] };\r\n    } else {\r\n      resolvedInfo = { type: 'none', keys: Object.keys(CameraModule || {}) };\r\n    }\r\n  } catch(e) {\r\n    resolvedInfo = { type: 'error', keys: Object.keys(CameraModule || {}), error: String(e) };\r\n  }\r\n  const handlePickFromLibrary = async () => {\r\n    try {\r\n      let perm = null;\r\n      if (typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\r\n        perm = await ImagePicker.getMediaLibraryPermissionsAsync();\r\n      }\r\n      if (!perm || !(perm.granted === true || perm.status === 'granted')) {\r\n        perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n      }\r\n      const ok = (perm && (perm.granted === true || perm.status === 'granted'));\r\n      if (!ok) {\r\n        Alert.alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\r\n        return;\r\n      }\r\n      const mediaTypesOption = (ImagePicker && ImagePicker.MediaType && ImagePicker.MediaType.Images) ? ImagePicker.MediaType.Images : undefined;\r\n      const pickerOptions = { quality: 0.8 };\r\n      if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\r\n      const res = await ImagePicker.launchImageLibraryAsync(pickerOptions);\r\n      const extractAssets = (r) => {\r\n        if (!r) return [];\r\n        if (Array.isArray(r.assets) && r.assets.length) return r.assets;\r\n        if (Array.isArray(r.selectedAssets) && r.selectedAssets.length) return r.selectedAssets;\r\n        if (r.uri) return [{ uri: r.uri }];\r\n        if (r.cancelled === false && r.uri) return [{ uri: r.uri }];\r\n        return [];\r\n      };\r\n      const assets = extractAssets(res);\r\n      if (assets && assets.length > 0) {\r\n        // Skapa samma payload som vid foto\r\n        const photos = assets.map(a => {\r\n          const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\r\n          return uri ? { uri, comment: '' } : null;\r\n        }).filter(Boolean);\r\n        if (photos.length > 0) {\r\n          const target = route.params?.returnScreen || 'SkyddsrondScreen';\r\n          const payload = {\r\n            cameraResult: {\r\n              uri: photos[0].uri, // För kompatibilitet, men vi skickar alla i returnedMottagningsPhotos\r\n              sectionIdx,\r\n              pointIdx,\r\n              returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat(photos),\r\n            },\r\n            project,\r\n          };\r\n          const returnKey = route.params?.returnKey;\r\n          if (returnKey) {\r\n            try {\r\n              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: returnKey }));\r\n            } catch(e) {}\r\n            try {\r\n              (async () => {\r\n                try {\r\n                  const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\r\n                  const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\r\n                  pending.push(payload.cameraResult);\r\n                  await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\r\n                } catch(_e {}\r\n              })();\r\n            } catch(e) {}\r\n            setTimeout(() => { try { navigation.goBack(); } catch(_e {} }, 300);\r\n          } else {\r\n            try {\r\n              const state = navigation.getState && navigation.getState();\r\n              if (state && Array.isArray(state.routes)) {\r\n                const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\r\n                const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\r\n                if (prevRoute && prevRoute.key) {\r\n                  try {\r\n                    navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\r\n                  } catch(_e {}\r\n                  try {\r\n                    (async () => {\r\n                      const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\r\n                      const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\r\n                      pending.push(payload.cameraResult);\r\n                      await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\r\n                    })();\r\n                  } catch(e) {}\r\n                  setTimeout(() => { try { navigation.goBack(); } catch(e) {} }, 300);\r\n                } else {\r\n                  navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n                }\r\n              } else {\r\n                navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n              }\r\n            } catch(e) {\r\n              navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch(e) {\r\n      Alert.alert('Kunde inte välja bild: ' + (e?.message || e));\r\n    }\r\n  };\r\n\r\n  // Ta bort automatisk kamerabehörighetskontroll vid mount\r\n\r\n\r\n  const handleCapture = async () => {\r\n    try {\r\n      // Kontrollera kamerabehörighet först\r\n      let perm = null;\r\n      const tryFns = [\r\n        'getCameraPermissionsAsync',\r\n        'requestCameraPermissionsAsync',\r\n        'getPermissionsAsync',\r\n        'requestPermissionsAsync'\r\n      ];\r\n      for (const fn of tryFns) {\r\n        try {\r\n          if (CameraModule && typeof CameraModule[fn] === 'function') {\r\n            perm = await CameraModule[fn]();\r\n            if (perm) break;\r\n          }\r\n          if (CameraModule && CameraModule.Camera && typeof CameraModule.Camera[fn] === 'function') {\r\n            perm = await CameraModule.Camera[fn]();\r\n            if (perm) break;\r\n          }\r\n        } catch(e) {}\r\n      }\r\n      const status = perm && (perm.status || (perm.granted ? 'granted' : 'denied'));\r\n      if (status !== 'granted') {\r\n        Alert.alert('Kamerabehörighet krävs', 'Appen har inte tillgång till kameran. Gå till inställningar och ge behörighet om du vill ta foto.', [{ text: 'OK', onPress: () => {} }]);\r\n        return;\r\n      }\r\n      if (!cameraRef || isCapturing) return;\r\n      setIsCapturing(true);\r\n      const options = { quality: 0.8 };\r\n      if (pictureSize) options.pictureSize = pictureSize;\r\n      const photo = await cameraRef.takePictureAsync(options);\r\n\r\n      let finalPhoto = photo;\r\n      if (orientation === 'portrait' && photo && photo.width && photo.height) {\r\n        const targetRatio = 4 / 3;\r\n        const actualRatio = photo.height / photo.width;\r\n        if (Math.abs(actualRatio - targetRatio) > 0.01) {\r\n          const cropWidth = photo.width;\r\n          const cropHeight = Math.round(photo.width * 4 / 3);\r\n          if (cropHeight <= photo.height) {\r\n            const cropOriginY = Math.round((photo.height - cropHeight) / 2);\r\n            const manipResult = await ImageManipulator.manipulateAsync(\r\n              photo.uri,\r\n              [{ crop: { originX: 0, originY: cropOriginY, width: cropWidth, height: cropHeight } }],\r\n              { compress: 0.9, format: ImageManipulator.SaveFormat.JPEG }\r\n            );\r\n            finalPhoto = { ...manipResult, _orientation: orientation };\r\n          } else {\r\n            finalPhoto = { ...photo, _orientation: orientation };\r\n          }\r\n        } else {\r\n          finalPhoto = { ...photo, _orientation: orientation };\r\n        }\r\n      } else {\r\n        finalPhoto = { ...photo, _orientation: orientation };\r\n      }\r\n\r\n      setPhotoPreview(finalPhoto);\r\n      setPhotoComment('');\r\n    } catch(e) {\r\n      Alert.alert('Fel vid fotografering', String(e?.message || e));\r\n    } finally {\r\n      setIsCapturing(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // placeholder for autoSave behavior\r\n  }, [route.params?.autoSave]);\r\n\r\n  const checkCameraPermission = async () => {\r\n    try {\r\n      let perm = null;\r\n      const tryFns = [\r\n        'getCameraPermissionsAsync',\r\n        'requestCameraPermissionsAsync',\r\n        'getPermissionsAsync',\r\n        'requestPermissionsAsync'\r\n      ];\r\n      for (const fn of tryFns) {\r\n        try {\r\n          if (CameraModule && typeof CameraModule[fn] === 'function') {\r\n            perm = await CameraModule[fn]();\r\n            if (perm) break;\r\n          }\r\n          if (CameraModule && CameraModule.Camera && typeof CameraModule.Camera[fn] === 'function') {\r\n            perm = await CameraModule.Camera[fn]();\r\n            if (perm) break;\r\n          }\r\n        } catch(e) {}\r\n      }\r\n      const status = perm && (perm.status || (perm.granted ? 'granted' : 'denied'));\r\n      setHasPermission(status === 'granted' ? true : false);\r\n      return status === 'granted';\r\n    } catch(e) {\r\n      setHasPermission(false);\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Visa endast fallback om hasPermission === false\r\n  if (hasPermission === false) {\r\n    return (\r\n      <View style={styles.container}>\r\n        <Text style={{ color: '#D32F2F', marginBottom: 12, fontWeight: 'bold' }}>Kamerabehörighet nekad.</Text>\r\n        <Text style={{ color: '#666', marginBottom: 12, textAlign: 'center' }}>\r\n          Appen har inte tillgång till kameran. Gå till inställningar och ge behörighet, starta om appen och försök igen.\r\n        </Text>\r\n        <View style={{ flexDirection: 'row', gap: 12 }}>\r\n          <TouchableOpacity style={styles.secondaryAction} onPress={() => navigation.goBack()}>\r\n            <MaterialIcons name=\"arrow-back\" size={18} color={PRIMARY} />\r\n            <Text style={styles.secondaryActionText}>Tillbaka</Text>\r\n          </TouchableOpacity>\r\n          <TouchableOpacity style={[styles.secondaryAction, { marginLeft: 12 }]} onPress={() => checkCameraPermission()}>\r\n            <MaterialIcons name=\"autorenew\" size={18} color={PRIMARY} />\r\n            <Text style={styles.secondaryActionText}>Be om behörighet</Text>\r\n          </TouchableOpacity>\r\n        </View>\r\n      </View>\r\n    );\r\n  }\r\n\r\n  if (photoPreview) {\r\n    const isPortrait = photoPreview._orientation === 'portrait';\r\n    const aspectRatio = isPortrait ? 3 / 4 : 4 / 3;\r\n    return (\r\n      <KeyboardAvoidingView style={{ flex: 1, backgroundColor: '#000' }} behavior={Platform.OS === 'ios' ? 'padding' : 'position'} keyboardVerticalOffset={Platform.OS === 'ios' ? 80 : 120}>\r\n        <ScrollView ref={scrollRef} contentContainerStyle={{ flexGrow: 1, justifyContent: 'flex-start', alignItems: 'center', paddingTop: 24 }} keyboardShouldPersistTaps=\"handled\">\r\n          <Image\r\n          source={{ uri: photoPreview.uri }}\r\n          style={{\r\n            width: isPortrait ? '92%' : undefined,\r\n            height: isPortrait ? undefined : '68%',\r\n            aspectRatio,\r\n            borderRadius: 16,\r\n            marginTop: 24,\r\n            marginBottom: 12,\r\n            maxWidth: 420,\r\n            maxHeight: 420,\r\n            resizeMode: 'contain',\r\n            backgroundColor: '#111',\r\n          }}\r\n        />\r\n          <View style={{ width: '92%', marginTop: 12 }}>\r\n          <Text style={{ color: '#fff', marginBottom: 6 }}>Kommentar</Text>\r\n          <TextInput\r\n            value={photoComment}\r\n            onChangeText={(t) => setPhotoComment(t)}\r\n            placeholder=\"Lägg till kommentar till bilden...\"\r\n            placeholderTextColor=\"#ddd\"\r\n            multiline\r\n            numberOfLines={3}\r\n            blurOnSubmit={true}\r\n            onFocus={() => {\r\n              // Delay to allow keyboard to open then scroll the input into view\r\n              setTimeout(() => { try { scrollRef.current && scrollRef.current.scrollToEnd({ animated: true }); } catch(e) {} }, 120);\r\n            }}\r\n            returnKeyType=\"done\"\r\n            onSubmitEditing={() => { try { /* dismiss keyboard */ } catch(e) {} }}\r\n            style={{ backgroundColor: 'rgba(255,255,255,0.06)', padding: 8, borderRadius: 8, color: '#fff', minHeight: 48 }}\r\n          />\r\n        </View>\r\n        <View style={styles.previewButtonBar}>\r\n          <TouchableOpacity\r\n            style={[styles.previewButton, styles.previewButtonRetake]}\r\n            onPress={() => { setPhotoPreview(null); setPhotoComment(''); }}\r\n            activeOpacity={0.8}\r\n          >\r\n            <MaterialIcons name=\"refresh\" size={22} color={PRIMARY} style={{ marginBottom: 2 }} />\r\n            <Text style={styles.previewButtonTextRetake}>Ta om</Text>\r\n          </TouchableOpacity>\r\n          <TouchableOpacity\r\n            style={[styles.previewButton, styles.previewButtonSave]}\r\n            onPress={() => {\r\n              const target = route.params?.returnScreen || 'SkyddsrondScreen';\r\n              // Merge params into the existing route instead of pushing a new instance\r\n              try {\r\n                  // If caller provided `returnKey`, set params directly on that route (no remount).\r\n                  const payload = {\r\n                    cameraResult: {\r\n                      uri: photoPreview.uri,\r\n                      sectionIdx,\r\n                      pointIdx,\r\n                      returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat({ uri: photoPreview.uri, comment: photoComment || '' }),\r\n                    },\r\n                    project,\r\n                  };\r\n                  // Removed debug logging\r\n                  try {\r\n                    const returnKey = route.params?.returnKey;\r\n                    if (returnKey) {\r\n                      try {\r\n                        navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: returnKey }));\r\n                      } catch(e) {}\r\n                      try {\r\n                        const state = navigation.getState && navigation.getState();\r\n                        if (state && Array.isArray(state.routes)) {\r\n                          const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\r\n                          const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\r\n                          if (prevRoute && prevRoute.key) {\r\n                            try {\r\n                              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\r\n                            } catch(e) {}\r\n                          }\r\n                        }\r\n                      } catch(e) {}\r\n                      try {\r\n                        (async () => {\r\n                          try {\r\n                            const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\r\n                            const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\r\n                            pending.push(payload.cameraResult);\r\n                            await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\r\n                          } catch(e) {}\r\n                        })();\r\n                      } catch(e) {}\r\n                      setTimeout(() => {\r\n                        try { navigation.goBack(); } catch(e) {};\r\n                      }, 300);\r\n                    } else {\r\n                      try {\r\n                        const state = navigation.getState && navigation.getState();\r\n                        if (state && Array.isArray(state.routes)) {\r\n                          const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\r\n                          const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\r\n                            if (prevRoute && prevRoute.key) {\r\n                            try {\r\n                              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\r\n                            } catch(e) {}\r\n                            try {\r\n                              (async () => {\r\n                                const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\r\n                                const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\r\n                                pending.push(payload.cameraResult);\r\n                                await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\r\n                              })();\r\n                            } catch(e) {}\r\n                            setTimeout(() => { try { navigation.goBack(); } catch(e) {} }, 300);\r\n                          } else {\r\n                            navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n                          }\r\n                        } else {\r\n                          navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n                        }\r\n                      } catch(e) {\r\n                        navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\r\n                      }\r\n                    }\r\n                  } catch(e) {\r\n                    navigation.navigate(target, payload);\r\n                  }\r\n              } catch(e) {\r\n                navigation.navigate(target, {\r\n                  cameraResult: {\r\n                    uri: photoPreview.uri,\r\n                    sectionIdx,\r\n                    pointIdx,\r\n                    returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat({ uri: photoPreview.uri, comment: photoComment || '' }),\r\n                  },\r\n                  project,\r\n                });\r\n              }\r\n            }}\r\n            activeOpacity={0.8}\r\n          >\r\n            <MaterialIcons name=\"save\" size={28} color=\"#fff\" style={{ marginBottom: 2 }} />\r\n          </TouchableOpacity>\r\n        </View>\r\n      </ScrollView>\r\n    </KeyboardAvoidingView>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <View style={{ flex: 1, backgroundColor: '#000' }}>\r\n      {(CameraComponent) ? (\r\n      <CameraComponent\r\n        style={{ flex: 1 }}\r\n        ref={ref => {\r\n          setCameraRef(ref);\r\n          cameraViewRef.current = ref;\r\n        }}\r\n        ratio={orientation === 'portrait' ? '3:4' : '4:3'}\r\n        pictureSize={pictureSize}\r\n      />\r\n      ) : (\r\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n          <Text style={{ color: '#fff', marginBottom: 12 }}>Kunde inte ladda kamerakomponent.</Text>\r\n          <Text style={{ color: '#fff', marginBottom: 6, fontSize: 12, opacity: 0.9 }}>\r\n            {'Debug: ' + resolvedInfo.type + (Array.isArray(resolvedInfo.keys) && resolvedInfo.keys.length ? ' (' + resolvedInfo.keys.join(', ') + ')' : '')}\r\n          </Text>\r\n          <TouchableOpacity onPress={() => checkCameraPermission()} style={{ padding: 10, backgroundColor: '#fff', borderRadius: 8 }}>\r\n            <Text style={{ color: PRIMARY }}>Försök igen</Text>\r\n          </TouchableOpacity>\r\n        </View>\r\n      )}\r\n      {/* Avbryt-knapp i övre vänstra hörnet */}\r\n      <TouchableOpacity style={styles.cancelButton} onPress={() => navigation.goBack()}>\r\n        <MaterialIcons name=\"close\" size={28} color={PRIMARY} />\r\n      </TouchableOpacity>\r\n      {/* Stor foto-knapp: mitten nedtill (porträtt) eller mitten till höger (landskap) */}\r\n      {orientation === 'portrait' ? (\r\n        <View style={styles.cameraButtonBarPortrait} pointerEvents=\"box-none\">\r\n          <TouchableOpacity\r\n            style={styles.cameraButton}\r\n            onPress={handleCapture}\r\n            disabled={isCapturing}\r\n            activeOpacity={0.7}\r\n          >\r\n            <MaterialIcons name=\"photo-camera\" size={44} color=\"#fff\" />\r\n          </TouchableOpacity>\r\n          <View style={styles.libraryButtonWrapperPortrait} pointerEvents=\"box-none\">\r\n            <TouchableOpacity\r\n              style={[styles.cameraButton, styles.libraryButton]}\r\n              onPress={handlePickFromLibrary}\r\n              activeOpacity={0.7}\r\n            >\r\n              <MaterialIcons name=\"photo-library\" size={28} color={PRIMARY} />\r\n              <Text style={{ color: PRIMARY, fontWeight: 'bold', fontSize: 10, marginTop: 2 }}>Bibliotek</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      ) : (\r\n        <View style={styles.cameraButtonBarLandscape} pointerEvents=\"box-none\">\r\n          <TouchableOpacity\r\n            style={styles.cameraButton}\r\n            onPress={handleCapture}\r\n            disabled={isCapturing}\r\n            activeOpacity={0.7}\r\n          >\r\n            <MaterialIcons name=\"photo-camera\" size={44} color=\"#fff\" />\r\n          </TouchableOpacity>\r\n          <View style={styles.libraryButtonWrapperLandscape} pointerEvents=\"box-none\">\r\n            <TouchableOpacity\r\n              style={[styles.cameraButton, styles.libraryButton]}\r\n              onPress={handlePickFromLibrary}\r\n              activeOpacity={0.7}\r\n            >\r\n              <MaterialIcons name=\"photo-library\" size={28} color={PRIMARY} />\r\n              <Text style={{ color: PRIMARY, fontWeight: 'bold', fontSize: 10, marginTop: 2 }}>Bibliotek</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      )}\r\n    </View>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, backgroundColor: '#fff', alignItems: 'center', justifyContent: 'center', padding: 16 },\r\n  previewButtonBar: {\r\n    flexDirection: 'row',\r\n    justifyContent: 'space-between',\r\n    alignItems: 'center',\r\n    marginTop: 12,\r\n    marginBottom: 18,\r\n    paddingHorizontal: 18,\r\n  },\r\n  previewButton: {\r\n    flexDirection: 'column',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    borderRadius: 20,\r\n    minWidth: 86,\r\n    paddingVertical: 8,\r\n    paddingHorizontal: 12,\r\n    marginHorizontal: 6,\r\n    elevation: 3,\r\n    shadowColor: '#000',\r\n    shadowOffset: { width: 0, height: 1 },\r\n    shadowOpacity: 0.12,\r\n    shadowRadius: 4,\r\n  },\r\n  previewButtonRetake: {\r\n    backgroundColor: '#fff',\r\n    borderWidth: 2,\r\n    borderColor: PRIMARY,\r\n  },\r\n  previewButtonSave: {\r\n    backgroundColor: PRIMARY,\r\n    borderWidth: 2,\r\n    borderColor: '#fff',\r\n  },\r\n  previewButtonTextRetake: {\r\n    color: PRIMARY,\r\n    fontWeight: '700',\r\n    fontSize: 14,\r\n    marginTop: 4,\r\n    letterSpacing: 0.2,\r\n  },\r\n  previewButtonTextSave: {\r\n    color: '#fff',\r\n    fontWeight: '700',\r\n    fontSize: 14,\r\n    marginTop: 4,\r\n    letterSpacing: 0.2,\r\n  },\r\n  // ...existing code...\r\n  cancelButton: {\r\n    position: 'absolute',\r\n    top: 36,\r\n    left: 20,\r\n    zIndex: 10,\r\n    backgroundColor: 'rgba(255,255,255,0.85)',\r\n    borderRadius: 24,\r\n    padding: 6,\r\n    elevation: 2,\r\n  },\r\n  cameraButtonBarPortrait: {\r\n    position: 'absolute',\r\n    left: 0,\r\n    right: 0,\r\n    bottom: 36,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    zIndex: 5,\r\n    pointerEvents: 'box-none',\r\n  },\r\n  libraryButtonWrapperPortrait: {\r\n    position: 'absolute',\r\n    right: 24,\r\n    bottom: 0,\r\n    zIndex: 10,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    pointerEvents: 'box-none',\r\n  },\r\n  libraryButtonWrapperLandscape: {\r\n    position: 'absolute',\r\n    right: 24,\r\n    top: '60%',\r\n    zIndex: 10,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    pointerEvents: 'box-none',\r\n  },\r\n  libraryButton: {\r\n    backgroundColor: '#fff',\r\n    borderColor: PRIMARY,\r\n    marginTop: 0,\r\n    width: 60,\r\n    height: 60,\r\n    borderRadius: 30,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    paddingHorizontal: 0,\r\n    paddingVertical: 0,\r\n    minWidth: 0,\r\n    elevation: 4,\r\n    shadowColor: '#000',\r\n    shadowOffset: { width: 0, height: 2 },\r\n    shadowOpacity: 0.3,\r\n    shadowRadius: 6,\r\n  },\r\n  cameraButtonBarLandscape: {\r\n    position: 'absolute',\r\n    right: 36,\r\n    top: '50%',\r\n    transform: [{ translateY: 0 }],\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    zIndex: 5,\r\n    pointerEvents: 'box-none',\r\n  },\r\n  cameraButton: {\r\n    width: 80,\r\n    height: 80,\r\n    borderRadius: 40,\r\n    backgroundColor: PRIMARY,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    borderWidth: 4,\r\n    borderColor: '#fff',\r\n    shadowColor: '#000',\r\n    shadowOffset: { width: 0, height: 2 },\r\n    shadowOpacity: 0.3,\r\n    shadowRadius: 6,\r\n    elevation: 4,\r\n  },\r\n  secondaryAction: {\r\n    flexDirection: 'row',\r\n    alignItems: 'center',\r\n    paddingVertical: 8,\r\n    paddingHorizontal: 12,\r\n    borderRadius: 8,\r\n    backgroundColor: 'transparent'\r\n  },\r\n  secondaryActionText: {\r\n    color: PRIMARY,\r\n    marginLeft: 8,\r\n    fontSize: 14,\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\ControlDetails.js","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token {","line":61,"column":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\r\nimport Ionicons from '@expo/vector-icons/Ionicons';\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useNavigation } from '@react-navigation/native';\r\nimport * as ImagePicker from 'expo-image-picker';\r\nimport { useEffect, useMemo, useState } from 'react';\r\nimport { Alert, Platform, TextInput } from 'react-native';\r\n// import { Ionicons } from '@expo/vector-icons';\r\nimport { Image, Modal, Pressable, ScrollView, StyleSheet, Text, TouchableOpacity, View, useWindowDimensions } from 'react-native';\r\nimport SignatureModal from '../components/SignatureModal';\r\nimport { resolveCompanyLogoUrl } from '../components/firebase';\r\n\r\nconst CONTROL_TYPE_ICONS = {\r\n  'Arbetsberedning': { icon: 'construct-outline', color: '#1976D2', label: 'Arbetsberedning' },\r\n  'Egenkontroll': { icon: 'checkmark-done-outline', color: '#388E3C', label: 'Egenkontroll' },\r\n  'Fuktmätning': { icon: 'water-outline', color: '#0288D1', label: 'Fuktmätning' },\r\n  'Mottagningskontroll': { icon: 'checkbox-outline', color: '#7B1FA2', label: 'Mottagningskontroll' },\r\n  'Riskbedömning': { icon: 'warning-outline', color: '#FFD600', label: 'Riskbedömning' },\r\n  'Skyddsrond': { icon: 'shield-half-outline', color: '#388E3C', label: 'Skyddsrond' },\r\n};\r\n\r\nconst PRIMARY = '#263238';\r\nconst A4_WEB_MAX_WIDTH = 794; // ~210mm at 96dpi\r\nconst META_ICON_COLOR = '#1976D2';\r\n\r\nexport default function ControlDetails({ route }) {\r\n  const { height: windowHeight } = useWindowDimensions();\r\n  // Modal state for åtgärd\r\n  const [actionModal, setActionModal] = useState({ visible: false, section: '', point: '', img: null, comment: '', signature: '', name: '', date: '' });\r\n  const navigation = useNavigation();\r\n  const [photoModalVisible, setPhotoModalVisible] = useState(false);\r\n  const [selectedPhoto, setSelectedPhoto] = useState(null);\r\n  const { control, project, companyId: routeCompanyId } = route.params || {};\r\n  if (!control) {\r\n    return (\r\n      <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>\r\n        <Text style={{ color: '#555' }}>Kunde inte hitta kontrollen.</Text>\r\n      </View>\r\n    );\r\n  }\r\n\r\n  const [controlState, setControlState] = useState(control);\r\n  useEffect(() => {\r\n    setControlState(control);\r\n  }, [control?.id]);\r\n\r\n  const hasAnyChecklistPoints = (c) => {\r\n    try {\r\n      const sections = Array.isArray(c?.checklist)\r\n        ? c.checklist\r\n        : (Array.isArray(c?.checklistSections) ? c.checklistSections : []);\r\n      if (!Array.isArray(sections) || sections.length === 0) return false;\r\n      for (const sec of sections) {\r\n        const pts = Array.isArray(sec?.points)\r\n          ? sec.points\r\n          : (Array.isArray(sec?.items) ? sec.items : []);\r\n        if (Array.isArray(pts) && pts.length > 0) return true;\r\n      }\r\n      return false;\r\n    } catch(_e {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // If we navigated here with a thin control object (common on web lists), hydrate from AsyncStorage.\r\n  useEffect(() => {\r\n    let active = true;\r\n    (async () => {\r\n      try {\r\n        const current = (controlState && typeof controlState === 'object') ? controlState : (control || {});\r\n        if (hasAnyChecklistPoints(current)) return;\r\n\r\n        const id = current?.id || control?.id;\r\n        const projectId = current?.project?.id || project?.id;\r\n        const type = current?.type;\r\n        const savedAt = current?.savedAt;\r\n        const date = current?.date;\r\n\r\n        const tryHydrateFromKey = async (key) => {\r\n          const raw = await AsyncStorage.getItem(key);\r\n          if (!raw) return null;\r\n          const arr = JSON.parse(raw);\r\n          const list = Array.isArray(arr) ? arr : [];\r\n\r\n          if (id) {\r\n            const byId = list.find(x => x && x.id && String(x.id) === String(id));\r\n            if (byId) return byId;\r\n          }\r\n\r\n          // Best-effort fallback for legacy items without stable id\r\n          if (projectId && type) {\r\n            const byMeta = list.find(x => (\r\n              x\r\n              && String(x?.project?.id || '') === String(projectId)\r\n              && String(x?.type || '') === String(type)\r\n              && (savedAt ? String(x?.savedAt || '') === String(savedAt) : true)\r\n              && (date ? String(x?.date || '') === String(date) : true)\r\n            ));\r\n            if (byMeta) return byMeta;\r\n          }\r\n          return null;\r\n        };\r\n\r\n        const found = (await tryHydrateFromKey('completed_controls'))\r\n          || (await tryHydrateFromKey('draft_controls'))\r\n          || null;\r\n\r\n        if (!found) return;\r\n        // Only replace if it actually brings more data (especially checklist)\r\n        if (!hasAnyChecklistPoints(found) && !hasAnyChecklistPoints(current)) return;\r\n        if (active) setControlState(found);\r\n      } catch(_e {\r\n        // ignore hydration errors\r\n      }\r\n    })();\r\n    return () => { active = false; };\r\n  }, [control?.id, project?.id]);\r\n\r\n  const safeControl = (controlState && typeof controlState === 'object') ? controlState : {};\r\n  const type = safeControl.type;\r\n  const date = safeControl.date;\r\n  const deliveryDesc = safeControl.deliveryDesc;\r\n  const description = safeControl.description;\r\n  const generalNote = safeControl.generalNote;\r\n  const materialDesc = safeControl.materialDesc || safeControl.material;\r\n  const qualityDesc = safeControl.qualityDesc;\r\n  const coverageDesc = safeControl.coverageDesc;\r\n  const participants = Array.isArray(safeControl.participants) ? safeControl.participants : [];\r\n  const checklistRaw = Array.isArray(safeControl.checklist)\r\n    ? safeControl.checklist\r\n    : (Array.isArray(safeControl.checklistSections) ? safeControl.checklistSections : []);\r\n  const status = safeControl.status;\r\n  const weather = safeControl.weather;\r\n  const mottagningsPhotos = Array.isArray(safeControl.mottagningsPhotos) ? safeControl.mottagningsPhotos : [];\r\n  const mottagningsSignatures = Array.isArray(safeControl.mottagningsSignatures) ? safeControl.mottagningsSignatures : [];\r\n  const attachments = Array.isArray(safeControl.attachments) ? safeControl.attachments : [];\r\n\r\n  const [companyLogoUrl, setCompanyLogoUrl] = useState(null);\r\n  useEffect(() => {\r\n    let active = true;\r\n    (async () => {\r\n      try {\r\n        const stored = await AsyncStorage.getItem('dk_companyId');\r\n        const cid = (\r\n          routeCompanyId\r\n          || project?.companyId\r\n          || safeControl?.companyId\r\n          || safeControl?.company\r\n          || stored\r\n          || ''\r\n        ).trim();\r\n        if (!cid) return;\r\n        const url = await resolveCompanyLogoUrl(cid);\r\n        if (active) setCompanyLogoUrl(url || null);\r\n      } catch(_e {}\r\n    })();\r\n    return () => { active = false; };\r\n  }, [routeCompanyId, project?.companyId, project?.id]);\r\n\r\n  const formatYmd = (value) => {\r\n    if (!value) return '-';\r\n    let v = value;\r\n    try {\r\n      // Firestore Timestamp support\r\n      if (v && typeof v === 'object') {\r\n        if (typeof v.toDate === 'function') v = v.toDate();\r\n        else if (typeof v.toMillis === 'function') v = new Date(v.toMillis());\r\n        else if (typeof v.seconds === 'number') v = new Date(v.seconds * 1000);\r\n        else if (typeof v._seconds === 'number') v = new Date(v._seconds * 1000);\r\n        else if (typeof v.nanoseconds === 'number' && typeof v.seconds === 'number') v = new Date(v.seconds * 1000);\r\n        else if (typeof v._nanoseconds === 'number' && typeof v._seconds === 'number') v = new Date(v._seconds * 1000);\r\n      }\r\n    } catch(_e {}\r\n\r\n    const d = new Date(v);\r\n    if (isNaN(d.getTime())) return String(value);\r\n    return d.toISOString().slice(0, 10);\r\n  };\r\n\r\n  const upsertControlInStorage = async (updated) => {\r\n    const isDraft = !!updated?.isDraft;\r\n    const key = isDraft ? 'draft_controls' : 'completed_controls';\r\n    const raw = await AsyncStorage.getItem(key);\r\n    const list = raw ? JSON.parse(raw) : [];\r\n    const arr = Array.isArray(list) ? list : [];\r\n    const id = updated?.id;\r\n    if (!id) throw new Error('Kontrollen saknar id');\r\n    const idx = arr.findIndex(c => c && c.id === id);\r\n    if (idx !== -1) arr[idx] = updated;\r\n    else arr.push(updated);\r\n    await AsyncStorage.setItem(key, JSON.stringify(arr));\r\n  };\r\n\r\n  // Format week number\r\n  function getWeek(dateStr) {\r\n    if (!dateStr) return '';\r\n    const d = new Date(dateStr);\r\n    d.setHours(0, 0, 0, 0);\r\n    d.setDate(d.getDate() + 4 - (d.getDay() || 7));\r\n    const yearStart = new Date(d.getFullYear(), 0, 1);\r\n    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\r\n    return weekNo;\r\n  }\r\n  const week = getWeek(date);\r\n  // Status text\r\n  const statusText = status === 'UTFÖRD' || status === 'Slutförd' ? 'Slutförd' : 'Pågående';\r\n  const isCompleted = statusText === 'Slutförd' && !safeControl.isDraft;\r\n  const participantsLabel = type === 'Mottagningskontroll' ? 'Mottagare' : 'Deltagare';\r\n\r\n  // Checklist points: group by section, show approved and deviation points with icons\r\n  // checklistSections ska alltid innehålla remediation-objekt\r\n  const checklistSections = useMemo(() => {\r\n    const coerceArrayLike = (v) => {\r\n      if (Array.isArray(v)) return v;\r\n      if (v && typeof v === 'object') {\r\n        const keys = Object.keys(v)\r\n          .filter(k => String(parseInt(k, 10)) === k)\r\n          .map(k => parseInt(k, 10))\r\n          .sort((a, b) => a - b);\r\n        if (!keys.length) return [];\r\n        const arr = [];\r\n        keys.forEach(k => { arr[k] = v[k]; });\r\n        return arr;\r\n      }\r\n      return [];\r\n    };\r\n\r\n    const normalizePointText = (pt) => {\r\n      if (typeof pt === 'string') return pt;\r\n      if (pt && typeof pt === 'object') return pt.text || pt.label || pt.name || '';\r\n      return '';\r\n    };\r\n\r\n    const normalizeStatus = (v) => {\r\n      if (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') return v;\r\n      if (v === true) return 'ok';\r\n      if (v === false) return 'avvikelse';\r\n      const s = String(v ?? '').trim().toLowerCase();\r\n      if (!s) return null;\r\n      if (['ok', 'approved', 'godkänd', 'godkand', 'ja', 'yes', 'true', 'green', 'grön', 'gron'].includes(s)) return 'ok';\r\n      if (['avvikelse', 'deviation', 'nej', 'no', 'false', 'fail', 'red', 'röd', 'rod', 'anmärkning', 'anmarkning', 'risk'].includes(s)) return 'avvikelse';\r\n      if (['ejaktuell', 'inte aktuell', 'n/a', 'na'].includes(s)) return 'ejaktuell';\r\n      return null;\r\n    };\r\n\r\n    const arr = Array.isArray(checklistRaw) ? checklistRaw : [];\r\n    return arr.map((section) => {\r\n      if (!section || typeof section !== 'object') return null;\r\n\r\n      const label = section.label || section.title || section.name || 'Kontrollpunkter';\r\n\r\n      let remediation = section.remediation;\r\n      if (!remediation || typeof remediation !== 'object') remediation = {};\r\n\r\n      const items = [];\r\n\r\n      // Legacy/precomputed shape: section.approved / section.deviation\r\n      const approvedRaw = coerceArrayLike(section.approved ?? section.approvedPoints ?? null);\r\n      const deviationRaw = coerceArrayLike(section.deviation ?? section.deviationPoints ?? null);\r\n      if (approvedRaw.length > 0 || deviationRaw.length > 0) {\r\n        approvedRaw.forEach((pt, i) => {\r\n          const text = String(normalizePointText(pt) || '').trim();\r\n          if (text) items.push({ text, idx: i, status: 'ok' });\r\n        });\r\n        deviationRaw.forEach((pt, i) => {\r\n          const text = String(normalizePointText(pt) || '').trim();\r\n          if (text) items.push({ text, idx: i, status: 'avvikelse' });\r\n        });\r\n        if (items.length === 0) return null;\r\n        return { label, items, remediation };\r\n      }\r\n\r\n      const pointsRaw = coerceArrayLike(section.points ?? section.items ?? []);\r\n      if (!pointsRaw.length) return null;\r\n      const statusesRaw = coerceArrayLike(section.statuses ?? section.status ?? []);\r\n\r\n      pointsRaw.forEach((pt, idx) => {\r\n        const text = String(normalizePointText(pt) || '').trim();\r\n        if (!text) return;\r\n        const statusFromPoint = (pt && typeof pt === 'object' && pt.status !== undefined) ? pt.status : undefined;\r\n        const st = normalizeStatus(statusFromPoint !== undefined ? statusFromPoint : statusesRaw[idx]);\r\n        items.push({ text, idx, status: st });\r\n      });\r\n\r\n      if (items.length === 0) return null;\r\n      return { label, items, remediation };\r\n    }).filter(Boolean);\r\n  }, [checklistRaw]);\r\n\r\n  // Get icon and label for this control type\r\n  const { icon, color, label } = CONTROL_TYPE_ICONS[type] || { icon: 'alert-circle', color: '#D32F2F', label: type || 'Kontroll' };\r\n\r\n  const pageContent = (\r\n    <View style={[styles.page, Platform.OS === 'web' ? styles.pageWeb : null]}>\r\n      <View style={styles.headerCard}>\r\n        {companyLogoUrl ? (\r\n            <View style={{ marginBottom: 12, alignItems: 'flex-start', width: '100%' }}>\r\n            <Image source={{ uri: companyLogoUrl }} style={styles.companyLogo} resizeMode=\"contain\" />\r\n            <View style={styles.companyLogoDivider} />\r\n          </View>\r\n        ) : null}\r\n\r\n        <View style={styles.headerTopRow}>\r\n          <View style={styles.headerTitleRow}>\r\n            <Ionicons name={icon} size={28} color={color} style={{ marginRight: 10 }} />\r\n            <Text style={styles.title}>{label}</Text>\r\n          </View>\r\n\r\n          <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n            <View style={[styles.statusPill, isCompleted ? styles.statusPillDone : styles.statusPillOngoing]}>\r\n              <Text style={[styles.statusPillText, isCompleted ? styles.statusPillTextDone : styles.statusPillTextOngoing]}>{statusText}</Text>\r\n            </View>\r\n            <TouchableOpacity\r\n              onPress={() => {\r\n                let screen = null;\r\n                switch (type) {\r\n                  case 'Riskbedömning': screen = 'RiskbedömningScreen'; break;\r\n                  case 'Arbetsberedning': screen = 'ArbetsberedningScreen'; break;\r\n                  case 'Egenkontroll': screen = 'EgenkontrollScreen'; break;\r\n                  case 'Fuktmätning': screen = 'FuktmätningScreen'; break;\r\n                  case 'Mottagningskontroll': screen = 'MottagningskontrollScreen'; break;\r\n                  case 'Skyddsrond': screen = 'SkyddsrondScreen'; break;\r\n                  default: screen = null;\r\n                }\r\n                if (screen) navigation.navigate(screen, { initialValues: safeControl, project });\r\n              }}\r\n              style={[styles.headerActionBtn, { marginLeft: 8 }]}\r\n              accessibilityLabel=\"Redigera kontroll\"\r\n            >\r\n              <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n\r\n        {project?.id || project?.name ? (\r\n          <View style={styles.projectBar}>\r\n            <Text style={styles.projectBarText} numberOfLines={1} ellipsizeMode=\"tail\">\r\n              Projekt - {project?.id ? String(project.id).trim() : ''}{project?.id && project?.name ? ' - ' : ''}{project?.name ? String(project.name).trim() : ''}\r\n            </Text>\r\n          </View>\r\n        ) : null}\r\n      </View>\r\n\r\n      {/* Overview (matches mock) */}\r\n      <View style={styles.overviewCard}>\r\n        <View style={styles.overviewRow}>\r\n          <Text style={styles.overviewLabel}>Datum för kontroll:</Text>\r\n          <View style={styles.overviewValueWrap}>\r\n            <View style={styles.metaIconWrap}>\r\n              <Ionicons name=\"calendar-outline\" size={16} color={META_ICON_COLOR} />\r\n            </View>\r\n            <Text style={styles.overviewValue}>{formatYmd(date)}{week ? `  v.${week}` : ''}</Text>\r\n          </View>\r\n        </View>\r\n        <View style={styles.overviewRowDivider} />\r\n\r\n        <View style={styles.overviewRow}>\r\n          <Text style={styles.overviewLabel}>{participantsLabel}:</Text>\r\n          <View style={{ flex: 1 }}>\r\n            {participants.length > 0 ? participants.map((p, i) => {\r\n              const name = typeof p === 'string' ? p : (p?.name || p?.displayName || '');\r\n              const company = typeof p === 'object' ? (p?.company || p?.companyName || p?.foretag || p?.['f\\u00f6retag'] || '') : '';\r\n              const role = typeof p === 'object' ? (p?.role || p?.yrkesroll || p?.titel || '') : '';\r\n              const mobile = typeof p === 'object' ? (p?.mobile || p?.mobil || p?.phone || p?.telefon || p?.tel || '') : '';\r\n              const details = [name, company, role, mobile].filter(Boolean).join('  |  ');\r\n              const hasAny = !!(name || company || role || mobile);\r\n              if (!hasAny) return null;\r\n              return (\r\n                <View key={i} style={styles.metaMultiLineRow}>\r\n                  <View style={styles.metaIconWrap}>\r\n                    <Ionicons name=\"person-outline\" size={16} color={META_ICON_COLOR} />\r\n                  </View>\r\n                  {Platform.OS === 'web' ? (\r\n                    <View style={styles.participantTableRow}>\r\n                      <Text style={[styles.overviewValue, styles.participantColName]} numberOfLines={1} ellipsizeMode=\"tail\">{name}</Text>\r\n                      <Text style={[styles.overviewValue, styles.participantColCompany]} numberOfLines={1} ellipsizeMode=\"tail\">{company}</Text>\r\n                      <Text style={[styles.overviewValue, styles.participantColRole]} numberOfLines={1} ellipsizeMode=\"tail\">{role}</Text>\r\n                      <Text style={[styles.overviewValue, styles.participantColMobile]} numberOfLines={1} ellipsizeMode=\"tail\">{mobile}</Text>\r\n                    </View>\r\n                  ) : (\r\n                    <Text style={styles.overviewValue} numberOfLines={1} ellipsizeMode=\"tail\">{details}</Text>\r\n                  )}\r\n                </View>\r\n              );\r\n            }) : (\r\n              <Text style={[styles.overviewValue, { color: '#888' }]}>-</Text>\r\n            )}\r\n          </View>\r\n        </View>\r\n\r\n        {weather ? (\r\n          <>\r\n            <View style={styles.overviewRowDivider} />\r\n            <View style={styles.overviewRow}>\r\n              <Text style={styles.overviewLabel}>Väder:</Text>\r\n              <View style={styles.overviewValueWrap}>\r\n                <View style={styles.metaIconWrap}>\r\n                  <Ionicons name=\"sunny-outline\" size={16} color={META_ICON_COLOR} />\r\n                </View>\r\n                <Text style={styles.overviewValue}>{String(weather)}</Text>\r\n              </View>\r\n            </View>\r\n          </>\r\n        ) : null}\r\n      </View>\r\n\r\n      {/* Deltagare/Väder visas i Översikt-kortet ovan */}\r\n\r\n      {/* Beskrivning av moment */}\r\n      {((type === 'Mottagningskontroll' && (materialDesc || qualityDesc || coverageDesc || generalNote)) || deliveryDesc || description) && (\r\n        <View style={styles.card}>\r\n          {type === 'Mottagningskontroll' ? (\r\n            <>\r\n              {materialDesc ? (\r\n                <View style={styles.overviewRow}>\r\n                  <Text style={styles.overviewLabel}>Beskrivning:</Text>\r\n                  <View style={styles.overviewValueWrap}>\r\n                    <View style={styles.metaIconWrap}>\r\n                      <Ionicons name=\"cube-outline\" size={16} color={META_ICON_COLOR} />\r\n                    </View>\r\n                    <Text style={styles.overviewValue}>{String(materialDesc)}</Text>\r\n                  </View>\r\n                </View>\r\n              ) : null}\r\n              {qualityDesc ? (\r\n                <View style={{ marginBottom: 8 }}>\r\n                  <Text style={styles.noteText}>Kvalité / krav</Text>\r\n                  <Text style={styles.overviewValue}>{String(qualityDesc)}</Text>\r\n                </View>\r\n              ) : null}\r\n              {coverageDesc ? (\r\n                <View style={{ marginBottom: 8 }}>\r\n                  <Text style={styles.noteText}>Omfattning / mängd</Text>\r\n                  <Text style={styles.overviewValue}>{String(coverageDesc)}</Text>\r\n                </View>\r\n              ) : null}\r\n              {generalNote ? (\r\n                <View>\r\n                  <Text style={styles.noteText}>Anteckning</Text>\r\n                  <Text style={styles.overviewValue}>{String(generalNote)}</Text>\r\n                </View>\r\n              ) : null}\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Text style={styles.sectionTitle}>Beskrivning</Text>\r\n              <Text style={styles.bodyText}>{deliveryDesc || description}</Text>\r\n            </>\r\n          )}\r\n        </View>\r\n      )}\r\n\r\n\r\n\r\n      {/* Kontrollpunkter */}\r\n      {checklistSections.length > 0 && (\r\n        <View style={styles.card}>\r\n          <Text style={styles.sectionTitle}>Kontrollpunkter</Text>\r\n          {checklistSections.map((section, idx) => (\r\n            <View key={idx} style={{ marginBottom: 8 }}>\r\n              {idx > 0 && <View style={styles.innerDivider} />}\r\n              <Text style={{ fontWeight: '600', fontSize: 15, color: '#444', marginBottom: 2 }}>{section.label}</Text>\r\n              {(section.items || []).map((item, i) => {\r\n                const pt = item?.text;\r\n                const st = item?.status;\r\n                const remediationKey = String(pt || '').trim();\r\n                const idxKey = String(item?.idx ?? '');\r\n                const remediation = (\r\n                  (section.remediation && section.remediation[remediationKey])\r\n                  || (section.remediation && idxKey && section.remediation[idxKey])\r\n                  || null\r\n                );\r\n                const isDeviation = st === 'avvikelse';\r\n                const isHandled = isDeviation && !!remediation;\r\n\r\n                const iconName = isDeviation\r\n                  ? (isHandled ? 'checkmark-circle' : 'alert-circle')\r\n                  : (st === 'ok' ? 'checkmark-circle' : (st === 'ejaktuell' ? 'remove-circle-outline' : 'ellipse-outline'));\r\n                const iconColor = isDeviation\r\n                  ? (isHandled ? '#388E3C' : '#D32F2F')\r\n                  : (st === 'ok' ? '#388E3C' : (st === 'ejaktuell' ? '#757575' : '#9E9E9E'));\r\n                const textColor = isDeviation\r\n                  ? (isHandled ? '#1976D2' : '#D32F2F')\r\n                  : '#222';\r\n\r\n                return (\r\n                  <View key={i} style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 2, flexWrap: 'wrap' }}>\r\n                    <Ionicons name={iconName} size={18} color={iconColor} style={{ marginRight: 6, marginTop: 1 }} />\r\n                    <View style={{ flex: 1 }}>\r\n                      <Text style={[styles.bodyText, { color: textColor, flexWrap: 'wrap' }]}>{pt}</Text>\r\n                      {isHandled && remediation && (\r\n                        <Text style={{ fontSize: 12, color: '#888', marginTop: 2 }}>\r\n                          Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\r\n                        </Text>\r\n                      )}\r\n                    </View>\r\n                  </View>\r\n                );\r\n              })}\r\n            </View>\r\n          ))}\r\n        </View>\r\n      )}\r\n\r\n\r\n      {(() => {\r\n        // Gruppera avvikelser per sektion\r\n        const grouped = {};\r\n        checklistSections.forEach(section => {\r\n          const deviations = (section.items || []).filter(it => it && it.status === 'avvikelse');\r\n          if (deviations.length === 0) return;\r\n          if (!grouped[section.label]) grouped[section.label] = [];\r\n          deviations.forEach((item) => {\r\n            const pt = item?.text;\r\n            const idxKey = String(item?.idx ?? '');\r\n            grouped[section.label].push({\r\n              pt,\r\n              remediation: (\r\n                (section.remediation && section.remediation[String(pt || '').trim()])\r\n                || (section.remediation && idxKey && section.remediation[idxKey])\r\n                || null\r\n              )\r\n            });\r\n          });\r\n        });\r\n        const sectionLabels = Object.keys(grouped);\r\n        if (sectionLabels.length === 0) return null;\r\n        // Visa åtgärdsknapp endast för Skyddsrond\r\n        const isSkyddsrond = type === 'Skyddsrond';\r\n        return (\r\n          <>\r\n            <View style={styles.card}>\r\n              <Text style={styles.sectionTitle}>Avvikelser/risker:</Text>\r\n              {sectionLabels.map((label, idx) => (\r\n                <View key={label} style={{ marginBottom: 4 }}>\r\n                  <Text style={{ fontWeight: '600', color: '#444', marginBottom: 2 }}>{label}:</Text>\r\n                  {grouped[label].map((item, i) => {\r\n                    const { pt, remediation } = item;\r\n                    const isHandled = !!remediation;\r\n                    return (\r\n                      <View key={i} style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 2, flexWrap: 'wrap', marginLeft: 12 }}>\r\n                        <Ionicons name={isHandled ? \"checkmark-circle\" : \"alert-circle\"} size={18} color={isHandled ? \"#388E3C\" : \"#D32F2F\"} style={{ marginRight: 6, marginTop: 2 }} />\r\n                        <View style={{ flex: 1 }}>\r\n                          <Text style={[styles.bodyText, { color: isHandled ? '#222' : '#D32F2F', flexWrap: 'wrap' }]}>{pt}</Text>\r\n                          {isHandled && remediation && (\r\n                            <Text style={{ fontSize: 12, color: '#888', marginTop: 2 }}>\r\n                              Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\r\n                            </Text>\r\n                          )}\r\n                        </View>\r\n                        {isSkyddsrond && (\r\n                          isHandled ? (\r\n                            <TouchableOpacity\r\n                              style={{ marginLeft: 8, backgroundColor: '#FFC107', borderRadius: 6, paddingVertical: 4, paddingHorizontal: 10, flexDirection: 'row', alignItems: 'center' }}\r\n                              onPress={() => setActionModal({ visible: true, section: label, point: pt, img: remediation.img, comment: remediation.comment, signature: remediation.signature, name: remediation.name, date: remediation.date, infoMode: true })}\r\n                            >\r\n                              <Ionicons name=\"information-circle-outline\" size={16} color=\"#222\" style={{ marginRight: 4 }} />\r\n                              <Text style={{ color: '#222', fontSize: 13 }}>Info</Text>\r\n                            </TouchableOpacity>\r\n                          ) : (\r\n                            <TouchableOpacity\r\n                              style={{ marginLeft: 8, backgroundColor: '#1976D2', borderRadius: 6, paddingVertical: 4, paddingHorizontal: 10 }}\r\n                              onPress={() => setActionModal({ visible: true, section: label, point: pt, img: null, comment: '', signature: '', name: '', infoMode: false })}\r\n                            >\r\n                              <Text style={{ color: '#fff', fontSize: 13 }}>Åtgärda</Text>\r\n                            </TouchableOpacity>\r\n                          )\r\n                        )}\r\n                      </View>\r\n                    );\r\n                  })}\r\n                </View>\r\n              ))}\r\n            </View>\r\n\r\n            {/* Modal för åtgärd */}\r\n            <Modal\r\n              visible={actionModal.visible}\r\n              transparent\r\n              animationType=\"slide\"\r\n              onRequestClose={() => setActionModal(a => ({ ...a, visible: false, /* INGEN SPARLOGIK HÄR */ }))}\r\n            >\r\n              <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n                <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 22, width: 320, alignItems: 'center' }}>\r\n                  {/* X-stäng uppe till höger */}\r\n                  <TouchableOpacity\r\n                    style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n                    onPress={() => setActionModal(a => ({ ...a, visible: false, /* INGEN SPARLOGIK HÄR */ }))}\r\n                  >\r\n                    <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n                  </TouchableOpacity>\r\n                  {actionModal.infoMode ? (\r\n                    <>\r\n                      <Text style={{ fontWeight: 'bold', fontSize: 18, marginBottom: 10 }}>Åtgärdsinfo</Text>\r\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 8, textAlign: 'center' }}>{actionModal.section}: {actionModal.point}</Text>\r\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 6 }}>Beskrivning:</Text>\r\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.comment}</Text>\r\n                      {actionModal.img && (\r\n                        <Image source={{ uri: actionModal.img }} style={{ width: 120, height: 90, borderRadius: 8, marginBottom: 10 }} />\r\n                      )}\r\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Namn:</Text>\r\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.name}</Text>\r\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Signatur:</Text>\r\n                      {actionModal.signature ? (\r\n                        <Image source={{ uri: actionModal.signature }} style={{ width: 80, height: 32, backgroundColor: '#fff', borderRadius: 4, marginBottom: 10 }} />\r\n                      ) : (\r\n                        <Text style={{ color: '#888', fontSize: 15, marginBottom: 10 }}>Ingen signatur</Text>\r\n                      )}\r\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Åtgärdat datum:</Text>\r\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.date ? actionModal.date.slice(0, 10) : '-'}</Text>\r\n                    </>\r\n                  ) : (\r\n                    <>\r\n                      <Text style={{ fontWeight: 'bold', fontSize: 18, marginBottom: 6 }}>Åtgärda brist</Text>\r\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 4, textAlign: 'center' }}>{actionModal.section}: {actionModal.point}</Text>\r\n                      <View style={{ width: '100%', marginBottom: 10 }}>\r\n                        <Text style={{ fontSize: 13, color: '#888', marginBottom: 4 }}>Datum:</Text>\r\n                        <TouchableOpacity\r\n                          activeOpacity={0.8}\r\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, backgroundColor: '#f3f3f3', marginBottom: 2 }}\r\n                          onLongPress={() => {\r\n                            Alert.prompt(\r\n                              'Ändra datum',\r\n                              'Skriv nytt datum (YYYY-MM-DD)',\r\n                              [\r\n                                {\r\n                                  text: 'Avbryt',\r\n                                  style: 'cancel',\r\n                                },\r\n                                {\r\n                                  text: 'OK',\r\n                                  onPress: (newDate) => {\r\n                                    if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(newDate)) {\r\n                                      Alert.alert('Fel', 'Datumet måste vara på formatet YYYY-MM-DD');\r\n                                      return;\r\n                                    }\r\n                                    const today = new Date().toISOString().slice(0, 10);\r\n                                    if (newDate > today) {\r\n                                      Alert.alert('Fel', 'Du kan inte välja ett datum i framtiden.');\r\n                                      return;\r\n                                    }\r\n                                    setActionModal(a => ({ ...a, date: newDate }));\r\n                                  },\r\n                                },\r\n                              ],\r\n                              'plain-text',\r\n                              actionModal.date || new Date().toISOString().slice(0, 10)\r\n                            );\r\n                          }}\r\n                        >\r\n                          <Text style={{ fontSize: 15, color: '#888' }}>{actionModal.date || new Date().toISOString().slice(0, 10)}</Text>\r\n                        </TouchableOpacity>\r\n                        <Text style={{ fontSize: 11, color: '#aaa', marginTop: 2 }}>Håll inne för att ändra datum</Text>\r\n                      </View>\r\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 6 }}>Beskriv åtgärd:</Text>\r\n                      <View style={{ width: '100%', marginBottom: 10 }}>\r\n                        <TextInput\r\n                          value={actionModal.comment}\r\n                          onChangeText={t => setActionModal(a => ({ ...a, comment: t }))}\r\n                          placeholder=\"Beskriv vad som åtgärdats...\"\r\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, fontSize: 15, minHeight: 40, backgroundColor: '#fafbfc' }}\r\n                          multiline\r\n                          placeholderTextColor=\"#aaa\"\r\n                        />\r\n                      </View>\r\n                      <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\r\n                        <TouchableOpacity\r\n                          style={{ backgroundColor: '#1976D2', borderRadius: 50, padding: 10, marginRight: 10 }}\r\n                          onPress={async () => {\r\n                            // Välj/tar foto\r\n                            const result = await ImagePicker.launchCameraAsync({ mediaTypes: ImagePicker.MediaTypeOptions.Images, quality: 0.7 });\r\n                            if (!result.canceled && result.assets && result.assets.length > 0) {\r\n                              setActionModal(a => ({ ...a, img: result.assets[0].uri }));\r\n                            }\r\n                          }}\r\n                        >\r\n                          <Ionicons name=\"camera\" size={24} color=\"#fff\" />\r\n                        </TouchableOpacity>\r\n                        {actionModal.img && (\r\n                          <Image source={{ uri: actionModal.img }} style={{ width: 60, height: 45, borderRadius: 8 }} />\r\n                        )}\r\n                      </View>\r\n                      <View style={{ width: '100%', marginBottom: 10 }}>\r\n                        <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Namn på åtgärdande person:</Text>\r\n                        <TextInput\r\n                          value={actionModal.name}\r\n                          onChangeText={t => setActionModal(a => ({ ...a, name: t }))}\r\n                          placeholder=\"Namn...\"\r\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, fontSize: 15, backgroundColor: '#fafbfc' }}\r\n                          placeholderTextColor=\"#aaa\"\r\n                        />\r\n                      </View>\r\n                      <View style={{ width: '100%', marginBottom: 10 }}>\r\n                        <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Signatur:</Text>\r\n                        <TouchableOpacity\r\n                          style={{ flexDirection: 'row', alignItems: 'center', borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, backgroundColor: '#fafbfc', minHeight: 44 }}\r\n                          onPress={() => setActionModal(a => ({ ...a, showSignatureModal: true }))}\r\n                        >\r\n                          {actionModal.signature ? (\r\n                            <Image source={{ uri: actionModal.signature }} style={{ width: 80, height: 32, backgroundColor: '#fff', borderRadius: 4 }} />\r\n                          ) : (\r\n                            <>\r\n                              <Ionicons name=\"pencil\" size={20} color=\"#1976D2\" style={{ marginRight: 8 }} />\r\n                              <Text style={{ color: '#888', fontSize: 15 }}>Tryck för signatur</Text>\r\n                            </>\r\n                          )}\r\n                        </TouchableOpacity>\r\n                        <SignatureModal\r\n                          visible={!!actionModal.showSignatureModal}\r\n                          onOK={uri => setActionModal(a => ({ ...a, signature: uri, showSignatureModal: false }))}\r\n                          onCancel={() => setActionModal(a => ({ ...a, showSignatureModal: false }))}\r\n                        />\r\n                      </View>\r\n                      <TouchableOpacity\r\n                        style={{\r\n                          flexDirection: 'row',\r\n                          alignItems: 'center',\r\n                          justifyContent: 'center',\r\n                          minHeight: 40,\r\n                          paddingVertical: 8,\r\n                          marginTop: 18,\r\n                          backgroundColor: (actionModal.comment && actionModal.name && actionModal.signature) ? '#1976D2' : '#e0e0e0',\r\n                          borderRadius: 8,\r\n                          shadowColor: '#1976D2',\r\n                          shadowOffset: { width: 0, height: 2 },\r\n                          shadowOpacity: 0.10,\r\n                          shadowRadius: 4,\r\n                        }}\r\n                        onPress={async () => {\r\n                          if (!(actionModal.comment && actionModal.name && actionModal.signature)) {\r\n                            // Visa alert med saknade fält\r\n                            const missing = [];\r\n                            if (!actionModal.comment) missing.push('Beskriv åtgärd');\r\n                            if (!actionModal.name) missing.push('Namn');\r\n                            if (!actionModal.signature) missing.push('Signatur');\r\n                            Alert.alert('Saknas', 'Följande fält måste fyllas i: ' + missing.join(', '));\r\n                            return;\r\n                          }\r\n                          // Immutabel kopia av checklistan och kontrollen\r\n                          const hasChecklist = Array.isArray(safeControl.checklist);\r\n                          const sourceChecklist = hasChecklist\r\n                            ? safeControl.checklist\r\n                            : (Array.isArray(safeControl.checklistSections) ? safeControl.checklistSections : []);\r\n\r\n                          let newChecklist = Array.isArray(sourceChecklist)\r\n                            ? sourceChecklist.map(s => ({ ...s, remediation: { ...(s && s.remediation ? s.remediation : {}) } }))\r\n                            : [];\r\n\r\n                          const sectionIdx = newChecklist.findIndex(s => (s && (s.label || s.title)) === actionModal.section);\r\n                          if (sectionIdx !== -1) {\r\n                            // Hitta exakt rätt punkttext (pt) i sektionen, trimma för säker matchning\r\n                            const pt = (newChecklist[sectionIdx].points || []).find(p => String(p || '').trim() === String(actionModal.point || '').trim());\r\n                            const remediationKey = String((pt || actionModal.point) || '').trim();\r\n                            const today = new Date().toISOString().slice(0, 10);\r\n                            const remediationDate = actionModal.date && /^\\d{4}-\\d{2}-\\d{2}$/.test(actionModal.date) ? actionModal.date : today;\r\n                            newChecklist[sectionIdx].remediation[remediationKey] = {\r\n                              comment: actionModal.comment,\r\n                              img: actionModal.img,\r\n                              signature: actionModal.signature,\r\n                              name: actionModal.name,\r\n                              date: remediationDate,\r\n                            };\r\n                          } else {\r\n                            Alert.alert('Fel', 'Kunde inte hitta sektionen för åtgärden.');\r\n                            return;\r\n                          }\r\n                          const updatedControl = {\r\n                            ...safeControl,\r\n                            ...(hasChecklist ? { checklist: newChecklist } : { checklistSections: newChecklist }),\r\n                            savedAt: new Date().toISOString(),\r\n                          };\r\n\r\n                          try {\r\n                            await upsertControlInStorage(updatedControl);\r\n                            setControlState(updatedControl);\r\n                            setActionModal(a => ({ ...a, visible: false }));\r\n                            Alert.alert('Åtgärd sparad', 'Din åtgärd har sparats.', [\r\n                              { text: 'OK' }\r\n                            ]);\r\n                          } catch(_e {\r\n                            Alert.alert('Fel', 'Kunde inte spara åtgärden. Försök igen.');\r\n                          }\r\n                        }}\r\n                      >\r\n                        <Ionicons name=\"save-outline\" size={22} color={(actionModal.comment && actionModal.name && actionModal.signature) ? '#fff' : '#888'} style={{ marginRight: 8 }} />\r\n                        <Text style={{\r\n                          color: (actionModal.comment && actionModal.name && actionModal.signature) ? '#fff' : '#888',\r\n                          fontWeight: 'bold',\r\n                          fontSize: 17,\r\n                          letterSpacing: 0.5,\r\n                          textAlign: 'center',\r\n                        }}>Spara</Text>\r\n                      </TouchableOpacity>\r\n                    </>\r\n                  )}\r\n                </View>\r\n              </View>\r\n            </Modal>\r\n          </>\r\n        );\r\n      })()}\r\n\r\n      {/* Åtgärder vidtagna (om finns) tas bort, endast en rad ska visas */}\r\n\r\n      {/* Signaturer */}\r\n      {mottagningsSignatures.length > 0 && (\r\n        <View style={styles.card}>\r\n          <Text style={styles.sectionTitle}>Signaturer</Text>\r\n          {mottagningsSignatures.map((s, i) => (\r\n            <View key={i} style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\r\n              <Ionicons name=\"pencil\" size={18} color=\"#1976D2\" style={{ marginRight: 8, marginTop: 2 }} />\r\n              <View style={{ flex: 1 }}>\r\n                <Text style={styles.bodyText}>{s?.name || 'Signerad'}</Text>\r\n                {s?.uri ? (\r\n                  <Image source={{ uri: s.uri }} style={{ width: 140, height: 52, marginTop: 6, backgroundColor: '#fff', borderRadius: 6, borderWidth: 1, borderColor: '#eee' }} resizeMode=\"contain\" />\r\n                ) : null}\r\n              </View>\r\n            </View>\r\n          ))}\r\n        </View>\r\n      )}\r\n\r\n      {/* Bifogade bilder */}\r\n      {mottagningsPhotos.length > 0 && (\r\n        <View style={styles.card}>\r\n          <Text style={styles.sectionTitle}>Bifogade bilder</Text>\r\n          <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 8 }}>\r\n            {mottagningsPhotos.map((img, idx) => {\r\n              const uri = img.uri || img;\r\n              return (\r\n                <TouchableOpacity\r\n                  key={idx}\r\n                  style={{ marginRight: 8 }}\r\n                  onPress={() => {\r\n                    setSelectedPhoto(uri);\r\n                    setPhotoModalVisible(true);\r\n                  }}\r\n                  accessibilityLabel=\"Visa bild i stor vy\"\r\n                >\r\n                  <Image source={{ uri }} style={{ width: 84, height: 84, borderRadius: 8, borderWidth: 1, borderColor: '#ddd', backgroundColor: '#eee' }} />\r\n                  {img.comment ? (\r\n                    <View style={{ position: 'absolute', left: 6, right: 6, bottom: 6, backgroundColor: 'rgba(0,0,0,0.45)', paddingVertical: 2, paddingHorizontal: 6, borderRadius: 6 }}>\r\n                      <Text numberOfLines={1} style={{ color: '#fff', fontSize: 12 }}>{img.comment}</Text>\r\n                    </View>\r\n                  ) : null}\r\n                </TouchableOpacity>\r\n              );\r\n            })}\r\n          </ScrollView>\r\n          <Modal\r\n            visible={photoModalVisible}\r\n            transparent={true}\r\n            animationType=\"fade\"\r\n            onRequestClose={() => setPhotoModalVisible(false)}\r\n          >\r\n            <Pressable style={styles.modalOverlay} onPress={() => setPhotoModalVisible(false)}>\r\n              <View style={styles.modalContent}>\r\n                {selectedPhoto && (\r\n                  <Image\r\n                    source={{ uri: selectedPhoto }}\r\n                    style={{ width: '100%', height: 350, borderRadius: 12, resizeMode: 'contain', backgroundColor: '#000' }}\r\n                  />\r\n                )}\r\n                <Text style={{ color: '#fff', marginTop: 12, textAlign: 'center' }}>Tryck utanför bilden för att stänga</Text>\r\n              </View>\r\n            </Pressable>\r\n          </Modal>\r\n        </View>\r\n      )}\r\n\r\n    </View>\r\n  );\r\n\r\n  if (Platform.OS === 'web') {\r\n    return (\r\n      <View style={[styles.container, styles.webScrollRoot, { height: windowHeight || undefined }]}>\r\n        <View style={[styles.content, styles.contentWeb]}>\r\n          {pageContent}\r\n        </View>\r\n      </View>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <ScrollView\r\n      style={styles.container}\r\n      contentContainerStyle={styles.content}\r\n    >\r\n      {pageContent}\r\n    </ScrollView>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, backgroundColor: '#fff' },\r\n  // RN-web does not reliably apply `overflowY`; use `overflow` to enable scrolling.\r\n  webScrollRoot: { overflow: 'auto', minHeight: 0 },\r\n  content: { padding: 16, paddingBottom: 24 },\r\n  contentWeb: { alignItems: 'flex-start' },\r\n  page: { width: '100%' },\r\n  pageWeb: { width: A4_WEB_MAX_WIDTH },\r\n\r\n  title: { fontSize: 22, fontWeight: 'bold', color: PRIMARY },\r\n  projectLine: { fontSize: 14, color: '#666', marginTop: 2 },\r\n  subInfo: { fontSize: 13, color: '#666', marginTop: 8 },\r\n  sectionTitle: { fontSize: 16, fontWeight: '700', color: PRIMARY, marginBottom: 10 },\r\n  bodyText: { fontSize: 15, color: '#222' },\r\n  noteText: { fontSize: 13, color: '#444', marginTop: 2 },\r\n\r\n  headerCard: {\r\n    borderWidth: 1,\r\n    borderColor: '#e0e0e0',\r\n    borderRadius: 14,\r\n    padding: 14,\r\n    backgroundColor: '#fff',\r\n    marginBottom: 12,\r\n  },\r\n  companyLogo: {\r\n    width: 260,\r\n    maxWidth: '100%',\r\n    height: 56,\r\n  },\r\n  companyLogoDivider: {\r\n    height: 1,\r\n    backgroundColor: '#e6e6e6',\r\n    marginTop: 10,\r\n    width: '100%',\r\n    alignSelf: 'stretch',\r\n  },\r\n  headerTopRow: {\r\n    flexDirection: 'row',\r\n    alignItems: 'flex-start',\r\n    justifyContent: 'space-between',\r\n  },\r\n  headerTitleRow: { flexDirection: 'row', alignItems: 'center', flex: 1, paddingRight: 8 },\r\n  headerActionBtn: { padding: 6, marginLeft: 8 },\r\n\r\n  projectBar: {\r\n    marginTop: 10,\r\n    paddingVertical: 10,\r\n    paddingHorizontal: 12,\r\n    borderRadius: 10,\r\n    backgroundColor: '#f6f6f6',\r\n    borderWidth: 1,\r\n    borderColor: '#ededed',\r\n  },\r\n  projectBarText: {\r\n    fontSize: 13,\r\n    color: '#333',\r\n    fontWeight: '700',\r\n    letterSpacing: 0.4,\r\n  },\r\n\r\n  metaRow: { flexDirection: 'row', alignItems: 'center', marginTop: 10, justifyContent: 'space-between' },\r\n  metaItem: { flexDirection: 'row', alignItems: 'center', flexShrink: 1 },\r\n  metaText: { fontSize: 14, color: '#222' },\r\n\r\n  statusPill: { paddingVertical: 6, paddingHorizontal: 10, borderRadius: 999, borderWidth: 1 },\r\n  statusPillDone: { backgroundColor: '#E8F5E9', borderColor: '#43A047' },\r\n  statusPillOngoing: { backgroundColor: '#FFF8E1', borderColor: '#FFD600' },\r\n  statusPillText: { fontSize: 13, fontWeight: '700' },\r\n  statusPillTextDone: { color: '#2E7D32' },\r\n  statusPillTextOngoing: { color: '#222' },\r\n\r\n  card: {\r\n    borderWidth: 1,\r\n    borderColor: '#e0e0e0',\r\n    borderRadius: 14,\r\n    padding: 14,\r\n    backgroundColor: '#fff',\r\n    marginTop: 12,\r\n  },\r\n  innerDivider: { height: 1, backgroundColor: '#eee', marginVertical: 10 },\r\n\r\n  overviewCard: {\r\n    borderWidth: 1,\r\n    borderColor: '#e0e0e0',\r\n    borderRadius: 14,\r\n    padding: 14,\r\n    backgroundColor: '#fff',\r\n    marginBottom: 12,\r\n  },\r\n  overviewRow: {\r\n    flexDirection: 'row',\r\n    alignItems: 'flex-start',\r\n    justifyContent: 'flex-start',\r\n  },\r\n  overviewRowDivider: {\r\n    height: 1,\r\n    backgroundColor: '#eee',\r\n    marginVertical: 10,\r\n  },\r\n  overviewLabel: {\r\n    fontSize: 13,\r\n    color: '#444',\r\n    fontWeight: '700',\r\n    width: 145,\r\n    paddingRight: 10,\r\n  },\r\n  overviewValueWrap: {\r\n    flexDirection: 'row',\r\n    alignItems: 'center',\r\n    justifyContent: 'flex-start',\r\n    flex: 1,\r\n  },\r\n  metaIconWrap: { width: 22, alignItems: 'center', marginRight: 8 },\r\n  metaMultiLineRow: { flexDirection: 'row', alignItems: 'center', marginBottom: 4 },\r\n  participantTableRow: { flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 },\r\n  participantColName: { width: 170, paddingRight: 10 },\r\n  participantColCompany: { width: 170, paddingRight: 10 },\r\n  participantColRole: { width: 160, paddingRight: 10 },\r\n  participantColMobile: { width: 120 },\r\n  overviewValue: {\r\n    fontSize: 13,\r\n    color: '#333',\r\n    flexShrink: 1,\r\n  },\r\n\r\n  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.85)', justifyContent: 'center', padding: 16 },\r\n  modalContent: { alignItems: 'center' },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\ControlForm.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\EgenkontrollScreen.js","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token {","line":37,"column":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useRoute } from '@react-navigation/native';\r\nimport BaseControlForm from '../components/BaseControlForm';\r\nimport { saveControlToFirestore } from '../components/firebase';\r\n\r\nconst LABELS = {\r\n  title: 'Egenkontroll',\r\n  saveButton: 'Spara',\r\n  saveDraftButton: 'Spara och slutför senare',\r\n};\r\n\r\nexport default function EgenkontrollScreen({\r\n  date,\r\n  participants = [],\r\n  project: projectProp,\r\n  initialValues: initialValuesProp,\r\n  onExit,\r\n  onFinished,\r\n}) {\r\n  const route = useRoute();\r\n  const project = projectProp ?? route.params?.project;\r\n  const initialValues = (initialValuesProp ?? route.params?.initialValues) || undefined;\r\n\r\n  const handleSave = async (data) => {\r\n    try {\r\n      const completed = {\r\n        ...data,\r\n        project: data.project || project,\r\n        status: 'UTFÖRD',\r\n        savedAt: new Date().toISOString(),\r\n        type: 'Egenkontroll',\r\n        id: data.id || require('uuid').v4(),\r\n      };\r\n      try {\r\n        const ok = await saveControlToFirestore(completed);\r\n        if (!ok) throw new Error('Firestore save failed');\r\n      } catch(_e {\r\n        const existing = await AsyncStorage.getItem('completed_controls');\r\n        let arr = [];\r\n        if (existing) arr = JSON.parse(existing);\r\n        arr.push(completed);\r\n        await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\r\n      }\r\n      try {\r\n        const draftRaw = await AsyncStorage.getItem('draft_controls');\r\n        if (draftRaw) {\r\n          let drafts = JSON.parse(draftRaw) || [];\r\n          drafts = drafts.filter(d => !(d.project?.id === project?.id && d.type === 'Egenkontroll' && d.id === completed.id));\r\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\r\n        }\r\n      } catch(_e {}\r\n      alert('Kontrollen har sparats som utförd!');\r\n      } catch(_e {\r\n      alert('Kunde inte spara kontrollen: ' + (e && e.message ? e.message : String(e)));\r\n    }\r\n  };\r\n\r\n  return (\r\n    <BaseControlForm\r\n      date={date}\r\n      controlType=\"Egenkontroll\"\r\n      hideWeather={true}\r\n      labels={LABELS}\r\n      participants={participants}\r\n      project={project}\r\n      onSave={handleSave}\r\n      initialValues={initialValues}\r\n      onExit={onExit}\r\n      onFinished={onFinished}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\FuktmätningScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\HomeScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":12,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":68},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":66,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'adminTapCount' is assigned a value but never used.","line":140,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":140,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"adminTapCount"},"fix":{"range":[5764,5777],"text":""},"desc":"Remove unused variable 'adminTapCount'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":172,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":172,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":181,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":181,"endColumn":64},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":217,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":218,"column":51,"nodeType":"Identifier","messageId":"undef","endLine":218,"endColumn":53},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":218,"column":66,"nodeType":"Identifier","messageId":"undef","endLine":218,"endColumn":68},{"ruleId":"no-unused-vars","severity":1,"message":"'companyAdminsLastFetchAt' is assigned a value but never used.","line":244,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":244,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"companyAdminsLastFetchAt"},"fix":{"range":[10167,10191],"text":""},"desc":"Remove unused variable 'companyAdminsLastFetchAt'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":258,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":258,"endColumn":43},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":259,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":259,"endColumn":45},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":260,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":260,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":261,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":261,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":262,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":262,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":263,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":263,"endColumn":58},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":264,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":264,"endColumn":53},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":265,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":265,"endColumn":61},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":266,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":266,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":268,"column":66,"nodeType":"Identifier","messageId":"unusedVar","endLine":268,"endColumn":67},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":293,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":293,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":297,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":297,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":298,"column":26,"nodeType":"Identifier","messageId":"undef","endLine":298,"endColumn":28},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":298,"column":41,"nodeType":"Identifier","messageId":"undef","endLine":298,"endColumn":43},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":299,"column":11,"nodeType":"Identifier","messageId":"undef","endLine":299,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":322,"column":89,"nodeType":"Identifier","messageId":"unusedVar","endLine":322,"endColumn":90},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":332,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":332,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":348,"column":89,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":90},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":378,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":378,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":402,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":402,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":852,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":852,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'editModal' is assigned a value but never used.","line":1129,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":1129,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"editModal"},"fix":{"range":[52240,52249],"text":""},"desc":"Remove unused variable 'editModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'countProjectStatus' is defined but never used.","line":1131,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":1131,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"countProjectStatus"},"fix":{"range":[52387,53066],"text":""},"desc":"Remove unused variable 'countProjectStatus'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'removeLastMainFolder' is assigned a value but never used.","line":1152,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1152,"endColumn":29},{"ruleId":"no-unused-vars","severity":1,"message":"'countProjects' is defined but never used.","line":1162,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":1162,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"countProjects"},"fix":{"range":[53635,54073],"text":""},"desc":"Remove unused variable 'countProjects'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'loggingOut' is assigned a value but never used.","line":1178,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1178,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"loggingOut"},"fix":{"range":[54171,54181],"text":""},"desc":"Remove unused variable 'loggingOut'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1198,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1198,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1286,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1286,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1312,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":1312,"endColumn":80},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1319,"column":85,"nodeType":"Identifier","messageId":"unusedVar","endLine":1319,"endColumn":86},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1335,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1335,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1347,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1347,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1366,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1366,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1398,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1398,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1414,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1414,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1434,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1434,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1461,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1461,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1478,"column":98,"nodeType":"Identifier","messageId":"unusedVar","endLine":1478,"endColumn":99},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1494,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1494,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1495,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":1495,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1507,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1507,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1508,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":1508,"endColumn":61},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1530,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1530,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1571,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1571,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1576,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1576,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1577,"column":64,"nodeType":"Identifier","messageId":"unusedVar","endLine":1577,"endColumn":65},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1601,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1601,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1612,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1612,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1613,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":1613,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1662,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1662,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1695,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1695,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1714,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1714,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1729,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1729,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1737,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":1737,"endColumn":74},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1753,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1753,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'selectedProject'. Either include it or remove the dependency array.","line":1755,"column":6,"nodeType":"ArrayExpression","endLine":1755,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [selectedProject, selectedProject.id]","fix":{"range":[77670,77691],"text":"[selectedProject, selectedProject.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1764,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1764,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1783,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":1783,"endColumn":79},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1788,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":1788,"endColumn":64},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1818,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1818,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has unnecessary dependencies: 'auth.currentUser.email' and 'auth.currentUser.uid'. Either exclude them or remove the dependency array. Outer scope values like 'auth.currentUser.uid' aren't valid dependencies because mutating them doesn't re-render the component.","line":1822,"column":6,"nodeType":"ArrayExpression","endLine":1822,"endColumn":106,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, routeCompanyId, authClaims?.companyId]","fix":{"range":[80318,80418],"text":"[companyId, routeCompanyId, authClaims?.companyId]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1843,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1843,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1897,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1897,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1909,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1909,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1931,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1931,"endColumn":18},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":1932,"column":63,"nodeType":"Identifier","messageId":"undef","endLine":1932,"endColumn":65},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1936,"column":80,"nodeType":"Identifier","messageId":"unusedVar","endLine":1936,"endColumn":81},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1938,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1938,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":1939,"column":39,"nodeType":"Identifier","messageId":"undef","endLine":1939,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1950,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":1950,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1959,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":1959,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1961,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1961,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":1962,"column":66,"nodeType":"Identifier","messageId":"undef","endLine":1962,"endColumn":68},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":1962,"column":81,"nodeType":"Identifier","messageId":"undef","endLine":1962,"endColumn":83},{"ruleId":"no-unused-vars","severity":1,"message":"'bg' is assigned a value but never used.","line":1968,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1968,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2013,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2013,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2034,"column":85,"nodeType":"Identifier","messageId":"unusedVar","endLine":2034,"endColumn":86},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2037,"column":146,"nodeType":"Identifier","messageId":"unusedVar","endLine":2037,"endColumn":147},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2039,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":2039,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2046,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2046,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2067,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":2067,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2087,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2087,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2093,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":2093,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2095,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":2095,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2099,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2099,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useMemo has a missing dependency: 'route.params'. Either include it or remove the dependency array.","line":2134,"column":6,"nodeType":"ArrayExpression","endLine":2134,"endColumn":59,"suggestions":[{"desc":"Update the dependencies array to be: [route.params, headerProjectQuery]","fix":{"range":[93217,93270],"text":"[route.params, headerProjectQuery]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2197,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":2197,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2236,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":2236,"endColumn":43},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has missing dependencies: 'copyProjectWeb', 'deleteProject', and 'renameProjectWeb'. Either include them or remove the dependency array.","line":2598,"column":6,"nodeType":"ArrayExpression","endLine":2598,"endColumn":131,"suggestions":[{"desc":"Update the dependencies array to be: [contextMenu.target, copyProjectWeb, deleteMainFolderGuarded, deleteProject, deleteSubFolder, renameMainFolderWeb, renameProjectWeb, renameSubFolderWeb, requestProjectSwitch]","fix":{"range":[110362,110487],"text":"[contextMenu.target, copyProjectWeb, deleteMainFolderGuarded, deleteProject, deleteSubFolder, renameMainFolderWeb, renameProjectWeb, renameSubFolderWeb, requestProjectSwitch]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'kontrollKnappStil' is assigned a value but never used.","line":2612,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":2612,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'kontrollTextStil' is assigned a value but never used.","line":2613,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":2613,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"kontrollTextStil"},"fix":{"range":[111280,111387],"text":""},"desc":"Remove unused variable 'kontrollTextStil'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardSectionTitleStyle' object makes the dependencies of useCallback Hook (at line 2740) change on every render. To fix this, wrap the initialization of 'dashboardSectionTitleStyle' in its own useMemo() Hook.","line":2618,"column":11,"nodeType":"VariableDeclarator","endLine":2618,"endColumn":108},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardCardDenseStyle' object makes the dependencies of useCallback Hook (at line 2740) change on every render. Move it inside the useCallback callback. Alternatively, wrap the initialization of 'dashboardCardDenseStyle' in its own useMemo() Hook.","line":2620,"column":11,"nodeType":"VariableDeclarator","endLine":2620,"endColumn":135},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardEmptyTextStyle' object makes the dependencies of useCallback Hook (at line 2740) change on every render. To fix this, wrap the initialization of 'dashboardEmptyTextStyle' in its own useMemo() Hook.","line":2621,"column":11,"nodeType":"VariableDeclarator","endLine":2621,"endColumn":67},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardMetaTextStyle' object makes the dependencies of useCallback Hook (at line 2740) change on every render. To fix this, wrap the initialization of 'dashboardMetaTextStyle' in its own useMemo() Hook.","line":2622,"column":11,"nodeType":"VariableDeclarator","endLine":2622,"endColumn":81},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardListItemStyle' function makes the dependencies of useCallback Hook (at line 2740) change on every render. To fix this, wrap the definition of 'dashboardListItemStyle' in its own useCallback() Hook.","line":2624,"column":11,"nodeType":"VariableDeclarator","endLine":2629,"endColumn":7,"suggestions":[{"desc":"Wrap the definition of 'dashboardListItemStyle' in its own useCallback() Hook.","fix":{"range":[112315,112464],"text":"useCallback((idx) => ({\r\n      paddingVertical: 12,\r\n      paddingHorizontal: 6,\r\n      borderTopWidth: idx === 0 ? 0 : 1,\r\n      borderTopColor: '#eee',\r\n    }))"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'dashboardActivityTitleStyle' object makes the dependencies of useCallback Hook (at line 2740) change on every render. Move it inside the useCallback callback. Alternatively, wrap the initialization of 'dashboardActivityTitleStyle' in its own useMemo() Hook.","line":2640,"column":11,"nodeType":"VariableDeclarator","endLine":2640,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2713,"column":88,"nodeType":"Identifier","messageId":"unusedVar","endLine":2713,"endColumn":89},{"ruleId":"no-unused-vars","severity":1,"message":"'SelectProjectModal' is defined but never used.","line":2754,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":2754,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"SelectProjectModal"},"fix":{"range":[118972,130815],"text":""},"desc":"Remove unused variable 'SelectProjectModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddModal' is assigned a value but never used.","line":2757,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":2757,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddModal"},"fix":{"range":[119138,119151],"text":""},"desc":"Remove unused variable 'quickAddModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddModal' is assigned a value but never used.","line":2757,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2757,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddModal"},"fix":{"range":[119151,119169],"text":""},"desc":"Remove unused variable 'setQuickAddModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddName' is assigned a value but never used.","line":2758,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":2758,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddName"},"fix":{"range":[119236,119248],"text":""},"desc":"Remove unused variable 'quickAddName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddName' is assigned a value but never used.","line":2758,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":2758,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddName"},"fix":{"range":[119248,119265],"text":""},"desc":"Remove unused variable 'setQuickAddName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddNumber' is assigned a value but never used.","line":2759,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":2759,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddNumber"},"fix":{"range":[119297,119311],"text":""},"desc":"Remove unused variable 'quickAddNumber'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddNumber' is assigned a value but never used.","line":2759,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":2759,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddNumber"},"fix":{"range":[119311,119330],"text":""},"desc":"Remove unused variable 'setQuickAddNumber'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showProjectCreated' is assigned a value but never used.","line":2760,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":2760,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"showProjectCreated"},"fix":{"range":[119362,119380],"text":""},"desc":"Remove unused variable 'showProjectCreated'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setShowProjectCreated' is assigned a value but never used.","line":2760,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":2760,"endColumn":55,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowProjectCreated"},"fix":{"range":[119380,119403],"text":""},"desc":"Remove unused variable 'setShowProjectCreated'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has an unnecessary dependency: 'selectProjectModal.visible'. Either exclude it or remove the dependency array. Outer scope values like 'selectProjectModal.visible' aren't valid dependencies because mutating them doesn't re-render the component.","line":2768,"column":10,"nodeType":"ArrayExpression","endLine":2768,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[119848,119876],"text":"[]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3275,"column":101,"nodeType":"Identifier","messageId":"unusedVar","endLine":3275,"endColumn":102},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3306,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3306,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3391,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":3391,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3406,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":3406,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3414,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":3414,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3428,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":3428,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3436,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":3436,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3449,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3449,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3531,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":3531,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3574,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":3574,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3831,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":3831,"endColumn":26},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4664,"column":55,"nodeType":"MemberExpression","endLine":4664,"endColumn":69},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4665,"column":53,"nodeType":"MemberExpression","endLine":4665,"endColumn":67},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddModal' is assigned a value but never used.","line":4666,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":4666,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddModal"},"fix":{"range":[240207,240220],"text":""},"desc":"Remove unused variable 'quickAddModal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddModal' is assigned a value but never used.","line":4666,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":4666,"endColumn":53,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddModal"},"fix":{"range":[240220,240238],"text":""},"desc":"Remove unused variable 'setQuickAddModal'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4666,"column":57,"nodeType":"MemberExpression","endLine":4666,"endColumn":71},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddName' is assigned a value but never used.","line":4667,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":4667,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddName"},"fix":{"range":[240319,240331],"text":""},"desc":"Remove unused variable 'quickAddName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddName' is assigned a value but never used.","line":4667,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":4667,"endColumn":51,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddName"},"fix":{"range":[240331,240348],"text":""},"desc":"Remove unused variable 'setQuickAddName'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4667,"column":55,"nodeType":"MemberExpression","endLine":4667,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'quickAddNumber' is assigned a value but never used.","line":4668,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":4668,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"quickAddNumber"},"fix":{"range":[240394,240408],"text":""},"desc":"Remove unused variable 'quickAddNumber'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setQuickAddNumber' is assigned a value but never used.","line":4668,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":4668,"endColumn":55,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQuickAddNumber"},"fix":{"range":[240408,240427],"text":""},"desc":"Remove unused variable 'setQuickAddNumber'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4668,"column":59,"nodeType":"MemberExpression","endLine":4668,"endColumn":73},{"ruleId":"no-unused-vars","severity":1,"message":"'showProjectCreated' is assigned a value but never used.","line":4669,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":4669,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"showProjectCreated"},"fix":{"range":[240473,240491],"text":""},"desc":"Remove unused variable 'showProjectCreated'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setShowProjectCreated' is assigned a value but never used.","line":4669,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":4669,"endColumn":63,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowProjectCreated"},"fix":{"range":[240491,240514],"text":""},"desc":"Remove unused variable 'setShowProjectCreated'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useState\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4669,"column":67,"nodeType":"MemberExpression","endLine":4669,"endColumn":81},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"React.useEffect\" cannot be called inside a callback. React Hooks must be called in a React function component or a custom React Hook function.","line":4676,"column":15,"nodeType":"MemberExpression","endLine":4676,"endColumn":30},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has an unnecessary dependency: 'selectProjectModal.visible'. Either exclude it or remove the dependency array. Outer scope values like 'selectProjectModal.visible' aren't valid dependencies because mutating them doesn't re-render the component.","line":4678,"column":18,"nodeType":"ArrayExpression","endLine":4678,"endColumn":46,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[241136,241164],"text":"[]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5007,"column":91,"nodeType":"Identifier","messageId":"unusedVar","endLine":5007,"endColumn":92},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5010,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":5010,"endColumn":30},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5011,"column":114,"nodeType":"Identifier","messageId":"unusedVar","endLine":5011,"endColumn":115}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'companyAdmins', 'loadCompanyAdmins', and 'loadingCompanyAdmins'. Either include them or remove the dependency array.","line":316,"column":6,"nodeType":"ArrayExpression","endLine":316,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [companyAdmins, loadCompanyAdmins, loadingCompanyAdmins, newProjectModal?.visible, routeCompanyId]","fix":{"range":[13846,13888],"text":"[companyAdmins, loadCompanyAdmins, loadingCompanyAdmins, newProjectModal?.visible, routeCompanyId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'routeCompanyId'. Either include it or remove the dependency array. Outer scope values like 'auth.currentUser.uid' aren't valid dependencies because mutating them doesn't re-render the component.","line":1846,"column":6,"nodeType":"ArrayExpression","endLine":1846,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, routeCompanyId]","fix":{"range":[81347,81382],"text":"[companyId, routeCompanyId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'companyId' and 'route.params.uid'. Either include them or remove the dependency array.","line":2056,"column":6,"nodeType":"ArrayExpression","endLine":2056,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, route.params.uid]","fix":{"range":[90257,90259],"text":"[companyId, route.params.uid]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":16,"fatalErrorCount":0,"warningCount":131,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport React, { useEffect, useRef, useState } from 'react';\r\nimport { Alert, Animated, Easing, ImageBackground, Keyboard, KeyboardAvoidingView, Modal, PanResponder, Platform, Pressable, ScrollView, Switch, Text, TextInput, TouchableOpacity, View, useWindowDimensions } from 'react-native';\r\nimport ContextMenu from '../components/ContextMenu';\r\nimport { auth, fetchCompanyMembers, fetchCompanyProfile, fetchControlsForProject, fetchHierarchy, fetchUserProfile, logCompanyActivity, saveControlToFirestore, saveDraftToFirestore, saveHierarchy, saveUserProfile, subscribeCompanyActivity, subscribeCompanyMembers, upsertCompanyMember } from '../components/firebase';\r\nimport { formatPersonName } from '../components/formatPersonName';\r\nimport useBackgroundSync from '../hooks/useBackgroundSync';\r\nimport ProjectDetails from './ProjectDetails';\r\nlet createPortal = null;\r\nif (Platform.OS === 'web') {\r\n  try { createPortal = require('react-dom').createPortal; } catch(e) { createPortal = null; }\r\n}\r\nlet portalRootId = 'dk-header-portal';\r\n\r\n// App version (displayed in sidebar)\r\nlet appVersion = '1.0.0';\r\ntry {\r\n  // require package.json at runtime for web/native dev builds\r\n   \r\n  const pkg = require('../package.json');\r\n  if (pkg && pkg.version) appVersion = String(pkg.version);\r\n    } catch (e) {\r\n      Alert.alert('Fel', 'Kunde inte läsa dk_last_fs_error: ' + (e?.message || String(e)));\r\n    }\r\n\r\nfunction getFirstName(email) {\r\n  if (!email) return '';\r\n  const localPart = email.split('@')[0];\r\n  return localPart.split('.')[0].charAt(0).toUpperCase() + localPart.split('.')[0].slice(1);\r\n}\r\n\r\nfunction isValidIsoDateYmd(value) {\r\n  const v = String(value || '').trim();\r\n  if (!v) return true;\r\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\r\n  const [yStr, mStr, dStr] = v.split('-');\r\n  const y = Number(yStr);\r\n  const m = Number(mStr);\r\n  const d = Number(dStr);\r\n  if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;\r\n  if (m < 1 || m > 12) return false;\r\n  if (d < 1 || d > 31) return false;\r\n  const dt = new Date(Date.UTC(y, m - 1, d));\r\n  return dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === d;\r\n}\r\n\r\nexport default function HomeScreen({ route, navigation }) {\r\n  const { height: windowHeight } = useWindowDimensions();\r\n  const [headerHeight, setHeaderHeight] = useState(0);\r\n  const leftTreeScrollRef = useRef(null);\r\n  const rightPaneScrollRef = useRef(null);\r\n  const activityScrollRef = useRef(null);\r\n  const hierarchyRef = useRef([]);\r\n\r\n  const webPaneHeight = Platform.OS === 'web'\r\n    ? Math.max(240, (windowHeight || 800) - (headerHeight || 140))\r\n    : undefined;\r\n\r\n  const scrollToEndSafe = (ref) => {\r\n    const node = ref?.current;\r\n    if (!node) return;\r\n    try {\r\n      if (typeof node.scrollToEnd === 'function') node.scrollToEnd({ animated: true });\r\n      else if (typeof node.scrollTo === 'function') node.scrollTo({ y: 1e9, animated: true });\r\n    } catch(e) {}\r\n  };\r\n\r\n  // companyId state is declared later in this component; referencing it early can crash on web.\r\n  // Use the route param as the safe early value for Firestore lookups.\r\n  const routeCompanyId = route?.params?.companyId || '';\r\n  // Testdata för demo-kontot (används av dold admin-knapp)\r\n  const testHierarchy = [\r\n    {\r\n      id: 'main1',\r\n      name: 'Byggprojekt',\r\n      expanded: false,\r\n      children: [\r\n        {\r\n          id: 'sub1',\r\n          name: 'Stockholm',\r\n          expanded: false,\r\n          children: [\r\n            { id: 'P-1001', name: 'Projekt Slussen', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\r\n            { id: 'P-1002', name: 'Projekt Hammarby', type: 'project', status: 'completed', createdAt: new Date().toISOString() }\r\n          ]\r\n        },\r\n        {\r\n          id: 'sub2',\r\n          name: 'Göteborg',\r\n          expanded: false,\r\n          children: [\r\n            { id: 'P-2001', name: 'Projekt Gamlestaden', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\r\n            { id: 'P-2002', name: 'Projekt Mölndal', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() }\r\n          ]\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      id: 'main2',\r\n      name: 'Serviceprojekt',\r\n      expanded: false,\r\n      children: [\r\n        {\r\n          id: 'sub3',\r\n          name: 'Malmö',\r\n          expanded: false,\r\n          children: [\r\n            { id: 'P-3001', name: 'Projekt Limhamn', type: 'project', status: 'completed', createdAt: new Date().toISOString() },\r\n            { id: 'P-3002', name: 'Projekt Hyllie', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() }\r\n          ]\r\n        },\r\n        {\r\n          id: 'sub4',\r\n          name: 'Uppsala',\r\n          expanded: false,\r\n          children: [\r\n            { id: 'P-4001', name: 'Projekt Gränby', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\r\n            { id: 'P-4002', name: 'Projekt Fyrislund', type: 'project', status: 'completed', createdAt: new Date().toISOString() }\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  ];\r\n\r\n  // Helper: collapse all expanded flags in a hierarchy (used on initial load)\r\n  const collapseHierarchy = (items) => {\r\n    if (!Array.isArray(items)) return [];\r\n    return items.map(m => ({\r\n      ...m,\r\n      expanded: false,\r\n      children: Array.isArray(m.children) ? m.children.map(s => ({\r\n        ...s,\r\n        expanded: false,\r\n        children: Array.isArray(s.children) ? s.children.map(ch => ({ ...ch })) : [],\r\n      })) : [],\r\n    }));\r\n  };\r\n  // Admin unlock (tap title 5 times)\r\n  const [adminTapCount, setAdminTapCount] = useState(0);\r\n  const [showAdminButton, setShowAdminButton] = useState(false);\r\n  const [adminActionRunning, setAdminActionRunning] = useState(false);\r\n  function handleAdminTitlePress() {\r\n    setAdminTapCount(c => {\r\n      if (c >= 4) {\r\n        setShowAdminButton(true);\r\n        return 0;\r\n      }\r\n      return c + 1;\r\n    });\r\n  }\r\n\r\n  // Support/debug tools should not be visible in normal UI.\r\n  // Shown only in development or after explicit admin-unlock.\r\n  const showSupportTools = __DEV__ || showAdminButton;\r\n\r\n  // Extra restriction: only show support/debug tools for admins, or for the dedicated demo company.\r\n  // This keeps normal companies/users clean while still enabling dev workflows.\r\n  const [authClaims, setAuthClaims] = useState(null);\r\n\r\n  React.useEffect(() => {\r\n    let active = true;\r\n    async function refreshClaims() {\r\n      try {\r\n        const user = auth?.currentUser;\r\n        if (!user) {\r\n          if (active) setAuthClaims(null);\r\n          return;\r\n        }\r\n        const tokenRes = await user.getIdTokenResult(false).catch((e) => null);\r\n        if (active) setAuthClaims(tokenRes?.claims || null);\r\n      } catch(e) {\r\n        if (active) setAuthClaims(null);\r\n      }\r\n    }\r\n\r\n    refreshClaims();\r\n    const unsub = auth?.onAuthStateChanged ? auth.onAuthStateChanged(() => { refreshClaims(); }) : null;\r\n    return () => {\r\n      active = false;\r\n      try { if (typeof unsub === 'function') unsub(); } catch(e) {}\r\n    };\r\n  }, []);\r\n\r\n  const isAdminUser = !!(authClaims && (authClaims.admin === true || authClaims.role === 'admin'));\r\n  // IMPORTANT: companyId state is initialized later in this component.\r\n  // Do not reference it here (TDZ on web). Use claims/route params instead.\r\n  const debugCompanyId = String(authClaims?.companyId || routeCompanyId || '').trim();\r\n  const isDemoCompany = debugCompanyId === 'MS Byggsystem DEMO' || debugCompanyId === 'demo-service' || debugCompanyId === 'demo-company';\r\n  // Only show support tools for:\r\n  // - Demo company (all users)\r\n  // - MS Byggsystem admins (dev accounts)\r\n  // This prevents other-company admins from seeing dev tools.\r\n  const isMsByggsystemCompany = debugCompanyId === 'MS Byggsystem';\r\n  const canShowSupportToolsInHeader = !!(showSupportTools && (isDemoCompany || (isMsByggsystemCompany && isAdminUser)));\r\n  \r\n  // Dev-only: promote current user to demo/admin and load test hierarchy\r\n  async function handleMakeDemoAdmin() {\r\n    if (!__DEV__) return;\r\n    if (adminActionRunning) return;\r\n    setAdminActionRunning(true);\r\n    try {\r\n      const user = auth.currentUser;\r\n      const demoCompanyId = 'demo-company';\r\n        if (user) {\r\n        await saveUserProfile(user.uid, {\r\n          companyId: demoCompanyId,\r\n          role: 'admin',\r\n          displayName: user.email ? user.email.split('@')[0] : 'Demo Admin',\r\n          email: user.email || null,\r\n          updatedAt: new Date().toISOString()\r\n        });\r\n        await AsyncStorage.setItem('dk_companyId', demoCompanyId);\r\n        setCompanyId(demoCompanyId);\r\n        setHierarchy(collapseHierarchy(testHierarchy));\r\n      }\r\n    } catch(e) {\r\n      console.log('[Home] make demo admin error', _e?.message || _e);\r\n    } finally {\r\n      setAdminActionRunning(false);\r\n      setShowAdminButton(false);\r\n    }\r\n  }\r\n\r\n  // Filtrera bort projekt med namnet '22 test' vid render\r\n  React.useEffect(() => {\r\n    setHierarchy(prev => prev.map(main => ({\r\n      ...main,\r\n      children: main.children.map(sub => ({\r\n        ...sub,\r\n        children: sub.children ? sub.children.filter(child => !(child.type === 'project' && child.name.trim().toLowerCase() === '22 test')) : []\r\n      }))\r\n    })));\r\n  }, []);\r\n  // State för nytt projekt-modal i undermapp\r\n  const [newProjectModal, setNewProjectModal] = useState({ visible: false, parentSubId: null });\r\n  const [newProjectName, setNewProjectName] = useState(\"\");\r\n  const [newProjectNumber, setNewProjectNumber] = useState(\"\");\r\n  const [newProjectResponsible, setNewProjectResponsible] = useState(null);\r\n  const [responsiblePickerVisible, setResponsiblePickerVisible] = useState(false);\r\n  const [companyAdmins, setCompanyAdmins] = useState([]);\r\n  const [loadingCompanyAdmins, setLoadingCompanyAdmins] = useState(false);\r\n  const [newProjectKeyboardLockHeight, setNewProjectKeyboardLockHeight] = useState(0);\r\n  const [companyAdminsLastFetchAt, setCompanyAdminsLastFetchAt] = useState(0);\r\n  const companyAdminsUnsubRef = useRef(null);\r\n  const [companyAdminsPermissionDenied, setCompanyAdminsPermissionDenied] = useState(false);\r\n\r\n  const [newProjectSkyddsrondEnabled, setNewProjectSkyddsrondEnabled] = useState(true);\r\n  const [newProjectSkyddsrondWeeks, setNewProjectSkyddsrondWeeks] = useState(2);\r\n  const [newProjectSkyddsrondFirstDueDate, setNewProjectSkyddsrondFirstDueDate] = useState('');\r\n  const [skyddsrondWeeksPickerVisible, setSkyddsrondWeeksPickerVisible] = useState(false);\r\n\r\n  const newProjectSkyddsrondFirstDueTrim = String(newProjectSkyddsrondFirstDueDate || '').trim();\r\n  const newProjectSkyddsrondFirstDueValid = (!newProjectSkyddsrondEnabled)\r\n    || (newProjectSkyddsrondFirstDueTrim !== '' && isValidIsoDateYmd(newProjectSkyddsrondFirstDueTrim));\r\n\r\n  const resetProjectFields = React.useCallback(() => {\r\n    try { setNewProjectName(''); } catch(e) {}\r\n    try { setNewProjectNumber(''); } catch(e) {}\r\n    try { setNewProjectResponsible(null); } catch(e) {}\r\n    try { setResponsiblePickerVisible(false); } catch(e) {}\r\n    try { setNewProjectKeyboardLockHeight(0); } catch(e) {}\r\n    try { setNewProjectSkyddsrondEnabled(true); } catch(e) {}\r\n    try { setNewProjectSkyddsrondWeeks(2); } catch(e) {}\r\n    try { setNewProjectSkyddsrondFirstDueDate(''); } catch(e) {}\r\n    try { setSkyddsrondWeeksPickerVisible(false); } catch(e) {}\r\n    // Best-effort: dismiss keyboard on native\r\n    try { if (Platform.OS !== 'web') Keyboard.dismiss(); } catch(e) {}\r\n  }, []);\r\n\r\n  const loadCompanyAdmins = React.useCallback(async ({ force } = { force: false }) => {\r\n    try {\r\n      if (!routeCompanyId) return;\r\n      if (loadingCompanyAdmins && !force) return;\r\n      setLoadingCompanyAdmins(true);\r\n      setCompanyAdminsPermissionDenied(false);\r\n      // Ensure at least the current user is present in members directory\r\n      // (Inline to avoid any scope issues on native/web builds.)\r\n      try {\r\n        const user = auth?.currentUser;\r\n        if (user?.uid) {\r\n          const profile = await fetchUserProfile(user.uid).catch((e) => null);\r\n          const displayName = profile?.displayName || profile?.name || (user.email ? String(user.email).split('@')[0] : null);\r\n          const role = profile?.role || null;\r\n          await upsertCompanyMember({\r\n            companyId: routeCompanyId || null,\r\n            uid: user.uid,\r\n            displayName,\r\n            email: user.email || null,\r\n            role,\r\n          });\r\n        }\r\n      } catch(e) {}\r\n      const admins = await fetchCompanyMembers(routeCompanyId, { role: 'admin' });\r\n      setCompanyAdmins(Array.isArray(admins) ? admins : []);\r\n      setCompanyAdminsLastFetchAt(Date.now());\r\n    } catch(e) {\r\n      const msg = String(_e?.message || _e || '').toLowerCase();\r\n      if (_e?.code === 'permission-denied' || msg.includes('permission')) setCompanyAdminsPermissionDenied(true);\r\n      setCompanyAdmins([]);\r\n    } finally {\r\n      setLoadingCompanyAdmins(false);\r\n    }\r\n  }, [routeCompanyId, loadingCompanyAdmins]);\r\n\r\n  // If the create-project modal opens before companyId is ready, onShow can early-return.\r\n  // This effect ensures admins are fetched as soon as companyId is available while the modal is open.\r\n  React.useEffect(() => {\r\n    if (!newProjectModal?.visible) return;\r\n    if (!routeCompanyId) return;\r\n    // Avoid refetch loop; only fetch if we have nothing yet.\r\n    if (companyAdmins && companyAdmins.length > 0) return;\r\n    if (loadingCompanyAdmins) return;\r\n    loadCompanyAdmins({ force: false });\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [newProjectModal?.visible, routeCompanyId]);\r\n\r\n  // While the ansvarig picker is open, subscribe to admins in realtime.\r\n  // This avoids the common \"empty cache\" problem on fresh logins.\r\n  React.useEffect(() => {\r\n    if (!responsiblePickerVisible) {\r\n      try { if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current(); } catch(e) {}\r\n      companyAdminsUnsubRef.current = null;\r\n      return;\r\n    }\r\n    if (!routeCompanyId) return;\r\n\r\n    setLoadingCompanyAdmins(true);\r\n    setCompanyAdminsPermissionDenied(false);\r\n    try {\r\n      if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current();\r\n    } catch(e) {}\r\n    companyAdminsUnsubRef.current = subscribeCompanyMembers(routeCompanyId, {\r\n      role: 'admin',\r\n      onData: (admins) => {\r\n        setCompanyAdmins(Array.isArray(admins) ? admins : []);\r\n        setCompanyAdminsLastFetchAt(Date.now());\r\n        setLoadingCompanyAdmins(false);\r\n      },\r\n      onError: (err) => {\r\n        const msg = String(err?.message || err || '').toLowerCase();\r\n        if (err?.code === 'permission-denied' || msg.includes('permission')) setCompanyAdminsPermissionDenied(true);\r\n        setLoadingCompanyAdmins(false);\r\n      }\r\n    });\r\n\r\n    return () => {\r\n      try { if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current(); } catch(e) {}\r\n      companyAdminsUnsubRef.current = null;\r\n    };\r\n  }, [responsiblePickerVisible, routeCompanyId]);\r\n\r\n  // Track native keyboard height for the create-project modal.\r\n  // We keep this separate from the search modal keyboard handling to avoid stale/reset values.\r\n  const [nativeKeyboardHeight, setNativeKeyboardHeight] = useState(0);\r\n  const nativeKeyboardHeightRef = useRef(0);\r\n\r\n  React.useEffect(() => {\r\n    if (Platform.OS === 'web') return;\r\n    const subs = [];\r\n    const onShow = (e) => {\r\n      const h = e?.endCoordinates?.height || 0;\r\n      nativeKeyboardHeightRef.current = h;\r\n      setNativeKeyboardHeight(h);\r\n    };\r\n    const onHide = () => {\r\n      nativeKeyboardHeightRef.current = 0;\r\n      setNativeKeyboardHeight(0);\r\n    };\r\n\r\n    subs.push(Keyboard.addListener('keyboardWillShow', onShow));\r\n    subs.push(Keyboard.addListener('keyboardWillHide', onHide));\r\n    subs.push(Keyboard.addListener('keyboardDidShow', onShow));\r\n    subs.push(Keyboard.addListener('keyboardDidHide', onHide));\r\n\r\n    return () => {\r\n      for (const s of subs) {\r\n        try { s.remove(); } catch(e) {}\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // Modal för nytt projekt i undermapp (läggs utanför return)\r\n  // State for project selection modal (for creating controls)\r\n  const [selectProjectModal, setSelectProjectModal] = useState({ visible: false, type: null });\r\n  const [showControlTypeModal, setShowControlTypeModal] = useState(false);\r\n\r\n  // Check that a project number/id is unique across the whole hierarchy.\r\n  // Must be declared before any JSX/constants that reference it (RN-web TDZ).\r\n  const isProjectNumberUnique = React.useCallback((num) => {\r\n    if (!num) return true;\r\n    const n = String(num ?? '').trim();\r\n    if (!n) return true;\r\n    try {\r\n      for (const main of (hierarchyRef.current || [])) {\r\n        for (const sub of (main.children || [])) {\r\n          if (Array.isArray(sub.children) && sub.children.some(child => child?.type === 'project' && String(child.id) === n)) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n    } catch(e) {}\r\n    return true;\r\n  }, []);\r\n\r\n  const newProjectModalComponent = (\r\n    <Modal\r\n      visible={newProjectModal.visible}\r\n      transparent\r\n      animationType=\"fade\"\r\n      onShow={async () => {\r\n        // Fetch admins when the modal opens\r\n        await loadCompanyAdmins({ force: false });\r\n      }}\r\n      onRequestClose={() => {\r\n        setNewProjectModal({ visible: false, parentSubId: null });\r\n        resetProjectFields();\r\n        setNewProjectKeyboardLockHeight(0);\r\n      }}\r\n    >\r\n      {Platform.OS === 'web' ? (\r\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n          <Pressable\r\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n            onPress={() => {\r\n              setNewProjectModal({ visible: false, parentSubId: null });\r\n              resetProjectFields();\r\n            }}\r\n          />\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <TouchableOpacity\r\n              style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n              onPress={() => {\r\n                setNewProjectModal({ visible: false, parentSubId: null });\r\n                resetProjectFields();\r\n              }}\r\n              hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n            >\r\n              <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n            </TouchableOpacity>\r\n\r\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center', marginTop: 6 }}>Skapa nytt projekt</Text>\r\n\r\n            <TextInput\r\n              value={newProjectNumber}\r\n              onChangeText={(v) => {\r\n                // RN-web can sometimes deliver an event object; normalize to string to avoid crashes.\r\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n                setNewProjectNumber(String(next));\r\n              }}\r\n              placeholder=\"Projektnummer...\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor: String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) ? '#D32F2F' : '#e0e0e0',\r\n                borderRadius: 8,\r\n                padding: 10,\r\n                fontSize: 16,\r\n                marginBottom: 10,\r\n                backgroundColor: '#fafafa',\r\n                color: !isProjectNumberUnique(newProjectNumber) && String(newProjectNumber ?? '').trim() !== '' ? '#D32F2F' : '#222'\r\n              }}\r\n              autoFocus\r\n              keyboardType=\"default\"\r\n            />\r\n            {String(newProjectNumber ?? '').trim() !== '' && !isProjectNumberUnique(newProjectNumber) && (\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 4, marginBottom: 6 }}>\r\n                <Ionicons name=\"warning\" size={18} color=\"#D32F2F\" style={{ marginRight: 6 }} />\r\n                <Text style={{ color: '#D32F2F', fontSize: 15, fontWeight: 'bold' }}>Projektnummer används redan.</Text>\r\n              </View>\r\n            )}\r\n\r\n            <TextInput\r\n              value={newProjectName}\r\n              onChangeText={(v) => {\r\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n                setNewProjectName(String(next));\r\n              }}\r\n              placeholder=\"Projektnamn...\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor: String(newProjectName ?? '').trim() === '' ? '#D32F2F' : '#e0e0e0',\r\n                borderRadius: 8,\r\n                padding: 10,\r\n                fontSize: 16,\r\n                marginBottom: 12,\r\n                backgroundColor: '#fafafa',\r\n                color: '#222'\r\n              }}\r\n              keyboardType=\"default\"\r\n            />\r\n\r\n            {/* Ansvarig (required) */}\r\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n              Ansvarig\r\n            </Text>\r\n            <TouchableOpacity\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor: newProjectResponsible ? '#e0e0e0' : '#D32F2F',\r\n                borderRadius: 8,\r\n                paddingVertical: 10,\r\n                paddingHorizontal: 10,\r\n                marginBottom: 12,\r\n                backgroundColor: '#fafafa',\r\n                flexDirection: 'row',\r\n                alignItems: 'center',\r\n                justifyContent: 'space-between'\r\n              }}\r\n              onPress={() => setResponsiblePickerVisible(true)}\r\n              activeOpacity={0.8}\r\n            >\r\n              <Text style={{ fontSize: 16, color: newProjectResponsible ? '#222' : '#888' }} numberOfLines={1}>\r\n                {newProjectResponsible ? formatPersonName(newProjectResponsible) : 'Välj ansvarig...'}\r\n              </Text>\r\n              <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n            </TouchableOpacity>\r\n\r\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n              Första skyddsrond senast\r\n            </Text>\r\n            <TextInput\r\n              value={newProjectSkyddsrondFirstDueDate}\r\n              onChangeText={(v) => {\r\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n                setNewProjectSkyddsrondFirstDueDate(String(next));\r\n              }}\r\n              placeholder=\"YYYY-MM-DD\"\r\n              placeholderTextColor=\"#888\"\r\n              editable={!!newProjectSkyddsrondEnabled}\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor: (!newProjectSkyddsrondFirstDueValid && newProjectSkyddsrondEnabled) ? '#D32F2F' : '#e0e0e0',\r\n                borderRadius: 8,\r\n                padding: 10,\r\n                fontSize: 16,\r\n                marginBottom: 12,\r\n                backgroundColor: '#fafafa',\r\n                color: '#222',\r\n                opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\r\n              }}\r\n            />\r\n\r\n            {newProjectSkyddsrondEnabled && !newProjectSkyddsrondFirstDueValid && (\r\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\r\n                Du måste fylla i datum (YYYY-MM-DD).\r\n              </Text>\r\n            )}\r\n\r\n            {!newProjectResponsible && (\r\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\r\n                Du måste välja ansvarig.\r\n              </Text>\r\n            )}\r\n\r\n            <Modal\r\n              visible={responsiblePickerVisible}\r\n              transparent\r\n              animationType=\"fade\"\r\n              onRequestClose={() => setResponsiblePickerVisible(false)}\r\n            >\r\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n                <Pressable\r\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                  onPress={() => setResponsiblePickerVisible(false)}\r\n                />\r\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\r\n                    Välj ansvarig\r\n                  </Text>\r\n                  {loadingCompanyAdmins ? (\r\n                    <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\r\n                      Laddar...\r\n                    </Text>\r\n                  ) : (companyAdmins.length === 0 ? (\r\n                    <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\r\n                      Inga admins hittades i företaget.\r\n                    </Text>\r\n                  ) : (\r\n                    <ScrollView style={{ maxHeight: 420 }}>\r\n                      {companyAdmins.map((m) => (\r\n                        <TouchableOpacity\r\n                          key={m.id || m.uid || m.email}\r\n                          style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                          onPress={() => {\r\n                            setNewProjectResponsible({\r\n                              uid: m.uid || m.id,\r\n                              displayName: m.displayName || null,\r\n                              email: m.email || null,\r\n                              role: m.role || null,\r\n                            });\r\n                            setResponsiblePickerVisible(false);\r\n                          }}\r\n                        >\r\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\r\n                            {formatPersonName(m)}\r\n                          </Text>\r\n                        </TouchableOpacity>\r\n                      ))}\r\n                    </ScrollView>\r\n                  ))}\r\n\r\n                  <TouchableOpacity\r\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                    onPress={() => setResponsiblePickerVisible(false)}\r\n                  >\r\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            </Modal>\r\n\r\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n              Skyddsronder\r\n            </Text>\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>\r\n              <Text style={{ fontSize: 15, color: '#555' }}>Aktiva</Text>\r\n              <Switch\r\n                value={!!newProjectSkyddsrondEnabled}\r\n                onValueChange={(v) => setNewProjectSkyddsrondEnabled(!!v)}\r\n              />\r\n            </View>\r\n\r\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n              Veckor mellan skyddsronder\r\n            </Text>\r\n            <TouchableOpacity\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor: '#e0e0e0',\r\n                borderRadius: 8,\r\n                paddingVertical: 10,\r\n                paddingHorizontal: 10,\r\n                marginBottom: 12,\r\n                backgroundColor: '#fafafa',\r\n                flexDirection: 'row',\r\n                alignItems: 'center',\r\n                justifyContent: 'space-between',\r\n                opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\r\n              }}\r\n              disabled={!newProjectSkyddsrondEnabled}\r\n              onPress={() => setSkyddsrondWeeksPickerVisible(true)}\r\n              activeOpacity={0.8}\r\n            >\r\n              <Text style={{ fontSize: 16, color: '#222' }} numberOfLines={1}>\r\n                {String(newProjectSkyddsrondWeeks || 2)}\r\n              </Text>\r\n              <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n            </TouchableOpacity>\r\n\r\n            <Modal\r\n              visible={skyddsrondWeeksPickerVisible}\r\n              transparent\r\n              animationType=\"fade\"\r\n              onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\r\n            >\r\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n                <Pressable\r\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n                />\r\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\r\n                    Veckor mellan skyddsronder\r\n                  </Text>\r\n                  {[1, 2, 3, 4].map((w) => (\r\n                    <TouchableOpacity\r\n                      key={String(w)}\r\n                      style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                      onPress={() => {\r\n                        setNewProjectSkyddsrondWeeks(w);\r\n                        setSkyddsrondWeeksPickerVisible(false);\r\n                      }}\r\n                    >\r\n                      <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\r\n                        {w}\r\n                      </Text>\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                  <TouchableOpacity\r\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                    onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n                  >\r\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            </Modal>\r\n\r\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n              <TouchableOpacity\r\n                style={{\r\n                  backgroundColor: '#1976D2',\r\n                  borderRadius: 8,\r\n                  paddingVertical: 12,\r\n                  alignItems: 'center',\r\n                  flex: 1,\r\n                  marginRight: 8,\r\n                  opacity: (String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible) ? 0.5 : 1\r\n                }}\r\n                disabled={String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible}\r\n                onPress={() => {\r\n                  // Insert new project into selected subfolder\r\n                  setHierarchy(prev => prev.map(main => ({\r\n                    ...main,\r\n                    children: main.children.map(sub =>\r\n                      sub.id === newProjectModal.parentSubId\r\n                        ? {\r\n                            ...sub,\r\n                            children: [\r\n                              ...(sub.children || []),\r\n                              {\r\n                                id: String(newProjectNumber ?? '').trim(),\r\n                                name: String(newProjectName ?? '').trim(),\r\n                                type: 'project',\r\n                                status: 'ongoing',\r\n                                skyddsrondEnabled: !!newProjectSkyddsrondEnabled,\r\n                                skyddsrondIntervalWeeks: Number(newProjectSkyddsrondWeeks) || 2,\r\n                                skyddsrondFirstDueDate: String(newProjectSkyddsrondFirstDueDate || '').trim() || null,\r\n                                ansvarig: formatPersonName(newProjectResponsible),\r\n                                ansvarigId: newProjectResponsible?.uid || null,\r\n                                createdAt: new Date().toISOString(),\r\n                                createdBy: auth?.currentUser?.email || ''\r\n                              }\r\n                            ]\r\n                          }\r\n                        : sub\r\n                    )\r\n                  })));\r\n                  setNewProjectModal({ visible: false, parentSubId: null });\r\n                  resetProjectFields();\r\n                }}\r\n              >\r\n                <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>Skapa</Text>\r\n              </TouchableOpacity>\r\n\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\r\n                onPress={() => {\r\n                  setNewProjectModal({ visible: false, parentSubId: null });\r\n                  resetProjectFields();\r\n                }}\r\n              >\r\n                <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n              </TouchableOpacity>\r\n            </View>\r\n          </View>\r\n        </View>\r\n      ) : (\r\n        (() => {\r\n          const effectiveKb = responsiblePickerVisible\r\n            ? Math.max(nativeKeyboardHeight || 0, newProjectKeyboardLockHeight || 0)\r\n            : (nativeKeyboardHeight || 0);\r\n          // Lift the modal above the keyboard. Keep a small margin so it doesn't over-shoot.\r\n          const lift = Math.max(0, effectiveKb - 12);\r\n          return (\r\n            <View style={{ flex: 1, justifyContent: 'flex-end', alignItems: 'center', paddingBottom: 16 + lift }}>\r\n            <Pressable\r\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n              onPress={() => {\r\n                setNewProjectModal({ visible: false, parentSubId: null });\r\n                resetProjectFields();\r\n                setNewProjectKeyboardLockHeight(0);\r\n              }}\r\n            />\r\n            <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n          <TouchableOpacity\r\n            style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n            onPress={() => {\r\n              setNewProjectModal({ visible: false, parentSubId: null });\r\n              resetProjectFields();\r\n            }}\r\n            hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n          >\r\n            <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n          </TouchableOpacity>\r\n\r\n          <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center', marginTop: 6 }}>Skapa nytt projekt</Text>\r\n\r\n          <TextInput\r\n            value={newProjectNumber}\r\n            onChangeText={(v) => {\r\n              // RN-web can sometimes deliver an event object; normalize to string to avoid crashes.\r\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n              setNewProjectNumber(String(next));\r\n            }}\r\n            placeholder=\"Projektnummer...\"\r\n            placeholderTextColor=\"#888\"\r\n            style={{\r\n              borderWidth: 1,\r\n              borderColor: String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) ? '#D32F2F' : '#e0e0e0',\r\n              borderRadius: 8,\r\n              padding: 10,\r\n              fontSize: 16,\r\n              marginBottom: 10,\r\n              backgroundColor: '#fafafa',\r\n              color: !isProjectNumberUnique(newProjectNumber) && String(newProjectNumber ?? '').trim() !== '' ? '#D32F2F' : '#222'\r\n            }}\r\n            autoFocus\r\n            keyboardType=\"default\"\r\n          />\r\n          {String(newProjectNumber ?? '').trim() !== '' && !isProjectNumberUnique(newProjectNumber) && (\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 4, marginBottom: 6 }}>\r\n              <Ionicons name=\"warning\" size={18} color=\"#D32F2F\" style={{ marginRight: 6 }} />\r\n              <Text style={{ color: '#D32F2F', fontSize: 15, fontWeight: 'bold' }}>Projektnummer används redan.</Text>\r\n            </View>\r\n          )}\r\n\r\n          <TextInput\r\n            value={newProjectName}\r\n            onChangeText={(v) => {\r\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n              setNewProjectName(String(next));\r\n            }}\r\n            placeholder=\"Projektnamn...\"\r\n            placeholderTextColor=\"#888\"\r\n            style={{\r\n              borderWidth: 1,\r\n              borderColor: String(newProjectName ?? '').trim() === '' ? '#D32F2F' : '#e0e0e0',\r\n              borderRadius: 8,\r\n              padding: 10,\r\n              fontSize: 16,\r\n              marginBottom: 12,\r\n              backgroundColor: '#fafafa',\r\n              color: '#222'\r\n            }}\r\n            keyboardType=\"default\"\r\n          />\r\n\r\n          {/* Ansvarig (required) */}\r\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n            Ansvarig\r\n          </Text>\r\n          <TouchableOpacity\r\n            style={{\r\n              borderWidth: 1,\r\n              borderColor: newProjectResponsible ? '#e0e0e0' : '#D32F2F',\r\n              borderRadius: 8,\r\n              paddingVertical: 10,\r\n              paddingHorizontal: 10,\r\n              marginBottom: 12,\r\n              backgroundColor: '#fafafa',\r\n              flexDirection: 'row',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between'\r\n            }}\r\n            onPress={() => {\r\n              // Opening the picker dismisses the keyboard on iOS/Android.\r\n              // Lock the current keyboard height so this modal doesn't jump down.\r\n              setNewProjectKeyboardLockHeight(nativeKeyboardHeightRef.current || nativeKeyboardHeight || 0);\r\n              try { Keyboard.dismiss(); } catch(e) {}\r\n              // If admins weren't loaded yet (or modal opened too early), fetch now.\r\n              if ((!companyAdmins || companyAdmins.length === 0) && !loadingCompanyAdmins) {\r\n                loadCompanyAdmins({ force: true });\r\n              }\r\n              setResponsiblePickerVisible(true);\r\n            }}\r\n            activeOpacity={0.8}\r\n          >\r\n            <Text style={{ fontSize: 16, color: newProjectResponsible ? '#222' : '#888' }} numberOfLines={1}>\r\n              {newProjectResponsible ? formatPersonName(newProjectResponsible) : 'Välj ansvarig...'}\r\n            </Text>\r\n            <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n          </TouchableOpacity>\r\n\r\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n            Första skyddsrond senast\r\n          </Text>\r\n          <TextInput\r\n            value={newProjectSkyddsrondFirstDueDate}\r\n            onChangeText={(v) => {\r\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\r\n              setNewProjectSkyddsrondFirstDueDate(String(next));\r\n            }}\r\n            placeholder=\"YYYY-MM-DD\"\r\n            placeholderTextColor=\"#888\"\r\n            editable={!!newProjectSkyddsrondEnabled}\r\n            style={{\r\n              borderWidth: 1,\r\n                borderColor: (!newProjectSkyddsrondFirstDueValid && newProjectSkyddsrondEnabled) ? '#D32F2F' : '#e0e0e0',\r\n              borderRadius: 8,\r\n              padding: 10,\r\n              fontSize: 16,\r\n              marginBottom: 12,\r\n              backgroundColor: '#fafafa',\r\n              color: '#222',\r\n              opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\r\n            }}\r\n          />\r\n\r\n            {newProjectSkyddsrondEnabled && !newProjectSkyddsrondFirstDueValid && (\r\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\r\n                Du måste fylla i datum (YYYY-MM-DD).\r\n              </Text>\r\n            )}\r\n\r\n          {!newProjectResponsible && (\r\n            <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\r\n              Du måste välja ansvarig.\r\n            </Text>\r\n          )}\r\n\r\n          <Modal\r\n            visible={responsiblePickerVisible}\r\n            transparent\r\n            animationType=\"fade\"\r\n            onRequestClose={() => {\r\n              setResponsiblePickerVisible(false);\r\n              setNewProjectKeyboardLockHeight(0);\r\n            }}\r\n          >\r\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n              <Pressable\r\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                onPress={() => {\r\n                  setResponsiblePickerVisible(false);\r\n                  setNewProjectKeyboardLockHeight(0);\r\n                }}\r\n              />\r\n              <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\r\n                  Välj ansvarig\r\n                </Text>\r\n                {loadingCompanyAdmins ? (\r\n                  <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\r\n                    Laddar...\r\n                  </Text>\r\n                ) : companyAdminsPermissionDenied ? (\r\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\r\n                    Saknar behörighet att läsa admins i företaget. Logga ut/in eller kontakta admin.\r\n                  </Text>\r\n                ) : companyAdmins.length === 0 ? (\r\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\r\n                    Inga admins hittades i företaget. Om du nyss lades till, logga ut/in och försök igen.\r\n                  </Text>\r\n                ) : (\r\n                  <ScrollView style={{ maxHeight: 420 }}>\r\n                    {companyAdmins.map((m) => (\r\n                      <TouchableOpacity\r\n                        key={m.id || m.uid || m.email}\r\n                        style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                        onPress={() => {\r\n                          setNewProjectResponsible({\r\n                            uid: m.uid || m.id,\r\n                            displayName: m.displayName || null,\r\n                            email: m.email || null,\r\n                            role: m.role || null,\r\n                          });\r\n                          setResponsiblePickerVisible(false);\r\n                          setNewProjectKeyboardLockHeight(0);\r\n                        }}\r\n                      >\r\n                        <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\r\n                          {formatPersonName(m)}\r\n                        </Text>\r\n                      </TouchableOpacity>\r\n                    ))}\r\n                  </ScrollView>\r\n                )}\r\n\r\n                <TouchableOpacity\r\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                  onPress={() => {\r\n                    setResponsiblePickerVisible(false);\r\n                    setNewProjectKeyboardLockHeight(0);\r\n                  }}\r\n                >\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n\r\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n            Skyddsronder\r\n          </Text>\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>\r\n            <Text style={{ fontSize: 15, color: '#555' }}>Aktiva</Text>\r\n            <Switch\r\n              value={!!newProjectSkyddsrondEnabled}\r\n              onValueChange={(v) => setNewProjectSkyddsrondEnabled(!!v)}\r\n            />\r\n          </View>\r\n\r\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\r\n            Veckor mellan skyddsronder\r\n          </Text>\r\n          <TouchableOpacity\r\n            style={{\r\n              borderWidth: 1,\r\n              borderColor: '#e0e0e0',\r\n              borderRadius: 8,\r\n              paddingVertical: 10,\r\n              paddingHorizontal: 10,\r\n              marginBottom: 12,\r\n              backgroundColor: '#fafafa',\r\n              flexDirection: 'row',\r\n              alignItems: 'center',\r\n              justifyContent: 'space-between',\r\n              opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\r\n            }}\r\n            disabled={!newProjectSkyddsrondEnabled}\r\n            onPress={() => setSkyddsrondWeeksPickerVisible(true)}\r\n            activeOpacity={0.8}\r\n          >\r\n            <Text style={{ fontSize: 16, color: '#222' }} numberOfLines={1}>\r\n              {String(newProjectSkyddsrondWeeks || 2)}\r\n            </Text>\r\n            <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n          </TouchableOpacity>\r\n\r\n          <Modal\r\n            visible={skyddsrondWeeksPickerVisible}\r\n            transparent\r\n            animationType=\"fade\"\r\n            onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\r\n          >\r\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n              <Pressable\r\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n              />\r\n              <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\r\n                  Veckor mellan skyddsronder\r\n                </Text>\r\n                {[1, 2, 3, 4].map((w) => (\r\n                  <TouchableOpacity\r\n                    key={String(w)}\r\n                    style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                    onPress={() => {\r\n                      setNewProjectSkyddsrondWeeks(w);\r\n                      setSkyddsrondWeeksPickerVisible(false);\r\n                    }}\r\n                  >\r\n                    <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\r\n                      {w}\r\n                    </Text>\r\n                  </TouchableOpacity>\r\n                ))}\r\n                <TouchableOpacity\r\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n                >\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n\r\n          <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n            <TouchableOpacity\r\n              style={{\r\n                backgroundColor: '#1976D2',\r\n                borderRadius: 8,\r\n                paddingVertical: 12,\r\n                alignItems: 'center',\r\n                flex: 1,\r\n                marginRight: 8,\r\n                opacity: (String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible || !newProjectSkyddsrondFirstDueValid) ? 0.5 : 1\r\n              }}\r\n              disabled={String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible || !newProjectSkyddsrondFirstDueValid}\r\n              onPress={() => {\r\n                // Insert new project into selected subfolder\r\n                setHierarchy(prev => prev.map(main => ({\r\n                  ...main,\r\n                  children: main.children.map(sub =>\r\n                    sub.id === newProjectModal.parentSubId\r\n                      ? {\r\n                          ...sub,\r\n                          children: [\r\n                            ...(sub.children || []),\r\n                            {\r\n                              id: String(newProjectNumber ?? '').trim(),\r\n                              name: String(newProjectName ?? '').trim(),\r\n                              type: 'project',\r\n                              status: 'ongoing',\r\n                              skyddsrondEnabled: !!newProjectSkyddsrondEnabled,\r\n                              skyddsrondIntervalWeeks: Number(newProjectSkyddsrondWeeks) || 2,\r\n                              skyddsrondFirstDueDate: newProjectSkyddsrondEnabled ? (String(newProjectSkyddsrondFirstDueDate || '').trim() || null) : null,\r\n                              ansvarig: formatPersonName(newProjectResponsible),\r\n                              ansvarigId: newProjectResponsible?.uid || null,\r\n                              createdAt: new Date().toISOString(),\r\n                              createdBy: auth?.currentUser?.email || ''\r\n                            }\r\n                          ]\r\n                        }\r\n                      : sub\r\n                  )\r\n                })));\r\n                setNewProjectModal({ visible: false, parentSubId: null });\r\n                resetProjectFields();\r\n              }}\r\n            >\r\n              <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>Skapa</Text>\r\n            </TouchableOpacity>\r\n\r\n            <TouchableOpacity\r\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\r\n              onPress={() => {\r\n                setNewProjectModal({ visible: false, parentSubId: null });\r\n                resetProjectFields();\r\n              }}\r\n            >\r\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n            </View>\r\n          );\r\n        })()\r\n      )}\r\n    </Modal>\r\n  );\r\n    // Ref for main folder long press timers\r\n    const mainTimersRef = React.useRef({});\r\n  // Clean up timer on unmount (only one, correct placement)\r\n  React.useEffect(() => {\r\n    return () => {\r\n      if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\r\n    };\r\n  }, []);\r\n          // Ref for long press timer\r\n          const projektLongPressTimer = React.useRef(null);\r\n        // State for new main folder modal\r\n        const [newFolderModalVisible, setNewFolderModalVisible] = useState(false);\r\n      // State for edit modal (main or sub group)\r\n      const [editModal, setEditModal] = useState({ visible: false, type: '', id: null, name: '' });\r\n    // Helper to count ongoing and completed projects\r\n    function countProjectStatus(tree) {\r\n      let ongoing = 0;\r\n      let completed = 0;\r\n      if (!Array.isArray(tree)) return { ongoing, completed };\r\n      tree.forEach(main => {\r\n        if (main.children && Array.isArray(main.children)) {\r\n          main.children.forEach(sub => {\r\n            if (sub.children && Array.isArray(sub.children)) {\r\n              sub.children.forEach(child => {\r\n                if (child.type === 'project') {\r\n                  if (child.status === 'completed') completed++;\r\n                  else ongoing++;\r\n                }\r\n              });\r\n            }\r\n          });\r\n        }\r\n      });\r\n      return { ongoing, completed };\r\n    }\r\n  // Helper to remove last main folder\r\n  const removeLastMainFolder = () => {\r\n    setHierarchy(prev => prev.length > 0 ? prev.slice(0, -1) : prev);\r\n  };\r\n  // Helper to check if folder name is unique\r\n  const isFolderNameUnique = (name) => !hierarchy.some(folder => folder.name.trim().toLowerCase() === name.trim().toLowerCase());\r\n\r\n  // State for new subfolder modal\r\n  const [newSubModal, setNewSubModal] = useState({ visible: false, parentId: null });\r\n  const [newSubName, setNewSubName] = useState('');\r\n  // Helper to count all projects in the hierarchy\r\n  function countProjects(tree) {\r\n    let count = 0;\r\n    if (!Array.isArray(tree)) return count;\r\n    tree.forEach(main => {\r\n      if (main.children && Array.isArray(main.children)) {\r\n        main.children.forEach(sub => {\r\n          if (sub.children && Array.isArray(sub.children)) {\r\n            count += sub.children.filter(child => child.type === 'project').length;\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return count;\r\n  }\r\n  const email = route?.params?.email || '';\r\n  const firstName = getFirstName(email);\r\n  const [loggingOut, setLoggingOut] = useState(false);\r\n  // companyId kan komma från route.params eller användarprofil\r\n  const [companyId, setCompanyId] = useState(() => route?.params?.companyId || '');\r\n\r\n  // Persist companyId locally (used as fallback in other screens) and\r\n  // allow resolving companyId from auth claims when route params are missing.\r\n  React.useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const current = String(companyId || '').trim();\r\n        const fromClaims = String(authClaims?.companyId || '').trim();\r\n        const cid = current || fromClaims;\r\n        if (!cid) return;\r\n        if (!current && fromClaims) {\r\n          setCompanyId(fromClaims);\r\n        }\r\n        const stored = await AsyncStorage.getItem('dk_companyId');\r\n        if (stored !== cid) {\r\n          await AsyncStorage.setItem('dk_companyId', cid);\r\n        }\r\n      } catch(e) {}\r\n    })();\r\n  }, [companyId, authClaims?.companyId]);\r\n  // Laddningsstate för hierarkin\r\n  const [loadingHierarchy, setLoadingHierarchy] = useState(true);\r\n  const [hierarchy, setHierarchy] = useState([]);\r\n  const [localFallbackExists, setLocalFallbackExists] = useState(false);\r\n  const [syncStatus, setSyncStatus] = useState('idle');\r\n  const [selectedProject, setSelectedProject] = useState(null);\r\n  const selectedProjectRef = useRef(null);\r\n  const [isInlineLocked, setIsInlineLocked] = useState(false);\r\n  const pendingProjectSwitchRef = useRef(null);\r\n  const [projectControlsRefreshNonce, setProjectControlsRefreshNonce] = useState(0);\r\n\r\n  // Used to request a specific action when opening a project from the dashboard (e.g. open a draft inline)\r\n  const [projectSelectedAction, setProjectSelectedAction] = useState(null);\r\n\r\n  const [dashboardLoading, setDashboardLoading] = useState(false);\r\n  const [dashboardOverview, setDashboardOverview] = useState({\r\n    activeProjects: 0,\r\n    openDeviations: 0,\r\n    skyddsrondOverdue: 0,\r\n    skyddsrondDueSoon: 0,\r\n    controlsToSign: 0,\r\n    drafts: 0,\r\n  });\r\n  const [dashboardRecent, setDashboardRecent] = useState([]);\r\n  const [dashboardRecentProjects, setDashboardRecentProjects] = useState([]);\r\n  const [companyActivity, setCompanyActivity] = useState([]);\r\n\r\n  // Dashboard drill-down + hover (used mainly on web)\r\n  const [dashboardFocus, setDashboardFocus] = useState(null); // 'activeProjects' | 'drafts' | 'controlsToSign' | 'upcomingSkyddsrond' | 'openDeviations'\r\n  const [dashboardHoveredStatKey, setDashboardHoveredStatKey] = useState(null);\r\n  const [dashboardActiveProjectsList, setDashboardActiveProjectsList] = useState([]);\r\n  const [dashboardDraftItems, setDashboardDraftItems] = useState([]);\r\n  const [dashboardControlsToSignItems, setDashboardControlsToSignItems] = useState([]);\r\n  const [dashboardOpenDeviationItems, setDashboardOpenDeviationItems] = useState([]);\r\n  const [dashboardUpcomingSkyddsrondItems, setDashboardUpcomingSkyddsrondItems] = useState([]);\r\n  const [dashboardDropdownAnchor, setDashboardDropdownAnchor] = useState('overview');\r\n  const [dashboardDropdownTop, setDashboardDropdownTop] = useState(null);\r\n\r\n  const dashboardCardLayoutRef = useRef({ overview: null, reminders: null });\r\n  const dashboardStatRowLayoutRef = useRef({});\r\n\r\n  const toggleDashboardFocus = (key, anchor, top) => {\r\n    if (!key) return;\r\n    if (anchor) setDashboardDropdownAnchor(anchor);\r\n    setDashboardFocus((prev) => {\r\n      const next = prev === key ? null : key;\r\n      if (next) {\r\n        setDashboardDropdownTop(typeof top === 'number' ? top : null);\r\n      } else {\r\n        setDashboardDropdownTop(null);\r\n      }\r\n      return next;\r\n    });\r\n  };\r\n\r\n  // Keep ref in sync for popstate handler\r\n  React.useEffect(() => {\r\n    selectedProjectRef.current = selectedProject;\r\n  }, [selectedProject]);\r\n\r\n  const handleInlineLockChange = React.useCallback((locked) => {\r\n    setIsInlineLocked(!!locked);\r\n  }, []);\r\n\r\n  const requestProjectSwitch = React.useCallback((project, opts = {}) => {\r\n    if (!project) {\r\n      if (Object.prototype.hasOwnProperty.call(opts, 'selectedAction')) {\r\n        setProjectSelectedAction(opts.selectedAction);\r\n      }\r\n      setSelectedProject(null);\r\n      return;\r\n    }\r\n\r\n    const nextProject = { ...project };\r\n    const selectedActionProvided = Object.prototype.hasOwnProperty.call(opts, 'selectedAction');\r\n    const clearActionAfter = !!opts.clearActionAfter;\r\n\r\n    if (Platform.OS === 'web' && isInlineLocked) {\r\n      pendingProjectSwitchRef.current = {\r\n        project: nextProject,\r\n        selectedAction: selectedActionProvided ? opts.selectedAction : null,\r\n        clearActionAfter,\r\n      };\r\n      try {\r\n        window.dispatchEvent(new CustomEvent('dkInlineAttemptExit'));\r\n      } catch(e) {\r\n        // Fallback: if event dispatch fails, proceed immediately.\r\n        if (selectedActionProvided) setProjectSelectedAction(opts.selectedAction);\r\n        setSelectedProject(nextProject);\r\n        if (clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (selectedActionProvided) setProjectSelectedAction(opts.selectedAction);\r\n    setSelectedProject(nextProject);\r\n    if (clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\r\n  }, [isInlineLocked]);\r\n\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const onDecision = (event) => {\r\n      const decision = event?.detail?.decision;\r\n      const pending = pendingProjectSwitchRef.current;\r\n      pendingProjectSwitchRef.current = null;\r\n\r\n      if (!pending) return;\r\n      if (decision !== 'draft' && decision !== 'abort') return;\r\n\r\n      try { setProjectSelectedAction(pending.selectedAction ?? null); } catch(e) {}\r\n      setSelectedProject({ ...pending.project });\r\n      if (pending.clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\r\n    };\r\n\r\n    window.addEventListener('dkInlineExitDecision', onDecision);\r\n    return () => {\r\n      try { window.removeEventListener('dkInlineExitDecision', onDecision); } catch(e) {}\r\n    };\r\n  }, []);\r\n\r\n  const findProjectById = React.useCallback((projectId) => {\r\n    if (!projectId) return null;\r\n    const targetId = String(projectId);\r\n    try {\r\n      const tree = hierarchyRef.current || [];\r\n      for (const main of tree) {\r\n        for (const sub of (main.children || [])) {\r\n          for (const child of (sub.children || [])) {\r\n            if (child && child.type === 'project' && String(child.id) === targetId) return child;\r\n          }\r\n        }\r\n      }\r\n    } catch(e) {}\r\n    return null;\r\n  }, []);\r\n\r\n  const toTsMs = React.useCallback((value) => {\r\n    try {\r\n      if (value === null || value === undefined) return 0;\r\n      if (typeof value === 'number') return Number.isFinite(value) ? value : 0;\r\n      if (typeof value === 'string') return new Date(value).getTime() || 0;\r\n      if (typeof value?.toDate === 'function') return value.toDate().getTime() || 0;\r\n      if (typeof value?.seconds === 'number') return (value.seconds * 1000) + (typeof value.nanoseconds === 'number' ? Math.floor(value.nanoseconds / 1e6) : 0);\r\n      return new Date(value).getTime() || 0;\r\n    } catch(e) {\r\n      return 0;\r\n    }\r\n  }, []);\r\n\r\n  const formatRelativeTime = React.useCallback((isoLike) => {\r\n    try {\r\n      const t = toTsMs(isoLike);\r\n      if (!t) return '';\r\n      const diffMs = Date.now() - t;\r\n      const diffSec = Math.max(0, Math.floor(diffMs / 1000));\r\n      if (diffSec < 60) return 'för nyss';\r\n      const diffMin = Math.floor(diffSec / 60);\r\n      if (diffMin < 60) return `för ${diffMin} minut${diffMin === 1 ? '' : 'er'} sedan`;\r\n      const diffH = Math.floor(diffMin / 60);\r\n      if (diffH < 24) return `för ${diffH} tim${diffH === 1 ? 'me' : 'mar'} sedan`;\r\n      const diffD = Math.floor(diffH / 24);\r\n      if (diffD < 7) return `för ${diffD} dag${diffD === 1 ? '' : 'ar'} sedan`;\r\n      return new Date(t).toLocaleDateString('sv-SE');\r\n    } catch(e) {\r\n      return '';\r\n    }\r\n  }, [toTsMs]);\r\n\r\n  const computeOpenDeviationsCount = React.useCallback((controls) => {\r\n    try {\r\n      let open = 0;\r\n      for (const item of (controls || [])) {\r\n        if (!item || item.type !== 'Skyddsrond') continue;\r\n        // Saved controls may use different shapes over time:\r\n        // - Newer: item.checklist (array of sections) with section.remediation keyed by point text\r\n        // - Older: item.checklistSections with section.remediation indexed by point index\r\n        const sections = Array.isArray(item.checklistSections)\r\n          ? item.checklistSections\r\n          : (Array.isArray(item.checklist) ? item.checklist : null);\r\n        if (!Array.isArray(sections)) continue;\r\n        for (const section of sections) {\r\n          if (!section || !Array.isArray(section.statuses)) continue;\r\n          section.statuses.forEach((status, idx) => {\r\n            if (status !== 'avvikelse') return;\r\n            const points = Array.isArray(section.points) ? section.points : [];\r\n            const pt = points[idx];\r\n            const rem = section.remediation\r\n              ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[idx]\r\n              : null;\r\n            const handled = !!rem;\r\n            if (!handled) open += 1;\r\n          });\r\n        }\r\n      }\r\n      return open;\r\n    } catch(e) {\r\n      return 0;\r\n    }\r\n  }, []);\r\n\r\n  const computeControlsToSign = React.useCallback((drafts) => {\r\n    try {\r\n      let count = 0;\r\n      for (const item of (drafts || [])) {\r\n        if (!item) continue;\r\n        const type = String(item.type || '');\r\n        if (type !== 'Mottagningskontroll' && type !== 'Riskbedömning') continue;\r\n        const sigs = item.mottagningsSignatures;\r\n        if (!Array.isArray(sigs) || sigs.length === 0) count++;\r\n      }\r\n      return count;\r\n    } catch(e) {\r\n      return 0;\r\n    }\r\n  }, []);\r\n\r\n  const countActiveProjects = React.useCallback(() => {\r\n    try {\r\n      let active = 0;\r\n      const tree = hierarchyRef.current || [];\r\n      for (const main of tree) {\r\n        for (const sub of (main.children || [])) {\r\n          for (const child of (sub.children || [])) {\r\n            if (child && child.type === 'project') {\r\n              const status = child.status || 'ongoing';\r\n              if (status !== 'completed') active++;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      return active;\r\n    } catch(e) {\r\n      return 0;\r\n    }\r\n  }, []);\r\n\r\n  const loadDashboard = React.useCallback(async () => {\r\n    setDashboardLoading(true);\r\n    try {\r\n      const [draftRaw, completedRaw] = await Promise.all([\r\n        AsyncStorage.getItem('draft_controls'),\r\n        AsyncStorage.getItem('completed_controls'),\r\n      ]);\r\n      const drafts = draftRaw ? (JSON.parse(draftRaw) || []) : [];\r\n      const completed = completedRaw ? (JSON.parse(completedRaw) || []) : [];\r\n\r\n      // Important: draft/completed controls are stored locally without company-scoping.\r\n      // Filter them to only include projects that exist in the current company's hierarchy.\r\n      const allowedProjectIds = new Set();\r\n      try {\r\n        const tree = hierarchyRef.current || [];\r\n        for (const main of tree) {\r\n          for (const sub of (main.children || [])) {\r\n            for (const child of (sub.children || [])) {\r\n              if (child && child.type === 'project' && child.id) allowedProjectIds.add(String(child.id));\r\n            }\r\n          }\r\n        }\r\n      } catch(e) {}\r\n\r\n      const pickProjectId = (item) => {\r\n        const pid = item?.project?.id || item?.projectId || item?.project || null;\r\n        return pid ? String(pid) : null;\r\n      };\r\n\r\n      const filteredDrafts = (drafts || []).filter((d) => {\r\n        const pid = pickProjectId(d);\r\n        return pid && allowedProjectIds.has(pid);\r\n      });\r\n      const filteredCompleted = (completed || []).filter((c) => {\r\n        const pid = pickProjectId(c);\r\n        return pid && allowedProjectIds.has(pid);\r\n      });\r\n\r\n      // Store lists for dashboard drill-down\r\n      try { setDashboardDraftItems(Array.isArray(filteredDrafts) ? filteredDrafts : []); } catch(e) {}\r\n\r\n      try {\r\n        const activeList = [];\r\n        const tree = hierarchyRef.current || [];\r\n        for (const main of tree) {\r\n          for (const sub of (main.children || [])) {\r\n            for (const child of (sub.children || [])) {\r\n              if (!child || child.type !== 'project') continue;\r\n              const status = child.status || 'ongoing';\r\n              if (status === 'completed') continue;\r\n              activeList.push(child);\r\n            }\r\n          }\r\n        }\r\n        setDashboardActiveProjectsList(activeList);\r\n      } catch(e) {\r\n        try { setDashboardActiveProjectsList([]); } catch(e) {}\r\n      }\r\n\r\n      try {\r\n        const needSign = (filteredDrafts || []).filter((item) => {\r\n          if (!item) return false;\r\n          const type = String(item.type || '');\r\n          if (type !== 'Mottagningskontroll' && type !== 'Riskbedömning') return false;\r\n          const sigs = item.mottagningsSignatures;\r\n          return !Array.isArray(sigs) || sigs.length === 0;\r\n        });\r\n        setDashboardControlsToSignItems(needSign);\r\n      } catch(e) {\r\n        try { setDashboardControlsToSignItems([]); } catch(e) {}\r\n      }\r\n\r\n      const activeProjects = countActiveProjects();\r\n      const openDeviations = computeOpenDeviationsCount(filteredCompleted);\r\n      const controlsToSign = computeControlsToSign(filteredDrafts);\r\n\r\n      // Skyddsrond interval reminders (default: 14 days)\r\n      const MS_DAY = 24 * 60 * 60 * 1000;\r\n      const NOW = Date.now();\r\n      const SOON_THRESHOLD_DAYS = 3;\r\n      const lastSkyddsrondByProject = new Map();\r\n      try {\r\n        (filteredCompleted || []).forEach((c) => {\r\n          if (!c || c.type !== 'Skyddsrond') return;\r\n          const pid = pickProjectId(c);\r\n          if (!pid) return;\r\n          const ts = toTsMs(c.date || c.savedAt || c.updatedAt || c.createdAt || null);\r\n          if (!ts) return;\r\n          const prev = lastSkyddsrondByProject.get(pid) || 0;\r\n          if (ts > prev) lastSkyddsrondByProject.set(pid, ts);\r\n        });\r\n      } catch(e) {}\r\n\r\n      let skyddsrondOverdue = 0;\r\n      let skyddsrondDueSoon = 0;\r\n      const upcomingSkyddsrond = [];\r\n      try {\r\n        const tree = hierarchyRef.current || [];\r\n        for (const main of tree) {\r\n          for (const sub of (main.children || [])) {\r\n            for (const child of (sub.children || [])) {\r\n              if (!child || child.type !== 'project' || !child.id) continue;\r\n              const status = child.status || 'ongoing';\r\n              if (status === 'completed') continue;\r\n\r\n              const pid = String(child.id);\r\n              const enabled = child.skyddsrondEnabled !== false;\r\n              if (!enabled) continue;\r\n\r\n              const intervalWeeksRaw = Number(child.skyddsrondIntervalWeeks);\r\n              const intervalDaysRaw = Number(child.skyddsrondIntervalDays);\r\n              const intervalDays = (Number.isFinite(intervalWeeksRaw) && intervalWeeksRaw > 0)\r\n                ? (intervalWeeksRaw * 7)\r\n                : (Number.isFinite(intervalDaysRaw) && intervalDaysRaw > 0 ? intervalDaysRaw : 14);\r\n\r\n              const lastMs = lastSkyddsrondByProject.get(pid) || 0;\r\n              const firstDueMs = toTsMs(child.skyddsrondFirstDueDate || null);\r\n              const baselineMs = lastMs || toTsMs(child.createdAt || null) || NOW;\r\n              const nextDueMs = lastMs\r\n                ? (baselineMs + intervalDays * MS_DAY)\r\n                : (firstDueMs || (baselineMs + intervalDays * MS_DAY));\r\n\r\n              if (NOW > nextDueMs) {\r\n                skyddsrondOverdue += 1;\r\n                upcomingSkyddsrond.push({ project: child, nextDueMs, state: 'overdue' });\r\n              } else if ((nextDueMs - NOW) <= (SOON_THRESHOLD_DAYS * MS_DAY)) {\r\n                skyddsrondDueSoon += 1;\r\n                upcomingSkyddsrond.push({ project: child, nextDueMs, state: 'dueSoon' });\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } catch(e) {}\r\n\r\n      try {\r\n        upcomingSkyddsrond.sort((a, b) => Number(a?.nextDueMs || 0) - Number(b?.nextDueMs || 0));\r\n        setDashboardUpcomingSkyddsrondItems(upcomingSkyddsrond);\r\n      } catch(e) {\r\n        try { setDashboardUpcomingSkyddsrondItems([]); } catch(e) {}\r\n      }\r\n\r\n      const countOpenDeviationsForControl = (control) => {\r\n        try {\r\n          if (!control || control.type !== 'Skyddsrond') return 0;\r\n          const sections = Array.isArray(control.checklistSections)\r\n            ? control.checklistSections\r\n            : (Array.isArray(control.checklist) ? control.checklist : null);\r\n          if (!Array.isArray(sections)) return 0;\r\n          let open = 0;\r\n          for (const section of sections) {\r\n            if (!section || !Array.isArray(section.statuses)) continue;\r\n            const points = Array.isArray(section.points) ? section.points : [];\r\n            for (let i = 0; i < section.statuses.length; i++) {\r\n              if (section.statuses[i] !== 'avvikelse') continue;\r\n              const pt = points[i];\r\n              const rem = section.remediation\r\n                ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[i]\r\n                : null;\r\n              if (!rem) open += 1;\r\n            }\r\n          }\r\n          return open;\r\n        } catch(e) {\r\n          return 0;\r\n        }\r\n      };\r\n\r\n      try {\r\n        const openDevItems = (filteredCompleted || [])\r\n          .filter((c) => c && c.type === 'Skyddsrond')\r\n          .map((c) => ({ control: c, openCount: countOpenDeviationsForControl(c) }))\r\n          .filter((x) => (x.openCount || 0) > 0);\r\n        setDashboardOpenDeviationItems(openDevItems);\r\n      } catch(e) {\r\n        try { setDashboardOpenDeviationItems([]); } catch(e) {}\r\n      }\r\n\r\n      const recent = [];\r\n      const pushRecent = (item, kind) => {\r\n        if (!item || typeof item !== 'object') return;\r\n        const ts = item.savedAt || item.updatedAt || item.createdAt || item.date || null;\r\n        const projectId = pickProjectId(item);\r\n        if (!projectId) return;\r\n        // Only show activity for projects we know belong to this company.\r\n        if (!allowedProjectIds.has(projectId)) return;\r\n        const projObj = findProjectById(projectId);\r\n        if (!projObj) return;\r\n        const projectName = projObj?.name || null;\r\n        const desc = String(item.deliveryDesc || item.materialDesc || item.generalNote || item.description || '').trim();\r\n        recent.push({\r\n          kind,\r\n          type: item.type || kind,\r\n          ts,\r\n          projectId,\r\n          projectName,\r\n          desc,\r\n          openDeviationsCount: (kind === 'completed' && item.type === 'Skyddsrond') ? countOpenDeviationsForControl(item) : 0,\r\n          raw: item,\r\n        });\r\n      };\r\n      (filteredCompleted || []).forEach((c) => pushRecent(c, 'completed'));\r\n      (filteredDrafts || []).forEach((d) => pushRecent(d, 'draft'));\r\n\r\n      // Merge in company activity (e.g. login events). These may not have a projectId.\r\n      try {\r\n        const events = Array.isArray(companyActivity) ? companyActivity : [];\r\n        events.forEach((ev) => {\r\n          if (!ev || typeof ev !== 'object') return;\r\n          const eventType = String(ev.type || '').toLowerCase();\r\n          if (eventType !== 'login') return;\r\n          const who = String(ev.displayName || ev.email || ev.uid || '').trim();\r\n          recent.push({\r\n            kind: 'company',\r\n            type: 'login',\r\n            ts: ev.ts || ev.createdAt || ev.updatedAt || null,\r\n            projectId: null,\r\n            projectName: null,\r\n            desc: who ? `Loggade in: ${who}` : 'Loggade in',\r\n            actorName: ev.displayName || null,\r\n            actorEmail: ev.email || null,\r\n            raw: ev,\r\n          });\r\n        });\r\n      } catch(e) {}\r\n      recent.sort((a, b) => {\r\n        return toTsMs(b.ts) - toTsMs(a.ts);\r\n      });\r\n      const top = recent.slice(0, 8);\r\n\r\n      // Derive recent projects from recent activity (unique by projectId)\r\n      const projMap = new Map();\r\n      for (const r of recent) {\r\n        if (!r.projectId) continue;\r\n        const prev = projMap.get(r.projectId);\r\n        const t = toTsMs(r.ts);\r\n        if (!prev || t > prev.ts) projMap.set(r.projectId, { ts: t });\r\n      }\r\n      const recentProjects = Array.from(projMap.entries())\r\n        .map(([projectId, meta]) => {\r\n          const p = findProjectById(projectId);\r\n          return p ? { project: p, projectId: String(projectId), ts: meta.ts } : null;\r\n        })\r\n        .filter(Boolean)\r\n        .sort((a, b) => (b.ts || 0) - (a.ts || 0))\r\n        .slice(0, 8);\r\n\r\n      setDashboardOverview({\r\n        activeProjects,\r\n        openDeviations,\r\n        skyddsrondOverdue,\r\n        skyddsrondDueSoon,\r\n        controlsToSign,\r\n        drafts: Array.isArray(filteredDrafts) ? filteredDrafts.length : 0,\r\n      });\r\n      setDashboardRecent(top);\r\n      setDashboardRecentProjects(recentProjects);\r\n    } catch(e) {\r\n      setDashboardOverview({ activeProjects: 0, openDeviations: 0, skyddsrondOverdue: 0, skyddsrondDueSoon: 0, controlsToSign: 0, drafts: 0 });\r\n      setDashboardRecent([]);\r\n      setDashboardRecentProjects([]);\r\n    } finally {\r\n      setDashboardLoading(false);\r\n    }\r\n  }, [companyActivity, countActiveProjects, computeControlsToSign, computeOpenDeviationsCount, findProjectById, toTsMs]);\r\n\r\n  // Web: keep browser back/forward in sync with selectedProject\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    if (typeof window === 'undefined') return;\r\n    if (!window.history) return;\r\n\r\n    // Ensure we have a stable \"home\" state\r\n    try {\r\n      const st = window.history.state || {};\r\n      if (!st.dkView) window.history.replaceState({ ...st, dkView: 'home' }, '');\r\n    } catch(e) {}\r\n\r\n    const onPopState = (e) => {\r\n      try {\r\n        const st = e?.state || window.history.state || {};\r\n        if (st && st.dkView === 'project' && st.projectId) {\r\n          const proj = findProjectById(st.projectId);\r\n          // Clear any pending dashboard action when navigating with browser back/forward.\r\n          setProjectSelectedAction(null);\r\n          if (proj) setSelectedProject({ ...proj });\r\n          else setSelectedProject(null);\r\n        } else {\r\n          setProjectSelectedAction(null);\r\n          setSelectedProject(null);\r\n        }\r\n      } catch(e) {\r\n        setProjectSelectedAction(null);\r\n        setSelectedProject(null);\r\n      }\r\n    };\r\n\r\n    window.addEventListener('popstate', onPopState);\r\n    return () => {\r\n      try { window.removeEventListener('popstate', onPopState); } catch(e) {}\r\n    };\r\n  }, [findProjectById]);\r\n\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    if (typeof window === 'undefined') return;\r\n    if (!window.history || typeof window.history.pushState !== 'function') return;\r\n\r\n    const proj = selectedProject;\r\n    if (proj && proj.id) {\r\n      try {\r\n        const st = window.history.state || {};\r\n        // Avoid pushing duplicates\r\n        if (st.dkView === 'project' && String(st.projectId || '') === String(proj.id)) return;\r\n        window.history.pushState({ ...st, dkView: 'project', projectId: String(proj.id) }, '');\r\n      } catch(e) {}\r\n    }\r\n  }, [selectedProject?.id]);\r\n\r\n  const closeSelectedProject = React.useCallback(() => {\r\n    // UX requirement: the in-app back button should always leave the project\r\n    // and return to the dashboard (not the previously opened project).\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined' && window.history && typeof window.history.replaceState === 'function') {\r\n      try {\r\n        const st = window.history.state || {};\r\n        window.history.replaceState({ ...st, dkView: 'home', projectId: null }, '');\r\n      } catch(e) {}\r\n    }\r\n    setProjectSelectedAction(null);\r\n    setSelectedProject(null);\r\n  }, []);\r\n\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    // Refresh dashboard when returning to start panel or after sync/hierarchy changes.\r\n    if (!selectedProject) loadDashboard();\r\n  }, [selectedProject, syncStatus, hierarchy, companyActivity, loadDashboard]);\r\n\r\n  // Realtime company activity feed (company-scoped).\r\n  React.useEffect(() => {\r\n    const cid = String(companyId || routeCompanyId || authClaims?.companyId || '').trim();\r\n    if (!cid) return;\r\n    const unsub = subscribeCompanyActivity(cid, {\r\n      limitCount: 25,\r\n      onData: (items) => {\r\n        try { setCompanyActivity(Array.isArray(items) ? items : []); } catch(e) {}\r\n      },\r\n      onError: () => {},\r\n    });\r\n    return () => {\r\n      try { if (typeof unsub === 'function') unsub(); } catch(e) {}\r\n    };\r\n  }, [companyId, routeCompanyId, authClaims?.companyId]);\r\n\r\n  // Log a login event (throttled) so other users can see who logs in.\r\n  React.useEffect(() => {\r\n    const cid = String(companyId || routeCompanyId || authClaims?.companyId || '').trim();\r\n    const user = auth?.currentUser;\r\n    if (!cid) return;\r\n    if (!user?.uid && !user?.email) return;\r\n\r\n    let cancelled = false;\r\n    (async () => {\r\n      try {\r\n        const idPart = user?.uid || user?.email || 'unknown';\r\n        const throttleKey = `dk_last_login_activity:${cid}:${idPart}`;\r\n        const last = await AsyncStorage.getItem(throttleKey);\r\n        if (last) {\r\n          const lastMs = new Date(last).getTime() || 0;\r\n          if (lastMs && (Date.now() - lastMs) < 5 * 60 * 1000) return;\r\n        }\r\n        const ok = await logCompanyActivity({\r\n          type: 'login',\r\n          uid: user?.uid || null,\r\n          email: user?.email || null,\r\n          displayName: user?.displayName || null,\r\n        }, cid);\r\n        if (!ok) return;\r\n        if (cancelled) return;\r\n        await AsyncStorage.setItem(throttleKey, new Date().toISOString());\r\n      } catch(e) {}\r\n    })();\r\n\r\n    return () => { cancelled = true; };\r\n  }, [companyId, routeCompanyId, authClaims?.companyId, auth?.currentUser?.uid, auth?.currentUser?.email]);\r\n\r\n  // Ensure current user is written to the company members directory (so admin dropdown works)\r\n  React.useEffect(() => {\r\n    if (!companyId) return;\r\n    if (!auth?.currentUser?.uid) return;\r\n    // Inline the upsert to avoid any scope issues on native/web builds.\r\n    (async () => {\r\n      try {\r\n        const user = auth?.currentUser;\r\n        if (!user?.uid) return;\r\n        const profile = await fetchUserProfile(user.uid).catch((e) => null);\r\n        const displayName = profile?.displayName || profile?.name || (user.email ? String(user.email).split('@')[0] : null);\r\n        const role = profile?.role || null;\r\n        await upsertCompanyMember({\r\n          companyId: routeCompanyId || null,\r\n          uid: user.uid,\r\n          displayName,\r\n          email: user.email || null,\r\n          role,\r\n        });\r\n      } catch(e) {}\r\n    })();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [companyId, auth?.currentUser?.uid]);\r\n\r\n  // Keep ref in sync for early-defined helpers/modals\r\n  React.useEffect(() => {\r\n    hierarchyRef.current = hierarchy;\r\n  }, [hierarchy]);\r\n\r\n  // Company profile (used for per-company feature visibility)\r\n  const [companyProfile, setCompanyProfile] = useState(null);\r\n\r\n  const controlTypeOptions = React.useMemo(() => {\r\n    const all = [\r\n      { type: 'Arbetsberedning', icon: 'construct-outline', color: '#1976D2' },\r\n      { type: 'Egenkontroll', icon: 'checkmark-done-outline', color: '#388E3C' },\r\n      { type: 'Fuktmätning', icon: 'water-outline', color: '#0288D1' },\r\n      { type: 'Mottagningskontroll', icon: 'checkbox-outline', color: '#7B1FA2' },\r\n      { type: 'Riskbedömning', icon: 'warning-outline', color: '#FFD600' },\r\n      { type: 'Skyddsrond', icon: 'shield-half-outline', color: '#388E3C' }\r\n    ];\r\n\r\n    const enabled = companyProfile?.enabledControlTypes;\r\n    const filtered = Array.isArray(enabled)\r\n      ? all.filter(o => enabled.includes(o.type))\r\n      : all;\r\n\r\n    return filtered.slice().sort((a, b) => a.type.localeCompare(b.type));\r\n  }, [companyProfile]);\r\n\r\n  // Load company profile when companyId changes\r\n  React.useEffect(() => {\r\n    let active = true;\r\n    if (!companyId) {\r\n      setCompanyProfile(null);\r\n      return () => { active = false; };\r\n    }\r\n    fetchCompanyProfile(companyId)\r\n      .then((p) => { if (active) setCompanyProfile(p || null); })\r\n      .catch((e) => { /* ignore */ });\r\n    return () => { active = false; };\r\n  }, [companyId]);\r\n\r\n  // Recompute whether any local fallback data exists (hierarki eller kontroller)\r\n  async function refreshLocalFallbackFlag() {\r\n    try {\r\n      const [h, c, d] = await Promise.all([\r\n        AsyncStorage.getItem('hierarchy_local'),\r\n        AsyncStorage.getItem('completed_controls'),\r\n        AsyncStorage.getItem('draft_controls'),\r\n      ]);\r\n      const exists = !!((h && h !== '[]') || (c && c !== '[]') || (d && d !== '[]'));\r\n      setLocalFallbackExists(exists);\r\n    } catch(e) {}\r\n  }\r\n  \r\n  // Debug helper: dump local AsyncStorage keys and compare with Firestore counts\r\n  async function dumpLocalRemoteControls() {\r\n    try {\r\n      const keys = ['hierarchy_local', 'completed_controls', 'draft_controls', 'completed_controls_backup', 'draft_controls_backup'];\r\n      const data = {};\r\n      for (const k of keys) {\r\n        try {\r\n          const raw = await AsyncStorage.getItem(k);\r\n          data[k] = raw ? JSON.parse(raw) : null;\r\n        } catch(e) { data[k] = null; }\r\n      }\r\n      // Build summary\r\n      const summary = {\r\n        completed_count: Array.isArray(data.completed_controls) ? data.completed_controls.length : 0,\r\n        draft_count: Array.isArray(data.draft_controls) ? data.draft_controls.length : 0,\r\n        backups: {\r\n          completed_backup_exists: !!data.completed_controls_backup,\r\n          draft_backup_exists: !!data.draft_controls_backup,\r\n        },\r\n      };\r\n\r\n      // Query Firestore for any project IDs found in local completed controls\r\n      const projectIds = new Set();\r\n      (data.completed_controls || []).forEach(c => { if (c && c.project && c.project.id) projectIds.add(String(c.project.id)); });\r\n      (data.draft_controls || []).forEach(d => { if (d && d.project && d.project.id) projectIds.add(String(d.project.id)); });\r\n\r\n      const remoteInfo = {};\r\n      for (const pid of projectIds) {\r\n        try {\r\n          const remote = await fetchControlsForProject(pid, companyId).catch((e) => []);\r\n          remoteInfo[pid] = { remote_count: Array.isArray(remote) ? remote.length : 0, sample_ids: (remote || []).slice(0,5).map(r => r.id) };\r\n        } catch(e) {\r\n          remoteInfo[pid] = { remote_count: -1, error: String(_e) };\r\n        }\r\n      }\r\n      const final = { summary, remote: remoteInfo, sample_local_completed: (data.completed_controls || []).slice(0,5).map(c => ({ id: c.id, projectId: c.project?.id })) };\r\n      try { console.log('[dumpLocalRemoteControls] full dump', final); } catch(e) {}\r\n      Alert.alert('Debug: lokal vs moln', JSON.stringify(final, null, 2).slice(0,1000));\r\n    } catch(e) {\r\n      Alert.alert('Debug-fel', String(_e));\r\n    }\r\n  }\r\n\r\n  // Show the last Firestore error saved by firebase helpers\r\n  async function showLastFsError() {\r\n    try {\r\n      // Prefer the full errors array if available\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      if (rawArr) {\r\n        let parsedArr = null;\r\n        try { parsedArr = JSON.parse(rawArr); } catch(e) { parsedArr = [rawArr]; }\r\n        // Show the most recent entry first (arrays can get huge)\r\n        const last = Array.isArray(parsedArr) ? parsedArr[parsedArr.length - 1] : parsedArr;\r\n        return Alert.alert('Senaste FS-fel', JSON.stringify(last, null, 2).slice(0,2000));\r\n      }\r\n      // Fallback to single-entry key for older records\r\n      const raw = await AsyncStorage.getItem('dk_last_fs_error');\r\n      if (!raw) return Alert.alert('Senaste FS-fel', 'Ingen fel-logg hittades.');\r\n      let parsed = null;\r\n      try { parsed = JSON.parse(raw); } catch(e) { parsed = { raw }; }\r\n      Alert.alert('Senaste FS-fel', JSON.stringify(parsed, null, 2).slice(0,2000));\r\n    } catch(e) {\r\n      Alert.alert('Fel', 'Kunde inte läsa dk_last_fs_error: ' + (_e?.message || _e));\r\n    }\r\n  }\r\n  \r\n\r\n  // start background sync hook\r\n  const bg = useBackgroundSync(companyId, { onStatus: (s) => setSyncStatus(s) });\r\n  const didInitialLoadRef = React.useRef(false);\r\n\r\n  // Left column resizer state (default 320)\r\n  const [leftWidth, setLeftWidth] = useState(320);\r\n  const leftWidthRef = useRef(leftWidth);\r\n  useEffect(() => { leftWidthRef.current = leftWidth; }, [leftWidth]);\r\n  const initialLeftRef = useRef(0);\r\n\r\n  // PanResponder for resizing the left column (works on web + native)\r\n  const panResponder = useRef(PanResponder.create({\r\n    onStartShouldSetPanResponder: (evt, gestureState) => true,\r\n    onPanResponderGrant: () => {\r\n      initialLeftRef.current = leftWidthRef.current;\r\n    },\r\n    onPanResponderMove: (evt, gestureState) => {\r\n      const dx = gestureState.dx || 0;\r\n      const newWidth = Math.max(240, Math.min(800, initialLeftRef.current + dx));\r\n      setLeftWidth(newWidth);\r\n    },\r\n    onPanResponderRelease: () => {},\r\n    onPanResponderTerminate: () => {},\r\n  })).current;\r\n\r\n\r\n  // Ladda hierarchy från Firestore vid appstart\r\n  React.useEffect(() => {\r\n    (async () => {\r\n      let cid = companyId;\r\n      // If companyId not provided via params, try user profile by uid\r\n      if (!cid && route?.params?.uid) {\r\n        const userProfile = await fetchUserProfile(route.params.uid);\r\n        if (userProfile && userProfile.companyId) {\r\n          cid = userProfile.companyId;\r\n          setCompanyId(cid);\r\n        }\r\n      }\r\n      // As a last resort try local stored companyId (dk_companyId)\r\n      if (!cid) {\r\n        try {\r\n          const stored = await AsyncStorage.getItem('dk_companyId');\r\n          if (stored) {\r\n            cid = stored;\r\n            setCompanyId(cid);\r\n          }\r\n        } catch(e) {}\r\n      }\r\n      if (cid) {\r\n        setLoadingHierarchy(true);\r\n        const items = await fetchHierarchy(cid);\r\n        if (Array.isArray(items) && items.length > 0) {\r\n          setHierarchy(collapseHierarchy(items));\r\n        } else {\r\n          // Firestore empty or failed — try local AsyncStorage fallback\r\n          try {\r\n            const raw = await AsyncStorage.getItem('hierarchy_local');\r\n            if (raw) {\r\n              const parsed = JSON.parse(raw);\r\n              if (Array.isArray(parsed) && parsed.length > 0) {\r\n                setHierarchy(collapseHierarchy(parsed));\r\n                setLocalFallbackExists(true);\r\n                // Try to push local fallback to Firestore (best-effort)\r\n                try {\r\n                  const pushedRes = await saveHierarchy(cid, parsed);\r\n                  const pushed = pushedRes === true || (pushedRes && pushedRes.ok === true);\r\n                  if (pushed) {\r\n                    try { await AsyncStorage.removeItem('hierarchy_local'); } catch(e) {}\r\n                    await refreshLocalFallbackFlag();\r\n                  } else {\r\n                    try { console.error('[Home] push local fallback error', pushedRes && pushedRes.error ? pushedRes.error : pushedRes); } catch(e) {}\r\n                  }\r\n                } catch(e) {}\r\n              } else {\r\n                setHierarchy([]);\r\n              }\r\n            } else {\r\n              setHierarchy([]);\r\n            }\r\n          } catch(e) {\r\n            setHierarchy([]);\r\n          }\r\n        }\r\n        setLoadingHierarchy(false);\r\n        // mark that initial load completed to avoid initial empty save overwriting server\r\n        didInitialLoadRef.current = true;\r\n      }\r\n    })();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  // Visa migreringsknappen även om det finns lokala kontroller (completed/draft)\r\n  React.useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const completed = await AsyncStorage.getItem('completed_controls');\r\n        const drafts = await AsyncStorage.getItem('draft_controls');\r\n        if ((completed && completed !== '[]') || (drafts && drafts !== '[]')) {\r\n          setLocalFallbackExists(true);\r\n        }\r\n      } catch(e) {\r\n        // ignore\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  // Spara hierarchy till Firestore varje gång den ändras (och companyId finns)\r\n  React.useEffect(() => {\r\n    if (!companyId) return;\r\n    // don't save before initial load finished (avoid overwriting server with empty on mount)\r\n    if (!didInitialLoadRef.current) return;\r\n    (async () => {\r\n      try {\r\n        const res = await saveHierarchy(companyId, hierarchy);\r\n        const ok = res === true || (res && res.ok === true);\r\n        if (!ok) {\r\n          // Firestore save failed — persist locally as fallback\r\n          try {\r\n            await AsyncStorage.setItem('hierarchy_local', JSON.stringify(hierarchy || []));\r\n            setLocalFallbackExists(true);\r\n          } catch(e) {}\r\n        } else {\r\n          // On successful cloud save, also clear local fallback\r\n            try {\r\n            await AsyncStorage.removeItem('hierarchy_local');\r\n            await refreshLocalFallbackFlag();\r\n          } catch(e) {}\r\n        }\r\n      } catch(e) {\r\n        try {\r\n          await AsyncStorage.setItem('hierarchy_local', JSON.stringify(hierarchy || []));\r\n          setLocalFallbackExists(true);\r\n        } catch(e) {}\r\n      }\r\n    })();\r\n     \r\n  }, [hierarchy, companyId]);\r\n\r\n  // Remove all top-level folders named 'test' after initial load\r\n  React.useEffect(() => {\r\n    setHierarchy(prev => prev.filter(folder => folder.name.trim().toLowerCase() !== 'test'));\r\n  }, []);\r\n  // Search modal state\r\n  const [searchModalVisible, setSearchModalVisible] = useState(false);\r\n  const [searchText, setSearchText] = useState('');\r\n  const [keyboardHeight, setKeyboardHeight] = useState(0);\r\n\r\n  const openSearchModal = React.useCallback(() => {\r\n    // Ensure the popup doesn't start \"lifted\" due to stale keyboard height\r\n    setKeyboardHeight(0);\r\n    setSearchModalVisible(true);\r\n  }, []);\r\n\r\n  const closeSearchModal = React.useCallback(() => {\r\n    setSearchModalVisible(false);\r\n    setSearchText('');\r\n    setKeyboardHeight(0);\r\n  }, []);\r\n\r\n  // Header search dropdown (between logos): search among created projects in hierarchy\r\n  const headerProjectQuery = String(route?.params?.headerProjectSearchText || '').trim();\r\n  const headerSearchOpen = React.useMemo(() => {\r\n    // default: open when there is a query; explicit false closes dropdown\r\n    if (Object.prototype.hasOwnProperty.call(route?.params || {}, 'headerSearchOpen')) {\r\n      return !!route.params.headerSearchOpen;\r\n    }\r\n    return !!headerProjectQuery;\r\n  }, [route?.params?.headerSearchOpen, headerProjectQuery]);\r\n  const headerSearchWidth = React.useMemo(() => {\r\n    const w = Number(route?.params?.headerSearchWidth || 0);\r\n    return Number.isFinite(w) && w > 0 ? w : null;\r\n  }, [route?.params?.headerSearchWidth]);\r\n  const headerSearchBottom = React.useMemo(() => {\r\n    const b = Number(route?.params?.headerSearchBottom || 0);\r\n    return Number.isFinite(b) && b > 0 ? b : 71;\r\n  }, [route?.params?.headerSearchBottom]);\r\n  const headerSearchLeft = React.useMemo(() => {\r\n    const l = Number(route?.params?.headerSearchLeft || 0);\r\n    return Number.isFinite(l) ? l : null;\r\n  }, [route?.params?.headerSearchLeft]);\r\n  const headerProjectMatches = React.useMemo(() => {\r\n    if (!headerProjectQuery) return [];\r\n    const q = headerProjectQuery.toLowerCase();\r\n    const out = [];\r\n\r\n    for (const main of (hierarchy || [])) {\r\n      for (const sub of (main?.children || [])) {\r\n        for (const child of (sub?.children || [])) {\r\n          if (child?.type !== 'project') continue;\r\n          const id = String(child?.id || '');\r\n          const name = String(child?.name || '');\r\n          if (id.toLowerCase().includes(q) || name.toLowerCase().includes(q)) {\r\n            out.push(child);\r\n            if (out.length >= 25) return out;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return out;\r\n  }, [headerProjectQuery, hierarchy]);\r\n\r\n  // Web-only UX: hover highlight + subtle open animation for dropdown\r\n  const [hoveredProjectId, setHoveredProjectId] = useState(null);\r\n  const dropdownAnim = React.useRef(new Animated.Value(0)).current;\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    Animated.timing(dropdownAnim, {\r\n      toValue: headerProjectQuery ? 1 : 0,\r\n      duration: 140,\r\n      easing: Easing.out(Easing.cubic),\r\n      useNativeDriver: true,\r\n    }).start();\r\n  }, [headerProjectQuery, dropdownAnim]);\r\n\r\n  // Native: keep search modal above the keyboard\r\n  React.useEffect(() => {\r\n    if (Platform.OS === 'web') return;\r\n    const subs = [];\r\n    const onShow = (e) => setKeyboardHeight(e?.endCoordinates?.height || 0);\r\n    const onHide = () => setKeyboardHeight(0);\r\n\r\n    // iOS is often more reliable with *Will* events\r\n    subs.push(Keyboard.addListener('keyboardWillShow', onShow));\r\n    subs.push(Keyboard.addListener('keyboardWillHide', onHide));\r\n    subs.push(Keyboard.addListener('keyboardDidShow', onShow));\r\n    subs.push(Keyboard.addListener('keyboardDidHide', onHide));\r\n\r\n    return () => {\r\n      for (const s of subs) {\r\n        try { s.remove(); } catch(e) {}\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // App (native): filter projects by status\r\n  const [projectStatusFilter, setProjectStatusFilter] = useState('all'); // 'all' | 'ongoing' | 'completed'\r\n  const [filterModalVisible, setFilterModalVisible] = useState(false);\r\n\r\n  // Web: right-click context menu for folder tree\r\n  const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, target: null });\r\n  const ensuredDefaultMainRef = useRef(false);\r\n\r\n  // Web: hover highlight for tree rows\r\n  const [hoveredRowKey, setHoveredRowKey] = useState(null);\r\n  const getRowKey = React.useCallback((type, mainId, subId, projectId) => {\r\n    return [type, mainId ?? '', subId ?? '', projectId ?? ''].join(':');\r\n  }, []);\r\n\r\n  const closeContextMenu = React.useCallback(() => {\r\n    setContextMenu(prev => ({ ...prev, visible: false, target: null }));\r\n  }, []);\r\n\r\n  const getContextCoords = React.useCallback((e) => {\r\n    const ne = e?.nativeEvent || e;\r\n    const rawX = ne?.pageX ?? ne?.clientX ?? 0;\r\n    const rawY = ne?.pageY ?? ne?.clientY ?? 0;\r\n    const menuWidth = 220;\r\n    const menuHeight = 220;\r\n    if (typeof window !== 'undefined') {\r\n      const maxX = Math.max(8, (window.innerWidth || rawX) - menuWidth - 8);\r\n      const maxY = Math.max(8, (window.innerHeight || rawY) - menuHeight - 8);\r\n      return { x: Math.min(rawX, maxX), y: Math.min(rawY, maxY) };\r\n    }\r\n    return { x: rawX, y: rawY };\r\n  }, []);\r\n\r\n  const openContextMenu = React.useCallback((e, target) => {\r\n    if (Platform.OS !== 'web') return;\r\n    try { e?.preventDefault?.(); } catch(e) {}\r\n    const { x, y } = getContextCoords(e);\r\n    setContextMenu({ visible: true, x, y, target });\r\n  }, [getContextCoords]);\r\n\r\n  // Web-only: intercept the *real* DOM contextmenu event so the browser menu never opens.\r\n  // RN-web doesn't reliably fire onContextMenu for all components.\r\n  React.useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    if (typeof document === 'undefined') return;\r\n\r\n    const handler = (ev) => {\r\n      const rootEl = document.getElementById('dk-tree-root');\r\n      if (!rootEl) return;\r\n      if (!rootEl.contains(ev.target)) return;\r\n\r\n      // Always block the browser menu within the tree area\r\n      ev.preventDefault();\r\n      ev.stopPropagation();\r\n\r\n      const rowEl = ev.target?.closest?.('[data-dk-type]');\r\n      if (!rowEl) return;\r\n\r\n      const dkType = rowEl.getAttribute('data-dk-type');\r\n      const mainId = rowEl.getAttribute('data-dk-mainid');\r\n      const subId = rowEl.getAttribute('data-dk-subid');\r\n      const projectId = rowEl.getAttribute('data-dk-projectid');\r\n\r\n      let target = null;\r\n      if (dkType === 'main') {\r\n        target = { type: 'main', mainId };\r\n      } else if (dkType === 'sub') {\r\n        target = { type: 'sub', mainId, subId };\r\n      } else if (dkType === 'project') {\r\n        // Lookup project object from current hierarchy\r\n        let project = null;\r\n        for (const m of hierarchy || []) {\r\n          if (String(m.id) !== String(mainId)) continue;\r\n          for (const s of m.children || []) {\r\n            if (String(s.id) !== String(subId)) continue;\r\n            project = (s.children || []).find(ch => ch?.type === 'project' && String(ch.id) === String(projectId)) || null;\r\n          }\r\n        }\r\n        target = { type: 'project', mainId, subId, project };\r\n      }\r\n\r\n      if (!target) return;\r\n      openContextMenu(ev, target);\r\n    };\r\n\r\n    document.addEventListener('contextmenu', handler, { capture: true });\r\n    return () => document.removeEventListener('contextmenu', handler, { capture: true });\r\n  }, [hierarchy, openContextMenu]);\r\n\r\n  // Ensure at least one main folder exists (important since we remove the + button)\r\n  React.useEffect(() => {\r\n    if (!companyId) return;\r\n    if (!didInitialLoadRef.current) return;\r\n    if (ensuredDefaultMainRef.current) return;\r\n    if (Array.isArray(hierarchy) && hierarchy.length === 0) {\r\n      ensuredDefaultMainRef.current = true;\r\n        setHierarchy([\r\n        {\r\n          id: (Math.random() * 100000).toFixed(0),\r\n          name: 'Huvudmapp',\r\n          expanded: false,\r\n          children: [],\r\n        },\r\n      ]);\r\n    }\r\n  }, [hierarchy, companyId]);\r\n\r\n  const renameMainFolderWeb = React.useCallback((mainId) => {\r\n    const current = hierarchy.find(m => m.id === mainId);\r\n    const currentName = current?.name || '';\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const nextName = (window.prompt('Byt namn på huvudmapp', currentName) || '').trim();\r\n      if (!nextName) return;\r\n      setHierarchy(prev => prev.map(m => (m.id === mainId ? { ...m, name: nextName } : m)));\r\n      return;\r\n    }\r\n    setEditModal({ visible: true, type: 'main', id: mainId, name: currentName });\r\n  }, [hierarchy]);\r\n\r\n  const renameSubFolderWeb = React.useCallback((subId) => {\r\n    let currentName = '';\r\n    hierarchy.forEach(m => {\r\n      (m.children || []).forEach(s => {\r\n        if (s.id === subId) currentName = s.name || '';\r\n      });\r\n    });\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const nextName = (window.prompt('Byt namn på undermapp', currentName) || '').trim();\r\n      if (!nextName) return;\r\n      setHierarchy(prev => prev.map(m => ({\r\n        ...m,\r\n        children: (m.children || []).map(s => (s.id === subId ? { ...s, name: nextName } : s)),\r\n      })));\r\n      return;\r\n    }\r\n    setEditModal({ visible: true, type: 'sub', id: subId, name: currentName });\r\n  }, [hierarchy]);\r\n\r\n  const deleteMainFolderGuarded = React.useCallback((mainId) => {\r\n    const mainName = (hierarchy || []).find(m => m.id === mainId)?.name || '';\r\n    if ((hierarchy || []).length <= 1) {\r\n      if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n        window.alert('Kan inte radera.\\n\\nDet måste finnas minst en huvudmapp.');\r\n      } else {\r\n        Alert.alert('Kan inte radera', 'Det måste finnas minst en huvudmapp.');\r\n      }\r\n      return;\r\n    }\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const ok = window.confirm(`Vill du verkligen radera huvudmappen${mainName ? ` \"${mainName}\"` : ''}?`);\r\n      if (!ok) return;\r\n      setHierarchy(prev => prev.filter(m => m.id !== mainId));\r\n      return;\r\n    }\r\n\r\n    Alert.alert('Radera huvudmapp', `Vill du verkligen radera huvudmappen${mainName ? ` \"${mainName}\"` : ''}?`, [\r\n      { text: 'Avbryt', style: 'cancel' },\r\n      {\r\n        text: 'Radera',\r\n        style: 'destructive',\r\n        onPress: () => setHierarchy(prev => prev.filter(m => m.id !== mainId)),\r\n      },\r\n    ]);\r\n  }, [hierarchy]);\r\n\r\n  const deleteSubFolder = React.useCallback((mainId, subId) => {\r\n    const main = (hierarchy || []).find(m => m.id === mainId);\r\n    const subName = (main?.children || []).find(s => s.id === subId)?.name || '';\r\n\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const ok = window.confirm(`Vill du verkligen radera undermappen${subName ? ` \"${subName}\"` : ''}?`);\r\n      if (!ok) return;\r\n      setHierarchy(prev => prev.map(m => (\r\n        m.id === mainId\r\n          ? { ...m, children: (m.children || []).filter(s => s.id !== subId) }\r\n          : m\r\n      )));\r\n      return;\r\n    }\r\n\r\n    Alert.alert('Radera undermapp', `Vill du verkligen radera undermappen${subName ? ` \"${subName}\"` : ''}?`, [\r\n      { text: 'Avbryt', style: 'cancel' },\r\n      {\r\n        text: 'Radera',\r\n        style: 'destructive',\r\n        onPress: () => setHierarchy(prev => prev.map(m => (\r\n          m.id === mainId\r\n            ? { ...m, children: (m.children || []).filter(s => s.id !== subId) }\r\n            : m\r\n        ))),\r\n      },\r\n    ]);\r\n  }, [hierarchy]);\r\n\r\n  const renameProjectWeb = React.useCallback((projectId) => {\r\n    let currentName = '';\r\n    hierarchy.forEach(m => {\r\n      (m.children || []).forEach(s => {\r\n        (s.children || []).forEach(ch => {\r\n          if (ch?.type === 'project' && ch.id === projectId) currentName = ch.name || '';\r\n        });\r\n      });\r\n    });\r\n\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const nextName = (window.prompt('Byt namn på projekt', currentName) || '').trim();\r\n      if (!nextName) return;\r\n      setHierarchy(prev => prev.map(m => ({\r\n        ...m,\r\n        children: (m.children || []).map(s => ({\r\n          ...s,\r\n          children: (s.children || []).map(ch => (\r\n            ch?.type === 'project' && ch.id === projectId ? { ...ch, name: nextName } : ch\r\n          )),\r\n        })),\r\n      })));\r\n      return;\r\n    }\r\n  }, [hierarchy]);\r\n\r\n  const deleteProject = React.useCallback((mainId, subId, projectId) => {\r\n    const main = (hierarchy || []).find(m => m.id === mainId);\r\n    const sub = (main?.children || []).find(s => s.id === subId);\r\n    const projName = (sub?.children || []).find(ch => ch?.type === 'project' && ch.id === projectId)?.name || '';\r\n\r\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\r\n      const ok = window.confirm(`Vill du verkligen radera projektet ${projectId}${projName ? ` — ${projName}` : ''}?`);\r\n      if (!ok) return;\r\n      setHierarchy(prev => prev.map(m => (\r\n        m.id !== mainId\r\n          ? m\r\n          : {\r\n            ...m,\r\n            children: (m.children || []).map(s => (\r\n              s.id !== subId\r\n                ? s\r\n                : { ...s, children: (s.children || []).filter(ch => !(ch?.type === 'project' && ch.id === projectId)) }\r\n            )),\r\n          }\r\n      )));\r\n      return;\r\n    }\r\n\r\n    Alert.alert('Radera projekt', `Vill du verkligen radera projektet ${projectId}${projName ? ` — ${projName}` : ''}?`, [\r\n      { text: 'Avbryt', style: 'cancel' },\r\n      {\r\n        text: 'Radera',\r\n        style: 'destructive',\r\n        onPress: () => setHierarchy(prev => prev.map(m => (\r\n          m.id !== mainId\r\n            ? m\r\n            : {\r\n              ...m,\r\n              children: (m.children || []).map(s => (\r\n                s.id !== subId\r\n                  ? s\r\n                  : { ...s, children: (s.children || []).filter(ch => !(ch?.type === 'project' && ch.id === projectId)) }\r\n              )),\r\n            }\r\n        ))),\r\n      },\r\n    ]);\r\n  }, [hierarchy]);\r\n\r\n  const copyProjectWeb = React.useCallback((mainId, subId, project) => {\r\n    if (Platform.OS !== 'web' || typeof window === 'undefined') return;\r\n    if (!project || project.type !== 'project') return;\r\n\r\n    const suggestedId = String(project.id || '').trim();\r\n    const suggestedName = String(project.name || '').trim();\r\n    const newId = (window.prompt('Nytt projektnummer', suggestedId) || '').trim();\r\n    if (!newId) return;\r\n    if (!isProjectNumberUnique(newId)) {\r\n      Alert.alert('Fel', 'Projektnummer används redan.');\r\n      return;\r\n    }\r\n    const newName = (window.prompt('Nytt projektnamn', suggestedName) || '').trim();\r\n    if (!newName) return;\r\n\r\n    const copy = {\r\n      ...project,\r\n      id: newId,\r\n      name: newName,\r\n      createdAt: new Date().toISOString(),\r\n      status: project.status || 'ongoing',\r\n    };\r\n\r\n    setHierarchy(prev => prev.map(m => (\r\n      m.id !== mainId\r\n        ? m\r\n        : {\r\n          ...m,\r\n          children: (m.children || []).map(s => (\r\n            s.id !== subId\r\n              ? s\r\n              : { ...s, children: [...(s.children || []), copy] }\r\n          )),\r\n        }\r\n    )));\r\n  }, [isProjectNumberUnique]);\r\n\r\n  const contextMenuItems = React.useMemo(() => {\r\n    const t = contextMenu.target;\r\n    if (!t) return [];\r\n    if (t.type === 'main') {\r\n      return [\r\n        { key: 'addMain', label: 'Lägg till huvudmapp', icon: '📁' },\r\n        { key: 'addSub', label: 'Lägg till undermapp', icon: '📂' },\r\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\r\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true, disabled: (hierarchy || []).length <= 1 },\r\n      ];\r\n    }\r\n    if (t.type === 'sub') {\r\n      return [\r\n        { key: 'addProject', label: 'Lägg till projekt', icon: '➕' },\r\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\r\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true },\r\n      ];\r\n    }\r\n    if (t.type === 'project') {\r\n      return [\r\n        { key: 'open', label: 'Öppna projekt', icon: '📄' },\r\n        { key: 'addProject', label: 'Lägg till projekt', icon: '➕' },\r\n        { key: 'copy', label: 'Kopiera projekt', icon: '📋' },\r\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\r\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true },\r\n      ];\r\n    }\r\n    return [];\r\n  }, [contextMenu.target, hierarchy]);\r\n\r\n  const handleContextMenuSelect = React.useCallback((item) => {\r\n    const t = contextMenu.target;\r\n    if (!t) return;\r\n\r\n    if (t.type === 'main') {\r\n      const mainId = t.mainId;\r\n      switch (item.key) {\r\n        case 'addMain':\r\n          setNewFolderModalVisible(true);\r\n          setNewSubName('');\r\n          break;\r\n        case 'addSub':\r\n          setNewSubModal({ visible: true, parentId: mainId });\r\n          setNewSubName('');\r\n          break;\r\n        case 'rename':\r\n          renameMainFolderWeb(mainId);\r\n          break;\r\n        case 'delete':\r\n          deleteMainFolderGuarded(mainId);\r\n          break;\r\n      }\r\n    }\r\n\r\n    if (t.type === 'sub') {\r\n      const mainId = t.mainId;\r\n      const subId = t.subId;\r\n      switch (item.key) {\r\n        case 'addProject':\r\n          setNewProjectModal({ visible: true, parentSubId: subId });\r\n          setNewProjectName('');\r\n          setNewProjectNumber('');\r\n          break;\r\n        case 'rename':\r\n          renameSubFolderWeb(subId);\r\n          break;\r\n        case 'delete':\r\n          deleteSubFolder(mainId, subId);\r\n          break;\r\n      }\r\n    }\r\n\r\n    if (t.type === 'project') {\r\n      const mainId = t.mainId;\r\n      const subId = t.subId;\r\n      const project = t.project;\r\n      switch (item.key) {\r\n        case 'open':\r\n          if (project && Platform.OS === 'web') requestProjectSwitch(project, { selectedAction: null });\r\n          break;\r\n        case 'addProject':\r\n          setNewProjectModal({ visible: true, parentSubId: subId });\r\n          setNewProjectName('');\r\n          setNewProjectNumber('');\r\n          break;\r\n        case 'copy':\r\n          copyProjectWeb(mainId, subId, project);\r\n          break;\r\n        case 'rename':\r\n          if (project?.id) renameProjectWeb(project.id);\r\n          break;\r\n        case 'delete':\r\n          if (project?.id) deleteProject(mainId, subId, project.id);\r\n          break;\r\n      }\r\n    }\r\n  }, [contextMenu.target, deleteMainFolderGuarded, deleteSubFolder, renameMainFolderWeb, renameSubFolderWeb, requestProjectSwitch]);\r\n\r\n  function toggleExpand(level, id, parentArr = hierarchy) {\r\n    return parentArr.map(item => {\r\n      if (item.id === id) {\r\n        return { ...item, expanded: !item.expanded };\r\n      } else if (item.children) {\r\n        return { ...item, children: toggleExpand(level + 1, id, item.children) };\r\n      }\r\n      return item;\r\n    });\r\n  }\r\n\r\n  // Stil för återanvändning\r\nconst kontrollKnappStil = { backgroundColor: '#fff', borderRadius: 16, marginBottom: 16, alignItems: 'center', flexDirection: 'row', justifyContent: 'center', shadowColor: '#1976D2', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2, minHeight: 56, maxWidth: 240, width: '90%', paddingLeft: 14, paddingRight: 10, overflow: 'hidden', borderWidth: 2, borderColor: '#222' };\r\nconst kontrollTextStil = { color: '#222', fontWeight: '600', fontSize: 17, letterSpacing: 0.5, zIndex: 1 };\r\n\r\n    // Dashboard: gemensamma stilar (återanvänd befintliga färger)\r\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\r\n    const dashboardColumnsStyle = { flexDirection: 'row', alignItems: 'flex-start', flexWrap: 'wrap' };\r\n    const dashboardSectionTitleStyle = { fontSize: 20, fontWeight: '700', color: '#222', marginBottom: 10 };\r\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\r\n    const dashboardCardDenseStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 10, backgroundColor: '#fff' };\r\n    const dashboardEmptyTextStyle = { color: '#777', padding: 12 };\r\n    const dashboardMetaTextStyle = { fontSize: 12, color: '#888', marginTop: 4 };\r\n    const dashboardLinkTitleStyle = { fontSize: 15, color: '#1976D2', fontWeight: '400' };\r\n    const dashboardListItemStyle = (idx) => ({\r\n      paddingVertical: 12,\r\n      paddingHorizontal: 6,\r\n      borderTopWidth: idx === 0 ? 0 : 1,\r\n      borderTopColor: '#eee',\r\n    });\r\n    const dashboardStatRowStyle = (idx) => ({\r\n      flexDirection: 'row',\r\n      alignItems: 'center',\r\n      paddingVertical: 10,\r\n      borderTopWidth: idx === 0 ? 0 : 1,\r\n      borderTopColor: '#eee',\r\n    });\r\n    const dashboardStatDotStyle = (color) => ({ width: 10, height: 10, borderRadius: 5, backgroundColor: color, marginRight: 12 });\r\n    const dashboardStatLabelStyle = { flex: 1, fontSize: 15, color: '#222' };\r\n    const dashboardStatValueStyle = { fontSize: 16, fontWeight: '700', color: '#222' };\r\n    const dashboardActivityTitleStyle = { fontSize: 15, color: '#222', fontWeight: '600' };\r\n\r\n    const ActivityPanel = React.useCallback(() => {\r\n      return (\r\n        <View style={{ flex: 1, minWidth: 0 }}>\r\n          <Text style={dashboardSectionTitleStyle}>Senaste aktivitet</Text>\r\n          <View style={dashboardCardDenseStyle}>\r\n            {dashboardLoading ? (\r\n              <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\r\n            ) : (dashboardRecent || []).length === 0 ? (\r\n              <Text style={dashboardEmptyTextStyle}>Ingen aktivitet ännu.</Text>\r\n            ) : (\r\n              (dashboardRecent || []).map((a, idx) => {\r\n                const isLogin = String(a.type || '').toLowerCase() === 'login';\r\n                const hasOpenDeviations = !isLogin && a.kind !== 'draft' && a.type === 'Skyddsrond' && (a.openDeviationsCount || 0) > 0;\r\n                const iconName = isLogin ? 'log-in-outline' : (a.kind === 'draft' ? 'document-text-outline' : (hasOpenDeviations ? 'alert-circle' : 'checkmark-circle'));\r\n                const iconColor = isLogin ? '#1976D2' : (a.kind === 'draft' ? '#FFD600' : (hasOpenDeviations ? '#D32F2F' : '#43A047'));\r\n                const subtitle = !isLogin ? (a.projectName ? `i ${a.projectName}` : (a.projectId ? `i ${a.projectId}` : '')) : '';\r\n                const who = String(a.actorName || a.actorEmail || '').trim();\r\n                const title = isLogin\r\n                  ? (who ? `Loggade in: ${who}` : 'Loggade in')\r\n                  : (a.kind === 'draft' ? `Utkast sparat: ${a.type}` : `Slutförd: ${a.type}`);\r\n\r\n                return (\r\n                  <TouchableOpacity\r\n                    key={`${a.kind}-${a.ts || 'no-ts'}-${idx}`}\r\n                    activeOpacity={0.85}\r\n                    onPress={() => {\r\n                      if (isLogin) return;\r\n                      if (a.projectId) {\r\n                        const p = findProjectById(a.projectId);\r\n                        if (p) {\r\n                          if (a.kind === 'draft') {\r\n                            const raw = a.raw || null;\r\n                            const stableId = raw?.id || raw?.draftId || raw?.controlId || raw?.localId || raw?.savedAt || a.ts || Date.now();\r\n                            const selectedAction = {\r\n                              id: `openDraft:${String(a.projectId)}:${String(stableId)}`,\r\n                              kind: 'openDraft',\r\n                              type: a.type,\r\n                              initialValues: raw || undefined,\r\n                            };\r\n                            requestProjectSwitch(p, { selectedAction, clearActionAfter: true });\r\n                          } else {\r\n                            requestProjectSwitch(p, { selectedAction: null });\r\n                          }\r\n                        }\r\n                      }\r\n                    }}\r\n                    style={[{ flexDirection: 'row', alignItems: 'flex-start' }, dashboardListItemStyle(idx)]}\r\n                  >\r\n                    <Ionicons name={iconName} size={20} color={iconColor} style={{ marginTop: 2, marginRight: 12 }} />\r\n                    <View style={{ flex: 1, minWidth: 0 }}>\r\n                      <Text style={dashboardActivityTitleStyle} numberOfLines={2}>\r\n                        {title}\r\n                      </Text>\r\n                      {subtitle ? (\r\n                        <Text style={{ fontSize: 14, color: '#1976D2', marginTop: 2 }} numberOfLines={1}>\r\n                          {subtitle}\r\n                        </Text>\r\n                      ) : null}\r\n                      {a.desc ? (\r\n                        <Text style={{ fontSize: 13, color: '#666', marginTop: 2 }} numberOfLines={1}>\r\n                          {a.desc}\r\n                        </Text>\r\n                      ) : null}\r\n                      <Text style={dashboardMetaTextStyle}>\r\n                        {formatRelativeTime(a.ts)}\r\n                      </Text>\r\n                    </View>\r\n\r\n                    {Platform.OS === 'web' && hasOpenDeviations && (\r\n                      <TouchableOpacity\r\n                        onPress={(e) => {\r\n                          try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\r\n                          if (!a.projectId) return;\r\n                          const p = findProjectById(a.projectId);\r\n                          if (!p) return;\r\n                          const raw = a.raw || null;\r\n                          const stableId = raw?.id || raw?.controlId || raw?.localId || raw?.savedAt || a.ts || Date.now();\r\n                          const selectedAction = {\r\n                            id: `openControlDetails:${String(a.projectId)}:${String(stableId)}`,\r\n                            kind: 'openControlDetails',\r\n                            control: raw || undefined,\r\n                          };\r\n                          requestProjectSwitch(p, { selectedAction, clearActionAfter: true });\r\n                        }}\r\n                        style={{ marginLeft: 12, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600', alignSelf: 'center' }}\r\n                        activeOpacity={0.85}\r\n                        accessibilityLabel=\"Åtgärda avvikelse\"\r\n                      >\r\n                        <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\r\n                      </TouchableOpacity>\r\n                    )}\r\n                  </TouchableOpacity>\r\n                );\r\n              })\r\n            )}\r\n          </View>\r\n        </View>\r\n      );\r\n    }, [\r\n      dashboardRecent,\r\n      dashboardLoading,\r\n      dashboardSectionTitleStyle,\r\n      dashboardCardDenseStyle,\r\n      dashboardEmptyTextStyle,\r\n      dashboardListItemStyle,\r\n      dashboardActivityTitleStyle,\r\n      dashboardMetaTextStyle,\r\n      findProjectById,\r\n      formatRelativeTime,\r\n      requestProjectSwitch,\r\n    ]);\r\n\r\n    function SelectProjectModal() {\r\n      const [expandedMain, setExpandedMain] = useState([]);\r\n      const [expandedSub, setExpandedSub] = useState([]);\r\n      const [quickAddModal, setQuickAddModal] = useState({ visible: false, parentSubId: null });\r\n      const [quickAddName, setQuickAddName] = useState(\"\");\r\n      const [quickAddNumber, setQuickAddNumber] = useState(\"\");\r\n      const [showProjectCreated, setShowProjectCreated] = useState(false);\r\n      const isMainExpanded = id => expandedMain[0] === id;\r\n      const isSubExpanded = id => expandedSub.includes(id);\r\n      const toggleMain = id => setExpandedMain(exp => exp[0] === id ? [] : [id]);\r\n      const toggleSub = id => setExpandedSub(exp => exp.includes(id) ? exp.filter(e => e !== id) : [...exp, id]);\r\n\r\n      React.useEffect(() => {\r\n        if (selectProjectModal.visible) setExpandedMain([]);\r\n      }, [selectProjectModal.visible]);\r\n\r\n      return (\r\n        <Modal\r\n          visible={selectProjectModal.visible}\r\n          transparent\r\n          animationType=\"fade\"\r\n          onRequestClose={() => setSelectProjectModal({ visible: false, type: null })}\r\n        >\r\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n            <Pressable\r\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n              onPress={() => setSelectProjectModal({ visible: false, type: null })}\r\n            />\r\n            <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 360, maxHeight: 540 }}>\r\n              {selectProjectModal.type && (\r\n                <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 6, color: '#222', textAlign: 'center' }}>\r\n                  {selectProjectModal.type}\r\n                </Text>\r\n              )}\r\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222', textAlign: 'center' }}>Välj projekt</Text>\r\n              <View style={{ position: 'relative', marginBottom: 14 }}>\r\n                <TextInput\r\n                  value={searchText}\r\n                  onChangeText={setSearchText}\r\n                  placeholder=\"Sök projektnamn eller nummer...\"\r\n                  style={{\r\n                    borderWidth: 1,\r\n                    borderColor: '#222',\r\n                    borderRadius: 16,\r\n                    padding: 10,\r\n                    fontSize: 16,\r\n                    backgroundColor: '#fff',\r\n                    color: '#222',\r\n                    paddingRight: 38\r\n                  }}\r\n                  autoCorrect={false}\r\n                  autoCapitalize=\"none\"\r\n                />\r\n                {searchText.trim().length > 0 && (\r\n                  <View style={{ position: 'absolute', top: 44, left: 0, right: 0, backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#e0e0e0', zIndex: 10, maxHeight: 180 }}>\r\n                    <ScrollView keyboardShouldPersistTaps=\"handled\">\r\n                      {hierarchy.flatMap(main =>\r\n                        main.children.flatMap(sub =>\r\n                          (sub.children || [])\r\n                            .filter(child => child.type === 'project' && (\r\n                              child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                              child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                            ))\r\n                            .map(proj => (\r\n                              <TouchableOpacity\r\n                                key={proj.id}\r\n                                style={{ padding: 10, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\r\n                                onPress={() => {\r\n                                  setSelectProjectModal({ visible: false, type: null });\r\n                                  switch (selectProjectModal.type) {\r\n                                    case 'Arbetsberedning': navigation.navigate('ArbetsberedningScreen', { project: proj }); break;\r\n                                    case 'Riskbedömning': navigation.navigate('RiskbedömningScreen', { project: proj }); break;\r\n                                    case 'Fuktmätning': navigation.navigate('FuktmätningScreen', { project: proj }); break;\r\n                                    case 'Egenkontroll': navigation.navigate('EgenkontrollScreen', { project: proj }); break;\r\n                                    case 'Mottagningskontroll': navigation.navigate('MottagningskontrollScreen', { project: proj }); break;\r\n                                    case 'Skyddsrond': navigation.navigate('SkyddsrondScreen', { project: proj }); break;\r\n                                    default:\r\n                                      navigation.navigate('ControlForm', { project: proj, controlType: selectProjectModal.type });\r\n                                  }\r\n                                }}\r\n                              >\r\n                                <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                <Text style={{ fontSize: 14, color: '#1976D2', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\r\n                              </TouchableOpacity>\r\n                            ))\r\n                        )\r\n                      )}\r\n                    </ScrollView>\r\n                  </View>\r\n                )}\r\n              </View>\r\n              <ScrollView style={{ maxHeight: 370 }}>\r\n                {[...hierarchy]\r\n                  .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                  .filter(main =>\r\n                    main.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                    main.children.some(sub =>\r\n                      sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                      (sub.children || []).some(child =>\r\n                        child.type === 'project' && (\r\n                          child.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                          child.id.toLowerCase().includes(searchText.toLowerCase())\r\n                        )\r\n                      )\r\n                    )\r\n                  )\r\n                  .map(main => (\r\n                    <View key={main.id} style={{ backgroundColor: '#fff', borderRadius: 16, marginBottom: 3, padding: 6, shadowColor: '#1976D2', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2 }}>\r\n                      <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }} onPress={() => toggleMain(main.id)} activeOpacity={0.7}>\r\n                        <Ionicons name={isMainExpanded(main.id) ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\r\n                        <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginLeft: 8 }}>{main.name}</Text>\r\n                      </TouchableOpacity>\r\n                      {isMainExpanded(main.id) && (\r\n                        !main.children || main.children.length === 0 ? (\r\n                          <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>Inga undermappar skapade</Text>\r\n                        ) : (\r\n                          [...main.children]\r\n                            .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                            .filter(sub =>\r\n                              sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                              (sub.children || []).some(child =>\r\n                                child.type === 'project' && (\r\n                                  child.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                                  child.id.toLowerCase().includes(searchText.toLowerCase())\r\n                                )\r\n                              )\r\n                            )\r\n                            .map(sub => (\r\n                              <View key={sub.id} style={{ marginLeft: 20, marginBottom: 0, padding: 0 }}>\r\n                                <View style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 0', userSelect: 'none' }}>\r\n                                  <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }} onPress={() => toggleSub(sub.id)} activeOpacity={0.7}>\r\n                                    <Ionicons name={isSubExpanded(sub.id) ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 4 }} />\r\n                                    <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginLeft: 2 }}>{sub.name}</Text>\r\n                                  </TouchableOpacity>\r\n                                </View>\r\n                                {isSubExpanded(sub.id) && (\r\n                                  (sub.children || []).filter(child => child.type === 'project').map(proj => (\r\n                                    <View key={proj.id} style={{ marginLeft: 32 }}>\r\n                                      <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: 'transparent', borderRadius: 4, padding: '2px 4px', marginBottom: 0 }}\r\n                                        onPress={() => {\r\n                                          setSelectProjectModal({ visible: false, type: null });\r\n                                          switch (selectProjectModal.type) {\r\n                                            case 'Arbetsberedning': navigation.navigate('ArbetsberedningScreen', { project: proj }); break;\r\n                                            case 'Riskbedömning': navigation.navigate('RiskbedömningScreen', { project: proj }); break;\r\n                                            case 'Fuktmätning': navigation.navigate('FuktmätningScreen', { project: proj }); break;\r\n                                            case 'Egenkontroll': navigation.navigate('EgenkontrollScreen', { project: proj }); break;\r\n                                            case 'Mottagningskontroll': navigation.navigate('MottagningskontrollScreen', { project: proj }); break;\r\n                                            case 'Skyddsrond': navigation.navigate('SkyddsrondScreen', { project: proj }); break;\r\n                                            default:\r\n                                              navigation.navigate('ControlForm', { project: proj, controlType: selectProjectModal.type });\r\n                                          }\r\n                                        }}\r\n                                      >\r\n                                        <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 6, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                        <Text style={{ fontSize: 13, color: '#1976D2', fontWeight: '400', marginLeft: 2, marginRight: 6, flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} — {proj.name}</Text>\r\n                                      </TouchableOpacity>\r\n                                    </View>\r\n                                  ))\r\n                                )}\r\n                              </View>\r\n                            ))\r\n                        )\r\n                      )}\r\n                    </View>\r\n                  ))}\r\n              </ScrollView>\r\n            </View>\r\n          </View>\r\n        </Modal>\r\n      );\r\n    }\r\n\r\n  return (\r\n    <View style={{ flex: 1 }}>\r\n      {/* App-only: filter modal */}\r\n      <Modal\r\n        visible={filterModalVisible}\r\n        transparent\r\n        animationType=\"fade\"\r\n        onRequestClose={() => setFilterModalVisible(false)}\r\n      >\r\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n          <Pressable\r\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n            onPress={() => setFilterModalVisible(false)}\r\n          />\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6, position: 'relative' }}>\r\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center' }}>\r\n              Filtrera projekt\r\n            </Text>\r\n\r\n            {[{ key: 'all', label: 'Alla' }, { key: 'ongoing', label: 'Pågående' }, { key: 'completed', label: 'Avslutade' }].map(opt => {\r\n              const selected = projectStatusFilter === opt.key;\r\n              return (\r\n                <TouchableOpacity\r\n                  key={opt.key}\r\n                  style={{\r\n                    flexDirection: 'row',\r\n                    alignItems: 'center',\r\n                    paddingVertical: 10,\r\n                    paddingHorizontal: 12,\r\n                    borderRadius: 12,\r\n                    borderWidth: 1,\r\n                    borderColor: selected ? '#1976D2' : '#e0e0e0',\r\n                    backgroundColor: selected ? '#e3f2fd' : '#fff',\r\n                    marginBottom: 10,\r\n                  }}\r\n                  onPress={() => {\r\n                    setProjectStatusFilter(opt.key);\r\n                    setFilterModalVisible(false);\r\n                  }}\r\n                  activeOpacity={0.8}\r\n                >\r\n                  {opt.key === 'ongoing' && (\r\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#43A047', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\r\n                  )}\r\n                  {opt.key === 'completed' && (\r\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#222', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\r\n                  )}\r\n                  {opt.key === 'all' && (\r\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#fff', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\r\n                  )}\r\n                  <Text style={{ fontSize: 16, fontWeight: selected ? '700' : '600', color: '#222' }}>{opt.label}</Text>\r\n                </TouchableOpacity>\r\n              );\r\n            })}\r\n\r\n            <TouchableOpacity\r\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 12, paddingVertical: 10, alignItems: 'center' }}\r\n              onPress={() => setFilterModalVisible(false)}\r\n            >\r\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n\r\n      {/* Sök-popup/modal */}\r\n      <Modal\r\n        visible={searchModalVisible}\r\n        transparent\r\n        animationType=\"fade\"\r\n        onRequestClose={closeSearchModal}\r\n      >\r\n        {Platform.OS === 'web' ? (\r\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>\r\n            <Pressable\r\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n              onPress={closeSearchModal}\r\n            />\r\n            <View\r\n              style={{\r\n                backgroundColor: '#fff',\r\n                borderRadius: 18,\r\n                padding: 24,\r\n                width: 340,\r\n                maxHeight: 700,\r\n                shadowColor: '#000',\r\n                shadowOffset: { width: 0, height: 4 },\r\n                shadowOpacity: 0.18,\r\n                shadowRadius: 8,\r\n                elevation: 6,\r\n                position: 'relative',\r\n              }}\r\n            >\r\n              <TouchableOpacity\r\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n                onPress={closeSearchModal}\r\n                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n              >\r\n                <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n              </TouchableOpacity>\r\n              <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center', marginTop: 6 }}>\r\n                Sök projekt\r\n              </Text>\r\n              <TextInput\r\n                value={searchText}\r\n                onChangeText={setSearchText}\r\n                placeholder=\"Skriv projektnummer...\"\r\n                style={{\r\n                  borderWidth: 1,\r\n                  borderColor: '#222',\r\n                  borderRadius: 16,\r\n                  padding: 10,\r\n                  fontSize: 16,\r\n                  backgroundColor: '#fff',\r\n                  color: '#222',\r\n                  marginBottom: 12\r\n                }}\r\n                autoFocus\r\n                keyboardType=\"default\"\r\n                autoCorrect={false}\r\n                autoCapitalize=\"none\"\r\n              />\r\n              <ScrollView style={{ maxHeight: 520 }} keyboardShouldPersistTaps=\"handled\">\r\n                {hierarchy.flatMap(main =>\r\n                  main.children.flatMap(sub =>\r\n                    (sub.children || [])\r\n                      .filter(child => child.type === 'project' &&\r\n                        searchText.trim() !== '' &&\r\n                        (\r\n                          child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                          child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                        )\r\n                      )\r\n                      .map(proj => (\r\n                        <TouchableOpacity\r\n                          key={proj.id}\r\n                          style={{ paddingVertical: 8, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\r\n                          onPress={() => {\r\n                            closeSearchModal();\r\n                            requestProjectSwitch(proj, { selectedAction: null });\r\n                          }}\r\n                        >\r\n                          <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\r\n                        </TouchableOpacity>\r\n                      ))\r\n                  )\r\n                )}\r\n                {searchText.trim() !== '' && hierarchy.flatMap(main => main.children.flatMap(sub => (sub.children || []).filter(child => child.type === 'project' && (\r\n                  child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                  child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                )))).length === 0 && (\r\n                  <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 12 }}>Inga projekt hittades.</Text>\r\n                )}\r\n              </ScrollView>\r\n            </View>\r\n          </View>\r\n        ) : (\r\n          <KeyboardAvoidingView\r\n            style={{ flex: 1 }}\r\n            behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\r\n            keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 0}\r\n          >\r\n            <View\r\n              style={{\r\n                flex: 1,\r\n                justifyContent: 'flex-end',\r\n                alignItems: 'center',\r\n                paddingTop: 20,\r\n                paddingBottom: 8,\r\n              }}\r\n            >\r\n              <Pressable\r\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                onPress={closeSearchModal}\r\n              />\r\n              <View\r\n                style={{\r\n                  backgroundColor: '#fff',\r\n                  borderRadius: 18,\r\n                  padding: 24,\r\n                  width: 340,\r\n                  maxHeight: Math.max(320, Math.min(600, (windowHeight || 700) - (keyboardHeight || 0) - 80)),\r\n                  shadowColor: '#000',\r\n                  shadowOffset: { width: 0, height: 4 },\r\n                  shadowOpacity: 0.18,\r\n                  shadowRadius: 8,\r\n                  elevation: 6,\r\n                  position: 'relative',\r\n                }}\r\n              >\r\n                <TouchableOpacity\r\n                  style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n                  onPress={closeSearchModal}\r\n                  hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n                >\r\n                  <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n                </TouchableOpacity>\r\n                <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center', marginTop: 6 }}>\r\n                  Sök projekt\r\n                </Text>\r\n                <TextInput\r\n                  value={searchText}\r\n                  onChangeText={setSearchText}\r\n                  placeholder=\"Skriv projektnummer...\"\r\n                  style={{\r\n                    borderWidth: 1,\r\n                    borderColor: '#222',\r\n                    borderRadius: 16,\r\n                    padding: 10,\r\n                    fontSize: 16,\r\n                    backgroundColor: '#fff',\r\n                    color: '#222',\r\n                    marginBottom: 12\r\n                  }}\r\n                  autoFocus\r\n                  keyboardType=\"default\"\r\n                  autoCorrect={false}\r\n                  autoCapitalize=\"none\"\r\n                />\r\n                <ScrollView\r\n                  style={{\r\n                    maxHeight: Math.max(180, (windowHeight || 700) - (keyboardHeight || 0) - 260),\r\n                  }}\r\n                  keyboardShouldPersistTaps=\"handled\"\r\n                >\r\n                  {hierarchy.flatMap(main =>\r\n                    main.children.flatMap(sub =>\r\n                      (sub.children || [])\r\n                        .filter(child => child.type === 'project' &&\r\n                          searchText.trim() !== '' &&\r\n                          (\r\n                            child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                            child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                          )\r\n                        )\r\n                        .map(proj => (\r\n                          <TouchableOpacity\r\n                            key={proj.id}\r\n                            style={{ paddingVertical: 8, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\r\n                            onPress={() => {\r\n                              closeSearchModal();\r\n                              navigation.navigate('ProjectDetails', {\r\n                                project: {\r\n                                  id: proj.id,\r\n                                  name: proj.name,\r\n                                  ansvarig: proj.ansvarig || '',\r\n                                  adress: proj.adress || '',\r\n                                  fastighetsbeteckning: proj.fastighetsbeteckning || '',\r\n                                  client: proj.client || '',\r\n                                  status: proj.status || 'ongoing',\r\n                                  createdAt: proj.createdAt || '',\r\n                                  createdBy: proj.createdBy || ''\r\n                                },\r\n                                companyId\r\n                              });\r\n                            }}\r\n                          >\r\n                            <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                            <Text style={{ fontSize: 16, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\r\n                          </TouchableOpacity>\r\n                        ))\r\n                    )\r\n                  )}\r\n                  {searchText.trim() !== '' && hierarchy.flatMap(main => main.children.flatMap(sub => (sub.children || []).filter(child => child.type === 'project' && (\r\n                    child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                    child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                  )))).length === 0 && (\r\n                    <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 12 }}>Inga projekt hittades.</Text>\r\n                  )}\r\n                </ScrollView>\r\n              </View>\r\n            </View>\r\n          </KeyboardAvoidingView>\r\n        )}\r\n      </Modal>\r\n      {newProjectModalComponent}\r\n      {(() => {\r\n        const isWeb = Platform.OS === 'web';\r\n        const RootContainer = isWeb ? ImageBackground : View;\r\n        const rootContainerProps = isWeb\r\n          ? {\r\n              source: require('../assets/images/inlogg.webb.png'),\r\n              resizeMode: 'cover',\r\n              imageStyle: { width: '100%', height: '100%' },\r\n            }\r\n          : {};\r\n\r\n        return (\r\n          <RootContainer\r\n            {...rootContainerProps}\r\n            style={isWeb ? { flex: 1, width: '100%', minHeight: '100vh', height: windowHeight || undefined } : { flex: 1 }}\r\n          >\r\n            {isWeb ? (\r\n              <View\r\n                pointerEvents=\"none\"\r\n                style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0 }}\r\n              />\r\n            ) : null}\r\n\r\n            {headerProjectQuery && headerSearchOpen ? (\r\n              (() => {\r\n                const Dropdown = (\r\n                  <View\r\n                    pointerEvents=\"auto\"\r\n                    style={{\r\n                      position: Platform.OS === 'web' ? 'fixed' : 'absolute',\r\n                      top: Platform.OS === 'web' ? headerSearchBottom : 8,\r\n                      left: Platform.OS === 'web' && headerSearchLeft !== null ? headerSearchLeft : 0,\r\n                      zIndex: 99999,\r\n                      alignItems: 'flex-start',\r\n                      marginTop: 0,\r\n                      paddingTop: 0,\r\n                    }}\r\n                  >\r\n                    <Animated.View\r\n                      style={{\r\n                          width: headerSearchWidth || 560,\r\n                          backgroundColor: '#fff',\r\n                          borderRadius: 16,\r\n                          borderTopLeftRadius: 0,\r\n                          borderTopRightRadius: 0,\r\n                          overflow: 'hidden',\r\n                          borderLeftWidth: 1,\r\n                          borderRightWidth: 1,\r\n                          borderBottomWidth: 1,\r\n                          borderTopWidth: 0,\r\n                          borderColor: '#666',\r\n                          shadowColor: '#000',\r\n                          shadowOffset: { width: 0, height: 6 },\r\n                          shadowOpacity: 0.18,\r\n                          shadowRadius: 14,\r\n                          elevation: 10,\r\n                          marginTop: 0,\r\n                          paddingTop: 0,\r\n                          opacity: Platform.OS === 'web' ? dropdownAnim : 1,\r\n                          transform: Platform.OS === 'web' ? [{ scale: dropdownAnim.interpolate({ inputRange: [0, 1], outputRange: [0.995, 1] }) }] : undefined,\r\n                        }}\r\n                    >\r\n                      <ScrollView style={{ maxHeight: 320 }} contentContainerStyle={{ paddingTop: 0 }} keyboardShouldPersistTaps=\"handled\">\r\n                        {headerProjectMatches.map((proj) => (\r\n                          <TouchableOpacity\r\n                            key={proj.id}\r\n                            onMouseEnter={Platform.OS === 'web' ? () => setHoveredProjectId(proj.id) : undefined}\r\n                            onMouseLeave={Platform.OS === 'web' ? () => setHoveredProjectId(null) : undefined}\r\n                            style={{ paddingVertical: 10, paddingHorizontal: 14, borderBottomWidth: 1, borderColor: '#f0f0f0', flexDirection: 'row', alignItems: 'center', backgroundColor: Platform.OS === 'web' && hoveredProjectId === proj.id ? '#F7FBFF' : '#fff' }}\r\n                            activeOpacity={0.8}\r\n                            onPress={() => {\r\n                                // Switch project inline and close the header dropdown (keep the query text).\r\n                                try { navigation?.setParams?.({ headerSearchOpen: false }); } catch(e) {}\r\n                                requestProjectSwitch(proj, { selectedAction: null });\r\n                              }}\r\n                          >\r\n                            <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\r\n                            <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">\r\n                              {proj.id} - {proj.name}\r\n                            </Text>\r\n                          </TouchableOpacity>\r\n                        ))}\r\n\r\n                        {headerProjectMatches.length === 0 ? (\r\n                          <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', paddingVertical: 14 }}>\r\n                            Inga projekt hittades.\r\n                          </Text>\r\n                        ) : null}\r\n                      </ScrollView>\r\n                    </Animated.View>\r\n                  </View>\r\n                );\r\n\r\n                if (Platform.OS === 'web' && createPortal && typeof document !== 'undefined') {\r\n                  try {\r\n                    let portalRoot = document.getElementById(portalRootId);\r\n                    if (!portalRoot) {\r\n                      portalRoot = document.createElement('div');\r\n                      portalRoot.id = portalRootId;\r\n                      portalRoot.style.position = 'relative';\r\n                      document.body.appendChild(portalRoot);\r\n                    }\r\n                    return createPortal(Dropdown, portalRoot);\r\n                  } catch(e) {\r\n                    return Dropdown;\r\n                  }\r\n                }\r\n                return Dropdown;\r\n              })()\r\n            ) : null}\r\n\r\n            <ScrollView style={{ flex: 1, backgroundColor: 'transparent' }} scrollEnabled={Platform.OS !== 'web'} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\r\n        {/* Header */}\r\n        <View\r\n          onLayout={(e) => {\r\n            const h = e?.nativeEvent?.layout?.height;\r\n            if (Platform.OS === 'web' && typeof h === 'number' && h > 0 && Math.abs(h - headerHeight) > 1) {\r\n              setHeaderHeight(h);\r\n            }\r\n          }}\r\n          style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', padding: 16, backgroundColor: '#F7FAFC', borderBottomWidth: 1, borderColor: '#e6e6e6' }}\r\n        >\r\n          <View>\r\n            <TouchableOpacity onPress={handleAdminTitlePress} activeOpacity={0.7}>\r\n              <Text style={{ fontSize: 18, fontWeight: 'bold', color: '#263238' }}>Hej, {firstName || 'Användare'}!</Text>\r\n            </TouchableOpacity>\r\n            <Text style={{ fontSize: 14, color: '#666' }}>Vad vill du göra idag?</Text>\r\n            {__DEV__ && showAdminButton && canShowSupportToolsInHeader && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => {\r\n                  await saveHierarchy('testdemo', testHierarchy);\r\n                  setShowAdminButton(false);\r\n                  alert('Testdata har lagts in!');\r\n                }}\r\n              >\r\n                <Text style={{ color: '#fff', fontWeight: 'bold' }}>Fyll på testdata</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {__DEV__ && showAdminButton && canShowSupportToolsInHeader && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#43A047', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => {\r\n                  await handleMakeDemoAdmin();\r\n                  alert('Din användare är nu markerad som demo/admin (client-side).');\r\n                }}\r\n              >\r\n                <Text style={{ color: '#fff', fontWeight: 'bold' }}>{adminActionRunning ? 'Kör...' : 'Gör mig demo-admin'}</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {canShowSupportToolsInHeader && localFallbackExists && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#FFB300', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => {\r\n                  // migrate local fallback (hierarki + controls) to Firestore with confirmation\r\n                  try {\r\n                    const rawHierarchy = await AsyncStorage.getItem('hierarchy_local');\r\n                    const rawCompleted = await AsyncStorage.getItem('completed_controls');\r\n                    const rawDrafts = await AsyncStorage.getItem('draft_controls');\r\n\r\n                    if (!rawHierarchy && !rawCompleted && !rawDrafts) {\r\n                      Alert.alert('Ingen lokal data', 'Ingen lokalt sparad hierarki eller kontroller hittades.');\r\n                      await refreshLocalFallbackFlag();\r\n                      return;\r\n                    }\r\n\r\n                    Alert.alert(\r\n                      'Migrera lokal data',\r\n                      'Vill du migrera lokalt sparad hierarki och kontroller till molnet för kontot? Detta kan skriva över befintlig molndata.',\r\n                      [\r\n                        { text: 'Avbryt', style: 'cancel' },\r\n                        { text: 'Migrera', onPress: async () => {\r\n                          try {\r\n                            let successMsgs = [];\r\n\r\n                            // Hierarki\r\n                            if (rawHierarchy) {\r\n                              try {\r\n                                const parsed = JSON.parse(rawHierarchy);\r\n                                const res = await saveHierarchy(companyId, parsed);\r\n                                const ok = res === true || (res && res.ok === true);\r\n                                if (ok) {\r\n                                  await AsyncStorage.removeItem('hierarchy_local');\r\n                                  setHierarchy(parsed);\r\n                                  successMsgs.push('Hierarki migrerad');\r\n                                } else {\r\n                                  successMsgs.push('Hierarki misslyckades');\r\n                                }\r\n                              } catch(e) {\r\n                                successMsgs.push('Hierarki-fel');\r\n                              }\r\n                            }\r\n\r\n                            // Controls: backup locally first\r\n                            if (rawCompleted) {\r\n                              try {\r\n                                await AsyncStorage.setItem('completed_controls_backup', rawCompleted);\r\n                                const parsedCompleted = JSON.parse(rawCompleted);\r\n                                let okCount = 0;\r\n                                for (const ctl of parsedCompleted) {\r\n                                  try {\r\n                                    const ok = await saveControlToFirestore(ctl);\r\n                                    if (ok) okCount++;\r\n                                  } catch(e) {}\r\n                                }\r\n                                if (okCount > 0) {\r\n                                  await AsyncStorage.removeItem('completed_controls');\r\n                                  successMsgs.push(`${okCount} utförda kontroller migrerade`);\r\n                                } else {\r\n                                  successMsgs.push('Inga utförda kontroller migrerade');\r\n                                }\r\n                              } catch(e) {\r\n                                successMsgs.push('Backup/migrering av utförda kontroller misslyckades');\r\n                              }\r\n                            }\r\n\r\n                            if (rawDrafts) {\r\n                              try {\r\n                                await AsyncStorage.setItem('draft_controls_backup', rawDrafts);\r\n                                const parsedDrafts = JSON.parse(rawDrafts);\r\n                                let okDrafts = 0;\r\n                                for (const d of parsedDrafts) {\r\n                                  try {\r\n                                    const ok = await saveDraftToFirestore(d);\r\n                                    if (ok) okDrafts++;\r\n                                  } catch(e) {}\r\n                                }\r\n                                if (okDrafts > 0) {\r\n                                  await AsyncStorage.removeItem('draft_controls');\r\n                                  successMsgs.push(`${okDrafts} utkast migrerade`);\r\n                                } else {\r\n                                  successMsgs.push('Inga utkast migrerade');\r\n                                }\r\n                              } catch(e) {\r\n                                successMsgs.push('Backup/migrering av utkast misslyckades');\r\n                              }\r\n                            }\r\n\r\n                            Alert.alert('Migrering klar', successMsgs.join('\\n'));\r\n                            await refreshLocalFallbackFlag();\r\n                          } catch(e) {\r\n                            Alert.alert('Fel', 'Kunde inte migrera: ' + (e?.message || 'okänt fel'));\r\n                          }\r\n                        }}\r\n                      ],\r\n                    );\r\n                  } catch(e) {\r\n                    Alert.alert('Fel', 'Kunde inte läsa lokal data.');\r\n                  }\r\n                }}\r\n              >\r\n                <Text style={{ color: '#222', fontWeight: '700' }}>Migrera lokal data</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {canShowSupportToolsInHeader && (auth && auth.currentUser) && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => {\r\n                  try {\r\n                    // Force refresh token\r\n                    await auth.currentUser.getIdToken(true);\r\n                    Alert.alert('Token uppdaterad', 'ID-token uppdaterad. Försöker migrera lokal data...');\r\n                    // attempt migration if local data exists\r\n                    const raw = await AsyncStorage.getItem('hierarchy_local');\r\n                    if (!raw) {\r\n                      Alert.alert('Ingen lokal data', 'Inget att migrera.');\r\n                      await refreshLocalFallbackFlag();\r\n                      return;\r\n                    }\r\n                    const parsed = JSON.parse(raw);\r\n                    const res = await saveHierarchy(companyId, parsed);\r\n                    const ok = res === true || (res && res.ok === true);\r\n                    if (ok) {\r\n                      await AsyncStorage.removeItem('hierarchy_local');\r\n                      await refreshLocalFallbackFlag();\r\n                      setHierarchy(parsed);\r\n                      Alert.alert('Klar', 'Lokal hierarki migrerad till molnet.');\r\n                    } else {\r\n                      Alert.alert('Misslyckades', 'Kunde inte spara till molnet. Fel: ' + (res && res.error ? res.error : 'okänt fel'));\r\n                    }\r\n                  } catch(e) {\r\n                    Alert.alert('Fel', 'Kunde inte uppdatera token eller migrera: ' + (e?.message || e));\r\n                  }\r\n                }}\r\n              >\r\n                <Text style={{ color: '#fff', fontWeight: '700' }}>Uppdatera token & synka</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {canShowSupportToolsInHeader && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#eee', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => {\r\n                  try {\r\n                    const user = auth.currentUser;\r\n                    const tokenRes = user ? await auth.currentUser.getIdTokenResult(true).catch((e) => null) : null;\r\n                    const claims = tokenRes?.claims || {};\r\n                    const stored = await AsyncStorage.getItem('dk_companyId');\r\n                    Alert.alert('Auth info', `user: ${user ? user.email + ' (' + user.uid + ')' : 'not signed in'}\\nclaims.companyId: ${claims.companyId || '—'}\\ndk_companyId: ${stored || '—'}`);\r\n                  } catch(e) {\r\n                    Alert.alert('Fel', 'Kunde inte läsa auth info: ' + (e?.message || e));\r\n                  }\r\n                }}\r\n              >\r\n                <Text style={{ color: '#222', fontWeight: '700' }}>Visa auth-info</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {canShowSupportToolsInHeader && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#ddd', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => { await dumpLocalRemoteControls(); }}\r\n              >\r\n                <Text style={{ color: '#222', fontWeight: '700' }}>Debug: visa lokal/moln</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n            {canShowSupportToolsInHeader && (\r\n              <TouchableOpacity\r\n                style={{ backgroundColor: '#f5f5f5', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\r\n                onPress={async () => { await showLastFsError(); }}\r\n              >\r\n                <Text style={{ color: '#222', fontWeight: '700' }}>Visa senaste FS-fel</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n          </View>\r\n          <View style={{ alignItems: 'flex-end' }}>\r\n          <TouchableOpacity\r\n            style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 3, paddingHorizontal: 8, alignItems: 'center', minWidth: 60, minHeight: 28 }}\r\n            onPress={async () => {\r\n              setLoggingOut(true);\r\n              try { await AsyncStorage.removeItem('dk_companyId'); } catch(e) {}\r\n              await auth.signOut();\r\n              setLoggingOut(false);\r\n              navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\r\n            }}\r\n          >\r\n            <Text style={{ color: '#222', fontWeight: 'bold', fontSize: 13 }}>Logga ut</Text>\r\n          </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n        {/* Allt under headern är skrollbart */}\r\n        {Platform.OS === 'web' ? (\r\n          <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\r\n                  <View style={{ width: leftWidth, padding: 8, borderRightWidth: 0, borderColor: '#e6e6e6', backgroundColor: '#f5f6f7', height: webPaneHeight, position: 'relative' }}>\r\n                    {/* Thin right-side divider for visual separation */}\r\n                    <View style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: 1, backgroundColor: '#e6e6e6' }} />\r\n                    {/* Draggable handle - sits above the divider */}\r\n                    <View\r\n                  {...(panResponder && panResponder.panHandlers)}\r\n                  style={Platform.OS === 'web' ? { position: 'absolute', right: -8, top: 0, bottom: 0, width: 16, cursor: 'col-resize', zIndex: 9 } : { position: 'absolute', right: -12, top: 0, bottom: 0, width: 24, zIndex: 9 }}\r\n                    />\r\n              <View style={{ paddingVertical: 6, paddingHorizontal: 6, borderBottomWidth: 2, borderColor: '#e0e0e0', marginBottom: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                  <Text style={{ fontSize: 20, fontWeight: '700', color: '#222' }}>Projekt</Text>\r\n                </View>\r\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                  <TouchableOpacity\r\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\r\n                    onPress={() => {\r\n                      if (selectedProject) closeSelectedProject();\r\n                    }}\r\n                    activeOpacity={0.7}\r\n                    accessibilityLabel=\"Hem\"\r\n                  >\r\n                    <Ionicons name=\"home-outline\" size={18} color=\"#1976D2\" />\r\n                  </TouchableOpacity>\r\n\r\n                  <TouchableOpacity\r\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\r\n                    onPress={() => {\r\n                      if (selectedProject) {\r\n                        setProjectControlsRefreshNonce((n) => n + 1);\r\n                      } else {\r\n                        try { loadDashboard(); } catch(e) {}\r\n                      }\r\n                    }}\r\n                    activeOpacity={0.7}\r\n                    accessibilityLabel=\"Uppdatera\"\r\n                  >\r\n                    <Ionicons name=\"refresh\" size={18} color=\"#1976D2\" />\r\n                  </TouchableOpacity>\r\n\r\n                  <TouchableOpacity\r\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\r\n                    onPress={() => setFilterModalVisible(true)}\r\n                    activeOpacity={0.7}\r\n                  >\r\n                    <View style={{ position: 'relative' }}>\r\n                      <Ionicons name=\"filter\" size={18} color=\"#1976D2\" />\r\n                      {projectStatusFilter !== 'all' && (\r\n                        <View\r\n                          style={{\r\n                            position: 'absolute',\r\n                            right: -1,\r\n                            top: -1,\r\n                            width: 9,\r\n                            height: 9,\r\n                            borderRadius: 5,\r\n                            backgroundColor: projectStatusFilter === 'completed' ? '#222' : '#43A047',\r\n                            borderWidth: 1,\r\n                            borderColor: '#f5f6f7',\r\n                          }}\r\n                        />\r\n                      )}\r\n                    </View>\r\n                  </TouchableOpacity>\r\n\r\n                  \r\n                </View>\r\n              </View>\r\n              <ScrollView ref={leftTreeScrollRef} style={{ flex: 1 }}>\r\n                {loadingHierarchy || hierarchy.length === 0 ? (\r\n                  <Text style={{ color: '#888', fontSize: 16, textAlign: 'center', marginTop: 32 }}>\r\n                    Inga mappar eller projekt skapade ännu.\r\n                  </Text>\r\n                ) : (\r\n                  <View style={{ paddingHorizontal: 4 }} nativeID={Platform.OS === 'web' ? 'dk-tree-root' : undefined}>\r\n                    {[...hierarchy]\r\n                      .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                      .map((main) => (\r\n                        <View key={main.id} style={{ marginBottom: 0, padding: 0 }}>\r\n                          <View\r\n                            style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 4px', userSelect: 'none' }}\r\n                            dataSet={Platform.OS === 'web' ? { dkType: 'main', dkMainid: String(main.id) } : undefined}\r\n                          >\r\n                            {(() => {\r\n                              const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('main', String(main.id));\r\n                              return (\r\n                            <TouchableOpacity\r\n                              dataSet={Platform.OS === 'web' ? { dkType: 'main', dkMainid: String(main.id) } : undefined}\r\n                              style={{\r\n                                flexDirection: 'row',\r\n                                alignItems: 'center',\r\n                                flex: 1,\r\n                                backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                borderRadius: 4,\r\n                                padding: '2px 4px',\r\n                                borderWidth: 1,\r\n                                borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                transition: 'background 0.15s, border 0.15s',\r\n                              }}\r\n                              onPress={() => setHierarchy(prev => prev.map(m => m.id === main.id ? { ...m, expanded: !m.expanded } : { ...m, expanded: false }))}\r\n                              activeOpacity={0.7}\r\n                              onLongPress={() => setEditModal({ visible: true, type: 'main', id: main.id, name: main.name })}\r\n                              delayLongPress={2000}\r\n                              onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('main', String(main.id))) : undefined}\r\n                              onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\r\n                              onPressIn={() => {\r\n                                if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\r\n                                mainTimersRef.current[main.id] = setTimeout(() => {\r\n                                  setEditModal({ visible: true, type: 'main', id: main.id, name: main.name });\r\n                                }, 2000);\r\n                              }}\r\n                              onPressOut={() => {\r\n                                if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\r\n                              }}\r\n                            >\r\n                              <Ionicons name={main.expanded ? 'chevron-down' : 'chevron-forward'} size={18} color=\"#222\" style={{ marginRight: 4 }} />\r\n                              <Text style={{ fontSize: 15, fontWeight: isHovered ? '700' : '600', color: '#222', marginLeft: 2 }}>{main.name}</Text>\r\n                            </TouchableOpacity>\r\n                              );\r\n                            })()}\r\n                          </View>\r\n                          {main.expanded && (\r\n                            !main.children || main.children.length === 0 ? (\r\n                              <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 22, marginTop: 6 }}>\r\n                                Inga undermappar skapade\r\n                              </Text>\r\n                            ) : (\r\n                              [...main.children]\r\n                                .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                                .map((sub) => {\r\n                                  const allProjects = sub.children ? sub.children.filter(child => child.type === 'project') : [];\r\n                                  const projects = projectStatusFilter === 'all'\r\n                                    ? allProjects\r\n                                    : allProjects.filter((p) => {\r\n                                        const status = p?.status || 'ongoing';\r\n                                        return projectStatusFilter === 'completed'\r\n                                          ? status === 'completed'\r\n                                          : status !== 'completed';\r\n                                      });\r\n                                  return (\r\n                                    <View key={sub.id} style={{ marginLeft: 20, marginBottom: 0, padding: 0 }}>\r\n                                  <View\r\n                                    style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 0', userSelect: 'none' }}\r\n                                    dataSet={Platform.OS === 'web' ? { dkType: 'sub', dkMainid: String(main.id), dkSubid: String(sub.id) } : undefined}\r\n                                  >\r\n                                    {(() => {\r\n                                      const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('sub', String(main.id), String(sub.id));\r\n                                      return (\r\n                                    <TouchableOpacity\r\n                                      dataSet={Platform.OS === 'web' ? { dkType: 'sub', dkMainid: String(main.id), dkSubid: String(sub.id) } : undefined}\r\n                                      style={{\r\n                                        flexDirection: 'row',\r\n                                        alignItems: 'center',\r\n                                        flex: 1,\r\n                                        backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                        borderRadius: 4,\r\n                                        padding: '2px 4px',\r\n                                        borderWidth: 1,\r\n                                        borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                        transition: 'background 0.15s, border 0.15s',\r\n                                      }}\r\n                                      onPress={() => setHierarchy(toggleExpand(1, sub.id))}\r\n                                      onLongPress={() => setEditModal({ visible: true, type: 'sub', id: sub.id, name: sub.name })}\r\n                                      delayLongPress={2000}\r\n                                      activeOpacity={0.7}\r\n                                      onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('sub', String(main.id), String(sub.id))) : undefined}\r\n                                      onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\r\n                                    >\r\n                                      <Ionicons name={sub.expanded ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 4 }} />\r\n                                      <Text style={{ fontSize: 14, fontWeight: isHovered ? '700' : '600', color: '#222', marginLeft: 2 }}>{sub.name}</Text>\r\n                                    </TouchableOpacity>\r\n                                      );\r\n                                    })()}\r\n                                  </View>\r\n                                  {sub.expanded && (\r\n                                    <React.Fragment>\r\n                                      {projects.length === 0 ? (\r\n                                        <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\r\n                                          {allProjects.length === 0 ? 'Inga projekt skapade' : 'Inga projekt matchar filtret'}\r\n                                        </Text>\r\n                                      ) : (\r\n                                        projects\r\n                                          .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                                          .map((proj) => (\r\n                                            <View\r\n                                              key={proj.id}\r\n                                              style={{ marginLeft: 32 }}\r\n                                              dataSet={Platform.OS === 'web' ? { dkType: 'project', dkMainid: String(main.id), dkSubid: String(sub.id), dkProjectid: String(proj.id) } : undefined}\r\n                                            >\r\n                                              {(() => {\r\n                                                const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('project', String(main.id), String(sub.id), String(proj.id));\r\n                                                return (\r\n                                              <TouchableOpacity\r\n                                                dataSet={Platform.OS === 'web' ? { dkType: 'project', dkMainid: String(main.id), dkSubid: String(sub.id), dkProjectid: String(proj.id) } : undefined}\r\n                                                style={{\r\n                                                  flexDirection: 'row',\r\n                                                  alignItems: 'center',\r\n                                                  backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                                  borderRadius: 4,\r\n                                                  padding: '2px 4px',\r\n                                                  marginBottom: 0,\r\n                                                  borderWidth: 1,\r\n                                                  borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                                  transition: 'background 0.15s, border 0.15s',\r\n                                                }}\r\n                                                onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('project', String(main.id), String(sub.id), String(proj.id))) : undefined}\r\n                                                onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\r\n                                                onPress={() => {\r\n                                                  if (Platform.OS === 'web') {\r\n                                                    requestProjectSwitch(proj, { selectedAction: null });\r\n                                                  } else {\r\n                                                    navigation.navigate('ProjectDetails', {\r\n                                                      project: {\r\n                                                        id: proj.id,\r\n                                                        name: proj.name,\r\n                                                        ansvarig: proj.ansvarig || '',\r\n                                                        adress: proj.adress || '',\r\n                                                        fastighetsbeteckning: proj.fastighetsbeteckning || '',\r\n                                                        client: proj.client || '',\r\n                                                        status: proj.status || 'ongoing',\r\n                                                        createdAt: proj.createdAt || '',\r\n                                                        createdBy: proj.createdBy || ''\r\n                                                      },\r\n                                                      companyId\r\n                                                    });\r\n                                                  }\r\n                                                }}\r\n                                              >\r\n                                                <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 6, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                                <Text\r\n                                                  style={{ fontSize: 13, color: '#1976D2', fontWeight: isHovered ? '700' : '400', marginLeft: 2, marginRight: 6, flexShrink: 1 }}\r\n                                                  numberOfLines={1}\r\n                                                  ellipsizeMode=\"tail\"\r\n                                                >\r\n                                                  {proj.id} — {proj.name}\r\n                                                </Text>\r\n                                              </TouchableOpacity>\r\n                                                );\r\n                                              })()}\r\n                                            </View>\r\n                                          ))\r\n                                      )}\r\n                                    </React.Fragment>\r\n                                  )}\r\n                                </View>\r\n                                  );\r\n                                })\r\n                            )\r\n                          )}\r\n                        </View>\r\n                      ))}\r\n                  </View>\r\n                )}\r\n              </ScrollView>\r\n\r\n              {Platform.OS === 'web' && (\r\n                <ContextMenu\r\n                  visible={contextMenu.visible}\r\n                  x={contextMenu.x}\r\n                  y={contextMenu.y}\r\n                  items={contextMenuItems}\r\n                  onSelect={handleContextMenuSelect}\r\n                  onClose={closeContextMenu}\r\n                />\r\n              )}\r\n              \r\n              {/* Sidebar bottom-left: sync status + app version (web portal to avoid clipping) */}\r\n              {Platform.OS === 'web' && createPortal && typeof document !== 'undefined' ? (() => {\r\n                try {\r\n                  let footerRoot = document.getElementById('dk-footer-portal');\r\n                  if (!footerRoot) {\r\n                    footerRoot = document.createElement('div');\r\n                    footerRoot.id = 'dk-footer-portal';\r\n                    document.body.appendChild(footerRoot);\r\n                  }\r\n\r\n                  const FooterBox = (\r\n                    <View style={{ position: 'fixed', left: 12, bottom: 12, zIndex: 2147483647, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.96)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', shadowColor: '#000', shadowOffset: { width: 0, height: 6 }, shadowOpacity: 0.12, shadowRadius: 12, elevation: 12 }}>\r\n                      <View style={{ flexDirection: 'row', alignItems: 'center', gap: 10 }}>\r\n                        <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\r\n                          Synk: {syncStatus}\r\n                        </Text>\r\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 6 }}>Version: {appVersion}</Text>\r\n                      </View>\r\n                    </View>\r\n                  );\r\n\r\n                  return createPortal(FooterBox, footerRoot);\r\n                } catch(e) {\r\n                  return (\r\n                    <View style={{ position: 'absolute', left: 8, bottom: 8, zIndex: 9999, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.95)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', elevation: 8 }}>\r\n                      <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                        <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\r\n                          Synk: {syncStatus}\r\n                        </Text>\r\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 8 }}>Version: {appVersion}</Text>\r\n                      </View>\r\n                    </View>\r\n                  );\r\n                }\r\n              })() : (\r\n                <View style={{ position: 'absolute', left: 8, bottom: 8, zIndex: 9999, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.95)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', elevation: 8 }}>\r\n                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                    <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\r\n                      Synk: {syncStatus}\r\n                    </Text>\r\n                    <Text style={{ fontSize: 12, color: '#666', marginLeft: 8 }}>Version: {appVersion}</Text>\r\n                  </View>\r\n                </View>\r\n              )}\r\n\r\n            </View>\r\n            {Platform.OS === 'web' && (\r\n              <TouchableOpacity\r\n                onPress={() => scrollToEndSafe(leftTreeScrollRef)}\r\n                activeOpacity={0.85}\r\n                style={{\r\n                  position: 'absolute',\r\n                  right: 10,\r\n                  bottom: 10,\r\n                  zIndex: 20,\r\n                  backgroundColor: '#fff',\r\n                  borderRadius: 16,\r\n                  borderWidth: 1,\r\n                  borderColor: '#e0e0e0',\r\n                  padding: 6,\r\n                }}\r\n              >\r\n                <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n              </TouchableOpacity>\r\n            )}\r\n\r\n            <View style={{ flex: 1, height: webPaneHeight, position: 'relative' }}>\r\n              {Platform.OS === 'web' ? (\r\n                <View style={{ flex: 1, flexDirection: 'row', minWidth: 0 }}>\r\n                  {/* Main content (dashboard / project / control) */}\r\n                  <View style={{ flex: 1, minWidth: 0 }}>\r\n                    <ScrollView ref={rightPaneScrollRef} style={{ flex: 1 }} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\r\n                      {selectedProject ? (\r\n                        <View style={{ flex: 1 }}>\r\n                          <ProjectDetails route={{ params: { project: selectedProject, companyId, selectedAction: projectSelectedAction, onInlineLockChange: handleInlineLockChange } }} navigation={navigation} inlineClose={closeSelectedProject} refreshNonce={projectControlsRefreshNonce} />\r\n                        </View>\r\n                      ) : (\r\n                        <View style={{ flex: 1, padding: 18 }}>\r\n                          <View style={{ position: 'relative' }}>\r\n                            {Platform.OS === 'web' && dashboardFocus ? (\r\n                              <Pressable\r\n                                style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, zIndex: 10 }}\r\n                                onPress={() => setDashboardFocus(null)}\r\n                              />\r\n                            ) : null}\r\n\r\n                            <View style={dashboardContainerStyle}>\r\n                            <View style={dashboardColumnsStyle}>\r\n                              {/* Column 1: Continue */}\r\n                              <View style={{ flex: 1, minWidth: 360, marginRight: 16 }}>\r\n                                <Text style={dashboardSectionTitleStyle}>Senaste projekten</Text>\r\n                                <View style={dashboardCardStyle}>\r\n                                  {dashboardLoading ? (\r\n                                    <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\r\n                                  ) : (dashboardRecentProjects || []).length === 0 ? (\r\n                                    <Text style={dashboardEmptyTextStyle}>Inga senaste projekt ännu.</Text>\r\n                                  ) : (\r\n                                    (dashboardRecentProjects || []).map((entry, idx) => (\r\n                                      <TouchableOpacity\r\n                                        key={`${entry.projectId}-${idx}`}\r\n                                        activeOpacity={0.85}\r\n                                        onPress={() => {\r\n                                          if (entry?.project) {\r\n                                            requestProjectSwitch(entry.project, { selectedAction: null });\r\n                                          }\r\n                                        }}\r\n                                        style={dashboardListItemStyle(idx)}\r\n                                      >\r\n                                        <Text style={dashboardLinkTitleStyle} numberOfLines={1}>\r\n                                          {entry.project.id} — {entry.project.name}\r\n                                        </Text>\r\n                                        <Text style={dashboardMetaTextStyle}>\r\n                                          Senast aktivitet: {formatRelativeTime(entry.ts)}\r\n                                        </Text>\r\n                                      </TouchableOpacity>\r\n                                    ))\r\n                                  )}\r\n                                </View>\r\n                              </View>\r\n\r\n                              {/* Column 2: Overview */}\r\n                              <View style={{ width: 320, minWidth: 280, position: 'relative' }}>\r\n                                <Text style={dashboardSectionTitleStyle}>Översikt</Text>\r\n                                <View\r\n                                  style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}\r\n                                  onLayout={Platform.OS === 'web' ? (e) => { dashboardCardLayoutRef.current.overview = e?.nativeEvent?.layout || null; } : undefined}\r\n                                >\r\n                                  {[\r\n                                    { key: 'activeProjects', label: 'Pågående projekt', color: '#43A047', value: dashboardOverview.activeProjects, focus: 'activeProjects' },\r\n                                    { key: 'controlsToSign', label: 'Kontroller att signera', color: '#D32F2F', value: dashboardOverview.controlsToSign, focus: 'controlsToSign' },\r\n                                    { key: 'drafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts' },\r\n                                  ].map((row, ridx) => {\r\n                                    const isWeb = Platform.OS === 'web';\r\n                                    const isHovered = isWeb && dashboardHoveredStatKey === row.key;\r\n                                    const isOpen = isWeb && dashboardFocus === row.focus && dashboardDropdownAnchor === 'overview';\r\n                                    const openFromRow = () => {\r\n                                      if (row.key === 'activeProjects') setProjectStatusFilter('ongoing');\r\n                                      const cardLayout = dashboardCardLayoutRef.current.overview;\r\n                                      const rowLayout = dashboardStatRowLayoutRef.current[`overview:${row.key}`];\r\n                                      const top = (cardLayout && rowLayout) ? (cardLayout.y + rowLayout.y + rowLayout.height + 6) : undefined;\r\n                                      toggleDashboardFocus(row.focus, 'overview', top);\r\n                                    };\r\n                                    return (\r\n                                      <TouchableOpacity\r\n                                        key={row.key}\r\n                                        style={{\r\n                                          ...dashboardStatRowStyle(ridx),\r\n                                          paddingHorizontal: 6,\r\n                                          borderRadius: 8,\r\n                                          borderWidth: 1,\r\n                                          borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                          backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                          cursor: isWeb ? 'pointer' : undefined,\r\n                                          transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\r\n                                        }}\r\n                                        activeOpacity={0.75}\r\n                                        onPress={openFromRow}\r\n                                        onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\r\n                                        onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\r\n                                        onLayout={isWeb ? (e) => {\r\n                                          const l = e?.nativeEvent?.layout;\r\n                                          if (l) dashboardStatRowLayoutRef.current[`overview:${row.key}`] = l;\r\n                                        } : undefined}\r\n                                      >\r\n                                        <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} />\r\n                                        <View style={dashboardStatDotStyle(row.color)} />\r\n                                        <Text style={dashboardStatLabelStyle}>{row.label}</Text>\r\n                                        <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\r\n                                      </TouchableOpacity>\r\n                                    );\r\n                                  })}\r\n                                </View>\r\n\r\n                                <Text style={dashboardSectionTitleStyle}>Påminnelser</Text>\r\n                                <View\r\n                                  style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}\r\n                                  onLayout={Platform.OS === 'web' ? (e) => { dashboardCardLayoutRef.current.reminders = e?.nativeEvent?.layout || null; } : undefined}\r\n                                >\r\n                                  {[\r\n                                    {\r\n                                      key: 'remindersSkyddsrondUpcoming',\r\n                                      label: 'Kommande skyddsronder',\r\n                                      color: '#FFD600',\r\n                                      value: (dashboardOverview.skyddsrondDueSoon ?? 0) + (dashboardOverview.skyddsrondOverdue ?? 0),\r\n                                      focus: 'upcomingSkyddsrond',\r\n                                    },\r\n                                    { key: 'remindersOpenDeviations', label: 'Öppna avvikelser', color: '#FFD600', value: dashboardOverview.openDeviations, focus: 'openDeviations' },\r\n                                    { key: 'remindersDrafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts' },\r\n                                  ].map((row, ridx) => {\r\n                                    const isWeb = Platform.OS === 'web';\r\n                                    const isHovered = isWeb && dashboardHoveredStatKey === row.key;\r\n                                    const isOpen = isWeb && dashboardFocus === row.focus && dashboardDropdownAnchor === 'reminders';\r\n                                    const openFromRow = () => {\r\n                                      const cardLayout = dashboardCardLayoutRef.current.reminders;\r\n                                      const rowLayout = dashboardStatRowLayoutRef.current[`reminders:${row.key}`];\r\n                                      const top = (cardLayout && rowLayout) ? (cardLayout.y + rowLayout.y + rowLayout.height + 6) : undefined;\r\n                                      toggleDashboardFocus(row.focus, 'reminders', top);\r\n                                    };\r\n                                    return (\r\n                                      <TouchableOpacity\r\n                                        key={row.key}\r\n                                        style={{\r\n                                          ...dashboardStatRowStyle(ridx),\r\n                                          paddingHorizontal: 6,\r\n                                          borderRadius: 8,\r\n                                          borderWidth: 1,\r\n                                          borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                          backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                          cursor: isWeb ? 'pointer' : undefined,\r\n                                          transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\r\n                                        }}\r\n                                        activeOpacity={0.75}\r\n                                        onPress={openFromRow}\r\n                                        onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\r\n                                        onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\r\n                                        onLayout={isWeb ? (e) => {\r\n                                          const l = e?.nativeEvent?.layout;\r\n                                          if (l) dashboardStatRowLayoutRef.current[`reminders:${row.key}`] = l;\r\n                                        } : undefined}\r\n                                      >\r\n                                        <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} />\r\n                                        <View style={dashboardStatDotStyle(row.color)} />\r\n                                        <Text style={dashboardStatLabelStyle}>{row.label}</Text>\r\n                                        <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\r\n                                      </TouchableOpacity>\r\n                                    );\r\n                                  })}\r\n                                </View>\r\n\r\n                                {/* Web-only: dropdown overlay (doesn't push layout) */}\r\n                                {Platform.OS === 'web' && dashboardFocus ? (\r\n                                  <View\r\n                                    style={{\r\n                                      position: 'absolute',\r\n                                      left: 0,\r\n                                      right: 0,\r\n                                      top: typeof dashboardDropdownTop === 'number'\r\n                                        ? dashboardDropdownTop\r\n                                        : (dashboardDropdownAnchor === 'reminders' ? 210 : 46),\r\n                                      zIndex: 20,\r\n                                    }}\r\n                                  >\r\n                                    <View style={dashboardCardStyle}>\r\n                                      <View style={{ paddingHorizontal: 6, paddingBottom: 8 }}>\r\n                                        <Text style={{ ...dashboardStatLabelStyle, fontWeight: '600' }}>\r\n                                          {dashboardFocus === 'activeProjects'\r\n                                            ? 'Pågående projekt'\r\n                                            : dashboardFocus === 'controlsToSign'\r\n                                              ? 'Kontroller att signera'\r\n                                              : dashboardFocus === 'drafts'\r\n                                                ? 'Sparade utkast'\r\n                                                : dashboardFocus === 'openDeviations'\r\n                                                  ? 'Öppna avvikelser'\r\n                                                  : dashboardFocus === 'upcomingSkyddsrond'\r\n                                                    ? 'Kommande skyddsronder'\r\n                                                    : 'Lista'}\r\n                                        </Text>\r\n                                      </View>\r\n                                      <View style={{ height: 1, backgroundColor: '#eee', marginBottom: 6 }} />\r\n\r\n                                      <ScrollView\r\n                                        style={{\r\n                                          maxHeight: Math.max(\r\n                                            180,\r\n                                            (webPaneHeight || 640) -\r\n                                              (typeof dashboardDropdownTop === 'number' ? dashboardDropdownTop : 220) -\r\n                                              24\r\n                                          ),\r\n                                        }}\r\n                                      >\r\n                                        {dashboardLoading ? (\r\n                                          <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\r\n                                        ) : (\r\n                                          (() => {\r\n                                            const focus = dashboardFocus;\r\n\r\n                                            if (focus === 'activeProjects') {\r\n                                              const items = Array.isArray(dashboardActiveProjectsList) ? dashboardActiveProjectsList : [];\r\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga pågående projekt.</Text>;\r\n                                              return items.map((p, idx) => (\r\n                                                <TouchableOpacity\r\n                                                  key={`${p.id}-${idx}`}\r\n                                                  activeOpacity={0.85}\r\n                                                  onPress={() => { requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); }}\r\n                                                  style={dashboardListItemStyle(idx)}\r\n                                                >\r\n                                                  <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\r\n                                                </TouchableOpacity>\r\n                                              ));\r\n                                            }\r\n\r\n                                            if (focus === 'drafts' || focus === 'controlsToSign') {\r\n                                              const items = focus === 'controlsToSign'\r\n                                                ? (Array.isArray(dashboardControlsToSignItems) ? dashboardControlsToSignItems : [])\r\n                                                : (Array.isArray(dashboardDraftItems) ? dashboardDraftItems : []);\r\n\r\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga utkast.</Text>;\r\n                                              return items.map((d, idx) => {\r\n                                                const pid = d?.project?.id || d?.projectId || d?.project || null;\r\n                                                const projectId = pid ? String(pid) : '';\r\n                                                const projObj = projectId ? findProjectById(projectId) : null;\r\n                                                const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\r\n                                                const ts = d?.savedAt || d?.updatedAt || d?.createdAt || d?.date || null;\r\n                                                const type = String(d?.type || 'Utkast');\r\n                                                return (\r\n                                                  <TouchableOpacity\r\n                                                    key={`${projectId}-${type}-${idx}`}\r\n                                                    activeOpacity={0.85}\r\n                                                    onPress={() => {\r\n                                                      if (!projObj) return;\r\n                                                      requestProjectSwitch(projObj, {\r\n                                                        selectedAction: {\r\n                                                          id: `openDraft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,\r\n                                                          kind: 'openDraft',\r\n                                                          type,\r\n                                                          initialValues: d,\r\n                                                        },\r\n                                                        clearActionAfter: true,\r\n                                                      });\r\n                                                      setDashboardFocus(null);\r\n                                                    }}\r\n                                                    style={dashboardListItemStyle(idx)}\r\n                                                  >\r\n                                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\r\n                                                    <Text style={dashboardMetaTextStyle}>{type}{ts ? ` • Sparat: ${formatRelativeTime(ts)}` : ''}</Text>\r\n                                                  </TouchableOpacity>\r\n                                                );\r\n                                              });\r\n                                            }\r\n\r\n                                            if (focus === 'openDeviations') {\r\n                                              const items = Array.isArray(dashboardOpenDeviationItems) ? dashboardOpenDeviationItems : [];\r\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga öppna avvikelser.</Text>;\r\n                                              return items.map((entry, idx) => {\r\n                                                const c = entry?.control;\r\n                                                const pid = c?.project?.id || c?.projectId || c?.project || null;\r\n                                                const projectId = pid ? String(pid) : '';\r\n                                                const projObj = projectId ? findProjectById(projectId) : null;\r\n                                                const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\r\n                                                const openCount = entry?.openCount || 0;\r\n                                                return (\r\n                                                  <TouchableOpacity\r\n                                                    key={`${projectId}-${c?.id || idx}`}\r\n                                                    activeOpacity={0.85}\r\n                                                    onPress={() => {\r\n                                                      if (!projObj || !c) return;\r\n                                                      requestProjectSwitch(projObj, {\r\n                                                        selectedAction: {\r\n                                                          id: `openControl-${c?.id || Date.now()}`,\r\n                                                          kind: 'openControlDetails',\r\n                                                          control: c,\r\n                                                        },\r\n                                                        clearActionAfter: true,\r\n                                                      });\r\n                                                      setDashboardFocus(null);\r\n                                                    }}\r\n                                                    style={dashboardListItemStyle(idx)}\r\n                                                  >\r\n                                                    <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\r\n                                                      <View style={[dashboardStatDotStyle('#FFD600'), { marginTop: 4 }]} />\r\n                                                      <View style={{ flex: 1, minWidth: 0 }}>\r\n                                                        <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\r\n                                                        <Text style={dashboardMetaTextStyle}>Skyddsrond • Öppna avvikelser: {String(openCount)}</Text>\r\n                                                      </View>\r\n                                                    </View>\r\n                                                  </TouchableOpacity>\r\n                                                );\r\n                                              });\r\n                                            }\r\n\r\n                                            if (focus === 'upcomingSkyddsrond') {\r\n                                              const items = Array.isArray(dashboardUpcomingSkyddsrondItems) ? dashboardUpcomingSkyddsrondItems : [];\r\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga kommande skyddsronder.</Text>;\r\n                                              return items.map((entry, idx) => {\r\n                                                const p = entry?.project;\r\n                                                const dueMs = Number(entry?.nextDueMs || 0);\r\n                                                const dueLabel = dueMs ? new Date(dueMs).toLocaleDateString('sv-SE') : '';\r\n                                                const state = entry?.state === 'overdue' ? 'Försenad' : 'Snart';\r\n                                                return (\r\n                                                  <TouchableOpacity\r\n                                                    key={`${p?.id || 'proj'}-${idx}`}\r\n                                                    activeOpacity={0.85}\r\n                                                    onPress={() => { if (p) requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); }}\r\n                                                    style={dashboardListItemStyle(idx)}\r\n                                                  >\r\n                                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p?.id} — {p?.name}</Text>\r\n                                                    <Text style={dashboardMetaTextStyle}>{state}{dueLabel ? ` • Nästa: ${dueLabel}` : ''}</Text>\r\n                                                  </TouchableOpacity>\r\n                                                );\r\n                                              });\r\n                                            }\r\n\r\n                                            return <Text style={dashboardEmptyTextStyle}>Inget att visa.</Text>;\r\n                                          })()\r\n                                        )}\r\n                                      </ScrollView>\r\n                                    </View>\r\n                                  </View>\r\n                                ) : null}\r\n                              </View>\r\n                            </View>\r\n                          </View>\r\n                          </View>\r\n                        </View>\r\n                      )}\r\n                    </ScrollView>\r\n                    <TouchableOpacity\r\n                      onPress={() => scrollToEndSafe(rightPaneScrollRef)}\r\n                      activeOpacity={0.85}\r\n                      style={{\r\n                        position: 'absolute',\r\n                        right: 10,\r\n                        bottom: 10,\r\n                        zIndex: 20,\r\n                        backgroundColor: '#fff',\r\n                        borderRadius: 16,\r\n                        borderWidth: 1,\r\n                        borderColor: '#e0e0e0',\r\n                        padding: 6,\r\n                      }}\r\n                    >\r\n                      <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n                    </TouchableOpacity>\r\n                  </View>\r\n\r\n                  {/* Persistent right side: activity */}\r\n                  <View\r\n                    style={{\r\n                      width: 420,\r\n                      minWidth: 340,\r\n                      maxWidth: 520,\r\n                      padding: 18,\r\n                      borderLeftWidth: 1,\r\n                      borderLeftColor: '#e6e6e6',\r\n                      backgroundColor: '#F7FAFC',\r\n                    }}\r\n                  >\r\n                    <ScrollView ref={activityScrollRef} style={{ flex: 1 }} contentContainerStyle={{ paddingBottom: 24 }}>\r\n                      <ActivityPanel />\r\n                    </ScrollView>\r\n                    <TouchableOpacity\r\n                      onPress={() => scrollToEndSafe(activityScrollRef)}\r\n                      activeOpacity={0.85}\r\n                      style={{\r\n                        position: 'absolute',\r\n                        right: 10,\r\n                        bottom: 10,\r\n                        zIndex: 20,\r\n                        backgroundColor: '#fff',\r\n                        borderRadius: 16,\r\n                        borderWidth: 1,\r\n                        borderColor: '#e0e0e0',\r\n                        padding: 6,\r\n                      }}\r\n                    >\r\n                      <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n                    </TouchableOpacity>\r\n                  </View>\r\n                </View>\r\n              ) : (\r\n                <ScrollView ref={rightPaneScrollRef} style={{ flex: 1 }} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\r\n                  {selectedProject ? (\r\n                    <View style={{ flex: 1 }}>\r\n                      <ProjectDetails route={{ params: { project: selectedProject, companyId, selectedAction: projectSelectedAction, onInlineLockChange: handleInlineLockChange } }} navigation={navigation} inlineClose={closeSelectedProject} refreshNonce={projectControlsRefreshNonce} />\r\n                    </View>\r\n                  ) : (\r\n                    <View style={{ flex: 1, padding: 18 }}>\r\n                      <View style={dashboardContainerStyle}>\r\n                        <View style={dashboardColumnsStyle}>\r\n                          <View style={{ flex: 1, minWidth: 360, marginRight: 16 }}>\r\n                            <Text style={dashboardSectionTitleStyle}>Senaste projekten</Text>\r\n                            <View style={dashboardCardStyle}>\r\n                              {dashboardLoading ? (\r\n                                <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\r\n                              ) : (dashboardRecentProjects || []).length === 0 ? (\r\n                                <Text style={dashboardEmptyTextStyle}>Inga senaste projekt ännu.</Text>\r\n                              ) : (\r\n                                (dashboardRecentProjects || []).map((entry, idx) => (\r\n                                  <TouchableOpacity\r\n                                    key={`${entry.projectId}-${idx}`}\r\n                                    activeOpacity={0.85}\r\n                                    onPress={() => {\r\n                                      if (entry?.project) {\r\n                                        requestProjectSwitch(entry.project, { selectedAction: null });\r\n                                      }\r\n                                    }}\r\n                                    style={dashboardListItemStyle(idx)}\r\n                                  >\r\n                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>\r\n                                      {entry.project.id} — {entry.project.name}\r\n                                    </Text>\r\n                                    <Text style={dashboardMetaTextStyle}>\r\n                                      Senast aktivitet: {formatRelativeTime(entry.ts)}\r\n                                    </Text>\r\n                                  </TouchableOpacity>\r\n                                ))\r\n                              )}\r\n                            </View>\r\n\r\n                            {dashboardFocus ? (\r\n                              <View style={{ marginTop: 16 }}>\r\n                                <Text style={dashboardSectionTitleStyle}>\r\n                                  {dashboardFocus === 'activeProjects'\r\n                                    ? 'Pågående projekt'\r\n                                    : dashboardFocus === 'controlsToSign'\r\n                                      ? 'Kontroller att signera'\r\n                                      : dashboardFocus === 'drafts'\r\n                                        ? 'Sparade utkast'\r\n                                        : dashboardFocus === 'openDeviations'\r\n                                          ? 'Öppna avvikelser'\r\n                                          : dashboardFocus === 'upcomingSkyddsrond'\r\n                                            ? 'Kommande skyddsronder'\r\n                                            : 'Lista'}\r\n                                </Text>\r\n                                <View style={dashboardCardStyle}>\r\n                                  {dashboardLoading ? (\r\n                                    <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\r\n                                  ) : (\r\n                                    (() => {\r\n                                      const focus = dashboardFocus;\r\n\r\n                                      if (focus === 'activeProjects') {\r\n                                        const items = Array.isArray(dashboardActiveProjectsList) ? dashboardActiveProjectsList : [];\r\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga pågående projekt.</Text>;\r\n                                        return items.map((p, idx) => (\r\n                                          <TouchableOpacity\r\n                                            key={`${p.id}-${idx}`}\r\n                                            activeOpacity={0.85}\r\n                                            onPress={() => requestProjectSwitch(p, { selectedAction: null })}\r\n                                            style={dashboardListItemStyle(idx)}\r\n                                          >\r\n                                            <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\r\n                                          </TouchableOpacity>\r\n                                        ));\r\n                                      }\r\n\r\n                                      if (focus === 'drafts' || focus === 'controlsToSign') {\r\n                                        const items = focus === 'controlsToSign'\r\n                                          ? (Array.isArray(dashboardControlsToSignItems) ? dashboardControlsToSignItems : [])\r\n                                          : (Array.isArray(dashboardDraftItems) ? dashboardDraftItems : []);\r\n\r\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga utkast.</Text>;\r\n                                        return items.map((d, idx) => {\r\n                                          const pid = d?.project?.id || d?.projectId || d?.project || null;\r\n                                          const projectId = pid ? String(pid) : '';\r\n                                          const projObj = projectId ? findProjectById(projectId) : null;\r\n                                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\r\n                                          const ts = d?.savedAt || d?.updatedAt || d?.createdAt || d?.date || null;\r\n                                          const type = String(d?.type || 'Utkast');\r\n                                          return (\r\n                                            <TouchableOpacity\r\n                                              key={`${projectId}-${type}-${idx}`}\r\n                                              activeOpacity={0.85}\r\n                                              onPress={() => {\r\n                                                if (!projObj) return;\r\n                                                requestProjectSwitch(projObj, {\r\n                                                  selectedAction: {\r\n                                                    id: `openDraft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,\r\n                                                    kind: 'openDraft',\r\n                                                    type,\r\n                                                    initialValues: d,\r\n                                                  },\r\n                                                  clearActionAfter: true,\r\n                                                });\r\n                                              }}\r\n                                              style={dashboardListItemStyle(idx)}\r\n                                            >\r\n                                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\r\n                                              <Text style={dashboardMetaTextStyle}>{type}{ts ? ` • Sparat: ${formatRelativeTime(ts)}` : ''}</Text>\r\n                                            </TouchableOpacity>\r\n                                          );\r\n                                        });\r\n                                      }\r\n\r\n                                      if (focus === 'openDeviations') {\r\n                                        const items = Array.isArray(dashboardOpenDeviationItems) ? dashboardOpenDeviationItems : [];\r\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga öppna avvikelser.</Text>;\r\n                                        return items.map((entry, idx) => {\r\n                                          const c = entry?.control;\r\n                                          const pid = c?.project?.id || c?.projectId || c?.project || null;\r\n                                          const projectId = pid ? String(pid) : '';\r\n                                          const projObj = projectId ? findProjectById(projectId) : null;\r\n                                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\r\n                                          const openCount = entry?.openCount || 0;\r\n                                          return (\r\n                                            <TouchableOpacity\r\n                                              key={`${projectId}-${c?.id || idx}`}\r\n                                              activeOpacity={0.85}\r\n                                              onPress={() => {\r\n                                                if (!projObj || !c) return;\r\n                                                requestProjectSwitch(projObj, {\r\n                                                  selectedAction: {\r\n                                                    id: `openControl-${c?.id || Date.now()}`,\r\n                                                    kind: 'openControlDetails',\r\n                                                    control: c,\r\n                                                  },\r\n                                                  clearActionAfter: true,\r\n                                                });\r\n                                              }}\r\n                                              style={dashboardListItemStyle(idx)}\r\n                                            >\r\n                                              <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\r\n                                                <View style={[dashboardStatDotStyle('#FFD600'), { marginTop: 4 }]} />\r\n                                                <View style={{ flex: 1, minWidth: 0 }}>\r\n                                                  <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\r\n                                                  <Text style={dashboardMetaTextStyle}>Skyddsrond • Öppna avvikelser: {String(openCount)}</Text>\r\n                                                </View>\r\n                                              </View>\r\n                                            </TouchableOpacity>\r\n                                          );\r\n                                        });\r\n                                      }\r\n\r\n                                      if (focus === 'upcomingSkyddsrond') {\r\n                                        const items = Array.isArray(dashboardUpcomingSkyddsrondItems) ? dashboardUpcomingSkyddsrondItems : [];\r\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga kommande skyddsronder.</Text>;\r\n                                        return items.map((entry, idx) => {\r\n                                          const p = entry?.project;\r\n                                          const dueMs = Number(entry?.nextDueMs || 0);\r\n                                          const dueLabel = dueMs ? new Date(dueMs).toLocaleDateString('sv-SE') : '';\r\n                                          const state = entry?.state === 'overdue' ? 'Försenad' : 'Snart';\r\n                                          return (\r\n                                            <TouchableOpacity\r\n                                              key={`${p?.id || 'proj'}-${idx}`}\r\n                                              activeOpacity={0.85}\r\n                                              onPress={() => { if (p) requestProjectSwitch(p, { selectedAction: null }); }}\r\n                                              style={dashboardListItemStyle(idx)}\r\n                                            >\r\n                                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p?.id} — {p?.name}</Text>\r\n                                              <Text style={dashboardMetaTextStyle}>{state}{dueLabel ? ` • Nästa: ${dueLabel}` : ''}</Text>\r\n                                            </TouchableOpacity>\r\n                                          );\r\n                                        });\r\n                                      }\r\n\r\n                                      return <Text style={dashboardEmptyTextStyle}>Inget att visa.</Text>;\r\n                                    })()\r\n                                  )}\r\n                                </View>\r\n                              </View>\r\n                            ) : null}\r\n                          </View>\r\n                          <View style={{ width: 320, minWidth: 280 }}>\r\n                            <Text style={dashboardSectionTitleStyle}>Översikt</Text>\r\n                            <View style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}>\r\n                              {[\r\n                                { key: 'activeProjects', label: 'Pågående projekt', color: '#43A047', value: dashboardOverview.activeProjects, focus: 'activeProjects', onPress: () => { setProjectStatusFilter('ongoing'); toggleDashboardFocus('activeProjects'); } },\r\n                                { key: 'controlsToSign', label: 'Kontroller att signera', color: '#D32F2F', value: dashboardOverview.controlsToSign, focus: 'controlsToSign', onPress: () => toggleDashboardFocus('controlsToSign') },\r\n                                { key: 'drafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts', onPress: () => toggleDashboardFocus('drafts') },\r\n                              ].map((row, ridx) => {\r\n                                const isWeb = Platform.OS === 'web';\r\n                                const isHovered = isWeb && dashboardHoveredStatKey === row.key;\r\n                                const isOpen = !isWeb && dashboardFocus === row.focus;\r\n                                return (\r\n                                  <TouchableOpacity\r\n                                    key={row.key}\r\n                                    style={{\r\n                                      ...dashboardStatRowStyle(ridx),\r\n                                      paddingHorizontal: 6,\r\n                                      borderRadius: 8,\r\n                                      borderWidth: 1,\r\n                                      borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                      backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                      cursor: isWeb ? 'pointer' : undefined,\r\n                                      transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\r\n                                    }}\r\n                                    activeOpacity={0.75}\r\n                                    onPress={row.onPress}\r\n                                    onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\r\n                                    onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\r\n                                  >\r\n                                    {!isWeb ? <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} /> : null}\r\n                                    <View style={dashboardStatDotStyle(row.color)} />\r\n                                    <Text style={dashboardStatLabelStyle}>{row.label}</Text>\r\n                                    <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\r\n                                  </TouchableOpacity>\r\n                                );\r\n                              })}\r\n                            </View>\r\n\r\n                            <Text style={dashboardSectionTitleStyle}>Påminnelser</Text>\r\n                            <View style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}>\r\n                              {[\r\n                                {\r\n                                  key: 'remindersSkyddsrondUpcoming',\r\n                                  label: 'Kommande skyddsronder',\r\n                                  color: '#FFD600',\r\n                                  value: (dashboardOverview.skyddsrondDueSoon ?? 0) + (dashboardOverview.skyddsrondOverdue ?? 0),\r\n                                  focus: 'upcomingSkyddsrond',\r\n                                  onPress: () => toggleDashboardFocus('upcomingSkyddsrond'),\r\n                                },\r\n                                { key: 'remindersOpenDeviations', label: 'Öppna avvikelser', color: '#FFD600', value: dashboardOverview.openDeviations, focus: 'openDeviations', onPress: () => toggleDashboardFocus('openDeviations') },\r\n                                { key: 'remindersDrafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts', onPress: () => toggleDashboardFocus('drafts') },\r\n                              ].map((row, ridx) => {\r\n                                const isWeb = Platform.OS === 'web';\r\n                                const isHovered = isWeb && dashboardHoveredStatKey === row.key;\r\n                                const isOpen = !isWeb && dashboardFocus === row.focus;\r\n                                return (\r\n                                  <TouchableOpacity\r\n                                    key={row.key}\r\n                                    style={{\r\n                                      ...dashboardStatRowStyle(ridx),\r\n                                      paddingHorizontal: 6,\r\n                                      borderRadius: 8,\r\n                                      borderWidth: 1,\r\n                                      borderColor: isHovered ? '#1976D2' : 'transparent',\r\n                                      backgroundColor: isHovered ? '#eee' : 'transparent',\r\n                                      cursor: isWeb ? 'pointer' : undefined,\r\n                                      transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\r\n                                    }}\r\n                                    activeOpacity={0.75}\r\n                                    onPress={row.onPress}\r\n                                    onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\r\n                                    onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\r\n                                  >\r\n                                    {!isWeb ? <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} /> : null}\r\n                                    <View style={dashboardStatDotStyle(row.color)} />\r\n                                    <Text style={dashboardStatLabelStyle}>{row.label}</Text>\r\n                                    <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\r\n                                  </TouchableOpacity>\r\n                                );\r\n                              })}\r\n                            </View>\r\n                          </View>\r\n                          <View style={{ width: 420, minWidth: 320 }}>\r\n                            <ActivityPanel />\r\n                          </View>\r\n                        </View>\r\n                      </View>\r\n                    </View>\r\n                  )}\r\n                </ScrollView>\r\n              )}\r\n            </View>\r\n          </View>\r\n        ) : null}\r\n          {/* Skapa kontroll-knapp och popup för val av kontrolltyp */}\r\n          <View style={Platform.OS === 'web' ? { marginTop: 18, marginBottom: 16, alignItems: 'flex-start', paddingHorizontal: 16 } : { marginTop: 18, marginBottom: 16, alignItems: 'center', justifyContent: 'center' }}>\r\n            <Text style={Platform.OS === 'web' ? { fontSize: 18, fontWeight: '600', textAlign: 'left', marginBottom: 12, color: '#263238', letterSpacing: 0.2 } : { fontSize: 18, fontWeight: '600', textAlign: 'center', marginBottom: 8, color: '#263238', letterSpacing: 0.2 }}>\r\n              Skapa kontroll:\r\n            </Text>\r\n            {Platform.OS === 'web' ? (\r\n              <>\r\n                <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '100%', marginBottom: 12 }} />\r\n                <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>\r\n                  {controlTypeOptions.map(({ type, icon, color }) => (\r\n                    <TouchableOpacity\r\n                      key={type}\r\n                      style={{\r\n                        flexDirection: 'row',\r\n                        alignItems: 'center',\r\n                        backgroundColor: '#fff',\r\n                        borderRadius: 12,\r\n                        borderWidth: 1,\r\n                        borderColor: '#e0e0e0',\r\n                        paddingVertical: 10,\r\n                        paddingHorizontal: 14,\r\n                        marginRight: 10,\r\n                        marginBottom: 10,\r\n                        shadowColor: '#000',\r\n                        shadowOffset: { width: 0, height: 2 },\r\n                        shadowOpacity: 0.06,\r\n                        shadowRadius: 4,\r\n                        elevation: 2,\r\n                        cursor: 'pointer'\r\n                      }}\r\n                      onPress={() => {\r\n                        setSelectProjectModal({ visible: true, type });\r\n                        setShowControlTypeModal(false);\r\n                      }}\r\n                      activeOpacity={0.85}\r\n                    >\r\n                      <Ionicons name={icon} size={18} color={color} style={{ marginRight: 10 }} />\r\n                      <Text style={{ color: '#222', fontWeight: '600', fontSize: 15 }}>{type}</Text>\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                </View>\r\n              </>\r\n            ) : (\r\n              <>\r\n                <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '80%', marginBottom: 18 }} />\r\n                <TouchableOpacity\r\n                  style={{\r\n                    backgroundColor: '#fff',\r\n                    borderRadius: 16,\r\n                    borderWidth: 1,\r\n                    borderColor: '#222',\r\n                    paddingVertical: 14,\r\n                    paddingHorizontal: 32,\r\n                    alignItems: 'center',\r\n                    flexDirection: 'row',\r\n                    justifyContent: 'center',\r\n                    shadowColor: '#1976D2',\r\n                    shadowOffset: { width: 0, height: 4 },\r\n                    shadowOpacity: 0.10,\r\n                    shadowRadius: 6,\r\n                    elevation: 2,\r\n                    minHeight: 56,\r\n                    maxWidth: 240,\r\n                    width: '90%',\r\n                    marginBottom: 16,\r\n                    overflow: 'hidden',\r\n                  }}\r\n                  activeOpacity={0.85}\r\n                  onPress={() => setShowControlTypeModal(true)}\r\n                >\r\n                  <Ionicons name=\"add-circle-outline\" size={26} color=\"#222\" style={{ marginRight: 16 }} />\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 17, letterSpacing: 0.5, zIndex: 1 }}>Ny kontroll</Text>\r\n                </TouchableOpacity>\r\n              </>\r\n            )}\r\n          \r\n            {/* Modal för val av kontrolltyp */}\r\n            {/* Modal för val av kontrolltyp */}\r\n            <Modal\r\n              visible={showControlTypeModal}\r\n              transparent\r\n              animationType=\"fade\"\r\n              onRequestClose={() => setShowControlTypeModal(false)}\r\n            >\r\n              <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                  <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 18, color: '#222', textAlign: 'center', marginTop: 6 }}>\r\n                    Välj kontrolltyp\r\n                  </Text>\r\n                  {controlTypeOptions.map(({ type, icon, color }) => (\r\n                    <TouchableOpacity\r\n                      key={type}\r\n                      style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 10, paddingVertical: 12, paddingHorizontal: 14, marginBottom: 10, borderWidth: 1, borderColor: '#e0e0e0' }}\r\n                      onPress={() => {\r\n                        setSelectProjectModal({ visible: true, type });\r\n                        setShowControlTypeModal(false);\r\n                      }}\r\n                    >\r\n                      <Ionicons name={icon} size={22} color={color} style={{ marginRight: 12 }} />\r\n                      <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>{type}</Text>\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                  {Array.isArray(companyProfile?.enabledControlTypes) && controlTypeOptions.length === 0 ? (\r\n                    <Text style={{ color: '#D32F2F', textAlign: 'center', marginTop: 6, marginBottom: 8 }}>\r\n                      Inga kontrolltyper är aktiverade för företaget.\r\n                    </Text>\r\n                  ) : null}\r\n                  <TouchableOpacity\r\n                    style={{ marginTop: 8, alignSelf: 'center' }}\r\n                    onPress={() => setShowControlTypeModal(false)}\r\n                  >\r\n                    <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            </Modal>\r\n            {/* Modal för att välja projekt till kontroll */}\r\n            {/* Välj projekt-modal med exakt samma struktur och stil som projektlistan */}\r\n            {(() => {\r\n              const [expandedMain, setExpandedMain] = React.useState([]);\r\n              const [expandedSub, setExpandedSub] = React.useState([]);\r\n              const [quickAddModal, setQuickAddModal] = React.useState({ visible: false, parentSubId: null });\r\n              const [quickAddName, setQuickAddName] = React.useState(\"\");\r\n              const [quickAddNumber, setQuickAddNumber] = React.useState(\"\");\r\n              const [showProjectCreated, setShowProjectCreated] = React.useState(false);\r\n              // Endast en huvudmapp expanderad åt gången\r\n              const isMainExpanded = id => expandedMain[0] === id;\r\n              const isSubExpanded = id => expandedSub.includes(id);\r\n              const toggleMain = id => setExpandedMain(exp => exp[0] === id ? [] : [id]);\r\n              const toggleSub = id => setExpandedSub(exp => exp.includes(id) ? exp.filter(e => e !== id) : [...exp, id]);\r\n              // Stäng alla huvudmappar när modal öppnas\r\n              React.useEffect(() => {\r\n                if (selectProjectModal.visible) setExpandedMain([]);\r\n              }, [selectProjectModal.visible]);\r\n              return (\r\n                <Modal\r\n                  visible={selectProjectModal.visible}\r\n                  transparent\r\n                  animationType=\"fade\"\r\n                  onRequestClose={() => setSelectProjectModal({ visible: false, type: null })}\r\n                >\r\n                  <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n                    <Pressable\r\n                      style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                      onPress={() => setSelectProjectModal({ visible: false, type: null })}\r\n                    />\r\n                    <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 360, maxHeight: 540 }}>\r\n                      {selectProjectModal.type && (\r\n                        <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 6, color: '#222', textAlign: 'center' }}>\r\n                          {selectProjectModal.type}\r\n                        </Text>\r\n                      )}\r\n                      <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222', textAlign: 'center' }}>Välj projekt</Text>\r\n                      <View style={{ position: 'relative', marginBottom: 14 }}>\r\n                        <TextInput\r\n                          value={searchText}\r\n                          onChangeText={setSearchText}\r\n                          placeholder=\"Sök projektnamn eller nummer...\"\r\n                          style={{\r\n                            borderWidth: 1,\r\n                            borderColor: '#222',\r\n                            borderRadius: 16,\r\n                            padding: 10,\r\n                            fontSize: 16,\r\n                            backgroundColor: '#fff',\r\n                            color: '#222',\r\n                            paddingRight: 38 // plats för knappen\r\n                          }}\r\n                          autoCorrect={false}\r\n                          autoCapitalize=\"none\"\r\n                        />\r\n                        {/* Autocomplete-lista */}\r\n                        {searchText.trim().length > 0 && (\r\n                          <View style={{ position: 'absolute', top: 44, left: 0, right: 0, backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#e0e0e0', zIndex: 10, maxHeight: 180 }}>\r\n                            <ScrollView keyboardShouldPersistTaps=\"handled\">\r\n                              {hierarchy.flatMap(main =>\r\n                                main.children.flatMap(sub =>\r\n                                  (sub.children || [])\r\n                                    .filter(child => child.type === 'project' &&\r\n                                      (\r\n                                        child.id.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                                        child.name.toLowerCase().includes(searchText.toLowerCase())\r\n                                      )\r\n                                    )\r\n                                    .map(proj => (\r\n                                      <TouchableOpacity\r\n                                        key={proj.id}\r\n                                        style={{ padding: 10, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\r\n                                        onPress={() => {\r\n                                          setSelectProjectModal({ visible: false, type: null });\r\n                                          // Route each control type to its dedicated screen\r\n                                          switch (selectProjectModal.type) {\r\n                                            case 'Arbetsberedning':\r\n                                              navigation.navigate('ArbetsberedningScreen', { project: proj });\r\n                                              break;\r\n                                            case 'Riskbedömning':\r\n                                              navigation.navigate('RiskbedömningScreen', { project: proj });\r\n                                              break;\r\n                                            case 'Fuktmätning':\r\n                                              navigation.navigate('FuktmätningScreen', { project: proj });\r\n                                              break;\r\n                                            case 'Egenkontroll':\r\n                                              navigation.navigate('EgenkontrollScreen', { project: proj });\r\n                                              break;\r\n                                            case 'Mottagningskontroll':\r\n                                              navigation.navigate('MottagningskontrollScreen', { project: proj });\r\n                                              break;\r\n                                            case 'Skyddsrond':\r\n                                              navigation.navigate('SkyddsrondScreen', { project: proj });\r\n                                              break;\r\n                                            default:\r\n                                              navigation.navigate('ControlForm', {\r\n                                                project: proj,\r\n                                                controlType: selectProjectModal.type\r\n                                              });\r\n                                          }\r\n                                        }}\r\n                                      >\r\n                                        <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                        <Text style={{ fontSize: 14, color: '#1976D2', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\r\n                                      </TouchableOpacity>\r\n                                    ))\r\n                                )\r\n                              )}\r\n                            </ScrollView>\r\n                          </View>\r\n                        )}\r\n                      </View>\r\n                      <ScrollView style={{ maxHeight: 370 }}>\r\n                        {[...hierarchy]\r\n                          .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                          .filter(main =>\r\n                            main.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                            main.children.some(sub =>\r\n                              sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                              (sub.children || []).some(child =>\r\n                                child.type === 'project' &&\r\n                                (\r\n                                  child.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                                  child.id.toLowerCase().includes(searchText.toLowerCase())\r\n                                )\r\n                              )\r\n                            )\r\n                          )\r\n                          .map(main => (\r\n                            <View key={main.id} style={{ backgroundColor: '#fff', borderRadius: 16, marginBottom: 3, padding: 6, shadowColor: '#1976D2', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2 }}>\r\n                              <TouchableOpacity\r\n                                style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\r\n                                onPress={() => toggleMain(main.id)}\r\n                                activeOpacity={0.7}\r\n                              >\r\n                                <Ionicons name={isMainExpanded(main.id) ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\r\n                                <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginLeft: 8 }}>{main.name}</Text>\r\n                              </TouchableOpacity>\r\n                              {isMainExpanded(main.id) && (\r\n                                !main.children || main.children.length === 0 ? (\r\n                                  <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\r\n                                    Inga undermappar skapade\r\n                                  </Text>\r\n                                ) : (\r\n                                  [...main.children]\r\n                                    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                                    .filter(sub =>\r\n                                      sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                                      (sub.children || []).some(child =>\r\n                                        child.type === 'project' &&\r\n                                        (\r\n                                          child.name.toLowerCase().includes(searchText.toLowerCase()) ||\r\n                                          child.id.toLowerCase().includes(searchText.toLowerCase())\r\n                                        )\r\n                                      )\r\n                                    )\r\n                                    .map(sub => {\r\n                                  const projects = sub.children ? sub.children.filter(child => child.type === 'project') : [];\r\n                                  return (\r\n                                    <View key={sub.id} style={{ backgroundColor: '#F3F3F3', borderRadius: 12, marginVertical: 1, marginLeft: 12, padding: 5, borderLeftWidth: 3, borderLeftColor: '#bbb' }}>\r\n                                      <TouchableOpacity\r\n                                        style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\r\n                                        onPress={() => toggleSub(sub.id)}\r\n                                        activeOpacity={0.7}\r\n                                      >\r\n                                        <Ionicons name={isSubExpanded(sub.id) ? 'chevron-down' : 'chevron-forward'} size={18} color=\"#222\" />\r\n                                        <Text style={{ fontSize: 15, fontWeight: '600', color: '#222', marginLeft: 8 }}>{sub.name}</Text>\r\n                                      </TouchableOpacity>\r\n                                      {isSubExpanded(sub.id) && (\r\n                                        projects.length === 0 ? (\r\n                                          <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\r\n                                            Inga projekt skapade\r\n                                          </Text>\r\n                                        ) : (\r\n                                          projects\r\n                                            .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                                            .map((proj) => (\r\n                                              <TouchableOpacity\r\n                                                key={proj.id}\r\n                                                style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 3, marginLeft: 14, backgroundColor: '#e3f2fd', borderRadius: 8, marginVertical: 2, paddingHorizontal: 6 }}\r\n                                                onPress={() => {\r\n                                                  if (Platform.OS === 'web') {\r\n                                                    setSelectedProject({ ...proj });\r\n                                                  } else {\r\n                                                    navigation.navigate('ProjectDetails', {\r\n                                                      project: {\r\n                                                        id: proj.id,\r\n                                                        name: proj.name,\r\n                                                        ansvarig: proj.ansvarig || '',\r\n                                                        adress: proj.adress || '',\r\n                                                        fastighetsbeteckning: proj.fastighetsbeteckning || '',\r\n                                                        client: proj.client || '',\r\n                                                        status: proj.status || 'ongoing',\r\n                                                        createdAt: proj.createdAt || '',\r\n                                                        createdBy: proj.createdBy || ''\r\n                                                      },\r\n                                                      companyId\r\n                                                    });\r\n                                                  }\r\n                                                }}\r\n                                              >\r\n                                                <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                                <Text style={{ fontSize: 14, color: '#1976D2', marginLeft: 4, marginRight: 8, flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} — {proj.name}</Text>\r\n                                              </TouchableOpacity>\r\n                                            ))\r\n                                        )\r\n                                      )}\r\n                                    </View>\r\n                                  );\r\n                                    })\r\n                                )\r\n                              )}\r\n                            </View>\r\n                          ))}\r\n                      </ScrollView>\r\n                      <TouchableOpacity\r\n                        style={{ marginTop: 16, alignSelf: 'center' }}\r\n                        onPress={() => setSelectProjectModal({ visible: false, type: null })}\r\n                      >\r\n                        <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                </Modal>\r\n              );\r\n            })()}\r\n            {/* Utförda kontroller header removed from main screen; it's shown inside project details only */}\r\n          </View>\r\n          {/* Projektträd */}\r\n          {/* Rubrik och sök-knapp */}\r\n          <View style={{ width: '100%', alignItems: 'center', marginTop: 18 }}>\r\n            <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '80%', marginBottom: 12 }} />\r\n          </View>\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16, paddingHorizontal: 16 }}>\r\n            <TouchableOpacity\r\n              activeOpacity={0.7}\r\n              onPressIn={() => {\r\n                if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\r\n                projektLongPressTimer.current = setTimeout(() => {\r\n                  setNewFolderModalVisible(true);\r\n                }, 2000);\r\n              }}\r\n              onPressOut={() => {\r\n                if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\r\n              }}\r\n            >\r\n              <Text style={{ fontSize: 26, fontWeight: '600', color: '#263238', letterSpacing: 0.2, textAlign: 'center' }}>Projekt</Text>\r\n            </TouchableOpacity>\r\n            {Platform.OS !== 'web' && (\r\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                <TouchableOpacity\r\n                  style={{ padding: 6, borderRadius: 8 }}\r\n                  onPress={() => setFilterModalVisible(true)}\r\n                  activeOpacity={0.7}\r\n                >\r\n                  <View style={{ position: 'relative' }}>\r\n                    <Ionicons name=\"filter\" size={22} color=\"#1976D2\" />\r\n                    {projectStatusFilter !== 'all' && (\r\n                      <View\r\n                        style={{\r\n                          position: 'absolute',\r\n                          right: -1,\r\n                          top: -1,\r\n                          width: 10,\r\n                          height: 10,\r\n                          borderRadius: 5,\r\n                          backgroundColor: projectStatusFilter === 'completed' ? '#222' : '#43A047',\r\n                          borderWidth: 1,\r\n                          borderColor: '#fff',\r\n                        }}\r\n                      />\r\n                    )}\r\n                  </View>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity\r\n                  style={{ padding: 6, borderRadius: 8, marginLeft: 10 }}\r\n                  onPress={openSearchModal}\r\n                  activeOpacity={0.7}\r\n                >\r\n                  <Ionicons name=\"search\" size={22} color=\"#1976D2\" />\r\n                </TouchableOpacity>\r\n              </View>\r\n            )}\r\n          </View>\r\n          {/* Ny huvudmapp popup modal */}\r\n          <Modal\r\n            visible={newFolderModalVisible}\r\n            transparent\r\n            animationType=\"fade\"\r\n            onRequestClose={() => setNewFolderModalVisible(false)}\r\n          >\r\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n              <Pressable\r\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n                onPress={() => setNewFolderModalVisible(false)}\r\n              />\r\n              <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Skapa ny huvudmapp</Text>\r\n                <TextInput\r\n                  placeholder=\"Namn på huvudmapp...\"\r\n                  style={{\r\n                    borderWidth: 1,\r\n                    borderColor:\r\n                      newFolderModalVisible && (newSubName.trim() === '' || !isFolderNameUnique(newSubName))\r\n                        ? '#D32F2F'\r\n                        : '#e0e0e0',\r\n                    borderRadius: 8,\r\n                    padding: 10,\r\n                    fontSize: 16,\r\n                    marginBottom: 6\r\n                  }}\r\n                  autoFocus\r\n                  value={newSubName}\r\n                  onChangeText={setNewSubName}\r\n                />\r\n                {(newFolderModalVisible && newSubName.trim() === '') && (\r\n                  <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\r\n                    Du måste ange ett namn.\r\n                  </Text>\r\n                )}\r\n                {(newFolderModalVisible && newSubName.trim() !== '' && !isFolderNameUnique(newSubName)) && (\r\n                  <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\r\n                    Namnet används redan.\r\n                  </Text>\r\n                )}\r\n                <TouchableOpacity\r\n                  style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 10, alignItems: 'center', marginBottom: 8 }}\r\n                  onPress={async () => {\r\n                    if (newSubName.trim() === '' || !isFolderNameUnique(newSubName)) return;\r\n                    const newMain = {\r\n                      id: (Math.random() * 100000).toFixed(0),\r\n                      name: newSubName.trim(),\r\n                      expanded: false,\r\n                      children: [],\r\n                    };\r\n                    const newHierarchy = [...hierarchy, newMain];\r\n                    setHierarchy(newHierarchy);\r\n                    setNewSubName('');\r\n                    setNewFolderModalVisible(false);\r\n                    try {\r\n                      const ok = await saveHierarchy(companyId, newHierarchy);\r\n                      if (!ok) {\r\n                          await AsyncStorage.setItem('hierarchy_local', JSON.stringify(newHierarchy));\r\n                          setLocalFallbackExists(true);\r\n                          Alert.alert('Offline', 'Huvudmappen sparades lokalt. Appen kommer försöka synka senare.');\r\n                        } else {\r\n                          try { await AsyncStorage.removeItem('hierarchy_local'); } catch(e) {}\r\n                          await refreshLocalFallbackFlag();\r\n                      }\r\n                    } catch(e) {\r\n                      try { await AsyncStorage.setItem('hierarchy_local', JSON.stringify(newHierarchy)); } catch(e) {}\r\n                      Alert.alert('Offline', 'Huvudmappen sparades lokalt. Appen kommer försöka synka senare.');\r\n                    }\r\n                  }}\r\n                  disabled={newSubName.trim() === '' || !isFolderNameUnique(newSubName)}\r\n                >\r\n                  <Text style={{ color: '#fff', fontWeight: '600', fontSize: 16, opacity: newSubName.trim() === '' || !isFolderNameUnique(newSubName) ? 0.5 : 1 }}>\r\n                    Skapa\r\n                  </Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity\r\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 10, alignItems: 'center' }}\r\n                  onPress={() => {\r\n                    setNewSubName('');\r\n                    setNewFolderModalVisible(false);\r\n                  }}\r\n                >\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n          {Platform.OS !== 'web' && (\r\n            <View style={{ flex: 1, paddingHorizontal: 4 }}>\r\n              {loadingHierarchy || hierarchy.length === 0 ? (\r\n                <Text style={{ color: '#888', fontSize: 16, textAlign: 'center', marginTop: 32 }}>\r\n                  Inga mappar eller projekt skapade ännu.\r\n                </Text>\r\n              ) : (\r\n                <View style={{ paddingHorizontal: 4 }}>\r\n                  {[...hierarchy]\r\n                    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                    .map((main) => (\r\n                      <View key={main.id} style={{ backgroundColor: '#fff', borderRadius: 16, marginBottom: 3, padding: 6, shadowColor: '#1976D2', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2 }}>\r\n                        <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 6, borderBottomWidth: main.expanded ? 1 : 0, borderColor: '#e0e0e0' }}>\r\n                          <TouchableOpacity\r\n                            style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\r\n                            onPress={() => setHierarchy(prev => prev.map(m => m.id === main.id ? { ...m, expanded: !m.expanded } : { ...m, expanded: false }))}\r\n                            activeOpacity={0.7}\r\n                            onLongPress={() => setEditModal({ visible: true, type: 'main', id: main.id, name: main.name })}\r\n                            delayLongPress={2000}\r\n                            onPressIn={() => {\r\n                              if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\r\n                              mainTimersRef.current[main.id] = setTimeout(() => {\r\n                                setEditModal({ visible: true, type: 'main', id: main.id, name: main.name });\r\n                              }, 2000);\r\n                            }}\r\n                            onPressOut={() => {\r\n                              if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\r\n                            }}\r\n                          >\r\n                            <Ionicons name={main.expanded ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\r\n                            <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginLeft: 8 }}>{main.name}</Text>\r\n                          </TouchableOpacity>\r\n                          {/* Visa endast om ingen undermapp är expanderad */}\r\n                          {main.expanded && !main.children?.some(sub => sub.expanded) && (\r\n                            <TouchableOpacity\r\n                              style={{ marginLeft: 8, padding: 4 }}\r\n                              onPress={() => {\r\n                                setNewSubModal({ visible: true, parentId: main.id });\r\n                                setNewSubName(\"\");\r\n                              }}\r\n                            >\r\n                              <Ionicons name=\"add-circle\" size={22} color=\"#1976D2\" />\r\n                            </TouchableOpacity>\r\n                          )}\r\n                        </View>\r\n                        {main.expanded && (\r\n                          !main.children || main.children.length === 0 ? (\r\n                            <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\r\n                              Inga undermappar skapade\r\n                            </Text>\r\n                          ) : (\r\n                            [...main.children]\r\n                              .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                              .map((sub) => {\r\n                                const allProjects = sub.children ? sub.children.filter(child => child.type === 'project') : [];\r\n                                const projects = projectStatusFilter === 'all'\r\n                                  ? allProjects\r\n                                  : allProjects.filter(p => {\r\n                                      const status = p?.status || 'ongoing';\r\n                                      return projectStatusFilter === 'completed' ? status === 'completed' : status !== 'completed';\r\n                                    });\r\n                                return (\r\n                                  <View key={sub.id} style={{ backgroundColor: '#F3F3F3', borderRadius: 12, marginVertical: 1, marginLeft: 12, padding: 5, borderLeftWidth: 3, borderLeftColor: '#bbb' }}>\r\n                                    <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 4 }}>\r\n                                      <TouchableOpacity\r\n                                        style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\r\n                                        onPress={() => setHierarchy(toggleExpand(1, sub.id))}\r\n                                        onLongPress={() => setEditModal({ visible: true, type: 'sub', id: sub.id, name: sub.name })}\r\n                                        delayLongPress={2000}\r\n                                        activeOpacity={0.7}\r\n                                      >\r\n                                        <Ionicons name={sub.expanded ? 'chevron-down' : 'chevron-forward'} size={18} color=\"#222\" />\r\n                                        <Text style={{ fontSize: 15, fontWeight: '600', color: '#222', marginLeft: 8 }}>{sub.name}</Text>\r\n                                      </TouchableOpacity>\r\n                                      {sub.expanded && (\r\n                                        <TouchableOpacity\r\n                                          style={{ padding: 4 }}\r\n                                          onPress={() => {\r\n                                            setNewProjectModal({ visible: true, parentSubId: sub.id });\r\n                                            setNewProjectName(\"\");\r\n                                            setNewProjectNumber(\"\");\r\n                                          }}\r\n                                        >\r\n                                          <Ionicons name=\"add-circle\" size={22} color=\"#1976D2\" />\r\n                                        </TouchableOpacity>\r\n                                      )}\r\n                                    </View>\r\n                                    {sub.expanded && (\r\n                                      <React.Fragment>\r\n                                        {projects.length === 0 ? (\r\n                                          <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\r\n                                            {allProjects.length === 0 ? 'Inga projekt skapade' : 'Inga projekt matchar filtret'}\r\n                                          </Text>\r\n                                        ) : (\r\n                                          projects\r\n                                            .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\r\n                                            .map((proj) => (\r\n                                              <TouchableOpacity\r\n                                                key={proj.id}\r\n                                                style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 3, marginLeft: 14, backgroundColor: '#e3f2fd', borderRadius: 8, marginVertical: 2, paddingHorizontal: 6 }}\r\n                                                onPress={() => {\r\n                                                  if (Platform.OS === 'web') {\r\n                                                    setSelectedProject({ ...proj });\r\n                                                  } else {\r\n                                                    navigation.navigate('ProjectDetails', {\r\n                                                      project: {\r\n                                                        id: proj.id,\r\n                                                        name: proj.name,\r\n                                                        ansvarig: proj.ansvarig || '',\r\n                                                        adress: proj.adress || '',\r\n                                                        fastighetsbeteckning: proj.fastighetsbeteckning || '',\r\n                                                        client: proj.client || '',\r\n                                                        status: proj.status || 'ongoing',\r\n                                                        createdAt: proj.createdAt || '',\r\n                                                        createdBy: proj.createdBy || ''\r\n                                                      },\r\n                                                      companyId\r\n                                                    });\r\n                                                  }\r\n                                                }}\r\n                                              >\r\n                                                <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\r\n                                                <Text style={{ fontSize: 15, color: '#1976D2', marginLeft: 4, marginRight: 8, flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} — {proj.name}</Text>\r\n                                              </TouchableOpacity>\r\n                                            ))\r\n                                        )}\r\n                                      </React.Fragment>\r\n                                    )}\r\n                                  </View>\r\n                                );\r\n                              })\r\n                          )\r\n                        )}\r\n                      </View>\r\n                    ))}\r\n                </View>\r\n              )}\r\n            </View>\r\n          )}\r\n                  {/* Ny huvudmapp popup modal */}\r\n                  {/* Ny undermapp popup modal */}\r\n      {/* Ny undermapp popup modal */}\r\n      <Modal\r\n        visible={newSubModal.visible}\r\n        transparent\r\n        animationType=\"fade\"\r\n        onRequestClose={() => setNewSubModal({ visible: false, parentId: null })}\r\n      >\r\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\r\n          <Pressable\r\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\r\n            onPress={() => setNewSubModal({ visible: false, parentId: null })}\r\n          />\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Skapa ny undermapp</Text>\r\n            <TextInput\r\n              value={newSubName}\r\n              onChangeText={setNewSubName}\r\n              placeholder=\"Namn på undermapp...\"\r\n              style={{\r\n                borderWidth: 1,\r\n                borderColor:\r\n                  newSubModal.visible && (newSubName.trim() === '' || (() => {\r\n                    // Check for duplicate name in selected main folder\r\n                    const parent = hierarchy.find(main => main.id === newSubModal.parentId);\r\n                    if (!parent) return false;\r\n                    return parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase());\r\n                  })())\r\n                    ? '#D32F2F'\r\n                    : '#e0e0e0',\r\n                borderRadius: 8,\r\n                padding: 10,\r\n                fontSize: 16,\r\n                marginBottom: 6\r\n              }}\r\n              autoFocus\r\n            />\r\n            {(newSubModal.visible && newSubName.trim() === '') && (\r\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\r\n                Du måste ange ett namn.\r\n              </Text>\r\n            )}\r\n            {(newSubModal.visible && newSubName.trim() !== '' && (() => {\r\n              const parent = hierarchy.find(main => main.id === newSubModal.parentId);\r\n              if (!parent) return false;\r\n              return parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase());\r\n            })()) && (\r\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\r\n                Namnet används redan.\r\n              </Text>\r\n            )}\r\n            {(() => {\r\n              const parent = hierarchy.find(main => main.id === newSubModal.parentId);\r\n              const isDuplicate = parent ? parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase()) : false;\r\n              const isDisabled = newSubName.trim() === '' || isDuplicate;\r\n              const opacity = isDisabled ? 0.5 : 1;\r\n              return (\r\n                <TouchableOpacity\r\n                  style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 10, alignItems: 'center', marginBottom: 8, opacity }}\r\n                  onPress={() => {\r\n                    if (!isDisabled) {\r\n                      setHierarchy(prev => prev.map(main => {\r\n                        if (main.id === newSubModal.parentId) {\r\n                          return {\r\n                            ...main,\r\n                            children: [\r\n                              ...(main.children || []),\r\n                              {\r\n                                id: (Math.random() * 100000).toFixed(0),\r\n                                name: newSubName.trim(),\r\n                                expanded: false,\r\n                                children: [],\r\n                              },\r\n                            ],\r\n                          };\r\n                        }\r\n                        return main;\r\n                      }));\r\n                      setNewSubName('');\r\n                      setNewSubModal({ visible: false, parentId: null });\r\n                    }\r\n                  }}\r\n                  disabled={isDisabled}\r\n                >\r\n                  <Text style={{ color: '#fff', fontWeight: '600', fontSize: 16 }}>\r\n                    Skapa\r\n                  </Text>\r\n                </TouchableOpacity>\r\n              );\r\n            })()}\r\n            <TouchableOpacity\r\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 10, alignItems: 'center' }}\r\n              onPress={() => {\r\n                setNewSubName('');\r\n                setNewSubModal({ visible: false, parentId: null });\r\n              }}\r\n            >\r\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n      </ScrollView>\r\n          </RootContainer>\r\n        );\r\n      })()}\r\n    </View>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\LoginScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":33,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEV_BYPASS'. Either include it or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [navigation, autoHandled, DEV_BYPASS]","fix":{"range":[2148,2173],"text":"[navigation, autoHandled, DEV_BYPASS]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":103,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":123,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":123,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":125,"column":11,"nodeType":"Identifier","messageId":"undef","endLine":125,"endColumn":14},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":126,"column":17,"nodeType":"Identifier","messageId":"undef","endLine":126,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":148,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":148,"endColumn":49}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useNavigation } from '@react-navigation/native';\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport { Image, ImageBackground, Keyboard, KeyboardAvoidingView, Platform, StyleSheet, Text, TextInput, TouchableOpacity, TouchableWithoutFeedback, View } from 'react-native';\r\nimport { auth, fetchUserProfile, signInEmailPassword } from '../components/firebase';\r\n\r\nexport default function LoginScreen() {\r\n  const navigation = useNavigation();\r\n  // Toggle this to `true` only for fast local development. Leave `false` for real login flow.\r\n  const DEV_BYPASS = false;\r\n  const [email, setEmail] = useState('');\r\n  const [password, setPassword] = useState('');\r\n  const [error, setError] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [autoHandled, setAutoHandled] = useState(false);\r\n  const isEmailValid = (val) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(val);\r\n  const isFormValid = isEmailValid(email.trim()) && password.length > 0;\r\n  const emailRef = useRef(null);\r\n  const passwordRef = useRef(null);\r\n  const [rememberMe, setRememberMe] = useState(false);\r\n\r\n  // Load saved email if user previously chose to be remembered\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const saved = await AsyncStorage.getItem('dk_saved_email');\r\n        if (saved) {\r\n          setEmail(saved);\r\n          setRememberMe(true);\r\n        }\r\n      } catch(e) {}\r\n    })();\r\n  }, []);\r\n\r\n  // Dev-only: bypass login to speed up testing\r\n  useEffect(() => {\r\n    if (DEV_BYPASS && __DEV__ && !autoHandled) {\r\n      (async () => {\r\n        try {\r\n          const storedCompanyId = await AsyncStorage.getItem('dk_companyId');\r\n          navigation.reset({\r\n            index: 0,\r\n            routes: [\r\n              {\r\n                name: 'Home',\r\n                params: { email: 'dev@test.local', companyId: storedCompanyId || null }\r\n              }\r\n            ]\r\n          });\r\n        } finally {\r\n          setAutoHandled(true);\r\n        }\r\n      })();\r\n    }\r\n  }, [navigation, autoHandled]);\r\n\r\n  // Auto-redirect if already signed in\r\n  useEffect(() => {\r\n    const unsub = auth.onAuthStateChanged(async (user) => {\r\n      if (user && !autoHandled) {\r\n        const t0 = Date.now();\r\n        try {\r\n          // Start profile fetch but navigate immediately for speed\r\n          const profilePromise = fetchUserProfile(user.uid).catch((e) => null);\r\n          navigation.reset({ index: 0, routes: [ { name: 'Home', params: { email: user.email || '' } } ] });\r\n          const profile = await profilePromise;\r\n          const companyId = profile?.companyId || null;\r\n          if (companyId) {\r\n            await AsyncStorage.setItem('dk_companyId', companyId);\r\n            // Update route params with companyId without adding a back entry\r\n            navigation.reset({ index: 0, routes: [ { name: 'Home', params: { email: user.email || '', companyId } } ] });\r\n          }\r\n          console.log('[Login] Auto redirect total ms:', Date.now() - t0);\r\n        } catch(e) {\r\n          console.log('[Login] Auto redirect error', e?.code || e?.message);\r\n        } finally {\r\n          setAutoHandled(true);\r\n        }\r\n      }\r\n    });\r\n    return () => unsub();\r\n  }, [navigation, autoHandled]);\r\n\r\n  const handleLogin = async () => {\r\n    const t0 = Date.now();\r\n    try {\r\n      setLoading(true);\r\n      const cred = await signInEmailPassword(email.trim(), password);\r\n      console.log('[Login] Auth ms:', Date.now() - t0);\r\n      setError('');\r\n      setAutoHandled(true); // Prevent onAuthStateChanged duplicate navigation\r\n      // Navigate immediately (without waiting for profile)\r\n      navigation.reset({ index: 0, routes: [ { name: 'Home', params: { email } } ] });\r\n      // Persist remembered email preference\r\n      try {\r\n        if (rememberMe) {\r\n          await AsyncStorage.setItem('dk_saved_email', email.trim());\r\n        } else {\r\n          await AsyncStorage.removeItem('dk_saved_email');\r\n        }\r\n      } catch(e) {}\r\n\r\n      // Refresh ID token to pick up any custom claims, then fetch and update companyId\r\n      try {\r\n        if (cred && cred.user) {\r\n          await auth.currentUser.getIdToken(true);\r\n        }\r\n      } catch(e) {\r\n        console.log('[Login] Token refresh failed', e?.message || e);\r\n      }\r\n      fetchUserProfile(cred.user.uid)\r\n        .then(async (profile) => {\r\n          const companyId = profile?.companyId || null;\r\n          if (companyId) {\r\n            await AsyncStorage.setItem('dk_companyId', companyId);\r\n            navigation.reset({ index: 0, routes: [ { name: 'Home', params: { email, companyId } } ] });\r\n          }\r\n          console.log('[Login] Profile async ms:', Date.now() - t0);\r\n        })\r\n        .catch((e) => console.log('[Login] Profile error', e?.code || e?.message));\r\n    } catch(e) {\r\n      let message = 'Fel e-post eller lösenord';\r\n      if (err?.code) {\r\n        switch (err.code) {\r\n          case 'auth/invalid-email':\r\n            message = 'Ogiltig e-postadress';\r\n            break;\r\n          case 'auth/user-not-found':\r\n            message = 'Användaren hittades inte';\r\n            break;\r\n          case 'auth/wrong-password':\r\n            message = 'Fel lösenord';\r\n            break;\r\n          case 'auth/too-many-requests':\r\n            message = 'För många försök, försök igen senare';\r\n            break;\r\n          case 'auth/network-request-failed':\r\n            message = 'Nätverksfel, kontrollera uppkopplingen';\r\n            break;\r\n          default:\r\n            message = 'Kunde inte logga in. Försök igen.';\r\n        }\r\n      }\r\n      setError(message);\r\n      // focus email field when login fails\r\n      try { emailRef.current?.focus(); } catch(e) {}\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // On web, TouchableWithoutFeedback can interfere with input focus — use a plain View wrapper there.\r\n  const isWeb = Platform.OS === 'web';\r\n  if (isWeb) {\r\n    return (\r\n      <View style={{ flex: 1 }}>\r\n        <KeyboardAvoidingView style={styles.container} behavior={Platform.OS === 'ios' ? 'padding' : 'height'}>\r\n          <ImageBackground\r\n            source={require('../assets/images/inlogg.webb.png')}\r\n            style={styles.bg}\r\n            imageStyle={styles.bgImage}\r\n            resizeMode=\"cover\"\r\n          >\r\n          <View style={styles.overlay} />\r\n          <View style={styles.contentWrapper}>\r\n            <Image\r\n              source={require('../assets/images/digitalkontroll.lang.transparant.jpg')}\r\n              style={styles.logo}\r\n              resizeMode=\"contain\"\r\n            />\r\n            \r\n\r\n            {error ? (\r\n              <View style={styles.errorBox}>\r\n                <Text style={styles.errorText}>{error}</Text>\r\n              </View>\r\n            ) : null}\r\n\r\n            <View style={styles.inputContainer}>\r\n              <Text style={styles.label}>E-postadress</Text>\r\n              <TextInput\r\n                style={styles.input}\r\n                placeholder=\"Fyll i e-postadress\"\r\n                placeholderTextColor=\"#888\"\r\n                keyboardType=\"email-address\"\r\n                autoCapitalize=\"none\"\r\n                value={email}\r\n                onChangeText={setEmail}\r\n                ref={emailRef}\r\n                returnKeyType=\"next\"\r\n                onSubmitEditing={() => passwordRef.current?.focus()}\r\n              />\r\n              {!isEmailValid(email.trim()) && email.length > 0 ? (\r\n                <Text style={styles.hint}>Ogiltig e‑postadress</Text>\r\n              ) : null}\r\n            </View>\r\n\r\n            <View style={styles.inputContainer}>\r\n              <Text style={styles.label}>Lösenord</Text>\r\n              <TextInput\r\n                style={styles.input}\r\n                placeholder=\"Fyll i lösenord\"\r\n                placeholderTextColor=\"#888\"\r\n                secureTextEntry={!showPassword}\r\n                value={password}\r\n                onChangeText={setPassword}\r\n                autoCapitalize=\"none\"\r\n                ref={passwordRef}\r\n                returnKeyType=\"go\"\r\n                onSubmitEditing={() => { if (!loading && isFormValid) handleLogin(); }}\r\n              />\r\n              <TouchableOpacity onPress={() => setShowPassword((v) => !v)}>\r\n                <Text style={styles.toggleText}>{showPassword ? 'Dölj lösenord' : 'Visa lösenord'}</Text>\r\n              </TouchableOpacity>\r\n              {password.length === 0 && error ? (\r\n                <Text style={styles.hint}>Fyll i ditt lösenord</Text>\r\n              ) : null}\r\n            </View>\r\n\r\n            <TouchableOpacity onPress={() => setRememberMe(v => !v)} style={styles.rememberRow}>\r\n              <View style={styles.rememberBox}>\r\n                {rememberMe ? <View style={styles.rememberFill} /> : null}\r\n              </View>\r\n              <Text style={styles.rememberText}>Kom ihåg mig</Text>\r\n            </TouchableOpacity>\r\n\r\n            <TouchableOpacity style={[styles.button, (loading || !isFormValid) && styles.buttonDisabled]} onPress={loading || !isFormValid ? undefined : handleLogin} disabled={loading || !isFormValid}>\r\n              <Text style={styles.buttonText}>{loading ? 'Loggar in…' : 'LOGGA IN'}</Text>\r\n            </TouchableOpacity>\r\n\r\n          {/* Konto skapas av administratör – ingen självregistrering */}\r\n          </View>\r\n          </ImageBackground>\r\n        </KeyboardAvoidingView>\r\n      </View>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <TouchableWithoutFeedback onPress={Keyboard.dismiss} accessible={false}>\r\n    <KeyboardAvoidingView style={styles.container} behavior={Platform.OS === 'ios' ? 'padding' : 'height'}>\r\n      <ImageBackground\r\n        source={require('../assets/images/inlogg.app.png')}\r\n        style={styles.bg}\r\n        imageStyle={styles.bgImage}\r\n        resizeMode=\"cover\"\r\n      >\r\n      <View style={styles.overlay} />\r\n      <View style={[styles.contentWrapper, { justifyContent: 'flex-start', paddingTop: 12, paddingBottom: 24 }]}>\r\n        <Image\r\n          source={require('../assets/images/digitalkontroll.lang.transparant.jpg')}\r\n          style={styles.logo}\r\n          resizeMode=\"contain\"\r\n        />\r\n        \r\n\r\n        {error ? (\r\n          <View style={styles.errorBox}>\r\n            <Text style={styles.errorText}>{error}</Text>\r\n          </View>\r\n        ) : null}\r\n\r\n        <View style={styles.inputContainer}>\r\n          <Text style={styles.label}>E-postadress</Text>\r\n          <TextInput\r\n            style={styles.input}\r\n            placeholder=\"Fyll i e-postadress\"\r\n            placeholderTextColor=\"#888\"\r\n            keyboardType=\"email-address\"\r\n            autoCapitalize=\"none\"\r\n            value={email}\r\n            onChangeText={setEmail}\r\n            ref={emailRef}\r\n            returnKeyType=\"next\"\r\n            onSubmitEditing={() => passwordRef.current?.focus()}\r\n          />\r\n          {!isEmailValid(email.trim()) && email.length > 0 ? (\r\n            <Text style={styles.hint}>Ogiltig e‑postadress</Text>\r\n          ) : null}\r\n        </View>\r\n\r\n        <View style={styles.inputContainer}>\r\n          <Text style={styles.label}>Lösenord</Text>\r\n          <TextInput\r\n            style={styles.input}\r\n            placeholder=\"Fyll i lösenord\"\r\n            placeholderTextColor=\"#888\"\r\n            secureTextEntry={!showPassword}\r\n            value={password}\r\n            onChangeText={setPassword}\r\n            autoCapitalize=\"none\"\r\n            ref={passwordRef}\r\n            returnKeyType=\"go\"\r\n            onSubmitEditing={() => { if (!loading && isFormValid) handleLogin(); }}\r\n          />\r\n          <TouchableOpacity onPress={() => setShowPassword((v) => !v)}>\r\n            <Text style={styles.toggleText}>{showPassword ? 'Dölj lösenord' : 'Visa lösenord'}</Text>\r\n          </TouchableOpacity>\r\n          {password.length === 0 && error ? (\r\n            <Text style={styles.hint}>Fyll i ditt lösenord</Text>\r\n          ) : null}\r\n        </View>\r\n\r\n        <TouchableOpacity onPress={() => setRememberMe(v => !v)} style={styles.rememberRow}>\r\n          <View style={styles.rememberBox}>\r\n            {rememberMe ? <View style={styles.rememberFill} /> : null}\r\n          </View>\r\n          <Text style={styles.rememberText}>Kom ihåg mig</Text>\r\n        </TouchableOpacity>\r\n\r\n        <TouchableOpacity style={[styles.button, (loading || !isFormValid) && styles.buttonDisabled]} onPress={loading || !isFormValid ? undefined : handleLogin} disabled={loading || !isFormValid}>\r\n          <Text style={styles.buttonText}>{loading ? 'Loggar in…' : 'LOGGA IN'}</Text>\r\n        </TouchableOpacity>\r\n\r\n      {/* Konto skapas av administratör – ingen självregistrering */}\r\n      </View>\r\n      </ImageBackground>\r\n    </KeyboardAvoidingView>\r\n    </TouchableWithoutFeedback>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: {\r\n    flex: 1,\r\n    justifyContent: 'center',\r\n    alignItems: 'center',\r\n    backgroundColor: 'transparent',\r\n    paddingHorizontal: 0,\r\n  },\r\n  bg: {\r\n    flex: 1,\r\n    width: '100%',\r\n    height: '100%',\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    paddingHorizontal: 0,\r\n    paddingVertical: 0,\r\n  },\r\n  bgImage: {\r\n    width: '100%',\r\n    height: '100%',\r\n    backgroundColor: 'transparent',\r\n  },\r\n  overlay: {\r\n    position: 'absolute',\r\n    top: 0,\r\n    left: 0,\r\n    right: 0,\r\n    bottom: 0,\r\n    backgroundColor: 'rgba(255,255,255,0.6)',\r\n  },\r\n  contentWrapper: {\r\n    width: '100%',\r\n    maxWidth: 420,\r\n    paddingHorizontal: 20,\r\n    paddingVertical: 20,\r\n    paddingTop: 24,\r\n    marginTop: 0,\r\n    alignItems: 'center',\r\n  },\r\n  title: {\r\n    fontSize: 28,\r\n    fontWeight: 'bold',\r\n    marginBottom: 10,\r\n    textAlign: 'center',\r\n    marginTop: 8,\r\n  },\r\n  inputContainer: {\r\n    width: '100%',\r\n    maxWidth: 350,\r\n    marginTop: 12,\r\n    marginBottom: 16,\r\n  },\r\n  label: {\r\n    fontSize: 16,\r\n    color: '#111',\r\n    fontWeight: 'bold',\r\n    marginBottom: 4,\r\n    marginLeft: 4,\r\n    alignSelf: 'flex-start',\r\n    paddingHorizontal: 10,\r\n    paddingVertical: 6,\r\n    borderRadius: 10,\r\n    backgroundColor: 'rgba(255,255,255,0.85)',\r\n  },\r\n  input: {\r\n    width: '100%',\r\n    maxWidth: 350,\r\n    height: 48,\r\n    borderColor: '#ccc',\r\n    borderWidth: 1,\r\n    borderRadius: 8,\r\n    paddingHorizontal: 12,\r\n    fontSize: 16,\r\n    backgroundColor: '#fff',\r\n    color: '#000',\r\n  },\r\n  toggleText: {\r\n    marginTop: 6,\r\n    marginLeft: 4,\r\n    color: '#263238',\r\n    fontSize: 14,\r\n    fontWeight: '600',\r\n    alignSelf: 'flex-start',\r\n    paddingHorizontal: 10,\r\n    paddingVertical: 6,\r\n    borderRadius: 10,\r\n    backgroundColor: 'rgba(255,255,255,0.85)',\r\n  },\r\n  logo: {\r\n    width: 200,\r\n    height: 90,\r\n    marginTop: 0,\r\n    marginBottom: 12,\r\n  },\r\n  slogan: {\r\n    fontSize: 16,\r\n    color: '#111',\r\n    textAlign: 'center',\r\n    marginBottom: 12,\r\n    marginTop: 8,\r\n    opacity: 0.9,\r\n    fontWeight: '600',\r\n  },\r\n  errorBox: {\r\n    width: '100%',\r\n    maxWidth: 350,\r\n    backgroundColor: '#fdecea',\r\n    borderLeftWidth: 4,\r\n    borderLeftColor: '#d32f2f',\r\n    padding: 10,\r\n    borderRadius: 6,\r\n    marginBottom: 12,\r\n  },\r\n  errorText: {\r\n    color: '#b71c1c',\r\n    fontSize: 14,\r\n  },\r\n  button: {\r\n    width: '100%',\r\n    maxWidth: 350,\r\n    height: 48,\r\n    backgroundColor: '#263238',\r\n    borderRadius: 8,\r\n    justifyContent: 'center',\r\n    alignItems: 'center',\r\n    marginBottom: 12,\r\n  },\r\n  buttonDisabled: {\r\n    opacity: 0.6,\r\n  },\r\n  buttonText: {\r\n    color: '#fff',\r\n    fontSize: 18,\r\n    fontWeight: 'bold',\r\n  },\r\n  hint: {\r\n    marginTop: 6,\r\n    marginLeft: 4,\r\n    color: '#d32f2f',\r\n    fontSize: 13,\r\n  },\r\n  rememberRow: {\r\n    flexDirection: 'row',\r\n    alignItems: 'center',\r\n    marginTop: 8,\r\n    marginBottom: 8,\r\n    paddingHorizontal: 10,\r\n    paddingVertical: 8,\r\n    borderRadius: 10,\r\n    backgroundColor: 'rgba(255,255,255,0.85)',\r\n  },\r\n  rememberBox: {\r\n    width: 20,\r\n    height: 20,\r\n    borderWidth: 1,\r\n    borderColor: '#222',\r\n    marginRight: 8,\r\n    alignItems: 'center',\r\n    justifyContent: 'center',\r\n    backgroundColor: '#fff',\r\n  },\r\n  rememberFill: {\r\n    width: 12,\r\n    height: 12,\r\n    backgroundColor: '#1976D2',\r\n  },\r\n  rememberText: {\r\n    color: '#222',\r\n    fontWeight: '600',\r\n  },\r\n  link: {\r\n    color: '#263238',\r\n    fontSize: 16,\r\n    marginTop: 8,\r\n  },\r\n});\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\MottagningskontrollScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":33,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":61,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":62,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":73,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":88,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":88,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useRoute } from '@react-navigation/native';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport BaseControlForm from '../components/BaseControlForm';\r\nimport { saveControlToFirestore, saveDraftToFirestore } from '../components/firebase';\r\n\r\nconst LABELS = {\r\n  title: 'Mottagningskontroll',\r\n  saveButton: 'Spara',\r\n  saveDraftButton: 'Spara och slutför senare',\r\n};\r\n\r\nexport default function MottagningskontrollScreen({\r\n  date,\r\n  participants = [],\r\n  project: projectProp,\r\n  initialValues: initialValuesProp,\r\n  onExit,\r\n  onFinished,\r\n}) {\r\n  const route = useRoute();\r\n  const project = projectProp ?? route.params?.project;\r\n  const initialValues = (initialValuesProp ?? route.params?.initialValues) || undefined;\r\n\r\n  const handleSave = async (data) => {\r\n    try {\r\n      // Use existing id if present, otherwise create new\r\n      const controlId = data.id || uuidv4();\r\n      const completed = normalizeControl({ ...data, project, status: 'UTFÖRD', savedAt: new Date().toISOString(), id: controlId });\r\n      try {\r\n        const ok = await saveControlToFirestore(completed);\r\n        if (!ok) throw new Error('Firestore save failed');\r\n      } catch(e) {\r\n        const completedRaw = await AsyncStorage.getItem('completed_controls');\r\n        let completedList = completedRaw ? JSON.parse(completedRaw) : [];\r\n        // Remove all previous versions (by id if present, else by project+type+savedAt)\r\n        let filteredControls = completedList.filter((c) => {\r\n          if (data.id || completed.id) {\r\n            // Remove all with same id\r\n            return c.id !== (data.id || completed.id);\r\n          } else {\r\n            // Remove all with same project+type+savedAt\r\n            return !(\r\n              c.project === data.project &&\r\n              c.type === data.type &&\r\n              c.savedAt === data.savedAt\r\n            );\r\n          }\r\n        });\r\n        filteredControls.push(completed);\r\n        await AsyncStorage.setItem('completed_controls', JSON.stringify(filteredControls));\r\n      }\r\n      // Remove matching draft if exists\r\n      try {\r\n        const draftRaw = await AsyncStorage.getItem('draft_controls');\r\n        if (draftRaw) {\r\n          let drafts = JSON.parse(draftRaw) || [];\r\n          drafts = drafts.filter(d => !(d.project?.id === project?.id && d.type === 'Mottagningskontroll' && (d.id === data.id || d.id === controlId)));\r\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\r\n        }\r\n      } catch(e) {}\r\n    } catch(e) {\r\n      // Hantera fel\r\n    }\r\n  };\r\n\r\n  const handleSaveDraft = async (data) => {\r\n    try {\r\n      const draft = normalizeControl({ ...data, project, status: 'UTKAST', savedAt: new Date().toISOString(), type: 'Mottagningskontroll', id: data.id || uuidv4() });\r\n      try {\r\n        const ok = await saveDraftToFirestore(draft);\r\n        if (!ok) throw new Error('Firestore draft save failed');\r\n      } catch(e) {\r\n        let arr = [];\r\n        const existing = await AsyncStorage.getItem('draft_controls');\r\n        if (existing) arr = JSON.parse(existing);\r\n        // Ersätt om samma projekt+typ+id redan finns, annars lägg till\r\n        const idx = arr.findIndex(\r\n          c => c.project?.id === project?.id && c.type === 'Mottagningskontroll' && c.id === draft.id\r\n        );\r\n        if (idx !== -1) {\r\n          arr[idx] = draft;\r\n        } else {\r\n          arr.push(draft);\r\n        }\r\n        await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\r\n      }\r\n    } catch(e) {\r\n      // Hantera fel\r\n    }\r\n  };\r\n\r\n  // Ensure control object has new fields and migrate legacy ones where possible\r\n  function normalizeControl(obj) {\r\n    const c = { ...obj };\r\n    // Ensure fields exist\r\n    c.materialDesc = c.materialDesc || c.material || '';\r\n    c.qualityDesc = c.qualityDesc || '';\r\n    c.coverageDesc = c.coverageDesc || '';\r\n    // Migrate legacy single-signature uri to signatures array\r\n    if (c.mottagningsSignature && !c.mottagningsSignatures) {\r\n      // if it's boolean true without uri, leave empty\r\n      c.mottagningsSignatures = [];\r\n    }\r\n    if (!c.mottagningsSignatures) c.mottagningsSignatures = [];\r\n    if (c.mottagningsSignatureUri && (!c.mottagningsSignatures || c.mottagningsSignatures.length === 0)) {\r\n      c.mottagningsSignatures = [{ name: 'Signerad', uri: c.mottagningsSignatureUri }];\r\n    }\r\n    // Ensure checklist exists\r\n    if (!Array.isArray(c.checklist)) c.checklist = [];\r\n    return c;\r\n  }\r\n\r\n  return (\r\n    <BaseControlForm\r\n      project={project}\r\n      date={date}\r\n      participants={participants}\r\n      labels={LABELS}\r\n      onSave={handleSave}\r\n      onSaveDraft={handleSaveDraft}\r\n      initialValues={initialValues}\r\n      controlType=\"Mottagningskontroll\"\r\n      onExit={onExit}\r\n      onFinished={onFinished}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\ProjectControlsList.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\ProjectDetails.js","messages":[{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './ArbetsberedningScreen': Unexpected token { (46:16)","line":28,"column":35,"nodeType":"Literal","endLine":28,"endColumn":60},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './ArbetsberedningScreen': Unexpected token { (46:16)","line":28,"column":35,"nodeType":"Literal","endLine":28,"endColumn":60},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './ArbetsberedningScreen': Unexpected token { (46:16)","line":28,"column":35,"nodeType":"Literal","endLine":28,"endColumn":60},{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './ControlDetails': Unexpected token { (61:16)","line":29,"column":28,"nodeType":"Literal","endLine":29,"endColumn":46},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './ControlDetails': Unexpected token { (61:16)","line":29,"column":28,"nodeType":"Literal","endLine":29,"endColumn":46},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './ControlDetails': Unexpected token { (61:16)","line":29,"column":28,"nodeType":"Literal","endLine":29,"endColumn":46},{"ruleId":"import/namespace","severity":2,"message":"Parse errors in imported module './EgenkontrollScreen': Unexpected token { (37:18)","line":30,"column":32,"nodeType":"Literal","endLine":30,"endColumn":54},{"ruleId":"import/no-named-as-default","severity":1,"message":"Parse errors in imported module './EgenkontrollScreen': Unexpected token { (37:18)","line":30,"column":32,"nodeType":"Literal","endLine":30,"endColumn":54},{"ruleId":"import/no-named-as-default-member","severity":1,"message":"Parse errors in imported module './EgenkontrollScreen': Unexpected token { (37:18)","line":30,"column":32,"nodeType":"Literal","endLine":30,"endColumn":54},{"ruleId":"import/namespace","severity":2,"message":"'EncodingType' not found in imported namespace 'FileSystem'.","line":49,"column":78,"nodeType":"Identifier","endLine":49,"endColumn":90},{"ruleId":"import/namespace","severity":2,"message":"'cacheDirectory' not found in imported namespace 'FileSystem'.","line":69,"column":34,"nodeType":"Identifier","endLine":69,"endColumn":48},{"ruleId":"import/namespace","severity":2,"message":"'documentDirectory' not found in imported namespace 'FileSystem'.","line":69,"column":63,"nodeType":"Identifier","endLine":69,"endColumn":80},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":75,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":103,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":119,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":140,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":140,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":147,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":147,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":261,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":261,"endColumn":24},{"ruleId":"import/namespace","severity":2,"message":"'cacheDirectory' not found in imported namespace 'FileSystem'.","line":271,"column":42,"nodeType":"Identifier","endLine":271,"endColumn":56},{"ruleId":"import/namespace","severity":2,"message":"'documentDirectory' not found in imported namespace 'FileSystem'.","line":271,"column":71,"nodeType":"Identifier","endLine":271,"endColumn":88},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":291,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":291,"endColumn":26},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":303,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":303,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":333,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":333,"endColumn":22},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":334,"column":103,"nodeType":"Identifier","messageId":"undef","endLine":334,"endColumn":106},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":337,"column":69,"nodeType":"Identifier","messageId":"undef","endLine":337,"endColumn":85},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":381,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":381,"endColumn":22},{"ruleId":"import/namespace","severity":2,"message":"'cacheDirectory' not found in imported namespace 'FileSystem'.","line":390,"column":40,"nodeType":"Identifier","endLine":390,"endColumn":54},{"ruleId":"import/namespace","severity":2,"message":"'documentDirectory' not found in imported namespace 'FileSystem'.","line":390,"column":69,"nodeType":"Identifier","endLine":390,"endColumn":86},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":408,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":408,"endColumn":24},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":417,"column":64,"nodeType":"Identifier","messageId":"undef","endLine":417,"endColumn":80},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":444,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":444,"endColumn":20},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":445,"column":108,"nodeType":"Identifier","messageId":"undef","endLine":445,"endColumn":111},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":448,"column":67,"nodeType":"Identifier","messageId":"undef","endLine":448,"endColumn":83},{"ruleId":"no-unused-vars","severity":1,"message":"'initialCreator' is assigned a value but never used.","line":484,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":484,"endColumn":45,"suggestions":[{"messageId":"removeVar","data":{"varName":"initialCreator"},"fix":{"range":[24601,24617],"text":""},"desc":"Remove unused variable 'initialCreator'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":495,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":495,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":509,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":509,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'inlineControl' and 'route?.params?.onInlineLockChange'. Either include them or remove the dependency array.","line":510,"column":6,"nodeType":"ArrayExpression","endLine":510,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [inlineControl, inlineControl.type, route?.params?.onInlineLockChange]","fix":{"range":[25926,25947],"text":"[inlineControl, inlineControl.type, route?.params?.onInlineLockChange]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":526,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":526,"endColumn":98},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":528,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":528,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'openInlineControl' and 'selectedAction'. Either include them or remove the dependency array.","line":529,"column":6,"nodeType":"ArrayExpression","endLine":529,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [openInlineControl, selectedAction, selectedAction.id]","fix":{"range":[26829,26849],"text":"[openInlineControl, selectedAction, selectedAction.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":627,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":627,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":639,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":639,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'project'. Either include it or remove the dependency array.","line":678,"column":6,"nodeType":"ArrayExpression","endLine":678,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [project, project?.id]","fix":{"range":[32565,32578],"text":"[project, project?.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showControlPicker' is assigned a value but never used.","line":679,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":679,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"showControlPicker"},"fix":{"range":[32591,32608],"text":""},"desc":"Remove unused variable 'showControlPicker'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setShowControlPicker' is assigned a value but never used.","line":679,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":679,"endColumn":49,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowControlPicker"},"fix":{"range":[32608,32630],"text":""},"desc":"Remove unused variable 'setShowControlPicker'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'selectedControls' is assigned a value but never used.","line":685,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":685,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedControls"},"fix":{"range":[32993,33009],"text":""},"desc":"Remove unused variable 'selectedControls'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setSelectedControls' is assigned a value but never used.","line":685,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":685,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSelectedControls"},"fix":{"range":[33009,33030],"text":""},"desc":"Remove unused variable 'setSelectedControls'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'expandedType' is assigned a value but never used.","line":686,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":686,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"expandedType"},"fix":{"range":[33058,33070],"text":""},"desc":"Remove unused variable 'expandedType'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setExpandedType' is assigned a value but never used.","line":686,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":686,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setExpandedType"},"fix":{"range":[33070,33087],"text":""},"desc":"Remove unused variable 'setExpandedType'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setUndoState' is assigned a value but never used.","line":687,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":687,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"setUndoState"},"fix":{"range":[33126,33140],"text":""},"desc":"Remove unused variable 'setUndoState'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setCompanyLogoUri' is assigned a value but never used.","line":688,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":688,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCompanyLogoUri"},"fix":{"range":[33221,33240],"text":""},"desc":"Remove unused variable 'setCompanyLogoUri'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":710,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":710,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":723,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":723,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":740,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":740,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'selectedControl' is assigned a value but never used.","line":786,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":786,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedControl"},"fix":{"range":[36927,36942],"text":""},"desc":"Remove unused variable 'selectedControl'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showControlOptions' is assigned a value but never used.","line":787,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":787,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"showControlOptions"},"fix":{"range":[36992,37010],"text":""},"desc":"Remove unused variable 'showControlOptions'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'undoTimerRef' is assigned a value but never used.","line":790,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":790,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"undoTimerRef"},"fix":{"range":[37207,37241],"text":""},"desc":"Remove unused variable 'undoTimerRef'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":835,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":835,"endColumn":84},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":846,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":846,"endColumn":79},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":886,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":886,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1887,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":1887,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'allHandled' is assigned a value but never used.","line":1901,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1901,"endColumn":27},{"ruleId":"no-unused-vars","severity":1,"message":"'anyDeviation' is assigned a value but never used.","line":1902,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1902,"endColumn":29},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1926,"column":88,"nodeType":"Identifier","messageId":"unusedVar","endLine":1926,"endColumn":89},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1975,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":1975,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2120,"column":98,"nodeType":"Identifier","messageId":"unusedVar","endLine":2120,"endColumn":99},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2146,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":2146,"endColumn":52},{"ruleId":"import/namespace","severity":2,"message":"'cacheDirectory' not found in imported namespace 'FileSystem'.","line":2154,"column":70,"nodeType":"Identifier","endLine":2154,"endColumn":84},{"ruleId":"import/namespace","severity":2,"message":"'documentDirectory' not found in imported namespace 'FileSystem'.","line":2154,"column":99,"nodeType":"Identifier","endLine":2154,"endColumn":116},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2171,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":2171,"endColumn":54},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":2181,"column":50,"nodeType":"Identifier","messageId":"undef","endLine":2181,"endColumn":66},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2213,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":2213,"endColumn":48},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":2214,"column":120,"nodeType":"Identifier","messageId":"undef","endLine":2214,"endColumn":123},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":2218,"column":53,"nodeType":"Identifier","messageId":"undef","endLine":2218,"endColumn":69},{"ruleId":"no-undef","severity":2,"message":"'companyNameForPdf' is not defined.","line":2220,"column":119,"nodeType":"Identifier","messageId":"undef","endLine":2220,"endColumn":136},{"ruleId":"no-undef","severity":2,"message":"'handleAddControl' is not defined.","line":2348,"column":64,"nodeType":"Identifier","messageId":"undef","endLine":2348,"endColumn":80},{"ruleId":"no-undef","severity":2,"message":"'handleUndo' is not defined.","line":2360,"column":38,"nodeType":"Identifier","messageId":"undef","endLine":2360,"endColumn":48}],"suppressedMessages":[],"errorCount":24,"fatalErrorCount":0,"warningCount":53,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\r\nimport MaterialIcons from '@expo/vector-icons/MaterialIcons';\r\nimport { Asset } from 'expo-asset';\r\nimport * as FileSystem from 'expo-file-system';\r\nimport * as Haptics from 'expo-haptics';\r\nimport * as Print from 'expo-print';\r\nimport * as Sharing from 'expo-sharing';\r\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport {\r\n    Image,\r\n    KeyboardAvoidingView,\r\n    Modal,\r\n    Platform,\r\n    Pressable,\r\n    ScrollView,\r\n    StyleSheet,\r\n    Switch,\r\n    Text,\r\n    TextInput,\r\n    TouchableOpacity,\r\n    View\r\n} from 'react-native';\r\nimport Svg, { Circle, Text as SvgText } from 'react-native-svg';\r\nimport { formatPersonName } from '../components/formatPersonName';\r\nimport { buildPdfHtmlForControl } from '../components/pdfExport';\r\nimport { emitProjectUpdated } from '../components/projectBus';\r\n\r\nimport ArbetsberedningScreen from './ArbetsberedningScreen';\r\nimport ControlDetails from './ControlDetails';\r\nimport EgenkontrollScreen from './EgenkontrollScreen';\r\nimport FuktmätningScreen from './FuktmätningScreen';\r\nimport MottagningskontrollScreen from './MottagningskontrollScreen';\r\nimport RiskbedömningScreen from './RiskbedömningScreen';\r\nimport SkyddsrondScreen from './SkyddsrondScreen';\r\n\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo, HomeHeaderSearch } from '../components/HeaderComponents';\r\nimport { deleteControlFromFirestore, deleteDraftControlFromFirestore, fetchCompanyMembers, fetchCompanyProfile, fetchControlsForProject, fetchDraftControlsForProject } from '../components/firebase';\r\n\r\n// Utility: read a file URI as base64 if possible\r\nasync function readUriAsBase64(uri) {\r\n  if (!uri) return null;\r\n  try {\r\n    // If already a data URI, strip prefix and return raw base64\r\n    if (typeof uri === 'string' && uri.startsWith('data:')) {\r\n      const parts = uri.split(',');\r\n      return parts[1] || null;\r\n    }\r\n    const b = await FileSystem.readAsStringAsync(uri, { encoding: FileSystem.EncodingType.Base64 });\r\n    return b;\r\n  } catch(e) {\r\n    console.warn('[PDF] readUriAsBase64 failed for', uri, e);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Try to convert an image URI (file:// or http(s)) to a data URI (base64). Returns original uri on failure.\r\nasync function toDataUri(uri) {\r\n  if (!uri) return uri;\r\n  try {\r\n    if (typeof uri === 'string' && uri.startsWith('data:')) return uri;\r\n    // Try direct read (works for file:// and sometimes cached local URIs)\r\n    const b = await readUriAsBase64(uri);\r\n    if (b) return 'data:image/jpeg;base64,' + b;\r\n    // If http(s), try download to cache and read\r\n    if (/^https?:\\/\\//i.test(uri)) {\r\n      try {\r\n        const fileName = 'pdf-img-' + (Math.random().toString(36).slice(2, 9)) + '.jpg';\r\n        const dest = (FileSystem.cacheDirectory || FileSystem.documentDirectory) + fileName;\r\n        const dl = await FileSystem.downloadAsync(uri, dest);\r\n        if (dl && dl.uri) {\r\n          const b2 = await readUriAsBase64(dl.uri);\r\n          if (b2) return 'data:image/jpeg;base64,' + b2;\r\n        }\r\n      } catch(e) {}\r\n    }\r\n  } catch(e) {\r\n    console.warn('[PDF] toDataUri failed for', uri, e);\r\n  }\r\n  return uri;\r\n}\r\n\r\n// Embed images (photos/signatures/checklist photos) in a control object by converting URIs to data URIs where possible.\r\nasync function embedImagesInControl(ctrl) {\r\n  if (!ctrl || typeof ctrl !== 'object') return ctrl;\r\n  const c = JSON.parse(JSON.stringify(ctrl));\r\n  try {\r\n    // Mottagnings photos / photos\r\n    const photoFields = ['mottagningsPhotos', 'photos'];\r\n    for (const field of photoFields) {\r\n      if (Array.isArray(c[field]) && c[field].length > 0) {\r\n        const mapped = await Promise.all(c[field].map(async (p) => {\r\n          try {\r\n            if (!p) return p;\r\n            if (typeof p === 'string') {\r\n              const d = await toDataUri(p);\r\n              return d || p;\r\n            }\r\n            // object with uri and comment\r\n            const src = p.uri || p;\r\n            const d = await toDataUri(src);\r\n            return Object.assign({}, p, { uri: d || src });\r\n          } catch(e) { return p; }\r\n        }));\r\n        c[field] = mapped;\r\n      }\r\n    }\r\n\r\n    // Signatures\r\n    if (Array.isArray(c.mottagningsSignatures) && c.mottagningsSignatures.length > 0) {\r\n      const sigs = await Promise.all(c.mottagningsSignatures.map(async (s) => {\r\n        try {\r\n          if (!s) return s;\r\n          if (s.uri) {\r\n            const d = await toDataUri(s.uri);\r\n            return Object.assign({}, s, { uri: d || s.uri });\r\n          }\r\n          return s;\r\n        } catch(e) { return s; }\r\n      }));\r\n      c.mottagningsSignatures = sigs;\r\n    }\r\n\r\n    // Checklist photos (sections -> photos arrays)\r\n    if (Array.isArray(c.checklist) && c.checklist.length > 0) {\r\n      for (let si = 0; si < c.checklist.length; si++) {\r\n        const sec = c.checklist[si];\r\n        if (!sec) continue;\r\n        if (Array.isArray(sec.photos) && sec.photos.length > 0) {\r\n          const newPhotos = await Promise.all(sec.photos.map(async (entry) => {\r\n            if (!entry) return entry;\r\n            // entry might be array of uris or single uri/object\r\n            if (Array.isArray(entry)) {\r\n              return await Promise.all(entry.map(async (it) => {\r\n                try {\r\n                  if (!it) return it;\r\n                  const src = it.uri || it;\r\n                  const d = await toDataUri(src);\r\n                  return (typeof it === 'string') ? (d || src) : Object.assign({}, it, { uri: d || src });\r\n                } catch(e) { return it; }\r\n              }));\r\n            }\r\n            try {\r\n              const src = entry.uri || entry;\r\n              const d = await toDataUri(src);\r\n              return (typeof entry === 'string') ? (d || src) : Object.assign({}, entry, { uri: d || src });\r\n            } catch(e) { return entry; }\r\n          }));\r\n          c.checklist[si].photos = newPhotos;\r\n        }\r\n      }\r\n    }\r\n  } catch(e) {\r\n    console.warn('[PDF] embedImagesInControl failed', e);\r\n  }\r\n  return c;\r\n}\r\n\r\nfunction getWeekAndYear(dateInput) {\r\n  const d = dateInput ? new Date(dateInput) : new Date();\r\n  if (isNaN(d)) return { week: '', year: '' };\r\n  d.setHours(0,0,0,0);\r\n  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));\r\n  const week1 = new Date(d.getFullYear(), 0, 4);\r\n  const weekNo = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);\r\n  return { week: weekNo, year: d.getFullYear() };\r\n}\r\n\r\nfunction isValidIsoDateYmd(value) {\r\n  const v = String(value || '').trim();\r\n  if (!v) return true;\r\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\r\n  const [yStr, mStr, dStr] = v.split('-');\r\n  const y = Number(yStr);\r\n  const m = Number(mStr);\r\n  const d = Number(dStr);\r\n  if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;\r\n  if (m < 1 || m > 12) return false;\r\n  if (d < 1 || d > 31) return false;\r\n  const dt = new Date(Date.UTC(y, m - 1, d));\r\n  return dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === d;\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, padding: 16, backgroundColor: '#fff' },\r\n  subtitle: { fontSize: 18, fontWeight: '600', marginBottom: 8 },\r\n  noControls: { fontSize: 16, fontStyle: 'italic', marginBottom: 12 },\r\n  groupContainer: { marginBottom: 18, backgroundColor: '#f7f7f7', borderRadius: 10, padding: 8 },\r\n  groupHeader: { flexDirection: 'row', alignItems: 'center', flexWrap: 'nowrap', paddingVertical: 8, paddingHorizontal: 4 },\r\n  groupTitle: { fontSize: 16, fontWeight: '700', marginLeft: 6, color: '#263238', flexShrink: 1 },\r\n  groupBadge: { backgroundColor: '#1976D2', borderRadius: 12, paddingHorizontal: 8, marginLeft: 8 },\r\n  groupBadgeText: { color: '#fff', fontWeight: '700', fontSize: 13 },\r\n  controlCard: { backgroundColor: '#fff', borderRadius: 8, padding: 10, marginVertical: 4, borderWidth: 1, borderColor: '#e0e0e0', minHeight: 54, flexDirection: 'row', alignItems: 'center' },\r\n  controlCardWeb: { width: '100%', flex: 1, alignSelf: 'stretch', paddingVertical: 4, paddingHorizontal: 10, minHeight: 40, marginVertical: 2 },\r\n  controlTextContainer: { flexDirection: 'column', flex: 1, minWidth: 0 },\r\n  controlTextContainerWeb: { flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 },\r\n  controlLine: { flexShrink: 1 },\r\n  controlTitle: { fontSize: 15, color: '#222', fontWeight: 'bold', flexShrink: 1 },\r\n  controlTitleInlineWeb: { fontSize: 14, color: '#222', fontWeight: '400' },\r\n  controlSubtitle: { color: '#555', fontSize: 13, marginTop: 4, flexShrink: 1 },\r\n  controlSubtitleInline: { color: '#555', fontSize: 12, fontWeight: '400' },\r\n  form: { backgroundColor: '#fff', borderRadius: 12, padding: 16, margin: 12 },\r\n  selectedType: { fontWeight: '700', fontSize: 16, marginBottom: 8 },\r\n  infoText: { fontSize: 14, color: '#555', marginBottom: 8 },\r\n  linkText: { color: '#1976D2', fontSize: 14, marginBottom: 8 },\r\n  input: { backgroundColor: '#f5f5f5', borderRadius: 8, padding: 10, fontSize: 15, marginBottom: 8, borderWidth: 1, borderColor: '#e0e0e0' },\r\n  saveButton: { backgroundColor: '#1976D2', borderRadius: 8, padding: 12, alignItems: 'center', marginTop: 8 },\r\n  saveButtonText: { color: '#fff', fontWeight: '700', fontSize: 16 },\r\n  cancelButton: { backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, alignItems: 'center', marginTop: 8 },\r\n  cancelText: { color: '#222', fontWeight: '600', fontSize: 16 },\r\n  undoBar: { backgroundColor: '#fffbe6', borderRadius: 8, padding: 10, margin: 12, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' },\r\n  undoText: { color: '#222', fontSize: 15 },\r\n  undoButtonText: { color: '#1976D2', fontWeight: '700', fontSize: 15 },\r\n  noticeBar: { backgroundColor: '#e3f2fd', borderRadius: 8, padding: 10, margin: 12 },\r\n  noticeText: { color: '#1976D2', fontSize: 15, textAlign: 'center' },\r\n  summaryCard: { backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 },\r\n  modalText: { fontSize: 20, fontWeight: '600', marginBottom: 18, color: '#222', textAlign: 'center', marginTop: 6 },\r\n  filterRow: { flexDirection: 'row', flexWrap: 'wrap', marginVertical: 8 },\r\n  filterChip: { backgroundColor: '#e0e0e0', borderRadius: 16, paddingHorizontal: 12, paddingVertical: 6, marginRight: 8, marginBottom: 8 },\r\n  filterChipSelected: { backgroundColor: '#1976D2' },\r\n  filterChipText: { color: '#222', fontSize: 14 },\r\n  filterChipTextSelected: { color: '#fff', fontWeight: '700' },\r\n  centerOverlay: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.25)' },\r\n});\r\n\r\nexport default function ProjectDetails({ route, navigation, inlineClose, refreshNonce }) {\r\n              const [showControlTypeModal, setShowControlTypeModal] = useState(false);\r\n            const [showDeleteModal, setShowDeleteModal] = useState(false);\r\n            const [showDeleteWarning, setShowDeleteWarning] = useState(false);\r\n          // Sätt navigationstitel och header-komponenter så sökrutan finns i projektvyn också\r\n          React.useEffect(() => {\r\n    navigation.setOptions({\r\n      headerTitle: () => <HomeHeaderSearch navigation={navigation} route={navigation.getState?.().routes?.find(r => r.name === 'ProjectDetails') || { params: route?.params }} />,\r\n      headerLeft: () => (\r\n        <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\r\n          <DigitalKontrollHeaderLogo />\r\n        </View>\r\n      ),\r\n      headerRight: () => (\r\n        <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\r\n          <CompanyHeaderLogo companyId={route?.params?.companyId || ''} />\r\n        </View>\r\n      ),\r\n      headerBackTitle: '',\r\n    });\r\n  }, [navigation, route]);\r\n    // State för att låsa upp skapad-datum\r\n    const [canEditCreated, setCanEditCreated] = useState(false);\r\n        const handlePreviewPdf = async () => {\r\n          if (!controls || controls.length === 0) return;\r\n          setExportingPdf(true);\r\n          try {\r\n            try { Haptics.selectionAsync(); } catch {}\r\n\r\n            // Prefer company profile logo for PDF (MVP branding: only on print/PDF)\r\n            let profile = companyProfile;\r\n            if (!profile && companyId) {\r\n              try {\r\n                profile = await fetchCompanyProfile(companyId);\r\n                if (profile) setCompanyProfile(profile);\r\n              } catch(e) {}\r\n            }\r\n            const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\r\n            const companyLogoFromProfile = profile?.logoUrl || null;\r\n\r\n            // Try to use a local file path for the logo for better reliability\r\n            let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\r\n            if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\r\n              try {\r\n                const fileName = 'company-logo.preview.png';\r\n                const dest = (FileSystem.cacheDirectory || FileSystem.documentDirectory) + fileName;\r\n                const dl = await FileSystem.downloadAsync(logoForPrint, dest);\r\n                if (dl?.uri) logoForPrint = dl.uri;\r\n              } catch {}\r\n            }\r\n\r\n            // Convert logo to base64 (if possible) to avoid asset-loading issues\r\n            let logoBase64 = null;\r\n            try {\r\n              logoBase64 = await readUriAsBase64(logoForPrint);\r\n              if (!logoBase64) {\r\n                // Try bundled asset fallback\r\n                try {\r\n                  const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\r\n                  await Asset.loadAsync(a);\r\n                  const local = a.localUri || a.uri;\r\n                  if (local) {\r\n                    logoBase64 = await readUriAsBase64(local);\r\n                    if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n                  }\r\n                } catch(e) {\r\n                  // ignore\r\n                }\r\n              } else {\r\n                logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n              }\r\n            } catch(e) { console.warn('[PDF] logo base64 conversion failed', e); }\r\n\r\n            // Build HTML safely and log length to aid debugging blank PDFs\r\n            let html;\r\n            try {\r\n              if (typeof buildSummaryHtml === 'function') {\r\n                html = buildSummaryHtml(exportFilter, logoForPrint);\r\n              } else {\r\n                console.warn('[PDF] buildSummaryHtml not available, falling back to per-control builder');\r\n                const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\r\n                const preparedControls = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\r\n                html = (preparedControls || []).map(c => buildPdfHtmlForControl({ control: c, project, company: companyObj })).join('<div style=\"page-break-after:always\"></div>');\r\n              }\r\n            } catch (hErr) {\r\n              console.error('[PDF] error while building HTML for preview', hErr);\r\n              html = null;\r\n            }\r\n\r\n            console.log('[PDF] preview HTML length:', html ? String(html).length : 0);\r\n            if (!html || String(html).trim().length < 20) throw new Error('Empty or too-small HTML');\r\n\r\n            try {\r\n              const fileResult = await Print.printToFileAsync({ html });\r\n              const pdfUri = fileResult?.uri;\r\n              if (pdfUri) {\r\n                try {\r\n                  const avail = await Sharing.isAvailableAsync();\r\n                  if (avail) await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\r\n                  else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\r\n                } catch (shareErr) {\r\n                  console.warn('[PDF] shareAsync failed, opening print dialog as fallback', shareErr);\r\n                  await Print.printAsync({ uri: pdfUri });\r\n                }\r\n              } else {\r\n                throw new Error('printToFileAsync returned no uri');\r\n              }\r\n            } catch(e) {\r\n              console.warn('[PDF] printToFileAsync with logo/fallback failed, retrying without logo', err);\r\n              try {\r\n                let html2 = null;\r\n                if (typeof buildSummaryHtml === 'function') html2 = buildSummaryHtml(exportFilter, null);\r\n                else {\r\n                  const preparedControls2 = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\r\n                  html2 = (preparedControls2 || []).map(c => buildPdfHtmlForControl({ control: c, project, company: { name: companyNameForPdf } })).join('<div style=\"page-break-after:always\"></div>');\r\n                }\r\n                console.log('[PDF] retry HTML length:', html2 ? String(html2).length : 0);\r\n                if (!html2 || String(html2).trim().length < 20) throw new Error('Empty retry HTML');\r\n                const fileResult2 = await Print.printToFileAsync({ html: html2 });\r\n                const pdfUri2 = fileResult2?.uri;\r\n                if (pdfUri2) {\r\n                  try {\r\n                    const avail2 = await Sharing.isAvailableAsync();\r\n                    if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\r\n                    else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\r\n                  } catch (shareErr2) {\r\n                    console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\r\n                    await Print.printAsync({ uri: pdfUri2 });\r\n                  }\r\n                } else {\r\n                  throw new Error('printToFileAsync retry returned no uri');\r\n                }\r\n              } catch (err2) { throw err2; }\r\n            }\r\n          } catch(e) {\r\n            console.error('[PDF] Preview error:', e);\r\n            setNotice({ visible: true, text: 'Kunde inte förhandsvisa PDF' });\r\n            setTimeout(() => setNotice({ visible: false, text: '' }), 4000);\r\n          } finally {\r\n            setExportingPdf(false);\r\n          }\r\n        };\r\n      // PDF export-funktion\r\n      const handleExportPdf = async () => {\r\n        if (!controls || controls.length === 0) return;\r\n        setExportingPdf(true);\r\n        try {\r\n          try { Haptics.selectionAsync(); } catch {}\r\n\r\n          // Prefer company profile logo for PDF (MVP branding: only on print/PDF)\r\n          let profile = companyProfile;\r\n          if (!profile && companyId) {\r\n            try {\r\n              profile = await fetchCompanyProfile(companyId);\r\n              if (profile) setCompanyProfile(profile);\r\n            } catch(e) {}\r\n          }\r\n          const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\r\n          const companyLogoFromProfile = profile?.logoUrl || null;\r\n\r\n          let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\r\n          if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\r\n            try {\r\n              const fileName = 'company-logo.export.png';\r\n              const dest = (FileSystem.cacheDirectory || FileSystem.documentDirectory) + fileName;\r\n              const dl = await FileSystem.downloadAsync(logoForPrint, dest);\r\n              if (dl?.uri) logoForPrint = dl.uri;\r\n            } catch {}\r\n          }\r\n          // Try to convert logo to base64 for embedding\r\n          let logoBase64 = null;\r\n          try {\r\n            logoBase64 = await readUriAsBase64(logoForPrint);\r\n            if (!logoBase64) {\r\n              try {\r\n                const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\r\n                await Asset.loadAsync(a);\r\n                const local = a.localUri || a.uri;\r\n                if (local) {\r\n                  logoBase64 = await readUriAsBase64(local);\r\n                  if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n                }\r\n              } catch(e) {}\r\n            } else {\r\n              logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n            }\r\n          } catch(e) { console.warn('[PDF] logo base64 conversion failed', e); }\r\n\r\n          // Bygg HTML för export (alla eller filtrerat) — säkrare bygg och logg\r\n          let html;\r\n          try {\r\n            if (typeof buildSummaryHtml === 'function') html = buildSummaryHtml(exportFilter, logoForPrint);\r\n            else {\r\n                const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\r\n                const preparedControls = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\r\n              html = (preparedControls || []).map(c => buildPdfHtmlForControl({ control: c, project, company: companyObj })).join('<div style=\"page-break-after:always\"></div>');\r\n            }\r\n          } catch (hErr) {\r\n            console.error('[PDF] error while building HTML for export', hErr);\r\n            html = null;\r\n          }\r\n          console.log('[PDF] export HTML length:', html ? String(html).length : 0);\r\n          try {\r\n            if (!html || String(html).trim().length < 20) throw new Error('Empty export HTML');\r\n            const fileResult = await Print.printToFileAsync({ html });\r\n            const pdfUri = fileResult?.uri;\r\n            if (pdfUri) {\r\n              try {\r\n                const avail = await Sharing.isAvailableAsync();\r\n                if (avail) await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\r\n                else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\r\n              } catch (shareErr) {\r\n                console.warn('[PDF] shareAsync failed, falling back to open print dialog', shareErr);\r\n                await Print.printAsync({ uri: pdfUri });\r\n              }\r\n            } else {\r\n              throw new Error('printToFileAsync returned no uri');\r\n            }\r\n          } catch(e) {\r\n            console.warn('[PDF] printToFileAsync with logo failed or HTML invalid, retrying without logo', err);\r\n            try {\r\n              let html2 = null;\r\n              if (typeof buildSummaryHtml === 'function') html2 = buildSummaryHtml(exportFilter, null);\r\n              else {\r\n                const preparedControls2 = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\r\n                html2 = (preparedControls2 || []).map(c => buildPdfHtmlForControl({ control: c, project, company: { name: companyNameForPdf } })).join('<div style=\"page-break-after:always\"></div>');\r\n              }\r\n              console.log('[PDF] retry export HTML length:', html2 ? String(html2).length : 0);\r\n              if (!html2 || String(html2).trim().length < 20) throw new Error('Empty retry export HTML');\r\n              const fileResult2 = await Print.printToFileAsync({ html: html2 });\r\n              const pdfUri2 = fileResult2?.uri;\r\n              if (pdfUri2) {\r\n                try {\r\n                  const avail2 = await Sharing.isAvailableAsync();\r\n                  if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\r\n                  else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\r\n                } catch (shareErr2) {\r\n                  console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\r\n                  await Print.printAsync({ uri: pdfUri2 });\r\n                }\r\n              } else {\r\n                throw new Error('printToFileAsync retry returned no uri');\r\n              }\r\n            } catch (err2) { throw err2; }\r\n          }\r\n          setNotice({ visible: true, text: 'PDF genererad' });\r\n          setTimeout(() => setNotice({ visible: false, text: '' }), 3000);\r\n        } catch(e) {\r\n          console.error('[PDF] Export error:', e);\r\n          setNotice({ visible: true, text: 'Kunde inte exportera PDF' });\r\n          setTimeout(() => setNotice({ visible: false, text: '' }), 4000);\r\n        } finally {\r\n          setExportingPdf(false);\r\n        }\r\n      };\r\n    const [notice, setNotice] = useState({ visible: false, text: '' });\r\n    const scrollRef = useRef(null);\r\n  // Destructure navigation params\r\n  const { project, companyId, initialCreator, selectedAction } = route.params || {};\r\n  const [inlineControl, setInlineControl] = useState(null);\r\n  const openInlineControl = (type, initialValues) => {\r\n    if (!type) return;\r\n    // Freeze the project snapshot at time of opening so the form can't \"jump\"\r\n    // if parent selection changes.\r\n    setInlineControl({ type, initialValues: initialValues || undefined, projectSnapshot: project || null });\r\n    try {\r\n      if (scrollRef?.current && typeof scrollRef.current.scrollTo === 'function') {\r\n        scrollRef.current.scrollTo({ y: 0, animated: false });\r\n      }\r\n    } catch(e) {}\r\n  };\r\n  const closeInlineControl = () => setInlineControl(null);\r\n\r\n  // Inform parent (HomeScreen) when an inline FORM is open on web.\r\n  // This is used to lock the project tree so the user can't switch projects mid-control.\r\n  useEffect(() => {\r\n    try {\r\n      const isWeb = Platform.OS === 'web';\r\n      const isInlineFormOpen = isWeb && !!(inlineControl && inlineControl.type && inlineControl.type !== 'ControlDetails');\r\n      const cb = route?.params?.onInlineLockChange;\r\n      // Backwards-compatible: allow both prop injection patterns\r\n      // 1) route.params.onInlineLockChange (if parent can't pass real props)\r\n      if (typeof cb === 'function') cb(isInlineFormOpen);\r\n    } catch(e) {}\r\n  }, [inlineControl?.type]);\r\n\r\n  // When HomeScreen passes a selectedAction (e.g. open a draft from the dashboard),\r\n  // process it once and open the corresponding inline control.\r\n  const lastProcessedActionIdRef = useRef('');\r\n  useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    const id = selectedAction && selectedAction.id ? String(selectedAction.id) : '';\r\n    if (!id) return;\r\n    if (lastProcessedActionIdRef.current === id) return;\r\n    lastProcessedActionIdRef.current = id;\r\n    try {\r\n      if (selectedAction.kind === 'openDraft' && selectedAction.type) {\r\n        openInlineControl(selectedAction.type, selectedAction.initialValues || undefined);\r\n      }\r\n      if (selectedAction.kind === 'openControlDetails' && selectedAction.control) {\r\n        try { openInlineControl('ControlDetails', { control: selectedAction.control }); } catch(e) {}\r\n      }\r\n    } catch(e) {}\r\n  }, [selectedAction?.id]);\r\n  const [adminPickerVisible, setAdminPickerVisible] = useState(false);\r\n  const [companyAdmins, setCompanyAdmins] = useState([]);\r\n  const [loadingCompanyAdmins, setLoadingCompanyAdmins] = useState(false);\r\n  const [companyAdminsError, setCompanyAdminsError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    const loadAdmins = async () => {\r\n      if (!adminPickerVisible) return;\r\n      if (!companyId) {\r\n        setCompanyAdmins([]);\r\n        setCompanyAdminsError('Saknar företag (companyId).');\r\n        return;\r\n      }\r\n\r\n      setLoadingCompanyAdmins(true);\r\n      setCompanyAdminsError(null);\r\n      try {\r\n        const members = await fetchCompanyMembers(companyId);\r\n        const admins = (Array.isArray(members) ? members : [])\r\n          .filter(m => String(m?.role || '').toLowerCase() === 'admin')\r\n          .slice()\r\n          .sort((a, b) => formatPersonName(a).localeCompare(formatPersonName(b), 'sv'));\r\n\r\n        if (!cancelled) setCompanyAdmins(admins);\r\n      } catch(e) {\r\n        if (!cancelled) {\r\n          setCompanyAdmins([]);\r\n          const msg = e?.code === 'permission-denied'\r\n            ? 'Behörighet saknas för att läsa admins.'\r\n            : 'Kunde inte ladda admins.';\r\n          setCompanyAdminsError(msg);\r\n        }\r\n      } finally {\r\n        if (!cancelled) setLoadingCompanyAdmins(false);\r\n      }\r\n    };\r\n\r\n    loadAdmins();\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [adminPickerVisible, companyId]);\r\n  const hasValidProject = !!(project && typeof project === 'object' && project.id);\r\n    // ...befintlig kod...\r\n    // Visa lista med kontroller under projektinfo\r\n    // Placera där du vill i din layout, t.ex. direkt efter projektinfo:\r\n    // ...befintlig kod...\r\n    // Exempel på integration:\r\n    // <ProjectControlsList projectId={project.id} />\r\n  const controlTypes = [\r\n    'Arbetsberedning',\r\n    'Egenkontroll',\r\n    'Fuktmätning',\r\n    'Mottagningskontroll',\r\n    'Riskbedömning',\r\n    'Skyddsrond'\r\n  ].sort();\r\n  const [controls, setControls] = useState([]);\r\n  // Sökfält för kontroller\r\n  const [searchText, setSearchText] = useState('');\r\n\r\n  // Ladda både utkast (pågående) och slutförda kontroller för projektet\r\n  const loadControls = useCallback(async () => {\r\n    if (!project?.id) return;\r\n    let allControls = [];\r\n    // Hämta utkast (pågående)\r\n    try {\r\n      const draftsRaw = await AsyncStorage.getItem('draft_controls');\r\n      if (draftsRaw) {\r\n        const drafts = JSON.parse(draftsRaw);\r\n        drafts.filter(d => d.project?.id === project.id).forEach(draft => {\r\n          allControls.push({ ...draft, isDraft: true });\r\n        });\r\n      }\r\n    } catch {}\r\n    // Hämta slutförda\r\n    try {\r\n      const completedRaw = await AsyncStorage.getItem('completed_controls');\r\n      if (completedRaw) {\r\n        const completed = JSON.parse(completedRaw);\r\n        completed.filter(c => c.project?.id === project.id).forEach(ctrl => {\r\n          allControls.push({ ...ctrl, isDraft: false });\r\n        });\r\n      }\r\n    } catch {}\r\n    // Try fetching from Firestore as well (merge remote completed controls)\r\n    try {\r\n      const remote = await fetchControlsForProject(project.id, companyId);\r\n      if (Array.isArray(remote) && remote.length > 0) {\r\n        remote.forEach(r => {\r\n          // avoid duplicates if already in allControls by id\r\n          if (!allControls.find(c => c.id && r.id && c.id === r.id)) {\r\n            allControls.push(Object.assign({}, r, { isDraft: false }));\r\n          }\r\n        });\r\n      }\r\n    } catch(e) { /* ignore Firestore errors - we already have local fallback */ }\r\n\r\n    // Fetch remote drafts too so a draft created in app can be finished on web\r\n    try {\r\n      const remoteDrafts = await fetchDraftControlsForProject(project.id, companyId);\r\n      if (Array.isArray(remoteDrafts) && remoteDrafts.length > 0) {\r\n        remoteDrafts.forEach(r => {\r\n          if (!allControls.find(c => c.id && r.id && c.id === r.id)) {\r\n            allControls.push(Object.assign({}, r, { isDraft: true }));\r\n          }\r\n        });\r\n      }\r\n    } catch(e) { /* ignore */ }\r\n    // Sort controls by date (prefer date || savedAt || createdAt) descending\r\n    allControls.sort((a,b) => {\r\n      const ta = new Date(a.date || a.savedAt || a.createdAt || 0).getTime() || 0;\r\n      const tb = new Date(b.date || b.savedAt || b.createdAt || 0).getTime() || 0;\r\n      return tb - ta;\r\n    });\r\n    setControls(allControls);\r\n  }, [project?.id, companyId]);\r\n\r\n  // Web: allow parent (HomeScreen header) to force-refresh the list.\r\n  useEffect(() => {\r\n    if (refreshNonce == null) return;\r\n    loadControls();\r\n  }, [refreshNonce, loadControls]);\r\n\r\n  // Ladda kontroller när sidan visas (fokus)\r\n  React.useEffect(() => {\r\n    const unsubscribe = navigation.addListener('focus', () => {\r\n      loadControls();\r\n    });\r\n    loadControls();\r\n    return unsubscribe;\r\n  }, [navigation, loadControls]);\r\n  const normalizeProject = (p) => {\r\n    if (!p || typeof p !== 'object') return p;\r\n    const formatted = formatPersonName(p.ansvarig || '');\r\n    if (!formatted || formatted === p.ansvarig) return p;\r\n    return { ...p, ansvarig: formatted };\r\n  };\r\n\r\n  const [editableProject, setEditableProject] = useState(() => normalizeProject(project));\r\n    // Store original id for update (keep up to date when route.project changes)\r\n    const [originalProjectId, setOriginalProjectId] = useState(project?.id || null);\r\n\r\n  // Update editableProject when parent passes a new project (e.g., selecting another project inline)\r\n  React.useEffect(() => {\r\n    setEditableProject(normalizeProject(project));\r\n    setOriginalProjectId(project?.id || null);\r\n  }, [project?.id]);\r\n  const [showControlPicker, setShowControlPicker] = useState(false);\r\n  const [showForm, setShowForm] = useState(false);\r\n  const [newControl, setNewControl] = useState({ type: '', date: '', description: '', byggdel: '' });\r\n  const [expandedByType, setExpandedByType] = useState({});\r\n  const [editingInfo, setEditingInfo] = useState(false);\r\n  const [showSummary, setShowSummary] = useState(false);\r\n  const [selectedControls, setSelectedControls] = useState([]);\r\n  const [expandedType, setExpandedType] = useState(null);\r\n  const [undoState, setUndoState] = useState({ visible: false, item: null, index: -1 });\r\n  const [companyLogoUri, setCompanyLogoUri] = useState(null);\r\n  const [companyProfile, setCompanyProfile] = useState(null);\r\n  const [skyddsrondWeeksPickerVisible, setSkyddsrondWeeksPickerVisible] = useState(false);\r\n\r\n  const skyddsrondInfo = React.useMemo(() => {\r\n    const enabled = editableProject?.skyddsrondEnabled !== false;\r\n    const intervalWeeksRaw = Number(editableProject?.skyddsrondIntervalWeeks);\r\n    const intervalDaysRaw = Number(editableProject?.skyddsrondIntervalDays);\r\n    const intervalDays = (Number.isFinite(intervalWeeksRaw) && intervalWeeksRaw > 0)\r\n      ? (intervalWeeksRaw * 7)\r\n      : (Number.isFinite(intervalDaysRaw) && intervalDaysRaw > 0 ? intervalDaysRaw : 14);\r\n    const intervalWeeks = Math.max(1, Math.min(4, Math.round(intervalDays / 7) || 2));\r\n\r\n    const MS_DAY = 24 * 60 * 60 * 1000;\r\n    const now = Date.now();\r\n\r\n    const toMs = (v) => {\r\n      try {\r\n        if (!v) return 0;\r\n        if (typeof v === 'number') return v;\r\n        const t = new Date(v).getTime();\r\n        return Number.isFinite(t) ? t : 0;\r\n      } catch(e) {\r\n        return 0;\r\n      }\r\n    };\r\n\r\n    let lastMs = 0;\r\n    try {\r\n      (controls || []).forEach((c) => {\r\n        if (!c || c.isDraft) return;\r\n        if (c.type !== 'Skyddsrond') return;\r\n        const ts = toMs(c.date || c.savedAt || c.updatedAt || c.createdAt || null);\r\n        if (ts > lastMs) lastMs = ts;\r\n      });\r\n    } catch(e) {}\r\n\r\n    const createdMs = toMs(editableProject?.createdAt || null);\r\n    const firstDueMs = toMs(editableProject?.skyddsrondFirstDueDate || null);\r\n    const baselineMs = lastMs || createdMs || now;\r\n    const nextDueMs = lastMs\r\n      ? (baselineMs + intervalDays * MS_DAY)\r\n      : (firstDueMs || (baselineMs + intervalDays * MS_DAY));\r\n\r\n    const overdue = now > nextDueMs;\r\n    const daysUntil = Math.ceil((nextDueMs - now) / MS_DAY);\r\n    const soon = !overdue && Number.isFinite(daysUntil) && daysUntil <= 3;\r\n\r\n    const fmt = (ms) => {\r\n      try {\r\n        if (!ms) return '—';\r\n        return new Date(ms).toLocaleDateString('sv-SE');\r\n      } catch(e) {\r\n        return '—';\r\n      }\r\n    };\r\n\r\n    if (!enabled) {\r\n      return {\r\n        enabled: false,\r\n        intervalWeeks,\r\n        intervalDays,\r\n        lastLabel: lastMs ? fmt(lastMs) : 'Ingen registrerad',\r\n        nextLabel: fmt(nextDueMs),\r\n        overdue: false,\r\n        soon: false,\r\n      };\r\n    }\r\n\r\n    return {\r\n      enabled: true,\r\n      intervalWeeks,\r\n      intervalDays,\r\n      lastLabel: lastMs ? fmt(lastMs) : 'Ingen registrerad',\r\n      nextLabel: fmt(nextDueMs),\r\n      overdue,\r\n      soon,\r\n    };\r\n  }, [controls, editableProject?.createdAt, editableProject?.skyddsrondEnabled, editableProject?.skyddsrondIntervalWeeks, editableProject?.skyddsrondIntervalDays, editableProject?.skyddsrondFirstDueDate]);\r\n\r\n  const controlTypeOptions = React.useMemo(() => {\r\n    const all = [\r\n      { type: 'Arbetsberedning', icon: 'construct-outline', color: '#1976D2' },\r\n      { type: 'Egenkontroll', icon: 'checkmark-done-outline', color: '#388E3C' },\r\n      { type: 'Fuktmätning', icon: 'water-outline', color: '#0288D1' },\r\n      { type: 'Mottagningskontroll', icon: 'checkbox-outline', color: '#7B1FA2' },\r\n      { type: 'Riskbedömning', icon: 'warning-outline', color: '#FFD600' },\r\n      { type: 'Skyddsrond', icon: 'shield-half-outline', color: '#388E3C' }\r\n    ];\r\n\r\n    const enabled = companyProfile?.enabledControlTypes;\r\n    const filtered = Array.isArray(enabled)\r\n      ? all.filter(o => enabled.includes(o.type))\r\n      : all;\r\n\r\n    return filtered.slice().sort((a, b) => a.type.localeCompare(b.type));\r\n  }, [companyProfile]);\r\n  const [exportFilter, setExportFilter] = useState('Alla');\r\n  const [selectedControl, setSelectedControl] = useState(null);\r\n  const [showControlOptions, setShowControlOptions] = useState(false);\r\n  const [exportingPdf, setExportingPdf] = useState(false);\r\n  const [deleteConfirm, setDeleteConfirm] = useState({ visible: false, control: null });\r\n  const undoTimerRef = useRef(null);\r\n  // ...existing code...\r\n\r\n  // Prefetch company profile for PDF branding (logo/name) without affecting UI\r\n  React.useEffect(() => {\r\n    let active = true;\r\n    if (!companyId) {\r\n      setCompanyProfile(null);\r\n      return () => { active = false; };\r\n    }\r\n    fetchCompanyProfile(companyId)\r\n      .then((p) => { if (active) setCompanyProfile(p || null); })\r\n      .catch((e) => { /* ignore */ });\r\n    return () => { active = false; };\r\n  }, [companyId]);\r\n\r\n  // Handler for long-press on a control\r\n  const handleControlLongPress = (control) => {\r\n    setSelectedControl(control);\r\n    setShowControlOptions(true);\r\n  };\r\n\r\n  // Handler for deleting selected control\r\n  const handleDeleteSelectedControl = async () => {\r\n    if (!deleteConfirm.control) return;\r\n    await actuallyDeleteControl(deleteConfirm.control);\r\n    setDeleteConfirm({ visible: false, control: null });\r\n    setShowControlOptions(false);\r\n    setSelectedControl(null);\r\n    loadControls && loadControls();\r\n  };\r\n\r\n  // Delete logic for a control (draft or completed)\r\n  const actuallyDeleteControl = async (control) => {\r\n    if (!control) return;\r\n    if (control.isDraft) {\r\n      // Remove from draft_controls\r\n      const draftsRaw = await AsyncStorage.getItem('draft_controls');\r\n      let drafts = draftsRaw ? JSON.parse(draftsRaw) : [];\r\n      drafts = drafts.filter(\r\n        c => c.id !== control.id\r\n      );\r\n      await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\r\n\r\n      // Best-effort: delete remote draft too\r\n      try { await deleteDraftControlFromFirestore(control.id, companyId); } catch(e) {}\r\n    } else {\r\n      // Remove from completed_controls\r\n      const completedRaw = await AsyncStorage.getItem('completed_controls');\r\n      let completed = completedRaw ? JSON.parse(completedRaw) : [];\r\n      completed = completed.filter(\r\n        c => c.id !== control.id\r\n      );\r\n      await AsyncStorage.setItem('completed_controls', JSON.stringify(completed));\r\n\r\n      // Best-effort: delete remote control too\r\n      try { await deleteControlFromFirestore(control.id, companyId); } catch(e) {}\r\n    }\r\n  };\r\n\r\n  // Huvud-UI return\r\n  if (!hasValidProject) {\r\n    return (\r\n      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 32 }}>\r\n        <Text style={{ fontSize: 18, color: '#D32F2F', textAlign: 'center' }}>\r\n          Kunde inte läsa projektdata.\r\n        </Text>\r\n        <Text style={{ fontSize: 14, color: '#888', marginTop: 8, textAlign: 'center' }}>\r\n          Projektet är inte korrekt laddat eller saknar ID.\r\n        </Text>\r\n        <TouchableOpacity\r\n          style={{ marginTop: 24, padding: 12, backgroundColor: '#1976D2', borderRadius: 8 }}\r\n          onPress={() => {\r\n            if (typeof inlineClose === 'function') inlineClose();\r\n            else navigation.goBack();\r\n          }}\r\n        >\r\n          <Text style={{ color: '#fff', fontWeight: '600' }}>Tillbaka</Text>\r\n        </TouchableOpacity>\r\n      </View>\r\n    );\r\n  }\r\n\r\n  // Web: keep header/tree and render control forms inside the right pane\r\n  if (Platform.OS === 'web' && inlineControl && inlineControl.type) {\r\n    const isInlineFormOpen = !!(inlineControl && inlineControl.type && inlineControl.type !== 'ControlDetails');\r\n\r\n    const handleInlineBack = () => {\r\n      // For forms: always route through the BaseControlForm exit-confirm flow\r\n      // so the user doesn't accidentally leave without saving/finishing.\r\n      if (isInlineFormOpen) {\r\n        try {\r\n          if (typeof window !== 'undefined' && window.dispatchEvent) {\r\n            window.dispatchEvent(new CustomEvent('dkInlineAttemptExit', { detail: { reason: 'headerBack' } }));\r\n            return;\r\n          }\r\n        } catch(e) {}\r\n      }\r\n\r\n      // For non-form inline views (e.g. ControlDetails), just go back to the project page.\r\n      closeInlineControl();\r\n    };\r\n\r\n    const getInlineHeaderMeta = () => {\r\n      const explicitType = String(inlineControl?.type || '').trim();\r\n      const detailsType = String(inlineControl?.initialValues?.control?.type || '').trim();\r\n      const type = (explicitType === 'ControlDetails' ? detailsType : explicitType) || explicitType;\r\n      const map = {\r\n        Arbetsberedning: { icon: 'construct-outline', color: '#1976D2', label: 'Arbetsberedning' },\r\n        Egenkontroll: { icon: 'checkmark-done-outline', color: '#388E3C', label: 'Egenkontroll' },\r\n        Fuktmätning: { icon: 'water-outline', color: '#0288D1', label: 'Fuktmätning' },\r\n        Mottagningskontroll: { icon: 'checkbox-outline', color: '#7B1FA2', label: 'Mottagningskontroll' },\r\n        Riskbedömning: { icon: 'warning-outline', color: '#FFD600', label: 'Riskbedömning' },\r\n        Skyddsrond: { icon: 'shield-half-outline', color: '#388E3C', label: 'Skyddsrond' },\r\n      };\r\n\r\n      const meta = map[type] || null;\r\n      if (meta) return meta;\r\n      if (type) return { icon: null, color: '#1976D2', label: type };\r\n      return { icon: null, color: '#1976D2', label: 'Kontrolldetaljer' };\r\n    };\r\n\r\n    const wrapInlineControlWithBack = (child) => (\r\n      <View style={{ flex: 1 }}>\r\n        <View style={{ paddingHorizontal: 16, paddingTop: 10, flexDirection: 'row', alignItems: 'center' }}>\r\n          <TouchableOpacity\r\n            onPress={handleInlineBack}\r\n            accessibilityLabel=\"Tillbaka\"\r\n            hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n            style={{ width: 36, height: 32, justifyContent: 'center', alignItems: 'flex-start', marginRight: 10 }}\r\n          >\r\n            <Ionicons name=\"chevron-back\" size={22} color=\"#1976D2\" />\r\n          </TouchableOpacity>\r\n\r\n          {(() => {\r\n            const meta = getInlineHeaderMeta();\r\n            return (\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0, height: 32 }}>\r\n                {meta?.icon ? (\r\n                  <Ionicons name={meta.icon} size={18} color={meta.color} style={{ marginRight: 8 }} />\r\n                ) : null}\r\n                <Text style={{ fontSize: 16, fontWeight: '700', color: '#222', flexShrink: 1 }} numberOfLines={1}>\r\n                  {meta?.label || ''}\r\n                </Text>\r\n              </View>\r\n            );\r\n          })()}\r\n        </View>\r\n        {child}\r\n      </View>\r\n    );\r\n\r\n    const effectiveProject = inlineControl?.projectSnapshot || project;\r\n    const commonProps = {\r\n      project: effectiveProject,\r\n      initialValues: inlineControl.initialValues,\r\n      onExit: closeInlineControl,\r\n      onFinished: () => {\r\n        closeInlineControl();\r\n        loadControls();\r\n      },\r\n    };\r\n\r\n    switch (inlineControl.type) {\r\n      case 'Arbetsberedning':\r\n        return wrapInlineControlWithBack(<ArbetsberedningScreen {...commonProps} />);\r\n      case 'Riskbedömning':\r\n        return wrapInlineControlWithBack(<RiskbedömningScreen {...commonProps} />);\r\n      case 'Fuktmätning':\r\n        return wrapInlineControlWithBack(<FuktmätningScreen {...commonProps} />);\r\n      case 'Egenkontroll':\r\n        return wrapInlineControlWithBack(<EgenkontrollScreen {...commonProps} />);\r\n      case 'Mottagningskontroll':\r\n        return wrapInlineControlWithBack(<MottagningskontrollScreen {...commonProps} />);\r\n      case 'Skyddsrond':\r\n        return wrapInlineControlWithBack(<SkyddsrondScreen {...commonProps} />);\r\n      case 'ControlDetails':\r\n        return wrapInlineControlWithBack(\r\n          <ControlDetails\r\n            route={{\r\n              params: {\r\n                control: inlineControl?.initialValues?.control,\r\n                project: effectiveProject,\r\n                companyId,\r\n              },\r\n            }}\r\n          />\r\n        );\r\n      default:\r\n        return (\r\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 24 }}>\r\n            <Text style={{ fontSize: 16, color: '#D32F2F', textAlign: 'center' }}>\r\n              Okänd kontrolltyp: {String(inlineControl.type)}\r\n            </Text>\r\n            <TouchableOpacity\r\n              style={{ marginTop: 16, padding: 12, backgroundColor: '#1976D2', borderRadius: 8 }}\r\n              onPress={closeInlineControl}\r\n            >\r\n              <Text style={{ color: '#fff', fontWeight: '600' }}>Tillbaka</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        );\r\n    }\r\n  }\r\n\r\n  return (\r\n    <ScrollView\r\n      ref={scrollRef}\r\n      style={styles.container}\r\n      keyboardShouldPersistTaps=\"handled\"\r\n      contentContainerStyle={{ paddingBottom: 240 }}\r\n    >\r\n      {/* Rubrik för projektinfo (med redigera-knapp till höger) */}\r\n      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 18 }}>\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 }}>\r\n          {inlineClose && (\r\n            <TouchableOpacity onPress={inlineClose} style={{ padding: 6, marginRight: 8 }} accessibilityLabel=\"Stäng projekt\">\r\n              <Ionicons name=\"chevron-back\" size={20} color=\"#1976D2\" />\r\n            </TouchableOpacity>\r\n          )}\r\n          <Text style={{ fontSize: 18, fontWeight: 'bold', color: '#333', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">Projektinformation</Text>\r\n        </View>\r\n          {Platform.OS === 'web' ? (\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'nowrap' }}>\r\n            <TouchableOpacity\r\n              style={{ padding: 6, marginRight: 8, borderRadius: 8 }}\r\n              onPress={() => setShowSummary(true)}\r\n              accessibilityLabel=\"Skriv ut\"\r\n            >\r\n              <Ionicons name=\"print-outline\" size={20} color=\"#222\" />\r\n            </TouchableOpacity>\r\n            <TouchableOpacity\r\n              onPress={() => setEditingInfo(true)}\r\n              accessibilityLabel=\"Ändra projektinfo\"\r\n              style={{ padding: 6, marginRight: 8 }}\r\n            >\r\n              <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\r\n            </TouchableOpacity>\r\n            <TouchableOpacity\r\n              style={{ padding: 6 }}\r\n              onPress={() => {\r\n                if ((controls || []).length === 0) {\r\n                  setShowDeleteModal(true);\r\n                } else {\r\n                  setShowDeleteWarning(true);\r\n                }\r\n              }}\r\n              accessibilityLabel=\"Radera projekt\"\r\n            >\r\n              <Ionicons name=\"trash-outline\" size={20} color=\"#D32F2F\" />\r\n            </TouchableOpacity>\r\n          </View>\r\n        ) : (\r\n          <TouchableOpacity\r\n            onPress={() => setEditingInfo(true)}\r\n            accessibilityLabel=\"Ändra projektinfo\"\r\n            style={{ padding: 6 }}\r\n          >\r\n            <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\r\n          </TouchableOpacity>\r\n        )}\r\n      </View>\r\n      {/* Projektinfo med logga, status, projektnummer, projektnamn */}\r\n      <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 18, padding: 12, backgroundColor: '#f7f7f7', borderRadius: 10 }}>\r\n        {companyLogoUri ? (\r\n          <View style={{ marginRight: 16 }}>\r\n            <Image source={{ uri: companyLogoUri }} style={{ width: 56, height: 56, borderRadius: 8, backgroundColor: '#eee' }} resizeMode=\"contain\" />\r\n          </View>\r\n        ) : null}\r\n        <View style={{ flex: 1, position: 'relative' }}>\r\n          {/* Informationsrader */}\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\r\n            <View style={{\r\n              width: 16,\r\n              height: 16,\r\n              borderRadius: 8,\r\n              backgroundColor: editableProject?.status === 'completed' ? '#222' : '#43A047',\r\n              marginRight: 8,\r\n              borderWidth: 2,\r\n              borderColor: '#bbb',\r\n            }} />\r\n            <Text style={{ fontSize: 20, fontWeight: '700', color: '#222', marginRight: 8 }}>{editableProject?.id}</Text>\r\n            <Text style={{ fontSize: 20, fontWeight: '700', color: '#222' }}>{editableProject?.name}</Text>\r\n            {/* edit button moved to header row */}\r\n          </View>\r\n          <View style={{ marginBottom: 2 }}>\r\n            <View style={{ marginBottom: 2 }}>\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Skapad:</Text> {editableProject?.createdAt\r\n                  ? <Text>{new Date(editableProject.createdAt).toLocaleDateString()}</Text>\r\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Ansvarig:</Text> {editableProject?.ansvarig\r\n                  ? <Text>{formatPersonName(editableProject.ansvarig)}</Text>\r\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Status:</Text> {editableProject?.status === 'completed'\r\n                  ? <Text>Avslutat</Text>\r\n                  : editableProject?.status === 'ongoing'\r\n                    ? <Text>Pågående</Text>\r\n                    : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Kund:</Text> {editableProject?.client\r\n                  ? <Text>{editableProject.client}</Text>\r\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Adress:</Text> {editableProject?.adress\r\n                  ? <Text>{editableProject.adress}</Text>\r\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Fastighetsbeteckning:</Text> {editableProject?.fastighetsbeteckning\r\n                  ? <Text>{editableProject.fastighetsbeteckning}</Text>\r\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Valfritt</Text>}\r\n              </Text>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\r\n              <Text style={{ fontSize: 15, color: '#555' }}>\r\n                <Text style={{ fontWeight: '700' }}>Skyddsronder:</Text>{' '}\r\n                {skyddsrondInfo.enabled\r\n                  ? (\r\n                    <>\r\n                      var {skyddsrondInfo.intervalWeeks} veckor. Senaste: {skyddsrondInfo.lastLabel}. Nästa senast:{' '}\r\n                      <Text\r\n                        style={{\r\n                          color: skyddsrondInfo.overdue ? '#D32F2F' : (skyddsrondInfo.soon ? '#FFD600' : '#555'),\r\n                          fontWeight: (skyddsrondInfo.overdue || skyddsrondInfo.soon) ? '700' : '400',\r\n                        }}\r\n                      >\r\n                        {skyddsrondInfo.nextLabel}\r\n                      </Text>\r\n                    </>\r\n                  )\r\n                  : <Text>Inaktiverad</Text>\r\n                }\r\n              </Text>\r\n            </View>\r\n          </View>\r\n        </View>\r\n      </View>\r\n\r\n      {/* Modal för ändra projektinfo */}\r\n      <Modal visible={editingInfo} transparent animationType=\"fade\" onRequestClose={() => setEditingInfo(false)}>\r\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.30)' }}>\r\n          <View style={{ backgroundColor: '#f7f7fa', borderRadius: 20, padding: 28, minWidth: 300, maxWidth: 380, shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12, position: 'relative', borderWidth: 1, borderColor: '#e0e0e0' }}>\r\n            {/* Kryss för stängning uppe till höger */}\r\n            <TouchableOpacity\r\n              style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n              onPress={() => setEditingInfo(false)}\r\n              hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n            >\r\n              <Ionicons name=\"close\" size={24} color=\"#222\" />\r\n            </TouchableOpacity>\r\n            <Text style={{ fontSize: 22, fontWeight: '700', marginBottom: 18, color: '#222', textAlign: 'center', letterSpacing: 0.5 }}>Ändra projektinfo</Text>\r\n            <ScrollView style={{ maxHeight: 340, paddingHorizontal: 2 }} showsVerticalScrollIndicator={false}>\r\n                            {/* Projektnummer */}\r\n                            <View style={{ marginBottom: 14 }}>\r\n                              <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Projektnummer</Text>\r\n                              <TextInput\r\n                                style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n                                value={editableProject?.id || ''}\r\n                                onChangeText={v => setEditableProject(p => ({ ...p, id: v }))}\r\n                                placeholder=\"Ange projektnummer\"\r\n                                placeholderTextColor=\"#bbb\"\r\n                                autoCapitalize=\"none\"\r\n                              />\r\n                            </View>\r\n                            {/* Projektnamn */}\r\n                            <View style={{ marginBottom: 14 }}>\r\n                              <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Projektnamn</Text>\r\n                              <TextInput\r\n                                style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n                                value={editableProject?.name || ''}\r\n                                onChangeText={v => setEditableProject(p => ({ ...p, name: v }))}\r\n                                placeholder=\"Ange projektnamn\"\r\n                                placeholderTextColor=\"#bbb\"\r\n                                autoCapitalize=\"words\"\r\n                              />\r\n                            </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Skapad</Text>\r\n                <TouchableOpacity\r\n                  activeOpacity={1}\r\n                  onLongPress={() => setCanEditCreated(true)}\r\n                  delayLongPress={2000}\r\n                >\r\n                  <TextInput\r\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: canEditCreated ? '#fff' : '#eee', color: canEditCreated ? '#222' : '#888' }}\r\n                    value={editableProject?.createdAt ? new Date(editableProject.createdAt).toLocaleDateString() : ''}\r\n                    editable={false}\r\n                    pointerEvents=\"none\"\r\n                  />\r\n                  {!canEditCreated && (\r\n                    <Text style={{ fontSize: 13, color: '#888', marginTop: 4, textAlign: 'center' }}>\r\n                      Håll in 2 sekunder för att ändra datum\r\n                    </Text>\r\n                  )}\r\n                </TouchableOpacity>\r\n                {canEditCreated && (\r\n                  <Modal visible={canEditCreated} transparent animationType=\"fade\" onRequestClose={() => setCanEditCreated(false)}>\r\n                    <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.30)' }}>\r\n                      <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, minWidth: 260, maxWidth: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\r\n                        <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Välj nytt skapad-datum</Text>\r\n                        <TextInput\r\n                          style={{ borderWidth: 1, borderColor: '#1976D2', borderRadius: 8, padding: 10, fontSize: 16, backgroundColor: '#fafafa', color: '#222', marginBottom: 12 }}\r\n                          value={editableProject?.createdAt ? new Date(editableProject.createdAt).toISOString().slice(0, 10) : ''}\r\n                          onChangeText={v => {\r\n                            // Validera att datumet inte är i framtiden\r\n                            const today = new Date();\r\n                            const inputDate = new Date(v);\r\n                            if (inputDate > today) return;\r\n                            setEditableProject(p => ({ ...p, createdAt: v }));\r\n                          }}\r\n                          placeholder=\"YYYY-MM-DD\"\r\n                          placeholderTextColor=\"#bbb\"\r\n                          keyboardType=\"numeric\"\r\n                        />\r\n                        <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                          <TouchableOpacity\r\n                            style={{ backgroundColor: '#1976D2', borderRadius: 8, padding: 12, alignItems: 'center', flex: 1, marginRight: 8 }}\r\n                            onPress={() => setCanEditCreated(false)}\r\n                          >\r\n                            <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Spara</Text>\r\n                          </TouchableOpacity>\r\n                          <TouchableOpacity\r\n                            style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\r\n                            onPress={() => setCanEditCreated(false)}\r\n                          >\r\n                            <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n                          </TouchableOpacity>\r\n                        </View>\r\n                      </View>\r\n                    </View>\r\n                  </Modal>\r\n                )}\r\n              </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Ansvarig</Text>\r\n                <TouchableOpacity\r\n                  activeOpacity={0.85}\r\n                  onPress={() => setAdminPickerVisible(true)}\r\n                  style={{\r\n                    borderWidth: 1,\r\n                    borderColor: '#e0e0e0',\r\n                    borderRadius: 8,\r\n                    padding: 10,\r\n                    backgroundColor: '#fff',\r\n                    flexDirection: 'row',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'space-between',\r\n                    gap: 10,\r\n                  }}\r\n                >\r\n                  <Text\r\n                    style={{ fontSize: 15, color: editableProject?.ansvarig ? '#222' : '#bbb', flex: 1 }}\r\n                    numberOfLines={1}\r\n                  >\r\n                    {editableProject?.ansvarig ? formatPersonName(editableProject.ansvarig) : 'Välj ansvarig...'}\r\n                  </Text>\r\n                  <Ionicons name=\"chevron-down\" size={18} color=\"#888\" />\r\n                </TouchableOpacity>\r\n\r\n                <Modal\r\n                  visible={adminPickerVisible}\r\n                  transparent\r\n                  animationType=\"fade\"\r\n                  onRequestClose={() => setAdminPickerVisible(false)}\r\n                >\r\n                  <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 18 }}>\r\n                    <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 16, width: '100%', minWidth: 300, maxWidth: 380 }}>\r\n                      <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 10, textAlign: 'center' }}>\r\n                        Välj ansvarig\r\n                      </Text>\r\n\r\n                      {loadingCompanyAdmins ? (\r\n                        <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\r\n                          Laddar...\r\n                        </Text>\r\n                      ) : (companyAdminsError ? (\r\n                        <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\r\n                          {companyAdminsError}\r\n                        </Text>\r\n                      ) : (companyAdmins.length === 0 ? (\r\n                        <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\r\n                          Inga admins hittades i företaget.\r\n                        </Text>\r\n                      ) : (\r\n                        <ScrollView style={{ maxHeight: 420 }}>\r\n                          {companyAdmins.map((m) => (\r\n                            <TouchableOpacity\r\n                              key={m.id || m.uid || m.email}\r\n                              style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                              onPress={() => {\r\n                                const uid = m.uid || m.id || null;\r\n                                const name = formatPersonName(m);\r\n                                setEditableProject(p => ({\r\n                                  ...(p || {}),\r\n                                  ansvarig: name,\r\n                                  ansvarigId: uid,\r\n                                }));\r\n                                setAdminPickerVisible(false);\r\n                              }}\r\n                            >\r\n                              <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\r\n                                {formatPersonName(m)}\r\n                              </Text>\r\n                            </TouchableOpacity>\r\n                          ))}\r\n                        </ScrollView>\r\n                      )))}\r\n\r\n                      <TouchableOpacity\r\n                        style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                        onPress={() => setAdminPickerVisible(false)}\r\n                      >\r\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                </Modal>\r\n              </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Status</Text>\r\n                <View style={{ flexDirection: 'row', gap: 12 }}>\r\n                  <TouchableOpacity\r\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 12, borderRadius: 8, backgroundColor: editableProject?.status !== 'completed' ? '#e8f5e9' : '#fff', borderWidth: editableProject?.status !== 'completed' ? 2 : 1, borderColor: editableProject?.status !== 'completed' ? '#43A047' : '#e0e0e0', marginRight: 8 }}\r\n                    onPress={() => setEditableProject(p => ({ ...p, status: 'ongoing' }))}\r\n                  >\r\n                    <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: '#43A047', marginRight: 8, borderWidth: 2, borderColor: '#bbb' }} />\r\n                    <Text style={{ fontSize: 15, color: '#222' }}>Pågående</Text>\r\n                  </TouchableOpacity>\r\n                  <TouchableOpacity\r\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 12, borderRadius: 8, backgroundColor: editableProject?.status === 'completed' ? '#f5f5f5' : '#fff', borderWidth: editableProject?.status === 'completed' ? 2 : 1, borderColor: editableProject?.status === 'completed' ? '#222' : '#e0e0e0' }}\r\n                    onPress={() => setEditableProject(p => ({ ...p, status: 'completed' }))}\r\n                  >\r\n                    <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: '#222', marginRight: 8, borderWidth: 2, borderColor: '#bbb' }} />\r\n                    <Text style={{ fontSize: 15, color: '#222' }}>Avslutat</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Kund</Text>\r\n                <TextInput\r\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n                  value={editableProject?.client || ''}\r\n                  onChangeText={v => setEditableProject(p => ({ ...p, client: v }))}\r\n                  placeholder=\"Ange kund\"\r\n                  placeholderTextColor=\"#bbb\"\r\n                />\r\n              </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Adress</Text>\r\n                <TextInput\r\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n                  value={editableProject?.adress || ''}\r\n                  onChangeText={v => setEditableProject(p => ({ ...p, adress: v }))}\r\n                  placeholder=\"Ange adress\"\r\n                  placeholderTextColor=\"#bbb\"\r\n                />\r\n              </View>\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Fastighetsbeteckning</Text>\r\n                <TextInput\r\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n                  value={editableProject?.fastighetsbeteckning || ''}\r\n                  onChangeText={v => setEditableProject(p => ({ ...p, fastighetsbeteckning: v }))}\r\n                  placeholder=\"Ange fastighetsbeteckning\"\r\n                  placeholderTextColor=\"#bbb\"\r\n                />\r\n              </View>\r\n\r\n              <View style={{ marginBottom: 14 }}>\r\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 6 }}>Skyddsronder</Text>\r\n                {(() => {\r\n                  const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\r\n                  const isEnabled = editableProject?.skyddsrondEnabled !== false;\r\n                  const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\r\n                  return (\r\n                    <View>\r\n                      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>\r\n                        <Text style={{ fontSize: 15, color: '#222' }}>Aktiva</Text>\r\n                        <Switch\r\n                          value={editableProject?.skyddsrondEnabled !== false}\r\n                          onValueChange={(v) => setEditableProject(p => ({ ...p, skyddsrondEnabled: !!v }))}\r\n                        />\r\n                      </View>\r\n\r\n                      <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Veckor mellan skyddsronder</Text>\r\n                      <TouchableOpacity\r\n                        style={{\r\n                          borderWidth: 1,\r\n                          borderColor: '#e0e0e0',\r\n                          borderRadius: 8,\r\n                          paddingVertical: 10,\r\n                          paddingHorizontal: 10,\r\n                          backgroundColor: '#fff',\r\n                          flexDirection: 'row',\r\n                          alignItems: 'center',\r\n                          justifyContent: 'space-between',\r\n                          opacity: (editableProject?.skyddsrondEnabled !== false) ? 1 : 0.5,\r\n                        }}\r\n                        disabled={editableProject?.skyddsrondEnabled === false}\r\n                        onPress={() => setSkyddsrondWeeksPickerVisible(true)}\r\n                        activeOpacity={0.85}\r\n                      >\r\n                        <Text style={{ fontSize: 15, color: '#222' }}>\r\n                          {String(editableProject?.skyddsrondIntervalWeeks || 2)}\r\n                        </Text>\r\n                        <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\r\n                      </TouchableOpacity>\r\n\r\n                      <Text style={{ fontSize: 15, color: '#888', marginBottom: 4, marginTop: 10 }}>Första skyddsrond senast</Text>\r\n                      <TextInput\r\n                        style={{\r\n                          borderWidth: 1,\r\n                          borderColor: (isEnabled && !isFirstDueValid) ? '#D32F2F' : '#e0e0e0',\r\n                          borderRadius: 8,\r\n                          padding: 10,\r\n                          fontSize: 15,\r\n                          backgroundColor: '#fff',\r\n                          opacity: (editableProject?.skyddsrondEnabled !== false) ? 1 : 0.5,\r\n                        }}\r\n                        value={String(editableProject?.skyddsrondFirstDueDate || '')}\r\n                        editable={editableProject?.skyddsrondEnabled !== false}\r\n                        onChangeText={v => setEditableProject(p => ({ ...p, skyddsrondFirstDueDate: v }))}\r\n                        placeholder=\"YYYY-MM-DD\"\r\n                        placeholderTextColor=\"#bbb\"\r\n                      />\r\n\r\n                      {isEnabled && !isFirstDueValid && (\r\n                        <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: 6 }}>\r\n                          Du måste fylla i datum (YYYY-MM-DD).\r\n                        </Text>\r\n                      )}\r\n                    </View>\r\n                  );\r\n                })()}\r\n              </View>\r\n            </ScrollView>\r\n\r\n            <Modal\r\n              visible={skyddsrondWeeksPickerVisible}\r\n              transparent\r\n              animationType=\"fade\"\r\n              onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\r\n            >\r\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.30)' }}>\r\n                <Pressable\r\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0 }}\r\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n                />\r\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\r\n                    Veckor mellan skyddsronder\r\n                  </Text>\r\n                  {[1, 2, 3, 4].map((w) => (\r\n                    <TouchableOpacity\r\n                      key={String(w)}\r\n                      style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\r\n                      onPress={() => {\r\n                        setEditableProject(p => ({ ...p, skyddsrondIntervalWeeks: w }));\r\n                        setSkyddsrondWeeksPickerVisible(false);\r\n                      }}\r\n                    >\r\n                      <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>{w}</Text>\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                  <TouchableOpacity\r\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\r\n                    onPress={() => setSkyddsrondWeeksPickerVisible(false)}\r\n                  >\r\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            </Modal>\r\n\r\n            <TouchableOpacity\r\n              style={{\r\n                backgroundColor: 'transparent',\r\n                borderRadius: 10,\r\n                borderWidth: 1,\r\n                borderColor: '#1976D2',\r\n                flexDirection: 'row',\r\n                alignItems: 'center',\r\n                justifyContent: 'center',\r\n                paddingVertical: 10,\r\n                paddingHorizontal: 18,\r\n                shadowColor: 'transparent',\r\n                shadowOffset: { width: 0, height: 0 },\r\n                shadowOpacity: 0,\r\n                shadowRadius: 0,\r\n                elevation: 0,\r\n                minHeight: 36,\r\n                marginTop: 8,\r\n                marginBottom: 2,\r\n                overflow: 'hidden',\r\n                opacity: (() => {\r\n                  const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\r\n                  const isEnabled = editableProject?.skyddsrondEnabled !== false;\r\n                  const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\r\n                  return isFirstDueValid ? 1 : 0.5;\r\n                })(),\r\n              }}\r\n              activeOpacity={0.85}\r\n              disabled={(() => {\r\n                const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\r\n                const isEnabled = editableProject?.skyddsrondEnabled !== false;\r\n                const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\r\n                return !isFirstDueValid;\r\n              })()}\r\n              onPress={() => {\r\n                const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\r\n                const isEnabled = editableProject?.skyddsrondEnabled !== false;\r\n                const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\r\n                if (!isFirstDueValid) return;\r\n\r\n                const sanitizedProject = {\r\n                  ...editableProject,\r\n                  skyddsrondFirstDueDate: isEnabled ? (firstDueTrim || null) : null,\r\n                };\r\n                if (typeof navigation?.setParams === 'function') {\r\n                  navigation.setParams({ project: sanitizedProject });\r\n                }\r\n                emitProjectUpdated({ ...sanitizedProject, originalId: originalProjectId });\r\n                setEditingInfo(false);\r\n              }}\r\n            >\r\n              <Ionicons name=\"checkmark-circle-outline\" size={20} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n              <Text style={{ color: '#1976D2', fontWeight: '600', fontSize: 15, letterSpacing: 0.5 }}>Spara</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n      {/* Knapprad med horisontella linjer */}\r\n      <View style={{ marginBottom: 12 }}>\r\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', marginBottom: 10, marginTop: 8, width: '110%', marginLeft: '-5%' }} />\r\n        {Platform.OS === 'web' ? (\r\n          <>\r\n            <View style={{ marginBottom: 8, alignItems: 'flex-start', paddingHorizontal: 0 }}>\r\n              <Text style={{ fontSize: 18, fontWeight: '600', textAlign: 'left', marginBottom: 12, color: '#263238', letterSpacing: 0.2 }}>Skapa kontroll:</Text>\r\n            </View>\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>\r\n              {[\r\n                { type: 'Arbetsberedning', icon: 'construct-outline', color: '#1976D2' },\r\n                { type: 'Egenkontroll', icon: 'checkmark-done-outline', color: '#388E3C' },\r\n                { type: 'Fuktmätning', icon: 'water-outline', color: '#0288D1' },\r\n                { type: 'Mottagningskontroll', icon: 'checkbox-outline', color: '#7B1FA2' },\r\n                { type: 'Riskbedömning', icon: 'warning-outline', color: '#FFD600' },\r\n                { type: 'Skyddsrond', icon: 'shield-half-outline', color: '#388E3C' }\r\n              ].map(({ type, icon, color }) => (\r\n                <TouchableOpacity\r\n                  key={type}\r\n                  style={{\r\n                    flexDirection: 'row',\r\n                    alignItems: 'center',\r\n                    backgroundColor: '#fff',\r\n                    borderRadius: 12,\r\n                    borderWidth: 1,\r\n                    borderColor: '#e0e0e0',\r\n                    paddingVertical: 10,\r\n                    paddingHorizontal: 14,\r\n                    marginRight: 10,\r\n                    marginBottom: 10,\r\n                    shadowColor: '#000',\r\n                    shadowOffset: { width: 0, height: 2 },\r\n                    shadowOpacity: 0.06,\r\n                    shadowRadius: 4,\r\n                    elevation: 2,\r\n                    cursor: 'pointer'\r\n                  }}\r\n                  onPress={() => {\r\n                    switch (type) {\r\n                      case 'Arbetsberedning':\r\n                        if (Platform.OS === 'web') openInlineControl('Arbetsberedning');\r\n                        else navigation.navigate('ArbetsberedningScreen', { project });\r\n                        break;\r\n                      case 'Riskbedömning':\r\n                        if (Platform.OS === 'web') openInlineControl('Riskbedömning');\r\n                        else navigation.navigate('RiskbedömningScreen', { project });\r\n                        break;\r\n                      case 'Fuktmätning':\r\n                        if (Platform.OS === 'web') openInlineControl('Fuktmätning');\r\n                        else navigation.navigate('FuktmätningScreen', { project });\r\n                        break;\r\n                      case 'Egenkontroll':\r\n                        if (Platform.OS === 'web') openInlineControl('Egenkontroll');\r\n                        else navigation.navigate('EgenkontrollScreen', { project });\r\n                        break;\r\n                      case 'Mottagningskontroll':\r\n                        if (Platform.OS === 'web') openInlineControl('Mottagningskontroll');\r\n                        else navigation.navigate('MottagningskontrollScreen', { project });\r\n                        break;\r\n                      case 'Skyddsrond':\r\n                        if (Platform.OS === 'web') openInlineControl('Skyddsrond');\r\n                        else navigation.navigate('SkyddsrondScreen', { project });\r\n                        break;\r\n                      default:\r\n                        if (Platform.OS === 'web') openInlineControl(type);\r\n                        else navigation.navigate('ControlForm', { project, controlType: type });\r\n                    }\r\n                  }}\r\n                  activeOpacity={0.85}\r\n                >\r\n                  <Ionicons name={icon} size={18} color={color} style={{ marginRight: 10 }} />\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 15 }}>{type}</Text>\r\n                </TouchableOpacity>\r\n              ))}\r\n            </View>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'flex-end', width: '100%' }}>\r\n              <TouchableOpacity\r\n                style={{\r\n                  backgroundColor: '#f5f5f5',\r\n                  borderRadius: 10,\r\n                  borderWidth: 1,\r\n                  borderColor: '#e0e0e0',\r\n                  flexDirection: 'row',\r\n                  alignItems: 'center',\r\n                  paddingVertical: 6,\r\n                  paddingHorizontal: 18,\r\n                  shadowColor: '#222',\r\n                  shadowOffset: { width: 0, height: 2 },\r\n                  shadowOpacity: 0.08,\r\n                  shadowRadius: 4,\r\n                  elevation: 1,\r\n                  minHeight: 36,\r\n                  maxWidth: 180,\r\n                  width: 'auto',\r\n                  marginBottom: 8,\r\n                  marginRight: 40,\r\n                  overflow: 'hidden',\r\n                }}\r\n                activeOpacity={0.85}\r\n                onPress={() => setShowControlTypeModal(true)}\r\n              >\r\n                <Ionicons name=\"add-circle-outline\" size={20} color=\"#222\" style={{ marginRight: 10 }} />\r\n                <Text style={{ color: '#222', fontWeight: '600', fontSize: 15, letterSpacing: 0.5, zIndex: 1 }}>Ny kontroll</Text>\r\n              </TouchableOpacity>\r\n              <TouchableOpacity\r\n                style={{\r\n                  backgroundColor: '#f5f5f5',\r\n                  borderRadius: 10,\r\n                  borderWidth: 1,\r\n                  borderColor: '#e0e0e0',\r\n                  flexDirection: 'row',\r\n                  alignItems: 'center',\r\n                  paddingVertical: 6,\r\n                  paddingHorizontal: 12,\r\n                  shadowColor: '#222',\r\n                  shadowOffset: { width: 0, height: 2 },\r\n                  shadowOpacity: 0.08,\r\n                  shadowRadius: 4,\r\n                  elevation: 1,\r\n                  minHeight: 36,\r\n                  maxWidth: 50,\r\n                  marginRight: 10,\r\n                  marginBottom: 8,\r\n                  overflow: 'hidden',\r\n                }}\r\n                activeOpacity={0.85}\r\n                onPress={() => setShowSummary(true)}\r\n                accessibilityLabel=\"Skriv ut\"\r\n              >\r\n                <Ionicons name=\"print-outline\" size={20} color=\"#222\" />\r\n              </TouchableOpacity>\r\n              <TouchableOpacity\r\n                style={{\r\n                  backgroundColor: '#f5f5f5',\r\n                  borderRadius: 10,\r\n                  borderWidth: 1,\r\n                  borderColor: '#e0e0e0',\r\n                  flexDirection: 'row',\r\n                  alignItems: 'center',\r\n                  paddingVertical: 6,\r\n                  paddingHorizontal: 12,\r\n                  shadowColor: '#D32F2F',\r\n                  shadowOffset: { width: 0, height: 2 },\r\n                  shadowOpacity: 0.08,\r\n                  shadowRadius: 4,\r\n                  elevation: 1,\r\n                  minHeight: 36,\r\n                  maxWidth: 50,\r\n                  marginRight: 0,\r\n                  marginBottom: 8,\r\n                  overflow: 'hidden',\r\n                }}\r\n                activeOpacity={0.85}\r\n                onPress={() => {\r\n                  if ((controls || []).length === 0) {\r\n                    setShowDeleteModal(true);\r\n                  } else {\r\n                    setShowDeleteWarning(true);\r\n                  }\r\n                }}\r\n                accessibilityLabel=\"Radera projekt\"\r\n              >\r\n                <Ionicons name=\"trash-outline\" size={20} color=\"#D32F2F\" />\r\n              </TouchableOpacity>\r\n            </View>\r\n          </>\r\n        )}\r\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', marginTop: 10, width: '110%', marginLeft: '-5%' }} />\r\n      </View>\r\n\r\n      <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 16, marginBottom: 8, minHeight: 32 }}>\r\n\r\n      {/* Modal för val av kontrolltyp */}\r\n      <Modal\r\n        visible={showControlTypeModal}\r\n        transparent\r\n        animationType=\"fade\"\r\n        onRequestClose={() => setShowControlTypeModal(false)}\r\n      >\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 18, color: '#222', textAlign: 'center', marginTop: 6 }}>\r\n              Välj kontrolltyp\r\n            </Text>\r\n            {controlTypeOptions.map(({ type, icon, color }) => (\r\n              <TouchableOpacity\r\n                key={type}\r\n                style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 12, paddingHorizontal: 8, borderRadius: 8, marginBottom: 8, backgroundColor: '#f5f5f5', borderWidth: 1, borderColor: '#e0e0e0' }}\r\n                onPress={() => {\r\n                  setShowControlTypeModal(false);\r\n                  // Route each control type to its dedicated screen\r\n                  switch (type) {\r\n                    case 'Arbetsberedning':\r\n                      if (Platform.OS === 'web') openInlineControl('Arbetsberedning');\r\n                      else navigation.navigate('ArbetsberedningScreen', { project });\r\n                      break;\r\n                    case 'Riskbedömning':\r\n                      if (Platform.OS === 'web') openInlineControl('Riskbedömning');\r\n                      else navigation.navigate('RiskbedömningScreen', { project });\r\n                      break;\r\n                    case 'Fuktmätning':\r\n                      if (Platform.OS === 'web') openInlineControl('Fuktmätning');\r\n                      else navigation.navigate('FuktmätningScreen', { project });\r\n                      break;\r\n                    case 'Egenkontroll':\r\n                      if (Platform.OS === 'web') openInlineControl('Egenkontroll');\r\n                      else navigation.navigate('EgenkontrollScreen', { project });\r\n                      break;\r\n                    case 'Mottagningskontroll':\r\n                      if (Platform.OS === 'web') openInlineControl('Mottagningskontroll');\r\n                      else navigation.navigate('MottagningskontrollScreen', { project });\r\n                      break;\r\n                    case 'Skyddsrond':\r\n                      if (Platform.OS === 'web') openInlineControl('Skyddsrond');\r\n                      else navigation.navigate('SkyddsrondScreen', { project });\r\n                      break;\r\n                    default:\r\n                      if (Platform.OS === 'web') openInlineControl(type);\r\n                      else navigation.navigate('ControlForm', {\r\n                        project,\r\n                        controlType: type\r\n                      });\r\n                  }\r\n                }}\r\n              >\r\n                <Ionicons name={icon} size={22} color={color} style={{ marginRight: 12 }} />\r\n                <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>{type}</Text>\r\n              </TouchableOpacity>\r\n            ))}\r\n            {Array.isArray(companyProfile?.enabledControlTypes) && controlTypeOptions.length === 0 ? (\r\n              <Text style={{ color: '#D32F2F', textAlign: 'center', marginTop: 6, marginBottom: 8 }}>\r\n                Inga kontrolltyper är aktiverade för företaget.\r\n              </Text>\r\n            ) : null}\r\n                      <TouchableOpacity\r\n                        style={{ marginTop: 8, alignSelf: 'center' }}\r\n                        onPress={() => setShowControlTypeModal(false)}\r\n                      >\r\n                        <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\r\n                      </TouchableOpacity>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n\r\n              {/* Modal: Bekräfta radering om inga kontroller */}\r\n              <Modal visible={showDeleteModal} transparent animationType=\"fade\" onRequestClose={() => setShowDeleteModal(false)}>\r\n                <View style={styles.centerOverlay}>\r\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\r\n                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#222', textAlign: 'center' }}>Vill du ta bort projektet?</Text>\r\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\r\n                      <TouchableOpacity style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }} onPress={() => {/* TODO: Lägg till raderingslogik här */ setShowDeleteModal(false); }}>\r\n                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Ta bort</Text>\r\n                      </TouchableOpacity>\r\n                      <TouchableOpacity style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }} onPress={() => setShowDeleteModal(false)}>\r\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                </View>\r\n              </Modal>\r\n              {/* Modal: Extra varning om kontroller finns */}\r\n              <Modal visible={showDeleteWarning} transparent animationType=\"fade\" onRequestClose={() => setShowDeleteWarning(false)}>\r\n                <View style={styles.centerOverlay}>\r\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\r\n                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#D32F2F', textAlign: 'center' }}>Projektet har kontroller kopplade.\\nÄr du säker på att du vill ta bort projektet? Allt kommer att förloras.</Text>\r\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\r\n                      <TouchableOpacity style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }} onPress={() => {/* TODO: Lägg till raderingslogik här */ setShowDeleteWarning(false); }}>\r\n                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Ta bort</Text>\r\n                      </TouchableOpacity>\r\n                      <TouchableOpacity style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }} onPress={() => setShowDeleteWarning(false)}>\r\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                </View>\r\n              </Modal>\r\n        <View style={{ marginTop: 0, marginBottom: 0, alignItems: 'flex-start' }}>\r\n          <Text style={{ fontSize: 18, fontWeight: '600', textAlign: 'left', marginBottom: 12, color: '#263238', letterSpacing: 0.2 }}>\r\n            Utförda kontroller:\r\n          </Text>\r\n        </View>\r\n      </View>\r\n\r\n      {/* Sökfält för kontroller */}\r\n      <View style={{ marginBottom: 10 }}>\r\n        <TextInput\r\n          style={[styles.input, { marginBottom: 0 }]}\r\n          placeholder=\"Sök kontroller (t.ex. gips, arbetsmoment, leverans...)\"\r\n          placeholderTextColor=\"#888\"\r\n          value={searchText}\r\n          onChangeText={setSearchText}\r\n          autoCorrect={false}\r\n          autoCapitalize=\"none\"\r\n        />\r\n      </View>\r\n\r\n      {controls.length === 0 ? (\r\n        <Text style={[styles.noControls, { color: '#D32F2F' }]}>Inga kontroller utförda än</Text>\r\n      ) : (\r\n        <View>\r\n          {(() => {\r\n            // Filtrera kontroller baserat på söktext\r\n            const lowerSearch = (searchText || '').toLowerCase();\r\n            const filteredControls = !lowerSearch\r\n              ? controls\r\n              : controls.filter(c => {\r\n                  const fields = [c.deliveryDesc, c.materialDesc, c.generalNote, c.description, c.arbetsmoment];\r\n                  return fields.some(f => f && String(f).toLowerCase().includes(lowerSearch));\r\n                });\r\n            const grouped = controlTypes\r\n              .map((t) => ({ type: t, items: filteredControls.filter(c => (c.type || '') === t) }))\r\n              .filter(g => g.items.length > 0);\r\n\r\n            const toggleType = (t) => {\r\n              try { Haptics.selectionAsync(); } catch {}\r\n              setExpandedByType((prev) => ({ ...prev, [t]: !(prev[t] ?? false) }));\r\n            };\r\n\r\n            const pluralLabels = {\r\n              Arbetsberedning: 'Arbetsberedningar',\r\n              Egenkontroll: 'Egenkontroller',\r\n              Fuktmätning: 'Fuktmätningar',\r\n              Skyddsrond: 'Skyddsronder',\r\n              Riskbedömning: 'Riskbedömningar',\r\n            };\r\n\r\n            // Helper: count open/total deviations in a Skyddsrond.\r\n            // Supports both newer schema (checklist + remediation keyed by point text)\r\n            // and legacy schema (checklistSections + remediation indexed by point index).\r\n            function getSkyddsrondDeviationStats(ctrl) {\r\n              try {\r\n                const sections = Array.isArray(ctrl?.checklist)\r\n                  ? ctrl.checklist\r\n                  : (Array.isArray(ctrl?.checklistSections) ? ctrl.checklistSections : null);\r\n                if (!Array.isArray(sections) || sections.length === 0) return { total: 0, open: 0 };\r\n\r\n                let total = 0;\r\n                let open = 0;\r\n                for (const section of sections) {\r\n                  if (!section || !Array.isArray(section.statuses)) continue;\r\n                  const points = Array.isArray(section.points) ? section.points : [];\r\n                  for (let i = 0; i < section.statuses.length; i++) {\r\n                    if (section.statuses[i] !== 'avvikelse') continue;\r\n                    total += 1;\r\n                    const pt = points[i];\r\n                    const rem = section.remediation\r\n                      ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[i]\r\n                      : null;\r\n                    if (!rem) open += 1;\r\n                  }\r\n                }\r\n                return { total, open };\r\n              } catch(e) {\r\n                return { total: 0, open: 0 };\r\n              }\r\n            }\r\n\r\n            // For group header: are ALL Skyddsrond controls handled?\r\n            return grouped.map(({ type, items }) => {\r\n              const t = type;\r\n              const typeMeta = (controlTypeOptions || []).find(o => o.type === t) || null;\r\n              let allHandled = true;\r\n              let anyDeviation = false;\r\n              let anyOpenDeviation = false;\r\n              if (t === 'Skyddsrond') {\r\n                const stats = (items || []).map(ctrl => getSkyddsrondDeviationStats(ctrl));\r\n                allHandled = stats.length > 0 && stats.every(s => s.total > 0 && s.open === 0);\r\n                anyDeviation = stats.some(s => s.total > 0);\r\n                anyOpenDeviation = stats.some(s => s.open > 0);\r\n              }\r\n              const expanded = expandedByType[t] ?? false;\r\n              return (\r\n                <View key={t} style={styles.groupContainer}>\r\n                  <TouchableOpacity style={styles.groupHeader} onPress={() => toggleType(t)}>\r\n                    <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>\r\n                      <MaterialIcons name={expanded ? 'expand-less' : 'expand-more'} size={22} color=\"#263238\" />\r\n                      {typeMeta ? (\r\n                        <Ionicons\r\n                          name={typeMeta.icon}\r\n                          size={18}\r\n                          color={typeMeta.color}\r\n                          style={{ marginLeft: 8 }}\r\n                          accessibilityLabel={`${t} ikon`}\r\n                        />\r\n                      ) : null}\r\n                      <Text style={styles.groupTitle} numberOfLines={1} ellipsizeMode=\"tail\">{pluralLabels[t] || t}</Text>\r\n                    </View>\r\n\r\n                    {t === 'Skyddsrond' && anyOpenDeviation && (\r\n                      <TouchableOpacity\r\n                        onPress={(e) => {\r\n                          try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\r\n                          // Expand the group so the problematic rond becomes visible (and highlighted).\r\n                          setExpandedByType((prev) => ({ ...prev, [t]: true }));\r\n                        }}\r\n                        style={{ marginRight: 10, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600' }}\r\n                        activeOpacity={0.85}\r\n                        accessibilityLabel=\"Åtgärda\"\r\n                      >\r\n                        <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\r\n                      </TouchableOpacity>\r\n                    )}\r\n                    <View style={styles.groupBadge}><Text style={styles.groupBadgeText}>{items.length}</Text></View>\r\n                  </TouchableOpacity>\r\n                  {expanded ? (\r\n                    items\r\n                      .slice()\r\n                      .sort((a, b) => (b.date || '').localeCompare(a.date || ''))\r\n                      .map((item, idx) => {\r\n                        // ...existerande rendering av kontrollkortet...\r\n                        const isWeb = Platform.OS === 'web';\r\n                        const leadingIconSize = isWeb ? 20 : 22;\r\n                        const leadingIconMarginRight = isWeb ? 6 : 8;\r\n                        const trailingIconPadding = isWeb ? 4 : 6;\r\n                        const trailingIconMarginLeft = isWeb ? 6 : 8;\r\n                        let subtitle = null;\r\n                        let parsedDate = '';\r\n                        let label = '';\r\n                        if (item.type === 'Skyddsrond' || item.type === 'Riskbedömning') {\r\n                          let dateStr = '';\r\n                          if (item.date && item.date.length >= 10) {\r\n                            const d = new Date(item.date);\r\n                            if (!isNaN(d)) dateStr = d.toISOString().slice(0, 10);\r\n                          }\r\n                          if (!dateStr) dateStr = '(okänt datum)';\r\n                          const wy = getWeekAndYear(item.date || item.savedAt || item.createdAt || dateStr);\r\n                          const weekStr = wy && wy.week ? (wy.week < 10 ? '0' + wy.week : String(wy.week)) : '';\r\n                          label = (weekStr ? `V.${weekStr} - ` : '') + dateStr;\r\n                          subtitle = (item.deliveryDesc && String(item.deliveryDesc).trim())\r\n                            ? String(item.deliveryDesc).trim()\r\n                            : (item.materialDesc && String(item.materialDesc).trim()) ? String(item.materialDesc).trim()\r\n                            : (item.generalNote && String(item.generalNote).trim()) ? String(item.generalNote).trim()\r\n                            : (item.description && String(item.description).trim()) ? String(item.description).trim()\r\n                            : null;\r\n                        } else if (item.type === 'Mottagningskontroll') {\r\n                          const tryParse = (v) => {\r\n                            if (!v) return null;\r\n                            try {\r\n                              const d = new Date(v);\r\n                              if (!isNaN(d)) return d.toLocaleDateString('sv-SE');\r\n                            } catch(e) {}\r\n                            return null;\r\n                          };\r\n                          parsedDate = tryParse(item.date) || tryParse(item.dateValue) || tryParse(item.savedAt) || tryParse(item.createdAt) || tryParse(item.created) || '';\r\n                          if (!parsedDate && item.date) parsedDate = item.date;\r\n                          const dateLabel = parsedDate || '(okänt datum)';\r\n                          const wy = getWeekAndYear(parsedDate || item.date || item.savedAt || item.createdAt);\r\n                          const weekStr = wy && wy.week ? (wy.week < 10 ? '0' + wy.week : String(wy.week)) : '';\r\n                          const header = weekStr ? `V.${weekStr} - ${dateLabel}` : dateLabel;\r\n                          label = header;\r\n                          subtitle = (item.deliveryDesc && String(item.deliveryDesc).trim())\r\n                            ? String(item.deliveryDesc).trim()\r\n                            : (item.materialDesc && String(item.materialDesc).trim()) ? String(item.materialDesc).trim()\r\n                            : (item.generalNote && String(item.generalNote).trim()) ? String(item.generalNote).trim()\r\n                            : (item.description && String(item.description).trim()) ? String(item.description).trim()\r\n                            : null;\r\n                        } else {\r\n                          label = `${item.type}${item.date ? ' ' + item.date : ''}`;\r\n                          if (item.deliveryDesc && String(item.deliveryDesc).trim()) {\r\n                            label = `${label} — ${String(item.deliveryDesc).trim()}`;\r\n                          }\r\n                        }\r\n                        // Skyddsrond deviation status (open deviations => highlight)\r\n                        let hasDeviation = false;\r\n                        let allHandled = false;\r\n                        if (item.type === 'Skyddsrond') {\r\n                          const stats = getSkyddsrondDeviationStats(item);\r\n                          allHandled = stats.total > 0 && stats.open === 0;\r\n                          hasDeviation = stats.open > 0;\r\n                        }\r\n                        return (\r\n                          <View key={`${item.id || 'noid'}-${item.date || 'nodate'}-${idx}`} style={{ flexDirection: 'row', alignItems: 'center', width: '100%' }}>\r\n                            <TouchableOpacity\r\n                              style={[\r\n                                styles.controlCard,\r\n                                (Platform.OS === 'web' ? styles.controlCardWeb : null),\r\n                                (item.isDraft\r\n                                  ? { backgroundColor: '#fff', borderColor: '#222' }\r\n                                  : item.type === 'Skyddsrond' && hasDeviation\r\n                                    ? { backgroundColor: '#FFD600', borderColor: '#D32F2F', borderWidth: 2 }\r\n                                    : item.type === 'Skyddsrond' && allHandled\r\n                                      ? { backgroundColor: '#fff', borderColor: '#43A047', borderWidth: 2 }\r\n                                      : { backgroundColor: '#fff', borderColor: '#e0e0e0' }\r\n                                )\r\n                              ]}\r\n                              onPress={() => {\r\n                                if (item.isDraft) {\r\n                                  switch (item.type) {\r\n                                    case 'Arbetsberedning':\r\n                                      if (Platform.OS === 'web') openInlineControl('Arbetsberedning', item);\r\n                                      else navigation.navigate('ArbetsberedningScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    case 'Riskbedömning':\r\n                                      if (Platform.OS === 'web') openInlineControl('Riskbedömning', item);\r\n                                      else navigation.navigate('RiskbedömningScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    case 'Fuktmätning':\r\n                                      if (Platform.OS === 'web') openInlineControl('Fuktmätning', item);\r\n                                      else navigation.navigate('FuktmätningScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    case 'Egenkontroll':\r\n                                      if (Platform.OS === 'web') openInlineControl('Egenkontroll', item);\r\n                                      else navigation.navigate('EgenkontrollScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    case 'Mottagningskontroll':\r\n                                      if (Platform.OS === 'web') openInlineControl('Mottagningskontroll', item);\r\n                                      else navigation.navigate('MottagningskontrollScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    case 'Skyddsrond':\r\n                                      if (Platform.OS === 'web') openInlineControl('Skyddsrond', item);\r\n                                      else navigation.navigate('SkyddsrondScreen', { initialValues: item, project });\r\n                                      break;\r\n                                    default:\r\n                                      if (Platform.OS === 'web') openInlineControl(item.type, item);\r\n                                      else navigation.navigate('ControlForm', { initialValues: item, project });\r\n                                  }\r\n                                } else {\r\n                                  if (Platform.OS === 'web') {\r\n                                    openInlineControl('ControlDetails', { control: item });\r\n                                  } else {\r\n                                    navigation.navigate('ControlDetails', { control: item, project, companyId });\r\n                                  }\r\n                                }\r\n                              }}\r\n                              onLongPress={item.isDraft ? undefined : () => handleControlLongPress(item)}\r\n                              delayLongPress={item.isDraft ? undefined : 600}\r\n                            >\r\n                              {item.isDraft ? (\r\n                                <Ionicons name=\"document-text-outline\" size={leadingIconSize} color=\"#FFD600\" style={{ marginRight: leadingIconMarginRight }} />\r\n                              ) : item.type === 'Skyddsrond' ? (\r\n                                hasDeviation\r\n                                  ? <Ionicons name=\"alert-circle\" size={leadingIconSize} color=\"#D32F2F\" style={{ marginRight: leadingIconMarginRight }} />\r\n                                  : (\r\n                                    <Svg width={leadingIconSize} height={leadingIconSize} viewBox=\"0 0 24 24\" style={{ marginRight: leadingIconMarginRight }}>\r\n                                      <Circle cx={12} cy={12} r={10} fill=\"#43A047\" stroke=\"#222\" strokeWidth={1} />\r\n                                      <SvgText\r\n                                        x=\"12\"\r\n                                        y=\"13.5\"\r\n                                        fontSize=\"16\"\r\n                                        fontWeight=\"bold\"\r\n                                        fill=\"#fff\"\r\n                                        textAnchor=\"middle\"\r\n                                        alignmentBaseline=\"middle\"\r\n                                      >\r\n                                        ✓\r\n                                      </SvgText>\r\n                                    </Svg>\r\n                                  )\r\n                              ) : (\r\n                                <Svg width={leadingIconSize} height={leadingIconSize} viewBox=\"0 0 24 24\" style={{ marginRight: leadingIconMarginRight }}>\r\n                                  <Circle cx={12} cy={12} r={10} fill=\"#43A047\" stroke=\"#222\" strokeWidth={1} />\r\n                                  <SvgText\r\n                                    x=\"12\"\r\n                                    y=\"13.5\"\r\n                                    fontSize=\"16\"\r\n                                    fontWeight=\"bold\"\r\n                                    fill=\"#fff\"\r\n                                    textAnchor=\"middle\"\r\n                                    alignmentBaseline=\"middle\"\r\n                                  >\r\n                                    ✓\r\n                                  </SvgText>\r\n                                </Svg>\r\n                              )}\r\n                              <View style={(Platform.OS === 'web') ? styles.controlTextContainerWeb : styles.controlTextContainer}>\r\n                                {Platform.OS === 'web' ? (\r\n                                  <Text style={styles.controlLine} numberOfLines={1} ellipsizeMode=\"tail\">\r\n                                    <Text style={styles.controlTitleInlineWeb}>{label}</Text>\r\n                                    {subtitle ? <Text style={styles.controlSubtitleInline}> — {subtitle}</Text> : null}\r\n                                  </Text>\r\n                                ) : (\r\n                                  <>\r\n                                    <Text style={styles.controlTitle} numberOfLines={1} ellipsizeMode=\"tail\">{label}</Text>\r\n                                    {subtitle ? (\r\n                                      <Text style={styles.controlSubtitle} numberOfLines={1} ellipsizeMode=\"tail\">{subtitle}</Text>\r\n                                    ) : null}\r\n                                  </>\r\n                                )}\r\n                              </View>\r\n\r\n                              {Platform.OS === 'web' && !item.isDraft && item.type === 'Skyddsrond' && hasDeviation && (\r\n                                <TouchableOpacity\r\n                                  style={{ marginLeft: trailingIconMarginLeft, paddingVertical: 4, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600', alignSelf: 'center' }}\r\n                                  activeOpacity={0.85}\r\n                                  onPress={(e) => {\r\n                                    try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\r\n                                    navigation.navigate('ControlDetails', { control: item, project, companyId });\r\n                                  }}\r\n                                  accessibilityLabel=\"Åtgärda\"\r\n                                >\r\n                                  <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\r\n                                </TouchableOpacity>\r\n                              )}\r\n\r\n                              {/* Skriv ut-ikon (endast för slutförda) */}\r\n                              {!item.isDraft && (\r\n                                <TouchableOpacity\r\n                                  style={{ marginLeft: trailingIconMarginLeft, padding: trailingIconPadding }}\r\n                                  onPress={async (e) => {\r\n                                    e.stopPropagation && e.stopPropagation();\r\n                                    try {\r\n                                      setExportingPdf(true);\r\n                                      // Bygg HTML för EN kontroll\r\n                                      try {\r\n                                        console.log('[PDF] using buildSummaryHtml?', typeof buildSummaryHtml);\r\n                                        // Prepare logo (prefer company profile for PDF; try downloading + base64 embed)\r\n                                        let profile = companyProfile;\r\n                                        if (!profile && companyId) {\r\n                                          try {\r\n                                            profile = await fetchCompanyProfile(companyId);\r\n                                            if (profile) setCompanyProfile(profile);\r\n                                          } catch(e) {}\r\n                                        }\r\n                                        const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\r\n                                        const companyLogoFromProfile = profile?.logoUrl || null;\r\n                                        let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\r\n                                        if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\r\n                                          try {\r\n                                            const fileName = 'company-logo.single.png';\r\n                                            const dest = (FileSystem.cacheDirectory || FileSystem.documentDirectory) + fileName;\r\n                                            const dl = await FileSystem.downloadAsync(logoForPrint, dest);\r\n                                            if (dl?.uri) logoForPrint = dl.uri;\r\n                                          } catch(e) { console.warn('[PDF] download logo failed', e); }\r\n                                        }\r\n                                        let logoBase64 = null;\r\n                                        try {\r\n                                          logoBase64 = await readUriAsBase64(logoForPrint);\r\n                                          if (!logoBase64) {\r\n                                            try {\r\n                                              const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\r\n                                              await Asset.loadAsync(a);\r\n                                              const local = a.localUri || a.uri;\r\n                                              if (local) {\r\n                                                logoBase64 = await readUriAsBase64(local);\r\n                                                if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n                                              }\r\n                                            } catch(e) { /* ignore */ }\r\n                                          } else {\r\n                                            logoForPrint = 'data:image/png;base64,' + logoBase64;\r\n                                          }\r\n                                        } catch(e) { console.warn('[PDF] logo base64 convert failed', e); }\r\n\r\n                                        let html;\r\n                                        // Embed images for this item before building HTML\r\n                                        const embeddedItem = await embedImagesInControl(item);\r\n                                        if (typeof buildSummaryHtml === 'function') {\r\n                                          html = buildSummaryHtml('En', logoForPrint, [embeddedItem]);\r\n                                          } else {\r\n                                          console.warn('[PDF] buildSummaryHtml not found, falling back to type-aware builder');\r\n                                          const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\r\n                                          html = buildPdfHtmlForControl({ control: embeddedItem, project, company: companyObj });\r\n                                        }\r\n                                        // Generate PDF file and present share/save dialog instead of directly printing\r\n                                        const fileResult = await Print.printToFileAsync({ html });\r\n                                        const pdfUri = fileResult?.uri;\r\n                                        if (pdfUri) {\r\n                                          try {\r\n                                            // On iOS/Android this opens native share/save UI (Save to Files, etc.)\r\n                                            if (Sharing && Sharing.isAvailableAsync) {\r\n                                              const avail = await Sharing.isAvailableAsync();\r\n                                              if (avail) {\r\n                                                await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\r\n                                              } else {\r\n                                                // Fallback: just log path and show notice\r\n                                                console.log('[PDF] PDF generated at', pdfUri);\r\n                                                setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\r\n                                              }\r\n                                            } else {\r\n                                              console.log('[PDF] PDF generated at', pdfUri);\r\n                                              setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\r\n                                            }\r\n                                          } catch (shareErr) {\r\n                                            console.warn('[PDF] shareAsync failed, opening print dialog as fallback', shareErr);\r\n                                            await Print.printAsync({ uri: pdfUri });\r\n                                          }\r\n                                        } else {\r\n                                          throw new Error('printToFileAsync returned no uri');\r\n                                        }\r\n                                      } catch(e) {\r\n                                        console.warn('[PDF] single-item PDF generation failed, retrying without logo', err);\r\n                                        try {\r\n                                          let html2;\r\n                                          if (typeof buildSummaryHtml === 'function') {\r\n                                            html2 = buildSummaryHtml('En', null, [item]);\r\n                                          } else {\r\n                                            html2 = buildPdfHtmlForControl({ control: item, project, company: { name: companyNameForPdf } });\r\n                                          }\r\n                                          // Try generating file again without logo\r\n                                          const fileResult2 = await Print.printToFileAsync({ html: html2 });\r\n                                          const pdfUri2 = fileResult2?.uri;\r\n                                          if (pdfUri2) {\r\n                                            try {\r\n                                              const avail2 = await Sharing.isAvailableAsync();\r\n                                              if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\r\n                                              else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\r\n                                            } catch (shareErr2) {\r\n                                              console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\r\n                                              await Print.printAsync({ uri: pdfUri2 });\r\n                                            }\r\n                                          } else {\r\n                                            throw new Error('printToFileAsync retry returned no uri');\r\n                                          }\r\n                                        } catch (err2) {\r\n                                          console.error('[PDF] single-item print fallback failed', err2);\r\n                                          setNotice({ visible: true, text: 'Kunde inte generera eller dela PDF — se konsolen för detaljer' });\r\n                                        }\r\n                                      }\r\n                                    } finally {\r\n                                      setExportingPdf(false);\r\n                                    }\r\n                                  }}\r\n                                  accessibilityLabel=\"Exportera denna kontroll som PDF\"\r\n                                >\r\n                                  <Ionicons name=\"document-outline\" size={leadingIconSize} color=\"#1976D2\" />\r\n                                </TouchableOpacity>\r\n                              )}\r\n                              {/* Papperskorg-ikon med bekräftelsemodal (både för utkast och slutförda) */}\r\n                              <TouchableOpacity\r\n                                style={{ marginLeft: trailingIconMarginLeft, padding: trailingIconPadding }}\r\n                                onPress={(e) => {\r\n                                  e.stopPropagation && e.stopPropagation();\r\n                                  setDeleteConfirm({ visible: true, control: item });\r\n                                }}\r\n                                accessibilityLabel={item.isDraft ? \"Radera pågående kontroll\" : \"Radera denna kontroll\"}\r\n                              >\r\n                                <Ionicons name=\"trash-outline\" size={leadingIconSize} color=\"#D32F2F\" />\r\n                              </TouchableOpacity>\r\n\r\n                              {/* Modal för raderingsbekräftelse (läggs i JSX utanför listan) */}\r\n                              {/* Bekräftelsemodal för radering av kontroll */}\r\n                              <Modal\r\n                                visible={deleteConfirm.visible}\r\n                                transparent\r\n                                animationType=\"fade\"\r\n                                onRequestClose={() => setDeleteConfirm({ visible: false, control: null })}\r\n                              >\r\n                                <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.35)' }}>\r\n                                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\r\n                                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#D32F2F', textAlign: 'center' }}>\r\n                                      Vill du verkligen radera denna kontroll?\r\n                                    </Text>\r\n                                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\r\n                                      <TouchableOpacity\r\n                                        style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }}\r\n                                        onPress={handleDeleteSelectedControl}\r\n                                      >\r\n                                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Radera</Text>\r\n                                      </TouchableOpacity>\r\n                                      <TouchableOpacity\r\n                                        style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }}\r\n                                        onPress={() => setDeleteConfirm({ visible: false, control: null })}\r\n                                      >\r\n                                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\r\n                                      </TouchableOpacity>\r\n                                    </View>\r\n                                  </View>\r\n                                </View>\r\n                              </Modal>\r\n                            </TouchableOpacity>\r\n                          </View>\r\n                        );\r\n                      })\r\n                  ) : null}\r\n                </View>\r\n              );\r\n            });\r\n          })()}\r\n        </View>\r\n      )}\r\n\r\n      {/* Formulär */}\r\n      {showForm && (\r\n        <KeyboardAvoidingView\r\n          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\r\n          keyboardVerticalOffset={Platform.OS === 'ios' ? 80 : 0}\r\n          style={styles.form}\r\n        >\r\n          <Text style={styles.selectedType}>Vald kontroll: {newControl.type}</Text>\r\n\r\n          {/* Visa dagens datum och möjlighet att välja eget */}\r\n          <Text style={styles.infoText}>Dagens datum: {newControl.date}</Text>\r\n          <TouchableOpacity onPress={() => setNewControl({ ...newControl, date: '' })}>\r\n            <Text style={styles.linkText}>Välj eget datum</Text>\r\n          </TouchableOpacity>\r\n\r\n          <TextInput\r\n            style={styles.input}\r\n            placeholder=\"Datum (ÅÅÅÅ-MM-DD)\"\r\n            placeholderTextColor=\"#888\"\r\n            value={newControl.date}\r\n            onChangeText={(text) => setNewControl({ ...newControl, date: text })}\r\n            onFocus={() => {\r\n              setTimeout(() => {\r\n                if (scrollRef.current && typeof scrollRef.current.scrollToEnd === 'function') {\r\n                  try { scrollRef.current.scrollToEnd({ animated: true }); } catch {}\r\n                }\r\n              }, 50);\r\n            }}\r\n          />\r\n          <TextInput\r\n            style={styles.input}\r\n            placeholder={newControl.type === 'Skyddsrond' ? 'Skyddsrond omfattar' : 'Beskrivning'}\r\n            placeholderTextColor=\"#888\"\r\n            value={newControl.description}\r\n            onChangeText={(text) => setNewControl({ ...newControl, description: text })}\r\n            onFocus={() => {\r\n              setTimeout(() => {\r\n                if (scrollRef.current && typeof scrollRef.current.scrollToEnd === 'function') {\r\n                  try { scrollRef.current.scrollToEnd({ animated: true }); } catch {}\r\n                }\r\n              }, 50);\r\n            }}\r\n          />\r\n          <TouchableOpacity style={styles.saveButton} onPress={handleAddControl}>\r\n            <Text style={styles.saveButtonText}>Skapa kontroll</Text>\r\n          </TouchableOpacity>\r\n          <TouchableOpacity style={styles.cancelButton} onPress={() => { try { Haptics.selectionAsync(); } catch {}; setShowForm(false); }}>\r\n            <Text style={styles.cancelText}>Avbryt</Text>\r\n          </TouchableOpacity>\r\n        </KeyboardAvoidingView>\r\n      )}\r\n\r\n      {undoState.visible ? (\r\n        <View style={styles.undoBar}>\r\n          <Text style={styles.undoText}>Kontroll borttagen</Text>\r\n          <TouchableOpacity onPress={handleUndo}>\r\n            <Text style={styles.undoButtonText}>Ångra</Text>\r\n          </TouchableOpacity>\r\n        </View>\r\n      ) : null}\r\n\r\n      {notice.visible ? (\r\n        <View style={styles.noticeBar}>\r\n          <Text style={styles.noticeText}>{notice.text}</Text>\r\n        </View>\r\n      ) : null}\r\n\r\n      <Modal visible={showSummary} transparent animationType=\"fade\" onRequestClose={() => setShowSummary(false)}>\r\n        <TouchableOpacity style={styles.centerOverlay} activeOpacity={1} onPress={() => setShowSummary(false)}>\r\n          <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : 'height'} keyboardVerticalOffset={80}>\r\n            <View style={styles.summaryCard}>\r\n              {/* Stäng (X) knapp uppe till höger */}\r\n              <TouchableOpacity\r\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\r\n                onPress={() => { try { Haptics.selectionAsync(); } catch {}; setShowSummary(false); }}\r\n                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\r\n              >\r\n                <Ionicons name=\"close\" size={26} color=\"#222\" />\r\n              </TouchableOpacity>\r\n              <Text style={styles.modalText}>Skriv ut</Text>\r\n              {/* Export filter selector */}\r\n              {(() => {\r\n                const byType = controls.reduce((acc, c) => {\r\n                  const t = c.type || 'Okänd';\r\n                  (acc[t] = acc[t] || []).push(c);\r\n                  return acc;\r\n                }, {});\r\n                const types = Object.keys(byType).sort((a, b) => a.localeCompare(b));\r\n                if (types.length === 0) return null;\r\n                const labels = {\r\n                  Arbetsberedning: 'Arbetsberedningar',\r\n                  Egenkontroll: 'Egenkontroller',\r\n                  Fuktmätning: 'Fuktmätningar',\r\n                  Skyddsrond: 'Skyddsronder',\r\n                  Riskbedömning: 'Riskbedömningar',\r\n                };\r\n                return (\r\n                  <View style={styles.filterRow}>\r\n                    {['Alla', ...types].map((t) => (\r\n                      <TouchableOpacity\r\n                        key={t}\r\n                        onPress={() => { try { Haptics.selectionAsync(); } catch {}; setExportFilter(t); }}\r\n                        style={[styles.filterChip, exportFilter === t && styles.filterChipSelected]}\r\n                      >\r\n                        <Text style={[styles.filterChipText, exportFilter === t && styles.filterChipTextSelected]}>\r\n                          {t === 'Alla' ? 'Alla' : (labels[t] || t)}\r\n                        </Text>\r\n                      </TouchableOpacity>\r\n                    ))}\r\n                  </View>\r\n                );\r\n              })()}\r\n\r\n              <ScrollView style={{ maxHeight: 380 }}>\r\n                {/* Här kan du lägga till en preview av PDF-innehållet om du vill */}\r\n              </ScrollView>\r\n              <View style={{ marginTop: 10 }}>\r\n                <TouchableOpacity\r\n                  style={[\r\n                    {\r\n                      backgroundColor: '#fff',\r\n                      borderRadius: 8,\r\n                      borderWidth: 2,\r\n                      borderColor: '#222',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      height: 44,\r\n                      marginBottom: 8,\r\n                      opacity: exportingPdf || controls.length === 0 ? 0.7 : 1,\r\n                    },\r\n                  ]}\r\n                  onPress={handlePreviewPdf}\r\n                  disabled={exportingPdf || controls.length === 0}\r\n                >\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 14, letterSpacing: 0.2 }}>Förhandsvisa PDF</Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity\r\n                  style={[\r\n                    {\r\n                      backgroundColor: '#fff',\r\n                      borderRadius: 8,\r\n                      borderWidth: 2,\r\n                      borderColor: '#222',\r\n                      alignItems: 'center',\r\n                      justifyContent: 'center',\r\n                      height: 44,\r\n                      marginBottom: 8,\r\n                      opacity: exportingPdf || controls.length === 0 ? 0.7 : 1,\r\n                    },\r\n                  ]}\r\n                  onPress={handleExportPdf}\r\n                  disabled={exportingPdf || controls.length === 0}\r\n                >\r\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 14, letterSpacing: 0.2 }}>{exportingPdf ? 'Genererar…' : 'Exportera PDF'}</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </KeyboardAvoidingView>\r\n        </TouchableOpacity>\r\n      </Modal>\r\n    </ScrollView>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\RiskbedömningScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\Screens\\SkyddsrondScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":150,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":150,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":177,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":177,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useRoute } from '@react-navigation/native';\r\nimport BaseControlForm from '../components/BaseControlForm';\r\nimport { saveControlToFirestore } from '../components/firebase';\r\n// Skyddsrond checklist config: sections with control points\r\nconst SKYDDSROND_CHECKLIST = [\r\n  {\r\n    label: 'Allmän ordning och reda',\r\n    points: [\r\n      'Är gångvägar och arbetsytor fria från hinder?',\r\n      'Är material och verktyg rätt placerade?',\r\n      'Är städning tillfredsställande?',\r\n      'KMA tavla finns på plats?',\r\n      'Arbetsmiljöplan är signerad av beställare?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Fallrisker och ställningar',\r\n    points: [\r\n      'Finns skyddsräcken där det behövs?',\r\n      'Är ställningar och stegar i gott skick?',\r\n      'Är öppningar och hål skyddade?',\r\n      'Övertagning av ställning har signerats och finns på plats',\r\n      'Sparkskydd finns monterade'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Personlig skyddsutrustning',\r\n    points: [\r\n      'Används hjälm, skyddsskor och väst?',\r\n      'Finns behov av hörselskydd, ögonskydd eller handskar?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Maskiner och verktyg',\r\n    points: [\r\n      'Är maskiner och verktyg hela och rätt använda?',\r\n      'Finns skydd på maskiner där det krävs?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'El och belysning',\r\n    points: [\r\n      'Är provisorisk el korrekt dragen?',\r\n      'Är kablar hela och rätt placerade?',\r\n      'Är arbetsbelysning tillräcklig?',\r\n      'Ledlister och elkablar sitter upphängda i den mån det går?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Kemi och farliga ämnen',\r\n    points: [\r\n      'Förvaras kemikalier och farliga ämnen säkert?',\r\n      'Är märkning och skyddsutrustning på plats?',\r\n      'Kemikaliepärm finns på plats?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Brandskydd',\r\n    points: [\r\n      'Finns brandsläckare och brandfilt?',\r\n      'Är brandsläckare besiktigade och godkända?',\r\n      'Är utrymningsvägar fria och skyltade?',\r\n      'Brandfarliga arbeten hanteras korrekt?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Lyft och transporter',\r\n    points: [\r\n      'Används rätt lyftanordningar?',\r\n      'Är kranar och truckar besiktigade?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Första hjälpen och olycksberedskap',\r\n    points: [\r\n      'Finns förbandslåda och rutiner?',\r\n      'Behöver förbandslådor fyllas på med material?',\r\n      'Nödsituation och skyddsorganisation finns anslaget?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Skyltning och avspärrningar',\r\n    points: [\r\n      'Finns nödvändiga varningsskyltar?',\r\n      'Är riskområden avspärrade?'\r\n    ]\r\n  },\r\n  {\r\n    label: 'Miljö',\r\n    points: [\r\n      'Hanteras avfall och spill korrekt?',\r\n      'Avfallscontainer är skyltade med fraktioner?',\r\n      'Förebyggs utsläpp?'\r\n    ]\r\n  }\r\n];\r\n\r\n\r\nfunction getWeekAndYear(dateInput) {\r\n  const d = dateInput ? new Date(dateInput) : new Date();\r\n  d.setHours(0, 0, 0, 0);\r\n  // Thursday in current week decides the year.\r\n  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));\r\n  const week1 = new Date(d.getFullYear(), 0, 4);\r\n  // Calculate full weeks to nearest Thursday\r\n  const weekNo = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);\r\n  return { week: weekNo, year: d.getFullYear() };\r\n}\r\n\r\n\r\n\r\nexport default function SkyddsrondScreen({\r\n  date,\r\n  participants = [],\r\n  project: projectProp,\r\n  initialValues: initialValuesProp,\r\n  onExit,\r\n  onFinished,\r\n}) {\r\n  const route = useRoute();\r\n  const project = projectProp ?? route.params?.project;\r\n  const initialValuesRaw = (initialValuesProp ?? route.params?.initialValues) || {};\r\n  const initialValues = {\r\n    ...initialValuesRaw,\r\n    mottagningsSignatures: initialValuesRaw.mottagningsSignatures || [],\r\n  };\r\n  const { week, year } = getWeekAndYear(date);\r\n  const LABELS = {\r\n    title: `Skyddsrond ${year} V.${week < 10 ? '0' + week : week}`,\r\n    saveButton: 'Spara',\r\n    saveDraftButton: 'Spara och slutför senare',\r\n  };\r\n\r\n  const handleSave = async (data) => {\r\n    try {\r\n      const completed = {\r\n        ...data,\r\n        project: data.project || project,\r\n        status: 'UTFÖRD',\r\n        savedAt: new Date().toISOString(),\r\n        type: 'Skyddsrond',\r\n        id: data.id || require('uuid').v4(),\r\n      };\r\n      // Try saving to Firestore first (best-effort). If Firestore fails, fall back to local AsyncStorage.\r\n      try {\r\n        const ok = await saveControlToFirestore(completed);\r\n        if (!ok) throw new Error('Firestore save failed');\r\n      } catch(e) {\r\n        // fallback to local storage below\r\n      }\r\n      const existing = await AsyncStorage.getItem('completed_controls');\r\n      let arr = [];\r\n      if (existing) arr = JSON.parse(existing);\r\n      // Ersätt befintlig kontroll med samma id, annars lägg till\r\n      const idx = arr.findIndex(c => c.id === completed.id);\r\n      if (idx !== -1) {\r\n        arr[idx] = completed;\r\n      } else {\r\n        arr.push(completed);\r\n      }\r\n      await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\r\n      // Remove any matching drafts for this project+type\r\n      try {\r\n        const draftRaw = await AsyncStorage.getItem('draft_controls');\r\n        if (draftRaw) {\r\n          let drafts = JSON.parse(draftRaw) || [];\r\n          // If we have an id, remove only that draft. Otherwise remove drafts matching project+type.\r\n          if (data && data.id) {\r\n            drafts = drafts.filter(d => !(d.id === data.id && d.project?.id === project?.id && d.type === 'Skyddsrond'));\r\n          } else {\r\n            drafts = drafts.filter(d => !(d.project?.id === project?.id && d.type === 'Skyddsrond'));\r\n          }\r\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\r\n        }\r\n      } catch(e) {}\r\n      // ...existing code...\r\n    } catch(e) {\r\n      alert('Kunde inte spara kontrollen: ' + e.message);\r\n    }\r\n  };\r\n\r\n  const handleSaveDraft = async (data) => {\r\n    // Persistence is handled centrally in BaseControlForm.saveDraftControl().\r\n    // This screen should not write to AsyncStorage to avoid overwriting richer\r\n    // draft objects maintained by the form (which include photos, participants).\r\n    // ...existing code...\r\n  };\r\n\r\n  const WEATHER_OPTIONS = [\r\n    { key: 'Soligt', icon: 'sunny' },\r\n    { key: 'Delvis molnigt', icon: 'partly-sunny' },\r\n    { key: 'Molnigt', icon: 'cloudy' },\r\n    { key: 'Regn', icon: 'rainy' },\r\n    { key: 'Snö', icon: 'snow' },\r\n    { key: 'Åska', icon: 'thunderstorm' },\r\n  ];\r\n\r\n  return (\r\n    <BaseControlForm\r\n      date={date}\r\n      controlType=\"Skyddsrond\"\r\n      labels={LABELS}\r\n      participants={participants}\r\n      initialValues={initialValues}\r\n      project={project}\r\n      onSave={handleSave}\r\n      onSaveDraft={handleSaveDraft}\r\n      weatherOptions={WEATHER_OPTIONS}\r\n      checklistConfig={SKYDDSROND_CHECKLIST}\r\n      onExit={onExit}\r\n      onFinished={onFinished}\r\n    />\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\babel.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\BaseControlForm.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":57,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":69,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'clearAllPhotos' is assigned a value but never used.","line":246,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":246,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"clearAllPhotos"},"fix":{"range":[8592,8940],"text":""},"desc":"Remove unused variable 'clearAllPhotos'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'signerKeyboardShift' is assigned a value but never used.","line":258,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":258,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"signerKeyboardShift"},"fix":{"range":[9075,9094],"text":""},"desc":"Remove unused variable 'signerKeyboardShift'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":266,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":266,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'setQualityDesc' is assigned a value but never used.","line":289,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":289,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQualityDesc"},"fix":{"range":[10402,10418],"text":""},"desc":"Remove unused variable 'setQualityDesc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setCoverageDesc' is assigned a value but never used.","line":290,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":290,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCoverageDesc"},"fix":{"range":[10487,10504],"text":""},"desc":"Remove unused variable 'setCoverageDesc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'visibleTint' is assigned a value but never used.","line":307,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":307,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"visibleTint"},"fix":{"range":[11520,11614],"text":""},"desc":"Remove unused variable 'visibleTint'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onTintColor' is assigned a value but never used.","line":308,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":308,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"onTintColor"},"fix":{"range":[11618,11706],"text":""},"desc":"Remove unused variable 'onTintColor'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":338,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":338,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":342,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":342,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":381,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":381,"endColumn":51},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":401,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":401,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":409,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":409,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":410,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":410,"endColumn":58},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":411,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":411,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":419,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":419,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":426,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":426,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":432,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":432,"endColumn":74},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":433,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":433,"endColumn":88},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":476,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":476,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":492,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":492,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":529,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":529,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":636,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":636,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'dateValue', 'initialValues', and 'todayIso'. Either include them or remove the dependency array.","line":805,"column":6,"nodeType":"ArrayExpression","endLine":805,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [date, dateValue, initialValues, todayIso]","fix":{"range":[35619,35662],"text":"[date, dateValue, initialValues, todayIso]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":805,"column":13,"nodeType":"LogicalExpression","endLine":805,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'setGeneralNote' is assigned a value but never used.","line":807,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":807,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setGeneralNote"},"fix":{"range":[35792,35808],"text":""},"desc":"Remove unused variable 'setGeneralNote'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'participantsLabel'. Either include it or remove the dependency array.","line":844,"column":6,"nodeType":"ArrayExpression","endLine":844,"endColumn":115,"suggestions":[{"desc":"Update the dependencies array to be: [missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures, participantsLabel]","fix":{"range":[37625,37734],"text":"[missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures, participantsLabel]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'shallowEqual'. Either include it or remove the dependency array.","line":861,"column":6,"nodeType":"ArrayExpression","endLine":861,"endColumn":426,"suggestions":[{"desc":"Update the dependencies array to be: [shallowEqual, localParticipants, initialParticipants, checklist, initialChecklist, dateValue, initialDate, selectedWeather, initialWeather, byggdel, initialByggdel, deliveryDesc, initialDeliveryDesc, generalNote, initialGeneralNote, materialDesc, initialMaterialDesc, qualityDesc, initialQualityDesc, coverageDesc, initialCoverageDesc, mottagningsSignatures, initialMottagningsSignatures, mottagningsPhotos, initialMottagningsPhotos]","fix":{"range":[38641,39061],"text":"[shallowEqual, localParticipants, initialParticipants, checklist, initialChecklist, dateValue, initialDate, selectedWeather, initialWeather, byggdel, initialByggdel, deliveryDesc, initialDeliveryDesc, generalNote, initialGeneralNote, materialDesc, initialMaterialDesc, qualityDesc, initialQualityDesc, coverageDesc, initialCoverageDesc, mottagningsSignatures, initialMottagningsSignatures, mottagningsPhotos, initialMottagningsPhotos]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showCreateByggdelMoment' is assigned a value but never used.","line":896,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":896,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"showCreateByggdelMoment"},"fix":{"range":[41736,41759],"text":""},"desc":"Remove unused variable 'showCreateByggdelMoment'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'newByggdelMomentName' is assigned a value but never used.","line":897,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":897,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"newByggdelMomentName"},"fix":{"range":[41818,41838],"text":""},"desc":"Remove unused variable 'newByggdelMomentName'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'createMallKeyboardHeight'. Either include it or remove the dependency array.","line":906,"column":6,"nodeType":"ArrayExpression","endLine":906,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [createMallKeyboardHeight, showCreateByggdelMallModal]","fix":{"range":[42365,42393],"text":"[createMallKeyboardHeight, showCreateByggdelMallModal]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":923,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":923,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":924,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":924,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":944,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":944,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":945,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":945,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":950,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":950,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":962,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":962,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1111,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1111,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1121,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":1121,"endColumn":42},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1128,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1128,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1132,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1132,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1193,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1193,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1217,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1217,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1291,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1291,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1345,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1345,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'applySelectedCategoriesToChecklist', 'checklist', and 'project'. Either include them or remove the dependency array.","line":1347,"column":6,"nodeType":"ArrayExpression","endLine":1347,"endColumn":74,"suggestions":[{"desc":"Update the dependencies array to be: [controlType, checklistConfig, initialValues, project, checklist, applySelectedCategoriesToChecklist]","fix":{"range":[62919,62987],"text":"[controlType, checklistConfig, initialValues, project, checklist, applySelectedCategoriesToChecklist]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":1347,"column":20,"nodeType":"LogicalExpression","endLine":1347,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1417,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1417,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'defaultByggdelMomentsByGroup' and 'project'. Either include them or remove the dependency array.","line":1421,"column":6,"nodeType":"ArrayExpression","endLine":1421,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [controlType, defaultByggdelMomentsByGroup, project]","fix":{"range":[65876,65912],"text":"[controlType, defaultByggdelMomentsByGroup, project]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":1421,"column":20,"nodeType":"LogicalExpression","endLine":1421,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1469,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":1469,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1476,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1476,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1480,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1480,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1579,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":1579,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1581,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1581,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1587,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1587,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1596,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1596,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1624,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1624,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1637,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1637,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'processCameraResult' function makes the dependencies of useEffect Hook (at line 1868) change on every render. To fix this, wrap the definition of 'processCameraResult' in its own useCallback() Hook.","line":1660,"column":9,"nodeType":"VariableDeclarator","endLine":1811,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'processCameraResult' in its own useCallback() Hook.","fix":{"range":[77838,85193],"text":"useCallback((cameraResult) => {\r\n    if (!cameraResult) return;\r\n    // ...existing code...\r\n    const { uri, sectionIdx, pointIdx, returnedMottagningsPhotos } = cameraResult;\r\n    if (returnedMottagningsPhotos && Array.isArray(returnedMottagningsPhotos)) {\r\n      try {\r\n        const norm = normalizePhotos(returnedMottagningsPhotos);\r\n        // Filter duplicates by uri\r\n        const prev = mottagningsPhotosRef.current || [];\r\n        const existingUris = new Set(prev.map(p => p && p.uri).filter(Boolean));\r\n        const toAdd = norm.filter(p => p && p.uri && !existingUris.has(p.uri));\r\n        // Attach any new returned photo URIs to the specific checklist point (if provided)\r\n        try {\r\n          if (sectionIdx !== undefined && pointIdx !== undefined) {\r\n            const urisToAttach = toAdd.map(p => p.uri).filter(Boolean);\r\n              if (urisToAttach.length > 0) {\r\n              // ...existing code...\r\n              const prevChecklist = checklistRef.current || [];\r\n              const updated = prevChecklist.map((section, sIdx) => {\r\n                if (sIdx !== sectionIdx) return section;\r\n                const points = Array.isArray(section.points) ? section.points : [];\r\n                let photos = Array.isArray(section.photos) && section.photos.length === points.length\r\n                  ? [...section.photos]\r\n                  : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\r\n                photos[pointIdx] = Array.isArray(photos[pointIdx]) ? photos[pointIdx] : [];\r\n                photos[pointIdx] = [...photos[pointIdx], ...urisToAttach];\r\n                return { ...section, photos, points };\r\n              });\r\n              setChecklist(updated);\r\n              checklistRef.current = updated;\r\n              setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\r\n              // Persist draft with updated checklist (merge/upsert to avoid overwriting richer state)\r\n              (async () => {\r\n                try {\r\n                  const toSaveId = draftId || uuidv4();\r\n                  try { setDraftId(toSaveId); } catch(e) {}\r\n                  const draftObj = {\r\n                    id: toSaveId,\r\n                    date: dateValue,\r\n                    project,\r\n                    ...weatherPayload,\r\n                    byggdel,\r\n                    byggdelTemplate,\r\n                    participants: localParticipants,\r\n                    materialDesc,\r\n                    qualityDesc,\r\n                    coverageDesc,\r\n                    mottagningsSignatures,\r\n                    mottagningsPhotos,\r\n                    checklist: updated,\r\n                    expandedChecklist,\r\n                    deliveryDesc,\r\n                    generalNote,\r\n                    type: controlType,\r\n                    savedAt: new Date().toISOString(),\r\n                  };\r\n                  try {\r\n                    await persistDraftObject(draftObj);\r\n                    // ...existing code...\r\n                  } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\r\n                } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\r\n              })();\r\n            }\r\n          }\r\n        } catch(e) {}\r\n        if (toAdd.length === 0) {\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n          return;\r\n        }\r\n        setMottagningsPhotos(prevState => {\r\n          const next = [...(prevState || []), ...toAdd];\r\n          mottagningsPhotosRef.current = next;\r\n          return next;\r\n        });\r\n        // ...existing code...\r\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n      } catch(e) {}\r\n    } else if (uri) {\r\n      if (processedCameraUrisRef.current.has(uri)) {\r\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n        return;\r\n      }\r\n      if (controlType === 'Mottagningskontroll') {\r\n        try {\r\n          processedCameraUrisRef.current.add(uri);\r\n          setMottagningsPhotos(prev => {\r\n            const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\r\n            // avoid duplicates\r\n            if (prevArr.findIndex(x => x && x.uri === uri) !== -1) return prevArr;\r\n            const newItem = { uri, comment: '' };\r\n            const next = [...prevArr, newItem];\r\n            mottagningsPhotosRef.current = next;\r\n            return next;\r\n          });\r\n          try { console.log('[BaseControlForm] appended uri to mottagningsPhotos, item:', uri); } catch(e) {}\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n        } catch(e) {}\r\n      } else if (sectionIdx !== undefined && pointIdx !== undefined) {\r\n        try {\r\n          const prev = checklistRef.current || [];\r\n          const newChecklist = prev.map((section, sIdx) => {\r\n            if (sIdx !== sectionIdx) return section;\r\n            const points = Array.isArray(section.points) ? section.points : [];\r\n            let photos = Array.isArray(section.photos) && section.photos.length === points.length\r\n              ? [...section.photos]\r\n              : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\r\n            if (!Array.isArray(photos[pointIdx])) photos[pointIdx] = photos[pointIdx] ? [photos[pointIdx]] : [];\r\n            photos[pointIdx] = [...photos[pointIdx], uri];\r\n            return { ...section, photos, points };\r\n          });\r\n          setChecklist(newChecklist);\r\n          checklistRef.current = newChecklist;\r\n          setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n          // Persist updated checklist (including photos) to draft controls immediately so\r\n          // photos added from CameraCapture are not lost if the user navigates away.\r\n          (async () => {\r\n            try {\r\n              const toSaveId = draftId || uuidv4();\r\n              try { setDraftId(toSaveId); } catch(e) {}\r\n              const draftObj = {\r\n                id: toSaveId,\r\n                date: dateValue,\r\n                project,\r\n                ...weatherPayload,\r\n                byggdel,\r\n                byggdelTemplate,\r\n                participants: localParticipants,\r\n                materialDesc,\r\n                qualityDesc,\r\n                coverageDesc,\r\n                mottagningsSignatures,\r\n                mottagningsPhotos,\r\n                checklist: newChecklist,\r\n                expandedChecklist,\r\n                deliveryDesc,\r\n                generalNote,\r\n                type: controlType,\r\n                savedAt: new Date().toISOString(),\r\n              };\r\n              try {\r\n                await persistDraftObject(draftObj);\r\n                try { console.log('[BaseControlForm] persisted draft after uri add, id:', draftObj.id); } catch(e) {}\r\n              } catch(e) { try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {} }\r\n            } catch(e) {\r\n              try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {}\r\n            }\r\n          })();\r\n        } catch(e) {}\r\n      }\r\n    }\r\n  })"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1695,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":1695,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1719,"column":112,"nodeType":"Identifier","messageId":"unusedVar","endLine":1719,"endColumn":113},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1720,"column":110,"nodeType":"Identifier","messageId":"unusedVar","endLine":1720,"endColumn":111},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1724,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1724,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1726,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1726,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1735,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":1735,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1736,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1736,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1739,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":1739,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1754,"column":105,"nodeType":"Identifier","messageId":"unusedVar","endLine":1754,"endColumn":106},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1755,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1755,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1756,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1756,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1773,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1773,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1779,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":1779,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1802,"column":113,"nodeType":"Identifier","messageId":"unusedVar","endLine":1802,"endColumn":114},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1803,"column":109,"nodeType":"Identifier","messageId":"unusedVar","endLine":1803,"endColumn":110},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1805,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":1805,"endColumn":97},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1808,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1808,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'processCameraResult'. Either include it or remove the dependency array.","line":1819,"column":6,"nodeType":"ArrayExpression","endLine":1819,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [processCameraResult, route.params?.cameraResult]","fix":{"range":[85509,85537],"text":"[processCameraResult, route.params?.cameraResult]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'prev' is assigned a value but never used.","line":1837,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1837,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"prev"},"fix":{"range":[86379,86460],"text":""},"desc":"Remove unused variable 'prev'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1839,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1839,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1841,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1841,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'processCameraResult'. Either include it or remove the dependency array.","line":1847,"column":6,"nodeType":"ArrayExpression","endLine":1847,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [navigation, processCameraResult, route.key]","fix":{"range":[86789,86812],"text":"[navigation, processCameraResult, route.key]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1859,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":1859,"endColumn":61},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1862,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1862,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1900,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1900,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1907,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1907,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1916,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1916,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1970,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":1970,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1979,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1979,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1981,"column":94,"nodeType":"Identifier","messageId":"unusedVar","endLine":1981,"endColumn":95},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1988,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":1988,"endColumn":68},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2008,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2008,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2058,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2058,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2062,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2062,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2067,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2067,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2069,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":2069,"endColumn":53},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2085,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2085,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2146,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2146,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2147,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":2147,"endColumn":49},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2150,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":2150,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2160,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2160,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2162,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2162,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2258,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2258,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2321,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":2321,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2451,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2451,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2786,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":2786,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2975,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":2975,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3736,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":3736,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3883,"column":81,"nodeType":"Identifier","messageId":"unusedVar","endLine":3883,"endColumn":82},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4162,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4162,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4460,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4460,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4522,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":4522,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'showGreenCheck' is assigned a value but never used.","line":4529,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":4529,"endColumn":33},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4541,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":4541,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'total' is assigned a value but never used.","line":4569,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":4569,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"total"},"fix":{"range":[258652,258701],"text":""},"desc":"Remove unused variable 'total'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4619,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":4619,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4620,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":4620,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4631,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":4631,"endColumn":34},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4643,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":4643,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4825,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":4825,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4841,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":4841,"endColumn":46},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5056,"column":181,"nodeType":"Identifier","messageId":"unusedVar","endLine":5056,"endColumn":182},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5064,"column":159,"nodeType":"Identifier","messageId":"unusedVar","endLine":5064,"endColumn":160},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5075,"column":160,"nodeType":"Identifier","messageId":"unusedVar","endLine":5075,"endColumn":161},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5205,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":5205,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5206,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":5206,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5235,"column":123,"nodeType":"Identifier","messageId":"unusedVar","endLine":5235,"endColumn":124},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5259,"column":62,"nodeType":"Identifier","messageId":"unusedVar","endLine":5259,"endColumn":63},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5262,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":5262,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":130,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\r\n\r\n\r\n\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { useNavigation, useRoute } from '@react-navigation/native';\r\nimport { useEffect, useMemo, useRef, useState } from 'react';\r\n\r\n// import BottomSheet from '@gorhom/bottom-sheet';\r\nimport { Alert, Dimensions, Image, InteractionManager, Keyboard, KeyboardAvoidingView, LayoutAnimation, Modal, PanResponder, Platform, Pressable, ScrollView, Text, TextInput, TouchableOpacity, UIManager, useColorScheme, useWindowDimensions, View } from 'react-native';\r\n\r\nimport Ionicons from '@expo/vector-icons/Ionicons';\r\nimport MaterialIcons from '@expo/vector-icons/MaterialIcons';\r\nimport * as ImagePicker from 'expo-image-picker';\r\nimport 'react-native-get-random-values';\r\nimport Svg, { Path } from 'react-native-svg';\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { Colors } from '../constants/theme';\r\nimport { createByggdelMall, deleteByggdelMall, deleteDraftControlFromFirestore, fetchByggdelHierarchy, fetchByggdelMallar, saveByggdelHierarchy, saveDraftToFirestore, updateByggdelMall } from './firebase';\r\n\r\nexport default function BaseControlForm({\r\n  project,\r\n  participants = [],\r\n  date,\r\n  weatherOptions = [],\r\n  checklistConfig = [],\r\n  controlType = '',\r\n  labels = {},\r\n  onSave,\r\n  onSaveDraft,\r\n  onExit,\r\n  onFinished,\r\n  initialValues = {},\r\n  hideWeather = false,\r\n}) {\r\n  const { height: windowHeight } = useWindowDimensions();\r\n  const onExitRef = useRef(onExit);\r\n  useEffect(() => {\r\n    onExitRef.current = onExit;\r\n  }, [onExit]);\r\n\r\n  const arbetsberedningCategoryKey = (projectId) => `dk_ab_categories_${String(projectId || '').trim()}`;\r\n  const arbetsberedningActiveByggdelKey = (projectId) => `dk_ab_active_byggdel_${String(projectId || '').trim()}`;\r\n  const didInitArbetsberedningCategoriesRef = useRef(false);\r\n  const loadedAktivaByggdelPidRef = useRef('');\r\n\r\n  const suppressNextMallPressRef = useRef(false);\r\n  const formatByggdelLabelFromTemplate = (tpl) => {\r\n    try {\r\n      if (!tpl) return '';\r\n      const hg = tpl.huvudgrupp || '';\r\n      const mm = tpl.moment || '';\r\n      const nm = tpl.mallName || tpl.name || '';\r\n      const parts = [hg, mm, nm].map(x => String(x || '').trim()).filter(Boolean);\r\n      return parts.join(' / ');\r\n    } catch(e) {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  const formatByggdelMomentLabelFromTemplate = (tpl) => {\r\n    try {\r\n      if (!tpl) return '';\r\n      const hg = tpl.huvudgrupp || '';\r\n      const mm = tpl.moment || '';\r\n      const parts = [hg, mm].map(x => String(x || '').trim()).filter(Boolean);\r\n      return parts.join(' / ');\r\n    } catch(e) {\r\n      return '';\r\n    }\r\n  };\r\n\r\n  const fixedByggdelHuvudgrupper = useMemo(() => (\r\n    [\r\n      '0 - Sammansatta byggdelar',\r\n      '1 - Mark',\r\n      '2 - Husunderbyggnad',\r\n      '3 - Stomme',\r\n      '4 - Yttertak',\r\n      '5 - Fasad',\r\n      '6 - Stomkomplettering',\r\n      '7 - Invändiga ytskikt',\r\n      '8 - Installationer',\r\n      '9 - Gemensamma arbeten',\r\n    ]\r\n  ), []);\r\n\r\n  const byggdelHuvudgruppOptions = fixedByggdelHuvudgrupper;\r\n\r\n  const defaultByggdelMomentsByGroup = useMemo(() => (\r\n    {\r\n      // Prefer numeric prefix keys so labels can change without breaking lookups\r\n      '0': ['03 - Rivning', '06 - Håltagning'],\r\n      '1': ['10 - Markarbeten'],\r\n      '2': ['23 - Markförstärkningar', '24 - Grundkonstruktioner', '25 - Kulvert', '27 - Platta på mark'],\r\n      '3': [\r\n        '30 - Sammansatta',\r\n        '31 - Väggar',\r\n        '32 - Pelare',\r\n        '33 - Prefab',\r\n        '34 - Bjälklag/Balkar',\r\n        '35 - Smide',\r\n        '36 - Trappor/Hiss/Schakt',\r\n        '37 - Samverkande takstomme',\r\n        '38 - Huskomplettering',\r\n        '39 - Hall/UE (Tätt hus)',\r\n      ],\r\n      '4': [\r\n        '40 - Sammansatta',\r\n        '41 - Takstomme',\r\n        '42 - Taklagskomplettering',\r\n        '43 - Taktäckning',\r\n        '44 - Takfot & gavlar',\r\n        '45 - Öppningskomplettering (takluckor)',\r\n        '47 - Terrasser/altaner',\r\n        '48 - Huskomplettering',\r\n        '49 - Plåt',\r\n      ],\r\n      '5': [\r\n        '50 - Sammansatta',\r\n        '51 - Stomkomplettering (utfackning)',\r\n        '53 - Fasadbeklädnad/ytskikt',\r\n        '55 - Fönster/dörrar/partier',\r\n        '56 - Utvändiga trappor',\r\n        '58 - Huskomplettering',\r\n      ],\r\n      '6': [\r\n        '60 - Sammansatta',\r\n        '61 - Insida yttervägg',\r\n        '62 - Undergolv',\r\n        '63 - Innerväggar',\r\n        '64 - Innertak',\r\n        '65 - Invändiga dörrar & partier',\r\n        '66 - Invändiga trappor',\r\n        '67 - Brandskydd',\r\n        '68 - Huskomplettering',\r\n        '69 - Lås & passer',\r\n      ],\r\n      '7': [\r\n        '70 - Sammansatta',\r\n        '71 - Kakel/klinkers/keramik',\r\n        '72 - Ytskikt golv & trappor',\r\n        '73 - Ytskikt vägg',\r\n        '74 - Ytskikt tak/undertak',\r\n        '75 - Målning',\r\n        '76 - Vita varor',\r\n        '77 - Skåp & inredningssnickerier',\r\n        '78 - Rumskomplettering/övrigt',\r\n      ],\r\n      '8': [\r\n        '80 - Sammansatta',\r\n        '81 - Sprinkler',\r\n        '82 - Process',\r\n        '83 - Storkök',\r\n        '84 - Sanitet/värme',\r\n        '85 - Luft',\r\n        '86 - El',\r\n        '87 - Transport',\r\n        '88 - Styr',\r\n        '89 - Kyla',\r\n      ],\r\n      '9': [\r\n        '90 - Hyresmaskiner',\r\n        '91 - Gemensamma arbeten',\r\n        '92 - Ställningar',\r\n        '94 - Kran & lyft',\r\n        '96 - Bodar/etablering',\r\n        '98 - Konsulter',\r\n        '99 - TJ-tid',\r\n      ],\r\n    }\r\n  ), []);\r\n\r\n  const mergeByggdelMomentsByGroup = (existing) => {\r\n    const safeExisting = (existing && typeof existing === 'object') ? existing : {};\r\n    let changed = false;\r\n    const merged = { ...safeExisting };\r\n\r\n    const mergeList = (current, additions) => {\r\n      const base = Array.isArray(current) ? current.map(x => String(x || '').trim()).filter(Boolean) : [];\r\n      const add = Array.isArray(additions) ? additions.map(x => String(x || '').trim()).filter(Boolean) : [];\r\n      const set = new Set(base);\r\n      const out = [...base];\r\n      for (const item of add) {\r\n        if (!set.has(item)) {\r\n          set.add(item);\r\n          out.push(item);\r\n        }\r\n      }\r\n      return out;\r\n    };\r\n\r\n    for (const key of Object.keys(defaultByggdelMomentsByGroup)) {\r\n      const defaults = defaultByggdelMomentsByGroup[key];\r\n      const current = merged[key];\r\n      const next = mergeList(current, defaults);\r\n      if (!Array.isArray(current) || next.length !== (Array.isArray(current) ? current.length : 0)) {\r\n        merged[key] = next;\r\n        changed = true;\r\n      }\r\n    }\r\n\r\n    return { merged, changed };\r\n  };\r\n  // State för deltagar-modalens fält (måste ligga här!)\r\n  const [participantName, setParticipantName] = useState('');\r\n  const [participantCompany, setParticipantCompany] = useState('');\r\n  // State för åtgärd (remediation)\r\n  const [remediationModal, setRemediationModal] = useState({ visible: false, sectionIdx: null, pointIdx: null, comment: '', name: '', date: '', infoMode: false });\r\n  // expandedChecklist is declared above (moved earlier)\r\n  // State for adding custom checklist points\r\n  const [addPointModal, setAddPointModal] = useState({ visible: false, sectionIdx: null });\r\n  const [newPointText, setNewPointText] = useState('');\r\n  const [newPointActionText, setNewPointActionText] = useState('');\r\n  const [sectionMenuIndex, setSectionMenuIndex] = useState(null);\r\n  const [participantRole, setParticipantRole] = useState('');\r\n  const [participantPhone, setParticipantPhone] = useState('');\r\n  const [editParticipantIndex, setEditParticipantIndex] = useState(null);\r\n  // State for cancel edit confirmation modal\r\n  const [showCancelEditConfirm, setShowCancelEditConfirm] = useState(false);\r\n  // Refs för TextInput-fokus i deltagar-modal (måste ligga här!)\r\n  const nameRef = useRef();\r\n  const companyRef = useRef();\r\n  const roleRef = useRef();\r\n\r\n  // Enable LayoutAnimation on Android\r\n  useEffect(() => {\r\n    if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {\r\n      UIManager.setLayoutAnimationEnabledExperimental(true);\r\n    }\r\n  }, []);\r\n\r\n  // Keep all sections closed by default; user will open manually (accordion behavior)\r\n\r\n  const markAllOk = (sectionIdx) => {\r\n    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n    setChecklist(prev => prev.map((s, idx) => {\r\n      if (idx !== sectionIdx) return s;\r\n      const statuses = Array((s.points || []).length).fill('ok');\r\n      return { ...s, statuses };\r\n    }));\r\n    setSectionMenuIndex(null);\r\n  };\r\n\r\n  const clearAllPhotos = (sectionIdx) => {\r\n    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n    setChecklist(prev => prev.map((s, idx) => {\r\n      if (idx !== sectionIdx) return s;\r\n      const photos = Array((s.points || []).length).fill([]);\r\n      return { ...s, photos };\r\n    }));\r\n    setSectionMenuIndex(null);\r\n  };\r\n  const phoneRef = useRef();\r\n  const [missingFields, setMissingFields] = useState([]);\r\n  const scrollRef = useRef(null);\r\n  const [signerKeyboardShift, setSignerKeyboardShift] = useState(0);\r\n\r\n  useEffect(() => {\r\n    const onShow = (e) => {\r\n      try {\r\n        const h = e && e.endCoordinates ? e.endCoordinates.height : 0;\r\n        const shift = Math.max(0, h - 80);\r\n        setSignerKeyboardShift(shift);\r\n      } catch(e) {\r\n        setSignerKeyboardShift(0);\r\n      }\r\n    };\r\n    const onHide = () => setSignerKeyboardShift(0);\r\n    const showSub = Keyboard.addListener('keyboardDidShow', onShow);\r\n    const hideSub = Keyboard.addListener('keyboardDidHide', onHide);\r\n    return () => {\r\n      showSub.remove();\r\n      hideSub.remove();\r\n    };\r\n  }, []);\r\n  // Add state for draftId and selectedWeather\r\n  const [draftId, setDraftId] = useState(initialValues.id || null);\r\n  const [selectedWeather, setSelectedWeather] = useState(initialValues.weather || null);\r\n\r\n  const weatherPayload = useMemo(\r\n    () => (hideWeather ? {} : { weather: selectedWeather }),\r\n    [hideWeather, selectedWeather]\r\n  );\r\n  const [byggdelTemplate, setByggdelTemplate] = useState(initialValues.byggdelTemplate || null);\r\n  const [byggdel, setByggdel] = useState(initialValues.byggdel || formatByggdelLabelFromTemplate(initialValues.byggdelTemplate) || '');\r\n  const [materialDesc, setMaterialDesc] = useState(initialValues.materialDesc || '');\r\n  const [qualityDesc, setQualityDesc] = useState(initialValues.qualityDesc || '');\r\n  const [coverageDesc, setCoverageDesc] = useState(initialValues.coverageDesc || '');\r\n  const [mottagningsSignatures, setMottagningsSignatures] = useState(initialValues.mottagningsSignatures || []);\r\n  // Normalize mottagningsPhotos to array of objects { uri, comment }\r\n  const normalizePhotos = (arr) => {\r\n    if (!Array.isArray(arr)) return [];\r\n    return arr.map(p => {\r\n      if (!p) return null;\r\n      if (typeof p === 'string') return { uri: p, comment: '' };\r\n      if (typeof p === 'object' && p.uri) return { uri: p.uri, comment: p.comment || '' };\r\n      return null;\r\n    }).filter(Boolean);\r\n  };\r\n  const [mottagningsPhotos, setMottagningsPhotos] = useState(() => normalizePhotos(initialValues.mottagningsPhotos || []));\r\n  const [showPhotoChoice, setShowPhotoChoice] = useState(false);\r\n  const _theme = useColorScheme() || 'light';\r\n  const tintColor = (Colors && Colors[_theme] && Colors[_theme].tint) ? Colors[_theme].tint : '#1976D2';\r\n  // Ensure visibility: if tintColor is pure white (dark theme), use a contrasting fallback\r\n  const visibleTint = (tintColor === '#fff' || tintColor === '#ffffff') ? '#0a7ea4' : tintColor;\r\n  const onTintColor = (tintColor === '#fff' || tintColor === '#ffffff') ? '#000' : '#fff';\r\n  // const bottomSheetRef = useReactRef(null);\r\n  // The misplaced Modal and logic block above was removed because it must be inside a component or function, not at the top level.\r\n  // If you want to use this Modal, move it inside your component's return statement or a function.\r\n  const route = useRoute();\r\n  const navigation = useNavigation();\r\n  // ...existing code...\r\n  const participantsLabel = controlType === 'Mottagningskontroll' ? 'Mottagare' : 'Deltagare';\r\n  const addParticipantsLabel = controlType === 'Mottagningskontroll' ? 'Lägg till mottagare' : 'Lägg till deltagare';\r\n  const editParticipantsLabel = controlType === 'Mottagningskontroll' ? 'Redigera mottagare' : 'Redigera deltagare';\r\n  const [showBackConfirm, setShowBackConfirm] = useState(false);\r\n  const [backConfirmMode, setBackConfirmMode] = useState('dirty'); // 'dirty' | 'exit'\r\n  const [showFinishConfirm, setShowFinishConfirm] = useState(false);\r\n  const [showDraftSavedConfirm, setShowDraftSavedConfirm] = useState(false);\r\n  const finishingSaveRef = useRef(false);\r\n  // Ref to store blocked navigation event\r\n  const blockedNavEvent = useRef(null);\r\n  // Keep a ref copy of isDirty so the beforeRemove listener can be attached once\r\n  const isDirtyRef = useRef(false);\r\n  // Prevent duplicate rapid saves of drafts\r\n  const savingDraftRef = useRef(false);\r\n  const lastSavedDraftRef = useRef(null);\r\n\r\n  // Web-only: allow parent (HomeScreen) to coordinate project switching\r\n  // when the user is inside an inline control form.\r\n  const dispatchInlineExitDecision = (decision) => {\r\n    if (Platform.OS !== 'web') return;\r\n    try {\r\n      if (typeof window === 'undefined' || !window.dispatchEvent) return;\r\n      window.dispatchEvent(new CustomEvent('dkInlineExitDecision', { detail: { decision: String(decision || '') } }));\r\n    } catch(e) {}\r\n  };\r\n\r\n  const closeBackConfirm = (decision) => {\r\n    try { setShowBackConfirm(false); } catch(e) {}\r\n    if (decision) dispatchInlineExitDecision(decision);\r\n  };\r\n\r\n  const handleAttemptFinish = () => {\r\n    // Special validation rules for Mottagningskontroll and Skyddsrond\r\n    if (controlType !== 'Mottagningskontroll' && controlType !== 'Skyddsrond') {\r\n      handleSave();\r\n      return;\r\n    }\r\n    const missing = [];\r\n    // Date is optional for Mottagningskontroll; do not mark as missing\r\n    if (!Array.isArray(localParticipants) || localParticipants.length === 0) missing.push(participantsLabel);\r\n    const descLabel = (controlType === 'Skyddsrond') ? 'Omfattning / beskrivning av skyddsrond' : 'Beskriv leverans';\r\n    if (!(controlType === 'Skyddsrond' ? deliveryDesc : materialDesc) || !(controlType === 'Skyddsrond' ? deliveryDesc : materialDesc).trim()) missing.push(descLabel);\r\n    if (Array.isArray(checklist) && checklist.length > 0) {\r\n      const anyMissing = checklist.some(sec => !(Array.isArray(sec.statuses) && sec.statuses.every(s => !!s)));\r\n      if (anyMissing) missing.push('Kontrollpunkter');\r\n    }\r\n    if (!Array.isArray(mottagningsSignatures) || mottagningsSignatures.length === 0) missing.push('Signaturer');\r\n    if (missing.length === 0) {\r\n      handleSave();\r\n    } else {\r\n      setMissingFields(missing);\r\n      // More descriptive guidance when saving fails validation\r\n      const humanMsg = 'Följande saknas: ' + missing.join(', ') + '.\\nFyll i saknade fält eller markera kontrollpunkter. Om en avvikelse är åtgärdad, öppna punkten och tryck Åtgärda för att spara åtgärdsinfo.';\r\n      Alert.alert('Saknas', humanMsg);\r\n      if (scrollRef && scrollRef.current && scrollRef.current.scrollTo) {\r\n        scrollRef.current.scrollTo({ y: 0, animated: true });\r\n      }\r\n    }\r\n  };\r\n\r\n  // Add beforeRemove event once to block navigation if dirty (use ref inside)\r\n  useEffect(() => {\r\n    const unsubscribe = navigation.addListener('beforeRemove', (e) => {\r\n      if (!isDirtyRef.current) return; // Allow navigation if not dirty\r\n      e.preventDefault();\r\n      blockedNavEvent.current = e;\r\n      try { setBackConfirmMode('dirty'); } catch(e) {}\r\n      setShowBackConfirm(true);\r\n    });\r\n    return unsubscribe;\r\n  }, [navigation]);\r\n\r\n  // Web (inline mode): allow browser back button to trigger the same\r\n  // unsaved-changes flow (save draft or abort) instead of forcing the user\r\n  // to press the in-app \"Avbryt\" button.\r\n  useEffect(() => {\r\n    if (Platform.OS !== 'web') return;\r\n    if (typeof window === 'undefined') return;\r\n    if (!window.history || typeof window.history.pushState !== 'function') return;\r\n    // Only enable this guard when the form is rendered inline (i.e. it has an onExit handler)\r\n    if (typeof onExitRef.current !== 'function') return;\r\n\r\n    const guardId = String(Date.now()) + '-' + Math.random().toString(36).slice(2);\r\n    const pushGuard = () => {\r\n      try {\r\n        window.history.pushState({ ...(window.history.state || {}), dkInlineControl: guardId }, '');\r\n      } catch(e) {}\r\n    };\r\n    pushGuard();\r\n\r\n    const requestExitConfirm = (mode) => {\r\n      try {\r\n        // Re-add guard entry so the user stays \"here\" until they choose.\r\n        pushGuard();\r\n      } catch(e) {}\r\n      try { setBackConfirmMode(mode || 'exit'); } catch(e) {}\r\n      try { setShowBackConfirm(true); } catch(e) {}\r\n    };\r\n\r\n    const onPopState = () => {\r\n      try {\r\n        // Always confirm when leaving an inline control (prevents accidental project switch)\r\n        if (isDirtyRef.current) requestExitConfirm('dirty');\r\n        else requestExitConfirm('exit');\r\n      } catch(e) {}\r\n    };\r\n\r\n    const onAttemptExit = () => {\r\n      try {\r\n        if (isDirtyRef.current) requestExitConfirm('dirty');\r\n        else requestExitConfirm('exit');\r\n      } catch(e) {}\r\n    };\r\n\r\n    window.addEventListener('popstate', onPopState);\r\n    window.addEventListener('dkInlineAttemptExit', onAttemptExit);\r\n    return () => {\r\n      try { window.removeEventListener('popstate', onPopState); } catch(e) {}\r\n      try { window.removeEventListener('dkInlineAttemptExit', onAttemptExit); } catch(e) {}\r\n    };\r\n  }, []);\r\n  const [photoModal, setPhotoModal] = useState({ visible: false, uris: [], index: 0 });\r\n  const handleDeletePhoto = () => {\r\n    const { uris, index } = photoModal || {};\r\n    if (!uris || uris.length === 0) {\r\n      setPhotoModal({ visible: false, uris: [], index: 0 });\r\n      return;\r\n    }\r\n    const photoObj = uris[index];\r\n    const uri = photoObj ? (photoObj.uri || photoObj) : null;\r\n    if (!uri) {\r\n      setPhotoModal({ visible: false, uris: [], index: 0 });\r\n      return;\r\n    }\r\n\r\n    // 0) If viewing mall (template) photos, remove only from mall draft\r\n    try {\r\n      const mallSectionId = photoModal && photoModal.mallSectionId ? String(photoModal.mallSectionId) : '';\r\n      const mallPointIdx = (photoModal && typeof photoModal.mallPointIdx === 'number') ? photoModal.mallPointIdx : null;\r\n      if (mallSectionId && mallPointIdx !== null && mallPointIdx >= 0) {\r\n        setByggdelMallSectionsDraft(prev => {\r\n          const arr = Array.isArray(prev) ? prev : [];\r\n          return arr.map(s => {\r\n            if (String(s && s.id ? s.id : '') !== mallSectionId) return s;\r\n            const pts = Array.isArray(s && s.points) ? s.points : [];\r\n            const photosOuter = Array.isArray(s && s.photos) ? s.photos : Array(pts.length).fill(null).map(() => []);\r\n            const photos = photosOuter.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []));\r\n            if (!Array.isArray(photos[mallPointIdx])) photos[mallPointIdx] = [];\r\n            const list = photos[mallPointIdx] || [];\r\n            const pos = list.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri);\r\n            if (pos !== -1) {\r\n              photos[mallPointIdx] = list.filter((_, i) => i !== pos);\r\n            }\r\n            return Object.assign({}, s, { photos });\r\n          });\r\n        });\r\n        const newUris = uris.filter((u, i) => i !== index);\r\n        const newIndex = Math.max(0, index - 1);\r\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0, mallSectionId, mallPointIdx });\r\n        return;\r\n      }\r\n    } catch(e) {}\r\n\r\n    // 1) Try remove from mottagningsPhotos (central photos list)\r\n    try {\r\n      const mp = mottagningsPhotosRef.current || [];\r\n      const mpIdx = mp.findIndex(x => (x && x.uri) ? x.uri === uri : x === uri);\r\n      if (mpIdx !== -1) {\r\n        const newMp = [...mp];\r\n        newMp.splice(mpIdx, 1);\r\n        setMottagningsPhotos(newMp);\r\n        mottagningsPhotosRef.current = newMp;\r\n        const newUris = uris.filter((u, i) => i !== index);\r\n        const newIndex = Math.max(0, index - 1);\r\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\r\n        return;\r\n      }\r\n    } catch(e) {\r\n      // ignore and try checklist removal\r\n    }\r\n\r\n    // 2) Try remove from checklist photos (per-section/point)\r\n    try {\r\n      const prev = checklistRef.current || [];\r\n      let found = false;\r\n      const newChecklist = prev.map((section) => {\r\n        const points = Array.isArray(section.points) ? section.points : [];\r\n        // Normalize photos array to match points length\r\n        const photosArr = Array.isArray(section.photos) && section.photos.length === points.length\r\n          ? section.photos.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []))\r\n          : Array(points.length).fill(null).map(() => []);\r\n        // Remove uri if present in any point\r\n        for (let p = 0; p < photosArr.length; p++) {\r\n          const arr = photosArr[p] || [];\r\n          const pos = arr.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri);\r\n          if (pos !== -1) {\r\n            photosArr[p] = arr.filter((_, i) => i !== pos);\r\n            found = true;\r\n            break;\r\n          }\r\n        }\r\n        return { ...section, photos: photosArr, points };\r\n      });\r\n      if (found) {\r\n        setChecklist(newChecklist);\r\n        checklistRef.current = newChecklist;\r\n        // Expand the section containing the removed photo (if any)\r\n        const sectionIndex = newChecklist.findIndex(sec => Array.isArray(sec.photos) && sec.photos.some(arr => arr && arr.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri) !== -1));\r\n        if (sectionIndex !== -1) setExpandedChecklist(prev => prev.includes(sectionIndex) ? prev : [sectionIndex]);\r\n        const newUris = uris.filter((u, i) => i !== index);\r\n        const newIndex = Math.max(0, index - 1);\r\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\r\n        return;\r\n      }\r\n    } catch(e) {\r\n      // ignore and fallback to removing from modal only\r\n    }\r\n\r\n    // 3) Fallback: remove from modal list only\r\n    const newUris = uris.filter((u, i) => i !== index);\r\n    const newIndex = Math.max(0, index - 1);\r\n    setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\r\n  };\r\n  // Ref to avoid stale closures for mottagningsPhotos\r\n  const mottagningsPhotosRef = useRef(mottagningsPhotos);\r\n  useEffect(() => { mottagningsPhotosRef.current = mottagningsPhotos; }, [mottagningsPhotos]);\r\n  // Only initialize checklist ONCE, never re-initialize from checklistConfig after mount\r\n  // Checklist state: restore from route.params if present, else initialize\r\n  // Predefined sections for Mottagningskontroll (option B - pre-filled rows)\r\n  const mottagningsTemplate = [\r\n    {\r\n      label: 'Leverans',\r\n      points: [\r\n        'Kontrollera att levererat material överensstämmer med följesedel',\r\n        'Kontrollera antal och att inga kollin saknas eller är skadade',\r\n        'Kontrollera märkning och produktinformation på kollin',\r\n      ],\r\n    },\r\n    {\r\n      label: 'Kvalitet och skick',\r\n      points: [\r\n        'Inspektera ytskador (bulor, sprickor, fuktfläckar)',\r\n        'Kontrollera att dimensioner och toleranser stämmer',\r\n        'Kontrollera att rätt materialleverans lämnats (typ/spec)',\r\n      ],\r\n    },\r\n    {\r\n      label: 'Täckning och väderskydd',\r\n      points: [\r\n        'Kontrollera att material är täckt vid risk för nederbörd',\r\n        'Säkerställ att vindskydd eller presenningar är korrekt fästa',\r\n        'Kontrollera att täckning inte skadar materialet (kondens, gnidning)',\r\n      ],\r\n    },\r\n  ];\r\n  const [checklist, setChecklist] = useState(() => {\r\n    // Always prefer params.savedChecklist if present and non-empty, else checklistConfig\r\n    let raw = [];\r\n    if (route.params && Array.isArray(route.params.savedChecklist) && route.params.savedChecklist.length > 0) {\r\n      raw = route.params.savedChecklist;\r\n    } else if (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\r\n      raw = initialValues.checklist;\r\n    } else if (Array.isArray(checklistConfig) && checklistConfig.length > 0) {\r\n      // Arbetsberedning: start with no visible sections until user selects categories\r\n      if (controlType === 'Arbetsberedning') {\r\n        raw = [];\r\n      } else {\r\n      raw = checklistConfig.map(section => ({\r\n        label: section.label,\r\n        points: Array.isArray(section.points) ? [...section.points] : [],\r\n        statuses: Array(Array.isArray(section.points) ? section.points.length : 0).fill(null),\r\n        photos: Array(Array.isArray(section.points) ? section.points.length : 0).fill([]),\r\n          comments: Array(Array.isArray(section.points) ? section.points.length : 0).fill(''),\r\n      }));\r\n      }\r\n    } else if (controlType === 'Mottagningskontroll') {\r\n      // Use predefined Mottagningskontroll sections when no checklistConfig is provided\r\n      raw = mottagningsTemplate.map(section => ({ label: section.label, points: Array.isArray(section.points) ? [...section.points] : [] }));\r\n    }\r\n    // Robustify: ensure every section has valid points, statuses, photos arrays\r\n    return (raw || []).map(section => {\r\n      const points = Array.isArray(section.points) ? section.points : [];\r\n      const statuses = Array.isArray(section.statuses) && Array.isArray(points) && section.statuses.length === points.length\r\n        ? section.statuses\r\n        : Array(Array.isArray(points) ? points.length : 0).fill(null);\r\n      let photos = Array.isArray(section.photos) && Array.isArray(points) && section.photos.length === points.length\r\n        ? section.photos\r\n        : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\r\n      // Ensure every photos[i] is an array\r\n      photos = photos.map(arr => Array.isArray(arr) ? arr : (arr ? [arr] : []));\r\n      const comments = Array.isArray(section.comments) && Array.isArray(points) && section.comments.length === points.length\r\n        ? section.comments\r\n        : Array(Array.isArray(points) ? points.length : 0).fill('');\r\n      return {\r\n        label: section.label,\r\n        points,\r\n        statuses,\r\n        photos,\r\n        comments,\r\n      };\r\n    });\r\n  });\r\n\r\n  // Keep a ref of checklist to avoid stale closures when updating params\r\n  const checklistRef = useRef(checklist);\r\n  useEffect(() => { checklistRef.current = checklist; }, [checklist]);\r\n\r\n  const byggdelMallLocksCategories = useMemo(() => {\r\n    if (controlType !== 'Arbetsberedning') return false;\r\n    const tpl = byggdelTemplate || null;\r\n    return !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\r\n  }, [controlType, byggdelTemplate]);\r\n\r\n  const hasAnyChecklistPoints = (list) => {\r\n    try {\r\n      const arr = Array.isArray(list) ? list : [];\r\n      for (const sec of arr) {\r\n        const pts = Array.isArray(sec && sec.points) ? sec.points : [];\r\n        if (pts.length > 0) return true;\r\n      }\r\n      return false;\r\n    } catch(e) {\r\n      return false;\r\n    }\r\n  };\r\n\r\n  const buildChecklistFromMallPoints = ({ mallName, points, sections }) => {\r\n    const coerceArrayLike = (v) => {\r\n      if (Array.isArray(v)) return v;\r\n      if (v && typeof v === 'object') {\r\n        const keys = Object.keys(v).filter(k => String(parseInt(k, 10)) === k).map(k => parseInt(k, 10)).sort((a, b) => a - b);\r\n        if (!keys.length) return [];\r\n        const arr = [];\r\n        keys.forEach(k => { arr[k] = v[k]; });\r\n        return arr;\r\n      }\r\n      return [];\r\n    };\r\n\r\n    const secArr = Array.isArray(sections) ? sections : [];\r\n    const normalizedSections = secArr\r\n      .map(s => {\r\n        const label = String(s && (s.title ?? s.label ?? '')).trim();\r\n        const pts = (Array.isArray(s && s.points) ? s.points : []).map(p => String(p || '').trim()).filter(Boolean);\r\n        const rawStatuses = coerceArrayLike(s && s.statuses);\r\n        const statuses = pts.map((_, i) => {\r\n          const v = rawStatuses[i];\r\n          return (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\r\n        });\r\n        const rawPhotosOuter = coerceArrayLike(s && s.photos);\r\n        const photos = pts.map((_, i) => {\r\n          const row = rawPhotosOuter[i];\r\n          const list = Array.isArray(row) ? row : (row ? [row] : []);\r\n          return list\r\n            .map(item => {\r\n              if (!item) return null;\r\n              if (typeof item === 'string') return item;\r\n              if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\r\n              return null;\r\n            })\r\n            .filter(Boolean);\r\n        });\r\n        return { label, points: pts, statuses, photos };\r\n      })\r\n      .filter(s => (String(s.label || '').trim() || (Array.isArray(s.points) && s.points.length > 0)));\r\n\r\n    if (normalizedSections.length > 0) {\r\n      return normalizedSections.map(s => {\r\n        const lbl = String(s.label || '').trim() || String(mallName || 'Mall');\r\n        const pts = Array.isArray(s.points) ? s.points : [];\r\n        return {\r\n          label: lbl,\r\n          points: pts,\r\n          statuses: (Array.isArray(s.statuses) && s.statuses.length === pts.length) ? s.statuses : Array(pts.length).fill(null),\r\n          photos: (Array.isArray(s.photos) && s.photos.length === pts.length) ? s.photos.map(a => Array.isArray(a) ? a : (a ? [a] : [])) : Array(pts.length).fill(null).map(() => []),\r\n          comments: Array(pts.length).fill(''),\r\n        };\r\n      });\r\n    }\r\n\r\n    const pts = (Array.isArray(points) ? points : []).map(p => String(p || '').trim()).filter(Boolean);\r\n    return [\r\n      {\r\n        label: String(mallName || 'Mall'),\r\n        points: pts,\r\n        statuses: Array(pts.length).fill(null),\r\n        photos: Array(pts.length).fill([]),\r\n        comments: Array(pts.length).fill(''),\r\n      },\r\n    ];\r\n  };\r\n\r\n  // Track initial state for dirty checking\r\n  const initialChecklist = useMemo(() => {\r\n    if (route.params && Array.isArray(route.params.savedChecklist) && route.params.savedChecklist.length > 0) {\r\n      return route.params.savedChecklist;\r\n    }\r\n    if (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\r\n      return initialValues.checklist;\r\n    }\r\n    // Arbetsberedning: baseline is empty until user selects categories\r\n    if (controlType === 'Arbetsberedning') return [];\r\n    if (Array.isArray(checklistConfig)) {\r\n      return checklistConfig.map(section => ({\r\n        label: section.label,\r\n        points: Array.isArray(section.points) ? [...section.points] : [],\r\n        statuses: Array(Array.isArray(section.points) ? section.points.length : 0).fill(null),\r\n        photos: Array(Array.isArray(section.points) ? section.points.length : 0).fill([]),\r\n        comments: Array(Array.isArray(section.points) ? section.points.length : 0).fill(''),\r\n      }));\r\n    }\r\n    return [];\r\n  }, [checklistConfig, controlType, initialValues, route.params]);\r\n\r\n  const initialParticipants = useMemo(() => {\r\n    if (initialValues && Array.isArray(initialValues.participants) && initialValues.participants.length > 0) return initialValues.participants;\r\n    return Array.isArray(participants) ? participants : [];\r\n  }, [participants, initialValues]);\r\n  const initialDate = useMemo(() => date || initialValues.date || '', [date, initialValues.date]);\r\n  const initialWeather = useMemo(() => initialValues.weather || null, [initialValues.weather]);\r\n  const initialByggdel = useMemo(() => initialValues.byggdel || formatByggdelLabelFromTemplate(initialValues.byggdelTemplate) || '', [initialValues.byggdel, initialValues.byggdelTemplate]);\r\n  const initialDeliveryDesc = useMemo(() => initialValues.deliveryDesc || '', [initialValues.deliveryDesc]);\r\n  const initialGeneralNote = useMemo(() => initialValues.generalNote || '', [initialValues.generalNote]);\r\n  const initialMaterialDesc = useMemo(() => initialValues.materialDesc || '', [initialValues.materialDesc]);\r\n  const initialQualityDesc = useMemo(() => initialValues.qualityDesc || '', [initialValues.qualityDesc]);\r\n  const initialCoverageDesc = useMemo(() => initialValues.coverageDesc || '', [initialValues.coverageDesc]);\r\n  const initialMottagningsSignatures = useMemo(() => initialValues.mottagningsSignatures || [], [initialValues.mottagningsSignatures]);\r\n  const initialMottagningsPhotos = useMemo(() => initialValues.mottagningsPhotos || [], [initialValues.mottagningsPhotos]);\r\n\r\n  // Helper to compare arrays/objects shallowly\r\n  function shallowEqual(a, b) {\r\n\r\n    if (a === b) return true;\r\n    if (!a || !b) return false;\r\n    if (Array.isArray(a) && Array.isArray(b)) {\r\n      if (a.length !== b.length) return false;\r\n      for (let i = 0; i < a.length; i++) {\r\n        if (!shallowEqual(a[i], b[i])) return false;\r\n      }\r\n      return true;\r\n    }\r\n    if (typeof a === 'object' && typeof b === 'object') {\r\n      const aKeys = Object.keys(a);\r\n      const bKeys = Object.keys(b);\r\n      if (aKeys.length !== bKeys.length) return false;\r\n      for (let key of aKeys) {\r\n        if (!shallowEqual(a[key], b[key])) return false;\r\n      }\r\n      return true;\r\n    }\r\n    return a === b;\r\n  }\r\n\r\n    // Convert an array of points to a smooth SVG path using Catmull-Rom -> cubic Bezier\r\n    function pointsToPath(points) {\r\n      if (!Array.isArray(points) || points.length === 0) return '';\r\n      if (points.length === 1) return `M ${points[0].x} ${points[0].y}`;\r\n      const p = points.map(pt => ({ x: Number(pt.x), y: Number(pt.y) }));\r\n      let d = `M ${p[0].x} ${p[0].y}`;\r\n      for (let i = 0; i < p.length - 1; i++) {\r\n        const p0 = i > 0 ? p[i - 1] : p[i];\r\n        const p1 = p[i];\r\n        const p2 = p[i + 1];\r\n        const p3 = i + 2 < p.length ? p[i + 2] : p2;\r\n        const b1x = p1.x + (p2.x - p0.x) / 6;\r\n        const b1y = p1.y + (p2.y - p0.y) / 6;\r\n        const b2x = p2.x - (p3.x - p1.x) / 6;\r\n        const b2y = p2.y - (p3.y - p1.y) / 6;\r\n        d += ` C ${b1x} ${b1y}, ${b2x} ${b2y}, ${p2.x} ${p2.y}`;\r\n      }\r\n      return d;\r\n    }\r\n\r\n  // Local participants state (initialize from participants prop)\r\n  // Prefer participants passed via initialValues when viewing a saved/completed control\r\n  const [localParticipants, setLocalParticipants] = useState(() => {\r\n    if (initialValues && Array.isArray(initialValues.participants) && initialValues.participants.length > 0) return initialValues.participants;\r\n    return Array.isArray(participants) ? participants : [];\r\n  });\r\n\r\n  // NOTE: These states must be declared before any hook (e.g. isDirty) references them.\r\n  // Otherwise web can crash with \"Cannot access '<var>' before initialization\".\r\n  const todayIso = new Date().toISOString().slice(0, 10);\r\n  const [dateValue, setDateValue] = useState(date || (initialValues && initialValues.date) || todayIso);\r\n  // Ensure dateValue is populated if props arrive asynchronously or after hot restart\r\n  useEffect(() => {\r\n    if (!dateValue || dateValue === '') {\r\n      const fallback = date || (initialValues && initialValues.date) || todayIso;\r\n      setDateValue(fallback);\r\n    }\r\n  }, [date, initialValues && initialValues.date]);\r\n  const [deliveryDesc, setDeliveryDesc] = useState((initialValues && initialValues.deliveryDesc) || '');\r\n  const [generalNote, setGeneralNote] = useState((initialValues && initialValues.generalNote) || '');\r\n\r\n  // Keep missing-field highlights until the user fixes them.\r\n  // IMPORTANT: This must be declared after the dependent state variables,\r\n  // otherwise web can crash with \"Cannot access '<var>' before initialization\".\r\n  useEffect(() => {\r\n    if (!Array.isArray(missingFields) || missingFields.length === 0) return;\r\n\r\n    const descLabel = (controlType === 'Skyddsrond') ? 'Omfattning / beskrivning av skyddsrond' : 'Beskriv leverans';\r\n\r\n    const stillMissing = (label) => {\r\n      if (label === participantsLabel || label === 'Deltagare') {\r\n        return !(Array.isArray(localParticipants) && localParticipants.length > 0);\r\n      }\r\n      if (label === descLabel) {\r\n        if (controlType === 'Skyddsrond') {\r\n          return !(typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0);\r\n        }\r\n        // Mottagningskontroll has historically used both fields; accept either.\r\n        const hasDelivery = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\r\n        const hasMaterial = typeof materialDesc === 'string' && materialDesc.trim().length > 0;\r\n        return !(hasDelivery || hasMaterial);\r\n      }\r\n      if (label === 'Kontrollpunkter') {\r\n        if (!Array.isArray(checklist) || checklist.length === 0) return false;\r\n        return checklist.some(sec => !(Array.isArray(sec.statuses) && sec.statuses.every(s => !!s)));\r\n      }\r\n      if (label === 'Signaturer' || label === 'Signatur') {\r\n        return !(Array.isArray(mottagningsSignatures) && mottagningsSignatures.length > 0);\r\n      }\r\n      return true;\r\n    };\r\n\r\n    const nextMissing = missingFields.filter(stillMissing);\r\n    if (nextMissing.length !== missingFields.length) {\r\n      setMissingFields(nextMissing);\r\n    }\r\n  }, [missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures]);\r\n\r\n  // Dirty state: true if any field differs from initial\r\n  const isDirty = useMemo(() => {\r\n    if (!shallowEqual(localParticipants, initialParticipants)) return true;\r\n    if (!shallowEqual(checklist, initialChecklist)) return true;\r\n    if (dateValue !== initialDate) return true;\r\n    if (selectedWeather !== initialWeather) return true;\r\n    if ((byggdel || '') !== (initialByggdel || '')) return true;\r\n    if (deliveryDesc !== initialDeliveryDesc) return true;\r\n    if (generalNote !== initialGeneralNote) return true;\r\n    if (materialDesc !== initialMaterialDesc) return true;\r\n    if (qualityDesc !== initialQualityDesc) return true;\r\n    if (coverageDesc !== initialCoverageDesc) return true;\r\n    if (!shallowEqual(mottagningsSignatures, initialMottagningsSignatures)) return true;\r\n    if (!shallowEqual(mottagningsPhotos, initialMottagningsPhotos)) return true;\r\n    return false;\r\n  }, [localParticipants, checklist, dateValue, selectedWeather, byggdel, deliveryDesc, generalNote, materialDesc, qualityDesc, coverageDesc, mottagningsSignatures, mottagningsPhotos, initialParticipants, initialChecklist, initialDate, initialWeather, initialByggdel, initialDeliveryDesc, initialGeneralNote, initialMaterialDesc, initialQualityDesc, initialCoverageDesc, initialMottagningsSignatures, initialMottagningsPhotos]);\r\n  // Keep isDirtyRef in sync with latest computed isDirty\r\n  useEffect(() => { isDirtyRef.current = isDirty; }, [isDirty]);\r\n  const [showAddParticipantModal, setShowAddParticipantModal] = useState(false);\r\n  const [showAddSignerModal, setShowAddSignerModal] = useState(false);\r\n  const [signerName, setSignerName] = useState('');\r\n  const [showWeatherModal, setShowWeatherModal] = useState(false);\r\n  const [showByggdelModal, setShowByggdelModal] = useState(false);\r\n  const [showAktivaByggdelarModal, setShowAktivaByggdelarModal] = useState(false);\r\n  const [aktivaByggdelarSelectedKeys, setAktivaByggdelarSelectedKeys] = useState([]);\r\n  const [aktivaByggdelarDraftKeys, setAktivaByggdelarDraftKeys] = useState([]);\r\n  const [aktivaByggdelarExpandedPrefix, setAktivaByggdelarExpandedPrefix] = useState('');\r\n  const [byggdelHierarchyLoading, setByggdelHierarchyLoading] = useState(false);\r\n  const [byggdelMomentsByGroup, setByggdelMomentsByGroup] = useState(() => defaultByggdelMomentsByGroup);\r\n  const [byggdelMallarLoading, setByggdelMallarLoading] = useState(false);\r\n  const [byggdelMallar, setByggdelMallar] = useState([]);\r\n  const [byggdelHuvudgruppDraft, setByggdelHuvudgruppDraft] = useState('');\r\n  const [byggdelMomentDraft, setByggdelMomentDraft] = useState('');\r\n  const [byggdelMallDraft, setByggdelMallDraft] = useState(null);\r\n  const [byggdelExpandedHuvudgrupp, setByggdelExpandedHuvudgrupp] = useState('');\r\n  const [byggdelExpandedMomentKey, setByggdelExpandedMomentKey] = useState('');\r\n  const [showByggdelHuvudgruppRolldown, setShowByggdelHuvudgruppRolldown] = useState(true);\r\n  const [showKontrollplanRolldown, setShowKontrollplanRolldown] = useState(true);\r\n  const [newByggdelMallName, setNewByggdelMallName] = useState('');\r\n  const [savingByggdelMall, setSavingByggdelMall] = useState(false);\r\n  const [deletingByggdelMallId, setDeletingByggdelMallId] = useState('');\r\n  const [showCreateByggdelMallModal, setShowCreateByggdelMallModal] = useState(false);\r\n  const [createByggdelMallContext, setCreateByggdelMallContext] = useState(null);\r\n  const [showByggdelMallEditor, setShowByggdelMallEditor] = useState(false);\r\n  const [byggdelMallEditor, setByggdelMallEditor] = useState(null);\r\n  const [byggdelMallSectionsDraft, setByggdelMallSectionsDraft] = useState([]);\r\n  const [newByggdelMallSectionTitle, setNewByggdelMallSectionTitle] = useState('');\r\n  const [byggdelMallEditorExpandedSectionId, setByggdelMallEditorExpandedSectionId] = useState('');\r\n  const [newByggdelMallPointBySectionId, setNewByggdelMallPointBySectionId] = useState({});\r\n  const [savingByggdelMallPoints, setSavingByggdelMallPoints] = useState(false);\r\n  const [showCreateByggdelMoment, setShowCreateByggdelMoment] = useState(false);\r\n  const [newByggdelMomentName, setNewByggdelMomentName] = useState('');\r\n\r\n  // Keep create-mall popup bottom aligned right above the keyboard.\r\n  const DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS = 320;\r\n  const [createMallKeyboardHeight, setCreateMallKeyboardHeight] = useState(Platform.OS === 'ios' ? DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS : 0);\r\n  useEffect(() => {\r\n    if (showCreateByggdelMallModal && Platform.OS === 'ios' && !(createMallKeyboardHeight > 0)) {\r\n      setCreateMallKeyboardHeight(DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS);\r\n    }\r\n  }, [showCreateByggdelMallModal]);\r\n\r\n  // Shift mall editor up when keyboard is visible so footer buttons aren't covered.\r\n  const [mallEditorKeyboardHeight, setMallEditorKeyboardHeight] = useState(0);\r\n  useEffect(() => {\r\n    const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';\r\n    const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';\r\n\r\n    const onShow = (e) => {\r\n      const h = (e && e.endCoordinates && typeof e.endCoordinates.height === 'number') ? e.endCoordinates.height : 0;\r\n      setMallEditorKeyboardHeight(h || 0);\r\n    };\r\n    const onHide = () => setMallEditorKeyboardHeight(0);\r\n\r\n    const subShow = Keyboard.addListener(showEvent, onShow);\r\n    const subHide = Keyboard.addListener(hideEvent, onHide);\r\n    return () => {\r\n      try { subShow && subShow.remove && subShow.remove(); } catch(e) {}\r\n      try { subHide && subHide.remove && subHide.remove(); } catch(e) {}\r\n    };\r\n  }, []);\r\n  useEffect(() => {\r\n    const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';\r\n    const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';\r\n\r\n    const onShow = (e) => {\r\n      const h = (e && e.endCoordinates && typeof e.endCoordinates.height === 'number') ? e.endCoordinates.height : 0;\r\n      setCreateMallKeyboardHeight(h || 0);\r\n    };\r\n    const onHide = () => {\r\n      // iOS: keep last height to avoid jumping down and showing underlying footer.\r\n      if (Platform.OS === 'ios') return;\r\n      setCreateMallKeyboardHeight(0);\r\n    };\r\n\r\n    const subShow = Keyboard.addListener(showEvent, onShow);\r\n    const subHide = Keyboard.addListener(hideEvent, onHide);\r\n    return () => {\r\n      try { subShow && subShow.remove && subShow.remove(); } catch(e) {}\r\n      try { subHide && subHide.remove && subHide.remove(); } catch(e) {}\r\n    };\r\n  }, []);\r\n\r\n  const closeByggdelModal = () => {\r\n    try { Keyboard.dismiss && Keyboard.dismiss(); } catch(e) {}\r\n    setShowByggdelModal(false);\r\n    setShowAktivaByggdelarModal(false);\r\n    setNewByggdelMallName('');\r\n    setSavingByggdelMall(false);\r\n    setShowCreateByggdelMallModal(false);\r\n    setCreateByggdelMallContext(null);\r\n    setShowCreateByggdelMoment(false);\r\n    setNewByggdelMomentName('');\r\n  };\r\n\r\n  const closeCreateByggdelMallModal = () => {\r\n    try { Keyboard.dismiss && Keyboard.dismiss(); } catch(e) {}\r\n    setShowCreateByggdelMallModal(false);\r\n    setCreateByggdelMallContext(null);\r\n    setNewByggdelMallName('');\r\n    setSavingByggdelMall(false);\r\n  };\r\n\r\n  const submitCreateByggdelMall = async () => {\r\n    try {\r\n      const nm = String(newByggdelMallName || '').trim();\r\n      if (!nm) {\r\n        Alert.alert('Ange namn', 'Skriv ett namn på mallen.');\r\n        return;\r\n      }\r\n      if (savingByggdelMall) return;\r\n\r\n      const ctx = createByggdelMallContext;\r\n      const hgKeyPrefix = String(ctx && ctx.huvudgrupp ? ctx.huvudgrupp : '').trim();\r\n      const momentLabel = String(ctx && ctx.moment ? ctx.moment : '').trim();\r\n      if (!hgKeyPrefix || !momentLabel) {\r\n        Alert.alert('Kunde inte skapa', 'Saknar byggdel/moment. Försök igen.');\r\n        return;\r\n      }\r\n\r\n      setSavingByggdelMall(true);\r\n      const createdId = await createByggdelMall({ huvudgrupp: hgKeyPrefix, moment: momentLabel, name: nm });\r\n\r\n      // Optimistic insert so the mall is visible immediately under this moment.\r\n      setByggdelMallar(prev => {\r\n        const current = Array.isArray(prev) ? prev : [];\r\n        const next = [\r\n          ...current.filter(x => String(x && x.id ? x.id : '') !== String(createdId || '')),\r\n          { id: createdId, huvudgrupp: hgKeyPrefix, moment: momentLabel, name: nm, points: [], sections: [] },\r\n        ];\r\n        next.sort((a, b) => {\r\n          const ag = String(a && (a.huvudgrupp ?? '')).trim();\r\n          const bg = String(b && (b.huvudgrupp ?? '')).trim();\r\n          if (ag !== bg) return ag.localeCompare(bg, 'sv');\r\n          const am = String(a && (a.moment ?? '')).trim();\r\n          const bm = String(b && (b.moment ?? '')).trim();\r\n          if (am !== bm) return am.localeCompare(bm, 'sv');\r\n          const an = String(a && (a.name ?? '')).trim();\r\n          const bn = String(b && (b.name ?? '')).trim();\r\n          return an.localeCompare(bn, 'sv');\r\n        });\r\n        return next;\r\n      });\r\n\r\n      // Best-effort refresh (keeps list in sync across devices)\r\n      refreshByggdelMallar();\r\n\r\n      setByggdelMallDraft({ id: createdId || null, name: nm });\r\n      closeCreateByggdelMallModal();\r\n      if (createdId) {\r\n        // iOS/Expo Go: avoid stacking RN Modals; close Byggdel modal before opening editor.\r\n        setShowByggdelModal(false);\r\n        setTimeout(() => {\r\n          openByggdelMallEditor({ id: createdId, name: nm, huvudgrupp: hgKeyPrefix, moment: momentLabel, points: [], sections: [] });\r\n        }, 250);\r\n      }\r\n    } catch(e) {\r\n      const code = e && e.code ? String(e.code) : '';\r\n      const msg = (e && e.message) ? String(e.message) : '';\r\n      const isDuplicate = code === 'already-exists' || code === 'already_exists' || (msg && msg.toLowerCase().includes('already') && msg.toLowerCase().includes('exist'));\r\n      const isPermission = code === 'permission-denied' || (msg && msg.toLowerCase().includes('permission'));\r\n      const isAuth = code === 'unauthenticated';\r\n      const isOffline = code === 'unavailable' || (msg && (msg.toLowerCase().includes('network') || msg.toLowerCase().includes('offline')));\r\n      if (isDuplicate) {\r\n        Alert.alert('Finns redan', 'Det finns redan en mall med detta namn i företaget. Välj ett annat namn.');\r\n      } else if (isPermission) {\r\n        Alert.alert('Kunde inte skapa', 'Du saknar behörighet till företaget. Logga ut och in igen (eller be admin sätta rätt företag på användaren) och försök igen.');\r\n      } else if (isAuth) {\r\n        Alert.alert('Kunde inte skapa', 'Du är inte inloggad. Logga in igen och försök igen.');\r\n      } else if (isOffline) {\r\n        Alert.alert('Kunde inte skapa', 'Ingen kontakt med servern. Kontrollera internetanslutningen och försök igen.');\r\n      } else if (code === 'no_company') {\r\n        Alert.alert('Kunde inte skapa', 'Saknar företag på användaren. Logga ut/in eller be admin koppla användaren till ett företag.');\r\n      } else {\r\n        Alert.alert('Kunde inte skapa', 'Försök igen.');\r\n      }\r\n    } finally {\r\n      setSavingByggdelMall(false);\r\n    }\r\n  };\r\n\r\n  const openByggdelMallEditor = (mall) => {\r\n    try {\r\n      const id = mall && mall.id ? String(mall.id) : '';\r\n      const name = String(mall && (mall.name || '')).trim();\r\n      if (!id) {\r\n        Alert.alert('Kunde inte öppna', 'Mallen saknar id.');\r\n        return;\r\n      }\r\n      const coerceArrayLike = (v) => {\r\n        if (Array.isArray(v)) return v;\r\n        if (v && typeof v === 'object') {\r\n          const keys = Object.keys(v).filter(k => String(parseInt(k, 10)) === k).map(k => parseInt(k, 10)).sort((a, b) => a - b);\r\n          if (!keys.length) return [];\r\n          const arr = [];\r\n          keys.forEach(k => { arr[k] = v[k]; });\r\n          return arr;\r\n        }\r\n        return [];\r\n      };\r\n      const normalizeStatus = (v) => (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\r\n\r\n      const makeSectionId = (idx) => `sec-${Date.now()}-${idx}`;\r\n      const rawSections = Array.isArray(mall && mall.sections) ? mall.sections : [];\r\n\r\n      let sections = [];\r\n      if (rawSections.length > 0) {\r\n        sections = rawSections\r\n          .map((s, idx) => {\r\n            const title = String(s && (s.title ?? s.label ?? '')).trim();\r\n            const pts = (Array.isArray(s && s.points) ? s.points : []).map(p => String(p || '').trim()).filter(Boolean);\r\n            const rawStatuses = coerceArrayLike(s && s.statuses);\r\n            const statuses = pts.map((_, i) => normalizeStatus(rawStatuses[i]));\r\n            const rawPhotosOuter = coerceArrayLike(s && s.photos);\r\n            const photos = pts.map((_, i) => {\r\n              const row = rawPhotosOuter[i];\r\n              const list = Array.isArray(row) ? row : (row ? [row] : []);\r\n              return list.map(item => {\r\n                if (!item) return null;\r\n                if (typeof item === 'string') return item;\r\n                if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\r\n                return null;\r\n              }).filter(Boolean);\r\n            });\r\n            return { id: makeSectionId(idx), title, points: pts, statuses, photos };\r\n          })\r\n          .filter(s => String(s && s.title ? s.title : '').trim() || (Array.isArray(s && s.points) && s.points.length > 0));\r\n      } else {\r\n        const pts = Array.isArray(mall && mall.points) ? mall.points : [];\r\n        const normalized = pts.map(p => String(p || '').trim()).filter(Boolean);\r\n        if (normalized.length > 0) {\r\n          sections = [{ id: makeSectionId(0), title: 'Kontrollpunkter', points: normalized, statuses: Array(normalized.length).fill(null), photos: Array(normalized.length).fill(null).map(() => []) }];\r\n        }\r\n      }\r\n      setByggdelMallEditor({\r\n        id,\r\n        name,\r\n        huvudgrupp: String(mall && (mall.huvudgrupp || '')).trim(),\r\n        moment: String(mall && (mall.moment || '')).trim(),\r\n      });\r\n      setByggdelMallSectionsDraft(sections);\r\n      setByggdelMallEditorExpandedSectionId((sections && sections[0] && sections[0].id) ? String(sections[0].id) : '');\r\n      setNewByggdelMallSectionTitle('');\r\n      setNewByggdelMallPointBySectionId({});\r\n      setShowByggdelMallEditor(true);\r\n    } catch(e) {\r\n      Alert.alert('Kunde inte öppna', 'Försök igen.');\r\n    }\r\n  };\r\n\r\n  const handlePickMallPointFromLibrary = async (mallSectionId, mallPointIdx) => {\r\n    try {\r\n      const sid = String(mallSectionId || '').trim();\r\n      const pIdx = (typeof mallPointIdx === 'number') ? mallPointIdx : -1;\r\n      if (!sid || pIdx < 0) return;\r\n      try { Keyboard.dismiss(); } catch(e) {}\r\n\r\n      let perm = null;\r\n      try {\r\n        if (typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\r\n          perm = await ImagePicker.getMediaLibraryPermissionsAsync();\r\n        }\r\n      } catch(e) {}\r\n      if (!perm || !(perm.granted === true || perm.status === 'granted')) {\r\n        try {\r\n          perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n        } catch(e) {}\r\n      }\r\n      const ok = (perm && (perm.granted === true || perm.status === 'granted'));\r\n      if (!ok) {\r\n        alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\r\n        return;\r\n      }\r\n\r\n      const mediaTypesOption = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images)\r\n        ? ImagePicker.MediaTypeOptions.Images\r\n        : undefined;\r\n      const pickerOptions = { quality: 0.8 };\r\n      if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\r\n      await new Promise(resolve => InteractionManager.runAfterInteractions(() => setTimeout(resolve, 200)));\r\n      const res = await ImagePicker.launchImageLibraryAsync(pickerOptions);\r\n      const assets = (res && Array.isArray(res.assets) && res.assets.length) ? res.assets : (res && res.uri ? [{ uri: res.uri }] : []);\r\n      const photos = (assets || [])\r\n        .map(a => {\r\n          const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\r\n          return uri ? { uri, comment: '' } : null;\r\n        })\r\n        .filter(Boolean);\r\n      if (!photos.length) return;\r\n\r\n      let modalUris = [];\r\n      setByggdelMallSectionsDraft(prev => {\r\n        const arr = Array.isArray(prev) ? prev : [];\r\n        return arr.map(s => {\r\n          if (String(s && s.id ? s.id : '') !== sid) return s;\r\n          const pts = Array.isArray(s && s.points) ? s.points : [];\r\n          const photosOuter = Array.isArray(s && s.photos) && s.photos.length === pts.length\r\n            ? s.photos.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []))\r\n            : Array(pts.length).fill(null).map(() => []);\r\n          if (!Array.isArray(photosOuter[pIdx])) photosOuter[pIdx] = [];\r\n          const existingUris = new Set((photosOuter[pIdx] || []).map(p => (p && p.uri) ? p.uri : p).filter(Boolean));\r\n          const toAdd = photos.filter(p => p && p.uri && !existingUris.has(p.uri));\r\n          if (toAdd.length) {\r\n            photosOuter[pIdx] = [...(photosOuter[pIdx] || []), ...toAdd];\r\n          }\r\n          modalUris = photosOuter[pIdx];\r\n          return Object.assign({}, s, { photos: photosOuter });\r\n        });\r\n      });\r\n      setPhotoModal({ visible: true, uris: Array.isArray(modalUris) ? modalUris : [], index: 0, mallSectionId: sid, mallPointIdx: pIdx });\r\n    } catch(e) {\r\n      alert('Kunde inte välja bild: ' + (e?.message || e));\r\n    }\r\n  };\r\n\r\n  const refreshByggdelHierarchy = async () => {\r\n    try {\r\n      setByggdelHierarchyLoading(true);\r\n      const res = await fetchByggdelHierarchy();\r\n      const mbg = res && typeof res.momentsByGroup === 'object' && res.momentsByGroup ? res.momentsByGroup : {};\r\n      const { merged, changed } = mergeByggdelMomentsByGroup(mbg);\r\n      setByggdelMomentsByGroup(merged);\r\n\r\n      // Best-effort: persist defaults once per company so web/app share the same baseline.\r\n      if (changed) {\r\n        saveByggdelHierarchy({ momentsByGroup: merged }).catch((e) => {});\r\n      }\r\n    } catch(e) {\r\n      setByggdelMomentsByGroup(defaultByggdelMomentsByGroup);\r\n    } finally {\r\n      setByggdelHierarchyLoading(false);\r\n    }\r\n  };\r\n\r\n  const refreshByggdelMallar = async () => {\r\n    try {\r\n      setByggdelMallarLoading(true);\r\n      const list = await fetchByggdelMallar();\r\n      const arr = Array.isArray(list) ? list : [];\r\n      arr.sort((a, b) => {\r\n        const ag = String(a && (a.huvudgrupp ?? '')).trim();\r\n        const bg = String(b && (b.huvudgrupp ?? '')).trim();\r\n        if (ag !== bg) return ag.localeCompare(bg, 'sv');\r\n        const am = String(a && (a.moment ?? '')).trim();\r\n        const bm = String(b && (b.moment ?? '')).trim();\r\n        if (am !== bm) return am.localeCompare(bm, 'sv');\r\n        const an = String(a && (a.name ?? '')).trim();\r\n        const bn = String(b && (b.name ?? '')).trim();\r\n        return an.localeCompare(bn, 'sv');\r\n      });\r\n      setByggdelMallar(arr);\r\n    } catch(e) {\r\n      setByggdelMallar([]);\r\n    } finally {\r\n      setByggdelMallarLoading(false);\r\n    }\r\n  };\r\n  const [showCategoryModal, setShowCategoryModal] = useState(false);\r\n  const [selectedCategories, setSelectedCategories] = useState(() => {\r\n    if (!Array.isArray(checklistConfig) || checklistConfig.length === 0) return [];\r\n    // Arbetsberedning: start with all categories unchecked\r\n    if (controlType === 'Arbetsberedning') {\r\n      if (initialValues && Array.isArray(initialValues.selectedCategories) && initialValues.selectedCategories.length === checklistConfig.length) {\r\n        return initialValues.selectedCategories;\r\n      }\r\n      if (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\r\n        const selectedLabels = new Set((initialValues.checklist || []).map(s => s && s.label).filter(Boolean));\r\n        return checklistConfig.map(sec => selectedLabels.has(sec.label));\r\n      }\r\n      return checklistConfig.map(() => false);\r\n    }\r\n    // Other controls: default to all categories enabled\r\n    return checklistConfig.map(() => true);\r\n  });\r\n\r\n  const applySelectedCategoriesToChecklist = (categoryFlags) => {\r\n    try {\r\n      const cfg = (Array.isArray(checklistConfig) ? checklistConfig : []);\r\n      const flags = Array.isArray(categoryFlags) ? categoryFlags : [];\r\n      const current = Array.isArray(checklist) ? checklist : [];\r\n      const existingByLabel = new Map(current.map(s => [s && s.label ? s.label : '', s]));\r\n      const newChecklist = cfg\r\n        .filter((_, i) => !!flags[i])\r\n        .map(section => {\r\n          const points = Array.isArray(section.points) ? [...section.points] : [];\r\n          const existing = existingByLabel.get(section.label) || null;\r\n          if (existing && Array.isArray(existing.points)) {\r\n            const existingStatuses = Array.isArray(existing.statuses) ? existing.statuses : [];\r\n            const existingPhotos = Array.isArray(existing.photos) ? existing.photos : [];\r\n            const existingComments = Array.isArray(existing.comments) ? existing.comments : [];\r\n            const idxByPoint = new Map((existing.points || []).map((pt, idx) => [pt, idx]));\r\n            const statuses = points.map(pt => {\r\n              const exIdx = idxByPoint.get(pt);\r\n              return (exIdx === undefined) ? null : (existingStatuses[exIdx] ?? null);\r\n            });\r\n            const photos = points.map(pt => {\r\n              const exIdx = idxByPoint.get(pt);\r\n              const p = (exIdx === undefined) ? [] : existingPhotos[exIdx];\r\n              return Array.isArray(p) ? p : (p ? [p] : []);\r\n            });\r\n            const comments = points.map(pt => {\r\n              const exIdx = idxByPoint.get(pt);\r\n              return (exIdx === undefined) ? '' : (existingComments[exIdx] ?? '');\r\n            });\r\n            return {\r\n              ...existing,\r\n              label: section.label,\r\n              points,\r\n              statuses,\r\n              photos,\r\n              comments,\r\n            };\r\n          }\r\n          return {\r\n            label: section.label,\r\n            points,\r\n            statuses: Array(points.length).fill(null),\r\n            photos: Array(points.length).fill([]),\r\n            comments: Array(points.length).fill(''),\r\n          };\r\n        });\r\n      if (!shallowEqual(newChecklist, checklist)) {\r\n        setChecklist(newChecklist);\r\n      }\r\n      setExpandedChecklist([]);\r\n    } catch(e) {}\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Arbetsberedning: load project-level category defaults (local AsyncStorage)\r\n    if (controlType !== 'Arbetsberedning') return;\r\n    const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\r\n    const pid = project && project.id ? String(project.id) : '';\r\n    if (!pid || cfg.length === 0) return;\r\n    if (didInitArbetsberedningCategoriesRef.current) return;\r\n\r\n    const hasInitialSelection = !!(\r\n      (initialValues && Array.isArray(initialValues.selectedCategories) && initialValues.selectedCategories.length === cfg.length) ||\r\n      (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0)\r\n    );\r\n    if (hasInitialSelection) {\r\n      didInitArbetsberedningCategoriesRef.current = true;\r\n      return;\r\n    }\r\n\r\n    didInitArbetsberedningCategoriesRef.current = true;\r\n    (async () => {\r\n      try {\r\n        const raw = await AsyncStorage.getItem(arbetsberedningCategoryKey(pid));\r\n        if (!raw) return;\r\n        const parsed = JSON.parse(raw);\r\n\r\n        let flags = null;\r\n        if (Array.isArray(parsed) && parsed.length > 0) {\r\n          // Backward compatible formats:\r\n          // - boolean[] same length as cfg\r\n          // - string[] of selected labels\r\n          if (parsed.every(v => typeof v === 'boolean') && parsed.length === cfg.length) {\r\n            flags = parsed;\r\n          } else if (parsed.every(v => typeof v === 'string')) {\r\n            const selectedLabels = new Set(parsed.map(s => String(s || '').trim()).filter(Boolean));\r\n            flags = cfg.map(sec => selectedLabels.has(String(sec && sec.label ? sec.label : '').trim()));\r\n          }\r\n        } else if (parsed && typeof parsed === 'object') {\r\n          // Newer format: { selectedLabels: string[] }\r\n          if (Array.isArray(parsed.selectedLabels) && parsed.selectedLabels.every(v => typeof v === 'string')) {\r\n            const selectedLabels = new Set(parsed.selectedLabels.map(s => String(s || '').trim()).filter(Boolean));\r\n            flags = cfg.map(sec => selectedLabels.has(String(sec && sec.label ? sec.label : '').trim()));\r\n          }\r\n        }\r\n\r\n        if (!flags || flags.length !== cfg.length) return;\r\n        setSelectedCategories(flags);\r\n\r\n        // If this is a new control with empty checklist, apply immediately.\r\n        const currentChecklist = Array.isArray(checklistRef?.current) ? checklistRef.current : (Array.isArray(checklist) ? checklist : []);\r\n        if (!currentChecklist || currentChecklist.length === 0) {\r\n          applySelectedCategoriesToChecklist(flags);\r\n        }\r\n      } catch(e) {}\r\n    })();\r\n  }, [controlType, project && project.id, checklistConfig, initialValues]);\r\n\r\n  useEffect(() => {\r\n    // Arbetsberedning: load project-level active byggdel filter (local AsyncStorage)\r\n    if (controlType !== 'Arbetsberedning') return;\r\n    const pid = project && project.id ? String(project.id) : '';\r\n    if (!pid) return;\r\n    if (loadedAktivaByggdelPidRef.current === pid) return;\r\n    loadedAktivaByggdelPidRef.current = pid;\r\n\r\n    (async () => {\r\n      try {\r\n        const raw = await AsyncStorage.getItem(arbetsberedningActiveByggdelKey(pid));\r\n        if (!raw) {\r\n          setAktivaByggdelarSelectedKeys([]);\r\n          return;\r\n        }\r\n        const parsed = JSON.parse(raw);\r\n        let keys = [];\r\n        let legacyPrefixes = [];\r\n\r\n        if (Array.isArray(parsed) && parsed.every(v => typeof v === 'string')) {\r\n          // Backward compatible formats:\r\n          // - string[] of \"prefix\" (e.g. \"3\")\r\n          // - string[] of \"prefix||moment\" keys\r\n          const anyKey = parsed.some(v => String(v || '').includes('||'));\r\n          if (anyKey) {\r\n            keys = parsed;\r\n          } else {\r\n            legacyPrefixes = parsed;\r\n          }\r\n        } else if (parsed && typeof parsed === 'object') {\r\n          if (Array.isArray(parsed.selectedKeys) && parsed.selectedKeys.every(v => typeof v === 'string')) {\r\n            keys = parsed.selectedKeys;\r\n          } else if (Array.isArray(parsed.selectedPrefixes) && parsed.selectedPrefixes.every(v => typeof v === 'string')) {\r\n            legacyPrefixes = parsed.selectedPrefixes;\r\n          }\r\n        }\r\n\r\n        const normalizedKeys = (Array.isArray(keys) ? keys : [])\r\n          .map(x => String(x || '').trim())\r\n          .filter(x => !!x && x.includes('||'));\r\n\r\n        if (normalizedKeys.length > 0) {\r\n          setAktivaByggdelarSelectedKeys(normalizedKeys);\r\n          return;\r\n        }\r\n\r\n        // Migrate legacy huvudgrupp-prefix filter to moment keys (select all moments in those prefixes)\r\n        const prefixes = (Array.isArray(legacyPrefixes) ? legacyPrefixes : [])\r\n          .map(x => String(x || '').trim())\r\n          .filter(Boolean);\r\n        if (prefixes.length === 0) {\r\n          setAktivaByggdelarSelectedKeys([]);\r\n          return;\r\n        }\r\n\r\n        const migrated = [];\r\n        prefixes.forEach(prefix => {\r\n          const momentsCandidate = (defaultByggdelMomentsByGroup && defaultByggdelMomentsByGroup[prefix]) || [];\r\n          const moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\r\n          moments.forEach(mm => {\r\n            const m = String(mm || '').trim();\r\n            if (!m) return;\r\n            migrated.push(`${prefix}||${m}`);\r\n          });\r\n        });\r\n\r\n        const uniq = Array.from(new Set(migrated.map(x => String(x || '').trim()).filter(Boolean)));\r\n        setAktivaByggdelarSelectedKeys(uniq);\r\n      } catch(e) {\r\n        setAktivaByggdelarSelectedKeys([]);\r\n      }\r\n    })();\r\n  }, [controlType, project && project.id]);\r\n\r\n  useEffect(() => {\r\n    // If checklistConfig arrives/changes, initialize checkbox array length once without overriding user toggles\r\n    const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\r\n    setSelectedCategories(prev => {\r\n      if (Array.isArray(prev) && prev.length === cfg.length) return prev;\r\n      if (cfg.length === 0) return [];\r\n      if (controlType === 'Arbetsberedning') return cfg.map(() => false);\r\n      return cfg.map(() => true);\r\n    });\r\n  }, [checklistConfig, controlType]);\r\n  const windowWidth = Dimensions.get('window').width;\r\n  const startX = useRef(0);\r\n  const handleTouchStart = (e) => {\r\n    startX.current = e.nativeEvent.pageX;\r\n  };\r\n  const handleTouchEnd = (e, uris, index) => {\r\n    const dx = e.nativeEvent.pageX - startX.current;\r\n    if (dx > 40 && index > 0) {\r\n      setPhotoModal((m) => ({ ...m, index: m.index - 1 }));\r\n    } else if (dx < -40 && index < uris.length - 1) {\r\n      setPhotoModal((m) => ({ ...m, index: m.index + 1 }));\r\n    }\r\n  };\r\n\r\n  // Handle cameraResult photo adding logic in a useEffect\r\n    // Save checklist state to route.params before navigating to CameraCapture\r\n    const handleNavigateToCamera = (sectionIdx, pointIdx, project) => {\r\n        // Always pass the current checklist state to CameraCapture\r\n        // include returnScreen so CameraCapture can navigate back to the correct form\r\n        navigation.navigate('CameraCapture', {\r\n          sectionIdx,\r\n          pointIdx,\r\n          project,\r\n          // Provide the caller route key so CameraCapture can set params on return\r\n          returnKey: route.key || null,\r\n          // Provide the caller route name so CameraCapture can fallback to navigating back\r\n          // to the correct screen if key-based setParams doesn't reach it.\r\n          returnScreen: route.name || null,\r\n          autoSave: controlType === 'Mottagningskontroll',\r\n          mottagningsPhotos: mottagningsPhotosRef.current || [],\r\n        });\r\n      };\r\n\r\n    const handlePickFromLibrary = async () => {\r\n      try {\r\n        console.log('[BaseControlForm] handlePickFromLibrary start');\r\n        try { Keyboard.dismiss(); } catch(e) {}\r\n        setShowPhotoChoice(false);\r\n        let perm = null;\r\n        try {\r\n          if (typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\r\n            perm = await ImagePicker.getMediaLibraryPermissionsAsync();\r\n          }\r\n        } catch(e) {}\r\n        if (!perm || !(perm.granted === true || perm.status === 'granted')) {\r\n          try {\r\n            perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n          } catch(e) {}\r\n        }\r\n        const ok = (perm && (perm.granted === true || perm.status === 'granted'));\r\n        if (!ok) {\r\n          alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\r\n          return;\r\n        }\r\n        const mediaTypesOption = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images)\r\n          ? ImagePicker.MediaTypeOptions.Images\r\n          : undefined;\r\n        const pickerOptions = { quality: 0.8 };\r\n        if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\r\n        await new Promise(resolve => InteractionManager.runAfterInteractions(() => setTimeout(resolve, 500)));\r\n        const launchPromise = ImagePicker.launchImageLibraryAsync(pickerOptions);\r\n        let res;\r\n        try {\r\n          res = await Promise.race([\r\n            launchPromise,\r\n            new Promise((_, reject) => setTimeout(() => reject(new Error('picker_timeout')), 7000)),\r\n          ]);\r\n        } catch (launchErr) {\r\n          if (launchErr && launchErr.message === 'picker_timeout') {\r\n            alert('Bildväljaren svarade inte. Försök igen.');\r\n            return;\r\n          }\r\n          alert('Kunde inte öppna bildväljaren: ' + (launchErr?.message || launchErr));\r\n          return;\r\n        }\r\n        const extractAssets = (r) => {\r\n          if (!r) return [];\r\n          if (Array.isArray(r.assets) && r.assets.length) return r.assets;\r\n          if (Array.isArray(r.selectedAssets) && r.selectedAssets.length) return r.selectedAssets;\r\n          if (r.uri) return [{ uri: r.uri }];\r\n          if (r.cancelled === false && r.uri) return [{ uri: r.uri }];\r\n          return [];\r\n        };\r\n        const assets = extractAssets(res);\r\n        if (assets && assets.length > 0) {\r\n          const photos = assets.map(a => {\r\n            const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\r\n            return uri ? { uri, comment: '' } : null;\r\n          }).filter(Boolean);\r\n          if (photos.length > 0) {\r\n            // If a checklist photo modal is open, add to the correct checklist point\r\n            if (photoModal && typeof photoModal.sectionIdx === 'number' && typeof photoModal.pointIdx === 'number') {\r\n              setChecklist(prev => prev.map((section, sIdx) => {\r\n                if (sIdx !== photoModal.sectionIdx) return section;\r\n                const points = Array.isArray(section.points) ? section.points : [];\r\n                let photosArr = Array.isArray(section.photos) && section.photos.length === points.length\r\n                  ? [...section.photos]\r\n                  : Array(points.length).fill([]);\r\n                if (!Array.isArray(photosArr[photoModal.pointIdx])) photosArr[photoModal.pointIdx] = [];\r\n                // Avoid duplicates\r\n                const existingUris = new Set((photosArr[photoModal.pointIdx] || []).map(p => (p && p.uri) ? p.uri : p));\r\n                const toAdd = photos.filter(p => p && p.uri && !existingUris.has(p.uri));\r\n                photosArr[photoModal.pointIdx] = [...(photosArr[photoModal.pointIdx] || []), ...toAdd];\r\n                return { ...section, photos: photosArr };\r\n              }));\r\n              // Also update modal state to show new images\r\n              setPhotoModal(m => {\r\n                const newUris = [...(m.uris || []), ...photos.filter(p => p && p.uri && !(m.uris || []).some(u => (u && u.uri) ? u.uri === p.uri : u === p.uri))];\r\n                return { ...m, uris: newUris, index: newUris.length > 0 ? newUris.length - 1 : 0 };\r\n              });\r\n            } else {\r\n              // Otherwise, add to main mottagningsPhotos\r\n              setMottagningsPhotos(prev => {\r\n                const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\r\n                const existing = new Set(prevArr.map(p => p && p.uri).filter(Boolean));\r\n                const toAdd = photos.filter(p => p && p.uri && !existing.has(p.uri));\r\n                if (!toAdd.length) return prevArr;\r\n                const next = [...prevArr, ...toAdd];\r\n                mottagningsPhotosRef.current = next;\r\n                return next;\r\n              });\r\n            }\r\n          }\r\n        }\r\n        // User cancelled or no assets: No-op\r\n      } catch(e) {\r\n        console.warn('Image pick error', e);\r\n        alert('Kunde inte välja bild: ' + (e?.message || e));\r\n      }\r\n    };\r\n\r\n  // Guarded camera result handling to avoid re-processing and param cycles\r\n  const cameraHandledRef = useRef(false);\r\n  const processedCameraUrisRef = useRef(new Set());\r\n\r\n  // Helper: merge two drafts conservatively (preserve photos, participants, signatures, checklist photos)\r\n  const mergeDrafts = (existing, incoming) => {\r\n    if (!existing) return incoming;\r\n    if (!incoming) return existing;\r\n    const out = { ...existing, ...incoming };\r\n    // Merge participants (unique by name+company)\r\n    try {\r\n      const a = Array.isArray(existing.participants) ? existing.participants : [];\r\n      const b = Array.isArray(incoming.participants) ? incoming.participants : [];\r\n      const key = (p) => ((p && p.name) ? p.name : JSON.stringify(p)) + '::' + ((p && p.company) ? p.company : '');\r\n      const map = new Map();\r\n      a.concat(b).forEach(p => { try { map.set(key(p), p); } catch(e) {} });\r\n      out.participants = Array.from(map.values());\r\n    } catch(e) {}\r\n    // Merge mottagningsSignatures\r\n    try {\r\n      const a = Array.isArray(existing.mottagningsSignatures) ? existing.mottagningsSignatures : [];\r\n      const b = Array.isArray(incoming.mottagningsSignatures) ? incoming.mottagningsSignatures : [];\r\n      out.mottagningsSignatures = [...a, ...b.filter(s => !a.includes(s))];\r\n    } catch(e) {}\r\n    // Merge mottagningsPhotos by uri\r\n    try {\r\n      const a = Array.isArray(existing.mottagningsPhotos) ? existing.mottagningsPhotos : [];\r\n      const b = Array.isArray(incoming.mottagningsPhotos) ? incoming.mottagningsPhotos : [];\r\n      const seen = new Set(a.map(x => x && x.uri).filter(Boolean));\r\n      const merged = [...a];\r\n      b.forEach(x => { if (x && x.uri && !seen.has(x.uri)) { seen.add(x.uri); merged.push(x); } });\r\n      out.mottagningsPhotos = merged;\r\n    } catch(e) {}\r\n    // Merge checklist: prefer incoming structure but union photos per point\r\n    try {\r\n      const A = Array.isArray(existing.checklist) ? existing.checklist : [];\r\n      const B = Array.isArray(incoming.checklist) ? incoming.checklist : [];\r\n      if (B.length === 0) {\r\n        out.checklist = A;\r\n      } else if (A.length === 0) {\r\n        out.checklist = B;\r\n      } else {\r\n        const mergedChecklist = B.map((secB, sIdx) => {\r\n          const secA = A[sIdx] || {};\r\n          const points = Array.isArray(secB.points) ? secB.points : (Array.isArray(secA.points) ? secA.points : []);\r\n          const statuses = Array.isArray(secB.statuses) && secB.statuses.length === points.length ? secB.statuses : (secA.statuses || Array(points.length).fill(null));\r\n          const photosA = Array.isArray(secA.photos) ? secA.photos : Array(points.length).fill([]);\r\n          const photosB = Array.isArray(secB.photos) ? secB.photos : Array(points.length).fill([]);\r\n          const photos = points.map((_, pIdx) => {\r\n            const aArr = Array.isArray(photosA[pIdx]) ? photosA[pIdx] : (photosA[pIdx] ? [photosA[pIdx]] : []);\r\n            const bArr = Array.isArray(photosB[pIdx]) ? photosB[pIdx] : (photosB[pIdx] ? [photosB[pIdx]] : []);\r\n            const seen = new Set(aArr.map(x => (x && x.uri) ? x.uri : x).filter(Boolean));\r\n            const outArr = [...aArr];\r\n            bArr.forEach(item => { const uri = (item && item.uri) ? item.uri : item; if (uri && !seen.has(uri)) { seen.add(uri); outArr.push(item); } });\r\n            return outArr;\r\n          });\r\n          return { ...secB, points, statuses, photos };\r\n        });\r\n        out.checklist = mergedChecklist;\r\n      }\r\n    } catch(e) {}\r\n    return out;\r\n  };\r\n\r\n  // Persist a draft object by merging with existing matching draft(s)\r\n  const persistDraftObject = async (draftObj) => {\r\n    if (!draftObj || !draftObj.project) {\r\n      // still write minimal object to avoid losing the id\r\n    }\r\n    let arr = [];\r\n    try {\r\n      const raw = await AsyncStorage.getItem('draft_controls');\r\n      if (raw) arr = JSON.parse(raw) || [];\r\n    } catch(e) { arr = []; }\r\n    // Find matching draft by id first\r\n    let idx = -1;\r\n    if (draftObj && draftObj.id) {\r\n      idx = arr.findIndex(c => c.id === draftObj.id && c.project?.id === draftObj.project?.id && c.type === draftObj.type);\r\n    }\r\n    // If not found, try match by project+type (to merge newer content into older draft)\r\n    if (idx === -1 && draftObj && draftObj.project) {\r\n      idx = arr.findIndex(c => c.project?.id === draftObj.project?.id && c.type === draftObj.type);\r\n    }\r\n    if (idx !== -1) {\r\n      const merged = mergeDrafts(arr[idx], draftObj);\r\n      arr[idx] = merged;\r\n      lastSavedDraftRef.current = merged;\r\n    } else {\r\n      arr.push(draftObj);\r\n      lastSavedDraftRef.current = draftObj;\r\n    }\r\n    await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\r\n    // ...existing code...\r\n    return arr;\r\n  };\r\n\r\n  const processCameraResult = (cameraResult) => {\r\n    if (!cameraResult) return;\r\n    // ...existing code...\r\n    const { uri, sectionIdx, pointIdx, returnedMottagningsPhotos } = cameraResult;\r\n    if (returnedMottagningsPhotos && Array.isArray(returnedMottagningsPhotos)) {\r\n      try {\r\n        const norm = normalizePhotos(returnedMottagningsPhotos);\r\n        // Filter duplicates by uri\r\n        const prev = mottagningsPhotosRef.current || [];\r\n        const existingUris = new Set(prev.map(p => p && p.uri).filter(Boolean));\r\n        const toAdd = norm.filter(p => p && p.uri && !existingUris.has(p.uri));\r\n        // Attach any new returned photo URIs to the specific checklist point (if provided)\r\n        try {\r\n          if (sectionIdx !== undefined && pointIdx !== undefined) {\r\n            const urisToAttach = toAdd.map(p => p.uri).filter(Boolean);\r\n              if (urisToAttach.length > 0) {\r\n              // ...existing code...\r\n              const prevChecklist = checklistRef.current || [];\r\n              const updated = prevChecklist.map((section, sIdx) => {\r\n                if (sIdx !== sectionIdx) return section;\r\n                const points = Array.isArray(section.points) ? section.points : [];\r\n                let photos = Array.isArray(section.photos) && section.photos.length === points.length\r\n                  ? [...section.photos]\r\n                  : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\r\n                photos[pointIdx] = Array.isArray(photos[pointIdx]) ? photos[pointIdx] : [];\r\n                photos[pointIdx] = [...photos[pointIdx], ...urisToAttach];\r\n                return { ...section, photos, points };\r\n              });\r\n              setChecklist(updated);\r\n              checklistRef.current = updated;\r\n              setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\r\n              // Persist draft with updated checklist (merge/upsert to avoid overwriting richer state)\r\n              (async () => {\r\n                try {\r\n                  const toSaveId = draftId || uuidv4();\r\n                  try { setDraftId(toSaveId); } catch(e) {}\r\n                  const draftObj = {\r\n                    id: toSaveId,\r\n                    date: dateValue,\r\n                    project,\r\n                    ...weatherPayload,\r\n                    byggdel,\r\n                    byggdelTemplate,\r\n                    participants: localParticipants,\r\n                    materialDesc,\r\n                    qualityDesc,\r\n                    coverageDesc,\r\n                    mottagningsSignatures,\r\n                    mottagningsPhotos,\r\n                    checklist: updated,\r\n                    expandedChecklist,\r\n                    deliveryDesc,\r\n                    generalNote,\r\n                    type: controlType,\r\n                    savedAt: new Date().toISOString(),\r\n                  };\r\n                  try {\r\n                    await persistDraftObject(draftObj);\r\n                    // ...existing code...\r\n                  } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\r\n                } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\r\n              })();\r\n            }\r\n          }\r\n        } catch(e) {}\r\n        if (toAdd.length === 0) {\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n          return;\r\n        }\r\n        setMottagningsPhotos(prevState => {\r\n          const next = [...(prevState || []), ...toAdd];\r\n          mottagningsPhotosRef.current = next;\r\n          return next;\r\n        });\r\n        // ...existing code...\r\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n      } catch(e) {}\r\n    } else if (uri) {\r\n      if (processedCameraUrisRef.current.has(uri)) {\r\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n        return;\r\n      }\r\n      if (controlType === 'Mottagningskontroll') {\r\n        try {\r\n          processedCameraUrisRef.current.add(uri);\r\n          setMottagningsPhotos(prev => {\r\n            const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\r\n            // avoid duplicates\r\n            if (prevArr.findIndex(x => x && x.uri === uri) !== -1) return prevArr;\r\n            const newItem = { uri, comment: '' };\r\n            const next = [...prevArr, newItem];\r\n            mottagningsPhotosRef.current = next;\r\n            return next;\r\n          });\r\n          try { console.log('[BaseControlForm] appended uri to mottagningsPhotos, item:', uri); } catch(e) {}\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n        } catch(e) {}\r\n      } else if (sectionIdx !== undefined && pointIdx !== undefined) {\r\n        try {\r\n          const prev = checklistRef.current || [];\r\n          const newChecklist = prev.map((section, sIdx) => {\r\n            if (sIdx !== sectionIdx) return section;\r\n            const points = Array.isArray(section.points) ? section.points : [];\r\n            let photos = Array.isArray(section.photos) && section.photos.length === points.length\r\n              ? [...section.photos]\r\n              : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\r\n            if (!Array.isArray(photos[pointIdx])) photos[pointIdx] = photos[pointIdx] ? [photos[pointIdx]] : [];\r\n            photos[pointIdx] = [...photos[pointIdx], uri];\r\n            return { ...section, photos, points };\r\n          });\r\n          setChecklist(newChecklist);\r\n          checklistRef.current = newChecklist;\r\n          setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\r\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\r\n          // Persist updated checklist (including photos) to draft controls immediately so\r\n          // photos added from CameraCapture are not lost if the user navigates away.\r\n          (async () => {\r\n            try {\r\n              const toSaveId = draftId || uuidv4();\r\n              try { setDraftId(toSaveId); } catch(e) {}\r\n              const draftObj = {\r\n                id: toSaveId,\r\n                date: dateValue,\r\n                project,\r\n                ...weatherPayload,\r\n                byggdel,\r\n                byggdelTemplate,\r\n                participants: localParticipants,\r\n                materialDesc,\r\n                qualityDesc,\r\n                coverageDesc,\r\n                mottagningsSignatures,\r\n                mottagningsPhotos,\r\n                checklist: newChecklist,\r\n                expandedChecklist,\r\n                deliveryDesc,\r\n                generalNote,\r\n                type: controlType,\r\n                savedAt: new Date().toISOString(),\r\n              };\r\n              try {\r\n                await persistDraftObject(draftObj);\r\n                try { console.log('[BaseControlForm] persisted draft after uri add, id:', draftObj.id); } catch(e) {}\r\n              } catch(e) { try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {} }\r\n            } catch(e) {\r\n              try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {}\r\n            }\r\n          })();\r\n        } catch(e) {}\r\n      }\r\n    }\r\n  };\r\n\r\n  // Primary effect: react to explicit route.params changes (fast path)\r\n  useEffect(() => {\r\n    const cameraResult = route.params?.cameraResult;\r\n    // ...existing code...\r\n    if (cameraResult) processCameraResult(cameraResult);\r\n    if (!route.params?.cameraResult) cameraHandledRef.current = false;\r\n  }, [route.params?.cameraResult]);\r\n\r\n  // Secondary: on focus / navigation state, attempt to find cameraResult set via setParams-by-key\r\n  useEffect(() => {\r\n    const checkStateForCameraResult = () => {\r\n      try {\r\n        const state = navigation.getState && navigation.getState();\r\n        if (!state || !Array.isArray(state.routes)) return;\r\n        // ...existing code...\r\n        const ourRoute = state.routes.find(r => r.key === route.key);\r\n        const cr = ourRoute && ourRoute.params && ourRoute.params.cameraResult;\r\n        if (cr) {\r\n          // ...existing code...\r\n          processCameraResult(cr);\r\n        } else {\r\n          // Log which route appears previous to the current index for debugging\r\n          try {\r\n            const idx = typeof state.index === 'number' ? state.index : state.routes.findIndex(r => r.key === route.key);\r\n            const prev = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\r\n            // ...existing code...\r\n          } catch(e) {}\r\n        }\r\n      } catch(e) {}\r\n    };\r\n    const unsub = navigation.addListener('focus', () => { checkStateForCameraResult(); });\r\n    // also check immediately (in case params were set while backgrounded)\r\n    checkStateForCameraResult();\r\n    return unsub;\r\n  }, [navigation, route.key]);\r\n\r\n  // Drain any pending camera photos stored in AsyncStorage by CameraCapture as a fallback\r\n  useEffect(() => {\r\n    const drainPending = async () => {\r\n      try {\r\n        const raw = await AsyncStorage.getItem('pending_camera_photos');\r\n        if (!raw) return;\r\n        const arr = JSON.parse(raw || '[]') || [];\r\n        if (!Array.isArray(arr) || arr.length === 0) return;\r\n        // ...existing code...\r\n        for (const cameraResult of arr) {\r\n          try { processCameraResult(cameraResult); } catch(e) {}\r\n        }\r\n        await AsyncStorage.removeItem('pending_camera_photos');\r\n      } catch(e) {}\r\n    };\r\n    const unsub2 = navigation.addListener('focus', () => { drainPending(); });\r\n    // run now as well\r\n    drainPending();\r\n    return unsub2;\r\n  }, [navigation, processCameraResult]);\r\n  const [showDateModal, setShowDateModal] = useState(false);\r\n  const [tempDate, setTempDate] = useState('');\r\n  const [expandedChecklist, setExpandedChecklist] = useState([]);\r\n  const [signatureForIndex, setSignatureForIndex] = useState(null);\r\n  const [sigStrokes, setSigStrokes] = useState([]);\r\n  const [sigCurrent, setSigCurrent] = useState([]);\r\n  const sigCurrentRef = useRef([]);\r\n  const sigStrokesRef = useRef([]);\r\n  const sigCanvasSize = Math.min(Dimensions.get('window').width * 0.9, 760);\r\n  const panResponder = useRef(PanResponder.create({\r\n    onStartShouldSetPanResponder: () => true,\r\n    onMoveShouldSetPanResponder: () => true,\r\n    onPanResponderGrant: (e) => {\r\n      const { locationX, locationY } = e.nativeEvent;\r\n      const next = [{ x: locationX, y: locationY }];\r\n      sigCurrentRef.current = next;\r\n      setSigCurrent(next);\r\n    },\r\n    onPanResponderMove: (e) => {\r\n      const { locationX, locationY } = e.nativeEvent;\r\n      try {\r\n        const last = sigCurrentRef.current && sigCurrentRef.current.length ? sigCurrentRef.current[sigCurrentRef.current.length - 1] : null;\r\n        const dx = last ? Math.abs(locationX - last.x) : Infinity;\r\n        const dy = last ? Math.abs(locationY - last.y) : Infinity;\r\n        // Only add a new point if movement exceeds threshold (reduces noise)\r\n        const THRESH = 2; // pixels\r\n        if (!last || dx >= THRESH || dy >= THRESH) {\r\n          const next = [...sigCurrentRef.current, { x: locationX, y: locationY }];\r\n          sigCurrentRef.current = next;\r\n          setSigCurrent(next);\r\n        }\r\n      } catch(e) {}\r\n    },\r\n    onPanResponderRelease: () => {\r\n      try {\r\n        const curr = (sigCurrentRef.current && sigCurrentRef.current.length) ? [...(Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []), sigCurrentRef.current] : (Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []);\r\n        sigStrokesRef.current = curr;\r\n        setSigStrokes(curr);\r\n      } catch(e) {}\r\n      sigCurrentRef.current = [];\r\n      setSigCurrent([]);\r\n    },\r\n    onPanResponderTerminate: () => {\r\n      try {\r\n        const curr = (sigCurrentRef.current && sigCurrentRef.current.length) ? [...(Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []), sigCurrentRef.current] : (Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []);\r\n        sigStrokesRef.current = curr;\r\n        setSigStrokes(curr);\r\n      } catch(e) {}\r\n      sigCurrentRef.current = [];\r\n      setSigCurrent([]);\r\n    }\r\n  })).current;\r\n\r\n  // Spara utkast till AsyncStorage (flera per projekt/kontrolltyp)\r\n  const saveDraftControl = async () => {\r\n    // Prevent concurrent saves causing duplicates\r\n    if (savingDraftRef.current) return lastSavedDraftRef.current;\r\n    savingDraftRef.current = true;\r\n    let draft = null;\r\n    try {\r\n      // Guard: avoid creating a new empty draft unless there's meaningful data\r\n      const hasChecklistContent = Array.isArray(checklist) && checklist.some(sec => {\r\n        if (!sec) return false;\r\n        if (Array.isArray(sec.statuses) && sec.statuses.some(s => !!s)) return true;\r\n        if (Array.isArray(sec.photos) && sec.photos.some(pArr => Array.isArray(pArr) && pArr.length > 0)) return true;\r\n        return false;\r\n      });\r\n      const hasText = (deliveryDesc && String(deliveryDesc).trim().length > 0) || (materialDesc && String(materialDesc).trim().length > 0) || (generalNote && String(generalNote).trim().length > 0) || (byggdel && String(byggdel).trim().length > 0);\r\n      const hasPhotos = Array.isArray(mottagningsPhotos) && mottagningsPhotos.length > 0;\r\n      const hasSignatures = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length > 0;\r\n      const hasParticipantsLocal = Array.isArray(localParticipants) && localParticipants.length > 0;\r\n      const hasWeather = !hideWeather && !!selectedWeather;\r\n      const shouldPersist = !!lastSavedDraftRef.current || isDirtyRef.current || hasChecklistContent || hasText || hasPhotos || hasSignatures || hasParticipantsLocal || hasWeather;\r\n      if (!shouldPersist) {\r\n        // Nothing meaningful to save; avoid creating an empty draft\r\n        savingDraftRef.current = false;\r\n        return lastSavedDraftRef.current;\r\n      }\r\n      // ...existing code...\r\n      draft = {\r\n        id: draftId || uuidv4(),\r\n        date: dateValue,\r\n        project,\r\n        ...weatherPayload,\r\n        byggdel,\r\n        byggdelTemplate,\r\n        selectedCategories,\r\n        participants: localParticipants,\r\n        materialDesc,\r\n        qualityDesc,\r\n        coverageDesc,\r\n        mottagningsSignatures,\r\n        mottagningsPhotos,\r\n        checklist,\r\n        expandedChecklist,\r\n        deliveryDesc,\r\n        generalNote,\r\n        type: controlType,\r\n        savedAt: new Date().toISOString(),\r\n      };\r\n      // Ensure subsequent saves update the same draft instead of creating a new one\r\n      try { setDraftId(draft.id); } catch(e) {}\r\n\r\n      // Persist draft using merge-upsert helper so we don't overwrite richer data\r\n      try {\r\n        // ...existing code...\r\n        await persistDraftObject(draft);\r\n        try {\r\n          // Best-effort: also save draft to Firestore so web/app can sync\r\n          await saveDraftToFirestore(draft);\r\n        } catch(e) {}\r\n      } catch(e) {\r\n        try { console.warn('[BaseControlForm] failed to persist draft_controls', e); } catch(e) {}\r\n      }\r\n      // store last saved draft so concurrent attempts can reuse it\r\n      lastSavedDraftRef.current = draft;\r\n      return draft;\r\n    } catch(e) {\r\n      // If persistence fails, still return the constructed draft so callers/upserters reuse same id\r\n      try { if (draft) lastSavedDraftRef.current = draft; } catch(e) {}\r\n      alert('Kunde inte spara utkast: ' + (e && e.message ? e.message : String(e)));\r\n      return draft;\r\n    } finally {\r\n      savingDraftRef.current = false;\r\n    }\r\n  };\r\n\r\n  // Spara slutförd kontroll och ta bort ev. utkast\r\n  const handleSave = async () => {\r\n    if (finishingSaveRef.current) return;\r\n    finishingSaveRef.current = true;\r\n\r\n    const isEditingCompleted = !!(initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed));\r\n    const resolvedId = (initialValues && initialValues.id)\r\n      ? initialValues.id\r\n      : (draftId || uuidv4());\r\n    // Ensure repeated saves (e.g. accidental double click) target the same record.\r\n    try {\r\n      if (!(initialValues && initialValues.id) && !draftId) setDraftId(resolvedId);\r\n    } catch(e) {}\r\n\r\n    try {\r\n      if (onSave) {\r\n        await Promise.resolve(onSave({\r\n          id: resolvedId,\r\n          date: dateValue,\r\n          project,\r\n          ...weatherPayload,\r\n          byggdel,\r\n          byggdelTemplate,\r\n          selectedCategories,\r\n          participants: localParticipants,\r\n          materialDesc,\r\n          qualityDesc,\r\n          coverageDesc,\r\n          mottagningsSignatures,\r\n          mottagningsPhotos,\r\n          checklist,\r\n          expandedChecklist,\r\n          deliveryDesc,\r\n          generalNote,\r\n          type: controlType,\r\n        }));\r\n      }\r\n    } catch(e) {\r\n      finishingSaveRef.current = false;\r\n      Alert.alert('Kunde inte spara', (e && e.message) ? e.message : String(e));\r\n      return;\r\n    }\r\n    // Ta bort ev. utkast för detta projekt+typ\r\n    try {\r\n      const existing = await AsyncStorage.getItem('draft_controls');\r\n      if (existing) {\r\n        let arr = JSON.parse(existing);\r\n        arr = arr.filter(\r\n          c => !(c.project?.id === project?.id && c.type === controlType)\r\n        );\r\n        await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\r\n      }\r\n    } catch {}\r\n\r\n    // Best-effort: also delete the draft in Firestore so web/app stay in sync\r\n    try {\r\n      const draftIdToDelete = (initialValues && initialValues.id)\r\n        ? initialValues.id\r\n        : (draftId || null);\r\n      if (draftIdToDelete) {\r\n        await deleteDraftControlFromFirestore(draftIdToDelete);\r\n      }\r\n    } catch(e) {}\r\n    // Clear dirty flag so beforeRemove won't intercept navigation\r\n    try {\r\n      isDirtyRef.current = false;\r\n    } catch(e) {}\r\n\r\n    // For \"Slutför\" on web: show a lightweight confirmation (like \"Spara utkast\")\r\n    // and then exit back to the project automatically.\r\n    if (!isEditingCompleted) {\r\n      try { setShowFinishConfirm(true); } catch(e) {}\r\n      setTimeout(() => {\r\n        try { setShowFinishConfirm(false); } catch(e) {}\r\n        finishingSaveRef.current = false;\r\n        try {\r\n          if (typeof onFinished === 'function') {\r\n            onFinished();\r\n            return;\r\n          }\r\n          if (typeof onExit === 'function') {\r\n            onExit();\r\n            return;\r\n          }\r\n          if (navigation && navigation.navigate && project) {\r\n            navigation.navigate('ProjectDetails', { project });\r\n          } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\r\n            navigation.goBack();\r\n          }\r\n        } catch(e) {}\r\n      }, 900);\r\n      return;\r\n    }\r\n\r\n    // Editing an already completed control: keep the explicit OK flow.\r\n    finishingSaveRef.current = false;\r\n    setTimeout(() => {\r\n      Alert.alert(\r\n        'Sparad',\r\n        'Dina ändringar är sparade i kontrollen.',\r\n        [\r\n          {\r\n            text: 'OK',\r\n            onPress: () => {\r\n              if (typeof onFinished === 'function') {\r\n                onFinished();\r\n                return;\r\n              }\r\n              if (typeof onExit === 'function') {\r\n                onExit();\r\n                return;\r\n              }\r\n              if (navigation && navigation.navigate && project) {\r\n                navigation.navigate('ProjectDetails', { project });\r\n              } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\r\n                navigation.goBack();\r\n              }\r\n            },\r\n          },\r\n        ],\r\n        { cancelable: false }\r\n      );\r\n    }, 100);\r\n  };\r\n\r\n  // Spara utkast\r\n  const handleSaveDraft = async () => {\r\n    const draft = await saveDraftControl();\r\n    // ...existing code...\r\n    if (onSaveDraft) await onSaveDraft(draft || {\r\n      date: dateValue,\r\n      project,\r\n      ...weatherPayload,\r\n      byggdel,\r\n      byggdelTemplate,\r\n      selectedCategories,\r\n      participants: localParticipants,\r\n      materialDesc,\r\n      qualityDesc,\r\n      coverageDesc,\r\n      mottagningsSignatures,\r\n      mottagningsPhotos,\r\n      checklist,\r\n      expandedChecklist,\r\n      deliveryDesc,\r\n      generalNote,\r\n      type: controlType,\r\n    });\r\n    try {\r\n      // Mark form as not dirty and hide any back-confirm modal so navigation proceeds cleanly\r\n      try { isDirtyRef.current = false; } catch(e) {}\r\n      try { setShowBackConfirm(false); } catch(e) {}\r\n      setShowDraftSavedConfirm(true);\r\n      setTimeout(() => {\r\n        try { setShowDraftSavedConfirm(false); } catch(e) {}\r\n        try {\r\n          if (blockedNavEvent.current) {\r\n            blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\r\n            blockedNavEvent.current = null;\r\n          } else if (typeof onExit === 'function') {\r\n            onExit();\r\n          } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\r\n            navigation.goBack();\r\n          }\r\n        } catch(e) {}\r\n      }, 1000);\r\n    } catch(e) {}\r\n  };\r\n\r\n  // Render\r\n  // Determine whether the control may be completed (enabled \"Slutför\").\r\n  // For Riskbedömning: require date, >=1 participant, 'Beskriv arbetsmoment', all checklist points, and at least one signature.\r\n  // For Mottagningskontroll: require date, >=1 participant, material description, all checklist points, and at least one signature.\r\n  // For Skyddsrond: require date, >=1 participant, scope/description, all checklist points, and at least one signature.\r\n  const canFinish = (() => {\r\n    if (controlType === 'Riskbedömning') {\r\n      const hasDate = typeof dateValue === 'string' && dateValue.trim().length > 0;\r\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\r\n      const hasScope = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\r\n      const checklistComplete = (() => {\r\n        if (!Array.isArray(checklist) || checklist.length === 0) return false;\r\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\r\n      })();\r\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\r\n      return hasDate && hasParticipants && hasScope && checklistComplete && hasSignature;\r\n    }\r\n    if (controlType === 'Skyddsrond') {\r\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\r\n      const hasScope = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\r\n      const checklistComplete = (() => {\r\n        if (!Array.isArray(checklist) || checklist.length === 0) return true;\r\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\r\n      })();\r\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\r\n      return hasParticipants && hasScope && checklistComplete && hasSignature;\r\n    }\r\n    if (controlType === 'Mottagningskontroll') {\r\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\r\n      const hasMaterial = typeof materialDesc === 'string' && materialDesc.trim().length > 0;\r\n      const checklistComplete = (() => {\r\n        if (!Array.isArray(checklist) || checklist.length === 0) return true;\r\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\r\n      })();\r\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\r\n      return hasParticipants && hasMaterial && checklistComplete && hasSignature;\r\n    }\r\n    // Default: allow finish\r\n    return true;\r\n  })();\r\n\r\n  return (\r\n    <>\r\n      {/* Modal för åtgärd/åtgärdsinfo */}\r\n      <Modal visible={remediationModal.visible} transparent animationType=\"fade\" onRequestClose={() => setRemediationModal({ ...remediationModal, visible: false })}>\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 20, width: 320, alignItems: 'center' }}>\r\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 10, color: '#222' }}>{remediationModal.infoMode ? 'Åtgärdsinfo' : 'Åtgärda avvikelse'}</Text>\r\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 8 }}>Punkt: {remediationModal.sectionIdx !== null && remediationModal.pointIdx !== null ? checklist[remediationModal.sectionIdx].points[remediationModal.pointIdx] : ''}</Text>\r\n            <TextInput\r\n              value={remediationModal.comment}\r\n              onChangeText={text => setRemediationModal(m => ({ ...m, comment: text }))}\r\n              placeholder=\"Beskriv åtgärd\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: remediationModal.infoMode ? '#f5f5f5' : '#fff', width: '100%', marginBottom: 10 }}\r\n              editable={!remediationModal.infoMode}\r\n              multiline\r\n            />\r\n            <TextInput\r\n              value={remediationModal.name}\r\n              onChangeText={text => setRemediationModal(m => ({ ...m, name: text }))}\r\n              placeholder=\"Namn på åtgärdande person\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: remediationModal.infoMode ? '#f5f5f5' : '#fff', width: '100%', marginBottom: 10 }}\r\n              editable={!remediationModal.infoMode}\r\n            />\r\n            {/* Spara/avbryt/info-knappar */}\r\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%', marginTop: 8 }}>\r\n              <TouchableOpacity onPress={() => setRemediationModal({ ...remediationModal, visible: false })} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\r\n                <Text style={{ color: '#777' }}>Avbryt</Text>\r\n              </TouchableOpacity>\r\n              {!remediationModal.infoMode && (\r\n                <TouchableOpacity\r\n                  onPress={() => {\r\n                    // Spara åtgärd i checklistan\r\n                    const { sectionIdx, pointIdx, comment, name } = remediationModal;\r\n                    if (sectionIdx === null || pointIdx === null) return;\r\n                    setChecklist(prev => prev.map((s, sIdx) => {\r\n                      if (sIdx !== sectionIdx) return s;\r\n                      const remediation = { ...(s.remediation || {}) };\r\n                      const pt = s.points[pointIdx];\r\n                      remediation[pt] = {\r\n                        comment,\r\n                        name,\r\n                        date: new Date().toISOString(),\r\n                      };\r\n                      return { ...s, remediation };\r\n                    }));\r\n                    setRemediationModal({ ...remediationModal, visible: false });\r\n                    // Persist draft immediately so the saved åtgärd is not lost\r\n                    (async () => {\r\n                      try {\r\n                        await saveDraftControl();\r\n                      } catch(e) { }\r\n                    })();\r\n                  }}\r\n                  style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\r\n                >\r\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Spara</Text>\r\n                </TouchableOpacity>\r\n              )}\r\n            </View>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n\r\n      {/* ...ingen testknapp/modal... */}\r\n      {/* Modal för bekräftelse vid tillbaka om formuläret är ändrat */}\r\n      <Modal\r\n        visible={showBackConfirm}\r\n        transparent={true}\r\n        animationType=\"fade\"\r\n        onRequestClose={() => closeBackConfirm('cancel')}\r\n      >\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, width: 320, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6, position: 'relative' }}>\r\n            {/* Close (X) icon in top right */}\r\n            <TouchableOpacity\r\n              onPress={() => closeBackConfirm('cancel')}\r\n              style={{ position: 'absolute', top: 12, right: 12, zIndex: 10, padding: 6 }}\r\n              accessibilityLabel=\"Stäng\"\r\n              hitSlop={{ top: 12, bottom: 12, left: 12, right: 12 }}\r\n            >\r\n              <Ionicons name=\"close\" size={26} color=\"#888\" />\r\n            </TouchableOpacity>\r\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 16, color: '#222', textAlign: 'center', marginTop: 4 }}>\r\n              {backConfirmMode === 'dirty' ? 'Vill du avbryta kontrollen?' : 'Vill du lämna kontrollen?'}\r\n            </Text>\r\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 28, textAlign: 'center' }}>\r\n              {backConfirmMode === 'dirty'\r\n                ? 'Du har osparade ändringar. Välj om du vill spara utkast eller avbryta.'\r\n                : 'Välj om du vill spara som utkast eller avbryta.'}\r\n            </Text>\r\n            <View style={{ flexDirection: 'row', width: '100%', justifyContent: 'space-between' }}>\r\n              <TouchableOpacity\r\n                style={{ flex: 1, borderWidth: 1, borderColor: '#1976D2', borderRadius: 8, paddingVertical: 14, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent' }}\r\n                onPress={async () => {\r\n                  const draft = await saveDraftControl();\r\n                      if (onSaveDraft) await onSaveDraft(draft || {\r\n                        date: dateValue,\r\n                        project,\r\n                        ...weatherPayload,\r\n                        byggdel,\r\n                        byggdelTemplate,\r\n                        selectedCategories,\r\n                        participants: localParticipants,\r\n                        materialDesc,\r\n                        qualityDesc,\r\n                        coverageDesc,\r\n                        mottagningsSignatures,\r\n                        checklist,\r\n                        deliveryDesc,\r\n                        generalNote,\r\n                        type: controlType,\r\n                      });\r\n                  // Ensure navigation won't be blocked by dirty flag after saving\r\n                  try { isDirtyRef.current = false; } catch(e) {}\r\n                  closeBackConfirm('draft');\r\n                  if (blockedNavEvent.current) {\r\n                    blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\r\n                    blockedNavEvent.current = null;\r\n                  } else if (typeof onExit === 'function') {\r\n                    onExit();\r\n                  } else {\r\n                    navigation.goBack();\r\n                  }\r\n                }}\r\n              >\r\n                <Text style={{ color: '#1976D2', fontWeight: 'normal', fontSize: 16 }}>Spara utkast</Text>\r\n              </TouchableOpacity>\r\n              <TouchableOpacity\r\n                style={{ flex: 1, borderWidth: 1, borderColor: '#D32F2F', borderRadius: 8, paddingVertical: 14, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent' }}\r\n                onPress={() => {\r\n                  closeBackConfirm('abort');\r\n                  if (blockedNavEvent.current) {\r\n                    blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\r\n                    blockedNavEvent.current = null;\r\n                  } else if (typeof onExit === 'function') {\r\n                    onExit();\r\n                  } else {\r\n                    navigation.goBack();\r\n                  }\r\n                }}\r\n              >\r\n                <Text style={{ color: '#D32F2F', fontWeight: 'normal', fontSize: 16 }}>Avbryt</Text>\r\n              </TouchableOpacity>\r\n            </View>\r\n            </View>\r\n          </View>\r\n      </Modal>\r\n      {/* Confirmation after successful finish */}\r\n      <Modal visible={showFinishConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowFinishConfirm(false)}>\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 12, padding: 20, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <Ionicons name=\"checkmark-circle\" size={44} color=\"#43A047\" style={{ marginBottom: 8 }} />\r\n            <Text style={{ fontSize: 16, color: '#222', textAlign: 'center', fontWeight: '600' }}>Kontrollen är slutförd och sparad i projektet.</Text>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n      {/* Confirmation after saving draft */}\r\n      <Modal visible={showDraftSavedConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowDraftSavedConfirm(false)}>\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 12, padding: 20, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <Ionicons name=\"save-outline\" size={44} color=\"#D32F2F\" style={{ marginBottom: 8 }} />\r\n            <Text style={{ fontSize: 16, color: '#222', textAlign: 'center', fontWeight: '600' }}>Kontrollen sparas som utkast.</Text>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n      {/* Modal för bildgranskning med swipe */}\r\n      <Modal\r\n        visible={photoModal.visible}\r\n        transparent={true}\r\n        animationType=\"fade\"\r\n        onRequestClose={() => setPhotoModal({ ...photoModal, visible: false })}\r\n      >\r\n        <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === 'ios' ? 'padding' : 'height'} keyboardVerticalOffset={80}>\r\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.95)', justifyContent: 'center', alignItems: 'center' }}>\r\n            {/* Close (X) icon in top right */}\r\n            <TouchableOpacity\r\n              style={{ position: 'absolute', top: 32, right: 24, zIndex: 10, padding: 8 }}\r\n              onPress={() => setPhotoModal({ ...photoModal, visible: false })}\r\n              accessibilityLabel=\"Stäng\"\r\n            >\r\n              <Text style={{ fontSize: 28, color: '#fff', fontWeight: 'bold' }}>×</Text>\r\n            </TouchableOpacity>\r\n            {photoModal.uris.length > 0 && (\r\n              <View style={{ width: windowWidth, alignItems: 'center', justifyContent: 'center', flex: 1 }}>\r\n                {/* Modal header with title and close X */}\r\n                <View style={{ width: '100%', alignItems: 'center', justifyContent: 'center', marginBottom: 8, position: 'relative' }}>\r\n                  <Text style={{ fontSize: 22, fontWeight: 'bold', color: '#222', marginTop: 8, marginBottom: 8 }}>Bilder för kontrollpunkt</Text>\r\n                  <TouchableOpacity\r\n                    style={{ position: 'absolute', top: 0, right: 18, zIndex: 10, padding: 8 }}\r\n                    onPress={() => setPhotoModal({ ...photoModal, visible: false })}\r\n                    accessibilityLabel=\"Stäng\"\r\n                  >\r\n                    <Text style={{ fontSize: 28, color: '#222', fontWeight: 'bold' }}>×</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n                <View style={{\r\n                  width: Math.min(windowWidth * 0.92, 420),\r\n                  height: Math.min(windowWidth * 0.92, 420),\r\n                  maxWidth: 420,\r\n                  maxHeight: 420,\r\n                  borderRadius: 18,\r\n                  backgroundColor: '#222',\r\n                  alignItems: 'center',\r\n                  justifyContent: 'center',\r\n                  overflow: 'hidden',\r\n                }}>\r\n                  <Image\r\n                    source={{ uri: (photoModal.uris[photoModal.index] && photoModal.uris[photoModal.index].uri) ? photoModal.uris[photoModal.index].uri : photoModal.uris[photoModal.index] }}\r\n                    style={{ width: '100%', aspectRatio: 4/3, resizeMode: 'contain', backgroundColor: '#111' }}\r\n                    onTouchStart={handleTouchStart}\r\n                    onTouchEnd={(e) => handleTouchEnd(e, photoModal.uris, photoModal.index)}\r\n                  />\r\n                </View>\r\n                {/* Thumbnails row */}\r\n                <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 10, marginBottom: 8, maxHeight: 60 }}>\r\n                  {photoModal.uris.map((p, i) => (\r\n                    <TouchableOpacity\r\n                      key={i}\r\n                      onPress={() => setPhotoModal(m => ({ ...m, index: i }))}\r\n                      style={{ borderWidth: i === photoModal.index ? 2 : 0, borderColor: '#1976D2', borderRadius: 6, marginHorizontal: 2 }}\r\n                    >\r\n                      <Image source={{ uri: p.uri || p }} style={{ width: 48, height: 48, borderRadius: 6 }} />\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                </ScrollView>\r\n                {/* Comment input and delete button */}\r\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8, width: 320 }}>\r\n                  <TextInput\r\n                    value={(photoModal.uris[photoModal.index] && photoModal.uris[photoModal.index].comment) ? photoModal.uris[photoModal.index].comment : ''}\r\n                    onChangeText={(text) => {\r\n                      try {\r\n                        const newUris = (photoModal.uris || []).map((p, i) => i === photoModal.index ? ({ uri: (p && p.uri) ? p.uri : p, comment: text }) : (p && p.uri ? { uri: p.uri, comment: p.comment || '' } : p));\r\n                        setPhotoModal({ ...photoModal, uris: newUris });\r\n                        // Persist to mottagningsPhotos if central\r\n                        const current = photoModal.uris[photoModal.index];\r\n                        const currentUri = current && current.uri ? current.uri : current;\r\n                        const mp = mottagningsPhotosRef.current || [];\r\n                        const idxFound = mp.findIndex(x => x && x.uri === currentUri);\r\n                        if (idxFound !== -1) {\r\n                          const mpNew = mp.map((x, xi) => xi === idxFound ? ({ uri: x.uri, comment: text }) : x);\r\n                          setMottagningsPhotos(mpNew);\r\n                          mottagningsPhotosRef.current = mpNew;\r\n                        }\r\n                      } catch(e) {}\r\n                    }}\r\n                    placeholder=\"Lägg till kommentar...\"\r\n                    placeholderTextColor=\"#ddd\"\r\n                    style={{ flex: 1, backgroundColor: '#fff', borderRadius: 6, paddingHorizontal: 10, paddingVertical: 6, fontSize: 15, marginRight: 8 }}\r\n                    multiline\r\n                    maxLength={120}\r\n                  />\r\n                  <TouchableOpacity\r\n                    onPress={() => {\r\n                      setPhotoModal({ ...photoModal, visible: false });\r\n                      Alert.alert('Kommentar sparad');\r\n                    }}\r\n                    style={{ backgroundColor: '#1976D2', borderRadius: 24, padding: 10, marginRight: 8, elevation: 3, shadowColor: '#000', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.18, shadowRadius: 4, alignItems: 'center', justifyContent: 'center' }}\r\n                    accessibilityLabel=\"Spara kommentar\"\r\n                  >\r\n                    <MaterialIcons name=\"save\" size={28} color=\"#fff\" />\r\n                  </TouchableOpacity>\r\n                  <TouchableOpacity\r\n                    onPress={handleDeletePhoto}\r\n                    style={{ backgroundColor: '#e53935', borderRadius: 24, padding: 10, elevation: 3, shadowColor: '#000', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.18, shadowRadius: 4 }}\r\n                    accessibilityLabel=\"Ta bort foto\"\r\n                  >\r\n                    <MaterialIcons name=\"delete-forever\" size={28} color=\"#fff\" style={{}} />\r\n                  </TouchableOpacity>\r\n                </View>\r\n                {/* Action buttons row (tight layout) */}\r\n                <View style={{ flexDirection: 'row', justifyContent: 'center', alignItems: 'center', width: 320, marginBottom: 8 }}>\r\n                  <TouchableOpacity\r\n                    onPress={() => {\r\n                      setPhotoModal({ ...photoModal, visible: false });\r\n                      setTimeout(() => handleNavigateToCamera(), 300);\r\n                    }}\r\n                    style={{ backgroundColor: '#1976D2', borderRadius: 6, paddingVertical: 8, paddingHorizontal: 12, marginHorizontal: 4 }}\r\n                  >\r\n                    <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 15 }}>Ta nytt foto</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            )}\r\n          </View>\r\n        </KeyboardAvoidingView>\r\n      </Modal>\r\n      <ScrollView\r\n        ref={scrollRef}\r\n        style={[\r\n          { flex: 1, backgroundColor: '#fff' },\r\n          Platform.OS === 'web' ? { height: windowHeight || undefined, minHeight: 0 } : null,\r\n        ]}\r\n        keyboardShouldPersistTaps=\"handled\"\r\n      >\r\n      <View style={{ flex: 1 }}>\r\n                {/* Förklaring av statusknappar för riskbedömning (legend row removed from top, now only in checklist section header) */}\r\n        {/* Project Info and meta */}\r\n        <View style={{ padding: 16, paddingBottom: 0 }}>\r\n        {/* Project number and name */}\r\n        {project && (\r\n          <>\r\n            <Text style={{ fontSize: 20, color: '#222', fontWeight: 'bold', marginBottom: 8, letterSpacing: 0.2 }}>\r\n              {project.id ? project.id : ''}{project.id && project.name ? ' – ' : ''}{project.name ? project.name : ''}\r\n            </Text>\r\n            <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '100%', marginBottom: 10 }} />\r\n          </>\r\n        )}\r\n        {/* Date row - long press to edit */}\r\n        {/* Date row with icon, text, and edit button */}\r\n        {/* Created date row - show as 'Skapad' (date only) */}\r\n        <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 6, justifyContent: 'space-between' }}>\r\n          <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n            <Ionicons name=\"calendar-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n            <View>\r\n              <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>{`Skapad: ${(() => {\r\n                // Prefer the local `dateValue` (may be defaulted to today) so new forms show today's date\r\n                const src = (dateValue && dateValue !== '') ? dateValue : (initialValues && initialValues.date ? initialValues.date : '');\r\n                if (!src) return '-';\r\n                const d = new Date(src);\r\n                if (isNaN(d)) return src;\r\n                return d.toISOString().slice(0, 10);\r\n              })()}`}</Text>\r\n              {(() => {\r\n                const status = initialValues && initialValues.status ? initialValues.status : null;\r\n                const savedAt = initialValues && initialValues.savedAt ? initialValues.savedAt : null;\r\n                if (!status || !savedAt) return null;\r\n                const label = status === 'UTFÖRD' ? 'Slutförd' : (status === 'UTKAST' ? 'Sparad' : null);\r\n                if (!label) return null;\r\n                const d = new Date(savedAt);\r\n                const dateOnly = isNaN(d) ? savedAt : d.toISOString().slice(0, 10);\r\n                return <Text style={{ fontSize: 13, color: '#666', marginTop: 4 }}>{`${label}: ${dateOnly}`}</Text>;\r\n              })()}\r\n            </View>\r\n          </View>\r\n          <TouchableOpacity\r\n            onPress={() => {\r\n              setTempDate(dateValue ? new Date(dateValue).toISOString().slice(0, 10) : new Date().toISOString().slice(0, 10));\r\n              setShowDateModal(true);\r\n            }}\r\n            style={{ marginLeft: 12, padding: 4 }}\r\n            activeOpacity={0.7}\r\n            accessibilityLabel=\"Ändra datum\"\r\n          >\r\n            <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\r\n          </TouchableOpacity>\r\n        </View>\r\n        {/* Soft horizontal divider under date */}\r\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\r\n        {/* Date edit modal */}\r\n        <Modal\r\n          visible={showDateModal}\r\n          transparent\r\n          animationType=\"fade\"\r\n          onRequestClose={() => setShowDateModal(false)}\r\n        >\r\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 16 }}>\r\n            <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 280, maxWidth: '90%', alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n              {/* Close (X) icon in top right */}\r\n              <TouchableOpacity\r\n                onPress={() => setShowDateModal(false)}\r\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 10, padding: 4 }}\r\n                accessibilityLabel=\"Stäng\"\r\n                hitSlop={{ top: 16, bottom: 16, left: 16, right: 16 }}\r\n              >\r\n                <Ionicons name=\"close\" size={24} color=\"#888\" />\r\n              </TouchableOpacity>\r\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Ändra datum</Text>\r\n              <TextInput\r\n                value={tempDate}\r\n                onChangeText={text => {\r\n                  // Only allow numbers and hyphens, auto-insert hyphens for yyyy-mm-dd\r\n                  let cleaned = text.replace(/[^0-9]/g, '');\r\n                  if (cleaned.length > 8) cleaned = cleaned.slice(0, 8);\r\n                  let formatted = cleaned;\r\n                  if (cleaned.length > 4) formatted = cleaned.slice(0, 4) + '-' + cleaned.slice(4);\r\n                  if (cleaned.length > 6) formatted = formatted.slice(0, 7) + '-' + formatted.slice(7);\r\n                  setTempDate(formatted);\r\n                }}\r\n                style={{\r\n                  borderWidth: 1,\r\n                  borderColor: '#bbb',\r\n                  borderRadius: 8,\r\n                  padding: 8,\r\n                  fontSize: 16,\r\n                  color: '#222',\r\n                  backgroundColor: '#fafafa',\r\n                  width: 160,\r\n                  marginBottom: 8\r\n                }}\r\n                placeholder=\"ÅÅÅÅ-MM-DD\"\r\n                keyboardType=\"numeric\"\r\n                autoCapitalize=\"none\"\r\n                autoCorrect={false}\r\n                maxLength={10}\r\n              />\r\n              {/* Red warning if date is in the future */}\r\n              {(() => {\r\n                if (tempDate.length === 10) {\r\n                  const today = new Date();\r\n                  const inputDate = new Date(tempDate);\r\n                  if (!isNaN(inputDate) && inputDate > today) {\r\n                    return <Text style={{ color: '#D32F2F', marginBottom: 8, fontSize: 13 }}>Du kan inte välja ett framtida datum.</Text>;\r\n                  }\r\n                }\r\n                return null;\r\n              })()}\r\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\r\n                <TouchableOpacity\r\n                  style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\r\n                  onPress={() => {\r\n                    setDateValue(tempDate);\r\n                    setShowDateModal(false);\r\n                  }}\r\n                  disabled={(() => {\r\n                    if (tempDate.length === 10) {\r\n                      const today = new Date();\r\n                      const inputDate = new Date(tempDate);\r\n                      return isNaN(inputDate) || inputDate > today;\r\n                    }\r\n                    return true;\r\n                  })()}\r\n                >\r\n                  <Text style={{ color: '#1976D2', fontWeight: '400', fontSize: 16, opacity: (() => {\r\n                    if (tempDate.length === 10) {\r\n                      const today = new Date();\r\n                      const inputDate = new Date(tempDate);\r\n                      return (!isNaN(inputDate) && inputDate <= today) ? 1 : 0.4;\r\n                    }\r\n                    return 0.4;\r\n                  })() }}>Spara</Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity\r\n                  style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\r\n                  onPress={() => setShowDateModal(false)}\r\n                >\r\n                  <Text style={{ color: '#D32F2F', fontWeight: '400', fontSize: 16 }}>Avbryt</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </View>\r\n        </Modal>\r\n        {/* Participants (own row) and Weather (separate row below) */}\r\n        <View style={{ flexDirection: 'column', marginBottom: 2 }}>\r\n          <View style={{ flexDirection: 'row', alignItems: 'flex-start', justifyContent: 'space-between' }}>\r\n            <View style={{ flexDirection: 'row', alignItems: 'flex-start', flex: 1 }}>\r\n              <Ionicons name=\"person-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10, marginTop: 2 }} />\r\n              <View style={{ flex: 1 }}>\r\n                <Text style={{ fontSize: 18, color: (missingFields && (missingFields.includes(participantsLabel) || missingFields.includes('Deltagare'))) ? '#D32F2F' : '#222', fontWeight: '600', marginBottom: 6, marginTop: 4 }}>{participantsLabel}</Text>\r\n                <View style={{ paddingVertical: 6 }}>\r\n                  {(Array.isArray(localParticipants) ? localParticipants : []).map((p, idx) => {\r\n                    const name = (typeof p === 'string') ? p : (p && p.name) ? p.name : `${participantsLabel} ${idx+1}`;\r\n                    const key = (typeof p === 'object' && p && p.id) ? `participant-${p.id}` : `participant-${idx}-${name}`;\r\n                    return (\r\n                      <View key={key} style={{ backgroundColor: '#f5f5f5', borderRadius: 16, paddingVertical: 8, paddingHorizontal: 12, marginBottom: 8, flexDirection: 'row', alignItems: 'center' }}>\r\n                        <Text style={{ fontSize: 14, color: '#222', marginRight: 8 }}>{name}</Text>\r\n                        <TouchableOpacity onPress={() => { setParticipantName(typeof p === 'string' ? p : (p.name || '')); setParticipantCompany(typeof p === 'object' && p ? (p.company || '') : ''); setParticipantRole(typeof p === 'object' && p ? (p.role || '') : ''); setParticipantPhone(typeof p === 'object' && p ? (p.phone || '') : ''); setEditParticipantIndex(idx); setShowAddParticipantModal(true); }} style={{ marginRight: 6 }}>\r\n                          <Ionicons name=\"create-outline\" size={18} color=\"#1976D2\" />\r\n                        </TouchableOpacity>\r\n                        <TouchableOpacity onPress={() => { const nameToDelete = name; setLocalParticipants(prev => (Array.isArray(prev) ? prev.filter((_, i) => i !== idx) : [])); setMottagningsSignatures(prev => (Array.isArray(prev) ? prev.filter(s => s.name !== nameToDelete) : [])); }}>\r\n                          <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\r\n                        </TouchableOpacity>\r\n                      </View>\r\n                    );\r\n                  })}\r\n                </View>\r\n              </View>\r\n            </View>\r\n            <TouchableOpacity onPress={() => { setParticipantName(''); setParticipantCompany(''); setParticipantRole(''); setParticipantPhone(''); setEditParticipantIndex(null); setShowAddParticipantModal(true); }} style={{ padding: 4, marginLeft: 8 }} accessibilityLabel={addParticipantsLabel}>\r\n              <Ionicons name=\"add-circle-outline\" size={26} color=\"#1976D2\" />\r\n            </TouchableOpacity>\r\n          </View>\r\n\r\n          {/* Divider between participants and weather/byggdel */}\r\n          {(!hideWeather || controlType === 'Egenkontroll') && (\r\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 8 }} />\r\n          )}\r\n\r\n          {/* Weather row (separate) */}\r\n          {!hideWeather && (\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 8, justifyContent: 'space-between' }}>\r\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                {/* Fixed weather icon on the left, same blue as other icons */}\r\n                <Ionicons name=\"partly-sunny\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\r\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Väderlek</Text>\r\n                  {!selectedWeather && (\r\n                    <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\r\n                  )}\r\n                  {selectedWeather && (\r\n                    <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10 }}>\r\n                      <Ionicons\r\n                        name={(() => {\r\n                          const defaultWeatherOptions = [\r\n                            { key: 'Soligt', icon: 'sunny' },\r\n                            { key: 'Delvis molnigt', icon: 'partly-sunny' },\r\n                            { key: 'Molnigt', icon: 'cloudy' },\r\n                            { key: 'Regn', icon: 'rainy' },\r\n                            { key: 'Snö', icon: 'snow' },\r\n                            { key: 'Åska', icon: 'thunderstorm' },\r\n                          ];\r\n                          const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\r\n                            ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\r\n                            : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\r\n                          const meta = localWeather.find(w => (w.key || w) === selectedWeather);\r\n                          return (meta && meta.icon) ? meta.icon : 'sunny';\r\n                        })()}\r\n                        size={14}\r\n                        color={(() => {\r\n                          const cmap = { sunny: '#FFD54F', 'partly-sunny': '#FFB74D', cloudy: '#90A4AE', rainy: '#4FC3F7', snow: '#90CAF9', thunderstorm: '#9575CD' };\r\n                          const defaultWeatherOptions = [\r\n                            { key: 'Soligt', icon: 'sunny' },\r\n                            { key: 'Delvis molnigt', icon: 'partly-sunny' },\r\n                            { key: 'Molnigt', icon: 'cloudy' },\r\n                            { key: 'Regn', icon: 'rainy' },\r\n                            { key: 'Snö', icon: 'snow' },\r\n                            { key: 'Åska', icon: 'thunderstorm' },\r\n                          ];\r\n                          const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\r\n                            ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\r\n                            : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\r\n                          const meta = localWeather.find(w => (w.key || w) === selectedWeather);\r\n                          const icon = meta && meta.icon ? meta.icon : 'sunny';\r\n                          return cmap[icon] || '#1976D2';\r\n                        })()}\r\n                        style={{ marginRight: 6 }}\r\n                      />\r\n                      <Text style={{ color: '#222', marginRight: 8 }}>{selectedWeather}</Text>\r\n                      <TouchableOpacity onPress={() => setSelectedWeather(null)}>\r\n                        <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  )}\r\n                </View>\r\n              </View>\r\n              <TouchableOpacity onPress={() => setShowWeatherModal(true)} style={{ padding: 4, marginLeft: 8 }} accessibilityLabel=\"Lägg till väder\">\r\n                <Ionicons name=\"add-circle-outline\" size={26} color=\"#1976D2\" />\r\n              </TouchableOpacity>\r\n            </View>\r\n          )}\r\n\r\n          {/* Byggdel row (Egenkontroll, where weather usually is) */}\r\n          {hideWeather && controlType === 'Egenkontroll' && (\r\n            <View style={{ flexDirection: 'column', marginTop: 8 }}>\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                <Ionicons name=\"cube-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\r\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Byggdel</Text>\r\n                  {!((byggdelTemplate && (byggdelTemplate.huvudgrupp || byggdelTemplate.moment)) || byggdel) && (\r\n                    <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\r\n                  )}\r\n                  {!!((byggdelTemplate && (byggdelTemplate.huvudgrupp || byggdelTemplate.moment)) || byggdel) && (\r\n                    <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10, flexShrink: 1, minWidth: 0 }}>\r\n                      <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\r\n                        {(() => {\r\n                          const tpl = byggdelTemplate || null;\r\n                          const lbl = tpl ? formatByggdelMomentLabelFromTemplate(tpl) : '';\r\n                          return lbl || byggdel;\r\n                        })()}\r\n                      </Text>\r\n                      <TouchableOpacity\r\n                        onPress={() => {\r\n                          const tpl = byggdelTemplate || null;\r\n                          const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\r\n                          const clearOnlySelection = () => {\r\n                            setByggdel('');\r\n                            setByggdelTemplate(null);\r\n                          };\r\n                          const clearSelectionAndChecklist = () => {\r\n                            setByggdel('');\r\n                            setByggdelTemplate(null);\r\n                            setChecklist([]);\r\n                            setExpandedChecklist([]);\r\n                            try {\r\n                              if (controlType === 'Arbetsberedning') {\r\n                                const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\r\n                                if (cfg.length > 0) setSelectedCategories(cfg.map(() => false));\r\n                              }\r\n                            } catch(e) {}\r\n                          };\r\n\r\n                          if (hadMall && hasAnyChecklistPoints(checklistRef.current)) {\r\n                            Alert.alert(\r\n                              'Ta bort mall?'\r\n                              ,\r\n                              'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\r\n                              ,\r\n                              [\r\n                                { text: 'Avbryt', style: 'cancel' },\r\n                                { text: 'Behåll punkter', onPress: clearOnlySelection },\r\n                                { text: 'Rensa punkter', style: 'destructive', onPress: clearSelectionAndChecklist },\r\n                              ]\r\n                            );\r\n                            return;\r\n                          }\r\n\r\n                          if (hadMall) {\r\n                            clearSelectionAndChecklist();\r\n                            return;\r\n                          }\r\n\r\n                          clearOnlySelection();\r\n                        }}\r\n                        accessibilityLabel=\"Rensa byggdel\"\r\n                      >\r\n                        <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  )}\r\n                </View>\r\n              </View>\r\n              <TouchableOpacity\r\n                onPress={() => {\r\n                  const tpl = byggdelTemplate || null;\r\n                  const hg = String(tpl?.huvudgrupp || '').trim();\r\n                  const mm = String(tpl?.moment || '').trim();\r\n                  setByggdelHuvudgruppDraft(hg);\r\n                  setByggdelMomentDraft(mm);\r\n                  setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\r\n                  setByggdelExpandedHuvudgrupp(hg);\r\n                  setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\r\n                  setNewByggdelMallName('');\r\n                  setShowCreateByggdelMoment(false);\r\n                  setNewByggdelMomentName('');\r\n                  setShowCreateByggdelMallModal(false);\r\n                  setCreateByggdelMallContext(null);\r\n                  setShowKontrollplanRolldown(true);\r\n                  refreshByggdelHierarchy();\r\n                  refreshByggdelMallar();\r\n                  setShowByggdelModal(true);\r\n                }}\r\n                style={{ padding: 4, marginLeft: 8 }}\r\n                accessibilityLabel=\"Ange byggdel\"\r\n              >\r\n                <Ionicons name={byggdel ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\r\n              </TouchableOpacity>\r\n              </View>\r\n\r\n              {/* Divider between byggdel and kontrollplan */}\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\r\n\r\n              {/* Kontrollplan row (Egenkontroll) */}\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 10, justifyContent: 'space-between' }}>\r\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                  <Ionicons name=\"clipboard-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n                  <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\r\n                    <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Kontrollplan</Text>\r\n                    {!String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() && (\r\n                      <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\r\n                    )}\r\n                    {!!String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() && (\r\n                      <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10, flexShrink: 1, minWidth: 0 }}>\r\n                        <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\r\n                          {String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim()}\r\n                        </Text>\r\n                        <TouchableOpacity\r\n                          onPress={() => {\r\n                            const tpl = byggdelTemplate || null;\r\n                            const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\r\n                            if (!hadMall) return;\r\n\r\n                            const clearOnlyPlan = () => {\r\n                              const nextTpl = { huvudgrupp: tpl.huvudgrupp, moment: tpl.moment };\r\n                              setByggdelTemplate(nextTpl);\r\n                              setByggdel(formatByggdelMomentLabelFromTemplate(nextTpl));\r\n                            };\r\n                            const clearPlanAndChecklist = () => {\r\n                              const nextTpl = { huvudgrupp: tpl.huvudgrupp, moment: tpl.moment };\r\n                              setByggdelTemplate(nextTpl);\r\n                              setByggdel(formatByggdelMomentLabelFromTemplate(nextTpl));\r\n                              setChecklist([]);\r\n                              setExpandedChecklist([]);\r\n                            };\r\n\r\n                            if (hasAnyChecklistPoints(checklistRef.current)) {\r\n                              Alert.alert(\r\n                                'Ta bort mall?'\r\n                                ,\r\n                                'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\r\n                                ,\r\n                                [\r\n                                  { text: 'Avbryt', style: 'cancel' },\r\n                                  { text: 'Behåll punkter', onPress: clearOnlyPlan },\r\n                                  { text: 'Rensa punkter', style: 'destructive', onPress: clearPlanAndChecklist },\r\n                                ]\r\n                              );\r\n                              return;\r\n                            }\r\n\r\n                            clearOnlyPlan();\r\n                          }}\r\n                          accessibilityLabel=\"Rensa kontrollplan\"\r\n                        >\r\n                          <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\r\n                        </TouchableOpacity>\r\n                      </View>\r\n                    )}\r\n                  </View>\r\n                </View>\r\n\r\n                <TouchableOpacity\r\n                  onPress={() => {\r\n                    const tpl = byggdelTemplate || null;\r\n                    const hg = String(tpl?.huvudgrupp || '').trim();\r\n                    const mm = String(tpl?.moment || '').trim();\r\n                    setByggdelHuvudgruppDraft(hg);\r\n                    setByggdelMomentDraft(mm);\r\n                    setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\r\n                    setByggdelExpandedHuvudgrupp(hg);\r\n                    setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\r\n                    setNewByggdelMallName('');\r\n                    setShowCreateByggdelMoment(false);\r\n                    setNewByggdelMomentName('');\r\n                    setShowCreateByggdelMallModal(false);\r\n                    setCreateByggdelMallContext(null);\r\n                    setShowKontrollplanRolldown(true);\r\n                    refreshByggdelHierarchy();\r\n                    refreshByggdelMallar();\r\n                    setShowByggdelModal(true);\r\n                  }}\r\n                  style={{ padding: 4, marginLeft: 8 }}\r\n                  accessibilityLabel=\"Ange kontrollplan\"\r\n                >\r\n                  <Ionicons name={String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          )}\r\n\r\n          {/* Soft horizontal divider between weather and byggdel (same as date -> participants) */}\r\n          {controlType === 'Arbetsberedning' && !hideWeather && (\r\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\r\n          )}\r\n\r\n          {/* Byggdel row (Arbetsberedning only) */}\r\n          {controlType === 'Arbetsberedning' && (\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: hideWeather ? 12 : 2, justifyContent: 'space-between' }}>\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 }}>\r\n                <Ionicons name=\"cube-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 10, flexShrink: 0 }}>\r\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Byggdel</Text>\r\n                  <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\r\n                </View>\r\n\r\n                {!!byggdel && (\r\n                  <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, flexShrink: 1, minWidth: 0 }}>\r\n                    <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\r\n                      {byggdel}\r\n                    </Text>\r\n                    <TouchableOpacity\r\n                      onPress={() => {\r\n                        const tpl = byggdelTemplate || null;\r\n                        const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\r\n                        const clearOnlySelection = () => {\r\n                          setByggdel('');\r\n                          setByggdelTemplate(null);\r\n                        };\r\n                        const clearSelectionAndChecklist = () => {\r\n                          setByggdel('');\r\n                          setByggdelTemplate(null);\r\n                          setChecklist([]);\r\n                          setExpandedChecklist([]);\r\n                          try {\r\n                            if (controlType === 'Arbetsberedning') {\r\n                              const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\r\n                              if (cfg.length > 0) setSelectedCategories(cfg.map(() => false));\r\n                            }\r\n                          } catch(e) {}\r\n                        };\r\n\r\n                        if (hadMall && hasAnyChecklistPoints(checklistRef.current)) {\r\n                          Alert.alert(\r\n                            'Ta bort mall?'\r\n                            ,\r\n                            'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\r\n                            ,\r\n                            [\r\n                              { text: 'Avbryt', style: 'cancel' },\r\n                              { text: 'Behåll punkter', onPress: clearOnlySelection },\r\n                              { text: 'Rensa punkter', style: 'destructive', onPress: clearSelectionAndChecklist },\r\n                            ]\r\n                          );\r\n                          return;\r\n                        }\r\n\r\n                        if (hadMall) {\r\n                          clearSelectionAndChecklist();\r\n                          return;\r\n                        }\r\n\r\n                        clearOnlySelection();\r\n                      }}\r\n                      accessibilityLabel=\"Rensa byggdel\"\r\n                    >\r\n                      <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\r\n                    </TouchableOpacity>\r\n                  </View>\r\n                )}\r\n              </View>\r\n              <TouchableOpacity\r\n                onPress={() => {\r\n                  const tpl = byggdelTemplate || null;\r\n                  const hg = String(tpl?.huvudgrupp || '').trim();\r\n                  const mm = String(tpl?.moment || '').trim();\r\n                  setByggdelHuvudgruppDraft(hg);\r\n                  setByggdelMomentDraft(mm);\r\n                  setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\r\n                  setByggdelExpandedHuvudgrupp(hg);\r\n                  setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\r\n                  setNewByggdelMallName('');\r\n                  setShowCreateByggdelMoment(false);\r\n                  setNewByggdelMomentName('');\r\n                  setShowCreateByggdelMallModal(false);\r\n                  setCreateByggdelMallContext(null);\r\n                  refreshByggdelHierarchy();\r\n                  refreshByggdelMallar();\r\n                  setShowByggdelModal(true);\r\n                }}\r\n                style={{ padding: 4, marginLeft: 8 }}\r\n                accessibilityLabel=\"Ange byggdel\"\r\n              >\r\n                <Ionicons name={byggdel ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\r\n              </TouchableOpacity>\r\n            </View>\r\n          )}\r\n        </View>\r\n        {/* Horizontal divider between participants and material description */}\r\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\r\n        {/* Weather selection modal triggered from participants area */}\r\n        <Modal visible={showWeatherModal} transparent animationType=\"fade\" onRequestClose={() => setShowWeatherModal(false)}>\r\n          <TouchableOpacity activeOpacity={1} onPress={() => setShowWeatherModal(false)} style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n            <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\r\n              <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Välj väder</Text>\r\n              </View>\r\n              <View style={{ padding: 16, flexDirection: 'row', flexWrap: 'wrap' }}>\r\n                {(() => {\r\n                  const defaultWeatherOptions = [\r\n                    { key: 'Soligt', icon: 'sunny' },\r\n                    { key: 'Delvis molnigt', icon: 'partly-sunny' },\r\n                    { key: 'Molnigt', icon: 'cloudy' },\r\n                    { key: 'Regn', icon: 'rainy' },\r\n                    { key: 'Snö', icon: 'snow' },\r\n                    { key: 'Åska', icon: 'thunderstorm' },\r\n                  ];\r\n                  const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\r\n                    ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\r\n                    : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\r\n                  return localWeather.map(w => {\r\n                    const label = w.key || w;\r\n                    const iconName = w.icon || null;\r\n                    const isSelected = selectedWeather === label;\r\n                    return (\r\n                        <TouchableOpacity key={`wm-${label}`} onPress={() => { setSelectedWeather(label); setShowWeatherModal(false); }} style={{ width: '48%', padding: 12, margin: '1%', backgroundColor: isSelected ? '#E8F0FF' : '#fff', borderRadius: 8, borderWidth: 1, borderColor: isSelected ? '#1976D2' : '#e0e0e0', alignItems: 'center' }}>\r\n                          {iconName ? <Ionicons name={iconName} size={22} color={(() => { const cmap = { sunny: '#FFD54F', 'partly-sunny': '#FFB74D', cloudy: '#90A4AE', rainy: '#4FC3F7', snow: '#90CAF9', thunderstorm: '#9575CD' }; return isSelected ? '#1976D2' : (iconName && cmap[iconName] ? cmap[iconName] : '#444'); })()} style={{ marginBottom: 6 }} /> : null}\r\n                          <Text style={{ color: isSelected ? '#1976D2' : '#444' }}>{label}</Text>\r\n                        </TouchableOpacity>\r\n                      );\r\n                  });\r\n                })()}\r\n              </View>\r\n              <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', alignItems: 'center' }}>\r\n                <TouchableOpacity onPress={() => setShowWeatherModal(false)} style={{ paddingVertical: 10 }}>\r\n                  <Text style={{ color: '#1976D2' }}>Stäng</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </TouchableOpacity>\r\n        </Modal>\r\n\r\n        {/* Byggdel modal (Arbetsberedning + Egenkontroll) */}\r\n        {(controlType === 'Arbetsberedning' || controlType === 'Egenkontroll') && (\r\n          <Modal visible={showByggdelModal} transparent animationType=\"fade\" onRequestClose={closeByggdelModal}>\r\n            <View pointerEvents=\"box-none\" style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n              <Pressable onPress={closeByggdelModal} style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0 }} />\r\n              <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\r\n                <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                  <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Byggdel</Text>\r\n                </View>\r\n                <View style={{ padding: 16 }}>\r\n                  {byggdelHierarchyLoading ? (\r\n                    <Text style={{ color: '#444' }}>Laddar moment…</Text>\r\n                  ) : null}\r\n\r\n                  {byggdelMallarLoading ? (\r\n                    <Text style={{ color: '#444' }}>Laddar mallar…</Text>\r\n                  ) : null}\r\n\r\n                  {controlType === 'Arbetsberedning' ? (\r\n                    <TouchableOpacity\r\n                      onPress={() => {\r\n                        const current = (Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : []);\r\n                        setAktivaByggdelarDraftKeys(current);\r\n                        setAktivaByggdelarExpandedPrefix('');\r\n                        setShowAktivaByggdelarModal(true);\r\n                      }}\r\n                      style={{\r\n                        paddingVertical: 10,\r\n                        paddingHorizontal: 12,\r\n                        borderRadius: 10,\r\n                        borderWidth: 1,\r\n                        borderColor: '#e0e0e0',\r\n                        backgroundColor: '#fff',\r\n                        alignSelf: 'flex-start',\r\n                        marginBottom: 10,\r\n                      }}\r\n                      accessibilityRole=\"button\"\r\n                      accessibilityLabel=\"Aktiva byggdelar\"\r\n                    >\r\n                      <Text style={{ color: '#1976D2', fontWeight: '700' }}>Aktiva byggdelar</Text>\r\n                    </TouchableOpacity>\r\n                  ) : null}\r\n\r\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 10 }}>Välj byggdel och moment.</Text>\r\n\r\n                  {controlType === 'Arbetsberedning' && (!Array.isArray(aktivaByggdelarSelectedKeys) || aktivaByggdelarSelectedKeys.length === 0) ? (\r\n                    <Text style={{ fontSize: 13, color: '#666', marginBottom: 10 }}>\r\n                      Inga byggdelar är aktiva ännu. Tryck på “Aktiva byggdelar” och välj vilka moment som är aktuella i projektet.\r\n                    </Text>\r\n                  ) : null}\r\n\r\n                  {/* Step 1: Huvudgrupp */}\r\n                  {controlType === 'Egenkontroll' && (\r\n                    <TouchableOpacity\r\n                      onPress={() => {\r\n                        LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                        setShowByggdelHuvudgruppRolldown(prev => !prev);\r\n                      }}\r\n                      style={{\r\n                        paddingVertical: 10,\r\n                        paddingHorizontal: 12,\r\n                        borderRadius: 10,\r\n                        borderWidth: 1,\r\n                        borderColor: '#e0e0e0',\r\n                        backgroundColor: '#fff',\r\n                        flexDirection: 'row',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'space-between',\r\n                        marginBottom: 8,\r\n                      }}\r\n                      accessibilityLabel=\"Byggdel\"\r\n                    >\r\n                      <View style={{ flexDirection: 'row', alignItems: 'baseline', flex: 1, minWidth: 0 }}>\r\n                        <Text style={{ fontSize: 14, color: '#222', fontWeight: '700' }}>Byggdel</Text>\r\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 8, flexShrink: 1 }} numberOfLines={1}>\r\n                          {byggdelHuvudgruppDraft ? byggdelHuvudgruppDraft : 'Välj'}\r\n                        </Text>\r\n                      </View>\r\n                      <Ionicons name={showByggdelHuvudgruppRolldown ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\r\n                    </TouchableOpacity>\r\n                  )}\r\n\r\n                  {(controlType !== 'Egenkontroll' || showByggdelHuvudgruppRolldown) && (\r\n                    <View style={{ flexDirection: 'column' }}>\r\n                      {(() => {\r\n                        const options = Array.isArray(byggdelHuvudgruppOptions) ? byggdelHuvudgruppOptions : [];\r\n                        if (controlType !== 'Arbetsberedning') return options;\r\n                        const selected = Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : [];\r\n                        if (!selected || selected.length === 0) return [];\r\n                        const selectedPrefixes = new Set(selected\r\n                          .map(k => String(k || '').split('||')[0].trim())\r\n                          .filter(Boolean));\r\n                        return options.filter(hg => selectedPrefixes.has(String(hg || '').split('-')[0].trim()));\r\n                      })().map(hg => {\r\n                      const isSelected = String(byggdelHuvudgruppDraft || '') === hg;\r\n                      const isExpanded = String(byggdelExpandedHuvudgrupp || '') === hg;\r\n                      const hgKeyPrefix = String(hg || '').split('-')[0].trim();\r\n                      const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[hgKeyPrefix])) || [];\r\n                      let moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\r\n                      if (controlType === 'Arbetsberedning') {\r\n                        const selected = Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : [];\r\n                        if (!selected || selected.length === 0) {\r\n                          moments = [];\r\n                        } else {\r\n                          const activeSet = new Set(selected\r\n                            .filter(k => String(k || '').startsWith(`${hgKeyPrefix}||`))\r\n                            .map(k => String(k || '').split('||')[1])\r\n                            .map(x => String(x || '').trim())\r\n                            .filter(Boolean));\r\n                          moments = moments.filter(mm => activeSet.has(String(mm || '').trim()));\r\n                        }\r\n                      }\r\n                      return (\r\n                        <View key={`hg-${hg}`} style={{ marginBottom: 8 }}>\r\n                          <TouchableOpacity\r\n                            onPress={() => {\r\n                              LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n\r\n                              // Toggle expansion\r\n                              const nextExpanded = isExpanded ? '' : hg;\r\n                              setByggdelExpandedHuvudgrupp(nextExpanded);\r\n\r\n                              // Selecting a huvudgrupp resets moment (unless staying on same group)\r\n                              if (!isSelected) {\r\n                                setByggdelHuvudgruppDraft(hg);\r\n                                setByggdelMomentDraft('');\r\n                                setByggdelMallDraft(null);\r\n                                setByggdelExpandedMomentKey('');\r\n                                setShowCreateByggdelMallModal(false);\r\n                                setCreateByggdelMallContext(null);\r\n                                setNewByggdelMallName('');\r\n                              }\r\n                              setShowCreateByggdelMoment(false);\r\n                              setNewByggdelMomentName('');\r\n                            }}\r\n                            style={{\r\n                              paddingVertical: 10,\r\n                              paddingHorizontal: 12,\r\n                              borderRadius: 10,\r\n                              borderWidth: 1,\r\n                              borderColor: isExpanded ? '#1976D2' : '#e0e0e0',\r\n                              backgroundColor: isExpanded ? '#E8F0FF' : '#fff',\r\n                              flexDirection: 'row',\r\n                              alignItems: 'center',\r\n                              justifyContent: 'space-between',\r\n                            }}\r\n                          >\r\n                            <Text style={{ color: isExpanded ? '#1976D2' : '#444', fontWeight: isExpanded ? '700' : '500', flex: 1 }} numberOfLines={2}>\r\n                              {hg}\r\n                            </Text>\r\n                            <Ionicons name={isExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={isExpanded ? '#1976D2' : '#666'} style={{ marginLeft: 8 }} />\r\n                          </TouchableOpacity>\r\n\r\n                          {isExpanded ? (\r\n                            <View style={{ marginTop: 4, paddingLeft: 12, paddingRight: 12, paddingBottom: 2 }}>\r\n\r\n                              {moments.length === 0 ? (\r\n                                <Text style={{ color: '#666' }}>Inga moment finns ännu för denna byggdel.</Text>\r\n                              ) : (\r\n                                <View style={{ flexDirection: 'column' }}>\r\n                                  {moments.map((mm) => {\r\n                                    const momentKey = `${hgKeyPrefix}||${String(mm || '')}`;\r\n                                    const isMomentExpanded = String(byggdelExpandedMomentKey || '') === momentKey;\r\n                                    const mallarForMoment = (Array.isArray(byggdelMallar) ? byggdelMallar : []).filter(m => {\r\n                                      const mg = String(m && (m.huvudgrupp ?? '')).trim();\r\n                                      const mom = String(m && (m.moment ?? '')).trim();\r\n                                      return mg === hgKeyPrefix && mom === String(mm || '').trim();\r\n                                    });\r\n                                    return (\r\n                                      <View key={`mm-${hg}-${mm}`} style={{ marginBottom: 6 }}>\r\n                                        <TouchableOpacity\r\n                                          onPress={() => {\r\n                                            LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                                            setByggdelMomentDraft(String(mm || ''));\r\n                                            setByggdelMallDraft(null);\r\n                                            setNewByggdelMallName('');\r\n                                            setByggdelExpandedMomentKey(isMomentExpanded ? '' : momentKey);\r\n                                          }}\r\n                                          style={{\r\n                                            paddingVertical: 10,\r\n                                            paddingHorizontal: 12,\r\n                                            borderRadius: 10,\r\n                                            borderWidth: 1,\r\n                                            borderColor: isMomentExpanded ? '#1976D2' : '#e0e0e0',\r\n                                            backgroundColor: isMomentExpanded ? '#E8F0FF' : '#fff',\r\n                                            flexDirection: 'row',\r\n                                            alignItems: 'center',\r\n                                            justifyContent: 'space-between',\r\n                                          }}\r\n                                        >\r\n                                          <Text style={{ color: isMomentExpanded ? '#1976D2' : '#444', fontWeight: isMomentExpanded ? '700' : '500', flex: 1 }} numberOfLines={2}>\r\n                                            {String(mm || '')}\r\n                                          </Text>\r\n                                          <Ionicons name={isMomentExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={isMomentExpanded ? '#1976D2' : '#666'} style={{ marginLeft: 8 }} />\r\n                                        </TouchableOpacity>\r\n\r\n                                        {isMomentExpanded ? (\r\n                                          <View style={{ marginTop: 4, paddingLeft: 12, paddingRight: 12, paddingBottom: 2 }}>\r\n                                            {controlType === 'Egenkontroll' && (\r\n                                              <TouchableOpacity\r\n                                                onPress={() => {\r\n                                                  LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                                                  setShowKontrollplanRolldown(prev => !prev);\r\n                                                }}\r\n                                                style={{\r\n                                                  paddingVertical: 10,\r\n                                                  paddingHorizontal: 12,\r\n                                                  borderRadius: 10,\r\n                                                  borderWidth: 1,\r\n                                                  borderColor: '#e0e0e0',\r\n                                                  backgroundColor: '#fff',\r\n                                                  flexDirection: 'row',\r\n                                                  alignItems: 'center',\r\n                                                  justifyContent: 'space-between',\r\n                                                  marginBottom: 8,\r\n                                                }}\r\n                                                accessibilityLabel=\"Kontrollplan\"\r\n                                              >\r\n                                                <View style={{ flexDirection: 'row', alignItems: 'baseline', flex: 1, minWidth: 0 }}>\r\n                                                  <Text style={{ fontSize: 14, color: '#222', fontWeight: '700' }}>Kontrollplan</Text>\r\n                                                  <Text style={{ fontSize: 12, color: '#666', marginLeft: 8, flexShrink: 1 }} numberOfLines={1}>\r\n                                                    {(() => {\r\n                                                      const tpl = byggdelTemplate || null;\r\n                                                      const tplHg = String(tpl?.huvudgrupp || '').trim();\r\n                                                      const tplMom = String(tpl?.moment || '').trim();\r\n                                                      const tplMall = String((tpl && (tpl.mallName || tpl.name)) || '').trim();\r\n                                                      const isForThis = tplHg === String(hgKeyPrefix || '').trim() && tplMom === String(mm || '').trim();\r\n                                                      return (isForThis && tplMall) ? tplMall : 'Välj';\r\n                                                    })()}\r\n                                                  </Text>\r\n                                                </View>\r\n                                                <Ionicons name={showKontrollplanRolldown ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\r\n                                              </TouchableOpacity>\r\n                                            )}\r\n\r\n                                            {(controlType !== 'Egenkontroll' || showKontrollplanRolldown) && (\r\n                                              <View>\r\n                                                {mallarForMoment.length === 0 ? (\r\n                                                  <Text style={{ color: '#666', marginBottom: 8 }}>Inga mallar skapade.</Text>\r\n                                                ) : (\r\n                                                  <View style={{ marginBottom: 8 }}>\r\n                                                    {mallarForMoment.map((m) => {\r\n                                                      const id = m && m.id ? String(m.id) : '';\r\n                                                      const name = String(m && (m.name || '')).trim();\r\n                                                      const isSelectedMall = !!(byggdelMallDraft && ((byggdelMallDraft.id && id && byggdelMallDraft.id === id) || (byggdelMallDraft.name && name && byggdelMallDraft.name === name)));\r\n                                                      return (\r\n                                                        <TouchableOpacity\r\n                                                          key={`mall-${momentKey}-${id || name}`}\r\n                                                          onPress={() => {\r\n                                                            if (suppressNextMallPressRef.current) return;\r\n                                                            setByggdelMallDraft({ id: id || null, name });\r\n                                                            openByggdelMallEditor(m);\r\n                                                          }}\r\n                                                          delayLongPress={2000}\r\n                                                          onLongPress={() => {\r\n                                                            if (!id && !name) return;\r\n                                                            suppressNextMallPressRef.current = true;\r\n                                                            setTimeout(() => { suppressNextMallPressRef.current = false; }, 350);\r\n\r\n                                                            Alert.alert(\r\n                                                              'Mall',\r\n                                                              name || '(namnlös mall)',\r\n                                                              [\r\n                                                                { text: 'Avbryt', style: 'cancel' },\r\n                                                                {\r\n                                                                  text: 'Ändra mall',\r\n                                                                  onPress: () => {\r\n                                                                    openByggdelMallEditor(m);\r\n                                                                  }\r\n                                                                },\r\n                                                                {\r\n                                                                  text: 'Radera',\r\n                                                                  style: 'destructive',\r\n                                                                  onPress: () => {\r\n                                                                    if (!id) {\r\n                                                                      Alert.alert('Kunde inte radera', 'Mallen saknar id.');\r\n                                                                      return;\r\n                                                                    }\r\n\r\n                                                                    Alert.alert(\r\n                                                                      'Radera mall?',\r\n                                                                      `Vill du radera \"${name || '(namnlös mall)'}\"?`,\r\n                                                                      [\r\n                                                                        { text: 'Avbryt', style: 'cancel' },\r\n                                                                        {\r\n                                                                          text: 'Radera',\r\n                                                                          style: 'destructive',\r\n                                                                          onPress: async () => {\r\n                                                                            try {\r\n                                                                              if (deletingByggdelMallId) return;\r\n                                                                              setDeletingByggdelMallId(id);\r\n                                                                              await deleteByggdelMall({ mallId: id });\r\n\r\n                                                                              setByggdelMallar(prev => (Array.isArray(prev) ? prev.filter(x => String(x && x.id ? x.id : '') !== id) : []));\r\n\r\n                                                                              // Clear current selection if it was this mall\r\n                                                                              if (byggdelMallDraft) {\r\n                                                                                const pid = byggdelMallDraft.id ? String(byggdelMallDraft.id) : '';\r\n                                                                                const pname = byggdelMallDraft.name ? String(byggdelMallDraft.name).trim() : '';\r\n                                                                                if ((pid && pid === id) || (!pid && pname && pname === name)) {\r\n                                                                                  setByggdelMallDraft(null);\r\n                                                                                }\r\n                                                                              }\r\n\r\n                                                                              // Clear saved template reference if it was this mall (avoid dangling mallId)\r\n                                                                              if (byggdelTemplate) {\r\n                                                                                const pmid = byggdelTemplate.mallId ? String(byggdelTemplate.mallId) : '';\r\n                                                                                const pmname = byggdelTemplate.mallName ? String(byggdelTemplate.mallName).trim() : '';\r\n                                                                                const isMatch = (pmid && pmid === id) || (!pmid && pmname && pmname === name);\r\n                                                                                if (isMatch) {\r\n                                                                                  const nextTpl = { huvudgrupp: byggdelTemplate.huvudgrupp, moment: byggdelTemplate.moment };\r\n                                                                                  setByggdelTemplate(nextTpl);\r\n                                                                                  setByggdel(formatByggdelLabelFromTemplate(nextTpl));\r\n                                                                                }\r\n                                                                              }\r\n\r\n                                                                              if (byggdelMallEditor && String(byggdelMallEditor.id || '') === id) {\r\n                                                                                setShowByggdelMallEditor(false);\r\n                                                                                setByggdelMallEditor(null);\r\n                                                                                setByggdelMallSectionsDraft([]);\r\n                                                                                setNewByggdelMallSectionTitle('');\r\n                                                                              }\r\n                                                                            } catch(e) {\r\n                                                                              const msg = (e && e.message) ? String(e.message) : '';\r\n                                                                              const code = e && e.code ? String(e.code) : '';\r\n                                                                              const isPermission = code === 'permission-denied' || (msg && msg.toLowerCase().includes('permission'));\r\n                                                                              if (isPermission) {\r\n                                                                                Alert.alert('Kunde inte radera', 'Du saknar behörighet att radera mallar i företaget.');\r\n                                                                              } else {\r\n                                                                                Alert.alert('Kunde inte radera', 'Försök igen.');\r\n                                                                              }\r\n                                                                            } finally {\r\n                                                                              setDeletingByggdelMallId('');\r\n                                                                            }\r\n                                                                          }\r\n                                                                        }\r\n                                                                      ]\r\n                                                                    );\r\n                                                                  }\r\n                                                                }\r\n                                                              ]\r\n                                                            );\r\n                                                          }}\r\n                                                          style={{\r\n                                                            paddingVertical: 10,\r\n                                                            paddingHorizontal: 12,\r\n                                                            borderRadius: 10,\r\n                                                            borderWidth: 1,\r\n                                                            borderColor: isSelectedMall ? '#1976D2' : '#e0e0e0',\r\n                                                            backgroundColor: isSelectedMall ? '#E8F0FF' : '#fff',\r\n                                                            marginBottom: 6,\r\n                                                            opacity: deletingByggdelMallId && deletingByggdelMallId === id ? 0.5 : 1,\r\n                                                          }}\r\n                                                        >\r\n                                                          <Text style={{ color: isSelectedMall ? '#1976D2' : '#444', fontWeight: isSelectedMall ? '700' : '500' }}>\r\n                                                            {name || '(namnlös mall)'}\r\n                                                          </Text>\r\n                                                        </TouchableOpacity>\r\n                                                      );\r\n                                                    })}\r\n                                                  </View>\r\n                                                )}\r\n\r\n                                                <TouchableOpacity\r\n                                                  onPress={() => {\r\n                                                    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                                                    setCreateByggdelMallContext({ huvudgrupp: hgKeyPrefix, moment: String(mm || '').trim(), momentKey });\r\n                                                    setNewByggdelMallName('');\r\n                                                    setShowCreateByggdelMallModal(true);\r\n                                                  }}\r\n                                                  style={{\r\n                                                    paddingVertical: 10,\r\n                                                    paddingHorizontal: 2,\r\n                                                    alignItems: 'flex-start',\r\n                                                  }}\r\n                                                  accessibilityRole=\"button\"\r\n                                                  accessibilityLabel=\"Skapa ny mall\"\r\n                                                >\r\n                                                  <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Skapa ny mall</Text>\r\n                                                </TouchableOpacity>\r\n                                              </View>\r\n                                            )}\r\n                                          </View>\r\n                                        ) : null}\r\n                                      </View>\r\n                                    );\r\n                                  })}\r\n                                </View>\r\n                              )}\r\n                            </View>\r\n                          ) : null}\r\n                        </View>\r\n                      );\r\n                      })}\r\n                    </View>\r\n                  )}\r\n\r\n                </View>\r\n\r\n                {/* Create mall overlay (inside Byggdel modal for iOS/Expo Go stability) */}\r\n                {showCreateByggdelMallModal ? (\r\n                  <View pointerEvents=\"box-none\" style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}>\r\n                    <View\r\n                      style={{\r\n                        flex: 1,\r\n                        justifyContent: 'flex-end',\r\n                        alignItems: 'center',\r\n                        paddingTop: 14,\r\n                        paddingHorizontal: 14,\r\n                        paddingBottom: createMallKeyboardHeight > 0 ? createMallKeyboardHeight : 14,\r\n                      }}\r\n                    >\r\n                      <View style={{ width: '100%', maxWidth: 380, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\r\n                        <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                          <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Skapa ny mall</Text>\r\n                          {!!(createByggdelMallContext && createByggdelMallContext.moment) ? (\r\n                            <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\r\n                              {String(createByggdelMallContext.moment || '').trim()}\r\n                            </Text>\r\n                          ) : null}\r\n                        </View>\r\n\r\n                        <View style={{ padding: 16 }}>\r\n                          <TextInput\r\n                            value={newByggdelMallName}\r\n                            onChangeText={setNewByggdelMallName}\r\n                            placeholder=\"Mallnamn\"\r\n                            placeholderTextColor=\"#888\"\r\n                            style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff' }}\r\n                          />\r\n                        </View>\r\n\r\n                        <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                          <TouchableOpacity onPress={closeCreateByggdelMallModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\r\n                            <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                          </TouchableOpacity>\r\n                          <TouchableOpacity onPress={submitCreateByggdelMall} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\r\n                            <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMall ? 'Sparar…' : 'Spara'}</Text>\r\n                          </TouchableOpacity>\r\n                        </View>\r\n                      </View>\r\n                    </View>\r\n                  </View>\r\n                ) : null}\r\n\r\n                <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                  <TouchableOpacity onPress={closeByggdelModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\r\n                    <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                  </TouchableOpacity>\r\n                  <TouchableOpacity\r\n                    onPress={() => {\r\n                      const hg = String(byggdelHuvudgruppDraft || '').trim();\r\n                      const mm = String(byggdelMomentDraft || '').trim();\r\n\r\n                      if (!hg) {\r\n                        setByggdelTemplate(null);\r\n                        setByggdel('');\r\n                        closeByggdelModal();\r\n                        return;\r\n                      }\r\n\r\n                      const hgKeyPrefix = String(hg || '').split('-')[0].trim();\r\n                      const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[hgKeyPrefix])) || [];\r\n                      const availableMoments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\r\n\r\n                      if (!mm && availableMoments.length > 0) {\r\n                        Alert.alert('Välj moment', 'Välj ett moment under vald byggdel innan du sparar.');\r\n                        return;\r\n                      }\r\n\r\n                      const mid = byggdelMallDraft && byggdelMallDraft.id ? String(byggdelMallDraft.id) : null;\r\n                      const mname = byggdelMallDraft && byggdelMallDraft.name ? String(byggdelMallDraft.name) : '';\r\n                      const tpl = mm\r\n                        ? (mid || mname ? { huvudgrupp: hg, moment: mm, mallId: mid, mallName: mname } : { huvudgrupp: hg, moment: mm })\r\n                        : { huvudgrupp: hg };\r\n\r\n                      const finishSave = () => {\r\n                        setByggdelTemplate(tpl);\r\n                        setByggdel(formatByggdelLabelFromTemplate(tpl));\r\n                        setShowCategoryModal(false);\r\n                        closeByggdelModal();\r\n                      };\r\n\r\n                      // If a mall is selected, apply its points as the Arbetsberedning checklist.\r\n                      if (controlType === 'Arbetsberedning' && (mid || mname)) {\r\n                        const mallList = Array.isArray(byggdelMallar) ? byggdelMallar : [];\r\n                        const selectedMall = (mid\r\n                          ? mallList.find(m => String(m && m.id ? m.id : '') === String(mid))\r\n                          : null) || mallList.find(m => {\r\n                          const nm = String(m && (m.name ?? '')).trim();\r\n                          const hg2 = String(m && (m.huvudgrupp ?? '')).trim();\r\n                          const mm2 = String(m && (m.moment ?? '')).trim();\r\n                          return !!mname && nm === String(mname).trim() && hg2 === hgKeyPrefix && mm2 === String(mm || '').trim();\r\n                        });\r\n                        const mallPoints = Array.isArray(selectedMall && selectedMall.points) ? selectedMall.points : [];\r\n                        const mallSections = Array.isArray(selectedMall && selectedMall.sections) ? selectedMall.sections : [];\r\n                        const nextChecklist = buildChecklistFromMallPoints({ mallName: mname || (selectedMall && selectedMall.name) || 'Mall', points: mallPoints, sections: mallSections });\r\n                        const shouldConfirm = hasAnyChecklistPoints(checklistRef.current);\r\n\r\n                        if (shouldConfirm) {\r\n                          Alert.alert(\r\n                            'Ersätta kontrollpunkter?',\r\n                            'Detta ersätter dina nuvarande punkter.',\r\n                            [\r\n                              { text: 'Avbryt', style: 'cancel' },\r\n                              {\r\n                                text: 'Fortsätt',\r\n                                style: 'destructive',\r\n                                onPress: () => {\r\n                                  setChecklist(nextChecklist);\r\n                                  setExpandedChecklist([]);\r\n                                  finishSave();\r\n                                }\r\n                              }\r\n                            ]\r\n                          );\r\n                          return;\r\n                        }\r\n\r\n                        setChecklist(nextChecklist);\r\n                        setExpandedChecklist([]);\r\n                        finishSave();\r\n                        return;\r\n                      }\r\n\r\n                      finishSave();\r\n                    }}\r\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\r\n                  >\r\n                    <Text style={{ color: '#1976D2', fontWeight: '600' }}>Spara</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n\r\n              {showAktivaByggdelarModal ? (\r\n                <View style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', zIndex: 350 }}>\r\n                  <Pressable onPress={() => setShowAktivaByggdelarModal(false)} style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0 }} />\r\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 20, width: 320, height: '80%', alignItems: 'stretch', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 8 }}>\r\n                    <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Aktiva byggdelar</Text>\r\n                    <ScrollView style={{ flex: 1, marginBottom: 12 }}>\r\n                      {(Array.isArray(byggdelHuvudgruppOptions) ? byggdelHuvudgruppOptions : []).map((hg) => {\r\n                        const prefix = String(hg || '').split('-')[0].trim();\r\n                        const isExpanded = String(aktivaByggdelarExpandedPrefix || '') === String(prefix || '');\r\n                        const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[prefix])) || [];\r\n                        const moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\r\n                        const draftSet = new Set((Array.isArray(aktivaByggdelarDraftKeys) ? aktivaByggdelarDraftKeys : []).map(x => String(x || '').trim()).filter(Boolean));\r\n\r\n                        return (\r\n                          <View key={`ab-hg-active-${hg}`} style={{ marginBottom: 6 }}>\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                                setAktivaByggdelarExpandedPrefix(prev => (String(prev || '') === String(prefix || '') ? '' : prefix));\r\n                              }}\r\n                              style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 10 }}\r\n                              hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\r\n                            >\r\n                              <Text style={{ fontSize: 15, color: '#222', fontWeight: '700', flex: 1 }} numberOfLines={2}>{hg}</Text>\r\n                              <Ionicons name={isExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\r\n                            </TouchableOpacity>\r\n\r\n                            {isExpanded ? (\r\n                              <View style={{ paddingLeft: 14, paddingBottom: 8 }}>\r\n                                {moments.length === 0 ? (\r\n                                  <Text style={{ color: '#666', marginBottom: 6 }}>Inga byggdelar finns ännu för denna nivå.</Text>\r\n                                ) : (\r\n                                  <View style={{ flexDirection: 'column' }}>\r\n                                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>\r\n                                      <TouchableOpacity\r\n                                        onPress={() => {\r\n                                          setAktivaByggdelarDraftKeys(prev => {\r\n                                            const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\r\n                                            const next = new Set(cur);\r\n                                            (Array.isArray(moments) ? moments : []).forEach(mm => {\r\n                                              const momentLabel = String(mm || '').trim();\r\n                                              if (!prefix || !momentLabel) return;\r\n                                              next.add(`${prefix}||${momentLabel}`);\r\n                                            });\r\n                                            return Array.from(next);\r\n                                          });\r\n                                        }}\r\n                                        style={{ paddingVertical: 6, paddingHorizontal: 0 }}\r\n                                        accessibilityRole=\"button\"\r\n                                        accessibilityLabel={`Välj alla byggdelar i ${hg}`}\r\n                                      >\r\n                                        <Text style={{ color: '#1976D2', fontWeight: '700', fontSize: 13 }}>Välj alla i nivån</Text>\r\n                                      </TouchableOpacity>\r\n                                      <TouchableOpacity\r\n                                        onPress={() => {\r\n                                          setAktivaByggdelarDraftKeys(prev => {\r\n                                            const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\r\n                                            const next = new Set(cur);\r\n                                            (Array.isArray(moments) ? moments : []).forEach(mm => {\r\n                                              const momentLabel = String(mm || '').trim();\r\n                                              if (!prefix || !momentLabel) return;\r\n                                              next.delete(`${prefix}||${momentLabel}`);\r\n                                            });\r\n                                            return Array.from(next);\r\n                                          });\r\n                                        }}\r\n                                        style={{ paddingVertical: 6, paddingHorizontal: 0 }}\r\n                                        accessibilityRole=\"button\"\r\n                                        accessibilityLabel={`Rensa byggdelar i ${hg}`}\r\n                                      >\r\n                                        <Text style={{ color: '#777', fontWeight: '700', fontSize: 13 }}>Rensa nivån</Text>\r\n                                      </TouchableOpacity>\r\n                                    </View>\r\n\r\n                                    {moments.map((mm) => {\r\n                                      const momentLabel = String(mm || '').trim();\r\n                                      const key = `${prefix}||${momentLabel}`;\r\n                                      const checked = !!(prefix && momentLabel && draftSet.has(key));\r\n                                      return (\r\n                                        <TouchableOpacity\r\n                                          key={`ab-mm-active-${prefix}-${momentLabel}`}\r\n                                          onPress={() => {\r\n                                            setAktivaByggdelarDraftKeys(prev => {\r\n                                              const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\r\n                                              if (!prefix || !momentLabel) return Array.from(cur);\r\n                                              if (cur.has(key)) cur.delete(key);\r\n                                              else cur.add(key);\r\n                                              return Array.from(cur);\r\n                                            });\r\n                                          }}\r\n                                          style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8 }}\r\n                                          hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\r\n                                        >\r\n                                          <Ionicons name={checked ? 'checkbox' : 'square-outline'} size={20} color={checked ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\r\n                                          <Text style={{ fontSize: 14, color: '#222', flex: 1 }} numberOfLines={2}>{momentLabel}</Text>\r\n                                        </TouchableOpacity>\r\n                                      );\r\n                                    })}\r\n                                  </View>\r\n                                )}\r\n                              </View>\r\n                            ) : null}\r\n                          </View>\r\n                        );\r\n                      })}\r\n                    </ScrollView>\r\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                      <TouchableOpacity onPress={() => setShowAktivaByggdelarModal(false)} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\r\n                        <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                      </TouchableOpacity>\r\n                      <TouchableOpacity\r\n                        onPress={() => {\r\n                          try {\r\n                            const draftSet = new Set((Array.isArray(aktivaByggdelarDraftKeys) ? aktivaByggdelarDraftKeys : [])\r\n                              .map(x => String(x || '').trim())\r\n                              .filter(x => !!x && x.includes('||')));\r\n\r\n                            const normalized = Array.from(draftSet);\r\n\r\n                            setAktivaByggdelarSelectedKeys(normalized);\r\n                            const pid = project && project.id ? String(project.id) : '';\r\n                            if (pid) {\r\n                              AsyncStorage.setItem(arbetsberedningActiveByggdelKey(pid), JSON.stringify({ selectedKeys: normalized })).catch((e) => {});\r\n                            }\r\n                          } catch(e) {}\r\n                          setShowAktivaByggdelarModal(false);\r\n                        }}\r\n                        style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\r\n                      >\r\n                        <Text style={{ color: '#1976D2', fontWeight: '600' }}>Bekräfta</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                </View>\r\n              ) : null}\r\n            </View>\r\n          </Modal>\r\n        )}\r\n\r\n        {/* Create mall popup (separate from Byggdel modal to avoid nested Modals) */}\r\n        {controlType === 'Arbetsberedning' && (\r\n          <Modal visible={showCreateByggdelMallModal && !showByggdelModal} transparent animationType=\"fade\" onRequestClose={() => {}}>\r\n            <View pointerEvents=\"box-none\" style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)' }}>\r\n              <View\r\n                style={{\r\n                  flex: 1,\r\n                  justifyContent: 'flex-end',\r\n                  alignItems: 'center',\r\n                  paddingTop: 14,\r\n                  paddingHorizontal: 14,\r\n                  paddingBottom: createMallKeyboardHeight > 0 ? createMallKeyboardHeight : 14,\r\n                }}\r\n              >\r\n                <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\r\n                  <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                    <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Skapa ny mall</Text>\r\n                    {!!(createByggdelMallContext && createByggdelMallContext.moment) ? (\r\n                      <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\r\n                        {String(createByggdelMallContext.moment || '').trim()}\r\n                      </Text>\r\n                    ) : null}\r\n                  </View>\r\n\r\n                <View style={{ padding: 16 }}>\r\n                  <TextInput\r\n                    value={newByggdelMallName}\r\n                    onChangeText={setNewByggdelMallName}\r\n                    placeholder=\"Mallnamn\"\r\n                    placeholderTextColor=\"#888\"\r\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff' }}\r\n                  />\r\n                </View>\r\n\r\n                  <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                    <TouchableOpacity onPress={closeCreateByggdelMallModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\r\n                      <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                    </TouchableOpacity>\r\n                    <TouchableOpacity onPress={submitCreateByggdelMall} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\r\n                      <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMall ? 'Sparar…' : 'Spara'}</Text>\r\n                    </TouchableOpacity>\r\n                  </View>\r\n                </View>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n        )}\r\n\r\n        {/* Byggdel mall editor (kontrollpunkter) */}\r\n        {controlType === 'Arbetsberedning' && (\r\n          <Modal\r\n            visible={showByggdelMallEditor}\r\n            transparent\r\n            animationType=\"fade\"\r\n            onRequestClose={() => {}}\r\n          >\r\n            <View pointerEvents=\"box-none\" style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n              <View style={{ width: '90%', maxWidth: 420, height: '85%', backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd', marginBottom: mallEditorKeyboardHeight > 0 ? Math.min(mallEditorKeyboardHeight, 220) : 0 }}>\r\n                <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                  <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }} numberOfLines={2}>\r\n                    {String(byggdelMallEditor && byggdelMallEditor.name ? byggdelMallEditor.name : 'Mall')}\r\n                  </Text>\r\n                  {!!(byggdelMallEditor && (byggdelMallEditor.huvudgrupp || byggdelMallEditor.moment)) ? (\r\n                    <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\r\n                      {String(byggdelMallEditor.huvudgrupp || '').trim()}{byggdelMallEditor.moment ? ` / ${String(byggdelMallEditor.moment || '').trim()}` : ''}\r\n                    </Text>\r\n                  ) : null}\r\n                </View>\r\n\r\n                <ScrollView style={{ flex: 1 }} keyboardShouldPersistTaps=\"handled\" contentContainerStyle={{ padding: 16 }}>\r\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 10 }}>\r\n                    Rubriker/huvudmoment. Tryck för att visa/dölja kontrollpunkter.\r\n                  </Text>\r\n\r\n                  {Array.isArray(byggdelMallSectionsDraft) && byggdelMallSectionsDraft.length > 0 ? (\r\n                    <View style={{ marginBottom: 12 }}>\r\n                      {byggdelMallSectionsDraft.map((sec) => {\r\n                        const sid = String(sec && sec.id ? sec.id : '');\r\n                        const title = String(sec && (sec.title || '')).trim();\r\n                        const pts = Array.isArray(sec && sec.points) ? sec.points : [];\r\n                        const isExpanded = sid && String(byggdelMallEditorExpandedSectionId || '') === sid;\r\n\r\n                        return (\r\n                          <View key={`bsec-${sid}`} style={{ marginBottom: 10, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', borderWidth: 1, borderColor: '#e0e0e0' }}>\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                                setByggdelMallEditorExpandedSectionId(prev => (String(prev || '') === sid ? '' : sid));\r\n                              }}\r\n                              style={{ flexDirection: 'row', alignItems: 'center', padding: 12, backgroundColor: isExpanded ? '#E8F0FF' : '#fff' }}\r\n                              accessibilityRole=\"button\"\r\n                              accessibilityLabel={`Visa eller dölj ${title || 'rubrik'}`}\r\n                            >\r\n                              <Ionicons name={isExpanded ? 'chevron-down' : 'chevron-forward'} size={18} color={isExpanded ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\r\n                              <Text style={{ flex: 1, color: isExpanded ? '#1976D2' : '#222', fontWeight: '700' }} numberOfLines={2}>\r\n                                {title || '(Rubrik)'}\r\n                              </Text>\r\n                            </TouchableOpacity>\r\n\r\n                            {isExpanded ? (\r\n                              <View style={{ padding: 12, paddingTop: 0 }}>\r\n                                <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>\r\n                                  <TextInput\r\n                                    value={title}\r\n                                    onChangeText={(txt) => {\r\n                                      setByggdelMallSectionsDraft(prev => {\r\n                                        const arr = Array.isArray(prev) ? prev : [];\r\n                                        return arr.map(s => {\r\n                                          if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                          return Object.assign({}, s, { title: txt });\r\n                                        });\r\n                                      });\r\n                                    }}\r\n                                    placeholder=\"Rubrik / huvudmoment\"\r\n                                    placeholderTextColor=\"#888\"\r\n                                    style={{ flex: 1, marginRight: 10, paddingVertical: 8, paddingHorizontal: 10, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 10, fontWeight: '700', color: '#222', backgroundColor: '#fff' }}\r\n                                  />\r\n                                  <TouchableOpacity\r\n                                    onPress={() => {\r\n                                      Alert.alert(\r\n                                        'Ta bort rubrik?',\r\n                                        `Vill du ta bort \"${title || '(Rubrik)'}\"?`,\r\n                                        [\r\n                                          { text: 'Avbryt', style: 'cancel' },\r\n                                          {\r\n                                            text: 'Ta bort',\r\n                                            style: 'destructive',\r\n                                            onPress: () => {\r\n                                              setByggdelMallSectionsDraft(prev => (Array.isArray(prev) ? prev.filter(s => String(s && s.id ? s.id : '') !== sid) : []));\r\n                                              setByggdelMallEditorExpandedSectionId(prev => (String(prev || '') === sid ? '' : prev));\r\n                                              setNewByggdelMallPointBySectionId(prev => {\r\n                                                const next = Object.assign({}, (prev && typeof prev === 'object') ? prev : {});\r\n                                                try { delete next[sid]; } catch(e) {}\r\n                                                return next;\r\n                                              });\r\n                                            }\r\n                                          }\r\n                                        ]\r\n                                      );\r\n                                    }}\r\n                                    accessibilityRole=\"button\"\r\n                                    accessibilityLabel=\"Ta bort rubrik\"\r\n                                    style={{ padding: 6 }}\r\n                                  >\r\n                                    <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\r\n                                  </TouchableOpacity>\r\n                                </View>\r\n\r\n                                {pts.length > 0 ? (\r\n                                  <View style={{ marginBottom: 10 }}>\r\n                                    {pts.map((p, idx) => {\r\n                                      const statusVal = (sec && Array.isArray(sec.statuses)) ? (sec.statuses[idx] ?? null) : null;\r\n                                      const photosOuter = (sec && Array.isArray(sec.photos)) ? sec.photos : [];\r\n                                      const photoList = Array.isArray(photosOuter[idx]) ? photosOuter[idx] : (photosOuter[idx] ? [photosOuter[idx]] : []);\r\n                                      const hasPhotos = Array.isArray(photoList) && photoList.length > 0;\r\n\r\n                                      return (\r\n                                        <View key={`bp-${sid}-${idx}`} style={{ flexDirection: 'row', alignItems: 'flex-start', justifyContent: 'space-between', paddingVertical: 8, paddingHorizontal: 10, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 10, marginBottom: 8, backgroundColor: '#fff' }}>\r\n                                          <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8, paddingTop: 2 }}>\r\n                                            <TouchableOpacity\r\n                                              onPress={() => {\r\n                                                setByggdelMallSectionsDraft(prev => {\r\n                                                  const arr = Array.isArray(prev) ? prev : [];\r\n                                                  return arr.map(s => {\r\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\r\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? [...s.statuses] : Array(pp.length).fill(null);\r\n                                                    const next = (statuses[idx] === 'ok') ? null : 'ok';\r\n                                                    statuses[idx] = next;\r\n                                                    return Object.assign({}, s, { statuses });\r\n                                                  });\r\n                                                });\r\n                                              }}\r\n                                              style={{ padding: 4, marginRight: 6 }}\r\n                                              accessibilityRole=\"button\"\r\n                                              accessibilityLabel=\"Markera som godkänd\"\r\n                                            >\r\n                                              <Ionicons name={statusVal === 'ok' ? 'checkmark-circle' : 'ellipse-outline'} size={20} color={statusVal === 'ok' ? '#43A047' : '#bbb'} />\r\n                                            </TouchableOpacity>\r\n                                            <TouchableOpacity\r\n                                              onPress={() => {\r\n                                                setByggdelMallSectionsDraft(prev => {\r\n                                                  const arr = Array.isArray(prev) ? prev : [];\r\n                                                  return arr.map(s => {\r\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\r\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? [...s.statuses] : Array(pp.length).fill(null);\r\n                                                    const next = (statuses[idx] === 'avvikelse') ? null : 'avvikelse';\r\n                                                    statuses[idx] = next;\r\n                                                    return Object.assign({}, s, { statuses });\r\n                                                  });\r\n                                                });\r\n                                              }}\r\n                                              style={{ padding: 4 }}\r\n                                              accessibilityRole=\"button\"\r\n                                              accessibilityLabel=\"Markera som avvikelse\"\r\n                                            >\r\n                                              <View style={{ width: 20, height: 20, borderRadius: 10, alignItems: 'center', justifyContent: 'center', backgroundColor: statusVal === 'avvikelse' ? '#D32F2F' : 'transparent' }}>\r\n                                                {statusVal === 'avvikelse' ? (\r\n                                                  <Ionicons name=\"alert\" size={14} color=\"#fff\" />\r\n                                                ) : (\r\n                                                  <Ionicons name=\"ellipse-outline\" size={20} color=\"#bbb\" />\r\n                                                )}\r\n                                              </View>\r\n                                            </TouchableOpacity>\r\n                                          </View>\r\n\r\n                                          <TextInput\r\n                                            value={String(p || '')}\r\n                                            onChangeText={(txt) => {\r\n                                              setByggdelMallSectionsDraft(prev => {\r\n                                                const arr = Array.isArray(prev) ? prev : [];\r\n                                                return arr.map(s => {\r\n                                                  if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                                  const pp = Array.isArray(s && s.points) ? [...s.points] : [];\r\n                                                  if (idx < 0 || idx >= pp.length) return s;\r\n                                                  pp[idx] = txt;\r\n                                                  return Object.assign({}, s, { points: pp });\r\n                                                });\r\n                                              });\r\n                                            }}\r\n                                            multiline\r\n                                            placeholderTextColor=\"#888\"\r\n                                            style={{ color: '#222', flex: 1, marginRight: 10, paddingVertical: 6, paddingHorizontal: 8, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, backgroundColor: '#fff', minHeight: 36, textAlignVertical: 'top' }}\r\n                                          />\r\n\r\n                                          <View style={{ flexDirection: 'row', alignItems: 'center', paddingTop: 2 }}>\r\n                                            <TouchableOpacity\r\n                                              onPress={() => {\r\n                                                if (hasPhotos) {\r\n                                                  setPhotoModal({ visible: true, uris: photoList, index: 0, mallSectionId: sid, mallPointIdx: idx });\r\n                                                  return;\r\n                                                }\r\n                                                handlePickMallPointFromLibrary(sid, idx);\r\n                                              }}\r\n                                              style={{ padding: 6, marginRight: 2 }}\r\n                                              accessibilityRole=\"button\"\r\n                                              accessibilityLabel={hasPhotos ? 'Visa bilder' : 'Lägg till bilder'}\r\n                                            >\r\n                                              <Ionicons name={hasPhotos ? 'camera' : 'camera-outline'} size={18} color={'#1976D2'} />\r\n                                            </TouchableOpacity>\r\n                                            <TouchableOpacity\r\n                                              onPress={() => {\r\n                                                setByggdelMallSectionsDraft(prev => {\r\n                                                  const arr = Array.isArray(prev) ? prev : [];\r\n                                                  return arr.map(s => {\r\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\r\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? s.statuses : Array(pp.length).fill(null);\r\n                                                    const photos = Array.isArray(s && s.photos) && s.photos.length === pp.length ? s.photos : Array(pp.length).fill(null).map(() => []);\r\n                                                    return Object.assign({}, s, {\r\n                                                      points: pp.filter((_, i) => i !== idx),\r\n                                                      statuses: statuses.filter((_, i) => i !== idx),\r\n                                                      photos: photos.filter((_, i) => i !== idx),\r\n                                                    });\r\n                                                  });\r\n                                                });\r\n                                              }}\r\n                                              accessibilityRole=\"button\"\r\n                                              accessibilityLabel=\"Ta bort kontrollpunkt\"\r\n                                              style={{ padding: 6 }}\r\n                                            >\r\n                                              <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\r\n                                            </TouchableOpacity>\r\n                                          </View>\r\n                                        </View>\r\n                                      );\r\n                                    })}\r\n                                  </View>\r\n                                ) : (\r\n                                  <Text style={{ color: '#666', marginBottom: 10 }}>Inga kontrollpunkter under denna rubrik ännu.</Text>\r\n                                )}\r\n\r\n                                <Text style={{ fontSize: 13, color: '#444', marginBottom: 6 }}>Lägg till kontrollpunkt</Text>\r\n                                <TextInput\r\n                                  value={String((newByggdelMallPointBySectionId && newByggdelMallPointBySectionId[sid]) ? newByggdelMallPointBySectionId[sid] : '')}\r\n                                  onChangeText={(txt) => {\r\n                                    setNewByggdelMallPointBySectionId(prev => Object.assign({}, (prev && typeof prev === 'object') ? prev : {}, { [sid]: txt }));\r\n                                  }}\r\n                                  multiline\r\n                                  placeholder=\"Ny kontrollpunkt\"\r\n                                  placeholderTextColor=\"#888\"\r\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', marginBottom: 10, minHeight: 44, textAlignVertical: 'top' }}\r\n                                />\r\n                                <TouchableOpacity\r\n                                  onPress={() => {\r\n                                    const raw = (newByggdelMallPointBySectionId && newByggdelMallPointBySectionId[sid]) ? newByggdelMallPointBySectionId[sid] : '';\r\n                                    const txt = String(raw || '').trim();\r\n                                    if (!txt) {\r\n                                      Alert.alert('Ange text', 'Skriv en kontrollpunkt.');\r\n                                      return;\r\n                                    }\r\n                                    setByggdelMallSectionsDraft(prev => {\r\n                                      const arr = Array.isArray(prev) ? prev : [];\r\n                                      return arr.map(s => {\r\n                                        if (String(s && s.id ? s.id : '') !== sid) return s;\r\n                                        const pp = Array.isArray(s && s.points) ? s.points : [];\r\n                                        const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? s.statuses : Array(pp.length).fill(null);\r\n                                        const photos = Array.isArray(s && s.photos) && s.photos.length === pp.length ? s.photos : Array(pp.length).fill(null).map(() => []);\r\n                                        return Object.assign({}, s, {\r\n                                          points: [...pp, txt],\r\n                                          statuses: [...statuses, null],\r\n                                          photos: [...photos, []],\r\n                                        });\r\n                                      });\r\n                                    });\r\n                                    setNewByggdelMallPointBySectionId(prev => Object.assign({}, (prev && typeof prev === 'object') ? prev : {}, { [sid]: '' }));\r\n                                  }}\r\n                                  style={{ paddingVertical: 10, paddingHorizontal: 12, borderRadius: 10, borderWidth: 1, borderColor: '#1976D2', backgroundColor: '#E8F0FF', alignItems: 'center' }}\r\n                                  accessibilityRole=\"button\"\r\n                                  accessibilityLabel=\"Lägg till kontrollpunkt\"\r\n                                >\r\n                                  <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Lägg till kontrollpunkt</Text>\r\n                                </TouchableOpacity>\r\n                              </View>\r\n                            ) : null}\r\n                          </View>\r\n                        );\r\n                      })}\r\n                    </View>\r\n                  ) : (\r\n                    <Text style={{ color: '#666', marginBottom: 12 }}>Inga rubriker ännu.</Text>\r\n                  )}\r\n\r\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 6 }}>Lägg till rubrik</Text>\r\n                  <TextInput\r\n                    value={newByggdelMallSectionTitle}\r\n                    onChangeText={setNewByggdelMallSectionTitle}\r\n                    placeholder=\"Ny rubrik / huvudmoment\"\r\n                    placeholderTextColor=\"#888\"\r\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', marginBottom: 10 }}\r\n                  />\r\n\r\n                  <TouchableOpacity\r\n                    onPress={() => {\r\n                      const title = String(newByggdelMallSectionTitle || '').trim();\r\n                      if (!title) {\r\n                        Alert.alert('Ange rubrik', 'Skriv en rubrik/huvudmoment.');\r\n                        return;\r\n                      }\r\n                      const sid = `sec-${Date.now()}-${Math.random().toString(16).slice(2)}`;\r\n                      setByggdelMallSectionsDraft(prev => {\r\n                        const arr = Array.isArray(prev) ? prev : [];\r\n                        return [...arr, { id: sid, title, points: [], statuses: [], photos: [] }];\r\n                      });\r\n                      setNewByggdelMallSectionTitle('');\r\n                      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                      setByggdelMallEditorExpandedSectionId(sid);\r\n                    }}\r\n                    style={{ paddingVertical: 10, paddingHorizontal: 12, borderRadius: 10, borderWidth: 1, borderColor: '#1976D2', backgroundColor: '#E8F0FF', alignItems: 'center', marginBottom: 14 }}\r\n                    accessibilityRole=\"button\"\r\n                    accessibilityLabel=\"Lägg till rubrik\"\r\n                  >\r\n                    <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Lägg till rubrik</Text>\r\n                  </TouchableOpacity>\r\n                </ScrollView>\r\n\r\n                <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                  <TouchableOpacity\r\n                    onPress={() => setShowByggdelMallEditor(false)}\r\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\r\n                    accessibilityRole=\"button\"\r\n                    accessibilityLabel=\"Stäng mall\"\r\n                  >\r\n                    <Text style={{ color: '#777' }}>Stäng</Text>\r\n                  </TouchableOpacity>\r\n                  <TouchableOpacity\r\n                    onPress={async () => {\r\n                      try {\r\n                        if (!byggdelMallEditor || !byggdelMallEditor.id) return;\r\n                        if (savingByggdelMallPoints) return;\r\n                        setSavingByggdelMallPoints(true);\r\n                        const secs = Array.isArray(byggdelMallSectionsDraft) ? byggdelMallSectionsDraft : [];\r\n                        const sectionsForSave = secs\r\n                          .map(s => {\r\n                            const title = String(s && (s.title || '')).trim();\r\n                            const rawPts = Array.isArray(s && s.points) ? s.points : [];\r\n                            const rawStatuses = Array.isArray(s && s.statuses) ? s.statuses : [];\r\n                            const rawPhotosOuter = Array.isArray(s && s.photos) ? s.photos : [];\r\n                            const normalizeStatus = (v) => (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\r\n                            const items = rawPts\r\n                              .map((p, i) => ({\r\n                                text: String(p || '').trim(),\r\n                                status: rawStatuses[i],\r\n                                photos: rawPhotosOuter[i],\r\n                              }))\r\n                              .filter(it => !!it.text);\r\n                            const pts = items.map(it => it.text);\r\n                            const statuses = items.map(it => normalizeStatus(it.status));\r\n                            const photos = items.map(it => {\r\n                              const list = Array.isArray(it.photos) ? it.photos : (it.photos ? [it.photos] : []);\r\n                              return list\r\n                                .map(item => {\r\n                                  if (!item) return null;\r\n                                  if (typeof item === 'string') return item;\r\n                                  if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\r\n                                  return null;\r\n                                })\r\n                                .filter(Boolean);\r\n                            });\r\n                            return { title, points: pts, statuses, photos };\r\n                          })\r\n                          .filter(s => String(s && s.title ? s.title : '').trim() || (Array.isArray(s && s.points) && s.points.length > 0));\r\n                        const flatPoints = sectionsForSave.reduce((acc, s) => acc.concat(Array.isArray(s.points) ? s.points : []), []);\r\n                        const ok = await updateByggdelMall({ mallId: byggdelMallEditor.id, patch: { sections: sectionsForSave, points: flatPoints } });\r\n                        if (!ok) {\r\n                          Alert.alert('Kunde inte spara', 'Försök igen.');\r\n                          return;\r\n                        }\r\n                        await refreshByggdelMallar();\r\n                        setShowByggdelMallEditor(false);\r\n                      } catch(e) {\r\n                        Alert.alert('Kunde inte spara', 'Försök igen.');\r\n                      } finally {\r\n                        setSavingByggdelMallPoints(false);\r\n                      }\r\n                    }}\r\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\r\n                    accessibilityRole=\"button\"\r\n                    accessibilityLabel=\"Spara kontrollpunkter\"\r\n                  >\r\n                    <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMallPoints ? 'Sparar…' : 'Spara'}</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n        )}\r\n        {/* Material description for Mottagningskontroll */}\r\n        {controlType === 'Mottagningskontroll' && (\r\n          <View style={{ marginTop: 8, marginBottom: 10, paddingHorizontal: 16 }}>\r\n            <Text style={{ fontSize: 15, color: (missingFields && missingFields.includes('Beskriv leverans')) ? '#D32F2F' : '#222', marginBottom: 6, fontWeight: '600' }}>Beskriv leverans</Text>\r\n            <TextInput\r\n              value={materialDesc}\r\n              onChangeText={setMaterialDesc}\r\n              placeholder=\"Ex: Gipsskivor, isolering, fönster...\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n            />\r\n          </View>\r\n        )}\r\n\r\n        {/* Beskriv arbetsmoment endast för Riskbedömning */}\r\n        {controlType === 'Riskbedömning' && (\r\n          <View style={{ marginTop: 8, marginBottom: 10, paddingHorizontal: 16 }}>\r\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 6, fontWeight: '600' }}>Beskriv arbetsmoment</Text>\r\n            <TextInput\r\n              value={deliveryDesc}\r\n              onChangeText={setDeliveryDesc}\r\n              placeholder=\"Vad ska göras? T.ex. Lossning av stålbalkar\"\r\n              placeholderTextColor=\"#888\"\r\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n              multiline\r\n            />\r\n          </View>\r\n        )}\r\n        {/* Button to choose categories for Arbetsberedning */}\r\n        {controlType === 'Arbetsberedning' && Array.isArray(checklistConfig) && (\r\n          <View style={{ paddingHorizontal: 16, marginBottom: 8 }}>\r\n            <TouchableOpacity\r\n              onPress={() => {\r\n                if (byggdelMallLocksCategories) return;\r\n                setShowCategoryModal(true);\r\n              }}\r\n              disabled={byggdelMallLocksCategories}\r\n              style={{\r\n                flexDirection: 'row',\r\n                alignItems: 'center',\r\n                paddingVertical: 10,\r\n                paddingHorizontal: 10,\r\n                borderRadius: 10,\r\n                backgroundColor: (Array.isArray(checklist) && checklist.length > 0) ? 'transparent' : '#E8F0FF',\r\n                borderWidth: (Array.isArray(checklist) && checklist.length > 0) ? 0 : 1,\r\n                borderColor: (Array.isArray(checklist) && checklist.length > 0) ? 'transparent' : '#1976D2',\r\n                opacity: byggdelMallLocksCategories ? 0.4 : 1,\r\n              }}\r\n              accessibilityRole=\"button\"\r\n            >\r\n              <Ionicons name=\"options-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\r\n              <Text style={{ color: '#1976D2', fontWeight: '600', fontSize: 16 }}>Välj kategorier att gå igenom</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n        )}\r\n        {/* Add Participant Modal */}\r\n        {/* Modal för Lägg till deltagare */}\r\n        <Modal visible={showAddParticipantModal} transparent animationType=\"fade\" onRequestClose={() => setShowAddParticipantModal(false)}>\r\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)' }}>\r\n            <KeyboardAvoidingView\r\n              behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\r\n              keyboardVerticalOffset={Platform.OS === 'ios' ? 60 : 20}\r\n              style={{ flex: 1 }}\r\n            >\r\n              <ScrollView keyboardShouldPersistTaps=\"handled\" contentContainerStyle={{ flexGrow: 1, justifyContent: 'center', alignItems: 'center', paddingTop: 140, paddingBottom: 24 }}>\r\n                <View style={{ width: '100%', maxWidth: 300, backgroundColor: '#fff', borderRadius: 12, padding: 16, marginTop: 0, marginVertical: 8 }}>\r\n                  <TouchableOpacity\r\n                    onPress={() => setShowAddParticipantModal(false)}\r\n                    style={{ position: 'absolute', top: 8, right: 8, zIndex: 10, padding: 6 }}\r\n                    accessibilityLabel=\"Stäng\"\r\n                    hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}\r\n                  >\r\n                    <Ionicons name=\"close\" size={22} color=\"#888\" />\r\n                  </TouchableOpacity>\r\n                  <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 8, textAlign: 'center' }}>{editParticipantIndex !== null ? editParticipantsLabel : addParticipantsLabel}</Text>\r\n                  <TextInput\r\n                    value={participantName}\r\n                    onChangeText={setParticipantName}\r\n                    placeholder=\"Namn\"\r\n                    placeholderTextColor=\"#888\"\r\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\r\n                    returnKeyType=\"next\"\r\n                    onSubmitEditing={() => companyRef && companyRef.current && companyRef.current.focus()}\r\n                    ref={nameRef}\r\n                  />\r\n                  <TextInput\r\n                    value={participantCompany}\r\n                    onChangeText={setParticipantCompany}\r\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\r\n                    placeholderTextColor=\"#888\"\r\n                    placeholder=\"Företag\"\r\n                    autoCapitalize=\"words\"\r\n                    autoCorrect={false}\r\n                    returnKeyType=\"next\"\r\n                    onSubmitEditing={() => roleRef && roleRef.current && roleRef.current.focus()}\r\n                    ref={companyRef}\r\n                  />\r\n                  <TextInput\r\n                    value={participantRole}\r\n                    onChangeText={setParticipantRole}\r\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\r\n                    placeholderTextColor=\"#888\"\r\n                    placeholder=\"Roll\"\r\n                    autoCapitalize=\"words\"\r\n                    autoCorrect={false}\r\n                    returnKeyType=\"next\"\r\n                    onSubmitEditing={() => phoneRef && phoneRef.current && phoneRef.current.focus()}\r\n                    ref={roleRef}\r\n                  />\r\n                  <TextInput\r\n                    value={participantPhone}\r\n                    onChangeText={text => {\r\n                      // Only allow numbers, auto-insert spaces: xxx xxx xx xx\r\n                      let cleaned = text.replace(/[^0-9]/g, '');\r\n                      if (cleaned.length > 10) cleaned = cleaned.slice(0, 10);\r\n                      let formatted = cleaned;\r\n                      if (cleaned.length > 3) formatted = cleaned.slice(0, 3) + ' ' + cleaned.slice(3);\r\n                      if (cleaned.length > 6) formatted = formatted.slice(0, 7) + ' ' + formatted.slice(7);\r\n                      if (cleaned.length > 8) formatted = formatted.slice(0, 10) + ' ' + formatted.slice(10);\r\n                      setParticipantPhone(formatted);\r\n                    }}\r\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 16 }}\r\n                    placeholderTextColor=\"#888\"\r\n                    placeholder=\"Mobilnummer\"\r\n                    keyboardType=\"numeric\"\r\n                    autoCapitalize=\"none\"\r\n                    autoCorrect={false}\r\n                    maxLength={13}\r\n                    returnKeyType=\"done\"\r\n                    onSubmitEditing={() => {\r\n                      // Save or update participant\r\n                      if (!participantName.trim()) return;\r\n                      const newP = { name: participantName.trim(), company: participantCompany.trim(), role: participantRole.trim(), phone: participantPhone.trim() };\r\n                      if (editParticipantIndex !== null && editParticipantIndex >= 0) {\r\n                        setLocalParticipants(prev => {\r\n                          const a = Array.isArray(prev) ? [...prev] : [];\r\n                          a[editParticipantIndex] = newP;\r\n                          return a;\r\n                        });\r\n                      } else {\r\n                        setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), newP]));\r\n                      }\r\n                      setShowAddParticipantModal(false);\r\n                      setParticipantName('');\r\n                      setParticipantCompany('');\r\n                      setParticipantRole('');\r\n                      setParticipantPhone('');\r\n                      setEditParticipantIndex(null);\r\n                    }}\r\n                    ref={phoneRef}\r\n                  />\r\n                  <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\r\n                    <TouchableOpacity\r\n                      style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\r\n                      onPress={() => {\r\n                        if (!participantName.trim()) return;\r\n                        const newP = { name: participantName.trim(), company: participantCompany.trim(), role: participantRole.trim(), phone: participantPhone.trim() };\r\n                        if (editParticipantIndex !== null && editParticipantIndex >= 0) {\r\n                          setLocalParticipants(prev => {\r\n                            const a = Array.isArray(prev) ? [...prev] : [];\r\n                            a[editParticipantIndex] = newP;\r\n                            return a;\r\n                          });\r\n                        } else {\r\n                          setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), newP]));\r\n                        }\r\n                        setShowAddParticipantModal(false);\r\n                        setParticipantName('');\r\n                        setParticipantCompany('');\r\n                        setParticipantRole('');\r\n                        setParticipantPhone('');\r\n                        setEditParticipantIndex(null);\r\n                      }}\r\n                      disabled={!participantName.trim()}\r\n                    >\r\n                      <Text style={{ color: '#1976D2', fontWeight: '400', fontSize: 16, opacity: participantName.trim() ? 1 : 0.4 }}>{editParticipantIndex !== null ? 'Spara' : 'Spara'}</Text>\r\n                    </TouchableOpacity>\r\n                    <TouchableOpacity\r\n                      style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\r\n                      onPress={() => {\r\n                        setShowAddParticipantModal(false);\r\n                        setParticipantName('');\r\n                        setParticipantCompany('');\r\n                        setParticipantRole('');\r\n                        setParticipantPhone('');\r\n                        setEditParticipantIndex(null);\r\n                      }}\r\n                    >\r\n                      <Text style={{ color: '#D32F2F', fontWeight: '400', fontSize: 16 }}>Avbryt</Text>\r\n                    </TouchableOpacity>\r\n                  </View>\r\n                </View>\r\n              </ScrollView>\r\n            </KeyboardAvoidingView>\r\n          </View>\r\n        </Modal>\r\n        {/* Divider under participants, before weather (removed duplicate) */}\r\n        {/* Modal to add an extra signer (used by Lägg till signerare) */}\r\n        <Modal visible={showAddSignerModal} transparent animationType=\"fade\" onRequestClose={() => setShowAddSignerModal(false)}>\r\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n            <View style={{ width: '90%', maxWidth: 340, backgroundColor: '#fff', borderRadius: 12, padding: 16 }}>\r\n              <TouchableOpacity onPress={() => { setShowAddSignerModal(false); setSignerName(''); }} style={{ position: 'absolute', top: 8, right: 8, zIndex: 10, padding: 6 }}>\r\n                <Ionicons name=\"close\" size={22} color=\"#888\" />\r\n              </TouchableOpacity>\r\n              <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 12, textAlign: 'center' }}>Lägg till signerare</Text>\r\n              <TextInput\r\n                value={signerName}\r\n                onChangeText={setSignerName}\r\n                placeholder=\"Namn på signerare\"\r\n                placeholderTextColor=\"#888\"\r\n                style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 10, fontSize: 16, marginBottom: 12 }}\r\n              />\r\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                <TouchableOpacity onPress={() => { setShowAddSignerModal(false); setSignerName(''); }} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\r\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity onPress={() => {\r\n                  const name = (signerName || '').trim();\r\n                  if (!name) return;\r\n                  setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), { name }]));\r\n                  setSignerName('');\r\n                  setShowAddSignerModal(false);\r\n                }} style={{ flex: 1, alignItems: 'center', paddingVertical: 12 }}>\r\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Lägg till</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </View>\r\n        </Modal>\r\n\r\n        {/* Omfattning / beskrivning för Skyddsrond */}\r\n        {controlType === 'Skyddsrond' && (\r\n          <View style={{ marginTop: 8, marginBottom: 12, paddingHorizontal: 16 }}>\r\n            <Text style={{ fontSize: 15, color: (missingFields && missingFields.includes('Omfattning / beskrivning av skyddsrond')) ? '#D32F2F' : '#222', marginBottom: 4, fontWeight: 'bold' }}>Omfattning / beskrivning av skyddsrond</Text>\r\n            <TextInput\r\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\r\n              value={deliveryDesc}\r\n              onChangeText={setDeliveryDesc}\r\n              placeholder=\"Ex: Hus A, yttertak, ställning, endast inomhus eller utomhus...\"\r\n              placeholderTextColor=\"#bbb\"\r\n              multiline\r\n            />\r\n            {/* Divider under Omfattning */}\r\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 12, marginBottom: 0 }} />\r\n          </View>\r\n        )}\r\n        {/* Category selection modal for Arbetsberedning */}\r\n        {showCategoryModal && !byggdelMallLocksCategories && (\r\n          <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'flex-start', alignItems: 'center', zIndex: 300 }}>\r\n            <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 20, width: 320, maxHeight: '70%', alignItems: 'stretch', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 8, marginTop: 120 }}>\r\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Välj kategorier</Text>\r\n              <ScrollView style={{ marginBottom: 12 }}>\r\n                {Array.isArray(checklistConfig) && checklistConfig.map((sec, idx) => (\r\n                  <TouchableOpacity\r\n                    key={`cat-${idx}`}\r\n                    onPress={() => setSelectedCategories(prev => { const s = [...prev]; s[idx] = !s[idx]; return s; })}\r\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8 }}\r\n                    hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\r\n                  >\r\n                    <Ionicons name={selectedCategories[idx] ? 'checkbox' : 'square-outline'} size={20} color={selectedCategories[idx] ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\r\n                    <Text style={{ fontSize: 15, color: '#222' }}>{sec.label}</Text>\r\n                  </TouchableOpacity>\r\n                ))}\r\n              </ScrollView>\r\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\r\n                <TouchableOpacity onPress={() => setShowCategoryModal(false)} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\r\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity\r\n                  onPress={() => {\r\n                    applySelectedCategoriesToChecklist(selectedCategories);\r\n\r\n                    // Persist as project default (local device) for Arbetsberedning\r\n                    if (controlType === 'Arbetsberedning') {\r\n                      try {\r\n                        const pid = project && project.id ? String(project.id) : '';\r\n                        const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\r\n                        if (pid && cfg.length > 0 && Array.isArray(selectedCategories) && selectedCategories.length === cfg.length) {\r\n                          const selectedLabels = cfg.filter((_, i) => !!selectedCategories[i]).map(sec => sec && sec.label ? sec.label : '').filter(Boolean);\r\n                          AsyncStorage.setItem(arbetsberedningCategoryKey(pid), JSON.stringify({ selectedLabels })).catch((e) => {});\r\n                        }\r\n                      } catch(e) {}\r\n                    }\r\n                    setShowCategoryModal(false);\r\n                  }}\r\n                  style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\r\n                >\r\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Bekräfta</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n            </View>\r\n          </View>\r\n        )}\r\n      {/* Checklist rendering for Skyddsrond och andra kontroller */}\r\n      {(controlType === 'Arbetsberedning' || (Array.isArray(checklist) && checklist.length > 0)) && (\r\n        <View style={{ marginTop: 8, marginBottom: 16, paddingHorizontal: 16 }}>\r\n          <Text style={{ fontSize: 18, fontWeight: 'bold', color: (missingFields && missingFields.includes('Kontrollpunkter')) ? '#D32F2F' : '#222', marginBottom: 10, marginLeft: 2 }}>Kontrollpunkter</Text>\r\n          {(!Array.isArray(checklist) || checklist.length === 0) ? (\r\n            <Text style={{ color: '#666', fontSize: 14, marginLeft: 2 }}>\r\n              Inga kategorier är valda än. Tryck på “Välj kategorier att gå igenom” ovan.\r\n            </Text>\r\n          ) : null}\r\n          {(Array.isArray(checklist) ? checklist : []).map((section, sectionIdx) => {\r\n            const expanded = expandedChecklist.includes(sectionIdx);\r\n            // Check if any point in this section is not filled in\r\n            const sectionStatuses = checklist[sectionIdx]?.statuses || [];\r\n            const anyMissing = section.points.some((_, idx) => !sectionStatuses[idx]);\r\n            let sectionHeaderBg = anyMissing ? '#FFE5E5' : '#e9ecef';\r\n            let sectionHeaderText = anyMissing ? '#D32F2F' : '#222';\r\n            // Ikonlogik: visa fotoikon om något foto finns, varning om någon avvikelse, grön check om alla är ifyllda (oavsett status)\r\n            const allFilled = section.points.every((_, idx) => !!sectionStatuses[idx]);\r\n            // Only consider unhandled avvikelser as active warnings\r\n            const hasAvvikelse = (sectionStatuses || []).some((s, si) => s === 'avvikelse' && !(section.remediation && section.remediation[(section.points || [])[si]]));\r\n\r\n            // Web: make sections with unhandled deviations stand out in yellow\r\n            if (Platform.OS === 'web' && !anyMissing && hasAvvikelse) {\r\n              sectionHeaderBg = '#FFD600';\r\n              sectionHeaderText = '#222';\r\n            }\r\n\r\n            const photos = checklist[sectionIdx]?.photos || [];\r\n            const hasPhoto = photos.some(photoArr => Array.isArray(photoArr) && photoArr.length > 0);\r\n            // Web-only: show a small thumbnail preview in the row when photos exist\r\n            let sectionPhotoItems = [];\r\n            let sectionThumbIndex = 0;\r\n            let sectionThumbUri = null;\r\n            if (hasPhoto) {\r\n              try {\r\n                const out = [];\r\n                const outer = Array.isArray(photos) ? photos : [];\r\n                for (const arr of outer) {\r\n                  const inner = Array.isArray(arr) ? arr : (arr ? [arr] : []);\r\n                  for (const item of inner) {\r\n                    const uri = (item && typeof item === 'object' && item.uri) ? item.uri : item;\r\n                    if (uri) out.push(item);\r\n                  }\r\n                }\r\n                sectionPhotoItems = out;\r\n                if (out.length > 0) {\r\n                  sectionThumbIndex = out.length - 1;\r\n                  const thumbItem = out[sectionThumbIndex];\r\n                  sectionThumbUri = (thumbItem && typeof thumbItem === 'object' && thumbItem.uri) ? thumbItem.uri : thumbItem;\r\n                }\r\n              } catch(e) {\r\n                sectionPhotoItems = [];\r\n                sectionThumbIndex = 0;\r\n                sectionThumbUri = null;\r\n              }\r\n            }\r\n            // Show green check if all filled, regardless of status\r\n            const showGreenCheck = allFilled;\r\n\r\n            // Web-only helper: find the first unhandled deviation in this section\r\n            const firstUnhandledDeviationIdx = (() => {\r\n              try {\r\n                const pts = Array.isArray(section.points) ? section.points : [];\r\n                for (let i = 0; i < pts.length; i++) {\r\n                  if ((sectionStatuses || [])[i] !== 'avvikelse') continue;\r\n                  const pt = pts[i];\r\n                  const rem = section.remediation && section.remediation[pt];\r\n                  if (!rem) return i;\r\n                }\r\n              } catch(e) {}\r\n              return -1;\r\n            })();\r\n\r\n            return (\r\n                <View key={section.id ? `section-${section.id}` : btoa(unescape(encodeURIComponent(section.label))) + '-' + sectionIdx} style={{ marginBottom: 10, backgroundColor: '#fff', borderRadius: 8, overflow: 'hidden', borderWidth: 1, borderColor: '#e0e0e0' }}>\r\n                <TouchableOpacity\r\n                  style={{ flexDirection: 'row', alignItems: 'center', padding: 14, backgroundColor: sectionHeaderBg }}\r\n                  onPress={() => {\r\n                    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n                    setExpandedChecklist(prev => prev.includes(sectionIdx) ? [] : [sectionIdx]);\r\n                  }}\r\n                  activeOpacity={0.7}\r\n                  hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}\r\n                  accessibilityRole=\"button\"\r\n                  accessibilityLabel={`Visa eller dölj ${section.label}`}\r\n                >\r\n                  <Ionicons name={expanded ? 'chevron-down' : 'chevron-forward'} size={20} color={'#1976D2'} style={{ marginRight: 8 }} />\r\n                  <View style={{ flex: 1, flexDirection: 'column' }}>\r\n                    <Text numberOfLines={1} ellipsizeMode=\"tail\" style={{ fontSize: 16, fontWeight: 'bold', color: sectionHeaderText }}>{section.label}</Text>\r\n                    {(() => {\r\n                      // Count only unhandled deviations (exclude points with saved remediation info)\r\n                      const deviationCount = (sectionStatuses || []).reduce((acc, s, si) => {\r\n                        const rem = section.remediation && section.remediation[(section.points || [])[si]];\r\n                        return acc + ((s === 'avvikelse' && !rem) ? 1 : 0);\r\n                      }, 0);\r\n                      const okCount = (sectionStatuses || []).filter(s => s === 'ok').length;\r\n                      const notRelevantCount = (sectionStatuses || []).filter(s => s === 'ejaktuell').length;\r\n                      const total = (section.points || []).length || 0;\r\n                      const filledCount = okCount + deviationCount + notRelevantCount;\r\n\r\n                      // Web: always show labels + counts (even when 0)\r\n                      if (Platform.OS === 'web') {\r\n                        return (\r\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6, flexWrap: 'wrap' }}>\r\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 4 }} />\r\n                            <Text style={{ fontSize: 12, color: '#43A047', marginRight: 10 }}>{`Godkänd ${okCount}`}</Text>\r\n                            <Ionicons name=\"alert-circle\" size={18} color=\"#D32F2F\" style={{ marginRight: 4 }} />\r\n                            <Text style={{ fontSize: 12, color: '#D32F2F', marginRight: 10 }}>{`Avvikelse ${deviationCount}`}</Text>\r\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 4 }} />\r\n                            <Text style={{ fontSize: 12, color: '#607D8B' }}>{`Ej aktuell ${notRelevantCount}`}</Text>\r\n                          </View>\r\n                        );\r\n                      }\r\n\r\n                      if (filledCount === 0) {\r\n                        // Show legend only if nothing is filled\r\n                        return (\r\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6 }}>\r\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 2 }} />\r\n                            <Text style={{ fontSize: 11, color: '#43A047', marginRight: 8 }}>Godkänd</Text>\r\n                            <Ionicons name=\"alert-circle\" size={18} color=\"#D32F2F\" style={{ marginRight: 2 }} />\r\n                            <Text style={{ fontSize: 11, color: '#D32F2F', marginRight: 8 }}>Avvikelse</Text>\r\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 2 }} />\r\n                            <Text style={{ fontSize: 11, color: '#607D8B' }}>Ej aktuell</Text>\r\n                          </View>\r\n                        );\r\n                      } else {\r\n                        // Native: compact icon + count only\r\n                        return (\r\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6 }}>\r\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 2 }} />\r\n                            <Text style={{ fontSize: 13, color: '#43A047', fontWeight: '600', marginRight: 12 }}>{okCount}</Text>\r\n                            <View style={{ width: 18, height: 18, borderRadius: 9, backgroundColor: '#D32F2F', alignItems: 'center', justifyContent: 'center', marginRight: 2 }}>\r\n                              <Ionicons name=\"alert\" size={13} color=\"#fff\" />\r\n                            </View>\r\n                            <Text style={{ fontSize: 13, color: '#D32F2F', fontWeight: '600', marginRight: 12 }}>{deviationCount}</Text>\r\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 2 }} />\r\n                            <Text style={{ fontSize: 13, color: '#607D8B', fontWeight: '600' }}>{notRelevantCount}</Text>\r\n                          </View>\r\n                        );\r\n                      }\r\n                    })()}\r\n                  </View>\r\n                  {/* Camera / check icons */}\r\n                  {Platform.OS === 'web' && controlType === 'Skyddsrond' && hasAvvikelse && firstUnhandledDeviationIdx >= 0 && (\r\n                    <TouchableOpacity\r\n                      onPress={(e) => {\r\n                        try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\r\n                        try { setExpandedChecklist([sectionIdx]); } catch(e) {}\r\n                        try {\r\n                          setRemediationModal({\r\n                            visible: true,\r\n                            sectionIdx,\r\n                            pointIdx: firstUnhandledDeviationIdx,\r\n                            comment: '',\r\n                            name: '',\r\n                            date: '',\r\n                            infoMode: false,\r\n                          });\r\n                        } catch(e) {}\r\n                      }}\r\n                      style={{ marginLeft: 10, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600' }}\r\n                      activeOpacity={0.85}\r\n                      accessibilityLabel={`Åtgärda avvikelse i ${section.label}`}\r\n                    >\r\n                      <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\r\n                    </TouchableOpacity>\r\n                  )}\r\n                  {Platform.OS === 'web' && sectionThumbUri && sectionPhotoItems.length > 0 && (\r\n                    <TouchableOpacity\r\n                      onPress={(e) => {\r\n                        try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\r\n                        setPhotoModal({ visible: true, uris: sectionPhotoItems, index: sectionThumbIndex });\r\n                      }}\r\n                      style={{ marginLeft: 8 }}\r\n                      activeOpacity={0.8}\r\n                      accessibilityLabel={`Visa bilder ${section.label}`}\r\n                    >\r\n                      <Image\r\n                        source={{ uri: sectionThumbUri }}\r\n                        style={{ width: 28, height: 28, borderRadius: 4, backgroundColor: '#eee' }}\r\n                        resizeMode=\"cover\"\r\n                      />\r\n                    </TouchableOpacity>\r\n                  )}\r\n                  {hasPhoto && (\r\n                    <Ionicons name=\"camera\" size={20} color=\"#1976D2\" style={{ marginLeft: 8 }} />\r\n                  )}\r\n                  {/* Section menu button */}\r\n                  <TouchableOpacity onPress={(e) => { e.stopPropagation && e.stopPropagation(); setSectionMenuIndex(prev => prev === sectionIdx ? null : sectionIdx); }} style={{ marginLeft: 10, padding: 6 }} accessibilityLabel={`Sektion meny ${section.label}`}>\r\n                    <Ionicons name=\"ellipsis-vertical\" size={18} color=\"#666\" />\r\n                  </TouchableOpacity>\r\n                </TouchableOpacity>\r\n                {sectionMenuIndex === sectionIdx && (\r\n                  <View style={{ paddingHorizontal: 14, paddingBottom: 8, backgroundColor: '#fff' }}>\r\n                    <View style={{ flexDirection: 'row', justifyContent: 'flex-end' }}>\r\n                      <TouchableOpacity onPress={() => markAllOk(sectionIdx)} style={{ marginRight: 12 }}>\r\n                        <Text style={{ color: '#1976D2' }}>Markera alla OK</Text>\r\n                      </TouchableOpacity>\r\n                          {/* Removed \"Radera alla foton\" as requested */}\r\n                      <TouchableOpacity onPress={() => setSectionMenuIndex(null)}>\r\n                        <Text style={{ color: '#777' }}>Stäng</Text>\r\n                      </TouchableOpacity>\r\n                    </View>\r\n                  </View>\r\n                )}\r\n                {expanded && (\r\n                  <View style={{ padding: 10, paddingTop: 0 }}>\r\n                    {section.points.map((point, pointIdx) => {\r\n                      const photosArr = Array.isArray(section.photos) ? section.photos : [];\r\n                      const hasPhotos = Array.isArray(photosArr[pointIdx]) && photosArr[pointIdx].length > 0;\r\n                      const remediation = section.remediation && section.remediation[point] ? section.remediation[point] : null;\r\n                      const isDeviation = section.statuses[pointIdx] === 'avvikelse';\r\n                      const isHandled = !!remediation;\r\n                      const pointText = (typeof point === 'string') ? point : String(point || '');\r\n                      const actionText = (controlType === 'Arbetsberedning' && Array.isArray(section.comments) && typeof section.comments[pointIdx] === 'string')\r\n                        ? section.comments[pointIdx]\r\n                        : '';\r\n                      return (\r\n                        <View key={`point-${pointIdx}`} style={{ marginBottom: 0 }}>\r\n                          <View style={{ flexDirection: 'row', alignItems: controlType === 'Arbetsberedning' ? 'flex-start' : 'center', paddingVertical: 8 }}>\r\n                            {/* Status button (OK) */}\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                setChecklist(prev => prev.map((s, sIdx) => {\r\n                                  if (sIdx !== sectionIdx) return s;\r\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\r\n                                  statuses[pointIdx] = statuses[pointIdx] === 'ok' ? null : 'ok';\r\n                                  return { ...s, statuses };\r\n                                }));\r\n                              }}\r\n                              style={{ marginRight: 10, padding: 6 }}\r\n                              accessibilityLabel={`Markera ${pointText} som OK`}\r\n                            >\r\n                              <Ionicons name={section.statuses[pointIdx] === 'ok' ? 'checkmark-circle' : 'ellipse-outline'} size={22} color={section.statuses[pointIdx] === 'ok' ? '#43A047' : '#bbb'} />\r\n                            </TouchableOpacity>\r\n                            {/* Status button (Avvikelse) */}\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                setChecklist(prev => prev.map((s, sIdx) => {\r\n                                  if (sIdx !== sectionIdx) return s;\r\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\r\n                                  statuses[pointIdx] = statuses[pointIdx] === 'avvikelse' ? null : 'avvikelse';\r\n                                  return { ...s, statuses };\r\n                                }));\r\n                              }}\r\n                              style={{ marginRight: 10, padding: 6 }}\r\n                              accessibilityLabel={`Markera ${pointText} som avvikelse`}\r\n                            >\r\n                              <View style={{ width: 22, height: 22, borderRadius: 11, alignItems: 'center', justifyContent: 'center', backgroundColor: section.statuses[pointIdx] === 'avvikelse' ? '#D32F2F' : 'transparent' }}>\r\n                                {section.statuses[pointIdx] === 'avvikelse' ? (\r\n                                  <Ionicons name=\"alert\" size={18} color=\"#fff\" />\r\n                                ) : (\r\n                                  <Ionicons name=\"ellipse-outline\" size={22} color=\"#bbb\" />\r\n                                )}\r\n                              </View>\r\n                            </TouchableOpacity>\r\n                            {/* Status button (Ej aktuell) */}\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                setChecklist(prev => prev.map((s, sIdx) => {\r\n                                  if (sIdx !== sectionIdx) return s;\r\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\r\n                                  statuses[pointIdx] = statuses[pointIdx] === 'ejaktuell' ? null : 'ejaktuell';\r\n                                  return { ...s, statuses };\r\n                                }));\r\n                              }}\r\n                              style={{ marginRight: 10, padding: 6 }}\r\n                              accessibilityLabel={`Markera ${pointText} som ej aktuell`}\r\n                            >\r\n                              <Ionicons name={section.statuses[pointIdx] === 'ejaktuell' ? 'remove-circle' : 'ellipse-outline'} size={22} color={section.statuses[pointIdx] === 'ejaktuell' ? '#607D8B' : '#bbb'} />\r\n                            </TouchableOpacity>\r\n                            {/* Kontrollpunkt text */}\r\n                            {controlType === 'Arbetsberedning' ? (\r\n                              <View style={{ flex: 1, marginRight: 10 }}>\r\n                                <TextInput\r\n                                  value={pointText}\r\n                                  onChangeText={(txt) => {\r\n                                    setChecklist(prev => prev.map((s, sIdx) => {\r\n                                      if (sIdx !== sectionIdx) return s;\r\n                                      const pointsArr = Array.isArray(s.points) ? [...s.points] : [];\r\n                                      if (pointIdx < 0 || pointIdx >= pointsArr.length) return s;\r\n                                      pointsArr[pointIdx] = txt;\r\n                                      return { ...s, points: pointsArr };\r\n                                    }));\r\n                                  }}\r\n                                  placeholder=\"Risk / moment\"\r\n                                  placeholderTextColor=\"#888\"\r\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', color: '#222' }}\r\n                                  multiline\r\n                                />\r\n                                <TextInput\r\n                                  value={actionText}\r\n                                  onChangeText={(txt) => {\r\n                                    setChecklist(prev => prev.map((s, sIdx) => {\r\n                                      if (sIdx !== sectionIdx) return s;\r\n                                      const pointsArr = Array.isArray(s.points) ? s.points : [];\r\n                                      const comments = Array.isArray(s.comments) && s.comments.length === pointsArr.length\r\n                                        ? [...s.comments]\r\n                                        : Array(pointsArr.length).fill('');\r\n                                      comments[pointIdx] = txt;\r\n                                      return { ...s, comments };\r\n                                    }));\r\n                                  }}\r\n                                  placeholder=\"Åtgärd / hantering (hur ska risken hanteras?)\"\r\n                                  placeholderTextColor=\"#888\"\r\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', color: '#222', marginTop: 8 }}\r\n                                  multiline\r\n                                  textAlignVertical=\"top\"\r\n                                />\r\n                              </View>\r\n                            ) : (\r\n                              <Text style={{ flex: 1, fontSize: 15, color: '#222' }}>{pointText}</Text>\r\n                            )}\r\n                            {/* Photo button */}\r\n                            <TouchableOpacity\r\n                              onPress={() => {\r\n                                if (hasPhotos) {\r\n                                  setPhotoModal({\r\n                                    visible: true,\r\n                                    uris: section.photos[pointIdx].map(uri => (typeof uri === 'string' ? { uri, comment: '' } : uri)),\r\n                                    index: 0,\r\n                                    sectionIdx,\r\n                                    pointIdx,\r\n                                  });\r\n                                } else {\r\n                                  handleNavigateToCamera(sectionIdx, pointIdx, project);\r\n                                }\r\n                              }}\r\n                              style={{ marginLeft: 8, padding: 6 }}\r\n                              accessibilityLabel={hasPhotos ? `Visa och hantera bilder för ${pointText}` : `Lägg till foto för ${pointText}`}\r\n                            >\r\n                              <Ionicons name={hasPhotos ? 'camera' : 'camera-outline'} size={20} color={'#1976D2'} />\r\n                            </TouchableOpacity>\r\n                            {/* Åtgärda-knapp / Info för avvikelse (Skyddsrond).\r\n                                När en åtgärd sparas lagras remediation-info och avvikelsen\r\n                                betraktas som handlad (visas ej som aktiv varning i header),\r\n                                men vi sparar åtgärden för spårbarhet. */}\r\n                            {controlType === 'Skyddsrond' && isDeviation && (\r\n                              isHandled ? (\r\n                                <>\r\n                                  <TouchableOpacity\r\n                                    onPress={() => {\r\n                                      try {\r\n                                        setRemediationModal({\r\n                                          visible: true,\r\n                                          sectionIdx,\r\n                                          pointIdx,\r\n                                          comment: remediation && remediation.comment ? remediation.comment : '',\r\n                                          name: remediation && remediation.name ? remediation.name : '',\r\n                                          date: remediation && remediation.date ? remediation.date : '',\r\n                                          infoMode: true,\r\n                                        });\r\n                                      } catch(e) {}\r\n                                    }}\r\n                                    style={{ marginLeft: 8, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#E8F5E9' }}\r\n                                    accessibilityLabel={`Visa åtgärdsinfo för ${pointText}`}\r\n                                  >\r\n                                    <Text style={{ color: '#388E3C', fontSize: 13, fontWeight: '600' }}>Info</Text>\r\n                                  </TouchableOpacity>\r\n                                  <Text style={{ marginLeft: 8, color: '#388E3C', fontSize: 12 }}>\r\n                                    Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\r\n                                  </Text>\r\n                                </>\r\n                              ) : (\r\n                                <TouchableOpacity\r\n                                  onPress={() => {\r\n                                    try {\r\n                                      setRemediationModal({ visible: true, sectionIdx, pointIdx, comment: '', name: '', date: '', infoMode: false });\r\n                                    } catch(e) {}\r\n                                  }}\r\n                                  style={{ marginLeft: 8, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 0, backgroundColor: '#FFD600' }}\r\n                                  accessibilityLabel={`Åtgärda avvikelse för ${pointText}`}\r\n                                >\r\n                                  <Text style={{ color: '#222', fontSize: 13, fontWeight: '700' }}>Åtgärda</Text>\r\n                                </TouchableOpacity>\r\n                              )\r\n                            )}\r\n                          </View>\r\n                          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 6, marginBottom: 6 }} />\r\n                        </View>\r\n                      );\r\n                    })}\r\n                    {/* Add custom checklist point button */}\r\n                    <TouchableOpacity\r\n                      style={{ flexDirection: 'row', alignItems: 'center', marginTop: 8, marginBottom: 8 }}\r\n                      onPress={() => {\r\n                        setAddPointModal({ visible: true, sectionIdx });\r\n                        setNewPointText('');\r\n                        setNewPointActionText('');\r\n                      }}\r\n                      accessibilityLabel=\"Lägg till kontrollpunkt\"\r\n                    >\r\n                      <Text style={{ fontSize: 20, color: '#1976D2', marginRight: 4 }}>+</Text>\r\n                      <Text style={{ color: '#1976D2', fontWeight: 'bold' }}>Lägg till kontrollpunkt</Text>\r\n                    </TouchableOpacity>\r\n                    {/* Modal for adding a new checklist point */}\r\n                    {addPointModal.visible && addPointModal.sectionIdx === sectionIdx && (\r\n                      <Modal\r\n                        visible={addPointModal.visible}\r\n                        transparent\r\n                        animationType=\"fade\"\r\n                        onRequestClose={() => {\r\n                          setAddPointModal({ visible: false, sectionIdx: null });\r\n                          setNewPointText('');\r\n                          setNewPointActionText('');\r\n                        }}\r\n                      >\r\n                        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.3)', justifyContent: 'center', alignItems: 'center' }}>\r\n                          <View style={{ backgroundColor: '#fff', borderRadius: 10, padding: 20, width: '80%', elevation: 5 }}>\r\n                            <Text style={{ fontWeight: 'bold', fontSize: 16, marginBottom: 8 }}>Ny kontrollpunkt</Text>\r\n                            <TextInput\r\n                              value={newPointText}\r\n                              onChangeText={setNewPointText}\r\n                              placeholder={controlType === 'Arbetsberedning' ? 'Risk / moment' : 'Skriv rubrik på kontrollpunkt'}\r\n                              style={{ borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 8, fontSize: 16, backgroundColor: '#fafafa' }}\r\n                              autoFocus\r\n                            />\r\n                            {controlType === 'Arbetsberedning' && (\r\n                              <TextInput\r\n                                value={newPointActionText}\r\n                                onChangeText={setNewPointActionText}\r\n                                placeholder=\"Åtgärd / hantering (hur ska risken hanteras?)\"\r\n                                style={{ borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 8, fontSize: 16, backgroundColor: '#fafafa', marginTop: 10 }}\r\n                                multiline\r\n                                textAlignVertical=\"top\"\r\n                              />\r\n                            )}\r\n                            <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 12 }}>\r\n                              <TouchableOpacity onPress={() => {\r\n                                setAddPointModal({ visible: false, sectionIdx: null });\r\n                                setNewPointText('');\r\n                                setNewPointActionText('');\r\n                              }} style={{ marginRight: 16 }}>\r\n                                <Text style={{ color: '#1976D2' }}>Avbryt</Text>\r\n                              </TouchableOpacity>\r\n                              <TouchableOpacity onPress={() => {\r\n                                if (!newPointText.trim()) return;\r\n                                setChecklist(prev => prev.map((s, sIdx) => {\r\n                                  if (sIdx !== sectionIdx) return s;\r\n                                  const points = [...s.points, newPointText.trim()];\r\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses, null] : Array(points.length).fill(null);\r\n                                  const photos = Array.isArray(s.photos) ? [...s.photos, []] : Array(points.length).fill([]);\r\n                                  if (controlType === 'Arbetsberedning') {\r\n                                    const comments = Array.isArray(s.comments) ? [...s.comments, String(newPointActionText || '')] : Array(points.length).fill('');\r\n                                    if (comments.length === points.length) {\r\n                                      comments[points.length - 1] = String(newPointActionText || '');\r\n                                    }\r\n                                    return { ...s, points, statuses, photos, comments };\r\n                                  }\r\n                                  return { ...s, points, statuses, photos };\r\n                                }));\r\n                                setAddPointModal({ visible: false, sectionIdx: null });\r\n                                setNewPointText('');\r\n                                setNewPointActionText('');\r\n                              }}>\r\n                                <Text style={{ color: '#1976D2', fontWeight: 'bold' }}>Lägg till</Text>\r\n                              </TouchableOpacity>\r\n                            </View>\r\n                          </View>\r\n                        </View>\r\n                      </Modal>\r\n                    )}\r\n                  </View>\r\n                )}\r\n              </View>\r\n            );\r\n          })}\r\n          {/* Divider under checklist */}\r\n          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 8 }} />\r\n\r\n          {/* Summary under checklist */}\r\n          {(() => {\r\n            // Count sections\r\n            const numSections = checklist.length;\r\n            // Count all points\r\n            let totalPoints = 0;\r\n            let approvedPoints = 0;\r\n            let deviationPoints = 0;\r\n            let completedSections = 0;\r\n            checklist.forEach((section, sectionIdx) => {\r\n              totalPoints += (section.points || []).length;\r\n              const statuses = checklist[sectionIdx]?.statuses || [];\r\n              let allFilled = true;\r\n              (section.points || []).forEach((_, pointIdx) => {\r\n                if (statuses[pointIdx] === 'ok') approvedPoints++;\r\n                // Count only unhandled deviations\r\n                if (statuses[pointIdx] === 'avvikelse' && !(section.remediation && section.remediation[section.points[pointIdx]])) deviationPoints++;\r\n                if (!statuses[pointIdx]) allFilled = false;\r\n              });\r\n              if ((section.points || []).length > 0 && allFilled) completedSections++;\r\n            });\r\n            return (\r\n              <View style={{ marginTop: 16, marginBottom: 8, padding: 16, backgroundColor: '#f5f5f5', borderRadius: 10, borderWidth: 1, borderColor: '#e0e0e0' }}>\r\n                <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginBottom: 4 }}>\r\n                  Sammanställning\r\n                </Text>\r\n                <Text style={{ fontSize: 15, color: '#222', marginBottom: 2 }}>\r\n                  Gått igenom: {completedSections} av {numSections} områden\r\n                </Text>\r\n                <Text style={{ fontSize: 15, color: '#43A047', marginBottom: 2 }}>\r\n                  Godkända kontrollpunkter: {approvedPoints} av {totalPoints}\r\n                </Text>\r\n                <Text style={{ fontSize: 15, color: deviationPoints > 0 ? '#FFD600' : '#222' }}>\r\n                  Avvikelser: {deviationPoints}\r\n                </Text>\r\n              </View>\r\n            );\r\n          })()}\r\n        </View>\r\n      )}\r\n          {/* Centralized photos (for Mottagningskontroll) */}\r\n          {controlType === 'Mottagningskontroll' && (\r\n            <View style={{ paddingHorizontal: 16, marginTop: 8 }}>\r\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 12 }} />\r\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600' }}>Foton</Text>\r\n                {(!Array.isArray(mottagningsPhotos) || mottagningsPhotos.length === 0) && (\r\n                  <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\r\n                )}\r\n                {/* Debug: show count of mottagningsPhotos */}\r\n                <View style={{ marginLeft: 10 }}>\r\n                  <Text style={{ fontSize: 12, color: '#1976D2' }}>{`Bilder: ${Array.isArray(mottagningsPhotos) ? mottagningsPhotos.length : 0}`}</Text>\r\n                  {/* Removed verbose file path display (Senast: file://...) per UX request */}\r\n                </View>\r\n              </View>\r\n              <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'flex-start', marginTop: 8 }}>\r\n                <TouchableOpacity onPress={() => setShowPhotoChoice(true)} style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#000', backgroundColor: 'transparent' }}>\r\n                  <Ionicons name=\"camera\" size={20} color=\"#000\" style={{ marginRight: 8 }} />\r\n                  <Text style={{ color: '#000', fontWeight: '600' }}>Lägg till foto</Text>\r\n                </TouchableOpacity>\r\n              </View>\r\n              {Array.isArray(mottagningsPhotos) && mottagningsPhotos.length > 0 && (\r\n                <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 8 }}>\r\n                  {mottagningsPhotos.map((uri, idx) => (\r\n                    <TouchableOpacity key={`m-photo-${idx}-${(uri && uri.uri) ? uri.uri.substring(uri.uri.length-8) : idx}`} onPress={() => setPhotoModal({ visible: true, uris: mottagningsPhotos, index: idx })} activeOpacity={0.85} style={{ marginRight: 8 }}>\r\n                      <Image source={{ uri: uri && uri.uri ? uri.uri : uri }} style={{ width: 84, height: 84, borderRadius: 8, borderWidth: 1, borderColor: '#ddd', backgroundColor: '#eee' }} />\r\n                      {uri && uri.comment ? (\r\n                        <View style={{ position: 'absolute', left: 6, right: 6, bottom: 6, backgroundColor: 'rgba(0,0,0,0.45)', paddingVertical: 2, paddingHorizontal: 6, borderRadius: 6 }}>\r\n                          <Text numberOfLines={1} style={{ color: '#fff', fontSize: 12 }}>{uri.comment}</Text>\r\n                        </View>\r\n                      ) : null}\r\n                    </TouchableOpacity>\r\n                  ))}\r\n                </ScrollView>\r\n              )}\r\n            </View>\r\n          )}\r\n      {(controlType === 'Mottagningskontroll' || controlType === 'Skyddsrond' || controlType === 'Riskbedömning') && (\r\n        <View style={{ paddingHorizontal: 16, marginTop: 12 }}>\r\n          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 12 }} />\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>\r\n            <Text style={{ fontSize: 15, color: (missingFields && (missingFields.includes('Signaturer') || missingFields.includes('Signatur'))) ? '#D32F2F' : '#222', fontWeight: '600', marginBottom: 8 }}>Signaturer</Text>\r\n            <TouchableOpacity onPress={() => setShowAddSignerModal(true)} style={{ paddingHorizontal: 8, paddingVertical: 4 }}>\r\n              <Text style={{ color: '#1976D2' }}>Lägg till signerare</Text>\r\n            </TouchableOpacity>\r\n          </View>\r\n          {localParticipants && localParticipants.length > 0 ? (\r\n            localParticipants.map((p, pIdx) => {\r\n              const name = (typeof p === 'object' && p !== null) ? (p.name || `${p.company || ''}`) : (p || `${participantsLabel} ${pIdx+1}`);\r\n              const existing = (mottagningsSignatures || []).find(s => s.name === name);\r\n              return (\r\n                <View key={`sig-${pIdx}-${name}`} style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>\r\n                  <Text style={{ fontSize: 15, color: '#222' }}>{name}</Text>\r\n                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                    {existing ? (\r\n                      <>\r\n                        {existing.strokes ? (\r\n                          <Svg width={120} height={48} viewBox={`0 0 ${sigCanvasSize} ${sigCanvasSize / 2}`} style={{ marginRight: 8 }}>\r\n                            {existing.strokes.map((stroke, si) => (\r\n                              <Path\r\n                                key={`ps-${si}`}\r\n                                d={pointsToPath(stroke)}\r\n                                fill=\"none\"\r\n                                stroke=\"#000\"\r\n                                strokeWidth={2}\r\n                                strokeLinecap=\"round\"\r\n                                strokeLinejoin=\"round\"\r\n                              />\r\n                            ))}\r\n                          </Svg>\r\n                        ) : (\r\n                          <Image source={{ uri: existing.uri }} style={{ width: 120, height: 48, borderRadius: 6, marginRight: 8, borderWidth: 1, borderColor: '#e0e0e0' }} />\r\n                        )}\r\n                        <TouchableOpacity onPress={() => { const v = existing.strokes || []; setSignatureForIndex(pIdx); setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingHorizontal: 10, paddingVertical: 6, marginRight: 8 }}>\r\n                          <Text style={{ color: '#1976D2' }}>Byt</Text>\r\n                        </TouchableOpacity>\r\n                        <TouchableOpacity onPress={() => setMottagningsSignatures(prev => prev.filter(s => s.name !== name))} style={{ paddingHorizontal: 10, paddingVertical: 6 }}>\r\n                          <Text style={{ color: '#D32F2F' }}>Ta bort</Text>\r\n                        </TouchableOpacity>\r\n                      </>\r\n                    ) : (\r\n                      <TouchableOpacity onPress={() => { setSignatureForIndex(pIdx); const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingHorizontal: 6, paddingVertical: 2 }} accessibilityLabel=\"Lägg till signatur\">\r\n                        <Ionicons name=\"add-circle-outline\" size={24} color=\"#1976D2\" />\r\n                      </TouchableOpacity>\r\n                    )}\r\n                  </View>\r\n                </View>\r\n              );\r\n            })\r\n          ) : (\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n              <Text style={{ fontSize: 15, color: '#222' }}>Signatur</Text>\r\n              <TouchableOpacity onPress={() => { setSignatureForIndex('mottagnings'); const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingVertical: 4, paddingHorizontal: 6 }} accessibilityLabel=\"Lägg till signatur\">\r\n                <Ionicons name=\"add-circle-outline\" size={28} color=\"#1976D2\" />\r\n              </TouchableOpacity>\r\n            </View>\r\n          )}\r\n          \r\n          <Modal visible={showPhotoChoice} transparent animationType=\"fade\" onRequestClose={() => setShowPhotoChoice(false)}>\r\n            <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' }}>\r\n              <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\r\n                    <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\r\n                      <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Bifoga bild</Text>\r\n                    </View>\r\n                    <View style={{ padding: 16 }}>\r\n                      <TouchableOpacity onPress={() => { setShowPhotoChoice(false); handleNavigateToCamera(null, null, project); }} style={{ paddingVertical: 12, flexDirection: 'row', alignItems: 'center' }}>\r\n                        <Ionicons name=\"camera\" size={20} color=\"#000\" style={{ marginRight: 10 }} />\r\n                        <Text style={{ color: '#1976D2', fontSize: 16 }}>Ta foto</Text>\r\n                      </TouchableOpacity>\r\n                      <TouchableOpacity onPress={() => { setShowPhotoChoice(false); setTimeout(() => handlePickFromLibrary(), 200); }} style={{ paddingVertical: 12, flexDirection: 'row', alignItems: 'center' }}>\r\n                        <Ionicons name=\"images\" size={20} color=\"#000\" style={{ marginRight: 10 }} />\r\n                        <Text style={{ color: '#1976D2', fontSize: 16 }}>Välj från bibliotek</Text>\r\n                      </TouchableOpacity>\r\n                  <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 8 }}>\r\n                    <TouchableOpacity onPress={() => setShowPhotoChoice(false)} style={{ padding: 8 }}>\r\n                      <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                    </TouchableOpacity>\r\n                  </View>\r\n                </View>\r\n              </View>\r\n            </View>\r\n          </Modal>\r\n        </View>\r\n      )}\r\n      <View style={{\r\n        flexDirection: 'row',\r\n        justifyContent: 'space-between',\r\n        width: '100%',\r\n        paddingHorizontal: 16,\r\n        marginTop: 16,\r\n        marginBottom: 32,\r\n        backgroundColor: '#fafafa',\r\n        borderWidth: 1,\r\n        borderColor: '#e0e0e0',\r\n        borderRadius: 12,\r\n        paddingVertical: 10,\r\n        shadowColor: '#000',\r\n        shadowOffset: { width: 0, height: 2 },\r\n        shadowOpacity: 0.06,\r\n        shadowRadius: 4,\r\n        elevation: 2,\r\n      }}>\r\n        <TouchableOpacity\r\n          onPress={() => {\r\n            if (!canFinish && controlType === 'Riskbedömning') {\r\n              // Build missing fields list\r\n              const missing = [];\r\n              if (!dateValue || dateValue.trim().length === 0) missing.push('Datum');\r\n              if (!Array.isArray(localParticipants) || localParticipants.length === 0) missing.push('Deltagare');\r\n              if (!deliveryDesc || deliveryDesc.trim().length === 0) missing.push('Beskriv arbetsmoment');\r\n              if (!Array.isArray(checklist) || checklist.length === 0 || !checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s))) missing.push('Alla kontrollpunkter');\r\n              if (!Array.isArray(mottagningsSignatures) || mottagningsSignatures.length === 0) missing.push('Signatur');\r\n              Alert.alert('Kan inte slutföra', 'Följande saknas: ' + missing.join(', '));\r\n              return;\r\n            }\r\n\r\n            // For Skyddsrond + Mottagningskontroll: show a clear popup of missing fields\r\n            // instead of doing nothing when canFinish is false (especially important on web).\r\n            if (!canFinish && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll')) {\r\n              handleAttemptFinish();\r\n              return;\r\n            }\r\n\r\n            if (canFinish) {\r\n              handleAttemptFinish();\r\n            }\r\n          }}\r\n          style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0, opacity: canFinish ? 1 : 0.55 }}\r\n        >\r\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\r\n            <Ionicons name=\"checkmark-circle\" size={18} color={(canFinish || (Platform.OS === 'web' && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll'))) ? '#1976D2' : '#AAA'} style={{ marginRight: 8 }} />\r\n            <Text style={{ color: (canFinish || (Platform.OS === 'web' && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll'))) ? '#1976D2' : '#AAA', fontWeight: 'bold', fontSize: 16 }}>\r\n              {((initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed)) ? 'Spara' : 'Slutför')}\r\n            </Text>\r\n          </View>\r\n        </TouchableOpacity>\r\n        {((initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed)) || !isDirtyRef.current) ? (\r\n          <TouchableOpacity\r\n            onPress={() => {\r\n              if (!isDirtyRef.current) {\r\n                // No changes, exit immediately\r\n                if (typeof onExit === 'function') onExit();\r\n                else if (navigation && navigation.goBack) navigation.goBack();\r\n              } else {\r\n                setShowCancelEditConfirm(true);\r\n              }\r\n            }}\r\n            style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0 }}\r\n          >\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\r\n              <Ionicons name=\"close-circle-outline\" size={18} color=\"#D32F2F\" style={{ marginRight: 8 }} />\r\n              <Text style={{ color: '#D32F2F', fontWeight: 'bold', fontSize: 16 }}>Avbryt</Text>\r\n            </View>\r\n          </TouchableOpacity>\r\n        ) : (\r\n          <TouchableOpacity\r\n            onPress={handleSaveDraft}\r\n            style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0 }}\r\n          >\r\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\r\n              <Ionicons name=\"save-outline\" size={18} color=\"#D32F2F\" style={{ marginRight: 8 }} />\r\n              <Text style={{ color: '#D32F2F', fontWeight: 'bold', fontSize: 16 }}>Spara utkast</Text>\r\n            </View>\r\n          </TouchableOpacity>\r\n        )}\r\n\r\n      {/* Modal for cancel edit confirmation */}\r\n      <Modal visible={!!showCancelEditConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowCancelEditConfirm(false)}>\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\r\n          <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 24, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\r\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 16, color: '#222', textAlign: 'center' }}>Vill du verkligen avbryta ändringen?</Text>\r\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%', marginTop: 12 }}>\r\n              <TouchableOpacity\r\n                onPress={() => setShowCancelEditConfirm(false)}\r\n                style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}\r\n              >\r\n                <Text style={{ color: '#1976D2', fontWeight: '600' }}>Nej</Text>\r\n              </TouchableOpacity>\r\n              <TouchableOpacity\r\n                onPress={() => {\r\n                  setShowCancelEditConfirm(false);\r\n                  setShowBackConfirm(false); // Prevent double modal\r\n                  try { isDirtyRef.current = false; } catch(e) {}\r\n                  try { if (blockedNavEvent) blockedNavEvent.current = null; } catch(e) {}\r\n                  if (typeof onExit === 'function') onExit();\r\n                  else if (navigation && navigation.goBack) navigation.goBack();\r\n                }}\r\n                style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\r\n              >\r\n                <Text style={{ color: '#D32F2F', fontWeight: '600' }}>Ja, avbryt</Text>\r\n              </TouchableOpacity>\r\n            </View>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n      </View>\r\n      {/* Signature Modal (JS fallback) */}\r\n      <Modal visible={signatureForIndex !== null} transparent animationType=\"slide\" onRequestClose={() => setSignatureForIndex(null)}>\r\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.45)', justifyContent: 'flex-end', alignItems: 'center', paddingBottom: 12 }}>\r\n          <View style={{ width: '100%', maxWidth: sigCanvasSize + 32, backgroundColor: '#fff', borderTopLeftRadius: 12, borderTopRightRadius: 12, padding: 12, alignItems: 'center' }}>\r\n            <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 8 }}>Signera med fingret</Text>\r\n            <View style={{ width: sigCanvasSize, height: sigCanvasSize / 2, backgroundColor: '#fff', borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, overflow: 'hidden' }} {...panResponder.panHandlers}>\r\n              <Svg width={sigCanvasSize} height={sigCanvasSize / 2}>\r\n                {sigStrokes.map((stroke, si) => (\r\n                  <Path key={`s-${si}`} d={pointsToPath(stroke)} fill=\"none\" stroke=\"#000\" strokeWidth={2} strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                ))}\r\n                {sigCurrent && sigCurrent.length > 0 && (\r\n                  <Path d={pointsToPath(sigCurrent)} fill=\"none\" stroke=\"#000\" strokeWidth={2} strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n                )}\r\n              </Svg>\r\n            </View>\r\n            <View style={{ flexDirection: 'row', marginTop: 12, width: '100%', justifyContent: 'space-between' }}>\r\n              <TouchableOpacity onPress={() => { const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} setSigCurrent([]); }} style={{ padding: 10 }}>\r\n                <Text style={{ color: '#D32F2F' }}>Rensa</Text>\r\n              </TouchableOpacity>\r\n              <View style={{ flexDirection: 'row' }}>\r\n                <TouchableOpacity onPress={() => setSignatureForIndex(null)} style={{ padding: 10, marginRight: 8 }}>\r\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\r\n                </TouchableOpacity>\r\n                <TouchableOpacity onPress={() => {\r\n                  try {\r\n                    const strokesToSave = Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : sigStrokes;\r\n                    // Save signature strokes for participant or generic\r\n                    if (signatureForIndex === 'mottagnings') {\r\n                      setMottagningsSignatures(prev => [...(prev || []), { name: 'Signerad', strokes: strokesToSave }]);\r\n                    } else if (typeof signatureForIndex === 'number') {\r\n                      const p = localParticipants[signatureForIndex];\r\n                      const name = (typeof p === 'object' && p !== null) ? (p.name || `${p.company || ''}`) : (p || `${participantsLabel} ${signatureForIndex+1}`);\r\n                      setMottagningsSignatures(prev => {\r\n                        const others = (prev || []).filter(s => s.name !== name);\r\n                        return [...others, { name, strokes: strokesToSave }];\r\n                      });\r\n                    }\r\n                    // Reset local signature drawing state and close modal\r\n                    const v = [];\r\n                    setSigStrokes(v);\r\n                    try { sigStrokesRef.current = v; } catch(e) {}\r\n                    setSigCurrent([]);\r\n                    setSignatureForIndex(null);\r\n                  } catch(e) {}\r\n                }} style={{ padding: 10 }}>\r\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>OK</Text>\r\n                </TouchableOpacity>\r\n                \r\n              </View>\r\n            </View>\r\n          </View>\r\n        </View>\r\n      </Modal>\r\n    </View>\r\n  </View>\r\n  </ScrollView>\r\n  </>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ContextMenu.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ControlPreview.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ErrorBoundary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\HeaderComponents.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\InfoPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\MainLayout.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\NativeSignatureModal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ProjectSidebar.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\SignatureModal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\external-link.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":15,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { openBrowserAsync } from 'expo-web-browser';\nimport { Linking, Platform, Text, TouchableOpacity } from 'react-native';\n\ntype Props = { href: string; children?: any; style?: any };\n\nexport function ExternalLink({ href, children, style }: Props) {\n  const handlePress = async () => {\n    try {\n      if (Platform.OS === 'web') {\n        window.open(href, '_blank');\n      } else {\n        // prefer in-app browser when available\n        try {\n          await openBrowserAsync(href);\n        } catch(e) {\n          await Linking.openURL(href);\n        }\n      }\n    } catch {\n      try { await Linking.openURL(href); } catch {}\n    }\n  };\n  return (\n    <TouchableOpacity onPress={handlePress} style={style} accessibilityRole=\"link\">\n      {children ? children : <Text style={{ color: '#1976D2' }}>{href}</Text>}\n    </TouchableOpacity>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\fetchProjectControls.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\firebase.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":33,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":10},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":53,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":56,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":77,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":82,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":128,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":128,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":129,"column":92,"nodeType":"Identifier","messageId":"undef","endLine":129,"endColumn":95},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":133,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":149,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":162,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":162,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":174,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":174,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'inner' is defined but never used. Allowed unused caught errors must match /^_/u.","line":211,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":211,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":217,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":231,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":231,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":243,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":243,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":264,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":264,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":274,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":274,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":287,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":287,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":335,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":335,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":358,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":358,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":361,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":361,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":374,"column":116,"nodeType":"Identifier","messageId":"unusedVar","endLine":374,"endColumn":117},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":389,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":389,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":392,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":392,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":396,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":396,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":401,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":401,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":412,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":412,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":434,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":434,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":472,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":472,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":485,"column":116,"nodeType":"Identifier","messageId":"unusedVar","endLine":485,"endColumn":117},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":499,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":499,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":519,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":519,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":521,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":521,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":542,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":542,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":544,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":544,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":549,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":549,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":560,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":560,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":590,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":590,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":614,"column":95,"nodeType":"Identifier","messageId":"unusedVar","endLine":614,"endColumn":96},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":629,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":629,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":641,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":641,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":646,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":646,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":663,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":663,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":694,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":694,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":716,"column":93,"nodeType":"Identifier","messageId":"unusedVar","endLine":716,"endColumn":94},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":731,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":731,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":746,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":746,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":750,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":776,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":776,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":788,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":788,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":791,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":791,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":812,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":812,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":824,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":824,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":827,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":827,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":839,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":839,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":851,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":851,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":869,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":869,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":881,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":881,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":918,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":918,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":939,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":939,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":955,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":955,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is assigned a value but never used. Allowed unused caught errors must match /^_/u.","line":1041,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1041,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'e2' is not defined.","line":1041,"column":13,"nodeType":"Identifier","messageId":"undef","endLine":1041,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1051,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1051,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1064,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1064,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1075,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1075,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is assigned a value but never used. Allowed unused caught errors must match /^_/u.","line":1104,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1104,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'e2' is not defined.","line":1104,"column":13,"nodeType":"Identifier","messageId":"undef","endLine":1104,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1113,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1113,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1126,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1126,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1139,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1139,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is assigned a value but never used. Allowed unused caught errors must match /^_/u.","line":1180,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1180,"endColumn":10},{"ruleId":"no-undef","severity":2,"message":"'e2' is not defined.","line":1180,"column":13,"nodeType":"Identifier","messageId":"undef","endLine":1180,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1189,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1189,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1203,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1203,"endColumn":14}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":71,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n// components/firebase.js\r\n\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { initializeApp } from \"firebase/app\";\r\nimport { getAuth, getReactNativePersistence, initializeAuth, signInWithEmailAndPassword } from \"firebase/auth\";\r\nimport { addDoc, collection, deleteDoc, doc, getDoc, getDocs, getDocsFromServer, getFirestore, limit, onSnapshot, orderBy, query, serverTimestamp, setDoc, where } from \"firebase/firestore\";\r\nimport { getDownloadURL, getStorage, ref as storageRef } from 'firebase/storage';\r\nimport { Alert } from 'react-native';\r\n\r\n// Firebase-konfiguration för DigitalKontroll\r\nconst firebaseConfig = {\r\n  apiKey: \"AIzaSyDI7SzOdfwV6wx0Igs8-Kdb8Zhuxwm7BWk\",\r\n  authDomain: \"digitalkontroll-8fd05.firebaseapp.com\",\r\n  projectId: \"digitalkontroll-8fd05\",\r\n  storageBucket: \"digitalkontroll-8fd05.firebasestorage.app\",\r\n  messagingSenderId: \"753073457092\",\r\n  appId: \"1:753073457092:web:937d55d391cbe78be40691\",\r\n  measurementId: \"G-EF1JRB9Y2E\"\r\n};\r\n\r\n// Initiera Firebase\r\nconst app = initializeApp(firebaseConfig);\r\n\r\n// Storage (for branding assets like company logos)\r\nexport const storage = getStorage(app);\r\n\r\n// Initiera autentisering & Firestore\r\n// Use React Native AsyncStorage for Auth persistence when possible\r\nlet _auth;\r\ntry {\r\n  _auth = initializeAuth(app, { persistence: getReactNativePersistence(AsyncStorage) });\r\n} catch(e) {\r\n  // Fallback to default (web) auth for environments where initializeAuth isn't available\r\n  _auth = getAuth(app);\r\n}\r\nexport const auth = _auth;\r\nexport const db = getFirestore(app);\r\n\r\nasync function getAuthDebugSnapshot() {\r\n  const snap = {\r\n    projectId: firebaseConfig?.projectId || null,\r\n    uid: auth?.currentUser?.uid || null,\r\n    email: auth?.currentUser?.email || null,\r\n    claimsCompanyId: null,\r\n    storedCompanyId: null,\r\n  };\r\n  try {\r\n    if (auth?.currentUser?.getIdTokenResult) {\r\n      const tokenRes = await auth.currentUser.getIdTokenResult(false).catch((e) => null);\r\n      snap.claimsCompanyId = tokenRes?.claims?.companyId || null;\r\n    }\r\n  } catch(e) {}\r\n  try {\r\n    snap.storedCompanyId = await AsyncStorage.getItem('dk_companyId');\r\n  } catch(e) {}\r\n  return snap;\r\n}\r\n\r\nasync function resolveCompanyId(preferredCompanyId, payload) {\r\n  // Prefer explicit override first.\r\n  // In onboarding / role changes it's common that custom claims are stale until\r\n  // the client refreshes its token; using the override avoids querying the wrong company.\r\n  if (preferredCompanyId) return preferredCompanyId;\r\n\r\n  // Next prefer payload-provided companyId.\r\n  if (payload && payload.companyId) return payload.companyId;\r\n\r\n  // Finally fall back to authenticated user's companyId claim when available.\r\n  try {\r\n    const user = auth && auth.currentUser;\r\n    if (user && user.getIdTokenResult) {\r\n      const tokenRes = await user.getIdTokenResult(false).catch((e) => null);\r\n      const claims = tokenRes && tokenRes.claims ? tokenRes.claims : {};\r\n      if (claims && claims.companyId) return claims.companyId;\r\n    }\r\n  } catch(e) {}\r\n\r\n  try {\r\n    const stored = await AsyncStorage.getItem('dk_companyId');\r\n    if (stored) return stored;\r\n  } catch(e) {}\r\n  return null;\r\n}\r\n\r\n// Sanitize objects for Firestore: Firestore does not allow nested arrays (arrays inside arrays).\r\n// Convert any nested array values into an object map with numeric keys so writes succeed.\r\nfunction sanitizeForFirestore(value) {\r\n  // Ensure no nested arrays exist anywhere in the data structure.\r\n  // Firestore rejects nested arrays (arrays that contain arrays anywhere inside them).\r\n  // Strategy:\r\n  // - Walk the value recursively.\r\n  // - If an array is found that contains another array anywhere in its subtree,\r\n  //   convert that array into an object keyed by index (so Firestore accepts it).\r\n  // - Otherwise keep arrays as arrays but ensure their elements are sanitized.\r\n  function containsArray(v) {\r\n    if (!v) return false;\r\n    if (Array.isArray(v)) return true;\r\n    if (typeof v === 'object') {\r\n      for (const k of Object.keys(v)) if (containsArray(v[k])) return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  function _walk(v) {\r\n    if (Array.isArray(v)) {\r\n      // If any element (recursively) contains an array, convert the whole array to an object\r\n      // keyed by index to avoid nested arrays anywhere.\r\n      const hasNested = v.some(el => containsArray(el));\r\n      if (hasNested) {\r\n        const obj = {};\r\n        for (let i = 0; i < v.length; i++) obj[i] = _walk(v[i]);\r\n        return obj;\r\n      }\r\n      // Safe to keep as array; sanitize elements.\r\n      return v.map(el => _walk(el));\r\n    }\r\n    if (v && typeof v === 'object' && !(v instanceof Date)) {\r\n      const out = {};\r\n      for (const k of Object.keys(v)) out[k] = _walk(v[k]);\r\n      return out;\r\n    }\r\n    return v;\r\n  }\r\n\r\n  try {\r\n    return _walk(value);\r\n  } catch(e) {\r\n    console.warn('[firebase] sanitizeForFirestore failed, falling back to JSON stringify', err);\r\n    // As a last resort, stringify the whole payload so setDoc won't throw nested-array errors.\r\n    try {\r\n      return { __json: JSON.stringify(value) };\r\n    } catch(e) {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\n// Helpers for syncing hierarchy per company\r\nexport async function fetchHierarchy(companyId) {\r\n  if (!companyId) return [];\r\n  try {\r\n    const ref = doc(db, 'foretag', companyId, 'hierarki', 'state');\r\n    const snap = await getDoc(ref);\r\n    if (snap.exists()) {\r\n      const data = snap.data();\r\n      return Array.isArray(data.items) ? data.items : [];\r\n    }\r\n  } catch(e) {\r\n    // Silent fail -> caller can fall back to local storage\r\n  }\r\n  return [];\r\n}\r\n\r\nexport async function saveHierarchy(companyId, items) {\r\n  if (!companyId) return false;\r\n  try {\r\n    const ref = doc(db, 'foretag', companyId, 'hierarki', 'state');\r\n    // write items with server timestamp\r\n    await setDoc(ref, { items, updatedAt: serverTimestamp() }, { merge: true });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Company profile: name, logoUrl, etc.\r\nexport async function fetchCompanyProfile(companyId) {\r\n  if (!companyId) return null;\r\n  try {\r\n    const ref = doc(db, 'foretag', companyId, 'profil', 'public');\r\n    const snap = await getDoc(ref);\r\n    if (snap.exists()) return snap.data();\r\n  } catch(e) {}\r\n  return null;\r\n}\r\n\r\n// Resolve the company logo URL from profile.public.logoUrl.\r\n// Supports both https(s) URLs and gs:// storage URLs.\r\nexport async function resolveCompanyLogoUrl(companyId) {\r\n  if (!companyId) return null;\r\n  const profile = await fetchCompanyProfile(companyId);\r\n  const logoUrl = profile?.logoUrl || null;\r\n  if (!logoUrl) return null;\r\n\r\n  // If a gs:// URL is stored, convert it to an HTTPS download URL.\r\n  if (typeof logoUrl === 'string' && logoUrl.trim().toLowerCase().startsWith('gs://')) {\r\n    try {\r\n      const raw = logoUrl.trim();\r\n      const match = raw.match(/^gs:\\/\\/([^\\/]+)\\/(.+)$/i);\r\n      const bucket = match && match[1] ? String(match[1]) : '';\r\n      const fullPath = match && match[2] ? String(match[2]) : '';\r\n      if (!fullPath) return null;\r\n\r\n      // Some environments are picky about ref-from-gs:// URLs. Use bucket+path explicitly.\r\n      // Also handle common mismatch between provided bucket domains.\r\n      const bucketCandidates = [];\r\n      if (bucket) {\r\n        bucketCandidates.push(bucket);\r\n        if (bucket.toLowerCase().endsWith('.firebasestorage.app')) {\r\n          bucketCandidates.push(bucket.replace(/\\.firebasestorage\\.app$/i, '.appspot.com'));\r\n        }\r\n      }\r\n\r\n      for (const b of bucketCandidates.length > 0 ? bucketCandidates : ['']) {\r\n        try {\r\n          const st = b ? getStorage(app, `gs://${b}`) : storage;\r\n          const r = storageRef(st, fullPath);\r\n          const https = await getDownloadURL(r);\r\n          if (https) return https;\r\n        } catch (inner) {\r\n          // fall through and try other bucket candidates\r\n        }\r\n      }\r\n\r\n      return null;\r\n    } catch(e) {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  return logoUrl;\r\n}\r\n\r\nexport async function saveCompanyProfile(companyId, profile) {\r\n  if (!companyId) return false;\r\n  try {\r\n    const ref = doc(db, 'foretag', companyId, 'profil', 'public');\r\n    await setDoc(ref, profile, { merge: true });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// User profile helpers\r\nexport async function fetchUserProfile(uid) {\r\n  if (!uid) return null;\r\n  try {\r\n    const ref = doc(db, 'users', uid);\r\n    const snap = await getDoc(ref);\r\n    if (snap.exists()) return snap.data();\r\n  } catch(e) {}\r\n  return null;\r\n}\r\n\r\n// Company member directory (scoped under foretag/{companyId}/members/{uid})\r\n// Used for listing admins and other roles inside a company.\r\nexport async function upsertCompanyMember({ companyId: companyIdOverride, uid, displayName, email, role }) {\r\n  try {\r\n    if (!uid) return false;\r\n    const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\r\n    if (!companyId) return false;\r\n    const ref = doc(db, 'foretag', companyId, 'members', uid);\r\n    await setDoc(ref, {\r\n      uid,\r\n      companyId,\r\n      displayName: displayName || null,\r\n      email: email || null,\r\n      role: role || null,\r\n      updatedAt: serverTimestamp(),\r\n    }, { merge: true });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function fetchCompanyMembers(companyIdOverride, { role } = {}) {\r\n  async function attemptRead({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n\r\n    const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\r\n    if (!companyId) return { ok: true, out: [], err: null, permissionDenied: false, companyId: null };\r\n\r\n    try {\r\n      const baseRef = collection(db, 'foretag', companyId, 'members');\r\n      const q = role ? query(baseRef, where('role', '==', role)) : query(baseRef);\r\n      // Prefer server to avoid stale/empty cache on fresh logins.\r\n      let snap;\r\n      try {\r\n        snap = await getDocsFromServer(q);\r\n      } catch(e) {\r\n        snap = await getDocs(q);\r\n      }\r\n      const out = [];\r\n      snap.forEach(d => out.push({ id: d.id, ...d.data() }));\r\n      out.sort((a, b) => String(a.displayName || a.email || '').localeCompare(String(b.displayName || b.email || ''), undefined, { sensitivity: 'base' }));\r\n      return {\r\n        ok: true,\r\n        out,\r\n        err: null,\r\n        permissionDenied: false,\r\n        companyId,\r\n        meta: {\r\n          size: snap?.size ?? out.length,\r\n          fromCache: snap?.metadata?.fromCache ?? null,\r\n        }\r\n      };\r\n    } catch (e) {\r\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      return { ok: false, out: [], err: e, permissionDenied, companyId, meta: null };\r\n    }\r\n  }\r\n\r\n  try {\r\n    const first = await attemptRead({ forceTokenRefresh: false });\r\n    if (first.ok) return first.out;\r\n\r\n    if (first.permissionDenied) {\r\n      const second = await attemptRead({ forceTokenRefresh: true });\r\n      if (second.ok) return second.out;\r\n\r\n      // Persist debug info so we can inspect on the client via existing debug UI.\r\n      try {\r\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n        let arr = rawArr ? JSON.parse(rawArr) : [];\r\n        const debug = await getAuthDebugSnapshot();\r\n        const entry = {\r\n          fn: 'fetchCompanyMembers',\r\n          code: second.err?.code || first.err?.code || null,\r\n          err: (second.err && second.err.message) ? second.err.message : ((first.err && first.err.message) ? first.err.message : String(second.err || first.err)),\r\n          ts: new Date().toISOString(),\r\n          role: role || null,\r\n          resolvedCompanyId: second.companyId || first.companyId || null,\r\n          auth: debug,\r\n        };\r\n        arr.push(entry);\r\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n      } catch(e) {}\r\n\r\n      return [];\r\n    }\r\n\r\n    // Log any non-permission errors too (e.g. failed-precondition, offline, etc)\r\n    try {\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      let arr = rawArr ? JSON.parse(rawArr) : [];\r\n      const debug = await getAuthDebugSnapshot();\r\n      const entry = {\r\n        fn: 'fetchCompanyMembers',\r\n        code: first.err?.code || null,\r\n        err: (first.err && first.err.message) ? first.err.message : String(first.err),\r\n        ts: new Date().toISOString(),\r\n        role: role || null,\r\n        resolvedCompanyId: first.companyId || null,\r\n        meta: first.meta || null,\r\n        auth: debug,\r\n      };\r\n      arr.push(entry);\r\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n    } catch(e) {}\r\n\r\n    return [];\r\n  } catch(e) {\r\n    return [];\r\n  }\r\n}\r\n\r\n// Realtime subscription for company members (used for ansvarig picker).\r\n// Returns an unsubscribe function.\r\nexport function subscribeCompanyMembers(companyIdOverride, { role, onData, onError } = {}) {\r\n  let unsub = null;\r\n  (async () => {\r\n    try {\r\n      const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\r\n      if (!companyId) {\r\n        try { if (typeof onData === 'function') onData([], { size: 0, fromCache: null, companyId: null }); } catch(e) {}\r\n        return;\r\n      }\r\n      const baseRef = collection(db, 'foretag', companyId, 'members');\r\n      const q = role ? query(baseRef, where('role', '==', role)) : query(baseRef);\r\n      unsub = onSnapshot(\r\n        q,\r\n        (snap) => {\r\n          const out = [];\r\n          snap.forEach(d => out.push({ id: d.id, ...d.data() }));\r\n          out.sort((a, b) => String(a.displayName || a.email || '').localeCompare(String(b.displayName || b.email || ''), undefined, { sensitivity: 'base' }));\r\n          try {\r\n            if (typeof onData === 'function') {\r\n              onData(out, { size: snap.size, fromCache: snap.metadata?.fromCache ?? null, companyId });\r\n            }\r\n          } catch(e) {}\r\n        },\r\n        (err) => {\r\n          try { if (typeof onError === 'function') onError(err); } catch(e) {}\r\n        }\r\n      );\r\n    } catch(e) {\r\n      try { if (typeof onError === 'function') onError(e); } catch(e) {}\r\n    }\r\n  })();\r\n\r\n  return () => {\r\n    try { if (typeof unsub === 'function') unsub(); } catch(e) {}\r\n  };\r\n}\r\n\r\n// Save or update a user's profile document (client-side safe helper)\r\nexport async function saveUserProfile(uid, data) {\r\n  if (!uid) return false;\r\n  try {\r\n    const ref = doc(db, 'users', uid);\r\n    await setDoc(ref, data, { merge: true });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function signInEmailPassword(email, password) {\r\n  return signInWithEmailAndPassword(auth, email, password);\r\n}\r\n\r\n// Log user actions (egenkontroller, skyddsronder) with company context\r\nexport async function logUserAction({ uid, email, companyId, type, payload }) {\r\n  try {\r\n    const ref = collection(db, 'logs');\r\n    await addDoc(ref, {\r\n      uid: uid || null,\r\n      email: email || null,\r\n      companyId: companyId || null,\r\n      type, // e.g. 'egenkontroll' | 'skyddsrond'\r\n      payload: payload || {},\r\n      ts: serverTimestamp(),\r\n    });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Company-scoped activity feed (for dashboard \"Senaste aktivitet\")\r\n// Storage: foretag/{companyId}/activity\r\n// Event shape example:\r\n// { type: 'login', uid, email, displayName, ts }\r\nexport async function logCompanyActivity(event, companyIdOverride) {\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, event || null);\r\n    if (!companyId) return false;\r\n    const ref = collection(db, 'foretag', companyId, 'activity');\r\n    const payload = Object.assign({}, event || {}, {\r\n      companyId,\r\n      ts: serverTimestamp(),\r\n    });\r\n    await addDoc(ref, sanitizeForFirestore(payload));\r\n    return true;\r\n  } catch(e) {\r\n    // Record last Firestore error for debugging (permission-denied, etc)\r\n    try {\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      let arr = rawArr ? JSON.parse(rawArr) : [];\r\n      const debug = await getAuthDebugSnapshot();\r\n      const entry = {\r\n        fn: 'logCompanyActivity',\r\n        code: e?.code || null,\r\n        err: (e && e.message) ? e.message : String(e),\r\n        ts: new Date().toISOString(),\r\n        companyIdOverride: companyIdOverride || null,\r\n        eventType: event?.type || null,\r\n        auth: debug,\r\n      };\r\n      arr.push(entry);\r\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n    } catch(e) {}\r\n    return false;\r\n  }\r\n}\r\n\r\n// Realtime subscription for company activity feed.\r\n// Returns an unsubscribe function.\r\nexport function subscribeCompanyActivity(companyIdOverride, { onData, onError, limitCount = 25 } = {}) {\r\n  let unsub = null;\r\n  (async () => {\r\n    try {\r\n      const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\r\n      if (!companyId) {\r\n        try { if (typeof onData === 'function') onData([], { size: 0, fromCache: null, companyId: null }); } catch(e) {}\r\n        return;\r\n      }\r\n      const baseRef = collection(db, 'foretag', companyId, 'activity');\r\n      const q = query(baseRef, orderBy('ts', 'desc'), limit(Math.max(1, Math.min(100, Number(limitCount) || 25))));\r\n      unsub = onSnapshot(\r\n        q,\r\n        (snap) => {\r\n          const out = [];\r\n          snap.forEach(d => out.push({ id: d.id, ...d.data() }));\r\n          try {\r\n            if (typeof onData === 'function') {\r\n              onData(out, { size: snap.size, fromCache: snap.metadata?.fromCache ?? null, companyId });\r\n            }\r\n          } catch(e) {}\r\n        },\r\n        (err) => {\r\n          // Record last Firestore error for debugging\r\n          (async () => {\r\n            try {\r\n              const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n              let arr = rawArr ? JSON.parse(rawArr) : [];\r\n              const debug = await getAuthDebugSnapshot();\r\n              const entry = {\r\n                fn: 'subscribeCompanyActivity',\r\n                code: err?.code || null,\r\n                err: (err && err.message) ? err.message : String(err),\r\n                ts: new Date().toISOString(),\r\n                companyIdOverride: companyIdOverride || null,\r\n                auth: debug,\r\n              };\r\n              arr.push(entry);\r\n              await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n              await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n            } catch(e) {}\r\n          })();\r\n          try { if (typeof onError === 'function') onError(err); } catch(e) {}\r\n        }\r\n      );\r\n    } catch(e) {\r\n      // Record last Firestore error for debugging\r\n      (async () => {\r\n        try {\r\n          const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n          let arr = rawArr ? JSON.parse(rawArr) : [];\r\n          const debug = await getAuthDebugSnapshot();\r\n          const entry = {\r\n            fn: 'subscribeCompanyActivity',\r\n            code: e?.code || null,\r\n            err: (e && e.message) ? e.message : String(e),\r\n            ts: new Date().toISOString(),\r\n            companyIdOverride: companyIdOverride || null,\r\n            auth: debug,\r\n          };\r\n          arr.push(entry);\r\n          await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n          await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n        } catch(e) {}\r\n      })();\r\n      try { if (typeof onError === 'function') onError(e); } catch(e) {}\r\n    }\r\n  })();\r\n\r\n  return () => {\r\n    try { if (typeof unsub === 'function') unsub(); } catch(e) {}\r\n  };\r\n}\r\n\r\n// Controls persistence helpers\r\nexport async function saveControlToFirestore(control, companyIdOverride) {\r\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (!control) return { ok: false, err: null, permissionDenied: false };\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n    const companyId = await resolveCompanyId(companyIdOverride, control);\r\n    if (!companyId) return { ok: false, err: null, permissionDenied: false };\r\n    const id = control.id || (new Date().getTime().toString());\r\n    const ref = doc(db, 'foretag', companyId, 'controls', id);\r\n    // Normalize project shape: some older local items use `projectId` instead of `project: { id }`\r\n    const projectObj = control.project || (control.projectId ? { id: control.projectId } : (control.project && control.project.id ? { id: control.project.id } : undefined));\r\n    const payload = Object.assign({}, control, {\r\n      companyId,\r\n      project: projectObj,\r\n      projectId: projectObj?.id || control.projectId || control.project?.id,\r\n      savedAt: serverTimestamp()\r\n    });\r\n    const safePayload = sanitizeForFirestore(payload);\r\n    try {\r\n      await setDoc(ref, safePayload, { merge: true });\r\n    } catch(e) {\r\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      return { ok: false, err: e, permissionDenied };\r\n    }\r\n    // Also persist a local copy so the native app shows the item immediately\r\n    try {\r\n      const raw = await AsyncStorage.getItem('completed_controls');\r\n      let arr = raw ? JSON.parse(raw) || [] : [];\r\n      // avoid duplicate by id\r\n      if (!arr.find(a => a && a.id === id)) {\r\n        arr.push({ ...control, id, savedAt: new Date().toISOString() });\r\n        await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\r\n      }\r\n    } catch(e) {\r\n      // ignore local persist failures\r\n    }\r\n    return { ok: true, err: null, permissionDenied: false };\r\n  }\r\n\r\n  try {\r\n    const first = await attemptWrite({ forceTokenRefresh: false });\r\n    if (first.ok) return true;\r\n    if (first.permissionDenied) {\r\n      // Very common: custom claims were just set but the client token hasn't refreshed yet.\r\n      const second = await attemptWrite({ forceTokenRefresh: true });\r\n      if (second.ok) return true;\r\n      throw second.err || first.err || new Error('permission-denied');\r\n    }\r\n    throw first.err;\r\n  } catch(e) {\r\n      // If Firestore rejects due to permission issues, persist locally and show a friendly alert\r\n      const isPermissionError = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      try {\r\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n        let arr = rawArr ? JSON.parse(rawArr) : [];\r\n        const debug = await getAuthDebugSnapshot();\r\n        let resolvedCompanyId = null;\r\n        try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, control); } catch(e) {}\r\n        const entry = {\r\n          fn: 'saveControlToFirestore',\r\n          code: e?.code || null,\r\n          err: (e && e.message) ? e.message : String(e),\r\n          full: (e && e.stack) ? e.stack : String(e),\r\n          ts: new Date().toISOString(),\r\n          id: control && control.id ? control.id : null,\r\n          resolvedCompanyId,\r\n          auth: debug,\r\n        };\r\n        arr.push(entry);\r\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n        // keep single \"last\" key for compatibility\r\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n      } catch(e) {}\r\n\r\n      if (isPermissionError) {\r\n        // Save the control locally so the app doesn't lose data and can sync later\r\n        try {\r\n          const raw = await AsyncStorage.getItem('completed_controls');\r\n          let arr = raw ? JSON.parse(raw) || [] : [];\r\n          const id = control && control.id ? control.id : (new Date().getTime().toString());\r\n          if (!arr.find(a => a && a.id === id)) {\r\n            arr.push({ ...control, id, savedAt: new Date().toISOString() });\r\n            await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\r\n          }\r\n        } catch(e) {}\r\n\r\n        // Show friendly user-facing message and warn in console (avoid raw console.error to reduce noisy UI logs)\r\n        try {\r\n          Alert.alert('Sparat lokalt', 'Kontrollen sparades lokalt eftersom servern nekade skrivning. Appen kommer försöka synka senare.');\r\n        } catch(e) {}\r\n        console.warn('[firebase] saveControlToFirestore permission denied — saved locally');\r\n        return false;\r\n      }\r\n\r\n      // Fallback for other error types\r\n      console.error('[firebase] saveControlToFirestore error', e);\r\n      return false;\r\n    }\r\n}\r\n\r\nexport async function saveDraftToFirestore(draft, companyIdOverride) {\r\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (!draft) return { ok: false, err: null, permissionDenied: false };\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n    const companyId = await resolveCompanyId(companyIdOverride, draft);\r\n    if (!companyId) return { ok: false, err: null, permissionDenied: false };\r\n    const id = draft.id || (new Date().getTime().toString());\r\n    const ref = doc(db, 'foretag', companyId, 'draft_controls', id);\r\n    const projectObj = draft.project || (draft.projectId ? { id: draft.projectId } : (draft.project && draft.project.id ? { id: draft.project.id } : undefined));\r\n    const payload = Object.assign({}, draft, {\r\n      companyId,\r\n      project: projectObj,\r\n      projectId: projectObj?.id || draft.projectId || draft.project?.id,\r\n      savedAt: serverTimestamp()\r\n    });\r\n    const safePayload = sanitizeForFirestore(payload);\r\n    try {\r\n      await setDoc(ref, safePayload, { merge: true });\r\n    } catch(e) {\r\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      return { ok: false, err: e, permissionDenied };\r\n    }\r\n    // Also persist a local copy so native app retains the draft\r\n    try {\r\n      const raw = await AsyncStorage.getItem('draft_controls');\r\n      let arr = raw ? JSON.parse(raw) || [] : [];\r\n      const idx = arr.findIndex(a => a && a.id === id);\r\n      if (idx !== -1) {\r\n        arr[idx] = { ...draft, id, savedAt: new Date().toISOString() };\r\n      } else {\r\n        arr.push({ ...draft, id, savedAt: new Date().toISOString() });\r\n      }\r\n      await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\r\n    } catch(e) {\r\n      // ignore local persist failures\r\n    }\r\n    return { ok: true, err: null, permissionDenied: false };\r\n  }\r\n\r\n  try {\r\n    const first = await attemptWrite({ forceTokenRefresh: false });\r\n    if (first.ok) return true;\r\n    if (first.permissionDenied) {\r\n      const second = await attemptWrite({ forceTokenRefresh: true });\r\n      if (second.ok) return true;\r\n      throw second.err || first.err || new Error('permission-denied');\r\n    }\r\n    throw first.err;\r\n  } catch(e) {\r\n      const isPermissionError = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      try {\r\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n        let arr = rawArr ? JSON.parse(rawArr) : [];\r\n        const debug = await getAuthDebugSnapshot();\r\n        let resolvedCompanyId = null;\r\n        try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, draft); } catch(e) {}\r\n        const entry = {\r\n          fn: 'saveDraftToFirestore',\r\n          code: e?.code || null,\r\n          err: (e && e.message) ? e.message : String(e),\r\n          full: (e && e.stack) ? e.stack : String(e),\r\n          ts: new Date().toISOString(),\r\n          id: draft && draft.id ? draft.id : null,\r\n          resolvedCompanyId,\r\n          auth: debug,\r\n        };\r\n        arr.push(entry);\r\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n        // keep single \"last\" key for compatibility\r\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n      } catch(e) {}\r\n\r\n      if (isPermissionError) {\r\n        // Save the draft locally so user doesn't lose work\r\n        try {\r\n          const raw = await AsyncStorage.getItem('draft_controls');\r\n          let arr = raw ? JSON.parse(raw) || [] : [];\r\n          const id = draft && draft.id ? draft.id : (new Date().getTime().toString());\r\n          const idx = arr.findIndex(a => a && a.id === id);\r\n          if (idx !== -1) {\r\n            arr[idx] = { ...draft, id, savedAt: new Date().toISOString() };\r\n          } else {\r\n            arr.push({ ...draft, id, savedAt: new Date().toISOString() });\r\n          }\r\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\r\n        } catch(e) {}\r\n\r\n        try {\r\n          Alert.alert('Sparat lokalt', 'Utkast sparades lokalt eftersom servern nekade skrivning. Appen kommer försöka synka senare.');\r\n        } catch(e) {}\r\n        console.warn('[firebase] saveDraftToFirestore permission denied — saved locally');\r\n        return false;\r\n      }\r\n\r\n      console.error('[firebase] saveDraftToFirestore error', e);\r\n      return false;\r\n    }\r\n}\r\n\r\n// Fetch controls for a single project from Firestore\r\nexport async function fetchControlsForProject(projectId, companyIdOverride) {\r\n  if (!projectId) return [];\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return [];\r\n    const out = [];\r\n\r\n    // Prefer querying on normalized projectId field\r\n    try {\r\n      const q1 = query(collection(db, 'foretag', companyId, 'controls'), where('projectId', '==', projectId));\r\n      const snap1 = await getDocs(q1);\r\n      snap1.forEach(docSnap => {\r\n        const d = docSnap.data() || {};\r\n        out.push(Object.assign({}, d, { id: docSnap.id }));\r\n      });\r\n    } catch(e) {}\r\n\r\n    // Backward compatibility: some items may have only project.id\r\n    try {\r\n      const q2 = query(collection(db, 'foretag', companyId, 'controls'), where('project.id', '==', projectId));\r\n      const snap2 = await getDocs(q2);\r\n      snap2.forEach(docSnap => {\r\n        if (!out.find(x => x && x.id === docSnap.id)) {\r\n          const d = docSnap.data() || {};\r\n          out.push(Object.assign({}, d, { id: docSnap.id }));\r\n        }\r\n      });\r\n    } catch(e) {}\r\n\r\n    return out;\r\n  } catch(e) {\r\n    return [];\r\n  }\r\n}\r\n\r\n// Fetch draft controls for a single project from Firestore\r\nexport async function fetchDraftControlsForProject(projectId, companyIdOverride) {\r\n  if (!projectId) return [];\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return [];\r\n    const out = [];\r\n\r\n    // Prefer querying on normalized projectId field\r\n    try {\r\n      const q1 = query(collection(db, 'foretag', companyId, 'draft_controls'), where('projectId', '==', projectId));\r\n      const snap1 = await getDocs(q1);\r\n      snap1.forEach(docSnap => {\r\n        const d = docSnap.data() || {};\r\n        out.push(Object.assign({}, d, { id: docSnap.id }));\r\n      });\r\n    } catch(e) {}\r\n\r\n    // Backward compatibility: some items may have only project.id\r\n    try {\r\n      const q2 = query(collection(db, 'foretag', companyId, 'draft_controls'), where('project.id', '==', projectId));\r\n      const snap2 = await getDocs(q2);\r\n      snap2.forEach(docSnap => {\r\n        if (!out.find(x => x && x.id === docSnap.id)) {\r\n          const d = docSnap.data() || {};\r\n          out.push(Object.assign({}, d, { id: docSnap.id }));\r\n        }\r\n      });\r\n    } catch(e) {}\r\n\r\n    return out;\r\n  } catch(e) {\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function deleteDraftControlFromFirestore(draftId, companyIdOverride) {\r\n  try {\r\n    if (!draftId) return false;\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return false;\r\n    await deleteDoc(doc(db, 'foretag', companyId, 'draft_controls', String(draftId)));\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function deleteControlFromFirestore(controlId, companyIdOverride) {\r\n  try {\r\n    if (!controlId) return false;\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return false;\r\n    await deleteDoc(doc(db, 'foretag', companyId, 'controls', String(controlId)));\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Byggdel-hierarki per företag\r\n// Storage: foretag/{companyId}/byggdel_hierarki/state\r\n// Shape: { momentsByGroup: { [huvudgrupp: string]: string[] }, updatedAt }\r\nexport async function fetchByggdelHierarchy(companyIdOverride) {\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return { momentsByGroup: {} };\r\n    const ref = doc(db, 'foretag', companyId, 'byggdel_hierarki', 'state');\r\n    const snap = await getDoc(ref);\r\n    if (!snap.exists()) return { momentsByGroup: {} };\r\n    const data = snap.data() || {};\r\n    const momentsByGroup = (data && typeof data.momentsByGroup === 'object' && data.momentsByGroup) ? data.momentsByGroup : {};\r\n    return { momentsByGroup };\r\n  } catch(e) {\r\n    return { momentsByGroup: {} };\r\n  }\r\n}\r\n\r\nexport async function saveByggdelHierarchy({ momentsByGroup }, companyIdOverride) {\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return false;\r\n    const ref = doc(db, 'foretag', companyId, 'byggdel_hierarki', 'state');\r\n    await setDoc(ref, { momentsByGroup: momentsByGroup || {}, updatedAt: serverTimestamp() }, { merge: true });\r\n    return true;\r\n  } catch(e) {\r\n    return false;\r\n  }\r\n}\r\n\r\n// Byggdel mall-register per företag\r\n// Data model: foretag/{companyId}/byggdel_mallar/{mallId} with fields:\r\n// { huvudgrupp: string, moment: string, name: string, createdAt, updatedAt }\r\nexport async function fetchByggdelMallar(companyIdOverride) {\r\n  try {\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) return [];\r\n    const out = [];\r\n\r\n    // Avoid multi-field orderBy here: it can require a composite index.\r\n    // Fetch all mall docs and sort client-side for predictable UI ordering.\r\n    const snap = await getDocs(collection(db, 'foretag', companyId, 'byggdel_mallar'));\r\n    snap.forEach(docSnap => {\r\n      const d = docSnap.data() || {};\r\n      out.push(Object.assign({}, d, { id: docSnap.id }));\r\n    });\r\n\r\n    out.sort((a, b) => {\r\n      const ag = String(a && (a.huvudgrupp ?? '')).trim();\r\n      const bg = String(b && (b.huvudgrupp ?? '')).trim();\r\n      if (ag !== bg) return ag.localeCompare(bg, 'sv');\r\n\r\n      const am = String(a && (a.moment ?? '')).trim();\r\n      const bm = String(b && (b.moment ?? '')).trim();\r\n      if (am !== bm) return am.localeCompare(bm, 'sv');\r\n\r\n      const an = String(a && (a.name ?? '')).trim();\r\n      const bn = String(b && (b.name ?? '')).trim();\r\n      return an.localeCompare(bn, 'sv');\r\n    });\r\n\r\n    return out;\r\n  } catch(e) {\r\n    return [];\r\n  }\r\n}\r\n\r\nexport async function createByggdelMall({ huvudgrupp, moment, name }, companyIdOverride) {\r\n  function normalizeMallNameLower(raw) {\r\n    const s = String(raw || '').trim();\r\n    if (!s) return '';\r\n    return s.replace(/\\s+/g, ' ').toLowerCase();\r\n  }\r\n\r\n  function makeMallNameKey(nameLower) {\r\n    const s = String(nameLower || '').trim();\r\n    if (!s) return '';\r\n    // Convert to a stable Firestore doc id\r\n    // - remove diacritics (åäö -> aao)\r\n    // - keep [a-z0-9-]\r\n    let base = s;\r\n    try {\r\n      base = base.normalize('NFKD').replace(/[\\u0300-\\u036f]/g, '');\r\n    } catch(e) {\r\n      // normalize may not exist in some environments; fall back\r\n      base = s;\r\n    }\r\n    base = base\r\n      .replace(/[^a-z0-9]+/g, '-')\r\n      .replace(/^-+/, '')\r\n      .replace(/-+$/, '')\r\n      .replace(/-+/g, '-');\r\n    return base || '';\r\n  }\r\n\r\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) {\r\n      const err = new Error('no_company');\r\n      err.code = 'no_company';\r\n      throw err;\r\n    }\r\n    const hg = String(huvudgrupp || '').trim();\r\n    const mm = String(moment || '').trim();\r\n    const nm = String(name || '').trim();\r\n    if (!hg || !mm || !nm) {\r\n      const err = new Error('invalid-argument');\r\n      err.code = 'invalid-argument';\r\n      throw err;\r\n    }\r\n\r\n    const nmLower = normalizeMallNameLower(nm);\r\n    const nameKey = makeMallNameKey(nmLower);\r\n    if (!nmLower || !nameKey) {\r\n      const err = new Error('invalid-argument');\r\n      err.code = 'invalid-argument';\r\n      throw err;\r\n    }\r\n\r\n    const colRef = collection(db, 'foretag', companyId, 'byggdel_mallar');\r\n\r\n    // Uniqueness per company (case-insensitive)\r\n    // Must also cover older docs that may not have nameLower.\r\n    const allSnap = await getDocs(colRef);\r\n    let hasDuplicate = false;\r\n    allSnap.forEach(docSnap => {\r\n      const d = docSnap.data() || {};\r\n      const existingLower = normalizeMallNameLower(d.nameLower || d.name || '');\r\n      if (existingLower && existingLower === nmLower) hasDuplicate = true;\r\n    });\r\n    if (hasDuplicate) {\r\n      const err = new Error('already-exists');\r\n      err.code = 'already-exists';\r\n      throw err;\r\n    }\r\n\r\n    const docRef = doc(db, 'foretag', companyId, 'byggdel_mallar', nameKey);\r\n    const existingById = await getDoc(docRef);\r\n    if (existingById.exists()) {\r\n      const err = new Error('already-exists');\r\n      err.code = 'already-exists';\r\n      throw err;\r\n    }\r\n\r\n    const payload = {\r\n      huvudgrupp: hg,\r\n      moment: mm,\r\n      name: nm,\r\n      nameLower: nmLower,\r\n      nameKey,\r\n      points: [],\r\n      sections: [],\r\n      createdAt: serverTimestamp(),\r\n      updatedAt: serverTimestamp(),\r\n    };\r\n\r\n    try {\r\n      await setDoc(docRef, payload, { merge: false });\r\n      return docRef.id;\r\n    } catch(e) {\r\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      if (permissionDenied) {\r\n        const err = e || new Error('permission-denied');\r\n        err.code = err.code || 'permission-denied';\r\n        err.__permissionDenied = true;\r\n        throw err;\r\n      }\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  try {\r\n    return await attemptWrite({ forceTokenRefresh: false });\r\n  } catch(e) {\r\n    const isPermissionError = !!(e && (e.__permissionDenied === true || e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n    if (isPermissionError) {\r\n      try {\r\n        return await attemptWrite({ forceTokenRefresh: true });\r\n      } catch(e) {\r\n        e = e2 || e;\r\n      }\r\n    }\r\n\r\n    // Store debug info for troubleshooting (same pattern as other writes)\r\n    try {\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      let arr = rawArr ? JSON.parse(rawArr) : [];\r\n      const debug = await getAuthDebugSnapshot();\r\n      let resolvedCompanyId = null;\r\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\r\n      const entry = {\r\n        fn: 'createByggdelMall',\r\n        code: e?.code || null,\r\n        err: (e && e.message) ? e.message : String(e),\r\n        full: (e && e.stack) ? e.stack : String(e),\r\n        ts: new Date().toISOString(),\r\n        resolvedCompanyId,\r\n        auth: debug,\r\n      };\r\n      arr.push(entry);\r\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n    } catch(e) {}\r\n\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function deleteByggdelMall({ mallId }, companyIdOverride) {\r\n  async function attemptDelete({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) {\r\n      const err = new Error('no_company');\r\n      err.code = 'no_company';\r\n      throw err;\r\n    }\r\n\r\n    const id = String(mallId || '').trim();\r\n    if (!id) {\r\n      const err = new Error('invalid-argument');\r\n      err.code = 'invalid-argument';\r\n      throw err;\r\n    }\r\n\r\n    await deleteDoc(doc(db, 'foretag', companyId, 'byggdel_mallar', id));\r\n    return true;\r\n  }\r\n\r\n  try {\r\n    return await attemptDelete({ forceTokenRefresh: false });\r\n  } catch(e) {\r\n    const permissionDenied = !!(e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n    if (permissionDenied) {\r\n      try {\r\n        return await attemptDelete({ forceTokenRefresh: true });\r\n      } catch(e) {\r\n        e = e2 || e;\r\n      }\r\n    }\r\n\r\n    try {\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      let arr = rawArr ? JSON.parse(rawArr) : [];\r\n      const debug = await getAuthDebugSnapshot();\r\n      let resolvedCompanyId = null;\r\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\r\n      const entry = {\r\n        fn: 'deleteByggdelMall',\r\n        code: e?.code || null,\r\n        err: (e && e.message) ? e.message : String(e),\r\n        full: (e && e.stack) ? e.stack : String(e),\r\n        ts: new Date().toISOString(),\r\n        resolvedCompanyId,\r\n        auth: debug,\r\n      };\r\n      arr.push(entry);\r\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n    } catch(e) {}\r\n\r\n    throw e;\r\n  }\r\n}\r\n\r\n// Update a Byggdel mall document (merge)\r\n// Example: updateByggdelMall({ mallId, patch: { points: ['...'] } })\r\nexport async function updateByggdelMall({ mallId, patch }, companyIdOverride) {\r\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\r\n    if (forceTokenRefresh) {\r\n      try {\r\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\r\n      } catch(e) {}\r\n    }\r\n    const companyId = await resolveCompanyId(companyIdOverride, null);\r\n    if (!companyId) {\r\n      const err = new Error('no_company');\r\n      err.code = 'no_company';\r\n      throw err;\r\n    }\r\n    const id = String(mallId || '').trim();\r\n    if (!id) {\r\n      const err = new Error('invalid-argument');\r\n      err.code = 'invalid-argument';\r\n      throw err;\r\n    }\r\n\r\n    const safePatch = sanitizeForFirestore(patch || {});\r\n    const ref = doc(db, 'foretag', companyId, 'byggdel_mallar', id);\r\n    try {\r\n      await setDoc(ref, Object.assign({}, safePatch || {}, { updatedAt: serverTimestamp() }), { merge: true });\r\n      return true;\r\n    } catch(e) {\r\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n      if (permissionDenied) {\r\n        const err = e || new Error('permission-denied');\r\n        err.code = err.code || 'permission-denied';\r\n        err.__permissionDenied = true;\r\n        throw err;\r\n      }\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  try {\r\n    const ok = await attemptWrite({ forceTokenRefresh: false });\r\n    return ok;\r\n  } catch(e) {\r\n    const isPermissionError = !!(e && (e.__permissionDenied === true || e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\r\n    if (isPermissionError) {\r\n      try {\r\n        return await attemptWrite({ forceTokenRefresh: true });\r\n      } catch(e) {\r\n        e = e2 || e;\r\n      }\r\n    }\r\n\r\n    try {\r\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\r\n      let arr = rawArr ? JSON.parse(rawArr) : [];\r\n      const debug = await getAuthDebugSnapshot();\r\n      let resolvedCompanyId = null;\r\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\r\n      const entry = {\r\n        fn: 'updateByggdelMall',\r\n        code: e?.code || null,\r\n        err: (e && e.message) ? e.message : String(e),\r\n        full: (e && e.stack) ? e.stack : String(e),\r\n        ts: new Date().toISOString(),\r\n        mallId: String(mallId || '').trim() || null,\r\n        resolvedCompanyId,\r\n        auth: debug,\r\n      };\r\n      arr.push(entry);\r\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\r\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\r\n    } catch(e) {}\r\n\r\n    throw e;\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\formatPersonName.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\haptic-tab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\hello-wave.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\parallax-scroll-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\pdfExport.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'companyName' is assigned a value but never used.","line":103,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"companyName"},"fix":{"range":[4475,4525],"text":""},"desc":"Remove unused variable 'companyName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":192,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":192,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Minimal PDF export scaffold for controls with a shared header\r\n// Uses \"Mätplats\" terminology per request\r\n\r\nexport function buildControlPdfHtml({ control, project, company }) {\r\n  const title = control?.type || 'Kontroll';\r\n  const date = control?.date || '';\r\n  const companyName = company?.name || 'FÖRETAG AB';\r\n  const companyLogoUrl = company?.logoUrl || '';\r\n  const companyLogoBase64 = company?.logoBase64 || null;\r\n\r\n  // Fält för Fuktmätning\r\n  const device = control?.device || '';\r\n  const serial = control?.serial || '';\r\n  const calibrationDate = control?.calibrationDate || '';\r\n  const location = control?.location || '';\r\n  const material = control?.material || '';\r\n  const method = control?.method || '';\r\n  const reference = control?.reference || '';\r\n  const measurements = Array.isArray(control?.measurements) ? control.measurements : [];\r\n\r\n  const logoSrcFallback = 'assets/images/foretag_ab.png';\r\n  const logoImgTag = companyLogoBase64\r\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:48px; display:block;\"/>`\r\n    : (companyLogoUrl\r\n      ? `<img src=\"${companyLogoUrl}\" style=\"height:48px; display:block;\"/>`\r\n      : `<img src=\"${logoSrcFallback}\" style=\"height:48px; display:block;\"/>`);\r\n  const headerHtml = `\r\n    <table style=\"width:100%; border-collapse:collapse;\">\r\n      <tr>\r\n        <td style=\"vertical-align:middle; width:40%;\">\r\n          ${logoImgTag}\r\n          <div style=\"font-weight:700; color:#263238; margin-top:6px;\">${companyName}</div>\r\n        </td>\r\n        <td style=\"text-align:right; vertical-align:middle; width:60%;\">\r\n          <div style=\"font-size:22px; font-weight:800; color:#263238;\">${title}</div>\r\n          <div style=\"color:#666; margin-top:4px;\">Datum: ${date}</div>\r\n          <div style=\"color:#666;\">Projekt: ${project?.id || ''} - ${project?.name || ''}</div>\r\n        </td>\r\n      </tr>\r\n    </table>\r\n    <div style=\"height:8px\"></div>\r\n    <div style=\"width:100%; height:2px; background:#000; margin:6px 0 16px 0;\"></div>\r\n  `;\r\n\r\n  const fuktMetaHtml = `\r\n    <h3 style=\"color:#263238;\">Mätinstrument</h3>\r\n    <div>Instrument: ${escapeHtml(device)} | Serienummer: ${escapeHtml(serial)} | Kalibrering: ${escapeHtml(calibrationDate)}</div>\r\n    <h3 style=\"color:#263238; margin-top:12px;\">Mätplats</h3>\r\n    <div>Plats/rum: ${escapeHtml(location)} | Material: ${escapeHtml(material)}</div>\r\n    <div>Metod: ${escapeHtml(method)} | Referens: ${escapeHtml(reference)}</div>\r\n  `;\r\n\r\n  const rows = measurements.map((m, i) => `\r\n    <tr>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${i + 1}</td>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.position || '')}</td>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.depth || '')}</td>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.temp || '')}</td>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.value || '')} ${escapeHtml(m.unit || '')}</td>\r\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.note || '')}</td>\r\n    </tr>\r\n  `).join('');\r\n\r\n  const tableHtml = `\r\n    <h3 style=\"color:#263238; margin-top:16px;\">Mätpunkter</h3>\r\n    <table style=\"width:100%; border-collapse:collapse; font-size:12px;\">\r\n      <thead>\r\n        <tr style=\"background:#F7FAFC;\">\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">#</th>\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Position</th>\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Djup (mm)</th>\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Temp (°C)</th>\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Värde</th>\r\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Anteckning</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>${rows}</tbody>\r\n    </table>\r\n  `;\r\n\r\n  return `\r\n    <html>\r\n      <head>\r\n        <meta charset=\"utf-8\" />\r\n        <style>\r\n          body { font-family: Arial, sans-serif; color:#222; }\r\n          h3 { margin: 8px 0; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        ${headerHtml}\r\n        ${fuktMetaHtml}\r\n        ${tableHtml}\r\n      </body>\r\n    </html>\r\n  `;\r\n}\r\n\r\n// Build HTML for Mottagningskontroll (report-style layout matching mock)\r\nexport function buildMottagningsPdfHtml({ control, project, company }) {\r\n  const title = 'Mottagningskontroll';\r\n  const date = control?.date || control?.savedAt || '';\r\n  const companyName = company?.name || 'FÖRETAG AB';\r\n  const companyLogoUrl = company?.logoUrl || '';\r\n  const companyLogoBase64 = company?.logoBase64 || null;\r\n\r\n  const projectLine = `${project?.id ? project.id + ' - ' : ''}${project?.name || ''}`;\r\n  const participants = Array.isArray(control?.localParticipants) ? control.localParticipants : (Array.isArray(control?.participants) ? control.participants : []);\r\n  const weather = control?.selectedWeather || control?.weather || '';\r\n  const materialDesc = control?.materialDesc || control?.material || '';\r\n  const photos = Array.isArray(control?.mottagningsPhotos) ? control.mottagningsPhotos : (Array.isArray(control?.photos) ? control.photos : []);\r\n  const signatures = Array.isArray(control?.mottagningsSignatures) ? control.mottagningsSignatures : [];\r\n  const checklist = Array.isArray(control?.checklist) ? control.checklist : (Array.isArray(control?.points) ? control.points : []);\r\n\r\n  // Logo selection: prefer provided base64, then URL/path, then bundled asset\r\n  const logoSrcFallback = 'assets/images/foretag_ab.png';\r\n  const logoImgTagHeader = companyLogoBase64\r\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:48px; display:block;\"/>`\r\n    : (companyLogoUrl ? `<img src=\"${companyLogoUrl}\" style=\"height:48px; display:block;\"/>` : `<img src=\"${logoSrcFallback}\" style=\"height:48px; display:block;\"/>`);\r\n  const logoImgTagSmall = companyLogoBase64\r\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:24px; display:block;\"/>`\r\n    : (companyLogoUrl ? `<img src=\"${companyLogoUrl}\" style=\"height:24px; display:block;\"/>` : `<img src=\"${logoSrcFallback}\" style=\"height:24px; display:block;\"/>`);\r\n\r\n  const headerHtml = `\r\n    <div style=\"width:100%;\">\r\n      <!-- Top: company logo -->\r\n      <div style=\"display:flex; align-items:center; justify-content:flex-start;\">\r\n        <div style=\"width:160px;\">${logoImgTagHeader}</div>\r\n      </div>\r\n\r\n      <!-- Horizontal marking under logo (thin black line) -->\r\n      <div style=\"height:8px\"></div>\r\n      <div style=\"width:100%; height:2px; background:#000; margin:6px 0 10px 0;\"></div>\r\n\r\n      <!-- Title with vector icon below marking -->\r\n      <div style=\"display:flex; align-items:center; gap:12px; margin-top:8px;\">\r\n        <div style=\"width:44px; height:44px; border-radius:8px; background:transparent; display:flex; align-items:center; justify-content:center;\">\r\n          <svg width=\"26\" height=\"26\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n            <rect x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"4\" fill=\"none\" stroke=\"#7B1FA2\" stroke-width=\"2\"/>\r\n            <path d=\"M7 12l3 3 7-7\" fill=\"none\" stroke=\"#7B1FA2\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n          </svg>\r\n        </div>\r\n        <div style=\"font-size:28px; font-weight:800; color:#222;\">${title}</div>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n    const metaHtml = `\r\n      <div style=\"background:#f1f1f1; border-radius:8px; padding:12px; margin-top:8px; border:1px solid #e6e6e6;\">\r\n        <div style=\"font-weight:800; padding:6px 8px; background:rgba(0,0,0,0.03); border-radius:6px;\">PROJEKT ${escapeHtml(projectLine)}</div>\r\n        <table style=\"width:100%; margin-top:10px; border-collapse:collapse;\">\r\n          <tr>\r\n            <td style=\"vertical-align:top; padding:8px; width:160px; font-weight:700; color:#333;\">Datum för kontroll:</td>\r\n            <td style=\"padding:8px; color:#333;\">${escapeHtml(date || '')}</td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"vertical-align:top; padding:8px; font-weight:700; color:#333;\">Deltagare:</td>\r\n            <td style=\"padding:8px; color:#333;\">${participants.length ? participants.map(p => `<div style=\"margin-bottom:6px; display:flex; align-items:center; gap:8px;\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\" fill=\"#666\"/></svg><span>${escapeHtml(typeof p === 'string' ? p : (p.name || p.company || ''))}</span></div>`).join('') : '<i>Inga deltagare</i>'}</td>\r\n          </tr>\r\n          <tr>\r\n            <td style=\"vertical-align:top; padding:8px; font-weight:700; color:#333;\">Väder:</td>\r\n            <td style=\"padding:8px; color:#333;\">${escapeHtml(weather || '—')}</td>\r\n          </tr>\r\n        </table>\r\n      </div>\r\n    `;\r\n\r\n  // Summary of deviations (prominent box) — helpful to quickly see issues\r\n  let deviationSummaryHtml = '';\r\n  try {\r\n    let totalDeviations = 0;\r\n    const sectionSummaries = [];\r\n    if (Array.isArray(checklist) && checklist.length > 0) {\r\n      checklist.forEach((section) => {\r\n        const statuses = Array.isArray(section.statuses) ? section.statuses : [];\r\n        const count = statuses.filter(s => String(s || '').toLowerCase() === 'avvikelse').length;\r\n        if (count > 0) {\r\n          totalDeviations += count;\r\n          const label = section.label || section.title || '';\r\n          sectionSummaries.push(`<div style=\"margin-bottom:6px;\"><strong>${escapeHtml(label || 'Sektion')}</strong>: ${count} avvikelse${count>1 ? 'r' : ''}</div>`);\r\n        }\r\n      });\r\n    }\r\n    if (totalDeviations > 0) {\r\n      deviationSummaryHtml = `\r\n        <div style=\"margin-top:12px; padding:12px; border-radius:8px; border:2px solid #FFD600; background:#FFF8E1;\">\r\n          <div style=\"font-weight:800; color:#B85C00; font-size:16px; margin-bottom:8px;\">Sammanställning — Avvikelser: ${totalDeviations}</div>\r\n          <div style=\"font-size:13px; color:#333;\">${sectionSummaries.join('')}</div>\r\n        </div>\r\n      `;\r\n    }\r\n  } catch(e) {\r\n    deviationSummaryHtml = '';\r\n  }\r\n\r\n  // Checklist rendering (modern cards)\r\n  let checklistHtml = '';\r\n  if (Array.isArray(checklist) && checklist.length > 0) {\r\n    checklistHtml = checklist.map(section => {\r\n      const secLabel = escapeHtml(section.label || section.title || '');\r\n      const items = Array.isArray(section.points || section.items) ? (section.points || section.items) : [];\r\n      const statuses = Array.isArray(section.statuses) ? section.statuses : [];\r\n      const list = items.map((it, idx) => {\r\n          const status = statuses && statuses[idx] ? String(statuses[idx]).toLowerCase() : '';\r\n          let checkSvg = `<div style=\"width:20px; height:20px; border:1px solid #ccc; border-radius:4px;\"></div>`;\r\n          if (status === 'ok' || status === 'true') {\r\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#2e7d32\"/><path d=\"M7 12l3 3 7-7\" fill=\"none\" stroke=\"#fff\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;\r\n          } else if (status === 'avvikelse' || status === 'avvikelse' ) {\r\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><polygon points=\"12,2 22,20 2,20\" fill=\"#FFD600\" stroke=\"#111\" stroke-width=\"1\"/><text x=\"12\" y=\"15\" font-size=\"12\" font-weight=\"700\" fill=\"#111\" text-anchor=\"middle\">!</text></svg>`;\r\n          } else if (status === 'ejaktuell' || status === 'ej aktuell' || status === 'notapplicable' || status === 'na') {\r\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ffffff\" stroke=\"#bbb\" stroke-width=\"1\"/><path d=\"M8 8 L16 16 M16 8 L8 16\" stroke=\"#444\" stroke-width=\"1.8\" stroke-linecap=\"round\"/></svg>`;\r\n          }\r\n          return `<div style=\"display:flex; align-items:center; gap:12px; margin-bottom:8px;\"><div style=\"width:28px; text-align:center;\">${checkSvg}</div><div style=\"flex:1; font-size:14px;\">${escapeHtml(it)}</div></div>`;\r\n        }).join('');\r\n      return `<div style=\"border:1px solid #e6e9eb; border-radius:8px; padding:12px; margin-bottom:12px; background:#fff\">` + (secLabel ? `<div style=\"font-weight:700; margin-bottom:8px;\">${secLabel}</div>` : '') + list + `</div>`;\r\n    }).join('');\r\n  } else {\r\n    checklistHtml = '<div>Inga kontrollpunkter sparade.</div>';\r\n  }\r\n\r\n  // Photos grid + caption\r\n  let photosHtml = '';\r\n  const photoCaption = escapeHtml(control?.photoCaption || control?.photoNote || materialDesc || 'Material leverans inspekterad och dokumenterad');\r\n  if (Array.isArray(photos) && photos.length > 0) {\r\n    const cells = photos.map(ph => {\r\n      const src = ph && ph.uri ? ph.uri : ph || '';\r\n      return `<div style=\"width:33%; padding:8px; box-sizing:border-box;\">\r\n                <div style=\"width:100%; height:120px; border-radius:6px; border:1px solid #eee; background:#fafafa; display:flex; align-items:center; justify-content:center; overflow:hidden;\">\r\n                  ${src ? `<img src=\"${src}\" style=\"width:100%; height:100%; object-fit:cover; display:block;\"/>` : `<div style=\"color:#bbb; font-size:12px;\">Ingen bild</div>`}\r\n                </div>\r\n              </div>`;\r\n    }).join('');\r\n    photosHtml = `<div style=\"display:flex; flex-wrap:wrap; margin-top:8px;\">${cells}</div>`;\r\n    photosHtml += `<div style=\"text-align:center; color:#555; font-size:12px; margin-top:8px; font-style:italic;\">${photoCaption}</div>`;\r\n  } else photosHtml = '<div>Inga bifogade bilder.</div>';\r\n\r\n  // Signatures\r\n  const signaturesHtml = (Array.isArray(signatures) && signatures.length > 0) ? signatures.map(s => `\r\n    <div style=\"display:inline-block; width:33%; vertical-align:top; text-align:center; padding:8px;\">\r\n      <div style=\"height:64px; display:flex; align-items:center; justify-content:center;\">\r\n        ${s.uri ? `<img src=\"${s.uri}\" style=\"max-height:64px; display:block; margin:0 auto;\"/>` : (s.strokes ? '<div style=\"height:64px;\"></div>' : '')}\r\n      </div>\r\n      <div style=\"height:1px; border-bottom:1px dashed #ddd; margin:10px 20px 6px 20px;\"></div>\r\n      <div style=\"margin-top:6px; font-weight:700; color:#333; font-size:13px;\">${escapeHtml(s.name || '')}</div>\r\n    </div>\r\n  `).join('') : '<div>Inga signaturer</div>';\r\n\r\n  const footerHtml = `\r\n    <div style=\"width:100%; margin-top:28px; padding-top:12px; border-top:1px solid #eee; display:flex; align-items:center; justify-content:space-between;\">\r\n      <div style=\"color:#444; font-size:13px;\">Kontrollen är utförd med <strong>DigitalKontroll</strong></div>\r\n      <div style=\"display:flex; align-items:center; gap:12px;\">\r\n        <div style=\"height:28px;\">${logoImgTagSmall}</div>\r\n        <div style=\"color:#777; font-size:12px;\">www.digitalkontroll.se | info@digitalkontroll.se | 08-123 456 78</div>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  return `\r\n    <html>\r\n      <head>\r\n        <meta charset=\"utf-8\" />\r\n        <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\r\n        <style>\r\n          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:16px; }\r\n          h2 { margin:10px 0; color:#263238; }\r\n          .card { background:#fff; border:1px solid #eef2f4; border-radius:10px; padding:12px; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        ${headerHtml}\r\n        ${metaHtml}\r\n        ${deviationSummaryHtml}\r\n\r\n        <h2>Kontrollpunkter</h2>\r\n        ${checklistHtml}\r\n\r\n        <h2>Bifogade bilder</h2>\r\n        ${photosHtml}\r\n\r\n        <h2>Signaturer</h2>\r\n        <div style=\"display:flex; gap:8px; margin-top:8px;\">${signaturesHtml}</div>\r\n\r\n        ${footerHtml}\r\n      </body>\r\n    </html>\r\n  `;\r\n}\r\n\r\n// Dispatcher: choose builder based on control type\r\nexport function buildPdfHtmlForControl({ control, project, company }) {\r\n  if (!control || !control.type) return buildControlPdfHtml({ control, project, company });\r\n  switch ((control.type || '').toString()) {\r\n    case 'Mottagningskontroll':\r\n      return buildMottagningsPdfHtml({ control, project, company });\r\n    default:\r\n      return buildControlPdfHtml({ control, project, company });\r\n  }\r\n}\r\n\r\nfunction escapeHtml(s) {\r\n  return String(s || '')\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#39;');\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\projectBus.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":18,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Simple in-memory event bus for cross-screen project updates.\r\n// Avoids passing non-serializable callbacks through React Navigation params.\r\n\r\nconst projectUpdatedListeners = new Set();\r\n\r\nexport function onProjectUpdated(listener) {\r\n  if (typeof listener !== 'function') return () => {};\r\n  projectUpdatedListeners.add(listener);\r\n  return () => {\r\n    projectUpdatedListeners.delete(listener);\r\n  };\r\n}\r\n\r\nexport function emitProjectUpdated(updatedProject) {\r\n  for (const listener of projectUpdatedListeners) {\r\n    try {\r\n      listener(updatedProject);\r\n    } catch(e) {\r\n      // ignore\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\themed-text.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\themed-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ui\\icon-symbol.ios.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\components\\ui\\icon-symbol.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\constants\\theme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\hooks\\use-color-scheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\hooks\\use-color-scheme.web.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\hooks\\use-theme-color.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\hooks\\useBackgroundSync.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":49,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":57,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":76,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":81,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":85},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":83,"column":108,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":109},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":87,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":99,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":104,"column":80,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":81},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":106,"column":110,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":111},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":110,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":111,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":16}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'onStatus'. Either include it or remove the dependency array.","line":123,"column":6,"nodeType":"ArrayExpression","endLine":123,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, onStatus]","fix":{"range":[4811,4822],"text":"[companyId, onStatus]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport NetInfo from '@react-native-community/netinfo';\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport { saveControlToFirestore, saveDraftToFirestore, saveHierarchy } from '../components/firebase';\r\n\r\nexport default function useBackgroundSync(companyId, opts = {}) {\r\n  const { onStatus } = opts;\r\n  const [status, setStatus] = useState('idle'); // idle | pending | syncing | synced | error | offline\r\n  const attemptsRef = useRef(0);\r\n  const backoffTimer = useRef(null);\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    const unsubscribe = NetInfo.addEventListener(async (state) => {\r\n      const online = !!(state.isConnected && (state.isInternetReachable ?? true));\r\n      if (!mounted) return;\r\n      if (!online) {\r\n        setStatus('offline');\r\n        if (onStatus) onStatus('offline');\r\n        return;\r\n      }\r\n      // online -> try to sync\r\n      try {\r\n        const raw = await AsyncStorage.getItem('hierarchy_local');\r\n        if (!raw) {\r\n          setStatus('synced');\r\n          if (onStatus) onStatus('synced');\r\n          return;\r\n        }\r\n        const parsed = JSON.parse(raw);\r\n        if (!parsed || !Array.isArray(parsed) || parsed.length === 0) {\r\n          // nothing to sync\r\n          await AsyncStorage.removeItem('hierarchy_local');\r\n          setStatus('synced');\r\n          if (onStatus) onStatus('synced');\r\n          return;\r\n        }\r\n        // attempt sync with retries/backoff\r\n        setStatus('syncing');\r\n        if (onStatus) onStatus('syncing');\r\n        let ok = false;\r\n        attemptsRef.current = 0;\r\n        while (attemptsRef.current < 5 && !ok) {\r\n          attemptsRef.current += 1;\r\n          try {\r\n            const res = await saveHierarchy(companyId, parsed);\r\n            ok = res === true || (res && res.ok === true);\r\n            if (ok) break;\r\n          } catch(e) {\r\n            // ignore, will backoff\r\n          }\r\n          // exponential backoff\r\n          const waitMs = Math.min(30000, 500 * Math.pow(2, attemptsRef.current));\r\n          await new Promise(r => backoffTimer.current = setTimeout(r, waitMs));\r\n        }\r\n        if (ok) {\r\n          try { await AsyncStorage.removeItem('hierarchy_local'); } catch(e) {}\r\n          setStatus('synced');\r\n          if (onStatus) onStatus('synced');\r\n        } else {\r\n          setStatus('error');\r\n          if (onStatus) onStatus('error');\r\n        }\r\n        // Additionally attempt to sync any locally stored controls (completed and drafts)\r\n        try {\r\n          // Sync completed controls\r\n          const rawCompleted = await AsyncStorage.getItem('completed_controls');\r\n          if (rawCompleted) {\r\n            let completedArr = JSON.parse(rawCompleted) || [];\r\n            if (Array.isArray(completedArr) && completedArr.length > 0) {\r\n              const remaining = [];\r\n              for (const ctl of completedArr) {\r\n                try {\r\n                  const res = await saveControlToFirestore(ctl);\r\n                  if (!res) remaining.push(ctl);\r\n                } catch(e) {\r\n                  remaining.push(ctl);\r\n                }\r\n              }\r\n              if (remaining.length === 0) {\r\n                try { await AsyncStorage.removeItem('completed_controls'); } catch(e) {}\r\n              } else {\r\n                try { await AsyncStorage.setItem('completed_controls', JSON.stringify(remaining)); } catch(e) {}\r\n              }\r\n            }\r\n          }\r\n        } catch(e) {}\r\n        try {\r\n          // Sync draft controls\r\n          const rawDrafts = await AsyncStorage.getItem('draft_controls');\r\n          if (rawDrafts) {\r\n            let draftArr = JSON.parse(rawDrafts) || [];\r\n            if (Array.isArray(draftArr) && draftArr.length > 0) {\r\n              const remainingDrafts = [];\r\n              for (const d of draftArr) {\r\n                try {\r\n                  const res = await saveDraftToFirestore(d);\r\n                  if (!res) remainingDrafts.push(d);\r\n                } catch(e) {\r\n                  remainingDrafts.push(d);\r\n                }\r\n              }\r\n              if (remainingDrafts.length === 0) {\r\n                try { await AsyncStorage.removeItem('draft_controls'); } catch(e) {}\r\n              } else {\r\n                try { await AsyncStorage.setItem('draft_controls', JSON.stringify(remainingDrafts)); } catch(e) {}\r\n              }\r\n            }\r\n          }\r\n        } catch(e) {}\r\n      } catch(e) {\r\n        setStatus('error');\r\n        if (onStatus) onStatus('error');\r\n      }\r\n    });\r\n\r\n    return () => {\r\n      mounted = false;\r\n      unsubscribe();\r\n      if (backoffTimer.current) clearTimeout(backoffTimer.current);\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [companyId]);\r\n\r\n  return { status };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\add-user.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":84,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":138,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'_err' is not defined.","line":139,"column":31,"nodeType":"Identifier","messageId":"undef","endLine":139,"endColumn":35}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n/*\r\n  scripts/add-user.js\r\n\r\n  Skapar eller hämtar en Firebase Auth-användare, sätter custom claims och skriver users/{uid}.\r\n\r\n  Usage:\r\n    node scripts/add-user.js --serviceAccount=./konton/demo-service.json --email=user@company.com --company=my-company --role=user --admin=false --password=Secret123!\r\n\r\n  Notes:\r\n    - Om --password utelämnas skapas ett slumpat lösenord och skrivs ut.\r\n    - Sätter claims: { companyId, admin }\r\n*/\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst admin = require('firebase-admin');\r\n\r\nfunction parseArgs() {\r\n  const args = {};\r\n  process.argv.slice(2).forEach(a => {\r\n    const m = a.match(/^--([^=]+)=(.*)$/);\r\n    if (m) args[m[1]] = m[2];\r\n  });\r\n  return args;\r\n}\r\n\r\nfunction toBool(value, fallback) {\r\n  if (value === undefined || value === null || value === '') return fallback;\r\n  const v = String(value).trim().toLowerCase();\r\n  if (['true', '1', 'yes', 'y'].includes(v)) return true;\r\n  if (['false', '0', 'no', 'n'].includes(v)) return false;\r\n  return fallback;\r\n}\r\n\r\nfunction randomPassword() {\r\n  // enkel, men tillräcklig för onboarding (kan bytas av användaren)\r\n  const base = Math.random().toString(36).slice(-10);\r\n  return `${base}A!`;\r\n}\r\n\r\nasync function main() {\r\n  const args = parseArgs();\r\n\r\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\r\n  if (!serviceAccount) {\r\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\r\n    process.exit(1);\r\n  }\r\n\r\n  const email = args.email;\r\n  const company = args.company;\r\n  if (!email || !company) {\r\n    console.error('Usage: node scripts/add-user.js --serviceAccount=./konton/XXX.json --email=user@company.com --company=my-company --role=user --admin=false [--password=Secret123!]');\r\n    process.exit(1);\r\n  }\r\n\r\n  const role = (args.role || 'user').trim();\r\n  const isAdmin = toBool(args.admin, role === 'admin');\r\n  const password = (args.password && String(args.password).trim()) || randomPassword();\r\n  const firstName = (args.firstName || args.firstname || '').trim();\r\n  const lastName = (args.lastName || args.lastname || '').trim();\r\n  const displayNameArg = (args.displayName || args.displayname || '').trim();\r\n  const desiredDisplayName = displayNameArg || [firstName, lastName].filter(Boolean).join(' ').trim();\r\n\r\n  const saPath = path.resolve(serviceAccount);\r\n  if (!fs.existsSync(saPath)) {\r\n    console.error('Service account file not found:', saPath);\r\n    process.exit(1);\r\n  }\r\n\r\n  const sa = require(saPath);\r\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\r\n\r\n  const auth = admin.auth();\r\n  const db = admin.firestore();\r\n\r\n  try {\r\n    // Create or get user\r\n    let userRecord;\r\n    try {\r\n      userRecord = await auth.getUserByEmail(email);\r\n      console.log('User already exists:', userRecord.uid);\r\n    } catch(e) {\r\n      userRecord = await auth.createUser({\r\n        email,\r\n        password,\r\n        emailVerified: true,\r\n        displayName: desiredDisplayName || email.split('@')[0]\r\n      });\r\n      console.log('Created user:', userRecord.uid);\r\n      console.log('Password (new user):', password);\r\n    }\r\n\r\n    // Best-effort: update displayName if we have a better one\r\n    if (desiredDisplayName && desiredDisplayName !== userRecord.displayName) {\r\n      try {\r\n        await auth.updateUser(userRecord.uid, { displayName: desiredDisplayName });\r\n        userRecord = await auth.getUser(userRecord.uid);\r\n        console.log('Updated displayName:', userRecord.displayName);\r\n      } catch(e) {\r\n        console.warn('Could not update displayName:', e?.message || e);\r\n      }\r\n    }\r\n\r\n    const effectiveRole = isAdmin ? 'admin' : role;\r\n    const claims = { companyId: company, admin: isAdmin, role: effectiveRole };\r\n    await auth.setCustomUserClaims(userRecord.uid, claims);\r\n    console.log('Set custom claims:', claims);\r\n\r\n    await db.collection('users').doc(userRecord.uid).set({\r\n      companyId: company,\r\n      role: effectiveRole,\r\n      email,\r\n      displayName: userRecord.displayName || email.split('@')[0],\r\n      firstName: firstName || null,\r\n      lastName: lastName || null,\r\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      createdAt: admin.firestore.FieldValue.serverTimestamp()\r\n    }, { merge: true });\r\n\r\n    // Also write to company-scoped members directory for in-app dropdowns (ansvarig)\r\n    await db.collection('foretag').doc(company).collection('members').doc(userRecord.uid).set({\r\n      uid: userRecord.uid,\r\n      companyId: company,\r\n      role: effectiveRole,\r\n      email,\r\n      displayName: userRecord.displayName || email.split('@')[0],\r\n      firstName: firstName || null,\r\n      lastName: lastName || null,\r\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    }, { merge: true });\r\n\r\n    console.log('Wrote users/{uid} document');\r\n    console.log('Done.');\r\n    process.exit(0);\r\n  } catch(e) {\r\n      console.error('Error:', _err);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\create-demo-user.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":54,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n/*\r\n  scripts/create-demo-user.js\r\n  Usage:\r\n    node scripts/create-demo-user.js --serviceAccount=./konton/demo-service.json --email=demo@demo.local --password=Demo12345! --company=demo-company\r\n  Or set GOOGLE_APPLICATION_CREDENTIALS env var and omit --serviceAccount\r\n*/\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst admin = require('firebase-admin');\r\n\r\nfunction parseArgs() {\r\n  const args = {};\r\n  process.argv.slice(2).forEach(a => {\r\n    const m = a.match(/^--([^=]+)=(.*)$/);\r\n    if (m) args[m[1]] = m[2];\r\n  });\r\n  return args;\r\n}\r\n\r\nasync function main() {\r\n  const args = parseArgs();\r\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\r\n  if (!serviceAccount) {\r\n    console.error('Service account JSON path required via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\r\n    process.exit(1);\r\n  }\r\n\r\n  const saPath = path.resolve(serviceAccount);\r\n  if (!fs.existsSync(saPath)) {\r\n    console.error('Service account file not found:', saPath);\r\n    process.exit(1);\r\n  }\r\n\r\n  const sa = require(saPath);\r\n\r\n  admin.initializeApp({\r\n    credential: admin.credential.cert(sa)\r\n  });\r\n\r\n  const email = args.email || 'demo@demo.local';\r\n  const password = args.password || 'Demo12345!';\r\n  const company = args.company || 'demo-company';\r\n\r\n  const auth = admin.auth();\r\n  const db = admin.firestore();\r\n\r\n  // Create or get user\r\n  let userRecord;\r\n  try {\r\n    try {\r\n      userRecord = await auth.getUserByEmail(email);\r\n      console.log('User already exists:', userRecord.uid);\r\n    } catch(e) {\r\n      userRecord = await auth.createUser({ email, password, emailVerified: true, displayName: 'Demo Admin' });\r\n      console.log('Created user:', userRecord.uid);\r\n    }\r\n\r\n    // Set custom claims\r\n    const claims = { admin: true, role: 'admin', companyId: company };\r\n    await auth.setCustomUserClaims(userRecord.uid, claims);\r\n    console.log('Set custom claims:', claims);\r\n\r\n    // Create users/{uid} doc\r\n    const userDocRef = db.collection('users').doc(userRecord.uid);\r\n    await userDocRef.set({\r\n      companyId: company,\r\n      role: 'admin',\r\n      displayName: userRecord.displayName || 'Demo Admin',\r\n      email: userRecord.email,\r\n      createdAt: admin.firestore.FieldValue.serverTimestamp()\r\n    }, { merge: true });\r\n    console.log('Wrote users/{uid} document');\r\n\r\n    // Seed basic company structure and a template (if not exists)\r\n    const companyRef = db.collection('foretag').doc(company);\r\n    const companySnap = await companyRef.get();\r\n    if (!companySnap.exists) {\r\n      await companyRef.set({ name: 'Demo Company', createdAt: admin.firestore.FieldValue.serverTimestamp() });\r\n      console.log('Created foretag/{company}');\r\n    }\r\n\r\n    // Seed company members directory\r\n    await companyRef.collection('members').doc(userRecord.uid).set({\r\n      uid: userRecord.uid,\r\n      companyId: company,\r\n      role: 'admin',\r\n      displayName: userRecord.displayName || 'Demo Admin',\r\n      email: userRecord.email,\r\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    }, { merge: true });\r\n\r\n    // Seed a simple mall-template collection\r\n    const templatesRef = companyRef.collection('mallar');\r\n    const templatesSnap = await templatesRef.limit(1).get();\r\n    if (templatesSnap.empty) {\r\n      await templatesRef.add({ title: 'Tom mall', description: 'Bas-mall att kopiera vid onboarding', createdAt: admin.firestore.FieldValue.serverTimestamp(), items: [] });\r\n      console.log('Added a mall-template');\r\n    }\r\n\r\n    // Seed demo hierarchy\r\n    const hierRef = companyRef.collection('hierarki').doc('state');\r\n    const hierSnap = await hierRef.get();\r\n    if (!hierSnap.exists) {\r\n      const demoHierarchy = [\r\n        { id: 'main1', name: 'Demo Projekt', expanded: false, children: [ { id: 'P-0001', name: 'Demo Projekt 1', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() } ] }\r\n      ];\r\n      await hierRef.set({ items: demoHierarchy, createdAt: admin.firestore.FieldValue.serverTimestamp() });\r\n      console.log('Seeded demo hierarchy for company');\r\n    }\r\n\r\n    console.log('Done. Demo user ready.');\r\n    process.exit(0);\r\n  } catch (err) {\r\n    console.error('Error:', err);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\eslint_fix_unused_e.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\fix_underscore_catch_tracked.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\import-companies-users.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":204,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":204,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":219,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":219,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n/*\r\n  scripts/import-companies-users.js\r\n\r\n  Importerar flera företag + användare (admin/user) från en CSV (export från Excel).\r\n\r\n  Varför:\r\n    - Återanvändbar onboarding utan att klicka i Firestore manuellt\r\n    - Sätter Auth claims + skriver users/{uid} + foretag/{companyId}/members/{uid}\r\n    - Skapar grundstruktur för företaget (foretag-doc + minst en mall) om den saknas\r\n\r\n  Usage:\r\n    node scripts/import-companies-users.js --serviceAccount=./konton/demo-service.json --file=./data/import.csv\r\n\r\n  Valfritt:\r\n    --delimiter=;           (Excel i Sverige använder ofta semikolon)\r\n    --dryRun=true           (skriver inget, loggar bara)\r\n\r\n  CSV format (rekommenderat med header):\r\n    companyId;companyName;email;firstName;lastName;role;admin;password;logoUrl;enabledControlTypes\r\n\r\n  Exempelrad:\r\n    ms-bygg;MS Byggsystem;anna@msbygg.se;Anna;Andersson;admin;true;BytMig123!;https://...;Arbetsberedning,Egenkontroll\r\n\r\n  Notes:\r\n    - logoUrl är valfritt; bäst är att du själv lägger in den vid behov.\r\n    - enabledControlTypes skrivs till foretag/{companyId}/profil/public.enabledControlTypes (valfritt)\r\n*/\r\n\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst admin = require('firebase-admin');\r\n\r\nfunction parseArgs() {\r\n  const args = {};\r\n  process.argv.slice(2).forEach(a => {\r\n    const m = a.match(/^--([^=]+)=(.*)$/);\r\n    if (m) args[m[1]] = m[2];\r\n  });\r\n  return args;\r\n}\r\n\r\nfunction toBool(value, fallback) {\r\n  if (value === undefined || value === null || value === '') return fallback;\r\n  const v = String(value).trim().toLowerCase();\r\n  if (['true', '1', 'yes', 'y', 'ja'].includes(v)) return true;\r\n  if (['false', '0', 'no', 'n', 'nej'].includes(v)) return false;\r\n  return fallback;\r\n}\r\n\r\nfunction randomPassword() {\r\n  const base = Math.random().toString(36).slice(-10);\r\n  return `${base}A!`;\r\n}\r\n\r\nfunction splitEnabledTypes(raw) {\r\n  const s = (raw ?? '').trim();\r\n  if (!s) return null;\r\n  return s.split(',').map(x => x.trim()).filter(Boolean);\r\n}\r\n\r\nfunction guessDelimiter(firstLine) {\r\n  const semi = (firstLine.match(/;/g) || []).length;\r\n  const comma = (firstLine.match(/,/g) || []).length;\r\n  return semi > comma ? ';' : ',';\r\n}\r\n\r\nfunction parseCsv(text, delimiter) {\r\n  // Minimal CSV parser (supports quotes)\r\n  const rows = [];\r\n  let row = [];\r\n  let cur = '';\r\n  let inQuotes = false;\r\n\r\n  for (let i = 0; i < text.length; i++) {\r\n    const ch = text[i];\r\n\r\n    if (inQuotes) {\r\n      if (ch === '\"') {\r\n        const next = text[i + 1];\r\n        if (next === '\"') {\r\n          cur += '\"';\r\n          i++;\r\n        } else {\r\n          inQuotes = false;\r\n        }\r\n      } else {\r\n        cur += ch;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (ch === '\"') {\r\n      inQuotes = true;\r\n      continue;\r\n    }\r\n\r\n    if (ch === delimiter) {\r\n      row.push(cur);\r\n      cur = '';\r\n      continue;\r\n    }\r\n\r\n    if (ch === '\\n') {\r\n      row.push(cur);\r\n      cur = '';\r\n      // skip empty/comment-only lines\r\n      const joined = row.join('').trim();\r\n      if (joined && !joined.startsWith('#')) rows.push(row);\r\n      row = [];\r\n      continue;\r\n    }\r\n\r\n    if (ch === '\\r') continue;\r\n\r\n    cur += ch;\r\n  }\r\n\r\n  if (cur.length || row.length) {\r\n    row.push(cur);\r\n    const joined = row.join('').trim();\r\n    if (joined && !joined.startsWith('#')) rows.push(row);\r\n  }\r\n\r\n  return rows;\r\n}\r\n\r\nfunction normalizeHeaderKey(k) {\r\n  return String(k || '')\r\n    .trim()\r\n    .toLowerCase()\r\n    .replace(/\\s+/g, '')\r\n    .replace(/[_-]/g, '');\r\n}\r\n\r\nfunction getCell(row, idx) {\r\n  const v = row[idx];\r\n  return v === undefined || v === null ? '' : String(v).trim();\r\n}\r\n\r\nasync function ensureCompanyBase(db, companyId, companyName, dryRun) {\r\n  const companyRef = db.collection('foretag').doc(companyId);\r\n  if (!dryRun) {\r\n    await companyRef.set(\r\n      {\r\n        name: companyName || companyId,\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      },\r\n      { merge: true }\r\n    );\r\n  }\r\n\r\n  // Ensure at least one template exists\r\n  const templatesRef = companyRef.collection('mallar');\r\n  if (!dryRun) {\r\n    const snap = await templatesRef.limit(1).get();\r\n    if (snap.empty) {\r\n      await templatesRef.add({\r\n        title: 'Tom mall',\r\n        description: 'Bas-mall att kopiera vid onboarding',\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        items: [],\r\n      });\r\n    }\r\n  }\r\n\r\n  return companyRef;\r\n}\r\n\r\nasync function upsertCompanyProfile(db, companyId, patch, dryRun) {\r\n  if (!patch || Object.keys(patch).length === 0) return;\r\n  const ref = db.doc(`foretag/${companyId}/profil/public`);\r\n  if (dryRun) return;\r\n  await ref.set(\r\n    {\r\n      ...patch,\r\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n    },\r\n    { merge: true }\r\n  );\r\n}\r\n\r\nasync function upsertUserAndMembership({ auth, db, companyId, companyName, rowData, dryRun, createdPasswords }) {\r\n  const email = (rowData.email || '').trim();\r\n  if (!email) return;\r\n\r\n  const firstName = (rowData.firstName || '').trim();\r\n  const lastName = (rowData.lastName || '').trim();\r\n  const displayName = (rowData.displayName || '').trim() || [firstName, lastName].filter(Boolean).join(' ').trim();\r\n\r\n  const roleRaw = (rowData.role || 'user').trim().toLowerCase();\r\n  const isAdmin = toBool(rowData.admin, roleRaw === 'admin');\r\n  const effectiveRole = isAdmin ? 'admin' : (roleRaw || 'user');\r\n\r\n  const password = (rowData.password || '').trim() || randomPassword();\r\n\r\n  let userRecord;\r\n  let created = false;\r\n\r\n  if (!dryRun) {\r\n    try {\r\n      userRecord = await auth.getUserByEmail(email);\r\n    } catch(e) {\r\n      userRecord = await auth.createUser({\r\n        email,\r\n        password,\r\n        emailVerified: true,\r\n        displayName: displayName || email.split('@')[0],\r\n      });\r\n      created = true;\r\n      createdPasswords.push({ email, password, companyId });\r\n    }\r\n\r\n    if (displayName && displayName !== userRecord.displayName) {\r\n      try {\r\n        await auth.updateUser(userRecord.uid, { displayName });\r\n        userRecord = await auth.getUser(userRecord.uid);\r\n      } catch(e) {\r\n        // ignore\r\n      }\r\n    }\r\n\r\n    const claims = { companyId, admin: isAdmin, role: effectiveRole };\r\n    await auth.setCustomUserClaims(userRecord.uid, claims);\r\n\r\n    await db.collection('users').doc(userRecord.uid).set(\r\n      {\r\n        companyId,\r\n        role: effectiveRole,\r\n        email,\r\n        displayName: userRecord.displayName || displayName || email.split('@')[0],\r\n        firstName: firstName || null,\r\n        lastName: lastName || null,\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      },\r\n      { merge: true }\r\n    );\r\n\r\n    await db.collection('foretag').doc(companyId).collection('members').doc(userRecord.uid).set(\r\n      {\r\n        uid: userRecord.uid,\r\n        companyId,\r\n        role: effectiveRole,\r\n        email,\r\n        displayName: userRecord.displayName || displayName || email.split('@')[0],\r\n        firstName: firstName || null,\r\n        lastName: lastName || null,\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      },\r\n      { merge: true }\r\n    );\r\n  }\r\n\r\n  const action = dryRun ? '[dryRun]' : created ? '[created]' : '[updated]';\r\n  console.log(\r\n    '%s user=%s role=%s company=%s (%s)',\r\n    action,\r\n    email,\r\n    effectiveRole,\r\n    companyId,\r\n    companyName || companyId\r\n  );\r\n}\r\n\r\nasync function main() {\r\n  const args = parseArgs();\r\n\r\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\r\n  if (!serviceAccount) {\r\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\r\n    process.exit(1);\r\n  }\r\n\r\n  const file = args.file || args.path;\r\n  if (!file) {\r\n    console.error('Usage: node scripts/import-companies-users.js --serviceAccount=./konton/XXX.json --file=./data/import.csv [--delimiter=;] [--dryRun=true]');\r\n    process.exit(1);\r\n  }\r\n\r\n  const dryRun = toBool(args.dryRun, false);\r\n\r\n  const saPath = path.resolve(serviceAccount);\r\n  if (!fs.existsSync(saPath)) {\r\n    console.error('Service account file not found:', saPath);\r\n    process.exit(1);\r\n  }\r\n\r\n  const filePath = path.resolve(file);\r\n  if (!fs.existsSync(filePath)) {\r\n    console.error('CSV file not found:', filePath);\r\n    process.exit(1);\r\n  }\r\n\r\n  const sa = require(saPath);\r\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\r\n\r\n  const db = admin.firestore();\r\n  const auth = admin.auth();\r\n\r\n  const raw = fs.readFileSync(filePath, 'utf8');\r\n  const firstLine = raw.split(/\\r?\\n/).find(l => String(l).trim().length > 0) || '';\r\n  const delimiter = (args.delimiter || '').trim() || guessDelimiter(firstLine);\r\n\r\n  const rows = parseCsv(raw, delimiter);\r\n  if (rows.length === 0) {\r\n    console.error('No rows found in file');\r\n    process.exit(1);\r\n  }\r\n\r\n  // Header\r\n  const header = rows[0].map(normalizeHeaderKey);\r\n  const hasHeader = header.includes('companyid') && header.includes('email');\r\n\r\n  const startIdx = hasHeader ? 1 : 0;\r\n  const createdPasswords = [];\r\n\r\n  const colIndex = (key) => {\r\n    const k = normalizeHeaderKey(key);\r\n    return header.indexOf(k);\r\n  };\r\n\r\n  const idx = hasHeader\r\n    ? {\r\n        companyId: colIndex('companyId'),\r\n        companyName: colIndex('companyName'),\r\n        email: colIndex('email'),\r\n        firstName: colIndex('firstName'),\r\n        lastName: colIndex('lastName'),\r\n        displayName: colIndex('displayName'),\r\n        role: colIndex('role'),\r\n        admin: colIndex('admin'),\r\n        password: colIndex('password'),\r\n        logoUrl: colIndex('logoUrl'),\r\n        enabledControlTypes: colIndex('enabledControlTypes'),\r\n      }\r\n    : {\r\n        // Fallback (utan header):\r\n        // 0 companyId, 1 companyName, 2 email, 3 firstName, 4 lastName, 5 role, 6 admin, 7 password\r\n        companyId: 0,\r\n        companyName: 1,\r\n        email: 2,\r\n        firstName: 3,\r\n        lastName: 4,\r\n        role: 5,\r\n        admin: 6,\r\n        password: 7,\r\n        displayName: -1,\r\n        logoUrl: -1,\r\n        enabledControlTypes: -1,\r\n      };\r\n\r\n  const seenCompanies = new Set();\r\n\r\n  for (let r = startIdx; r < rows.length; r++) {\r\n    const row = rows[r];\r\n\r\n    const companyId = getCell(row, idx.companyId);\r\n    if (!companyId) continue;\r\n\r\n    const companyName = idx.companyName >= 0 ? getCell(row, idx.companyName) : '';\r\n\r\n    if (!seenCompanies.has(companyId)) {\r\n      seenCompanies.add(companyId);\r\n      console.log('%s company=%s name=%s', dryRun ? '[dryRun]' : '[upsert]', companyId, companyName || companyId);\r\n\r\n      await ensureCompanyBase(db, companyId, companyName || companyId, dryRun);\r\n\r\n      const profilePatch = {};\r\n      // name i profil/public används för PDF-branding\r\n      profilePatch.name = companyName || companyId;\r\n\r\n      const logoUrl = idx.logoUrl >= 0 ? getCell(row, idx.logoUrl) : '';\r\n      if (logoUrl) profilePatch.logoUrl = logoUrl;\r\n\r\n      const enabledRaw = idx.enabledControlTypes >= 0 ? getCell(row, idx.enabledControlTypes) : '';\r\n      const enabled = splitEnabledTypes(enabledRaw);\r\n      if (enabled) profilePatch.enabledControlTypes = enabled;\r\n\r\n      await upsertCompanyProfile(db, companyId, profilePatch, dryRun);\r\n    }\r\n\r\n    const rowData = {\r\n      email: getCell(row, idx.email),\r\n      firstName: idx.firstName >= 0 ? getCell(row, idx.firstName) : '',\r\n      lastName: idx.lastName >= 0 ? getCell(row, idx.lastName) : '',\r\n      displayName: idx.displayName >= 0 ? getCell(row, idx.displayName) : '',\r\n      role: idx.role >= 0 ? getCell(row, idx.role) : 'user',\r\n      admin: idx.admin >= 0 ? getCell(row, idx.admin) : '',\r\n      password: idx.password >= 0 ? getCell(row, idx.password) : '',\r\n    };\r\n\r\n    await upsertUserAndMembership({ auth, db, companyId, companyName, rowData, dryRun, createdPasswords });\r\n  }\r\n\r\n  if (createdPasswords.length) {\r\n    console.log('\\nCreated users/passwords (save these somewhere safe):');\r\n    createdPasswords.forEach(x => console.log(`- ${x.email} (company=${x.companyId}) password=${x.password}`));\r\n  }\r\n\r\n  console.log('\\nDone.');\r\n  process.exit(0);\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error('Fatal error:', err);\r\n  process.exit(1);\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\list-foretag.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\provision-company.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":55,"column":124,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":125}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\n/*\r\n  scripts/provision-company.js\r\n  Usage:\r\n    node scripts/provision-company.js --serviceAccount=./konton/demo-service.json --company=my-company --adminEmail=owner@company.com --adminPassword=Secret123!\r\n*/\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst admin = require('firebase-admin');\r\n\r\nfunction parseArgs() {\r\n  const args = {};\r\n  process.argv.slice(2).forEach(a => {\r\n    const m = a.match(/^--([^=]+)=(.*)$/);\r\n    if (m) args[m[1]] = m[2];\r\n  });\r\n  return args;\r\n}\r\n\r\nasync function main() {\r\n  const args = parseArgs();\r\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\r\n  if (!serviceAccount) {\r\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\r\n    process.exit(1);\r\n  }\r\n  const saPath = path.resolve(serviceAccount);\r\n  if (!fs.existsSync(saPath)) { console.error('Service account file not found:', saPath); process.exit(1); }\r\n  const sa = require(saPath);\r\n\r\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\r\n  const db = admin.firestore();\r\n  const auth = admin.auth();\r\n\r\n  const company = args.company;\r\n  if (!company) { console.error('--company is required'); process.exit(1); }\r\n\r\n  const adminEmail = args.adminEmail;\r\n  const adminPassword = args.adminPassword || Math.random().toString(36).slice(-8);\r\n\r\n  try {\r\n    // create company doc\r\n    const companyRef = db.collection('foretag').doc(company);\r\n    await companyRef.set({ name: company, createdAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\r\n    console.log('Created or updated company doc:', company);\r\n\r\n    // create default templates\r\n    const templatesRef = companyRef.collection('mallar');\r\n    await templatesRef.add({ title: 'Tom mall', description: 'Bas-mall att kopiera vid onboarding', createdAt: admin.firestore.FieldValue.serverTimestamp(), items: [] });\r\n    console.log('Added default template');\r\n\r\n    // create admin user if email provided\r\n    if (adminEmail) {\r\n      let userRecord;\r\n      try { userRecord = await auth.getUserByEmail(adminEmail); console.log('Admin user exists:', userRecord.uid); } catch(e) {\r\n        userRecord = await auth.createUser({ email: adminEmail, password: adminPassword, displayName: adminEmail.split('@')[0] });\r\n        console.log('Created admin user:', userRecord.uid);\r\n      }\r\n      await auth.setCustomUserClaims(userRecord.uid, { admin: true, role: 'admin', companyId: company });\r\n      await db.collection('users').doc(userRecord.uid).set({ companyId: company, role: 'admin', email: adminEmail, createdAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\r\n      // Also write to company-scoped members directory for in-app dropdowns (ansvarig)\r\n      await companyRef.collection('members').doc(userRecord.uid).set({\r\n        uid: userRecord.uid,\r\n        companyId: company,\r\n        role: 'admin',\r\n        email: adminEmail,\r\n        displayName: userRecord.displayName || adminEmail.split('@')[0],\r\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\r\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\r\n      }, { merge: true });\r\n      console.log('Provisioned admin user and claims. Password (if created):', adminPassword);\r\n    }\r\n\r\n    console.log('Provisioning complete.');\r\n    process.exit(0);\r\n  } catch (err) {\r\n    console.error('Error provisioning:', err);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\read-hierarchy.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":41,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":42,"column":47,"nodeType":"Identifier","messageId":"undef","endLine":42,"endColumn":49}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\r\nconst admin = require('firebase-admin');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\n\r\nfunction parseArgs() {\r\n  const args = {};\r\n  process.argv.slice(2).forEach(a => {\r\n    const m = a.match(/^--([^=]+)=(.*)$/);\r\n    if (m) args[m[1]] = m[2];\r\n  });\r\n  return args;\r\n}\r\n\r\nasync function main() {\r\n  const args = parseArgs();\r\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS || './konton/demo-service.json';\r\n  const company = args.company;\r\n  if (!company) {\r\n    console.error('--company is required');\r\n    process.exit(1);\r\n  }\r\n  const saPath = path.resolve(serviceAccount);\r\n  if (!fs.existsSync(saPath)) {\r\n    console.error('Service account not found:', saPath);\r\n    process.exit(1);\r\n  }\r\n  const sa = require(saPath);\r\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\r\n  const db = admin.firestore();\r\n  try {\r\n    const ref = db.collection('foretag').doc(company).collection('hierarki').doc('state');\r\n    const snap = await ref.get();\r\n    if (!snap.exists) {\r\n      console.log('No hierarchy document for company:', company);\r\n      process.exit(0);\r\n    }\r\n    const data = snap.data();\r\n    console.log('Hierarchy for', company, JSON.stringify(data.items, null, 2));\r\n    process.exit(0);\r\n  } catch(e) {\r\n    console.error('Error reading hierarchy:', _e);\r\n    process.exit(1);\r\n  }\r\n}\r\n\r\nmain();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\replace-catch.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\replace_catch_tracked.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\replace_catch_tracked_safe.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'path' is assigned a value but never used.","line":2,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":11,"suggestions":[{"messageId":"removeVar","data":{"varName":"path"},"fix":{"range":[27,56],"text":""},"desc":"Remove unused variable 'path'."}]},{"ruleId":"no-undef","severity":2,"message":"'Buffer' is not defined.","line":30,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":30,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst path = require('path');\r\nconst cp = require('child_process');\r\nfunction unquoteGitPath(s){\r\n  if(!s) return s;\r\n  if(s[0]==='\"' && s[s.length-1]==='\"'){\r\n    s = s.slice(1,-1);\r\n  }\r\n  // replace octal escapes like \\303\\244 with bytes\r\n  const parts = s.split('\\\\');\r\n  if(parts.length===1) return s;\r\n  let bytes = [];\r\n  for(let i=0;i<parts.length;i++){\r\n    if(i===0){\r\n      // leading part\r\n      for(const ch of parts[0]) bytes.push(ch.charCodeAt(0));\r\n    } else {\r\n      const oct = parts[i].slice(0,3);\r\n      if(/^[0-7]{3}$/.test(oct)){\r\n        bytes.push(parseInt(oct,8));\r\n        const rest = parts[i].slice(3);\r\n        for(const ch of rest) bytes.push(ch.charCodeAt(0));\r\n      } else {\r\n        // not an octal escape, put back the backslash and part\r\n        bytes.push(92); // '\\'\r\n        for(const ch of parts[i]) bytes.push(ch.charCodeAt(0));\r\n      }\r\n    }\r\n  }\r\n  return Buffer.from(bytes).toString('utf8');\r\n}\r\ntry{\r\n  const files = cp.execSync('git ls-files \"*.js\" \"*.jsx\" \"*.ts\" \"*.tsx\"',{encoding:'utf8'})\r\n    .split(/\\r?\\n/).filter(Boolean);\r\n  files.forEach(f0=>{\r\n    const f = unquoteGitPath(f0);\r\n    try{\r\n      const s = fs.readFileSync(f,'utf8');\r\n      const ns = s.replace(/catch\\(\\s*\\(\\)\\s*=>/g,'catch((e) =>');\r\n      if(ns!==s){ fs.writeFileSync(f,ns,'utf8'); console.log('Updated',f); }\r\n    }catch(err){ console.error('ERR',f,err.message); }\r\n  });\r\n}catch(err){ console.error('fatal',err.message); process.exit(1); }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\replace_underscore_more.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\replace_underscore_paren.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\reset-project.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\revert_unused_e_catches.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'edits' is assigned a value but never used.","line":25,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"edits"},"fix":{"range":[772,789],"text":""},"desc":"Remove unused variable 'edits'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\r\nconst cp = require('child_process');\r\nfunction listFiles(){\r\n  return cp.execSync('git ls-files \"*.js\" \"*.jsx\" \"*.ts\" \"*.tsx\"',{encoding:'utf8'})\r\n    .split(/\\r?\\n/).filter(Boolean).map(s=> (s[0]==='\"' && s[s.length-1]==='\"')?s.slice(1,-1):s);\r\n}\r\nfunction findMatchingBrace(src, start){\r\n  // start points at index of '{'\r\n  let depth = 0;\r\n  for(let i=start;i<src.length;i++){\r\n    if(src[i]==='{') depth++;\r\n    else if(src[i]==='}'){\r\n      depth--;\r\n      if(depth===0) return i;\r\n    }\r\n  }\r\n  return -1;\r\n}\r\nfunction processFile(path){\r\n  let s = fs.readFileSync(path,'utf8');\r\n  let changed = false;\r\n  // regex to find catch with e param (various forms)\r\n  const re = /catch\\s*\\(\\s*(?:\\(?\\s*e\\s*\\)?)([^)]*)\\)\\s*(?:=>)?/g;\r\n  let m;\r\n  const edits = [];\r\n  while((m=re.exec(s))!==null){\r\n    const idx = m.index;\r\n    const after = re.lastIndex;\r\n    // determine body start\r\n    let bodyStart = after;\r\n    // skip spaces\r\n    while(bodyStart < s.length && /[\\s]/.test(s[bodyStart])) bodyStart++;\r\n    if(s[bodyStart]==='='){\r\n      // arrow function '=>' case, move past =>\r\n      if(s.substr(bodyStart,2)==='=>' ){\r\n        bodyStart += 2;\r\n        while(bodyStart < s.length && /[\\s]/.test(s[bodyStart])) bodyStart++;\r\n      }\r\n    }\r\n    if(s[bodyStart]==='{'){\r\n      const end = findMatchingBrace(s, bodyStart);\r\n      if(end===-1) continue;\r\n      const body = s.slice(bodyStart, end+1);\r\n      if(!/\\b e\\b|\\be\\.|\\be\\?\\.|\\be\\(/.test(body) && !/\\be\\s*[^=]/.test(body)){\r\n        // e not used in body -> replace param 'e' with '_e'\r\n        // replace only the first 'e' after 'catch('\r\n        const before = s.slice(0, idx);\r\n        const segment = s.slice(idx, after);\r\n        const newSegment = segment.replace(/\\bcatch\\s*\\(\\s*\\(?\\s*e\\s*\\)?/,'catch(_e');\r\n        s = before + newSegment + s.slice(after);\r\n        changed = true;\r\n        // move regex pointer forward to avoid infinite loop\r\n        re.lastIndex = idx + newSegment.length + (s.length - (after));\r\n      }\r\n    } else {\r\n      // expression body, check until semicolon or newline\r\n      const endPos = s.indexOf('\\n', bodyStart) === -1 ? s.length : s.indexOf('\\n', bodyStart);\r\n      const body = s.slice(bodyStart, endPos);\r\n      if(!/\\be\\b|\\be\\.|\\be\\?\\./.test(body)){\r\n        const before = s.slice(0, idx);\r\n        const segment = s.slice(idx, after);\r\n        const newSegment = segment.replace(/\\bcatch\\s*\\(\\s*\\(?\\s*e\\s*\\)?/,'catch(_e');\r\n        s = before + newSegment + s.slice(after);\r\n        changed = true;\r\n        re.lastIndex = idx + newSegment.length;\r\n      }\r\n    }\r\n  }\r\n  if(changed){ fs.writeFileSync(path, s, 'utf8'); console.log('Patched', path); }\r\n}\r\ntry{\r\n  const files = listFiles();\r\n  files.forEach(processFile);\r\n  console.log('Done');\r\n}catch(err){ console.error(err.message); process.exit(1); }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\seed-hierarchy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\seed-testdata.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\set-company-claim.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\MS Byggsystem\\DigitalKontroll\\scripts\\set-enabled-control-types.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]