[{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/AdminAuditLog.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'loggingOut' is assigned a value but never used.","line":15,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"loggingOut"},"fix":{"range":[885,895],"text":""},"desc":"Remove unused variable 'loggingOut'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'navigation'. Either include it or remove the dependency array.","line":38,"column":6,"nodeType":"ArrayExpression","endLine":38,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [navigation]","fix":{"range":[1649,1651],"text":"[navigation]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":187,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":187,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useEffect, useState } from 'react';\nimport { ImageBackground, Platform, ScrollView, Text, TouchableOpacity, View } from 'react-native';\nimport { auth, fetchAdminAuditEvents } from '../components/firebase';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo } from '../components/HeaderComponents';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenuConditional from '../components/HeaderUserMenuConditional';\nimport MainLayout from '../components/MainLayout';\n\nexport default function AdminAuditLog({ navigation }) {\n  const [allowedTools, setAllowedTools] = useState(false);\n  const [showHeaderUserMenu, setShowHeaderUserMenu] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  const [loggingOut, setLoggingOut] = useState(false);\n  const [events, setEvents] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [filterCompanyId, setFilterCompanyId] = useState(null);\n\n  useEffect(() => {\n    // Align header with ManageCompany\n    try {\n      navigation.setOptions({\n        headerTitle: () => null,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } catch (_e) {}\n  }, []);\n\n  // Only superadmin / MS Byggsystem-admin should see this screen (same gating as ManageCompany)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    let mounted = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        if (email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se') {\n          if (mounted) {\n            setAllowedTools(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(false).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const isAdminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const cid = companyFromClaims || stored || '';\n        if (cid === 'MS Byggsystem' && isAdminClaim) {\n          if (mounted) {\n            setAllowedTools(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n      } catch(_e) {}\n      if (mounted) {\n        setAllowedTools(false);\n        setShowHeaderUserMenu(false);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  // Lyssna på global \"hem\"-händelse från ProjectSidebar (webb)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = () => {\n      try {\n        navigation.reset({ index: 0, routes: [{ name: 'Home' }] });\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkGoHome', handler);\n    return () => {\n      try { window.removeEventListener('dkGoHome', handler); } catch (_e) {}\n    };\n  }, [navigation]);\n\n  // Fetch latest events (global or filtered by companyId)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    let cancelled = false;\n    (async () => {\n      try {\n        setLoading(true);\n        const items = await fetchAdminAuditEvents({ companyId: filterCompanyId || null, limitCount: 100 }).catch(() => []);\n        if (!cancelled) setEvents(Array.isArray(items) ? items : []);\n      } catch(_e) {\n        if (!cancelled) setEvents([]);\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    })();\n    return () => { cancelled = true; };\n  }, [filterCompanyId]);\n\n  // When a company is selected in the sidebar, use it as filter\n  const handleSelectCompany = (payload) => {\n    try {\n      if (payload?.createNew) {\n        setFilterCompanyId(null);\n        return;\n      }\n      const cid = String(payload?.companyId || payload?.id || '').trim();\n      if (!cid) {\n        setFilterCompanyId(null);\n        return;\n      }\n      setFilterCompanyId(cid);\n    } catch(_e) {}\n  };\n\n  const selectedFilter = String(filterCompanyId || '').trim();\n\n  if (Platform.OS === 'web') {\n    const RootContainer = ImageBackground;\n    const rootProps = {\n      source: require('../assets/images/inlogg.webb.png'),\n      resizeMode: 'cover',\n      imageStyle: { width: '100%', height: '100%' },\n    };\n\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\n\n    return (\n      <RootContainer {...rootProps} style={{ flex: 1, width: '100%', minHeight: '100vh' }}>\n        <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0, pointerEvents: 'none' }} />\n        <MainLayout\n          onSelectProject={handleSelectCompany}\n          sidebarTitle=\"Företag / filter\"\n          sidebarSearchPlaceholder=\"sök företag\"\n          sidebarCompaniesMode={true}\n          sidebarShowMembers={allowedTools}\n          topBar={\n            <View style={{ height: 96, paddingLeft: 24, paddingRight: 24, backgroundColor: '#fff', justifyContent: 'center' }}>\n              <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', marginLeft: 8 }}>\n                  <View style={{ marginRight: 10 }}>\n                    {showHeaderUserMenu ? <HeaderUserMenuConditional /> : <HeaderDisplayName />}\n                  </View>\n                  {allowedTools ? (\n                    <TouchableOpacity\n                      style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                      onPress={() => setSupportMenuOpen(s => !s)}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                    </TouchableOpacity>\n                  ) : null}\n                </View>\n                <View style={{ alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 6, paddingHorizontal: 12, alignItems: 'center', minWidth: 72 }}\n                    onPress={async () => {\n                      setLoggingOut(true);\n                      try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                      await auth.signOut();\n                      setLoggingOut(false);\n                      navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Logga ut</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          }\n        >\n          <View style={dashboardContainerStyle}>\n            <View style={[dashboardCardStyle, { marginBottom: 16 }] }>\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                <TouchableOpacity onPress={() => { try { navigation.goBack(); } catch(e){} }} style={{ padding: 8, marginRight: 8 }} accessibilityLabel=\"Tillbaka\">\n                  <Ionicons name=\"chevron-back\" size={20} color=\"#222\" />\n                </TouchableOpacity>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <View style={{ width: 24, height: 24, borderRadius: 6, backgroundColor: '#1565C0', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                    <Ionicons name=\"list\" size={14} color=\"#fff\" />\n                  </View>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>Adminlogg</Text>\n                </View>\n              </View>\n\n              <View style={{ marginBottom: 8 }}>\n                <Text style={{ fontSize: 13, color: '#555' }}>\n                  Visar senaste åtgärder i hela systemet. Välj ett företag i listan till vänster för att filtrera loggen.\n                </Text>\n              </View>\n\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                <Text style={{ fontSize: 13, color: '#333', marginRight: 8 }}>\n                  Filter:\n                </Text>\n                <Text style={{ fontSize: 13, fontWeight: '600', color: selectedFilter ? '#1565C0' : '#555' }}>\n                  {selectedFilter || 'Alla företag'}\n                </Text>\n                {selectedFilter ? (\n                  <TouchableOpacity\n                    style={{ marginLeft: 12, paddingHorizontal: 8, paddingVertical: 4, borderRadius: 999, backgroundColor: '#eee' }}\n                    onPress={() => setFilterCompanyId(null)}\n                  >\n                    <Text style={{ fontSize: 12, color: '#333' }}>Rensa filter</Text>\n                  </TouchableOpacity>\n                ) : null}\n              </View>\n\n              <View style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 8, maxHeight: 440, overflow: 'hidden', backgroundColor: '#fafafa' }}>\n                {loading ? (\n                  <Text style={{ fontSize: 13, color: '#666' }}>Laddar logg...</Text>\n                ) : (Array.isArray(events) && events.length > 0 ? (\n                  <ScrollView style={{ maxHeight: 420 }}>\n                    {events.map((ev) => {\n                      const ts = ev?.ts && ev.ts.toDate ? ev.ts.toDate() : null;\n                      const tsText = ts ? ts.toLocaleString('sv-SE') : '';\n                      const type = String(ev?.type || '').trim();\n                      let label = type;\n                      if (type === 'createUser') label = 'Skapa användare';\n                      else if (type === 'updateUser') label = 'Uppdatera användare';\n                      else if (type === 'deleteUser') label = 'Ta bort användare';\n                      else if (type === 'setCompanyUserLimit') label = 'Ändra antal användare (userLimit)';\n                      else if (type === 'setCompanyName') label = 'Ändra företagsnamn';\n                      else if (type === 'setCompanyStatus') label = 'Ändra status/dölj företag';\n                      else if (type === 'provisionCompany') label = 'Skapa företag';\n                      else if (type === 'purgeCompany') label = 'Permanent radering av företag';\n\n                      const companyLabel = String(ev?.companyId || '').trim();\n                      const actor = String(ev?.actorUid || '').trim();\n                      const target = String(ev?.targetUid || '').trim();\n\n                      return (\n                        <View key={ev.id} style={{ paddingVertical: 4, borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                          <Text style={{ fontSize: 13, fontWeight: '600', color: '#333' }}>{label}</Text>\n                          {companyLabel ? (\n                            <Text style={{ fontSize: 12, color: '#444' }}>Företag: {companyLabel}</Text>\n                          ) : null}\n                          {actor || target ? (\n                            <Text style={{ fontSize: 12, color: '#666' }}>\n                              {actor ? `Utförd av: ${actor}` : ''}\n                              {actor && target ? ' · ' : ''}\n                              {target ? `Mål: ${target}` : ''}\n                            </Text>\n                          ) : null}\n                          {tsText ? <Text style={{ fontSize: 12, color: '#777' }}>{tsText}</Text> : null}\n                        </View>\n                      );\n                    })}\n                  </ScrollView>\n                ) : (\n                  <Text style={{ fontSize: 13, color: '#666' }}>Inga loggposter hittades än.</Text>\n                ))}\n              </View>\n            </View>\n          </View>\n        </MainLayout>\n      </RootContainer>\n    );\n  }\n\n  // Native/mobile fallback: simple list\n  return (\n    <ScrollView style={{ flex: 1, padding: 16 }}>\n      <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 8 }}>Adminlogg</Text>\n      <Text style={{ fontSize: 14, color: '#555', marginBottom: 12 }}>\n        Den här vyn är optimerad för webb. Loggning fungerar ändå i bakgrunden.\n      </Text>\n      {loading ? (\n        <Text style={{ fontSize: 14, color: '#666' }}>Laddar logg...</Text>\n      ) : (Array.isArray(events) && events.length > 0 ? (\n        events.map((ev) => {\n          const ts = ev?.ts && ev.ts.toDate ? ev.ts.toDate() : null;\n          const tsText = ts ? ts.toLocaleString('sv-SE') : '';\n          const type = String(ev?.type || '').trim();\n          const companyLabel = String(ev?.companyId || '').trim();\n          return (\n            <View key={ev.id} style={{ paddingVertical: 4, borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n              <Text style={{ fontSize: 14, fontWeight: '600', color: '#333' }}>{type}</Text>\n              {companyLabel ? <Text style={{ fontSize: 13, color: '#444' }}>Företag: {companyLabel}</Text> : null}\n              {tsText ? <Text style={{ fontSize: 12, color: '#777' }}>{tsText}</Text> : null}\n            </View>\n          );\n        })\n      ) : (\n        <Text style={{ fontSize: 14, color: '#666' }}>Inga loggposter hittades än.</Text>\n      ))}\n    </ScrollView>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ArbetsberedningScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/CameraCapture.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'setOrientation' is assigned a value but never used.","line":23,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setOrientation"},"fix":{"range":[1170,1186],"text":""},"desc":"Remove unused variable 'setOrientation'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setPictureSize' is assigned a value but never used.","line":24,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setPictureSize"},"fix":{"range":[1232,1248],"text":""},"desc":"Remove unused variable 'setPictureSize'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":51,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":73},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":113,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":113,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":132,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":132,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":133,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":74},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":140,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":140,"endColumn":22},{"ruleId":"import/namespace","severity":2,"message":"Unable to validate computed reference to imported namespace 'CameraModule'.","line":166,"column":51,"nodeType":"Identifier","endLine":166,"endColumn":53},{"ruleId":"import/namespace","severity":2,"message":"Unable to validate computed reference to imported namespace 'CameraModule'.","line":167,"column":39,"nodeType":"Identifier","endLine":167,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":174,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":174,"endColumn":18},{"ruleId":"import/namespace","severity":2,"message":"Unable to validate computed reference to imported namespace 'CameraModule'.","line":236,"column":51,"nodeType":"Identifier","endLine":236,"endColumn":53},{"ruleId":"import/namespace","severity":2,"message":"Unable to validate computed reference to imported namespace 'CameraModule'.","line":237,"column":39,"nodeType":"Identifier","endLine":237,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":244,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":244,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":249,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":249,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":310,"column":120,"nodeType":"Identifier","messageId":"unusedVar","endLine":310,"endColumn":121},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":313,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":313,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":348,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":357,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":357,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":360,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":360,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":368,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":368,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":370,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":370,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":372,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":372,"endColumn":61},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":383,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":383,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":391,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":391,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":392,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":392,"endColumn":84},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":399,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":399,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":403,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":403,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":406,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":406,"endColumn":24}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":24,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import MaterialIcons from '@expo/vector-icons/MaterialIcons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { CommonActions, useNavigation, useRoute } from '@react-navigation/native';\nimport * as CameraModule from 'expo-camera';\nimport { Camera } from 'expo-camera';\nimport * as ImageManipulator from 'expo-image-manipulator';\nimport { useEffect, useRef, useState } from 'react';\nimport { Alert, Image, KeyboardAvoidingView, Platform, ScrollView, StyleSheet, Text, TextInput, TouchableOpacity, View } from 'react-native';\n// Load ImagePicker dynamically in handlers to avoid bundling native-only exports on web\nlet ImagePicker = null;\n\nconst PRIMARY = '#263238';\n\nexport default function CameraCapture() {\n  const navigation = useNavigation();\n  const route = useRoute();\n  const { sectionIdx, pointIdx, project } = route.params || {};\n  const [hasPermission, setHasPermission] = useState(null);\n  const [cameraRef, setCameraRef] = useState(null);\n  const [isCapturing, setIsCapturing] = useState(false);\n  const [photoPreview, setPhotoPreview] = useState(null);\n  const [photoComment, setPhotoComment] = useState('');\n  const [orientation, setOrientation] = useState('portrait');\n  const [pictureSize, setPictureSize] = useState(null);\n  const cameraViewRef = useRef(null);\n  const scrollRef = useRef(null);\n  // Resolve Camera component robustly across Expo versions / bundlers\n  // We will pick the first entry that is actually a renderable component (function/class)\n  let CameraComponent = null;\n  let resolvedInfo = { type: 'unknown', keys: [] };\n  try {\n    // Prefer CameraView if available (some builds expose CameraView as the host component)\n    if (CameraModule && CameraModule.CameraView) {\n      CameraComponent = CameraModule.CameraView;\n      resolvedInfo = { type: 'CameraView', keys: Object.keys(CameraModule || {}) };\n    } else if (CameraModule && CameraModule.Camera) {\n      CameraComponent = CameraModule.Camera;\n      resolvedInfo = { type: 'Camera', keys: Object.keys(CameraModule || {}) };\n    } else if (Camera) {\n      CameraComponent = Camera;\n      resolvedInfo = { type: 'expo-camera Camera', keys: [] };\n    } else {\n      resolvedInfo = { type: 'none', keys: Object.keys(CameraModule || {}) };\n    }\n  } catch(e) {\n    resolvedInfo = { type: 'error', keys: Object.keys(CameraModule || {}), error: String(e) };\n  }\n  const handlePickFromLibrary = async () => {\n    try {\n      if (!ImagePicker) {\n        try { ImagePicker = await import('expo-image-picker'); } catch(e) { ImagePicker = null; }\n      }\n      let perm = null;\n      if (ImagePicker && typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\n        perm = await ImagePicker.getMediaLibraryPermissionsAsync();\n      }\n      if (!perm || !(perm.granted === true || perm.status === 'granted')) {\n        perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\n      }\n      const ok = (perm && (perm.granted === true || perm.status === 'granted'));\n      if (!ok) {\n        Alert.alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\n        return;\n      }\n      const mediaTypesOption = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images)\n        ? ImagePicker.MediaTypeOptions.Images\n        : (ImagePicker && ImagePicker.MediaType && ImagePicker.MediaType.Images)\n          ? ImagePicker.MediaType.Images\n          : undefined;\n      const pickerOptions = { quality: 0.8 };\n      if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\n      const res = (ImagePicker && typeof ImagePicker.launchImageLibraryAsync === 'function') ? await ImagePicker.launchImageLibraryAsync(pickerOptions) : null;\n      const extractAssets = (r) => {\n        if (!r) return [];\n        if (Array.isArray(r.assets) && r.assets.length) return r.assets;\n        if (Array.isArray(r.selectedAssets) && r.selectedAssets.length) return r.selectedAssets;\n        if (r.uri) return [{ uri: r.uri }];\n        if (r.cancelled === false && r.uri) return [{ uri: r.uri }];\n        return [];\n      };\n      const assets = extractAssets(res);\n      if (assets && assets.length > 0) {\n        // Skapa samma payload som vid foto\n        const photos = assets.map(a => {\n          const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\n          return uri ? { uri, comment: '' } : null;\n        }).filter(Boolean);\n        if (photos.length > 0) {\n          const target = route.params?.returnScreen || 'SkyddsrondScreen';\n          const payload = {\n            cameraResult: {\n              uri: photos[0].uri, // För kompatibilitet, men vi skickar alla i returnedMottagningsPhotos\n              sectionIdx,\n              pointIdx,\n              returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat(photos),\n            },\n            project,\n          };\n          const returnKey = route.params?.returnKey;\n            if (returnKey) {\n            try {\n              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: returnKey }));\n            } catch(_e) {}\n            try {\n              (async () => {\n                try {\n                  const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\n                  const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\n                  pending.push(payload.cameraResult);\n                  await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\n                } catch(_e) {}\n              })();\n            } catch(e) {}\n            setTimeout(() => { try { navigation.goBack(); } catch(_e) {} }, 300);\n          } else {\n            try {\n              const state = navigation.getState && navigation.getState();\n              if (state && Array.isArray(state.routes)) {\n                const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\n                const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\n                if (prevRoute && prevRoute.key) {\n                  try {\n                    navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\n                  } catch(_e) {}\n                  try {\n                    (async () => {\n                      const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\n                      const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\n                      pending.push(payload.cameraResult);\n                      await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\n                    })();\n                  } catch(e) {}\n                  setTimeout(() => { try { navigation.goBack(); } catch(e) {} }, 300);\n                } else {\n                  navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n                }\n              } else {\n                navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n              }\n            } catch(e) {\n              navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n            }\n          }\n        }\n      }\n    } catch(e) {\n      Alert.alert('Kunde inte välja bild: ' + (e?.message || e));\n    }\n  };\n\n  // Ta bort automatisk kamerabehörighetskontroll vid mount\n\n\n  const handleCapture = async () => {\n    try {\n      // Kontrollera kamerabehörighet först\n      let perm = null;\n      const tryFns = [\n        'getCameraPermissionsAsync',\n        'requestCameraPermissionsAsync',\n        'getPermissionsAsync',\n        'requestPermissionsAsync'\n      ];\n      for (const fn of tryFns) {\n        try {\n          if (CameraModule && typeof CameraModule[fn] === 'function') {\n            perm = await CameraModule[fn]();\n            if (perm) break;\n          }\n          if (CameraModule && CameraModule.Camera && typeof CameraModule.Camera[fn] === 'function') {\n            perm = await CameraModule.Camera[fn]();\n            if (perm) break;\n          }\n        } catch(e) {}\n      }\n      const status = perm && (perm.status || (perm.granted ? 'granted' : 'denied'));\n      if (status !== 'granted') {\n        Alert.alert('Kamerabehörighet krävs', 'Appen har inte tillgång till kameran. Gå till inställningar och ge behörighet om du vill ta foto.', [{ text: 'OK', onPress: () => {} }]);\n        return;\n      }\n      if (!cameraRef || isCapturing) return;\n      setIsCapturing(true);\n      const options = { quality: 0.8 };\n      if (pictureSize) options.pictureSize = pictureSize;\n      const photo = await cameraRef.takePictureAsync(options);\n\n      let finalPhoto = photo;\n      if (orientation === 'portrait' && photo && photo.width && photo.height) {\n        const targetRatio = 4 / 3;\n        const actualRatio = photo.height / photo.width;\n        if (Math.abs(actualRatio - targetRatio) > 0.01) {\n          const cropWidth = photo.width;\n          const cropHeight = Math.round(photo.width * 4 / 3);\n          if (cropHeight <= photo.height) {\n            const cropOriginY = Math.round((photo.height - cropHeight) / 2);\n            const manipResult = await ImageManipulator.manipulateAsync(\n              photo.uri,\n              [{ crop: { originX: 0, originY: cropOriginY, width: cropWidth, height: cropHeight } }],\n              { compress: 0.9, format: ImageManipulator.SaveFormat.JPEG }\n            );\n            finalPhoto = { ...manipResult, _orientation: orientation };\n          } else {\n            finalPhoto = { ...photo, _orientation: orientation };\n          }\n        } else {\n          finalPhoto = { ...photo, _orientation: orientation };\n        }\n      } else {\n        finalPhoto = { ...photo, _orientation: orientation };\n      }\n\n      setPhotoPreview(finalPhoto);\n      setPhotoComment('');\n    } catch(e) {\n      Alert.alert('Fel vid fotografering', String(e?.message || e));\n    } finally {\n      setIsCapturing(false);\n    }\n  };\n\n  useEffect(() => {\n    // placeholder for autoSave behavior\n  }, [route.params?.autoSave]);\n\n  const checkCameraPermission = async () => {\n    try {\n      let perm = null;\n      const tryFns = [\n        'getCameraPermissionsAsync',\n        'requestCameraPermissionsAsync',\n        'getPermissionsAsync',\n        'requestPermissionsAsync'\n      ];\n      for (const fn of tryFns) {\n        try {\n          if (CameraModule && typeof CameraModule[fn] === 'function') {\n            perm = await CameraModule[fn]();\n            if (perm) break;\n          }\n          if (CameraModule && CameraModule.Camera && typeof CameraModule.Camera[fn] === 'function') {\n            perm = await CameraModule.Camera[fn]();\n            if (perm) break;\n          }\n        } catch(e) {}\n      }\n      const status = perm && (perm.status || (perm.granted ? 'granted' : 'denied'));\n      setHasPermission(status === 'granted' ? true : false);\n      return status === 'granted';\n    } catch(e) {\n      setHasPermission(false);\n      return false;\n    }\n  };\n\n  // Visa endast fallback om hasPermission === false\n  if (hasPermission === false) {\n    return (\n      <View style={styles.container}>\n        <Text style={{ color: '#D32F2F', marginBottom: 12, fontWeight: 'bold' }}>Kamerabehörighet nekad.</Text>\n        <Text style={{ color: '#666', marginBottom: 12, textAlign: 'center' }}>\n          Appen har inte tillgång till kameran. Gå till inställningar och ge behörighet, starta om appen och försök igen.\n        </Text>\n        <View style={{ flexDirection: 'row', gap: 12 }}>\n          <TouchableOpacity style={styles.secondaryAction} onPress={() => navigation.goBack()}>\n            <MaterialIcons name=\"arrow-back\" size={18} color={PRIMARY} />\n            <Text style={styles.secondaryActionText}>Tillbaka</Text>\n          </TouchableOpacity>\n          <TouchableOpacity style={[styles.secondaryAction, { marginLeft: 12 }]} onPress={() => checkCameraPermission()}>\n            <MaterialIcons name=\"autorenew\" size={18} color={PRIMARY} />\n            <Text style={styles.secondaryActionText}>Be om behörighet</Text>\n          </TouchableOpacity>\n        </View>\n      </View>\n    );\n  }\n\n  if (photoPreview) {\n    const isPortrait = photoPreview._orientation === 'portrait';\n    const aspectRatio = isPortrait ? 3 / 4 : 4 / 3;\n    return (\n      <KeyboardAvoidingView style={{ flex: 1, backgroundColor: '#000' }} behavior={Platform.OS === 'ios' ? 'padding' : 'position'} keyboardVerticalOffset={Platform.OS === 'ios' ? 80 : 120}>\n        <ScrollView ref={scrollRef} contentContainerStyle={{ flexGrow: 1, justifyContent: 'flex-start', alignItems: 'center', paddingTop: 24 }} keyboardShouldPersistTaps=\"handled\">\n          <Image\n          source={{ uri: photoPreview.uri }}\n          style={{\n            width: isPortrait ? '92%' : undefined,\n            height: isPortrait ? undefined : '68%',\n            aspectRatio,\n            borderRadius: 16,\n            marginTop: 24,\n            marginBottom: 12,\n            maxWidth: 420,\n            maxHeight: 420,\n            backgroundColor: '#111',\n          }}\n          resizeMode=\"contain\"\n        />\n          <View style={{ width: '92%', marginTop: 12 }}>\n          <Text style={{ color: '#fff', marginBottom: 6 }}>Kommentar</Text>\n          <TextInput\n            value={photoComment}\n            onChangeText={(t) => setPhotoComment(t)}\n            placeholder=\"Lägg till kommentar till bilden...\"\n            placeholderTextColor=\"#ddd\"\n            multiline\n            numberOfLines={3}\n            blurOnSubmit={true}\n            onFocus={() => {\n              // Delay to allow keyboard to open then scroll the input into view\n              setTimeout(() => { try { scrollRef.current && scrollRef.current.scrollToEnd({ animated: true }); } catch(e) {} }, 120);\n            }}\n            returnKeyType=\"done\"\n            onSubmitEditing={() => { try { /* dismiss keyboard */ } catch(e) {} }}\n            style={{ backgroundColor: 'rgba(255,255,255,0.06)', padding: 8, borderRadius: 8, color: '#fff', minHeight: 48 }}\n          />\n        </View>\n        <View style={styles.previewButtonBar}>\n          <TouchableOpacity\n            style={[styles.previewButton, styles.previewButtonRetake]}\n            onPress={() => { setPhotoPreview(null); setPhotoComment(''); }}\n            activeOpacity={0.8}\n          >\n            <MaterialIcons name=\"refresh\" size={22} color={PRIMARY} style={{ marginBottom: 2 }} />\n            <Text style={styles.previewButtonTextRetake}>Ta om</Text>\n          </TouchableOpacity>\n          <TouchableOpacity\n            style={[styles.previewButton, styles.previewButtonSave]}\n            onPress={() => {\n              const target = route.params?.returnScreen || 'SkyddsrondScreen';\n              // Merge params into the existing route instead of pushing a new instance\n              try {\n                  // If caller provided `returnKey`, set params directly on that route (no remount).\n                  const payload = {\n                    cameraResult: {\n                      uri: photoPreview.uri,\n                      sectionIdx,\n                      pointIdx,\n                      returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat({ uri: photoPreview.uri, comment: photoComment || '' }),\n                    },\n                    project,\n                  };\n                  // Removed debug logging\n                  try {\n                    const returnKey = route.params?.returnKey;\n                    if (returnKey) {\n                      try {\n                        navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: returnKey }));\n                      } catch(e) {}\n                      try {\n                        const state = navigation.getState && navigation.getState();\n                        if (state && Array.isArray(state.routes)) {\n                          const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\n                          const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\n                          if (prevRoute && prevRoute.key) {\n                            try {\n                              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\n                            } catch(e) {}\n                          }\n                        }\n                      } catch(e) {}\n                      try {\n                        (async () => {\n                          try {\n                            const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\n                            const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\n                            pending.push(payload.cameraResult);\n                            await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\n                          } catch(e) {}\n                        })();\n                      } catch(e) {}\n                      setTimeout(() => {\n                        try { navigation.goBack(); } catch(e) {};\n                      }, 300);\n                    } else {\n                      try {\n                        const state = navigation.getState && navigation.getState();\n                        if (state && Array.isArray(state.routes)) {\n                          const idx = state.index != null ? state.index : state.routes.findIndex(r => r.key === route.key);\n                          const prevRoute = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\n                            if (prevRoute && prevRoute.key) {\n                            try {\n                              navigation.dispatch(CommonActions.setParams({ params: { cameraResult: payload.cameraResult }, key: prevRoute.key }));\n                            } catch(e) {}\n                            try {\n                              (async () => {\n                                const pendingRaw = await AsyncStorage.getItem('pending_camera_photos');\n                                const pending = pendingRaw ? JSON.parse(pendingRaw) : [];\n                                pending.push(payload.cameraResult);\n                                await AsyncStorage.setItem('pending_camera_photos', JSON.stringify(pending));\n                              })();\n                            } catch(e) {}\n                            setTimeout(() => { try { navigation.goBack(); } catch(e) {} }, 300);\n                          } else {\n                            navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n                          }\n                        } else {\n                          navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n                        }\n                      } catch(e) {\n                        navigation.navigate({ name: target, params: { cameraResult: payload.cameraResult }, merge: true });\n                      }\n                    }\n                  } catch(e) {\n                    navigation.navigate(target, payload);\n                  }\n              } catch(e) {\n                navigation.navigate(target, {\n                  cameraResult: {\n                    uri: photoPreview.uri,\n                    sectionIdx,\n                    pointIdx,\n                    returnedMottagningsPhotos: (route.params?.mottagningsPhotos || []).concat({ uri: photoPreview.uri, comment: photoComment || '' }),\n                  },\n                  project,\n                });\n              }\n            }}\n            activeOpacity={0.8}\n          >\n            <MaterialIcons name=\"save\" size={28} color=\"#fff\" style={{ marginBottom: 2 }} />\n          </TouchableOpacity>\n        </View>\n      </ScrollView>\n    </KeyboardAvoidingView>\n    );\n  }\n\n  return (\n    <View style={{ flex: 1, backgroundColor: '#000' }}>\n      {(CameraComponent) ? (\n      <CameraComponent\n        style={{ flex: 1 }}\n        ref={ref => {\n          setCameraRef(ref);\n          cameraViewRef.current = ref;\n        }}\n        ratio={orientation === 'portrait' ? '3:4' : '4:3'}\n        pictureSize={pictureSize}\n      />\n      ) : (\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <Text style={{ color: '#fff', marginBottom: 12 }}>Kunde inte ladda kamerakomponent.</Text>\n          <Text style={{ color: '#fff', marginBottom: 6, fontSize: 12, opacity: 0.9 }}>\n            {'Debug: ' + resolvedInfo.type + (Array.isArray(resolvedInfo.keys) && resolvedInfo.keys.length ? ' (' + resolvedInfo.keys.join(', ') + ')' : '')}\n          </Text>\n          <TouchableOpacity onPress={() => checkCameraPermission()} style={{ padding: 10, backgroundColor: '#fff', borderRadius: 8 }}>\n            <Text style={{ color: PRIMARY }}>Försök igen</Text>\n          </TouchableOpacity>\n        </View>\n      )}\n      {/* Avbryt-knapp i övre vänstra hörnet */}\n      <TouchableOpacity style={styles.cancelButton} onPress={() => navigation.goBack()}>\n        <MaterialIcons name=\"close\" size={28} color={PRIMARY} />\n      </TouchableOpacity>\n      {/* Stor foto-knapp: mitten nedtill (porträtt) eller mitten till höger (landskap) */}\n      {orientation === 'portrait' ? (\n        <View style={[styles.cameraButtonBarPortrait, { pointerEvents: 'box-none' }] }>\n          <TouchableOpacity\n            style={styles.cameraButton}\n            onPress={handleCapture}\n            disabled={isCapturing}\n            activeOpacity={0.7}\n          >\n            <MaterialIcons name=\"photo-camera\" size={44} color=\"#fff\" />\n          </TouchableOpacity>\n          <View style={[styles.libraryButtonWrapperPortrait, { pointerEvents: 'box-none' }] }>\n            <TouchableOpacity\n              style={[styles.cameraButton, styles.libraryButton]}\n              onPress={handlePickFromLibrary}\n              activeOpacity={0.7}\n            >\n              <MaterialIcons name=\"photo-library\" size={28} color={PRIMARY} />\n              <Text style={{ color: PRIMARY, fontWeight: 'bold', fontSize: 10, marginTop: 2 }}>Bibliotek</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      ) : (\n        <View style={[styles.cameraButtonBarLandscape, { pointerEvents: 'box-none' }] }>\n          <TouchableOpacity\n            style={styles.cameraButton}\n            onPress={handleCapture}\n            disabled={isCapturing}\n            activeOpacity={0.7}\n          >\n            <MaterialIcons name=\"photo-camera\" size={44} color=\"#fff\" />\n          </TouchableOpacity>\n          <View style={[styles.libraryButtonWrapperLandscape, { pointerEvents: 'box-none' }] }>\n            <TouchableOpacity\n              style={[styles.cameraButton, styles.libraryButton]}\n              onPress={handlePickFromLibrary}\n              activeOpacity={0.7}\n            >\n              <MaterialIcons name=\"photo-library\" size={28} color={PRIMARY} />\n              <Text style={{ color: PRIMARY, fontWeight: 'bold', fontSize: 10, marginTop: 2 }}>Bibliotek</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      )}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: { flex: 1, backgroundColor: '#fff', alignItems: 'center', justifyContent: 'center', padding: 16 },\n  previewButtonBar: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    marginTop: 12,\n    marginBottom: 18,\n    paddingHorizontal: 18,\n  },\n  previewButton: {\n    flexDirection: 'column',\n    alignItems: 'center',\n    justifyContent: 'center',\n    borderRadius: 20,\n    minWidth: 86,\n    paddingVertical: 8,\n    paddingHorizontal: 12,\n    marginHorizontal: 6,\n    elevation: 3,\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 1 },\n    shadowOpacity: 0.12,\n    shadowRadius: 4,\n  },\n  previewButtonRetake: {\n    backgroundColor: '#fff',\n    borderWidth: 2,\n    borderColor: PRIMARY,\n  },\n  previewButtonSave: {\n    backgroundColor: PRIMARY,\n    borderWidth: 2,\n    borderColor: '#fff',\n  },\n  previewButtonTextRetake: {\n    color: PRIMARY,\n    fontWeight: '700',\n    fontSize: 14,\n    marginTop: 4,\n    letterSpacing: 0.2,\n  },\n  previewButtonTextSave: {\n    color: '#fff',\n    fontWeight: '700',\n    fontSize: 14,\n    marginTop: 4,\n    letterSpacing: 0.2,\n  },\n  // ...existing code...\n  cancelButton: {\n    position: 'absolute',\n    top: 36,\n    left: 20,\n    zIndex: 10,\n    backgroundColor: 'rgba(255,255,255,0.85)',\n    borderRadius: 24,\n    padding: 6,\n    elevation: 2,\n  },\n  cameraButtonBarPortrait: {\n    position: 'absolute',\n    left: 0,\n    right: 0,\n    bottom: 36,\n    alignItems: 'center',\n    justifyContent: 'center',\n    zIndex: 5,\n    pointerEvents: 'box-none',\n  },\n  libraryButtonWrapperPortrait: {\n    position: 'absolute',\n    right: 24,\n    bottom: 0,\n    zIndex: 10,\n    alignItems: 'center',\n    justifyContent: 'center',\n    pointerEvents: 'box-none',\n  },\n  libraryButtonWrapperLandscape: {\n    position: 'absolute',\n    right: 24,\n    top: '60%',\n    zIndex: 10,\n    alignItems: 'center',\n    justifyContent: 'center',\n    pointerEvents: 'box-none',\n  },\n  libraryButton: {\n    backgroundColor: '#fff',\n    borderColor: PRIMARY,\n    marginTop: 0,\n    width: 60,\n    height: 60,\n    borderRadius: 30,\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingHorizontal: 0,\n    paddingVertical: 0,\n    minWidth: 0,\n    elevation: 4,\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 6,\n  },\n  cameraButtonBarLandscape: {\n    position: 'absolute',\n    right: 36,\n    top: '50%',\n    transform: [{ translateY: 0 }],\n    alignItems: 'center',\n    justifyContent: 'center',\n    zIndex: 5,\n    pointerEvents: 'box-none',\n  },\n  cameraButton: {\n    width: 80,\n    height: 80,\n    borderRadius: 40,\n    backgroundColor: PRIMARY,\n    alignItems: 'center',\n    justifyContent: 'center',\n    borderWidth: 4,\n    borderColor: '#fff',\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 6,\n    elevation: 4,\n  },\n  secondaryAction: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingVertical: 8,\n    paddingHorizontal: 12,\n    borderRadius: 8,\n    backgroundColor: 'transparent'\n  },\n  secondaryActionText: {\n    color: PRIMARY,\n    marginLeft: 8,\n    fontSize: 14,\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ControlDetails.js","messages":[{"ruleId":"import/no-duplicates","severity":1,"message":"'/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/node_modules/react-native/index.js' imported multiple times.","line":7,"column":44,"nodeType":"Literal","endLine":7,"endColumn":58},{"ruleId":"import/no-duplicates","severity":1,"message":"'/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/node_modules/react-native/index.js' imported multiple times.","line":9,"column":116,"nodeType":"Literal","endLine":9,"endColumn":130},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":44,"column":43,"nodeType":"Identifier","endLine":44,"endColumn":51},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":45,"column":3,"nodeType":"Identifier","endLine":45,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'control'. Either include it or remove the dependency array.","line":47,"column":6,"nodeType":"ArrayExpression","endLine":47,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [control, control.id]","fix":{"range":[2295,2308],"text":"[control, control.id]"}}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":68,"column":3,"nodeType":"Identifier","endLine":68,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'control' and 'controlState'. Either include them or remove the dependency array.","line":119,"column":6,"nodeType":"ArrayExpression","endLine":119,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [control, control?.id, controlState, project?.id]","fix":{"range":[4883,4909],"text":"[control, control?.id, controlState, project?.id]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'checklistRaw' conditional could make the dependencies of useMemo Hook (at line 290) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'checklistRaw' in its own useMemo() Hook.","line":131,"column":9,"nodeType":"VariableDeclarator","endLine":133,"endColumn":90},{"ruleId":"no-unused-vars","severity":1,"message":"'attachments' is assigned a value but never used.","line":138,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"attachments"},"fix":{"range":[5972,6062],"text":""},"desc":"Remove unused variable 'attachments'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":140,"column":47,"nodeType":"Identifier","endLine":140,"endColumn":55},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":141,"column":3,"nodeType":"Identifier","endLine":141,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'safeControl?.company' and 'safeControl?.companyId'. Either include them or remove the dependency array.","line":160,"column":6,"nodeType":"ArrayExpression","endLine":160,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [routeCompanyId, project?.companyId, project.id, safeControl?.companyId, safeControl?.company]","fix":{"range":[6676,6725],"text":"[routeCompanyId, project?.companyId, project.id, safeControl?.companyId, safeControl?.company]"}}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useMemo\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":214,"column":29,"nodeType":"Identifier","endLine":214,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":675,"column":94,"nodeType":"Identifier","messageId":"unusedVar","endLine":675,"endColumn":95}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\n\nimport Ionicons from '@expo/vector-icons/Ionicons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useNavigation } from '@react-navigation/native';\nimport { useEffect, useMemo, useState } from 'react';\nimport { Alert, Platform, TextInput } from 'react-native';\n// import { Ionicons } from '@expo/vector-icons';\nimport { Image, Modal, Pressable, ScrollView, StyleSheet, Text, TouchableOpacity, View, useWindowDimensions } from 'react-native';\nimport SignatureModal from '../components/SignatureModal';\nimport { resolveCompanyLogoUrl } from '../components/firebase';\n// Load ImagePicker dynamically inside handlers to avoid bundling native-only exports on web\nlet ImagePicker = null;\n\nconst CONTROL_TYPE_ICONS = {\n  'Arbetsberedning': { icon: 'construct-outline', color: '#1976D2', label: 'Arbetsberedning' },\n  'Egenkontroll': { icon: 'checkmark-done-outline', color: '#388E3C', label: 'Egenkontroll' },\n  'Fuktmätning': { icon: 'water-outline', color: '#0288D1', label: 'Fuktmätning' },\n  'Mottagningskontroll': { icon: 'checkbox-outline', color: '#7B1FA2', label: 'Mottagningskontroll' },\n  'Riskbedömning': { icon: 'warning-outline', color: '#FFD600', label: 'Riskbedömning' },\n  'Skyddsrond': { icon: 'shield-half-outline', color: '#388E3C', label: 'Skyddsrond' },\n};\n\nconst PRIMARY = '#263238';\nconst A4_WEB_MAX_WIDTH = 794; // ~210mm at 96dpi\nconst META_ICON_COLOR = '#1976D2';\n\nexport default function ControlDetails({ route }) {\n  const { height: windowHeight } = useWindowDimensions();\n  // Modal state for åtgärd\n  const [actionModal, setActionModal] = useState({ visible: false, section: '', point: '', img: null, comment: '', signature: '', name: '', date: '' });\n  const navigation = useNavigation();\n  const [photoModalVisible, setPhotoModalVisible] = useState(false);\n  const [selectedPhoto, setSelectedPhoto] = useState(null);\n  const { control, project, companyId: routeCompanyId } = route.params || {};\n  if (!control) {\n    return (\n      <View style={[styles.container, { justifyContent: 'center', alignItems: 'center' }]}>\n        <Text style={{ color: '#555' }}>Kunde inte hitta kontrollen.</Text>\n      </View>\n    );\n  }\n\n  const [controlState, setControlState] = useState(control);\n  useEffect(() => {\n    setControlState(control);\n  }, [control?.id]);\n\n  const hasAnyChecklistPoints = (c) => {\n    try {\n      const sections = Array.isArray(c?.checklist)\n        ? c.checklist\n        : (Array.isArray(c?.checklistSections) ? c.checklistSections : []);\n      if (!Array.isArray(sections) || sections.length === 0) return false;\n      for (const sec of sections) {\n        const pts = Array.isArray(sec?.points)\n          ? sec.points\n          : (Array.isArray(sec?.items) ? sec.items : []);\n        if (Array.isArray(pts) && pts.length > 0) return true;\n      }\n      return false;\n    } catch(_e) {\n      return false;\n    }\n  };\n\n  // If we navigated here with a thin control object (common on web lists), hydrate from AsyncStorage.\n  useEffect(() => {\n    let active = true;\n    (async () => {\n      try {\n        const current = (controlState && typeof controlState === 'object') ? controlState : (control || {});\n        if (hasAnyChecklistPoints(current)) return;\n\n        const id = current?.id || control?.id;\n        const projectId = current?.project?.id || project?.id;\n        const type = current?.type;\n        const savedAt = current?.savedAt;\n        const date = current?.date;\n\n        const tryHydrateFromKey = async (key) => {\n          const raw = await AsyncStorage.getItem(key);\n          if (!raw) return null;\n          const arr = JSON.parse(raw);\n          const list = Array.isArray(arr) ? arr : [];\n\n          if (id) {\n            const byId = list.find(x => x && x.id && String(x.id) === String(id));\n            if (byId) return byId;\n          }\n\n          // Best-effort fallback for legacy items without stable id\n          if (projectId && type) {\n            const byMeta = list.find(x => (\n              x\n              && String(x?.project?.id || '') === String(projectId)\n              && String(x?.type || '') === String(type)\n              && (savedAt ? String(x?.savedAt || '') === String(savedAt) : true)\n              && (date ? String(x?.date || '') === String(date) : true)\n            ));\n            if (byMeta) return byMeta;\n          }\n          return null;\n        };\n\n        const found = (await tryHydrateFromKey('completed_controls'))\n          || (await tryHydrateFromKey('draft_controls'))\n          || null;\n\n        if (!found) return;\n        // Only replace if it actually brings more data (especially checklist)\n        if (!hasAnyChecklistPoints(found) && !hasAnyChecklistPoints(current)) return;\n        if (active) setControlState(found);\n      } catch(_e) {\n        // ignore hydration errors\n      }\n    })();\n    return () => { active = false; };\n  }, [control?.id, project?.id]);\n\n  const safeControl = (controlState && typeof controlState === 'object') ? controlState : {};\n  const type = safeControl.type;\n  const date = safeControl.date;\n  const deliveryDesc = safeControl.deliveryDesc;\n  const description = safeControl.description;\n  const generalNote = safeControl.generalNote;\n  const materialDesc = safeControl.materialDesc || safeControl.material;\n  const qualityDesc = safeControl.qualityDesc;\n  const coverageDesc = safeControl.coverageDesc;\n  const participants = Array.isArray(safeControl.participants) ? safeControl.participants : [];\n  const checklistRaw = Array.isArray(safeControl.checklist)\n    ? safeControl.checklist\n    : (Array.isArray(safeControl.checklistSections) ? safeControl.checklistSections : []);\n  const status = safeControl.status;\n  const weather = safeControl.weather;\n  const mottagningsPhotos = Array.isArray(safeControl.mottagningsPhotos) ? safeControl.mottagningsPhotos : [];\n  const mottagningsSignatures = Array.isArray(safeControl.mottagningsSignatures) ? safeControl.mottagningsSignatures : [];\n  const attachments = Array.isArray(safeControl.attachments) ? safeControl.attachments : [];\n\n  const [companyLogoUrl, setCompanyLogoUrl] = useState(null);\n  useEffect(() => {\n    let active = true;\n    (async () => {\n      try {\n        const stored = await AsyncStorage.getItem('dk_companyId');\n        const cid = (\n          routeCompanyId\n          || project?.companyId\n          || safeControl?.companyId\n          || safeControl?.company\n          || stored\n          || ''\n        ).trim();\n        if (!cid) return;\n        const url = await resolveCompanyLogoUrl(cid);\n        if (active) setCompanyLogoUrl(url || null);\n      } catch(_e) {}\n    })();\n    return () => { active = false; };\n  }, [routeCompanyId, project?.companyId, project?.id]);\n\n  const formatYmd = (value) => {\n    if (!value) return '-';\n    let v = value;\n    try {\n      // Firestore Timestamp support\n      if (v && typeof v === 'object') {\n        if (typeof v.toDate === 'function') v = v.toDate();\n        else if (typeof v.toMillis === 'function') v = new Date(v.toMillis());\n        else if (typeof v.seconds === 'number') v = new Date(v.seconds * 1000);\n        else if (typeof v._seconds === 'number') v = new Date(v._seconds * 1000);\n        else if (typeof v.nanoseconds === 'number' && typeof v.seconds === 'number') v = new Date(v.seconds * 1000);\n        else if (typeof v._nanoseconds === 'number' && typeof v._seconds === 'number') v = new Date(v._seconds * 1000);\n      }\n    } catch(_e) {}\n\n    const d = new Date(v);\n    if (isNaN(d.getTime())) return String(value);\n    return d.toISOString().slice(0, 10);\n  };\n\n  const upsertControlInStorage = async (updated) => {\n    const isDraft = !!updated?.isDraft;\n    const key = isDraft ? 'draft_controls' : 'completed_controls';\n    const raw = await AsyncStorage.getItem(key);\n    const list = raw ? JSON.parse(raw) : [];\n    const arr = Array.isArray(list) ? list : [];\n    const id = updated?.id;\n    if (!id) throw new Error('Kontrollen saknar id');\n    const idx = arr.findIndex(c => c && c.id === id);\n    if (idx !== -1) arr[idx] = updated;\n    else arr.push(updated);\n    await AsyncStorage.setItem(key, JSON.stringify(arr));\n  };\n\n  // Format week number\n  function getWeek(dateStr) {\n    if (!dateStr) return '';\n    const d = new Date(dateStr);\n    d.setHours(0, 0, 0, 0);\n    d.setDate(d.getDate() + 4 - (d.getDay() || 7));\n    const yearStart = new Date(d.getFullYear(), 0, 1);\n    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\n    return weekNo;\n  }\n  const week = getWeek(date);\n  // Status text\n  const statusText = status === 'UTFÖRD' || status === 'Slutförd' ? 'Slutförd' : 'Pågående';\n  const isCompleted = statusText === 'Slutförd' && !safeControl.isDraft;\n  const participantsLabel = type === 'Mottagningskontroll' ? 'Mottagare' : 'Deltagare';\n\n  // Checklist points: group by section, show approved and deviation points with icons\n  // checklistSections ska alltid innehålla remediation-objekt\n  const checklistSections = useMemo(() => {\n    const coerceArrayLike = (v) => {\n      if (Array.isArray(v)) return v;\n      if (v && typeof v === 'object') {\n        const keys = Object.keys(v)\n          .filter(k => String(parseInt(k, 10)) === k)\n          .map(k => parseInt(k, 10))\n          .sort((a, b) => a - b);\n        if (!keys.length) return [];\n        const arr = [];\n        keys.forEach(k => { arr[k] = v[k]; });\n        return arr;\n      }\n      return [];\n    };\n\n    const normalizePointText = (pt) => {\n      if (typeof pt === 'string') return pt;\n      if (pt && typeof pt === 'object') return pt.text || pt.label || pt.name || '';\n      return '';\n    };\n\n    const normalizeStatus = (v) => {\n      if (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') return v;\n      if (v === true) return 'ok';\n      if (v === false) return 'avvikelse';\n      const s = String(v ?? '').trim().toLowerCase();\n      if (!s) return null;\n      if (['ok', 'approved', 'godkänd', 'godkand', 'ja', 'yes', 'true', 'green', 'grön', 'gron'].includes(s)) return 'ok';\n      if (['avvikelse', 'deviation', 'nej', 'no', 'false', 'fail', 'red', 'röd', 'rod', 'anmärkning', 'anmarkning', 'risk'].includes(s)) return 'avvikelse';\n      if (['ejaktuell', 'inte aktuell', 'n/a', 'na'].includes(s)) return 'ejaktuell';\n      return null;\n    };\n\n    const arr = Array.isArray(checklistRaw) ? checklistRaw : [];\n    return arr.map((section) => {\n      if (!section || typeof section !== 'object') return null;\n\n      const label = section.label || section.title || section.name || 'Kontrollpunkter';\n\n      let remediation = section.remediation;\n      if (!remediation || typeof remediation !== 'object') remediation = {};\n\n      const items = [];\n\n      // Legacy/precomputed shape: section.approved / section.deviation\n      const approvedRaw = coerceArrayLike(section.approved ?? section.approvedPoints ?? null);\n      const deviationRaw = coerceArrayLike(section.deviation ?? section.deviationPoints ?? null);\n      if (approvedRaw.length > 0 || deviationRaw.length > 0) {\n        approvedRaw.forEach((pt, i) => {\n          const text = String(normalizePointText(pt) || '').trim();\n          if (text) items.push({ text, idx: i, status: 'ok' });\n        });\n        deviationRaw.forEach((pt, i) => {\n          const text = String(normalizePointText(pt) || '').trim();\n          if (text) items.push({ text, idx: i, status: 'avvikelse' });\n        });\n        if (items.length === 0) return null;\n        return { label, items, remediation };\n      }\n\n      const pointsRaw = coerceArrayLike(section.points ?? section.items ?? []);\n      if (!pointsRaw.length) return null;\n      const statusesRaw = coerceArrayLike(section.statuses ?? section.status ?? []);\n\n      pointsRaw.forEach((pt, idx) => {\n        const text = String(normalizePointText(pt) || '').trim();\n        if (!text) return;\n        const statusFromPoint = (pt && typeof pt === 'object' && pt.status !== undefined) ? pt.status : undefined;\n        const st = normalizeStatus(statusFromPoint !== undefined ? statusFromPoint : statusesRaw[idx]);\n        items.push({ text, idx, status: st });\n      });\n\n      if (items.length === 0) return null;\n      return { label, items, remediation };\n    }).filter(Boolean);\n  }, [checklistRaw]);\n\n  // Get icon and label for this control type\n  const { icon, color, label } = CONTROL_TYPE_ICONS[type] || { icon: 'alert-circle', color: '#D32F2F', label: type || 'Kontroll' };\n\n  const pageContent = (\n    <View style={[styles.page, Platform.OS === 'web' ? styles.pageWeb : null]}>\n      <View style={styles.headerCard}>\n        {companyLogoUrl ? (\n            <View style={{ marginBottom: 12, alignItems: 'flex-start', width: '100%' }}>\n            <Image source={{ uri: companyLogoUrl }} style={styles.companyLogo} resizeMode=\"contain\" />\n            <View style={styles.companyLogoDivider} />\n          </View>\n        ) : null}\n\n        <View style={styles.headerTopRow}>\n          <View style={styles.headerTitleRow}>\n            <Ionicons name={icon} size={28} color={color} style={{ marginRight: 10 }} />\n            <Text style={styles.title}>{label}</Text>\n          </View>\n\n          <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n            <View style={[styles.statusPill, isCompleted ? styles.statusPillDone : styles.statusPillOngoing]}>\n              <Text style={[styles.statusPillText, isCompleted ? styles.statusPillTextDone : styles.statusPillTextOngoing]}>{statusText}</Text>\n            </View>\n            <TouchableOpacity\n              onPress={() => {\n                let screen = null;\n                switch (type) {\n                  case 'Riskbedömning': screen = 'RiskbedömningScreen'; break;\n                  case 'Arbetsberedning': screen = 'ArbetsberedningScreen'; break;\n                  case 'Egenkontroll': screen = 'EgenkontrollScreen'; break;\n                  case 'Fuktmätning': screen = 'FuktmätningScreen'; break;\n                  case 'Mottagningskontroll': screen = 'MottagningskontrollScreen'; break;\n                  case 'Skyddsrond': screen = 'SkyddsrondScreen'; break;\n                  default: screen = null;\n                }\n                if (screen) navigation.navigate(screen, { initialValues: safeControl, project });\n              }}\n              style={[styles.headerActionBtn, { marginLeft: 8 }]}\n              accessibilityLabel=\"Redigera kontroll\"\n            >\n              <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\n            </TouchableOpacity>\n          </View>\n        </View>\n\n        {project?.id || project?.name ? (\n          <View style={styles.projectBar}>\n            <Text style={styles.projectBarText} numberOfLines={1} ellipsizeMode=\"tail\">\n              Projekt - {project?.id ? String(project.id).trim() : ''}{project?.id && project?.name ? ' - ' : ''}{project?.name ? String(project.name).trim() : ''}\n            </Text>\n          </View>\n        ) : null}\n      </View>\n\n      {/* Overview (matches mock) */}\n      <View style={styles.overviewCard}>\n        <View style={styles.overviewRow}>\n          <Text style={styles.overviewLabel}>Datum för kontroll:</Text>\n          <View style={styles.overviewValueWrap}>\n            <View style={styles.metaIconWrap}>\n              <Ionicons name=\"calendar-outline\" size={16} color={META_ICON_COLOR} />\n            </View>\n            <Text style={styles.overviewValue}>{formatYmd(date)}{week ? `  v.${week}` : ''}</Text>\n          </View>\n        </View>\n        <View style={styles.overviewRowDivider} />\n\n        <View style={styles.overviewRow}>\n          <Text style={styles.overviewLabel}>{participantsLabel}:</Text>\n          <View style={{ flex: 1 }}>\n            {participants.length > 0 ? participants.map((p, i) => {\n              const name = typeof p === 'string' ? p : (p?.name || p?.displayName || '');\n              const company = typeof p === 'object' ? (p?.company || p?.companyName || p?.foretag || p?.['f\\u00f6retag'] || '') : '';\n              const role = typeof p === 'object' ? (p?.role || p?.yrkesroll || p?.titel || '') : '';\n              const mobile = typeof p === 'object' ? (p?.mobile || p?.mobil || p?.phone || p?.telefon || p?.tel || '') : '';\n              const details = [name, company, role, mobile].filter(Boolean).join('  |  ');\n              const hasAny = !!(name || company || role || mobile);\n              if (!hasAny) return null;\n              return (\n                <View key={i} style={styles.metaMultiLineRow}>\n                  <View style={styles.metaIconWrap}>\n                    <Ionicons name=\"person-outline\" size={16} color={META_ICON_COLOR} />\n                  </View>\n                  {Platform.OS === 'web' ? (\n                    <View style={styles.participantTableRow}>\n                      <Text style={[styles.overviewValue, styles.participantColName]} numberOfLines={1} ellipsizeMode=\"tail\">{name}</Text>\n                      <Text style={[styles.overviewValue, styles.participantColCompany]} numberOfLines={1} ellipsizeMode=\"tail\">{company}</Text>\n                      <Text style={[styles.overviewValue, styles.participantColRole]} numberOfLines={1} ellipsizeMode=\"tail\">{role}</Text>\n                      <Text style={[styles.overviewValue, styles.participantColMobile]} numberOfLines={1} ellipsizeMode=\"tail\">{mobile}</Text>\n                    </View>\n                  ) : (\n                    <Text style={styles.overviewValue} numberOfLines={1} ellipsizeMode=\"tail\">{details}</Text>\n                  )}\n                </View>\n              );\n            }) : (\n              <Text style={[styles.overviewValue, { color: '#888' }]}>-</Text>\n            )}\n          </View>\n        </View>\n\n        {weather ? (\n          <>\n            <View style={styles.overviewRowDivider} />\n            <View style={styles.overviewRow}>\n              <Text style={styles.overviewLabel}>Väder:</Text>\n              <View style={styles.overviewValueWrap}>\n                <View style={styles.metaIconWrap}>\n                  <Ionicons name=\"sunny-outline\" size={16} color={META_ICON_COLOR} />\n                </View>\n                <Text style={styles.overviewValue}>{String(weather)}</Text>\n              </View>\n            </View>\n          </>\n        ) : null}\n      </View>\n\n      {/* Deltagare/Väder visas i Översikt-kortet ovan */}\n\n      {/* Beskrivning av moment */}\n      {((type === 'Mottagningskontroll' && (materialDesc || qualityDesc || coverageDesc || generalNote)) || deliveryDesc || description) && (\n        <View style={styles.card}>\n          {type === 'Mottagningskontroll' ? (\n            <>\n              {materialDesc ? (\n                <View style={styles.overviewRow}>\n                  <Text style={styles.overviewLabel}>Beskrivning:</Text>\n                  <View style={styles.overviewValueWrap}>\n                    <View style={styles.metaIconWrap}>\n                      <Ionicons name=\"cube-outline\" size={16} color={META_ICON_COLOR} />\n                    </View>\n                    <Text style={styles.overviewValue}>{String(materialDesc)}</Text>\n                  </View>\n                </View>\n              ) : null}\n              {qualityDesc ? (\n                <View style={{ marginBottom: 8 }}>\n                  <Text style={styles.noteText}>Kvalité / krav</Text>\n                  <Text style={styles.overviewValue}>{String(qualityDesc)}</Text>\n                </View>\n              ) : null}\n              {coverageDesc ? (\n                <View style={{ marginBottom: 8 }}>\n                  <Text style={styles.noteText}>Omfattning / mängd</Text>\n                  <Text style={styles.overviewValue}>{String(coverageDesc)}</Text>\n                </View>\n              ) : null}\n              {generalNote ? (\n                <View>\n                  <Text style={styles.noteText}>Anteckning</Text>\n                  <Text style={styles.overviewValue}>{String(generalNote)}</Text>\n                </View>\n              ) : null}\n            </>\n          ) : (\n            <>\n              <Text style={styles.sectionTitle}>Beskrivning</Text>\n              <Text style={styles.bodyText}>{deliveryDesc || description}</Text>\n            </>\n          )}\n        </View>\n      )}\n\n\n\n      {/* Kontrollpunkter */}\n      {checklistSections.length > 0 && (\n        <View style={styles.card}>\n          <Text style={styles.sectionTitle}>Kontrollpunkter</Text>\n          {checklistSections.map((section, idx) => (\n            <View key={idx} style={{ marginBottom: 8 }}>\n              {idx > 0 && <View style={styles.innerDivider} />}\n              <Text style={{ fontWeight: '600', fontSize: 15, color: '#444', marginBottom: 2 }}>{section.label}</Text>\n              {(section.items || []).map((item, i) => {\n                const pt = item?.text;\n                const st = item?.status;\n                const remediationKey = String(pt || '').trim();\n                const idxKey = String(item?.idx ?? '');\n                const remediation = (\n                  (section.remediation && section.remediation[remediationKey])\n                  || (section.remediation && idxKey && section.remediation[idxKey])\n                  || null\n                );\n                const isDeviation = st === 'avvikelse';\n                const isHandled = isDeviation && !!remediation;\n\n                const iconName = isDeviation\n                  ? (isHandled ? 'checkmark-circle' : 'alert-circle')\n                  : (st === 'ok' ? 'checkmark-circle' : (st === 'ejaktuell' ? 'remove-circle-outline' : 'ellipse-outline'));\n                const iconColor = isDeviation\n                  ? (isHandled ? '#388E3C' : '#D32F2F')\n                  : (st === 'ok' ? '#388E3C' : (st === 'ejaktuell' ? '#757575' : '#9E9E9E'));\n                const textColor = isDeviation\n                  ? (isHandled ? '#1976D2' : '#D32F2F')\n                  : '#222';\n\n                return (\n                  <View key={i} style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 2, flexWrap: 'wrap' }}>\n                    <Ionicons name={iconName} size={18} color={iconColor} style={{ marginRight: 6, marginTop: 1 }} />\n                    <View style={{ flex: 1 }}>\n                      <Text style={[styles.bodyText, { color: textColor, flexWrap: 'wrap' }]}>{pt}</Text>\n                      {isHandled && remediation && (\n                        <Text style={{ fontSize: 12, color: '#888', marginTop: 2 }}>\n                          Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\n                        </Text>\n                      )}\n                    </View>\n                  </View>\n                );\n              })}\n            </View>\n          ))}\n        </View>\n      )}\n\n\n      {(() => {\n        // Gruppera avvikelser per sektion\n        const grouped = {};\n        checklistSections.forEach(section => {\n          const deviations = (section.items || []).filter(it => it && it.status === 'avvikelse');\n          if (deviations.length === 0) return;\n          if (!grouped[section.label]) grouped[section.label] = [];\n          deviations.forEach((item) => {\n            const pt = item?.text;\n            const idxKey = String(item?.idx ?? '');\n            grouped[section.label].push({\n              pt,\n              remediation: (\n                (section.remediation && section.remediation[String(pt || '').trim()])\n                || (section.remediation && idxKey && section.remediation[idxKey])\n                || null\n              )\n            });\n          });\n        });\n        const sectionLabels = Object.keys(grouped);\n        if (sectionLabels.length === 0) return null;\n        // Visa åtgärdsknapp endast för Skyddsrond\n        const isSkyddsrond = type === 'Skyddsrond';\n        return (\n          <>\n            <View style={styles.card}>\n              <Text style={styles.sectionTitle}>Avvikelser/risker:</Text>\n              {sectionLabels.map((label, idx) => (\n                <View key={label} style={{ marginBottom: 4 }}>\n                  <Text style={{ fontWeight: '600', color: '#444', marginBottom: 2 }}>{label}:</Text>\n                  {grouped[label].map((item, i) => {\n                    const { pt, remediation } = item;\n                    const isHandled = !!remediation;\n                    return (\n                      <View key={i} style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 2, flexWrap: 'wrap', marginLeft: 12 }}>\n                        <Ionicons name={isHandled ? \"checkmark-circle\" : \"alert-circle\"} size={18} color={isHandled ? \"#388E3C\" : \"#D32F2F\"} style={{ marginRight: 6, marginTop: 2 }} />\n                        <View style={{ flex: 1 }}>\n                          <Text style={[styles.bodyText, { color: isHandled ? '#222' : '#D32F2F', flexWrap: 'wrap' }]}>{pt}</Text>\n                          {isHandled && remediation && (\n                            <Text style={{ fontSize: 12, color: '#888', marginTop: 2 }}>\n                              Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\n                            </Text>\n                          )}\n                        </View>\n                        {isSkyddsrond && (\n                          isHandled ? (\n                            <TouchableOpacity\n                              style={{ marginLeft: 8, backgroundColor: '#FFC107', borderRadius: 6, paddingVertical: 4, paddingHorizontal: 10, flexDirection: 'row', alignItems: 'center' }}\n                              onPress={() => setActionModal({ visible: true, section: label, point: pt, img: remediation.img, comment: remediation.comment, signature: remediation.signature, name: remediation.name, date: remediation.date, infoMode: true })}\n                            >\n                              <Ionicons name=\"information-circle-outline\" size={16} color=\"#222\" style={{ marginRight: 4 }} />\n                              <Text style={{ color: '#222', fontSize: 13 }}>Info</Text>\n                            </TouchableOpacity>\n                          ) : (\n                            <TouchableOpacity\n                              style={{ marginLeft: 8, backgroundColor: '#1976D2', borderRadius: 6, paddingVertical: 4, paddingHorizontal: 10 }}\n                              onPress={() => setActionModal({ visible: true, section: label, point: pt, img: null, comment: '', signature: '', name: '', infoMode: false })}\n                            >\n                              <Text style={{ color: '#fff', fontSize: 13 }}>Åtgärda</Text>\n                            </TouchableOpacity>\n                          )\n                        )}\n                      </View>\n                    );\n                  })}\n                </View>\n              ))}\n            </View>\n\n            {/* Modal för åtgärd */}\n            <Modal\n              visible={actionModal.visible}\n              transparent\n              animationType=\"slide\"\n              onRequestClose={() => setActionModal(a => ({ ...a, visible: false, /* INGEN SPARLOGIK HÄR */ }))}\n            >\n              <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n                <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 22, width: 320, alignItems: 'center' }}>\n                  {/* X-stäng uppe till höger */}\n                  <TouchableOpacity\n                    style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n                    onPress={() => setActionModal(a => ({ ...a, visible: false, /* INGEN SPARLOGIK HÄR */ }))}\n                  >\n                    <Ionicons name=\"close\" size={26} color=\"#222\" />\n                  </TouchableOpacity>\n                  {actionModal.infoMode ? (\n                    <>\n                      <Text style={{ fontWeight: 'bold', fontSize: 18, marginBottom: 10 }}>Åtgärdsinfo</Text>\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 8, textAlign: 'center' }}>{actionModal.section}: {actionModal.point}</Text>\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 6 }}>Beskrivning:</Text>\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.comment}</Text>\n                      {actionModal.img && (\n                        <Image source={{ uri: actionModal.img }} style={{ width: 120, height: 90, borderRadius: 8, marginBottom: 10 }} />\n                      )}\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Namn:</Text>\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.name}</Text>\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Signatur:</Text>\n                      {actionModal.signature ? (\n                        <Image source={{ uri: actionModal.signature }} style={{ width: 80, height: 32, backgroundColor: '#fff', borderRadius: 4, marginBottom: 10 }} />\n                      ) : (\n                        <Text style={{ color: '#888', fontSize: 15, marginBottom: 10 }}>Ingen signatur</Text>\n                      )}\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Åtgärdat datum:</Text>\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 10 }}>{actionModal.date ? actionModal.date.slice(0, 10) : '-'}</Text>\n                    </>\n                  ) : (\n                    <>\n                      <Text style={{ fontWeight: 'bold', fontSize: 18, marginBottom: 6 }}>Åtgärda brist</Text>\n                      <Text style={{ fontSize: 15, color: '#222', marginBottom: 4, textAlign: 'center' }}>{actionModal.section}: {actionModal.point}</Text>\n                      <View style={{ width: '100%', marginBottom: 10 }}>\n                        <Text style={{ fontSize: 13, color: '#888', marginBottom: 4 }}>Datum:</Text>\n                        <TouchableOpacity\n                          activeOpacity={0.8}\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, backgroundColor: '#f3f3f3', marginBottom: 2 }}\n                          onLongPress={() => {\n                            Alert.prompt(\n                              'Ändra datum',\n                              'Skriv nytt datum (YYYY-MM-DD)',\n                              [\n                                {\n                                  text: 'Avbryt',\n                                  style: 'cancel',\n                                },\n                                {\n                                  text: 'OK',\n                                  onPress: (newDate) => {\n                                    if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(newDate)) {\n                                      Alert.alert('Fel', 'Datumet måste vara på formatet YYYY-MM-DD');\n                                      return;\n                                    }\n                                    const today = new Date().toISOString().slice(0, 10);\n                                    if (newDate > today) {\n                                      Alert.alert('Fel', 'Du kan inte välja ett datum i framtiden.');\n                                      return;\n                                    }\n                                    setActionModal(a => ({ ...a, date: newDate }));\n                                  },\n                                },\n                              ],\n                              'plain-text',\n                              actionModal.date || new Date().toISOString().slice(0, 10)\n                            );\n                          }}\n                        >\n                          <Text style={{ fontSize: 15, color: '#888' }}>{actionModal.date || new Date().toISOString().slice(0, 10)}</Text>\n                        </TouchableOpacity>\n                        <Text style={{ fontSize: 11, color: '#aaa', marginTop: 2 }}>Håll inne för att ändra datum</Text>\n                      </View>\n                      <Text style={{ fontSize: 14, color: '#555', marginBottom: 6 }}>Beskriv åtgärd:</Text>\n                      <View style={{ width: '100%', marginBottom: 10 }}>\n                        <TextInput\n                          value={actionModal.comment}\n                          onChangeText={t => setActionModal(a => ({ ...a, comment: t }))}\n                          placeholder=\"Beskriv vad som åtgärdats...\"\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, fontSize: 15, minHeight: 40, backgroundColor: '#fafbfc' }}\n                          multiline\n                          placeholderTextColor=\"#aaa\"\n                        />\n                      </View>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                        <TouchableOpacity\n                          style={{ backgroundColor: '#1976D2', borderRadius: 50, padding: 10, marginRight: 10 }}\n                          onPress={async () => {\n                            // Välj/tar foto\n                            // Dynamically import ImagePicker for camera capture\n                            if (!ImagePicker) {\n                              try { ImagePicker = await import('expo-image-picker'); } catch(e) { ImagePicker = null; }\n                            }\n                            const launch = (ImagePicker && typeof ImagePicker.launchCameraAsync === 'function') ? ImagePicker.launchCameraAsync : null;\n                            const mediaTypes = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images) ? ImagePicker.MediaTypeOptions.Images : undefined;\n                            const result = launch ? await launch({ mediaTypes: mediaTypes, quality: 0.7 }) : null;\n                            if (result && !result.canceled && result.assets && result.assets.length > 0) {\n                              setActionModal(a => ({ ...a, img: result.assets[0].uri }));\n                            }\n                          }}\n                        >\n                          <Ionicons name=\"camera\" size={24} color=\"#fff\" />\n                        </TouchableOpacity>\n                        {actionModal.img && (\n                          <Image source={{ uri: actionModal.img }} style={{ width: 60, height: 45, borderRadius: 8 }} />\n                        )}\n                      </View>\n                      <View style={{ width: '100%', marginBottom: 10 }}>\n                        <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Namn på åtgärdande person:</Text>\n                        <TextInput\n                          value={actionModal.name}\n                          onChangeText={t => setActionModal(a => ({ ...a, name: t }))}\n                          placeholder=\"Namn...\"\n                          style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, fontSize: 15, backgroundColor: '#fafbfc' }}\n                          placeholderTextColor=\"#aaa\"\n                        />\n                      </View>\n                      <View style={{ width: '100%', marginBottom: 10 }}>\n                        <Text style={{ fontSize: 14, color: '#555', marginBottom: 4 }}>Signatur:</Text>\n                        <TouchableOpacity\n                          style={{ flexDirection: 'row', alignItems: 'center', borderWidth: 1, borderColor: '#bbb', borderRadius: 6, padding: 8, backgroundColor: '#fafbfc', minHeight: 44 }}\n                          onPress={() => setActionModal(a => ({ ...a, showSignatureModal: true }))}\n                        >\n                          {actionModal.signature ? (\n                            <Image source={{ uri: actionModal.signature }} style={{ width: 80, height: 32, backgroundColor: '#fff', borderRadius: 4 }} />\n                          ) : (\n                            <>\n                              <Ionicons name=\"pencil\" size={20} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                              <Text style={{ color: '#888', fontSize: 15 }}>Tryck för signatur</Text>\n                            </>\n                          )}\n                        </TouchableOpacity>\n                        <SignatureModal\n                          visible={!!actionModal.showSignatureModal}\n                          onOK={uri => setActionModal(a => ({ ...a, signature: uri, showSignatureModal: false }))}\n                          onCancel={() => setActionModal(a => ({ ...a, showSignatureModal: false }))}\n                        />\n                      </View>\n                      <TouchableOpacity\n                        style={{\n                          flexDirection: 'row',\n                          alignItems: 'center',\n                          justifyContent: 'center',\n                          minHeight: 40,\n                          paddingVertical: 8,\n                          marginTop: 18,\n                          backgroundColor: (actionModal.comment && actionModal.name && actionModal.signature) ? '#1976D2' : '#e0e0e0',\n                          borderRadius: 8,\n                          shadowColor: '#1976D2',\n                          shadowOffset: { width: 0, height: 2 },\n                          shadowOpacity: 0.10,\n                          shadowRadius: 4,\n                        }}\n                        onPress={async () => {\n                          if (!(actionModal.comment && actionModal.name && actionModal.signature)) {\n                            // Visa alert med saknade fält\n                            const missing = [];\n                            if (!actionModal.comment) missing.push('Beskriv åtgärd');\n                            if (!actionModal.name) missing.push('Namn');\n                            if (!actionModal.signature) missing.push('Signatur');\n                            Alert.alert('Saknas', 'Följande fält måste fyllas i: ' + missing.join(', '));\n                            return;\n                          }\n                          // Immutabel kopia av checklistan och kontrollen\n                          const hasChecklist = Array.isArray(safeControl.checklist);\n                          const sourceChecklist = hasChecklist\n                            ? safeControl.checklist\n                            : (Array.isArray(safeControl.checklistSections) ? safeControl.checklistSections : []);\n\n                          let newChecklist = Array.isArray(sourceChecklist)\n                            ? sourceChecklist.map(s => ({ ...s, remediation: { ...(s && s.remediation ? s.remediation : {}) } }))\n                            : [];\n\n                          const sectionIdx = newChecklist.findIndex(s => (s && (s.label || s.title)) === actionModal.section);\n                          if (sectionIdx !== -1) {\n                            // Hitta exakt rätt punkttext (pt) i sektionen, trimma för säker matchning\n                            const pt = (newChecklist[sectionIdx].points || []).find(p => String(p || '').trim() === String(actionModal.point || '').trim());\n                            const remediationKey = String((pt || actionModal.point) || '').trim();\n                            const today = new Date().toISOString().slice(0, 10);\n                            const remediationDate = actionModal.date && /^\\d{4}-\\d{2}-\\d{2}$/.test(actionModal.date) ? actionModal.date : today;\n                            newChecklist[sectionIdx].remediation[remediationKey] = {\n                              comment: actionModal.comment,\n                              img: actionModal.img,\n                              signature: actionModal.signature,\n                              name: actionModal.name,\n                              date: remediationDate,\n                            };\n                          } else {\n                            Alert.alert('Fel', 'Kunde inte hitta sektionen för åtgärden.');\n                            return;\n                          }\n                          const updatedControl = {\n                            ...safeControl,\n                            ...(hasChecklist ? { checklist: newChecklist } : { checklistSections: newChecklist }),\n                            savedAt: new Date().toISOString(),\n                          };\n\n                          try {\n                            await upsertControlInStorage(updatedControl);\n                            setControlState(updatedControl);\n                            setActionModal(a => ({ ...a, visible: false }));\n                            Alert.alert('Åtgärd sparad', 'Din åtgärd har sparats.', [\n                              { text: 'OK' }\n                            ]);\n                          } catch(_e) {\n                            Alert.alert('Fel', 'Kunde inte spara åtgärden. Försök igen.');\n                          }\n                        }}\n                      >\n                        <Ionicons name=\"save-outline\" size={22} color={(actionModal.comment && actionModal.name && actionModal.signature) ? '#fff' : '#888'} style={{ marginRight: 8 }} />\n                        <Text style={{\n                          color: (actionModal.comment && actionModal.name && actionModal.signature) ? '#fff' : '#888',\n                          fontWeight: 'bold',\n                          fontSize: 17,\n                          letterSpacing: 0.5,\n                          textAlign: 'center',\n                        }}>Spara</Text>\n                      </TouchableOpacity>\n                    </>\n                  )}\n                </View>\n              </View>\n            </Modal>\n          </>\n        );\n      })()}\n\n      {/* Åtgärder vidtagna (om finns) tas bort, endast en rad ska visas */}\n\n      {/* Signaturer */}\n      {mottagningsSignatures.length > 0 && (\n        <View style={styles.card}>\n          <Text style={styles.sectionTitle}>Signaturer</Text>\n          {mottagningsSignatures.map((s, i) => (\n            <View key={i} style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n              <Ionicons name=\"pencil\" size={18} color=\"#1976D2\" style={{ marginRight: 8, marginTop: 2 }} />\n              <View style={{ flex: 1 }}>\n                <Text style={styles.bodyText}>{s?.name || 'Signerad'}</Text>\n                {s?.uri ? (\n                  <Image source={{ uri: s.uri }} style={{ width: 140, height: 52, marginTop: 6, backgroundColor: '#fff', borderRadius: 6, borderWidth: 1, borderColor: '#eee' }} resizeMode=\"contain\" />\n                ) : null}\n              </View>\n            </View>\n          ))}\n        </View>\n      )}\n\n      {/* Bifogade bilder */}\n      {mottagningsPhotos.length > 0 && (\n        <View style={styles.card}>\n          <Text style={styles.sectionTitle}>Bifogade bilder</Text>\n          <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 8 }}>\n            {mottagningsPhotos.map((img, idx) => {\n              const uri = img.uri || img;\n              return (\n                <TouchableOpacity\n                  key={idx}\n                  style={{ marginRight: 8 }}\n                  onPress={() => {\n                    setSelectedPhoto(uri);\n                    setPhotoModalVisible(true);\n                  }}\n                  accessibilityLabel=\"Visa bild i stor vy\"\n                >\n                  <Image source={{ uri }} style={{ width: 84, height: 84, borderRadius: 8, borderWidth: 1, borderColor: '#ddd', backgroundColor: '#eee' }} />\n                  {img.comment ? (\n                    <View style={{ position: 'absolute', left: 6, right: 6, bottom: 6, backgroundColor: 'rgba(0,0,0,0.45)', paddingVertical: 2, paddingHorizontal: 6, borderRadius: 6 }}>\n                      <Text numberOfLines={1} style={{ color: '#fff', fontSize: 12 }}>{img.comment}</Text>\n                    </View>\n                  ) : null}\n                </TouchableOpacity>\n              );\n            })}\n          </ScrollView>\n          <Modal\n            visible={photoModalVisible}\n            transparent={true}\n            animationType=\"fade\"\n            onRequestClose={() => setPhotoModalVisible(false)}\n          >\n            <Pressable style={styles.modalOverlay} onPress={() => setPhotoModalVisible(false)}>\n              <View style={styles.modalContent}>\n                {selectedPhoto && (\n                  <Image\n                    source={{ uri: selectedPhoto }}\n                    style={{ width: '100%', height: 350, borderRadius: 12, backgroundColor: '#000' }}\n                    resizeMode=\"contain\"\n                  />\n                )}\n                <Text style={{ color: '#fff', marginTop: 12, textAlign: 'center' }}>Tryck utanför bilden för att stänga</Text>\n              </View>\n            </Pressable>\n          </Modal>\n        </View>\n      )}\n\n    </View>\n  );\n\n  if (Platform.OS === 'web') {\n    return (\n      <View style={[styles.container, styles.webScrollRoot, { height: windowHeight || undefined }]}>\n        <View style={[styles.content, styles.contentWeb]}>\n          {pageContent}\n        </View>\n      </View>\n    );\n  }\n\n  return (\n    <ScrollView\n      style={styles.container}\n      contentContainerStyle={styles.content}\n    >\n      {pageContent}\n    </ScrollView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: { flex: 1, backgroundColor: '#fff' },\n  // RN-web does not reliably apply `overflowY`; use `overflow` to enable scrolling.\n  webScrollRoot: { overflow: 'auto', minHeight: 0 },\n  content: { padding: 16, paddingBottom: 24 },\n  contentWeb: { alignItems: 'flex-start' },\n  page: { width: '100%' },\n  pageWeb: { width: A4_WEB_MAX_WIDTH },\n\n  title: { fontSize: 22, fontWeight: 'bold', color: PRIMARY },\n  projectLine: { fontSize: 14, color: '#666', marginTop: 2 },\n  subInfo: { fontSize: 13, color: '#666', marginTop: 8 },\n  sectionTitle: { fontSize: 16, fontWeight: '700', color: PRIMARY, marginBottom: 10 },\n  bodyText: { fontSize: 15, color: '#222' },\n  noteText: { fontSize: 13, color: '#444', marginTop: 2 },\n\n  headerCard: {\n    borderWidth: 1,\n    borderColor: '#e0e0e0',\n    borderRadius: 14,\n    padding: 14,\n    backgroundColor: '#fff',\n    marginBottom: 12,\n  },\n  companyLogo: {\n    width: 260,\n    maxWidth: '100%',\n    height: 56,\n  },\n  companyLogoDivider: {\n    height: 1,\n    backgroundColor: '#e6e6e6',\n    marginTop: 10,\n    width: '100%',\n    alignSelf: 'stretch',\n  },\n  headerTopRow: {\n    flexDirection: 'row',\n    alignItems: 'flex-start',\n    justifyContent: 'space-between',\n  },\n  headerTitleRow: { flexDirection: 'row', alignItems: 'center', flex: 1, paddingRight: 8 },\n  headerActionBtn: { padding: 6, marginLeft: 8 },\n\n  projectBar: {\n    marginTop: 10,\n    paddingVertical: 10,\n    paddingHorizontal: 12,\n    borderRadius: 10,\n    backgroundColor: '#f6f6f6',\n    borderWidth: 1,\n    borderColor: '#ededed',\n  },\n  projectBarText: {\n    fontSize: 13,\n    color: '#333',\n    fontWeight: '700',\n    letterSpacing: 0.4,\n  },\n\n  metaRow: { flexDirection: 'row', alignItems: 'center', marginTop: 10, justifyContent: 'space-between' },\n  metaItem: { flexDirection: 'row', alignItems: 'center', flexShrink: 1 },\n  metaText: { fontSize: 14, color: '#222' },\n\n  statusPill: { paddingVertical: 6, paddingHorizontal: 10, borderRadius: 999, borderWidth: 1 },\n  statusPillDone: { backgroundColor: '#E8F5E9', borderColor: '#43A047' },\n  statusPillOngoing: { backgroundColor: '#FFF8E1', borderColor: '#FFD600' },\n  statusPillText: { fontSize: 13, fontWeight: '700' },\n  statusPillTextDone: { color: '#2E7D32' },\n  statusPillTextOngoing: { color: '#222' },\n\n  card: {\n    borderWidth: 1,\n    borderColor: '#e0e0e0',\n    borderRadius: 14,\n    padding: 14,\n    backgroundColor: '#fff',\n    marginTop: 12,\n  },\n  innerDivider: { height: 1, backgroundColor: '#eee', marginVertical: 10 },\n\n  overviewCard: {\n    borderWidth: 1,\n    borderColor: '#e0e0e0',\n    borderRadius: 14,\n    padding: 14,\n    backgroundColor: '#fff',\n    marginBottom: 12,\n  },\n  overviewRow: {\n    flexDirection: 'row',\n    alignItems: 'flex-start',\n    justifyContent: 'flex-start',\n  },\n  overviewRowDivider: {\n    height: 1,\n    backgroundColor: '#eee',\n    marginVertical: 10,\n  },\n  overviewLabel: {\n    fontSize: 13,\n    color: '#444',\n    fontWeight: '700',\n    width: 145,\n    paddingRight: 10,\n  },\n  overviewValueWrap: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'flex-start',\n    flex: 1,\n  },\n  metaIconWrap: { width: 22, alignItems: 'center', marginRight: 8 },\n  metaMultiLineRow: { flexDirection: 'row', alignItems: 'center', marginBottom: 4 },\n  participantTableRow: { flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 },\n  participantColName: { width: 170, paddingRight: 10 },\n  participantColCompany: { width: 170, paddingRight: 10 },\n  participantColRole: { width: 160, paddingRight: 10 },\n  participantColMobile: { width: 120 },\n  overviewValue: {\n    fontSize: 13,\n    color: '#333',\n    flexShrink: 1,\n  },\n\n  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.85)', justifyContent: 'center', padding: 16 },\n  modalContent: { alignItems: 'center' },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ControlForm.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/EgenkontrollScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/FuktmätningScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/HomeScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":50,"column":71,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":72},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":53,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":54,"column":126,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":127},{"ruleId":"no-unused-vars","severity":1,"message":"'handleAdminTitlePress' is defined but never used.","line":222,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":222,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleAdminTitlePress"},"fix":{"range":[9726,9900],"text":""},"desc":"Remove unused variable 'handleAdminTitlePress'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1657,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":1657,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1666,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":1666,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'changed' is assigned a value but never used.","line":1681,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1681,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1742,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":1742,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has missing dependencies: 'authClaims?.companyId', 'companyId', 'controlTypeOptions', and 'routeCompanyId'. Either include them or remove the dependency array.","line":3282,"column":6,"nodeType":"ArrayExpression","endLine":3282,"endColumn":180,"suggestions":[{"desc":"Update the dependencies array to be: [contextMenu.target, renameMainFolderWeb, deleteMainFolderGuarded, renameSubFolderWeb, deleteSubFolder, requestProjectSwitch, copyProjectWeb, renameProjectWeb, deleteProject, controlTypeOptions, companyId, routeCompanyId, authClaims?.companyId]","fix":{"range":[140881,141055],"text":"[contextMenu.target, renameMainFolderWeb, deleteMainFolderGuarded, renameSubFolderWeb, deleteSubFolder, requestProjectSwitch, copyProjectWeb, renameProjectWeb, deleteProject, controlTypeOptions, companyId, routeCompanyId, authClaims?.companyId]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'top' is assigned a value but never used.","line":3423,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":3423,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3439,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":3439,"endColumn":27},{"ruleId":"no-unused-vars","severity":1,"message":"'subtitle' is assigned a value but never used.","line":3565,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":3565,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"subtitle"},"fix":{"range":[160748,160862],"text":""},"desc":"Remove unused variable 'subtitle'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has missing dependencies: 'dashboardActivityListItemStyle', 'dashboardActivityMetaCompactStyle', 'dashboardActivityTitleCompactStyle', 'dashboardCardStyle', 'dashboardDropdownRowKey', 'dashboardLinkTitleStyle', 'dashboardStatDotStyle', 'dashboardStatLabelStyle', 'dashboardStatRowStyle', 'dashboardStatValueStyle', and 'toggleDashboardFocus'. Either include them or remove the dependency array.","line":3659,"column":8,"nodeType":"ArrayExpression","endLine":3684,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [dashboardSectionTitleStyle, dashboardCardStyle, dashboardOverview.activeProjects, dashboardOverview.controlsToSign, dashboardOverview.drafts, hierarchy, dashboardFocus, dashboardDropdownAnchor, webPaneHeight, dashboardLoading, dashboardEmptyTextStyle, dashboardCardDenseStyle, dashboardRecent, dashboardHoveredStatKey, dashboardStatRowStyle, dashboardStatDotStyle, dashboardStatLabelStyle, dashboardStatValueStyle, toggleDashboardFocus, dashboardDropdownRowKey, dashboardDropdownTop, dashboardActiveProjectsList, dashboardListItemStyle, dashboardLinkTitleStyle, requestProjectSwitch, dashboardControlsToSignItems, dashboardDraftItems, findProjectById, dashboardMetaTextStyle, formatRelativeTime, dashboardOpenDeviationItems, dashboardUpcomingSkyddsrondItems, dashboardActivityListItemStyle, dashboardActivityTitleCompactStyle, dashboardActivityMetaCompactStyle]","fix":{"range":[165894,166657],"text":"[dashboardSectionTitleStyle, dashboardCardStyle, dashboardOverview.activeProjects, dashboardOverview.controlsToSign, dashboardOverview.drafts, hierarchy, dashboardFocus, dashboardDropdownAnchor, webPaneHeight, dashboardLoading, dashboardEmptyTextStyle, dashboardCardDenseStyle, dashboardRecent, dashboardHoveredStatKey, dashboardStatRowStyle, dashboardStatDotStyle, dashboardStatLabelStyle, dashboardStatValueStyle, toggleDashboardFocus, dashboardDropdownRowKey, dashboardDropdownTop, dashboardActiveProjectsList, dashboardListItemStyle, dashboardLinkTitleStyle, requestProjectSwitch, dashboardControlsToSignItems, dashboardDraftItems, findProjectById, dashboardMetaTextStyle, formatRelativeTime, dashboardOpenDeviationItems, dashboardUpcomingSkyddsrondItems, dashboardActivityListItemStyle, dashboardActivityTitleCompactStyle, dashboardActivityMetaCompactStyle]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'initials' is assigned a value but never used.","line":4273,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":4273,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"initials"},"fix":{"range":[197744,197951],"text":""},"desc":"Remove unused variable 'initials'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'top' is assigned a value but never used.","line":5151,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":5151,"endColumn":46},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5163,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":5163,"endColumn":49}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'companyAdmins', 'loadCompanyAdmins', and 'loadingCompanyAdmins'. Either include them or remove the dependency array.","line":399,"column":6,"nodeType":"ArrayExpression","endLine":399,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [companyAdmins, loadCompanyAdmins, loadingCompanyAdmins, newProjectModal?.visible, routeCompanyId]","fix":{"range":[17716,17758],"text":"[companyAdmins, loadCompanyAdmins, loadingCompanyAdmins, newProjectModal?.visible, routeCompanyId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-unused-vars","severity":1,"message":"'removeLastMainFolder' is assigned a value but never used.","line":1473,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1473,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_countProjects' is defined but never used.","line":1484,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":1484,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"_countProjects"},"fix":{"range":[69737,70163],"text":""},"desc":"Remove unused variable '_countProjects'."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'routeCompanyId'. Either include it or remove the dependency array. Outer scope values like 'auth.currentUser.uid' aren't valid dependencies because mutating them doesn't re-render the component.","line":2447,"column":6,"nodeType":"ArrayExpression","endLine":2447,"endColumn":41,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, routeCompanyId]","fix":{"range":[109407,109442],"text":"[companyId, routeCompanyId]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'companyId' and 'route.params.uid'. Either include them or remove the dependency array.","line":2724,"column":6,"nodeType":"ArrayExpression","endLine":2724,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, route.params.uid]","fix":{"range":[120603,120605],"text":"[companyId, route.params.uid]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_kontrollKnappStil' is assigned a value but never used.","line":3307,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":3307,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"_kontrollKnappStil"},"fix":{"range":[141891,142303],"text":""},"desc":"Remove unused variable '_kontrollKnappStil'."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"no-unused-vars","severity":1,"message":"'_kontrollTextStil' is assigned a value but never used.","line":3309,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":3309,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"_kontrollTextStil"},"fix":{"range":[142347,142455],"text":""},"desc":"Remove unused variable '_kontrollTextStil'."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { getDownloadURL, ref as storageRef } from 'firebase/storage';\nimport React, { useEffect, useRef, useState } from 'react';\nimport { Alert, Animated, Easing, Image, ImageBackground, Keyboard, KeyboardAvoidingView, Modal, PanResponder, Platform, Pressable, ScrollView, Switch, Text, TextInput, TouchableOpacity, useWindowDimensions, View } from 'react-native';\nimport ContextMenu from '../components/ContextMenu';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenu from '../components/HeaderUserMenu';\nimport { auth, DEFAULT_CONTROL_TYPES, fetchCompanyControlTypes, fetchCompanyMallar, fetchCompanyMembers, fetchCompanyProfile, fetchControlsForProject, fetchHierarchy, fetchUserProfile, logCompanyActivity, saveControlToFirestore, saveDraftToFirestore, saveHierarchy, saveUserProfile, storage, subscribeCompanyActivity, subscribeCompanyMembers, upsertCompanyMember } from '../components/firebase';\nimport { formatPersonName } from '../components/formatPersonName';\nimport { onProjectUpdated } from '../components/projectBus';\nimport useBackgroundSync from '../hooks/useBackgroundSync';\nimport ProjectDetails from './ProjectDetails';\nimport TemplateControlScreen from './TemplateControlScreen';\nlet createPortal = null;\nif (Platform.OS === 'web') {\n  try { createPortal = require('react-dom').createPortal; } catch(_e) { createPortal = null; }\n}\nlet portalRootId = 'dk-header-portal';\n\nfunction isValidIsoDateYmd(value) {\n  const v = String(value || '').trim();\n  if (!v) return true;\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\n  const [yStr, mStr, dStr] = v.split('-');\n  const y = Number(yStr);\n  const m = Number(mStr);\n  const d = Number(dStr);\n  if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;\n  if (m < 1 || m > 12) return false;\n  if (d < 1 || d > 31) return false;\n  const dt = new Date(Date.UTC(y, m - 1, d));\n  return dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === d;\n}\n\n// App version (displayed in sidebar)\nlet appVersion = '1.0.0';\ntry {\n  const pkg = require('../package.json');\n  if (pkg && pkg.version) appVersion = String(pkg.version);\n} catch (e) {\n  try { Alert.alert('Fel', 'Kunde inte läsa package.json: ' + (e?.message || String(e))); } catch(_e) {}\n}\n\n// showAlert: use Alert.alert on native, fallback to window.alert on web so support buttons work in browser\nfunction showAlert(title, message, buttons) {\n  try {\n    if (Platform && Platform.OS === 'web' && typeof window !== 'undefined' && typeof window.alert === 'function') {\n      const msg = (typeof message === 'string') ? message : (message && typeof message === 'object' ? JSON.stringify(message, null, 2) : String(message));\n      try { window.alert(String(title || '') + '\\n\\n' + msg); } catch(e) { /* ignore */ }\n      return;\n    }\n  } catch(e) {}\n  try { if (buttons) Alert.alert(title || '', message || '', buttons); else Alert.alert(title || '', message || ''); } catch(e) {}\n}\n\nexport default function HomeScreen({ route, navigation }) {\n  const { height: windowHeight } = useWindowDimensions();\n  const [headerHeight, setHeaderHeight] = useState(0);\n  const leftTreeScrollRef = useRef(null);\n  const rightPaneScrollRef = useRef(null);\n  const activityScrollRef = useRef(null);\n  const hierarchyRef = useRef([]);\n  const [spinSidebarHome, setSpinSidebarHome] = useState(0);\n  const [spinSidebarRefresh, setSpinSidebarRefresh] = useState(0);\n  const [spinSidebarFilter, setSpinSidebarFilter] = useState(0);\n  const filterSpinAnim = useRef(new Animated.Value(0)).current;\n  const searchSpinAnim = useRef(new Animated.Value(0)).current;\n  const mainChevronSpinAnim = useRef({}).current; // per-huvudmapp\n  const subChevronSpinAnim = useRef({}).current;  // per-undermapp\n\n  const spinOnce = (anim) => {\n    if (!anim) return;\n    try { anim.setValue(0); } catch(_e) {}\n      try {\n      Animated.timing(anim, {\n        toValue: 1,\n        duration: 300,\n        easing: Easing.out(Easing.ease),\n        useNativeDriver: (Platform && Platform.OS === 'web') ? false : true,\n      }).start();\n    } catch(_e) {}\n  };\n\n  // Small press feedback row used for task/control rows\n  function AnimatedRow({ children, onPress, style }) {\n    const scale = useRef(new Animated.Value(1)).current;\n    const pressIn = () => {\n      try { Animated.timing(scale, { toValue: 0.985, duration: 120, useNativeDriver: (Platform && Platform.OS === 'web') ? false : true }).start(); } catch(_e) {}\n    };\n    const pressOut = () => {\n      try { Animated.timing(scale, { toValue: 1, duration: 120, useNativeDriver: (Platform && Platform.OS === 'web') ? false : true }).start(); } catch(_e) {}\n    };\n    return (\n      <Pressable onPressIn={pressIn} onPressOut={pressOut} onPress={onPress}>\n        <Animated.View style={[{ transform: [{ scale }] }, style]}>\n          {children}\n        </Animated.View>\n      </Pressable>\n    );\n  }\n\n  const filterRotate = filterSpinAnim.interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] });\n  const searchRotate = searchSpinAnim.interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] });\n  const [tasksOpen, setTasksOpen] = useState(true);\n  const [controlsOpen, setControlsOpen] = useState(false);\n  \n  // Close header search on Escape key (web)\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    const keyHandler = (e) => {\n      try {\n        if (e && (e.key === 'Escape' || e.key === 'Esc')) {\n          try { navigation?.setParams?.({ headerSearchOpen: false, headerSearchKeepConnected: true }); } catch(_e) {}\n        }\n      } catch(_e) {}\n    };\n\n    const closeOnScrollOrResize = () => {\n      try { navigation?.setParams?.({ headerSearchOpen: false, headerSearchKeepConnected: false }); } catch(_e) {}\n    };\n\n    try { window.addEventListener('keydown', keyHandler); } catch(_e) {}\n    try { window.addEventListener('scroll', closeOnScrollOrResize, { passive: true }); } catch(_e) {}\n    try { window.addEventListener('resize', closeOnScrollOrResize); } catch(_e) {}\n\n    return () => {\n      try { window.removeEventListener('keydown', keyHandler); } catch(_e) {}\n      try { window.removeEventListener('scroll', closeOnScrollOrResize); } catch(_e) {}\n      try { window.removeEventListener('resize', closeOnScrollOrResize); } catch(_e) {}\n    };\n  }, [navigation]);\n\n  const webPaneHeight = Platform.OS === 'web'\n    ? Math.max(240, (windowHeight || 800) - (headerHeight || 140))\n    : undefined;\n\n  const scrollToEndSafe = (ref) => {\n    const node = ref?.current;\n    if (!node) return;\n    try {\n      if (typeof node.scrollToEnd === 'function') node.scrollToEnd({ animated: true });\n      else if (typeof node.scrollTo === 'function') node.scrollTo({ y: 1e9, animated: true });\n    } catch(_e) {}\n  };\n\n  // companyId state is declared later in this component; referencing it early can crash on web.\n  // Use the route param as the safe early value for Firestore lookups.\n  const routeCompanyId = route?.params?.companyId || '';\n  // Testdata för demo-kontot (används av dold admin-knapp)\n  const testHierarchy = [\n    {\n      id: 'main1',\n      name: 'Byggprojekt',\n      expanded: false,\n      children: [\n        {\n          id: 'sub1',\n          name: 'Stockholm',\n          expanded: false,\n          children: [\n            { id: 'P-1001', name: 'Projekt Slussen', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\n            { id: 'P-1002', name: 'Projekt Hammarby', type: 'project', status: 'completed', createdAt: new Date().toISOString() }\n          ]\n        },\n        {\n          id: 'sub2',\n          name: 'Göteborg',\n          expanded: false,\n          children: [\n            { id: 'P-2001', name: 'Projekt Gamlestaden', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\n            { id: 'P-2002', name: 'Projekt Mölndal', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() }\n          ]\n        }\n      ]\n    },\n    {\n      id: 'main2',\n      name: 'Serviceprojekt',\n      expanded: false,\n      children: [\n        {\n          id: 'sub3',\n          name: 'Malmö',\n          expanded: false,\n          children: [\n            { id: 'P-3001', name: 'Projekt Limhamn', type: 'project', status: 'completed', createdAt: new Date().toISOString() },\n            { id: 'P-3002', name: 'Projekt Hyllie', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() }\n          ]\n        },\n        {\n          id: 'sub4',\n          name: 'Uppsala',\n          expanded: false,\n          children: [\n            { id: 'P-4001', name: 'Projekt Gränby', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() },\n            { id: 'P-4002', name: 'Projekt Fyrislund', type: 'project', status: 'completed', createdAt: new Date().toISOString() }\n          ]\n        }\n      ]\n    }\n  ];\n\n  // Helper: collapse all expanded flags in a hierarchy (used on initial load)\n  const collapseHierarchy = (items) => {\n    if (!Array.isArray(items)) return [];\n    return items.map(m => ({\n      ...m,\n      expanded: false,\n      children: Array.isArray(m.children) ? m.children.map(s => ({\n        ...s,\n        expanded: false,\n        children: Array.isArray(s.children) ? s.children.map(ch => ({ ...ch })) : [],\n      })) : [],\n    }));\n  };\n  // Admin unlock (tap title 5 times)\n  const [, setAdminTapCount] = useState(0);\n  const [showAdminButton, setShowAdminButton] = useState(false);\n  const [adminActionRunning, setAdminActionRunning] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  function handleAdminTitlePress() {\n    setAdminTapCount(c => {\n      if (c >= 4) {\n        setShowAdminButton(true);\n        return 0;\n      }\n      return c + 1;\n    });\n  }\n\n  // Support/debug tools should not be visible in normal UI.\n  // Shown only in development or after explicit admin-unlock.\n  const showSupportTools = __DEV__ || showAdminButton;\n\n  // Extra restriction: only show support/debug tools for admins, or for the dedicated demo company.\n  // This keeps normal companies/users clean while still enabling dev workflows.\n  const [authClaims, setAuthClaims] = useState(null);\n\n  React.useEffect(() => {\n    let active = true;\n    async function refreshClaims() {\n      try {\n        const user = auth?.currentUser;\n        if (!user) {\n          if (active) setAuthClaims(null);\n          return;\n        }\n        const tokenRes = await user.getIdTokenResult(false).catch((e) => null);\n        if (active) setAuthClaims(tokenRes?.claims || null);\n      } catch(_e) {\n        if (active) setAuthClaims(null);\n      }\n    }\n\n    refreshClaims();\n    const unsub = auth?.onAuthStateChanged ? auth.onAuthStateChanged(() => { refreshClaims(); }) : null;\n    return () => {\n      active = false;\n      try { if (typeof unsub === 'function') unsub(); } catch(_e) {}\n    };\n  }, []);\n\n  const isAdminUser = !!(authClaims && (authClaims.admin === true || authClaims.role === 'admin'));\n  // IMPORTANT: companyId state is initialized later in this component.\n  // Do not reference it here (TDZ on web). Use claims/route params instead.\n  const debugCompanyId = String(authClaims?.companyId || routeCompanyId || '').trim();\n  const isDemoCompany = debugCompanyId === 'MS Byggsystem DEMO' || debugCompanyId === 'demo-service' || debugCompanyId === 'demo-company';\n  // Only show support tools for:\n  // - Demo company (all users)\n  // - MS Byggsystem admins (dev accounts)\n  // This prevents other-company admins from seeing dev tools.\n  const isMsByggsystemCompany = debugCompanyId === 'MS Byggsystem';\n  const canShowSupportToolsInHeader = !!(showSupportTools && (isDemoCompany || (isMsByggsystemCompany && isAdminUser)));\n  \n  // Dev-only: promote current user to demo/admin and load test hierarchy\n  async function handleMakeDemoAdmin() {\n    if (!__DEV__) return;\n    if (adminActionRunning) return;\n    setAdminActionRunning(true);\n    try {\n      const user = auth.currentUser;\n      const demoCompanyId = 'demo-company';\n        if (user) {\n        await saveUserProfile(user.uid, {\n          companyId: demoCompanyId,\n          role: 'admin',\n          displayName: user.email ? user.email.split('@')[0] : 'Demo Admin',\n          email: user.email || null,\n          updatedAt: new Date().toISOString()\n        });\n        await AsyncStorage.setItem('dk_companyId', demoCompanyId);\n        setCompanyId(demoCompanyId);\n        setHierarchy(collapseHierarchy(testHierarchy));\n      }\n    } catch(_e) {\n      console.log('[Home] make demo admin error', _e?.message || _e);\n    } finally {\n      setAdminActionRunning(false);\n      setShowAdminButton(false);\n    }\n  }\n\n  // Filtrera bort projekt med namnet '22 test' vid render\n  React.useEffect(() => {\n    setHierarchy(prev => prev.map(main => ({\n      ...main,\n      children: main.children.map(sub => ({\n        ...sub,\n        children: sub.children ? sub.children.filter(child => !(child.type === 'project' && child.name.trim().toLowerCase() === '22 test')) : []\n      }))\n    })));\n  }, []);\n  // State för nytt projekt-modal i undermapp\n  const [newProjectModal, setNewProjectModal] = useState({ visible: false, parentSubId: null });\n  const [newProjectName, setNewProjectName] = useState(\"\");\n  const [newProjectNumber, setNewProjectNumber] = useState(\"\");\n  const [newProjectResponsible, setNewProjectResponsible] = useState(null);\n  const [responsiblePickerVisible, setResponsiblePickerVisible] = useState(false);\n  const [newProjectParticipants, setNewProjectParticipants] = useState([]);\n  const [participantsPickerVisible, setParticipantsPickerVisible] = useState(false);\n  const [companyAdmins, setCompanyAdmins] = useState([]);\n  const [loadingCompanyAdmins, setLoadingCompanyAdmins] = useState(false);\n  const [newProjectKeyboardLockHeight, setNewProjectKeyboardLockHeight] = useState(0);\n  const [, setCompanyAdminsLastFetchAt] = useState(0);\n  const companyAdminsUnsubRef = useRef(null);\n  const [companyAdminsPermissionDenied, setCompanyAdminsPermissionDenied] = useState(false);\n\n  const [newProjectSkyddsrondEnabled, setNewProjectSkyddsrondEnabled] = useState(true);\n  const [newProjectSkyddsrondWeeks, setNewProjectSkyddsrondWeeks] = useState(2);\n  const [newProjectSkyddsrondFirstDueDate, setNewProjectSkyddsrondFirstDueDate] = useState('');\n  const [skyddsrondWeeksPickerVisible, setSkyddsrondWeeksPickerVisible] = useState(false);\n\n  const newProjectSkyddsrondFirstDueTrim = String(newProjectSkyddsrondFirstDueDate || '').trim();\n  const newProjectSkyddsrondFirstDueValid = (!newProjectSkyddsrondEnabled)\n    || (newProjectSkyddsrondFirstDueTrim !== '' && isValidIsoDateYmd(newProjectSkyddsrondFirstDueTrim));\n\n  const resetProjectFields = React.useCallback(() => {\n    try { setNewProjectName(''); } catch(_e) {}\n    try { setNewProjectNumber(''); } catch(_e) {}\n    try { setNewProjectResponsible(null); } catch(_e) {}\n    try { setResponsiblePickerVisible(false); } catch(_e) {}\n    try { setNewProjectKeyboardLockHeight(0); } catch(_e) {}\n    try { setNewProjectSkyddsrondEnabled(true); } catch(_e) {}\n    try { setNewProjectSkyddsrondWeeks(2); } catch(_e) {}\n    try { setNewProjectSkyddsrondFirstDueDate(''); } catch(_e) {}\n    try { setSkyddsrondWeeksPickerVisible(false); } catch(_e) {}\n    try { setNewProjectParticipants([]); } catch(_e) {}\n    try { setParticipantsPickerVisible(false); } catch(_e) {}\n    // Best-effort: dismiss keyboard on native\n    try { if (Platform.OS !== 'web') Keyboard.dismiss(); } catch(_e) {}\n  }, []);\n\n  const loadCompanyAdmins = React.useCallback(async ({ force } = { force: false }) => {\n    try {\n      if (!routeCompanyId) return;\n      if (loadingCompanyAdmins && !force) return;\n      setLoadingCompanyAdmins(true);\n      setCompanyAdminsPermissionDenied(false);\n      // Ensure at least the current user is present in members directory\n      // (Inline to avoid any scope issues on native/web builds.)\n      try {\n        const user = auth?.currentUser;\n        if (user?.uid) {\n          const profile = await fetchUserProfile(user.uid).catch((e) => null);\n          const displayName = profile?.displayName || profile?.name || (user.email ? String(user.email).split('@')[0] : null);\n          const role = profile?.role || null;\n          await upsertCompanyMember({\n            companyId: routeCompanyId || null,\n            uid: user.uid,\n            displayName,\n            email: user.email || null,\n            role,\n          });\n        }\n      } catch(_e) {}\n      const admins = await fetchCompanyMembers(routeCompanyId, { role: 'admin' });\n      setCompanyAdmins(Array.isArray(admins) ? admins : []);\n      setCompanyAdminsLastFetchAt(Date.now());\n    } catch(_e) {\n      const msg = String(_e?.message || _e || '').toLowerCase();\n      if (_e?.code === 'permission-denied' || msg.includes('permission')) setCompanyAdminsPermissionDenied(true);\n      setCompanyAdmins([]);\n    } finally {\n      setLoadingCompanyAdmins(false);\n    }\n  }, [routeCompanyId, loadingCompanyAdmins]);\n\n  // If the create-project modal opens before companyId is ready, onShow can early-return.\n  // This effect ensures admins are fetched as soon as companyId is available while the modal is open.\n  React.useEffect(() => {\n    if (!newProjectModal?.visible) return;\n    if (!routeCompanyId) return;\n    // Avoid refetch loop; only fetch if we have nothing yet.\n    if (companyAdmins && companyAdmins.length > 0) return;\n    if (loadingCompanyAdmins) return;\n    loadCompanyAdmins({ force: false });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [newProjectModal?.visible, routeCompanyId]);\n\n  // While the ansvarig picker is open, subscribe to admins in realtime.\n  // This avoids the common \"empty cache\" problem on fresh logins.\n  React.useEffect(() => {\n    if (!responsiblePickerVisible) {\n      try { if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current(); } catch(_e) {}\n      companyAdminsUnsubRef.current = null;\n      return;\n    }\n    if (!routeCompanyId) return;\n\n    setLoadingCompanyAdmins(true);\n    setCompanyAdminsPermissionDenied(false);\n    try {\n      if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current();\n    } catch(_e) {}\n    companyAdminsUnsubRef.current = subscribeCompanyMembers(routeCompanyId, {\n      role: 'admin',\n      onData: (admins) => {\n        setCompanyAdmins(Array.isArray(admins) ? admins : []);\n        setCompanyAdminsLastFetchAt(Date.now());\n        setLoadingCompanyAdmins(false);\n      },\n      onError: (err) => {\n        const msg = String(err?.message || err || '').toLowerCase();\n        if (err?.code === 'permission-denied' || msg.includes('permission')) setCompanyAdminsPermissionDenied(true);\n        setLoadingCompanyAdmins(false);\n      }\n    });\n\n    return () => {\n      try { if (companyAdminsUnsubRef.current) companyAdminsUnsubRef.current(); } catch(_e) {}\n      companyAdminsUnsubRef.current = null;\n    };\n  }, [responsiblePickerVisible, routeCompanyId]);\n\n  // Track native keyboard height for the create-project modal.\n  // We keep this separate from the search modal keyboard handling to avoid stale/reset values.\n  const [nativeKeyboardHeight, setNativeKeyboardHeight] = useState(0);\n  const nativeKeyboardHeightRef = useRef(0);\n\n  React.useEffect(() => {\n    if (Platform.OS === 'web') return;\n    const subs = [];\n    const onShow = (e) => {\n      const h = e?.endCoordinates?.height || 0;\n      nativeKeyboardHeightRef.current = h;\n      setNativeKeyboardHeight(h);\n    };\n    const onHide = () => {\n      nativeKeyboardHeightRef.current = 0;\n      setNativeKeyboardHeight(0);\n    };\n\n    subs.push(Keyboard.addListener('keyboardWillShow', onShow));\n    subs.push(Keyboard.addListener('keyboardWillHide', onHide));\n    subs.push(Keyboard.addListener('keyboardDidShow', onShow));\n    subs.push(Keyboard.addListener('keyboardDidHide', onHide));\n\n    return () => {\n      for (const s of subs) {\n        try { s.remove(); } catch(_e) {}\n      }\n    };\n  }, []);\n\n  // Modal för nytt projekt i undermapp (läggs utanför return)\n  // State for project selection modal (for creating controls)\n  const [selectProjectModal, setSelectProjectModal] = useState({ visible: false, type: null });\n  const [showControlTypeModal, setShowControlTypeModal] = useState(false);\n  const [controlTypeScrollMetrics, setControlTypeScrollMetrics] = useState({\n    containerHeight: 0,\n    contentHeight: 0,\n    scrollY: 0,\n  });\n  const controlTypeCanScroll = controlTypeScrollMetrics.contentHeight > (controlTypeScrollMetrics.containerHeight + 1);\n  const controlTypeThumbHeight = React.useMemo(() => {\n    const { containerHeight, contentHeight } = controlTypeScrollMetrics;\n    if (!containerHeight || !contentHeight || contentHeight <= containerHeight) return 0;\n    const ratio = containerHeight / contentHeight;\n    return Math.max(28, containerHeight * ratio);\n  }, [controlTypeScrollMetrics]);\n  const controlTypeThumbTop = React.useMemo(() => {\n    const { containerHeight, contentHeight, scrollY } = controlTypeScrollMetrics;\n    if (!containerHeight || !contentHeight || contentHeight <= containerHeight) return 0;\n    const maxScroll = Math.max(1, contentHeight - containerHeight);\n    const progress = Math.min(1, Math.max(0, scrollY / maxScroll));\n    return (containerHeight - controlTypeThumbHeight) * progress;\n  }, [controlTypeScrollMetrics, controlTypeThumbHeight]);\n  const [projectControlModal, setProjectControlModal] = useState({ visible: false, project: null });\n  const [projectControlSelectedType, setProjectControlSelectedType] = useState('');\n  const [projectControlTypePickerOpen, setProjectControlTypePickerOpen] = useState(false);\n  const [projectControlTemplates, setProjectControlTemplates] = useState([]);\n  const [projectControlSelectedTemplateId, setProjectControlSelectedTemplateId] = useState('');\n  const [projectControlTemplatePickerOpen, setProjectControlTemplatePickerOpen] = useState(false);\n  const [projectControlTemplateSearch, setProjectControlTemplateSearch] = useState('');\n\n  // Check that a project number/id is unique across the whole hierarchy.\n  // Must be declared before any JSX/constants that reference it (RN-web TDZ).\n  const isProjectNumberUnique = React.useCallback((num) => {\n    if (!num) return true;\n    const n = String(num ?? '').trim();\n    if (!n) return true;\n    try {\n      for (const main of (hierarchyRef.current || [])) {\n        for (const sub of (main.children || [])) {\n          if (Array.isArray(sub.children) && sub.children.some(child => child?.type === 'project' && String(child.id) === n)) {\n            return false;\n          }\n        }\n      }\n    } catch(_e) {}\n    return true;\n  }, []);\n\n  const newProjectModalComponent = (\n    <Modal\n      visible={newProjectModal.visible}\n      transparent\n      animationType=\"fade\"\n      onShow={async () => {\n        // Fetch admins when the modal opens\n        await loadCompanyAdmins({ force: false });\n      }}\n      onRequestClose={() => {\n        setNewProjectModal({ visible: false, parentSubId: null });\n        resetProjectFields();\n        setNewProjectKeyboardLockHeight(0);\n      }}\n    >\n      {Platform.OS === 'web' ? (\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <Pressable\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n            onPress={() => {\n              setNewProjectModal({ visible: false, parentSubId: null });\n              resetProjectFields();\n            }}\n          />\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <TouchableOpacity\n              style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n              onPress={() => {\n                setNewProjectModal({ visible: false, parentSubId: null });\n                resetProjectFields();\n              }}\n              hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n            >\n              <Ionicons name=\"close\" size={26} color=\"#222\" />\n            </TouchableOpacity>\n\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center', marginTop: 6 }}>Skapa nytt projekt</Text>\n\n            <TextInput\n              value={newProjectNumber}\n              onChangeText={(v) => {\n                // RN-web can sometimes deliver an event object; normalize to string to avoid crashes.\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n                setNewProjectNumber(String(next));\n              }}\n              placeholder=\"Projektnummer...\"\n              placeholderTextColor=\"#888\"\n              style={{\n                borderWidth: 1,\n                borderColor: String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) ? '#D32F2F' : '#e0e0e0',\n                borderRadius: 8,\n                padding: 10,\n                fontSize: 16,\n                marginBottom: 10,\n                backgroundColor: '#fafafa',\n                color: !isProjectNumberUnique(newProjectNumber) && String(newProjectNumber ?? '').trim() !== '' ? '#D32F2F' : '#222'\n              }}\n              autoFocus\n              keyboardType=\"default\"\n            />\n            {String(newProjectNumber ?? '').trim() !== '' && !isProjectNumberUnique(newProjectNumber) && (\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 4, marginBottom: 6 }}>\n                <Ionicons name=\"warning\" size={18} color=\"#D32F2F\" style={{ marginRight: 6 }} />\n                <Text style={{ color: '#D32F2F', fontSize: 15, fontWeight: 'bold' }}>Projektnummer används redan.</Text>\n              </View>\n            )}\n\n            <TextInput\n              value={newProjectName}\n              onChangeText={(v) => {\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n                setNewProjectName(String(next));\n              }}\n              placeholder=\"Projektnamn...\"\n              placeholderTextColor=\"#888\"\n              style={{\n                borderWidth: 1,\n                borderColor: String(newProjectName ?? '').trim() === '' ? '#D32F2F' : '#e0e0e0',\n                borderRadius: 8,\n                padding: 10,\n                fontSize: 16,\n                marginBottom: 12,\n                backgroundColor: '#fafafa',\n                color: '#222'\n              }}\n              keyboardType=\"default\"\n            />\n\n            {/* Ansvarig (required) */}\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n              Ansvarig\n            </Text>\n            <TouchableOpacity\n              style={{\n                borderWidth: 1,\n                borderColor: newProjectResponsible ? '#e0e0e0' : '#D32F2F',\n                borderRadius: 8,\n                paddingVertical: 10,\n                paddingHorizontal: 10,\n                marginBottom: 12,\n                backgroundColor: '#fafafa',\n                flexDirection: 'row',\n                alignItems: 'center',\n                justifyContent: 'space-between'\n              }}\n              onPress={() => setResponsiblePickerVisible(true)}\n              activeOpacity={0.8}\n            >\n              <Text style={{ fontSize: 16, color: newProjectResponsible ? '#222' : '#888' }} numberOfLines={1}>\n                {newProjectResponsible ? formatPersonName(newProjectResponsible) : 'Välj ansvarig...'}\n              </Text>\n              <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n            </TouchableOpacity>\n\n            {/* Deltagare (optional, multi-select) */}\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n              Deltagare\n            </Text>\n            <TouchableOpacity\n              style={{\n                borderWidth: 1,\n                borderColor: '#e0e0e0',\n                borderRadius: 8,\n                paddingVertical: 10,\n                paddingHorizontal: 10,\n                marginBottom: 12,\n                backgroundColor: '#fafafa',\n                flexDirection: 'row',\n                alignItems: 'center',\n                justifyContent: 'space-between'\n              }}\n              onPress={() => setParticipantsPickerVisible(true)}\n              activeOpacity={0.8}\n            >\n              <Text style={{ fontSize: 16, color: (newProjectParticipants && newProjectParticipants.length > 0) ? '#222' : '#888' }} numberOfLines={1}>\n                {(newProjectParticipants && newProjectParticipants.length > 0) ? newProjectParticipants.map(p => formatPersonName(p)).join(', ') : 'Välj deltagare...'}\n              </Text>\n              <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n            </TouchableOpacity>\n\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n              Första skyddsrond senast\n            </Text>\n            <TextInput\n              value={newProjectSkyddsrondFirstDueDate}\n              onChangeText={(v) => {\n                const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n                setNewProjectSkyddsrondFirstDueDate(String(next));\n              }}\n              placeholder=\"YYYY-MM-DD\"\n              placeholderTextColor=\"#888\"\n              editable={!!newProjectSkyddsrondEnabled}\n              style={{\n                borderWidth: 1,\n                borderColor: (!newProjectSkyddsrondFirstDueValid && newProjectSkyddsrondEnabled) ? '#D32F2F' : '#e0e0e0',\n                borderRadius: 8,\n                padding: 10,\n                fontSize: 16,\n                marginBottom: 12,\n                backgroundColor: '#fafafa',\n                color: '#222',\n                opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\n              }}\n            />\n\n            {newProjectSkyddsrondEnabled && !newProjectSkyddsrondFirstDueValid && (\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\n                Du måste fylla i datum (YYYY-MM-DD).\n              </Text>\n            )}\n\n            {!newProjectResponsible && (\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\n                Du måste välja ansvarig.\n              </Text>\n            )}\n\n            <Modal\n              visible={responsiblePickerVisible}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => setResponsiblePickerVisible(false)}\n            >\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n                <Pressable\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                  onPress={() => setResponsiblePickerVisible(false)}\n                />\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                    Välj ansvarig\n                  </Text>\n                  {loadingCompanyAdmins ? (\n                    <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\n                      Laddar...\n                    </Text>\n                  ) : (companyAdmins.length === 0 ? (\n                    <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                      Inga admins hittades i företaget.\n                    </Text>\n                  ) : (\n                    <ScrollView style={{ maxHeight: 420 }}>\n                      {companyAdmins.map((m) => (\n                        <TouchableOpacity\n                          key={m.id || m.uid || m.email}\n                          style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\n                          onPress={() => {\n                            setNewProjectResponsible({\n                              uid: m.uid || m.id,\n                              displayName: m.displayName || null,\n                              email: m.email || null,\n                              role: m.role || null,\n                            });\n                            setResponsiblePickerVisible(false);\n                          }}\n                        >\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                            {formatPersonName(m)}\n                          </Text>\n                        </TouchableOpacity>\n                      ))}\n                    </ScrollView>\n                  ))}\n\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                    onPress={() => setResponsiblePickerVisible(false)}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n\n          <Modal\n            visible={participantsPickerVisible}\n            transparent\n            animationType=\"fade\"\n            onRequestClose={() => {\n              setParticipantsPickerVisible(false);\n              setNewProjectKeyboardLockHeight(0);\n            }}\n          >\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n              <Pressable\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                onPress={() => {\n                  setParticipantsPickerVisible(false);\n                  setNewProjectKeyboardLockHeight(0);\n                }}\n              />\n              <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                  Välj deltagare\n                </Text>\n                {loadingCompanyAdmins ? (\n                  <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\n                    Laddar...\n                  </Text>\n                ) : companyAdminsPermissionDenied ? (\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                    Saknar behörighet att läsa admins i företaget. Logga ut/in eller kontakta admin.\n                  </Text>\n                ) : companyAdmins.length === 0 ? (\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                    Inga admins hittades i företaget. Om du nyss lades till, logga ut/in och försök igen.\n                  </Text>\n                ) : (\n                  <ScrollView style={{ maxHeight: 420 }}>\n                    {companyAdmins.map((m) => {\n                      const id = m.id || m.uid || m.email;\n                      const selected = !!(newProjectParticipants || []).find(p => (p.uid || p.id) === (m.uid || m.id));\n                      return (\n                        <TouchableOpacity\n                          key={id}\n                          style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}\n                          onPress={() => {\n                            try {\n                              const exists = (newProjectParticipants || []).find(p => (p.uid || p.id) === (m.uid || m.id));\n                              if (exists) {\n                                setNewProjectParticipants((prev) => (prev || []).filter(p => (p.uid || p.id) !== (m.uid || m.id)));\n                              } else {\n                                setNewProjectParticipants((prev) => ([...(prev || []), { uid: m.uid || m.id, displayName: m.displayName || null, email: m.email || null, role: m.role || null }]));\n                              }\n                            } catch(_e) {}\n                          }}\n                        >\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                            {formatPersonName(m)}\n                          </Text>\n                          {selected ? <Ionicons name=\"checkmark\" size={18} color=\"#1976D2\" /> : null}\n                        </TouchableOpacity>\n                      );\n                    })}\n                  </ScrollView>\n                )}\n\n                <TouchableOpacity\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                  onPress={() => {\n                    setParticipantsPickerVisible(false);\n                    setNewProjectKeyboardLockHeight(0);\n                  }}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Klar</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </Modal>\n\n            <Modal\n              visible={participantsPickerVisible}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => setParticipantsPickerVisible(false)}\n            >\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n                <Pressable\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                  onPress={() => setParticipantsPickerVisible(false)}\n                />\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                    Välj deltagare\n                  </Text>\n                  {loadingCompanyAdmins ? (\n                    <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\n                      Laddar...\n                    </Text>\n                  ) : (companyAdmins.length === 0 ? (\n                    <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                      Inga admins hittades i företaget.\n                    </Text>\n                  ) : (\n                    <ScrollView style={{ maxHeight: 420 }}>\n                      {companyAdmins.map((m) => {\n                        const id = m.id || m.uid || m.email;\n                        const selected = !!(newProjectParticipants || []).find(p => (p.uid || p.id) === (m.uid || m.id));\n                        return (\n                          <TouchableOpacity\n                            key={id}\n                            style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}\n                            onPress={() => {\n                              try {\n                                const exists = (newProjectParticipants || []).find(p => (p.uid || p.id) === (m.uid || m.id));\n                                if (exists) {\n                                  setNewProjectParticipants((prev) => (prev || []).filter(p => (p.uid || p.id) !== (m.uid || m.id)));\n                                } else {\n                                  setNewProjectParticipants((prev) => ([...(prev || []), { uid: m.uid || m.id, displayName: m.displayName || null, email: m.email || null, role: m.role || null }]));\n                                }\n                              } catch(_e) {}\n                            }}\n                          >\n                            <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                              {formatPersonName(m)}\n                            </Text>\n                            {selected ? <Ionicons name=\"checkmark\" size={18} color=\"#1976D2\" /> : null}\n                          </TouchableOpacity>\n                        );\n                      })}\n                    </ScrollView>\n                  ))}\n\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                    onPress={() => setParticipantsPickerVisible(false)}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Klar</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n              Skyddsronder\n            </Text>\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>\n              <Text style={{ fontSize: 15, color: '#555' }}>Aktiva</Text>\n              <Switch\n                value={!!newProjectSkyddsrondEnabled}\n                onValueChange={(v) => setNewProjectSkyddsrondEnabled(!!v)}\n              />\n            </View>\n\n            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n              Veckor mellan skyddsronder\n            </Text>\n            <TouchableOpacity\n              style={{\n                borderWidth: 1,\n                borderColor: '#e0e0e0',\n                borderRadius: 8,\n                paddingVertical: 10,\n                paddingHorizontal: 10,\n                marginBottom: 12,\n                backgroundColor: '#fafafa',\n                flexDirection: 'row',\n                alignItems: 'center',\n                justifyContent: 'space-between',\n                opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\n              }}\n              disabled={!newProjectSkyddsrondEnabled}\n              onPress={() => setSkyddsrondWeeksPickerVisible(true)}\n              activeOpacity={0.8}\n            >\n              <Text style={{ fontSize: 16, color: '#222' }} numberOfLines={1}>\n                {String(newProjectSkyddsrondWeeks || 2)}\n              </Text>\n              <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n            </TouchableOpacity>\n\n            <Modal\n              visible={skyddsrondWeeksPickerVisible}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\n            >\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n                <Pressable\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n                />\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                    Veckor mellan skyddsronder\n                  </Text>\n                  {[1, 2, 3, 4].map((w) => (\n                    <TouchableOpacity\n                      key={String(w)}\n                      style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\n                      onPress={() => {\n                        setNewProjectSkyddsrondWeeks(w);\n                        setSkyddsrondWeeksPickerVisible(false);\n                      }}\n                    >\n                      <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                        {w}\n                      </Text>\n                    </TouchableOpacity>\n                  ))}\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                    onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n              <TouchableOpacity\n                style={{\n                  backgroundColor: '#1976D2',\n                  borderRadius: 8,\n                  paddingVertical: 12,\n                  alignItems: 'center',\n                  flex: 1,\n                  marginRight: 8,\n                  opacity: (String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible) ? 0.5 : 1\n                }}\n                disabled={String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible}\n                onPress={() => {\n                  // Insert new project into selected subfolder\n                  setHierarchy(prev => prev.map(main => ({\n                    ...main,\n                    children: main.children.map(sub =>\n                      sub.id === newProjectModal.parentSubId\n                        ? {\n                            ...sub,\n                            children: [\n                              ...(sub.children || []),\n                              {\n                                id: String(newProjectNumber ?? '').trim(),\n                                name: String(newProjectName ?? '').trim(),\n                                type: 'project',\n                                status: 'ongoing',\n                                skyddsrondEnabled: !!newProjectSkyddsrondEnabled,\n                                skyddsrondIntervalWeeks: Number(newProjectSkyddsrondWeeks) || 2,\n                                skyddsrondFirstDueDate: String(newProjectSkyddsrondFirstDueDate || '').trim() || null,\n                                ansvarig: formatPersonName(newProjectResponsible),\n                                ansvarigId: newProjectResponsible?.uid || null,\n                                participants: (newProjectParticipants || []).map(p => ({ uid: p.uid || p.id, displayName: p.displayName || null, email: p.email || null })),\n                                createdAt: new Date().toISOString(),\n                                createdBy: auth?.currentUser?.email || ''\n                              }\n                            ]\n                          }\n                        : sub\n                    )\n                  })));\n                  setNewProjectModal({ visible: false, parentSubId: null });\n                  resetProjectFields();\n                }}\n              >\n                <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>Skapa</Text>\n              </TouchableOpacity>\n\n              <TouchableOpacity\n                style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\n                onPress={() => {\n                  setNewProjectModal({ visible: false, parentSubId: null });\n                  resetProjectFields();\n                }}\n              >\n                <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n              </TouchableOpacity>\n            </View>\n          </View>\n        </View>\n      ) : (\n        (() => {\n          const effectiveKb = responsiblePickerVisible\n            ? Math.max(nativeKeyboardHeight || 0, newProjectKeyboardLockHeight || 0)\n            : (nativeKeyboardHeight || 0);\n          // Lift the modal above the keyboard. Keep a small margin so it doesn't over-shoot.\n          const lift = Math.max(0, effectiveKb - 12);\n          const hasKeyboard = lift > 40; // if keyboard is visible, treat as bottom-aligned\n          return (\n            <View\n              style={{\n                flex: 1,\n                justifyContent: hasKeyboard ? 'flex-end' : 'center',\n                alignItems: 'center',\n                paddingBottom: hasKeyboard ? 16 + lift : 0,\n              }}\n            >\n            <Pressable\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n              onPress={() => {\n                setNewProjectModal({ visible: false, parentSubId: null });\n                resetProjectFields();\n                setNewProjectKeyboardLockHeight(0);\n              }}\n            />\n            <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n          <TouchableOpacity\n            style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n            onPress={() => {\n              setNewProjectModal({ visible: false, parentSubId: null });\n              resetProjectFields();\n            }}\n            hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n          >\n            <Ionicons name=\"close\" size={26} color=\"#222\" />\n          </TouchableOpacity>\n\n          <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center', marginTop: 6 }}>Skapa nytt projekt</Text>\n\n          <TextInput\n            value={newProjectNumber}\n            onChangeText={(v) => {\n              // RN-web can sometimes deliver an event object; normalize to string to avoid crashes.\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n              setNewProjectNumber(String(next));\n            }}\n            placeholder=\"Projektnummer...\"\n            placeholderTextColor=\"#888\"\n            style={{\n              borderWidth: 1,\n              borderColor: String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) ? '#D32F2F' : '#e0e0e0',\n              borderRadius: 8,\n              padding: 10,\n              fontSize: 16,\n              marginBottom: 10,\n              backgroundColor: '#fafafa',\n              color: !isProjectNumberUnique(newProjectNumber) && String(newProjectNumber ?? '').trim() !== '' ? '#D32F2F' : '#222'\n            }}\n            autoFocus\n            keyboardType=\"default\"\n          />\n          {String(newProjectNumber ?? '').trim() !== '' && !isProjectNumberUnique(newProjectNumber) && (\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 4, marginBottom: 6 }}>\n              <Ionicons name=\"warning\" size={18} color=\"#D32F2F\" style={{ marginRight: 6 }} />\n              <Text style={{ color: '#D32F2F', fontSize: 15, fontWeight: 'bold' }}>Projektnummer används redan.</Text>\n            </View>\n          )}\n\n          <TextInput\n            value={newProjectName}\n            onChangeText={(v) => {\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n              setNewProjectName(String(next));\n            }}\n            placeholder=\"Projektnamn...\"\n            placeholderTextColor=\"#888\"\n            style={{\n              borderWidth: 1,\n              borderColor: String(newProjectName ?? '').trim() === '' ? '#D32F2F' : '#e0e0e0',\n              borderRadius: 8,\n              padding: 10,\n              fontSize: 16,\n              marginBottom: 12,\n              backgroundColor: '#fafafa',\n              color: '#222'\n            }}\n            keyboardType=\"default\"\n          />\n\n          {/* Ansvarig (required) */}\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n            Ansvarig\n          </Text>\n          <TouchableOpacity\n            style={{\n              borderWidth: 1,\n              borderColor: newProjectResponsible ? '#e0e0e0' : '#D32F2F',\n              borderRadius: 8,\n              paddingVertical: 10,\n              paddingHorizontal: 10,\n              marginBottom: 12,\n              backgroundColor: '#fafafa',\n              flexDirection: 'row',\n              alignItems: 'center',\n              justifyContent: 'space-between'\n            }}\n            onPress={() => {\n              // Opening the picker dismisses the keyboard on iOS/Android.\n              // Lock the current keyboard height so this modal doesn't jump down.\n              setNewProjectKeyboardLockHeight(nativeKeyboardHeightRef.current || nativeKeyboardHeight || 0);\n              try { Keyboard.dismiss(); } catch(_e) {}\n              // If admins weren't loaded yet (or modal opened too early), fetch now.\n              if ((!companyAdmins || companyAdmins.length === 0) && !loadingCompanyAdmins) {\n                loadCompanyAdmins({ force: true });\n              }\n              setResponsiblePickerVisible(true);\n            }}\n            activeOpacity={0.8}\n          >\n            <Text style={{ fontSize: 16, color: newProjectResponsible ? '#222' : '#888' }} numberOfLines={1}>\n              {newProjectResponsible ? formatPersonName(newProjectResponsible) : 'Välj ansvarig...'}\n            </Text>\n            <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n          </TouchableOpacity>\n\n          {/* Deltagare (optional, multi-select) */}\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n            Deltagare\n          </Text>\n          <TouchableOpacity\n            style={{\n              borderWidth: 1,\n              borderColor: '#e0e0e0',\n              borderRadius: 8,\n              paddingVertical: 10,\n              paddingHorizontal: 10,\n              marginBottom: 12,\n              backgroundColor: '#fafafa',\n              flexDirection: 'row',\n              alignItems: 'center',\n              justifyContent: 'space-between'\n            }}\n            onPress={() => {\n              setNewProjectKeyboardLockHeight(nativeKeyboardHeightRef.current || nativeKeyboardHeight || 0);\n              try { Keyboard.dismiss(); } catch(_e) {}\n              if ((!companyAdmins || companyAdmins.length === 0) && !loadingCompanyAdmins) {\n                loadCompanyAdmins({ force: true });\n              }\n              setParticipantsPickerVisible(true);\n            }}\n            activeOpacity={0.8}\n          >\n            <Text style={{ fontSize: 16, color: (newProjectParticipants && newProjectParticipants.length > 0) ? '#222' : '#888' }} numberOfLines={1}>\n              {(newProjectParticipants && newProjectParticipants.length > 0) ? newProjectParticipants.map(p => formatPersonName(p)).join(', ') : 'Välj deltagare...'}\n            </Text>\n            <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n          </TouchableOpacity>\n\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n            Första skyddsrond senast\n          </Text>\n          <TextInput\n            value={newProjectSkyddsrondFirstDueDate}\n            onChangeText={(v) => {\n              const next = typeof v === 'string' ? v : (v?.target?.value ?? '');\n              setNewProjectSkyddsrondFirstDueDate(String(next));\n            }}\n            placeholder=\"YYYY-MM-DD\"\n            placeholderTextColor=\"#888\"\n            editable={!!newProjectSkyddsrondEnabled}\n            style={{\n              borderWidth: 1,\n                borderColor: (!newProjectSkyddsrondFirstDueValid && newProjectSkyddsrondEnabled) ? '#D32F2F' : '#e0e0e0',\n              borderRadius: 8,\n              padding: 10,\n              fontSize: 16,\n              marginBottom: 12,\n              backgroundColor: '#fafafa',\n              color: '#222',\n              opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\n            }}\n          />\n\n            {newProjectSkyddsrondEnabled && !newProjectSkyddsrondFirstDueValid && (\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\n                Du måste fylla i datum (YYYY-MM-DD).\n              </Text>\n            )}\n\n          {!newProjectResponsible && (\n            <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: -8, marginBottom: 10 }}>\n              Du måste välja ansvarig.\n            </Text>\n          )}\n\n          <Modal\n            visible={responsiblePickerVisible}\n            transparent\n            animationType=\"fade\"\n            onRequestClose={() => {\n              setResponsiblePickerVisible(false);\n              setNewProjectKeyboardLockHeight(0);\n            }}\n          >\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n              <Pressable\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                onPress={() => {\n                  setResponsiblePickerVisible(false);\n                  setNewProjectKeyboardLockHeight(0);\n                }}\n              />\n              <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, maxHeight: 520, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                  Välj ansvarig\n                </Text>\n                {loadingCompanyAdmins ? (\n                  <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\n                    Laddar...\n                  </Text>\n                ) : companyAdminsPermissionDenied ? (\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                    Saknar behörighet att läsa admins i företaget. Logga ut/in eller kontakta admin.\n                  </Text>\n                ) : companyAdmins.length === 0 ? (\n                  <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                    Inga admins hittades i företaget. Om du nyss lades till, logga ut/in och försök igen.\n                  </Text>\n                ) : (\n                  <ScrollView style={{ maxHeight: 420 }}>\n                    {companyAdmins.map((m) => (\n                      <TouchableOpacity\n                        key={m.id || m.uid || m.email}\n                        style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\n                        onPress={() => {\n                          setNewProjectResponsible({\n                            uid: m.uid || m.id,\n                            displayName: m.displayName || null,\n                            email: m.email || null,\n                            role: m.role || null,\n                          });\n                          setResponsiblePickerVisible(false);\n                          setNewProjectKeyboardLockHeight(0);\n                        }}\n                      >\n                        <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                          {formatPersonName(m)}\n                        </Text>\n                      </TouchableOpacity>\n                    ))}\n                  </ScrollView>\n                )}\n\n                <TouchableOpacity\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                  onPress={() => {\n                    setResponsiblePickerVisible(false);\n                    setNewProjectKeyboardLockHeight(0);\n                  }}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </Modal>\n\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n            Skyddsronder\n          </Text>\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>\n            <Text style={{ fontSize: 15, color: '#555' }}>Aktiva</Text>\n            <Switch\n              value={!!newProjectSkyddsrondEnabled}\n              onValueChange={(v) => setNewProjectSkyddsrondEnabled(!!v)}\n            />\n          </View>\n\n          <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginBottom: 6 }}>\n            Veckor mellan skyddsronder\n          </Text>\n          <TouchableOpacity\n            style={{\n              borderWidth: 1,\n              borderColor: '#e0e0e0',\n              borderRadius: 8,\n              paddingVertical: 10,\n              paddingHorizontal: 10,\n              marginBottom: 12,\n              backgroundColor: '#fafafa',\n              flexDirection: 'row',\n              alignItems: 'center',\n              justifyContent: 'space-between',\n              opacity: newProjectSkyddsrondEnabled ? 1 : 0.5,\n            }}\n            disabled={!newProjectSkyddsrondEnabled}\n            onPress={() => setSkyddsrondWeeksPickerVisible(true)}\n            activeOpacity={0.8}\n          >\n            <Text style={{ fontSize: 16, color: '#222' }} numberOfLines={1}>\n              {String(newProjectSkyddsrondWeeks || 2)}\n            </Text>\n            <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n          </TouchableOpacity>\n\n          <Modal\n            visible={skyddsrondWeeksPickerVisible}\n            transparent\n            animationType=\"fade\"\n            onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\n          >\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n              <Pressable\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n              />\n              <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                  Veckor mellan skyddsronder\n                </Text>\n                {[1, 2, 3, 4].map((w) => (\n                  <TouchableOpacity\n                    key={String(w)}\n                    style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\n                    onPress={() => {\n                      setNewProjectSkyddsrondWeeks(w);\n                      setSkyddsrondWeeksPickerVisible(false);\n                    }}\n                  >\n                    <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                      {w}\n                    </Text>\n                  </TouchableOpacity>\n                ))}\n                <TouchableOpacity\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </Modal>\n\n          <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n            <TouchableOpacity\n              style={{\n                backgroundColor: '#1976D2',\n                borderRadius: 8,\n                paddingVertical: 12,\n                alignItems: 'center',\n                flex: 1,\n                marginRight: 8,\n                opacity: (String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible || !newProjectSkyddsrondFirstDueValid) ? 0.5 : 1\n              }}\n              disabled={String(newProjectName ?? '').trim() === '' || String(newProjectNumber ?? '').trim() === '' || !isProjectNumberUnique(newProjectNumber) || !newProjectResponsible || !newProjectSkyddsrondFirstDueValid}\n              onPress={() => {\n                // Insert new project into selected subfolder\n                setHierarchy(prev => prev.map(main => ({\n                  ...main,\n                  children: main.children.map(sub =>\n                    sub.id === newProjectModal.parentSubId\n                      ? {\n                          ...sub,\n                          children: [\n                            ...(sub.children || []),\n                            {\n                              id: String(newProjectNumber ?? '').trim(),\n                              name: String(newProjectName ?? '').trim(),\n                              type: 'project',\n                              status: 'ongoing',\n                              skyddsrondEnabled: !!newProjectSkyddsrondEnabled,\n                              skyddsrondIntervalWeeks: Number(newProjectSkyddsrondWeeks) || 2,\n                              skyddsrondFirstDueDate: newProjectSkyddsrondEnabled ? (String(newProjectSkyddsrondFirstDueDate || '').trim() || null) : null,\n                              ansvarig: formatPersonName(newProjectResponsible),\n                              ansvarigId: newProjectResponsible?.uid || null,\n                              participants: (newProjectParticipants || []).map(p => ({ uid: p.uid || p.id, displayName: p.displayName || null, email: p.email || null })),\n                              createdAt: new Date().toISOString(),\n                              createdBy: auth?.currentUser?.email || ''\n                            }\n                          ]\n                        }\n                      : sub\n                  )\n                })));\n                setNewProjectModal({ visible: false, parentSubId: null });\n                resetProjectFields();\n              }}\n            >\n              <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 16 }}>Skapa</Text>\n            </TouchableOpacity>\n\n            <TouchableOpacity\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\n              onPress={() => {\n                setNewProjectModal({ visible: false, parentSubId: null });\n                resetProjectFields();\n              }}\n            >\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n            </View>\n          );\n        })()\n      )}\n    </Modal>\n  );\n    // Ref for main folder long press timers\n    const mainTimersRef = React.useRef({});\n  // Clean up timer on unmount (only one, correct placement)\n  React.useEffect(() => {\n    return () => {\n      if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\n    };\n  }, []);\n          // Ref for long press timer\n          const projektLongPressTimer = React.useRef(null);\n        // State for new main folder modal\n        const [newFolderModalVisible, setNewFolderModalVisible] = useState(false);\n      // State for edit modal (main or sub group)\n      const [, setEditModal] = useState({ visible: false, type: '', id: null, name: '' });\n    // Helper to count ongoing and completed projects\n     \n    function _countProjectStatus(tree) {\n      let ongoing = 0;\n      let completed = 0;\n      if (!Array.isArray(tree)) return { ongoing, completed };\n      try {\n        tree.forEach(main => {\n          if (main.children && Array.isArray(main.children)) {\n            main.children.forEach(sub => {\n              if (sub.children && Array.isArray(sub.children)) {\n                sub.children.forEach(child => {\n                  if (child && child.type === 'project') {\n                    if (child.status === 'completed') completed++;\n                    else ongoing++;\n                  }\n                });\n              }\n            });\n          }\n        });\n      } catch (_e) {}\n      return { ongoing, completed };\n    }\n  // Helper to remove last main folder\n  // eslint-disable-next-line no-unused-vars\n  const removeLastMainFolder = () => {\n    setHierarchy(prev => prev.length > 0 ? prev.slice(0, -1) : prev);\n  };\n  // Helper to check if folder name is unique\n  const isFolderNameUnique = (name) => !hierarchy.some(folder => folder.name.trim().toLowerCase() === name.trim().toLowerCase());\n\n  // State for new subfolder modal\n  const [newSubModal, setNewSubModal] = useState({ visible: false, parentId: null });\n  const [newSubName, setNewSubName] = useState('');\n  // Helper to count all projects in the hierarchy\n  // eslint-disable-next-line no-unused-vars\n  function _countProjects(tree) {\n    let count = 0;\n    if (!Array.isArray(tree)) return count;\n    tree.forEach(main => {\n      if (main.children && Array.isArray(main.children)) {\n        main.children.forEach(sub => {\n          if (sub.children && Array.isArray(sub.children)) {\n            count += sub.children.filter(child => child.type === 'project').length;\n          }\n        });\n      }\n    });\n    return count;\n  }\n  const email = route?.params?.email || '';\n  const firstName = formatPersonName(email);\n  const userBtnRef = useRef(null);\n  const [userMenuVisible, setUserMenuVisible] = useState(false);\n  const [menuPos, setMenuPos] = useState({ x: 20, y: 64 });\n  const isSuperAdmin = ((auth && auth.currentUser && ['marcus@msbyggsystem.se', 'marcus.skogh@msbyggsystem.se'].includes(String(auth.currentUser.email || '').toLowerCase())) || !!authClaims?.globalAdmin);\n\n  const currentEmailLower = String(auth?.currentUser?.email || '').toLowerCase();\n  const isMsAdminClaim = !!(authClaims && (authClaims.admin === true || authClaims.role === 'admin'));\n  const allowedTools = (currentEmailLower === 'marcus@msbyggsystem.se' || currentEmailLower === 'marcus.skogh@msbyggsystem.se') || (String(authClaims?.companyId || '').trim() === 'MS Byggsystem' && isMsAdminClaim);\n  const showHeaderUserMenu = !!(isAdminUser || currentEmailLower === 'marcus@msbyggsystem.se' || currentEmailLower === 'marcus.skogh@msbyggsystem.se');\n\n  const openUserMenu = () => {\n    try {\n      const node = userBtnRef.current;\n      if (node && typeof node.measureInWindow === 'function') {\n        node.measureInWindow((x, y, w, h) => {\n          setMenuPos({ x: Math.max(8, x), y: y + (h || 36) + 6 });\n          setUserMenuVisible(true);\n        });\n        return;\n      }\n    } catch (_e) {}\n    setUserMenuVisible(true);\n  };\n  const [, setLoggingOut] = useState(false);\n  // companyId kan komma från route.params eller användarprofil\n  const [companyId, setCompanyId] = useState(() => route?.params?.companyId || '');\n\n  // Persist companyId locally (used as fallback in other screens) and\n  // allow resolving companyId from auth claims when route params are missing.\n  React.useEffect(() => {\n    (async () => {\n      try {\n        const current = String(companyId || '').trim();\n        const fromClaims = String(authClaims?.companyId || '').trim();\n        const cid = current || fromClaims;\n        if (!cid) return;\n        if (!current && fromClaims) {\n          setCompanyId(fromClaims);\n        }\n        const stored = await AsyncStorage.getItem('dk_companyId');\n        if (stored !== cid) {\n          await AsyncStorage.setItem('dk_companyId', cid);\n        }\n      } catch(_e) {}\n    })();\n  }, [companyId, authClaims?.companyId]);\n  // Laddningsstate för hierarkin\n  const [loadingHierarchy, setLoadingHierarchy] = useState(true);\n  const [hierarchy, setHierarchy] = useState([]);\n  const [spinMain, setSpinMain] = useState({});\n  const [spinSub, setSpinSub] = useState({});\n  const [localFallbackExists, setLocalFallbackExists] = useState(false);\n  const [syncStatus, setSyncStatus] = useState('idle');\n  const [selectedProject, setSelectedProject] = useState(null);\n  const selectedProjectRef = useRef(null);\n  const [isInlineLocked, setIsInlineLocked] = useState(false);\n  const pendingProjectSwitchRef = useRef(null);\n  const [projectControlsRefreshNonce, setProjectControlsRefreshNonce] = useState(0);\n  const [inlineControlEditor, setInlineControlEditor] = useState(null); // { project, controlType }\n\n  // Used to request a specific action when opening a project from the dashboard (e.g. open a draft inline)\n  const [projectSelectedAction, setProjectSelectedAction] = useState(null);\n\n  const [dashboardLoading, setDashboardLoading] = useState(false);\n  const [dashboardOverview, setDashboardOverview] = useState({\n    activeProjects: 0,\n    openDeviations: 0,\n    skyddsrondOverdue: 0,\n    skyddsrondDueSoon: 0,\n    controlsToSign: 0,\n    drafts: 0,\n  });\n  const [dashboardRecent, setDashboardRecent] = useState([]);\n  const [dashboardRecentProjects, setDashboardRecentProjects] = useState([]);\n  const [companyActivity, setCompanyActivity] = useState([]);\n\n  // Dashboard drill-down + hover (used mainly on web)\n  const [dashboardFocus, setDashboardFocus] = useState(null); // 'activeProjects' | 'drafts' | 'controlsToSign' | 'upcomingSkyddsrond' | 'openDeviations'\n  const [dashboardHoveredStatKey, setDashboardHoveredStatKey] = useState(null);\n  const [dashboardActiveProjectsList, setDashboardActiveProjectsList] = useState([]);\n  const [dashboardDraftItems, setDashboardDraftItems] = useState([]);\n  const [dashboardControlsToSignItems, setDashboardControlsToSignItems] = useState([]);\n  const [dashboardOpenDeviationItems, setDashboardOpenDeviationItems] = useState([]);\n  const [dashboardUpcomingSkyddsrondItems, setDashboardUpcomingSkyddsrondItems] = useState([]);\n  const [dashboardDropdownAnchor, setDashboardDropdownAnchor] = useState('overview');\n  const [dashboardDropdownTop, setDashboardDropdownTop] = useState(null);\n  const [dashboardDropdownRowKey, setDashboardDropdownRowKey] = useState(null);\n\n  // Remote-loaded button images (prefer Firebase Storage; fallback to local assets)\n  const [dashboardBtn1Url, setDashboardBtn1Url] = useState(null);\n  const [dashboardBtn2Url, setDashboardBtn2Url] = useState(null);\n  const [dashboardBtn1Failed, setDashboardBtn1Failed] = useState(false);\n  const [dashboardBtn2Failed, setDashboardBtn2Failed] = useState(false);\n\n  const dashboardCardLayoutRef = useRef({ overview: null, reminders: null });\n  const dashboardStatRowLayoutRef = useRef({});\n\n  // Try to load dashboard button images from Firebase Storage path\n  React.useEffect(() => {\n    let mounted = true;\n    async function loadButtons() {\n      try {\n        const paths = [\n          'branding/dashboard_buttons/nykontroll.png',\n          'branding/dashboard_buttons/dagensuppgifter.png'\n        ];\n        const results = await Promise.all(paths.map(async (p) => {\n          try {\n            if (!storage) return null;\n            let fullPath = p;\n            // Support full gs:// URIs too\n            if (typeof p === 'string' && p.trim().toLowerCase().startsWith('gs://')) {\n              const m = String(p).trim().match(/^gs:\\/\\/[^\\/]+\\/(.+)$/i);\n              if (m && m[1]) fullPath = m[1];\n              else return null;\n            }\n\n            // Ensure path has no leading slash\n            const normPath = String(fullPath).replace(/^\\/+/, '');\n\n            // On web prefer the public GCS URL (avoids tokenized REST calls that can 403 in browsers)\n            try {\n              if (Platform && Platform.OS === 'web') {\n                const bucketName = (storage && storage.app && storage.app.options && storage.app.options.storageBucket) ? String(storage.app.options.storageBucket) : '';\n                const bucketCandidates = [];\n                if (bucketName) {\n                  bucketCandidates.push(bucketName);\n                  if (bucketName.toLowerCase().endsWith('.firebasestorage.app')) {\n                    bucketCandidates.push(bucketName.replace(/\\.firebasestorage\\.app$/i, '.appspot.com'));\n                  }\n                }\n                for (const b of (bucketCandidates.length ? bucketCandidates : [])) {\n                  try {\n                    const publicUrl = 'https://storage.googleapis.com/' + b + '/' + encodeURI(normPath);\n                    return publicUrl;\n                  } catch (_e) {\n                    // try next bucket candidate\n                  }\n                }\n              }\n            } catch (_e) {\n              // ignore fallback errors\n            }\n\n            // Try a couple of path variants (no leading slash and with a leading slash) using SDK\n            const tryPaths = [String(fullPath), String('/' + fullPath)];\n            for (const tp of tryPaths) {\n              try {\n                const sref = storageRef(storage, tp);\n                const url = await getDownloadURL(sref);\n                if (url) return url;\n              } catch (_e) {\n                // try next variant\n              }\n            }\n\n            return null;\n          } catch (e) {\n            return null;\n          }\n        }));\n        if (!mounted) return;\n        // Debug: log what we found so we can inspect console on web\n        try { console.log('Dashboard button URLs:', results); } catch (_e) {}\n        if (results[0]) setDashboardBtn1Url(results[0]);\n        if (results[1]) setDashboardBtn2Url(results[1]);\n      } catch (e) {\n        // ignore failures; local assets will be used\n      }\n    }\n    loadButtons();\n    return () => { mounted = false; };\n  }, []);\n\n  // Listen for project updates emitted from ProjectDetails (or other screens)\n  React.useEffect(() => {\n    const unsub = onProjectUpdated((updatedProject) => {\n      try {\n        if (!updatedProject || !updatedProject.id) return;\n        setHierarchy((prev) => {\n          const walk = (nodes) => {\n            let changed = false;\n            const next = (nodes || []).map((n) => {\n              if (!n) return n;\n              if (n.type === 'project' && String(n.id) === String(updatedProject.id)) {\n                changed = true;\n                return Object.assign({}, n, updatedProject);\n              }\n              if (Array.isArray(n.children) && n.children.length > 0) {\n                const newChildren = walk(n.children);\n                if (newChildren !== n.children) {\n                  changed = true;\n                  return Object.assign({}, n, { children: newChildren });\n                }\n              }\n              return n;\n            });\n            return next;\n          };\n          const newHierarchy = walk(prev || []);\n          try { hierarchyRef.current = newHierarchy; } catch (_e) {}\n          return newHierarchy;\n        });\n\n        setSelectedProject((prev) => (prev && String(prev.id) === String(updatedProject.id) ? Object.assign({}, prev, updatedProject) : prev));\n      } catch (e) {\n        console.warn('onProjectUpdated handler error', e);\n      }\n    });\n    return () => { try { if (typeof unsub === 'function') unsub(); } catch(_) {} };\n  }, []);\n\n  const toggleDashboardFocus = (key, anchor, top) => {\n    if (!key) return;\n    console.log && console.log('toggleDashboardFocus called', { key, anchor, top, current: dashboardFocus });\n    if (anchor) {\n      setDashboardDropdownAnchor(anchor);\n    }\n    // If opening, set top immediately to avoid race on positioning\n    if (typeof top === 'number') {\n      setDashboardDropdownTop(top);\n    } else if (dashboardFocus === key) {\n      // closing\n      setDashboardDropdownTop(null);\n      setDashboardHoveredStatKey(null);\n      setDashboardDropdownRowKey(null);\n    }\n    setDashboardFocus((prev) => (prev === key ? null : key));\n  };\n\n  // Keep ref in sync for popstate handler\n  React.useEffect(() => {\n    selectedProjectRef.current = selectedProject;\n  }, [selectedProject]);\n\n  // Close dashboard dropdowns when navigating into a project (avoid leaving overlays open)\n  React.useEffect(() => {\n    try {\n      // Clear dropdown focus whenever selectedProject changes (entering or leaving a project)\n      setDashboardFocus(null);\n      setDashboardDropdownTop(null);\n      setDashboardHoveredStatKey(null);\n    } catch (e) {}\n  }, [selectedProject]);\n\n  const handleInlineLockChange = React.useCallback((locked) => {\n    setIsInlineLocked(!!locked);\n  }, []);\n\n  const requestProjectSwitch = React.useCallback((project, opts = {}) => {\n    if (!project) {\n      if (Object.prototype.hasOwnProperty.call(opts, 'selectedAction')) {\n        setProjectSelectedAction(opts.selectedAction);\n      }\n      setSelectedProject(null);\n      return;\n    }\n\n    const nextProject = { ...project };\n    const selectedActionProvided = Object.prototype.hasOwnProperty.call(opts, 'selectedAction');\n    const clearActionAfter = !!opts.clearActionAfter;\n\n    if (Platform.OS === 'web' && isInlineLocked) {\n      pendingProjectSwitchRef.current = {\n        project: nextProject,\n        selectedAction: selectedActionProvided ? opts.selectedAction : null,\n        clearActionAfter,\n      };\n      try {\n        window.dispatchEvent(new CustomEvent('dkInlineAttemptExit'));\n      } catch(_e) {\n        // Fallback: if event dispatch fails, proceed immediately.\n        if (selectedActionProvided) setProjectSelectedAction(opts.selectedAction);\n        setSelectedProject(nextProject);\n        if (clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\n      }\n      return;\n    }\n\n    if (selectedActionProvided) setProjectSelectedAction(opts.selectedAction);\n    setSelectedProject(nextProject);\n    if (clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\n  }, [isInlineLocked]);\n\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n\n    const onDecision = (event) => {\n      const decision = event?.detail?.decision;\n      const pending = pendingProjectSwitchRef.current;\n      pendingProjectSwitchRef.current = null;\n\n      if (!pending) return;\n      if (decision !== 'draft' && decision !== 'abort') return;\n\n      try { setProjectSelectedAction(pending.selectedAction ?? null); } catch(_e) {}\n      setSelectedProject({ ...pending.project });\n      if (pending.clearActionAfter) setTimeout(() => setProjectSelectedAction(null), 0);\n    };\n\n    window.addEventListener('dkInlineExitDecision', onDecision);\n    return () => {\n      try { window.removeEventListener('dkInlineExitDecision', onDecision); } catch(_e) {}\n    };\n  }, []);\n\n  const findProjectById = React.useCallback((projectId) => {\n    if (!projectId) return null;\n    const targetId = String(projectId);\n    try {\n      const tree = hierarchyRef.current || [];\n      for (const main of tree) {\n        for (const sub of (main.children || [])) {\n          for (const child of (sub.children || [])) {\n            if (child && child.type === 'project' && String(child.id) === targetId) return child;\n          }\n        }\n      }\n    } catch(_e) {}\n    return null;\n  }, []);\n\n  const toTsMs = React.useCallback((value) => {\n    try {\n      if (value === null || value === undefined) return 0;\n      if (typeof value === 'number') return Number.isFinite(value) ? value : 0;\n      if (typeof value === 'string') return new Date(value).getTime() || 0;\n      if (typeof value?.toDate === 'function') return value.toDate().getTime() || 0;\n      if (typeof value?.seconds === 'number') return (value.seconds * 1000) + (typeof value.nanoseconds === 'number' ? Math.floor(value.nanoseconds / 1e6) : 0);\n      return new Date(value).getTime() || 0;\n    } catch(_e) {\n      return 0;\n    }\n  }, []);\n\n  const formatRelativeTime = React.useCallback((isoLike) => {\n    try {\n      const t = toTsMs(isoLike);\n      if (!t) return '';\n      const diffMs = Date.now() - t;\n      const diffSec = Math.max(0, Math.floor(diffMs / 1000));\n      if (diffSec < 60) return 'för nyss';\n      const diffMin = Math.floor(diffSec / 60);\n      if (diffMin < 60) return `för ${diffMin} minut${diffMin === 1 ? '' : 'er'} sedan`;\n      const diffH = Math.floor(diffMin / 60);\n      if (diffH < 24) return `för ${diffH} tim${diffH === 1 ? 'me' : 'mar'} sedan`;\n      const diffD = Math.floor(diffH / 24);\n      if (diffD < 7) return `för ${diffD} dag${diffD === 1 ? '' : 'ar'} sedan`;\n      return new Date(t).toLocaleDateString('sv-SE');\n    } catch(_e) {\n      return '';\n    }\n  }, [toTsMs]);\n\n  const computeOpenDeviationsCount = React.useCallback((controls) => {\n    try {\n      let open = 0;\n      for (const item of (controls || [])) {\n        if (!item || item.type !== 'Skyddsrond') continue;\n        // Saved controls may use different shapes over time:\n        // - Newer: item.checklist (array of sections) with section.remediation keyed by point text\n        // - Older: item.checklistSections with section.remediation indexed by point index\n        const sections = Array.isArray(item.checklistSections)\n          ? item.checklistSections\n          : (Array.isArray(item.checklist) ? item.checklist : null);\n        if (!Array.isArray(sections)) continue;\n        for (const section of sections) {\n          if (!section || !Array.isArray(section.statuses)) continue;\n          section.statuses.forEach((status, idx) => {\n            if (status !== 'avvikelse') return;\n            const points = Array.isArray(section.points) ? section.points : [];\n            const pt = points[idx];\n            const rem = section.remediation\n              ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[idx]\n              : null;\n            const handled = !!rem;\n            if (!handled) open += 1;\n          });\n        }\n      }\n      return open;\n    } catch(_e) {\n      return 0;\n    }\n  }, []);\n\n  const computeControlsToSign = React.useCallback((drafts) => {\n    try {\n      let count = 0;\n      for (const item of (drafts || [])) {\n        if (!item) continue;\n        const type = String(item.type || '');\n        if (type !== 'Mottagningskontroll' && type !== 'Riskbedömning') continue;\n        const sigs = item.mottagningsSignatures;\n        if (!Array.isArray(sigs) || sigs.length === 0) count++;\n      }\n      return count;\n    } catch(_e) {\n      return 0;\n    }\n  }, []);\n\n  const countActiveProjects = React.useCallback(() => {\n    try {\n      let active = 0;\n      const tree = hierarchyRef.current || [];\n      for (const main of tree) {\n        for (const sub of (main.children || [])) {\n          for (const child of (sub.children || [])) {\n            if (child && child.type === 'project') {\n              const status = child.status || 'ongoing';\n              if (status !== 'completed') active++;\n            }\n          }\n        }\n      }\n      return active;\n    } catch(_e) {\n      return 0;\n    }\n  }, []);\n\n  const loadDashboard = React.useCallback(async () => {\n    setDashboardLoading(true);\n    try {\n      const [draftRaw, completedRaw] = await Promise.all([\n        AsyncStorage.getItem('draft_controls'),\n        AsyncStorage.getItem('completed_controls'),\n      ]);\n      const drafts = draftRaw ? (JSON.parse(draftRaw) || []) : [];\n      const completed = completedRaw ? (JSON.parse(completedRaw) || []) : [];\n\n      // Important: draft/completed controls are stored locally without company-scoping.\n      // Filter them to only include projects that exist in the current company's hierarchy.\n      const allowedProjectIds = new Set();\n      try {\n        const tree = hierarchyRef.current || [];\n        for (const main of tree) {\n          for (const sub of (main.children || [])) {\n            for (const child of (sub.children || [])) {\n              if (child && child.type === 'project' && child.id) allowedProjectIds.add(String(child.id));\n            }\n          }\n        }\n      } catch(_e) {}\n\n      const pickProjectId = (item) => {\n        const pid = item?.project?.id || item?.projectId || item?.project || null;\n        return pid ? String(pid) : null;\n      };\n\n      const filteredDrafts = (drafts || []).filter((d) => {\n        const pid = pickProjectId(d);\n        return pid && allowedProjectIds.has(pid);\n      });\n      const filteredCompleted = (completed || []).filter((c) => {\n        const pid = pickProjectId(c);\n        return pid && allowedProjectIds.has(pid);\n      });\n\n      // Store lists for dashboard drill-down\n      try { setDashboardDraftItems(Array.isArray(filteredDrafts) ? filteredDrafts : []); } catch(_e) {}\n\n      try {\n        const activeList = [];\n        const tree = hierarchyRef.current || [];\n        for (const main of tree) {\n          for (const sub of (main.children || [])) {\n            for (const child of (sub.children || [])) {\n              if (!child || child.type !== 'project') continue;\n              const status = child.status || 'ongoing';\n              if (status === 'completed') continue;\n              activeList.push(child);\n            }\n          }\n        }\n        setDashboardActiveProjectsList(activeList);\n      } catch(_e) {\n        try { setDashboardActiveProjectsList([]); } catch(_e) {}\n      }\n\n      try {\n        const needSign = (filteredDrafts || []).filter((item) => {\n          if (!item) return false;\n          const type = String(item.type || '');\n          if (type !== 'Mottagningskontroll' && type !== 'Riskbedömning') return false;\n          const sigs = item.mottagningsSignatures;\n          return !Array.isArray(sigs) || sigs.length === 0;\n        });\n        setDashboardControlsToSignItems(needSign);\n      } catch(_e) {\n        try { setDashboardControlsToSignItems([]); } catch(_e) {}\n      }\n\n      const activeProjects = countActiveProjects();\n      const openDeviations = computeOpenDeviationsCount(filteredCompleted);\n      const controlsToSign = computeControlsToSign(filteredDrafts);\n\n      // Skyddsrond interval reminders (default: 14 days)\n      const MS_DAY = 24 * 60 * 60 * 1000;\n      const NOW = Date.now();\n      const SOON_THRESHOLD_DAYS = 3;\n      const lastSkyddsrondByProject = new Map();\n      try {\n        (filteredCompleted || []).forEach((c) => {\n          if (!c || c.type !== 'Skyddsrond') return;\n          const pid = pickProjectId(c);\n          if (!pid) return;\n          const ts = toTsMs(c.date || c.savedAt || c.updatedAt || c.createdAt || null);\n          if (!ts) return;\n          const prev = lastSkyddsrondByProject.get(pid) || 0;\n          if (ts > prev) lastSkyddsrondByProject.set(pid, ts);\n        });\n      } catch(_e) {}\n\n      let skyddsrondOverdue = 0;\n      let skyddsrondDueSoon = 0;\n      const upcomingSkyddsrond = [];\n      try {\n        const tree = hierarchyRef.current || [];\n        for (const main of tree) {\n          for (const sub of (main.children || [])) {\n            for (const child of (sub.children || [])) {\n              if (!child || child.type !== 'project' || !child.id) continue;\n              const status = child.status || 'ongoing';\n              if (status === 'completed') continue;\n\n              const pid = String(child.id);\n              const enabled = child.skyddsrondEnabled !== false;\n              if (!enabled) continue;\n\n              const intervalWeeksRaw = Number(child.skyddsrondIntervalWeeks);\n              const intervalDaysRaw = Number(child.skyddsrondIntervalDays);\n              const intervalDays = (Number.isFinite(intervalWeeksRaw) && intervalWeeksRaw > 0)\n                ? (intervalWeeksRaw * 7)\n                : (Number.isFinite(intervalDaysRaw) && intervalDaysRaw > 0 ? intervalDaysRaw : 14);\n\n              const lastMs = lastSkyddsrondByProject.get(pid) || 0;\n              const firstDueMs = toTsMs(child.skyddsrondFirstDueDate || null);\n              const baselineMs = lastMs || toTsMs(child.createdAt || null) || NOW;\n              const nextDueMs = lastMs\n                ? (baselineMs + intervalDays * MS_DAY)\n                : (firstDueMs || (baselineMs + intervalDays * MS_DAY));\n\n              if (NOW > nextDueMs) {\n                skyddsrondOverdue += 1;\n                upcomingSkyddsrond.push({ project: child, nextDueMs, state: 'overdue' });\n              } else if ((nextDueMs - NOW) <= (SOON_THRESHOLD_DAYS * MS_DAY)) {\n                skyddsrondDueSoon += 1;\n                upcomingSkyddsrond.push({ project: child, nextDueMs, state: 'dueSoon' });\n              }\n            }\n          }\n        }\n      } catch(_e) {}\n\n      try {\n        upcomingSkyddsrond.sort((a, b) => Number(a?.nextDueMs || 0) - Number(b?.nextDueMs || 0));\n        setDashboardUpcomingSkyddsrondItems(upcomingSkyddsrond);\n      } catch(_e) {\n        try { setDashboardUpcomingSkyddsrondItems([]); } catch(_e) {}\n      }\n\n      const countOpenDeviationsForControl = (control) => {\n        try {\n          if (!control || control.type !== 'Skyddsrond') return 0;\n          const sections = Array.isArray(control.checklistSections)\n            ? control.checklistSections\n            : (Array.isArray(control.checklist) ? control.checklist : null);\n          if (!Array.isArray(sections)) return 0;\n          let open = 0;\n          for (const section of sections) {\n            if (!section || !Array.isArray(section.statuses)) continue;\n            const points = Array.isArray(section.points) ? section.points : [];\n            for (let i = 0; i < section.statuses.length; i++) {\n              if (section.statuses[i] !== 'avvikelse') continue;\n              const pt = points[i];\n              const rem = section.remediation\n                ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[i]\n                : null;\n              if (!rem) open += 1;\n            }\n          }\n          return open;\n        } catch(_e) {\n          return 0;\n        }\n      };\n\n      try {\n        const openDevItems = (filteredCompleted || [])\n          .filter((c) => c && c.type === 'Skyddsrond')\n          .map((c) => ({ control: c, openCount: countOpenDeviationsForControl(c) }))\n          .filter((x) => (x.openCount || 0) > 0);\n        setDashboardOpenDeviationItems(openDevItems);\n      } catch(_e) {\n        try { setDashboardOpenDeviationItems([]); } catch(_e) {}\n      }\n\n      const recent = [];\n      const pushRecent = (item, kind) => {\n        if (!item || typeof item !== 'object') return;\n        const ts = item.savedAt || item.updatedAt || item.createdAt || item.date || null;\n        const projectId = pickProjectId(item);\n        if (!projectId) return;\n        // Only show activity for projects we know belong to this company.\n        if (!allowedProjectIds.has(projectId)) return;\n        const projObj = findProjectById(projectId);\n        if (!projObj) return;\n        const projectName = projObj?.name || null;\n        const desc = String(item.deliveryDesc || item.materialDesc || item.generalNote || item.description || '').trim();\n        // Try to enrich with actor info from companyActivity if available\n        let actorName = null;\n        let actorEmail = null;\n        let actorUid = null;\n        try {\n          if (Array.isArray(companyActivity) && companyActivity.length > 0) {\n            // find an activity event matching this project + type and close timestamp\n            const approxTs = toTsMs(ts || 0);\n            const match = companyActivity.find(ev => {\n              try {\n                const evProj = ev.projectId || (ev.project && ev.project.id) || null;\n                if (!evProj || String(evProj) !== String(projectId)) return false;\n                const evType = String(ev.type || ev.eventType || ev.kind || '').toLowerCase();\n                const itType = String(item.type || kind || '').toLowerCase();\n                if (itType && evType && evType !== itType) {\n                  // allow drafts/completed to map to same type name\n                }\n                const evTs = toTsMs(ev.ts || ev.createdAt || ev.updatedAt || 0);\n                if (approxTs && evTs) {\n                  const diff = Math.abs(approxTs - evTs);\n                  if (diff > 120000) return false; // require within 2 minutes\n                }\n                return true;\n              } catch(_e) { return false; }\n            });\n            if (match) {\n              actorName = match.actorName || match.displayName || match.actor || null;\n              actorEmail = match.actorEmail || match.email || null;\n              actorUid = match.uid || null;\n            }\n          }\n        } catch(_e) {}\n        // Fallbacks: check item/raw for createdBy/author fields\n        try {\n          if (!actorName) {\n            const raw = item.raw || item.payload || item || {};\n            // common shapes: createdBy: { uid, email, displayName } or createdBy: 'email' or createdBy: uid\n            const cb = raw.createdBy || raw.creator || raw.author || raw.createdByUid || raw.createdById || null;\n            if (cb) {\n              if (typeof cb === 'string') {\n                // Could be email or uid\n                actorEmail = actorEmail || (cb.includes('@') ? cb : actorEmail);\n                actorUid = actorUid || (cb.includes('@') ? actorUid : cb);\n                actorName = actorName || null;\n              } else if (typeof cb === 'object') {\n                actorName = actorName || cb.displayName || cb.name || cb.fullName || null;\n                actorEmail = actorEmail || cb.email || cb.mail || null;\n                actorUid = actorUid || cb.uid || cb.id || null;\n              }\n            }\n            // other ad-hoc fields\n            actorName = actorName || raw.actorName || raw.actor || raw.username || raw.userName || raw.userDisplayName || null;\n            actorEmail = actorEmail || raw.actorEmail || raw.email || null;\n            actorUid = actorUid || raw.uid || raw.userId || raw.userUID || null;\n          }\n        } catch(_e) {}\n\n        recent.push({\n          kind,\n          type: item.type || kind,\n          ts,\n          projectId,\n          projectName,\n          desc,\n          openDeviationsCount: (kind === 'completed' && item.type === 'Skyddsrond') ? countOpenDeviationsForControl(item) : 0,\n          actorName: actorName || null,\n          actorEmail: actorEmail || null,\n          uid: actorUid || null,\n          raw: item,\n        });\n      };\n      (filteredCompleted || []).forEach((c) => pushRecent(c, 'completed'));\n      (filteredDrafts || []).forEach((d) => pushRecent(d, 'draft'));\n\n      // Merge in company activity (e.g. login events and control-related events).\n      try {\n        const events = Array.isArray(companyActivity) ? companyActivity : [];\n        // Add login events (deduped by identity)\n        try {\n          const loginEvents = (events || []).filter(ev => ev && typeof ev === 'object' && String(ev.type || '').toLowerCase() === 'login').slice().sort((a, b) => {\n            const ta = toTsMs(a.ts || a.createdAt || a.updatedAt || 0);\n            const tb = toTsMs(b.ts || b.createdAt || b.updatedAt || 0);\n            return tb - ta;\n          });\n          const seen = new Set();\n          for (const ev of loginEvents) {\n            if (!ev || typeof ev !== 'object') continue;\n            const idKey = String(ev.uid || ev.email || ev.displayName || '').trim().toLowerCase();\n            const key = idKey || '__noid';\n            if (seen.has(key)) continue;\n            seen.add(key);\n            const who = formatPersonName(ev.displayName || ev.email || ev.uid || '');\n            recent.push({\n              kind: 'company',\n              type: 'login',\n              ts: ev.ts || ev.createdAt || ev.updatedAt || null,\n              projectId: null,\n              projectName: null,\n              desc: who ? `Loggade in: ${who}` : 'Loggade in',\n              actorName: ev.displayName || null,\n              actorEmail: ev.email || null,\n              uid: ev.uid || null,\n              raw: ev,\n            });\n          }\n        } catch(_e) {}\n\n        // Add other company events (drafts, completed controls, etc.) so actor info is visible\n        try {\n          const otherEvents = (events || []).filter(ev => ev && typeof ev === 'object' && String(ev.type || '').toLowerCase() !== 'login');\n          for (const ev of otherEvents) {\n            try {\n              const t = ev.type || ev.eventType || ev.kind || null;\n              const ts = ev.ts || ev.createdAt || ev.updatedAt || null;\n              const projectId = ev.projectId || (ev.project && ev.project.id) || null;\n              const projectName = ev.projectName || (ev.project && ev.project.name) || null;\n              const desc = ev.label || ev.message || ev.msg || '';\n              recent.push({\n                kind: ev.kind || 'company',\n                type: t,\n                ts,\n                projectId,\n                projectName,\n                desc,\n                actorName: ev.actorName || ev.displayName || null,\n                actorEmail: ev.actorEmail || ev.email || null,\n                uid: ev.uid || null,\n                raw: ev,\n              });\n            } catch(_e) {}\n          }\n        } catch(_e) {}\n      } catch(_e) {}\n      recent.sort((a, b) => {\n        return toTsMs(b.ts) - toTsMs(a.ts);\n      });\n      const top = recent.slice(0, 8);\n\n      // Derive recent projects from recent activity (unique by projectId)\n      const projMap = new Map();\n      for (const r of recent) {\n        if (!r.projectId) continue;\n        const prev = projMap.get(r.projectId);\n        const t = toTsMs(r.ts);\n        if (!prev || t > prev.ts) projMap.set(r.projectId, { ts: t });\n      }\n      const recentProjects = Array.from(projMap.entries())\n        .map(([projectId, meta]) => {\n          const p = findProjectById(projectId);\n          return p ? { project: p, projectId: String(projectId), ts: meta.ts } : null;\n        })\n        .filter(Boolean)\n        .sort((a, b) => (b.ts || 0) - (a.ts || 0))\n        .slice(0, 8);\n\n      setDashboardOverview({\n        activeProjects,\n        openDeviations,\n        skyddsrondOverdue,\n        skyddsrondDueSoon,\n        controlsToSign,\n        drafts: Array.isArray(filteredDrafts) ? filteredDrafts.length : 0,\n      });\n      setDashboardRecent(top);\n      setDashboardRecentProjects(recentProjects);\n    } catch(_e) {\n      setDashboardOverview({ activeProjects: 0, openDeviations: 0, skyddsrondOverdue: 0, skyddsrondDueSoon: 0, controlsToSign: 0, drafts: 0 });\n      setDashboardRecent([]);\n      setDashboardRecentProjects([]);\n    } finally {\n      setDashboardLoading(false);\n    }\n  }, [companyActivity, countActiveProjects, computeControlsToSign, computeOpenDeviationsCount, findProjectById, toTsMs]);\n\n  // Web: keep browser back/forward in sync with selectedProject\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n    if (!window.history) return;\n\n    // Ensure we have a stable \"home\" state\n    try {\n      const st = window.history.state || {};\n      if (!st.dkView) window.history.replaceState({ ...st, dkView: 'home' }, '');\n    } catch(_e) {}\n\n    const onPopState = (e) => {\n      try {\n        const st = e?.state || window.history.state || {};\n        if (st && st.dkView === 'project' && st.projectId) {\n          const proj = findProjectById(st.projectId);\n          // Clear any pending dashboard action when navigating with browser back/forward.\n          setProjectSelectedAction(null);\n          if (proj) setSelectedProject({ ...proj });\n          else setSelectedProject(null);\n        } else {\n          setProjectSelectedAction(null);\n          setSelectedProject(null);\n        }\n      } catch(_e) {\n        setProjectSelectedAction(null);\n        setSelectedProject(null);\n      }\n    };\n\n    window.addEventListener('popstate', onPopState);\n    return () => {\n      try { window.removeEventListener('popstate', onPopState); } catch(_e) {}\n    };\n  }, [findProjectById]);\n\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n    if (!window.history || typeof window.history.pushState !== 'function') return;\n\n    const proj = selectedProject;\n    if (proj && proj.id) {\n      try {\n        const st = window.history.state || {};\n        // Avoid pushing duplicates\n        if (st.dkView === 'project' && String(st.projectId || '') === String(proj.id)) return;\n        window.history.pushState({ ...st, dkView: 'project', projectId: String(proj.id) }, '');\n      } catch(_e) {}\n    }\n  }, [selectedProject]);\n\n  const closeSelectedProject = React.useCallback(() => {\n    // UX requirement: the in-app back button should always leave the project\n    // and return to the dashboard (not the previously opened project).\n    if (Platform.OS === 'web' && typeof window !== 'undefined' && window.history && typeof window.history.replaceState === 'function') {\n      try {\n        const st = window.history.state || {};\n        window.history.replaceState({ ...st, dkView: 'home', projectId: null }, '');\n      } catch(_e) {}\n    }\n    setProjectSelectedAction(null);\n    setSelectedProject(null);\n  }, []);\n\n  const openInlineControlEditor = React.useCallback((project, controlType, templateId = null) => {\n    if (!project || !controlType) return;\n    setSelectedProject(project);\n    setInlineControlEditor({ project, controlType, templateId });\n    setProjectSelectedAction(null);\n  }, []);\n\n  const closeInlineControlEditor = React.useCallback(() => {\n    setInlineControlEditor(null);\n  }, []);\n\n  const handleInlineControlFinished = React.useCallback(() => {\n    try {\n      showAlert('Sparad', 'Kontrollen är sparad.');\n    } catch(_e) {}\n    setInlineControlEditor(null);\n    setProjectControlsRefreshNonce((n) => n + 1);\n  }, []);\n\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    // Refresh dashboard when returning to start panel or after sync/hierarchy changes.\n    if (!selectedProject) loadDashboard();\n  }, [selectedProject, syncStatus, hierarchy, companyActivity, loadDashboard]);\n\n  // Realtime company activity feed (company-scoped).\n  React.useEffect(() => {\n    const cid = String(companyId || routeCompanyId || authClaims?.companyId || '').trim();\n    if (!cid) return;\n    const unsub = subscribeCompanyActivity(cid, {\n      limitCount: 25,\n      onData: (items) => {\n        try { setCompanyActivity(Array.isArray(items) ? items : []); } catch(_e) {}\n      },\n      onError: () => {},\n    });\n    return () => {\n      try { if (typeof unsub === 'function') unsub(); } catch(_e) {}\n    };\n  }, [companyId, routeCompanyId, authClaims?.companyId]);\n\n  // Log a login event (throttled) so other users can see who logs in.\n  React.useEffect(() => {\n    const cid = String(companyId || routeCompanyId || authClaims?.companyId || '').trim();\n    const user = auth?.currentUser;\n    if (!cid) return;\n    if (!user?.uid && !user?.email) return;\n\n    let cancelled = false;\n    (async () => {\n      try {\n        const idPart = user?.uid || user?.email || 'unknown';\n        const throttleKey = `dk_last_login_activity:${cid}:${idPart}`;\n        const last = await AsyncStorage.getItem(throttleKey);\n        if (last) {\n          const lastMs = new Date(last).getTime() || 0;\n          if (lastMs && (Date.now() - lastMs) < 5 * 60 * 1000) return;\n        }\n        const ok = await logCompanyActivity({\n          type: 'login',\n          uid: user?.uid || null,\n          email: user?.email || null,\n          displayName: user?.displayName || null,\n        }, cid);\n        if (!ok) return;\n        if (cancelled) return;\n        await AsyncStorage.setItem(throttleKey, new Date().toISOString());\n      } catch(_e) {}\n    })();\n\n    return () => { cancelled = true; };\n  }, [companyId, routeCompanyId, authClaims?.companyId]);\n\n  // Ensure current user is written to the company members directory (so admin dropdown works)\n  React.useEffect(() => {\n    if (!companyId) return;\n    if (!auth?.currentUser?.uid) return;\n    // Inline the upsert to avoid any scope issues on native/web builds.\n    (async () => {\n      try {\n        const user = auth?.currentUser;\n        if (!user?.uid) return;\n        const profile = await fetchUserProfile(user.uid).catch((e) => null);\n        const displayName = profile?.displayName || profile?.name || (user.email ? String(user.email).split('@')[0] : null);\n        const role = profile?.role || null;\n        await upsertCompanyMember({\n          companyId: routeCompanyId || null,\n          uid: user.uid,\n          displayName,\n          email: user.email || null,\n          role,\n        });\n      } catch(_e) {}\n    })();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [companyId, auth?.currentUser?.uid]);\n\n  // Keep ref in sync for early-defined helpers/modals\n  React.useEffect(() => {\n    hierarchyRef.current = hierarchy;\n  }, [hierarchy]);\n\n  // Company profile (used for per-company feature visibility)\n  const [companyProfile, setCompanyProfile] = useState(null);\n  const [controlTypes, setControlTypes] = useState(DEFAULT_CONTROL_TYPES);\n\n  // Load full control type list (default + company-specific) for the active company\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      if (!companyId) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n        return;\n      }\n      try {\n        const list = await fetchCompanyControlTypes(companyId);\n        if (mounted && Array.isArray(list) && list.length > 0) {\n          setControlTypes(list);\n        } else if (mounted) {\n          setControlTypes(DEFAULT_CONTROL_TYPES);\n        }\n      } catch (_e) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n      }\n    })();\n    return () => { mounted = false; };\n  }, [companyId]);\n\n  const controlTypeOptions = React.useMemo(() => {\n    const baseList = Array.isArray(controlTypes) && controlTypes.length > 0\n      ? controlTypes\n      : DEFAULT_CONTROL_TYPES;\n\n    // If we have any custom (non-builtin) control types, we treat the\n    // per-company list as the source of truth and ignore the older\n    // enabledControlTypes filter from the company profile.\n    const hasCustomTypes = baseList.some(ct => ct && ct.builtin === false);\n\n    let visible = baseList.filter(ct => ct && ct.hidden !== true);\n\n    const enabled = companyProfile?.enabledControlTypes;\n    if (!hasCustomTypes && Array.isArray(enabled) && enabled.length > 0) {\n      const enabledSet = new Set(enabled.map(v => String(v || '').trim()).filter(Boolean));\n      visible = visible.filter((ct) => {\n        const name = String(ct.name || '').trim();\n        const key = String(ct.key || '').trim();\n        if (!enabledSet.size) return true;\n        return (name && enabledSet.has(name)) || (key && enabledSet.has(key));\n      });\n    }\n\n    return visible.map((ct) => ({\n      type: ct.name || ct.key || '',\n      icon: ct.icon || 'document-text-outline',\n      color: ct.color || '#455A64',\n    })).filter(o => o.type);\n  }, [controlTypes, companyProfile]);\n\n  // Load company profile when companyId changes\n  React.useEffect(() => {\n    let active = true;\n    if (!companyId) {\n      setCompanyProfile(null);\n      return () => { active = false; };\n    }\n    fetchCompanyProfile(companyId)\n      .then((p) => { if (active) setCompanyProfile(p || null); })\n      .catch((e) => { /* ignore */ });\n    return () => { active = false; };\n  }, [companyId]);\n\n  // Recompute whether any local fallback data exists (hierarki eller kontroller)\n  async function refreshLocalFallbackFlag() {\n    try {\n      const [h, c, d] = await Promise.all([\n        AsyncStorage.getItem('hierarchy_local'),\n        AsyncStorage.getItem('completed_controls'),\n        AsyncStorage.getItem('draft_controls'),\n      ]);\n      const exists = !!((h && h !== '[]') || (c && c !== '[]') || (d && d !== '[]'));\n      setLocalFallbackExists(exists);\n    } catch(_e) {}\n  }\n  \n  // Debug helper: dump local AsyncStorage keys and compare with Firestore counts\n  async function dumpLocalRemoteControls() {\n    try {\n      const keys = ['hierarchy_local', 'completed_controls', 'draft_controls', 'completed_controls_backup', 'draft_controls_backup'];\n      const data = {};\n      for (const k of keys) {\n        try {\n          const raw = await AsyncStorage.getItem(k);\n          data[k] = raw ? JSON.parse(raw) : null;\n        } catch(_e) { data[k] = null; }\n      }\n      // Build summary\n      const summary = {\n        completed_count: Array.isArray(data.completed_controls) ? data.completed_controls.length : 0,\n        draft_count: Array.isArray(data.draft_controls) ? data.draft_controls.length : 0,\n        backups: {\n          completed_backup_exists: !!data.completed_controls_backup,\n          draft_backup_exists: !!data.draft_controls_backup,\n        },\n      };\n\n      // Query Firestore for any project IDs found in local completed controls\n      const projectIds = new Set();\n      (data.completed_controls || []).forEach(c => { if (c && c.project && c.project.id) projectIds.add(String(c.project.id)); });\n      (data.draft_controls || []).forEach(d => { if (d && d.project && d.project.id) projectIds.add(String(d.project.id)); });\n\n      const remoteInfo = {};\n      for (const pid of projectIds) {\n        try {\n          const remote = await fetchControlsForProject(pid, companyId).catch((e) => []);\n          remoteInfo[pid] = { remote_count: Array.isArray(remote) ? remote.length : 0, sample_ids: (remote || []).slice(0,5).map(r => r.id) };\n        } catch(_e) {\n          remoteInfo[pid] = { remote_count: -1, error: String(_e) };\n        }\n      }\n      const final = { summary, remote: remoteInfo, sample_local_completed: (data.completed_controls || []).slice(0,5).map(c => ({ id: c.id, projectId: c.project?.id })) };\n      try { console.log('[dumpLocalRemoteControls] full dump', final); } catch(_e) {}\n      showAlert('Debug: lokal vs moln', JSON.stringify(final, null, 2).slice(0,1000));\n    } catch(_e) {\n      showAlert('Debug-fel', String(_e));\n    }\n  }\n\n  // Show the last Firestore error saved by firebase helpers\n  async function showLastFsError() {\n    try {\n      // Prefer the full errors array if available\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      if (rawArr) {\n        let parsedArr = null;\n          try { parsedArr = JSON.parse(rawArr); } catch(_e) { parsedArr = [rawArr]; }\n        // Show the most recent entry first (arrays can get huge)\n        const last = Array.isArray(parsedArr) ? parsedArr[parsedArr.length - 1] : parsedArr;\n        return showAlert('Senaste FS-fel', JSON.stringify(last, null, 2).slice(0,2000));\n      }\n      // Fallback to single-entry key for older records\n      const raw = await AsyncStorage.getItem('dk_last_fs_error');\n      if (!raw) return showAlert('Senaste FS-fel', 'Ingen fel-logg hittades.');\n      let parsed = null;\n      try { parsed = JSON.parse(raw); } catch(_e) { parsed = { raw }; }\n      showAlert('Senaste FS-fel', JSON.stringify(parsed, null, 2).slice(0,2000));\n    } catch(_e) {\n      showAlert('Fel', 'Kunde inte läsa dk_last_fs_error: ' + (_e?.message || _e));\n    }\n  }\n  \n\n  // start background sync hook\n  useBackgroundSync(companyId, { onStatus: (s) => setSyncStatus(s) });\n  const didInitialLoadRef = React.useRef(false);\n\n  // Left column resizer state (default 320)\n  const [leftWidth, setLeftWidth] = useState(320);\n  const leftWidthRef = useRef(leftWidth);\n  useEffect(() => { leftWidthRef.current = leftWidth; }, [leftWidth]);\n  const initialLeftRef = useRef(0);\n\n  // Right column resizer state (default 420)\n  const [rightWidth, setRightWidth] = useState(420);\n  const rightWidthRef = useRef(rightWidth);\n  useEffect(() => { rightWidthRef.current = rightWidth; }, [rightWidth]);\n  const initialRightRef = useRef(0);\n\n  // PanResponder for resizing the left column (works on web + native)\n  const panResponder = useRef(PanResponder.create({\n    onStartShouldSetPanResponder: (evt, gestureState) => true,\n    onPanResponderGrant: () => {\n      initialLeftRef.current = leftWidthRef.current;\n    },\n    onPanResponderMove: (evt, gestureState) => {\n      const dx = gestureState.dx || 0;\n      const newWidth = Math.max(240, Math.min(800, initialLeftRef.current + dx));\n      setLeftWidth(newWidth);\n    },\n    onPanResponderRelease: () => {},\n    onPanResponderTerminate: () => {},\n  })).current;\n\n  // PanResponder for resizing the right column (works on web + native)\n  const panResponderRight = useRef(PanResponder.create({\n    onStartShouldSetPanResponder: (evt, gestureState) => true,\n    onPanResponderGrant: () => {\n      initialRightRef.current = rightWidthRef.current;\n    },\n    onPanResponderMove: (evt, gestureState) => {\n      const dx = gestureState.dx || 0;\n      // Dragging the left edge: moving right (dx>0) should decrease width, moving left (dx<0) should increase\n      const newWidth = Math.max(340, Math.min(520, initialRightRef.current - dx));\n      setRightWidth(newWidth);\n    },\n    onPanResponderRelease: () => {},\n    onPanResponderTerminate: () => {},\n  })).current;\n\n  // Ensure panes start at their minimum widths on web after first mount\n  const initialPaneWidthsSetRef = useRef(false);\n  useEffect(() => {\n    if (Platform.OS === 'web' && !initialPaneWidthsSetRef.current) {\n      setLeftWidth(240); // left min\n      setRightWidth(340); // right min\n      initialPaneWidthsSetRef.current = true;\n    }\n  }, []);\n\n\n  // Ladda hierarchy från Firestore vid appstart\n  React.useEffect(() => {\n    (async () => {\n      let cid = companyId;\n      // If companyId not provided via params, try user profile by uid\n      if (!cid && route?.params?.uid) {\n        const userProfile = await fetchUserProfile(route.params.uid);\n        if (userProfile && userProfile.companyId) {\n          cid = userProfile.companyId;\n          setCompanyId(cid);\n        }\n      }\n      // As a last resort try local stored companyId (dk_companyId)\n      if (!cid) {\n        try {\n          const stored = await AsyncStorage.getItem('dk_companyId');\n          if (stored) {\n            cid = stored;\n            setCompanyId(cid);\n          }\n        } catch(_e) {}\n      }\n      if (cid) {\n        setLoadingHierarchy(true);\n        const items = await fetchHierarchy(cid);\n        if (Array.isArray(items) && items.length > 0) {\n          setHierarchy(collapseHierarchy(items));\n        } else {\n          // Firestore empty or failed — try local AsyncStorage fallback\n          try {\n            const raw = await AsyncStorage.getItem('hierarchy_local');\n            if (raw) {\n              const parsed = JSON.parse(raw);\n              if (Array.isArray(parsed) && parsed.length > 0) {\n                setHierarchy(collapseHierarchy(parsed));\n                setLocalFallbackExists(true);\n                // Try to push local fallback to Firestore (best-effort)\n                try {\n                  const pushedRes = await saveHierarchy(cid, parsed);\n                  const pushed = pushedRes === true || (pushedRes && pushedRes.ok === true);\n                  if (pushed) {\n                    try { await AsyncStorage.removeItem('hierarchy_local'); } catch(_e) {}\n                    await refreshLocalFallbackFlag();\n                  } else {\n                    try { console.error('[Home] push local fallback error', pushedRes && pushedRes.error ? pushedRes.error : pushedRes); } catch(_e) {}\n                  }\n                } catch(_e) {}\n              } else {\n                setHierarchy([]);\n              }\n            } else {\n              setHierarchy([]);\n            }\n          } catch(_e) {\n              setHierarchy([]);\n            }\n        }\n        setLoadingHierarchy(false);\n        // mark that initial load completed to avoid initial empty save overwriting server\n        didInitialLoadRef.current = true;\n      }\n    })();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Visa migreringsknappen även om det finns lokala kontroller (completed/draft)\n  React.useEffect(() => {\n    (async () => {\n      try {\n        const completed = await AsyncStorage.getItem('completed_controls');\n        const drafts = await AsyncStorage.getItem('draft_controls');\n        if ((completed && completed !== '[]') || (drafts && drafts !== '[]')) {\n          setLocalFallbackExists(true);\n        }\n      } catch(_e) {\n        // ignore\n      }\n    })();\n  }, []);\n\n  // Spara hierarchy till Firestore varje gång den ändras (och companyId finns)\n  React.useEffect(() => {\n    if (!companyId) return;\n    // don't save before initial load finished (avoid overwriting server with empty on mount)\n    if (!didInitialLoadRef.current) return;\n    (async () => {\n      try {\n        const res = await saveHierarchy(companyId, hierarchy);\n        const ok = res === true || (res && res.ok === true);\n        if (!ok) {\n          // Firestore save failed — persist locally as fallback\n          try {\n            await AsyncStorage.setItem('hierarchy_local', JSON.stringify(hierarchy || []));\n            setLocalFallbackExists(true);\n          } catch(_e) {}\n        } else {\n          // On successful cloud save, also clear local fallback\n            try {\n            await AsyncStorage.removeItem('hierarchy_local');\n            await refreshLocalFallbackFlag();\n          } catch(_e) {}\n        }\n      } catch(_e) {\n        try {\n          await AsyncStorage.setItem('hierarchy_local', JSON.stringify(hierarchy || []));\n          setLocalFallbackExists(true);\n        } catch(_e) {}\n      }\n    })();\n     \n  }, [hierarchy, companyId]);\n\n  // Remove all top-level folders named 'test' after initial load\n  React.useEffect(() => {\n    setHierarchy(prev => prev.filter(folder => folder.name.trim().toLowerCase() !== 'test'));\n  }, []);\n  // Search modal state\n  const [searchModalVisible, setSearchModalVisible] = useState(false);\n  const [searchText, setSearchText] = useState('');\n  const [keyboardHeight, setKeyboardHeight] = useState(0);\n\n  const openSearchModal = React.useCallback(() => {\n    // Ensure the popup doesn't start \"lifted\" due to stale keyboard height\n    setKeyboardHeight(0);\n    setSearchModalVisible(true);\n  }, []);\n\n  const closeSearchModal = React.useCallback(() => {\n    setSearchModalVisible(false);\n    setSearchText('');\n    setKeyboardHeight(0);\n  }, []);\n\n  // Header search dropdown (between logos): search among created projects in hierarchy\n  const headerProjectQuery = String(route?.params?.headerProjectSearchText || '').trim();\n  const headerSearchOpen = React.useMemo(() => {\n    // default: open when there is a query; explicit false closes dropdown\n    if (Object.prototype.hasOwnProperty.call(route?.params || {}, 'headerSearchOpen')) {\n      return !!route.params.headerSearchOpen;\n    }\n    return !!headerProjectQuery;\n  }, [route?.params, headerProjectQuery]);\n  const headerSearchWidth = React.useMemo(() => {\n    const w = Number(route?.params?.headerSearchWidth || 0);\n    return Number.isFinite(w) && w > 0 ? w : null;\n  }, [route?.params]);\n  const headerSearchBottom = React.useMemo(() => {\n    const b = Number(route?.params?.headerSearchBottom || 0);\n    return Number.isFinite(b) && b > 0 ? b : 71;\n  }, [route?.params]);\n  const headerSearchLeft = React.useMemo(() => {\n    const l = Number(route?.params?.headerSearchLeft || 0);\n    return Number.isFinite(l) ? l : null;\n  }, [route?.params]);\n  const headerProjectMatches = React.useMemo(() => {\n    if (!headerProjectQuery) return [];\n    const q = headerProjectQuery.toLowerCase();\n    const out = [];\n\n    for (const main of (hierarchy || [])) {\n      for (const sub of (main?.children || [])) {\n        for (const child of (sub?.children || [])) {\n          if (child?.type !== 'project') continue;\n          const id = String(child?.id || '');\n          const name = String(child?.name || '');\n          if (id.toLowerCase().includes(q) || name.toLowerCase().includes(q)) {\n            out.push(child);\n            if (out.length >= 25) return out;\n          }\n        }\n      }\n    }\n\n    return out;\n  }, [headerProjectQuery, hierarchy]);\n\n  // Web-only UX: hover highlight + subtle open animation for dropdown\n  const [hoveredProjectId, setHoveredProjectId] = useState(null);\n  const dropdownAnim = React.useRef(new Animated.Value(0)).current;\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    Animated.timing(dropdownAnim, {\n      toValue: headerProjectQuery ? 1 : 0,\n      duration: 140,\n      easing: Easing.out(Easing.cubic),\n      useNativeDriver: (Platform && Platform.OS === 'web') ? false : true,\n    }).start();\n  }, [headerProjectQuery, dropdownAnim]);\n\n  // Native: keep search modal above the keyboard\n  React.useEffect(() => {\n    if (Platform.OS === 'web') return;\n    const subs = [];\n    const onShow = (e) => setKeyboardHeight(e?.endCoordinates?.height || 0);\n    const onHide = () => setKeyboardHeight(0);\n\n    // iOS is often more reliable with *Will* events\n    subs.push(Keyboard.addListener('keyboardWillShow', onShow));\n    subs.push(Keyboard.addListener('keyboardWillHide', onHide));\n    subs.push(Keyboard.addListener('keyboardDidShow', onShow));\n    subs.push(Keyboard.addListener('keyboardDidHide', onHide));\n\n    return () => {\n      for (const s of subs) {\n        try { s.remove(); } catch(_e) {}\n      }\n    };\n  }, []);\n\n  // App (native): filter projects by status\n  const [projectStatusFilter, setProjectStatusFilter] = useState('all'); // 'all' | 'ongoing' | 'completed'\n  const [filterModalVisible, setFilterModalVisible] = useState(false);\n\n  // Web: right-click context menu for folder tree\n  const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, target: null });\n  const ensuredDefaultMainRef = useRef(false);\n\n  // Web: hover highlight for tree rows\n  const [hoveredRowKey, setHoveredRowKey] = useState(null);\n  const getRowKey = React.useCallback((type, mainId, subId, projectId) => {\n    return [type, mainId ?? '', subId ?? '', projectId ?? ''].join(':');\n  }, []);\n\n  const closeContextMenu = React.useCallback(() => {\n    setContextMenu(prev => ({ ...prev, visible: false, target: null }));\n  }, []);\n\n  const getContextCoords = React.useCallback((e) => {\n    const ne = e?.nativeEvent || e;\n    const rawX = ne?.pageX ?? ne?.clientX ?? 0;\n    const rawY = ne?.pageY ?? ne?.clientY ?? 0;\n    const menuWidth = 220;\n    const menuHeight = 220;\n    if (typeof window !== 'undefined') {\n      const maxX = Math.max(8, (window.innerWidth || rawX) - menuWidth - 8);\n      const maxY = Math.max(8, (window.innerHeight || rawY) - menuHeight - 8);\n      return { x: Math.min(rawX, maxX), y: Math.min(rawY, maxY) };\n    }\n    return { x: rawX, y: rawY };\n  }, []);\n\n  const openContextMenu = React.useCallback((e, target) => {\n    if (Platform.OS !== 'web') return;\n    try { e?.preventDefault?.(); } catch(_e) {}\n    const { x, y } = getContextCoords(e);\n    setContextMenu({ visible: true, x, y, target });\n  }, [getContextCoords]);\n\n  // Web-only: intercept the *real* DOM contextmenu event so the browser menu never opens.\n  // RN-web doesn't reliably fire onContextMenu for all components.\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof document === 'undefined') return;\n\n    const handler = (ev) => {\n      const rootEl = document.getElementById('dk-tree-root');\n      if (!rootEl) return;\n      if (!rootEl.contains(ev.target)) return;\n\n      // Always block the browser menu within the tree area\n      ev.preventDefault();\n      ev.stopPropagation();\n\n      const rowEl = ev.target?.closest?.('[data-dk-type]');\n      if (!rowEl) return;\n\n      const dkType = rowEl.getAttribute('data-dk-type');\n      const mainId = rowEl.getAttribute('data-dk-mainid');\n      const subId = rowEl.getAttribute('data-dk-subid');\n      const projectId = rowEl.getAttribute('data-dk-projectid');\n\n      let target = null;\n      if (dkType === 'main') {\n        target = { type: 'main', mainId };\n      } else if (dkType === 'sub') {\n        target = { type: 'sub', mainId, subId };\n      } else if (dkType === 'project') {\n        // Lookup project object from current hierarchy\n        let project = null;\n        for (const m of hierarchy || []) {\n          if (String(m.id) !== String(mainId)) continue;\n          for (const s of m.children || []) {\n            if (String(s.id) !== String(subId)) continue;\n            project = (s.children || []).find(ch => ch?.type === 'project' && String(ch.id) === String(projectId)) || null;\n          }\n        }\n        target = { type: 'project', mainId, subId, project };\n      }\n\n      if (!target) return;\n      openContextMenu(ev, target);\n    };\n\n    document.addEventListener('contextmenu', handler, { capture: true });\n    return () => document.removeEventListener('contextmenu', handler, { capture: true });\n  }, [hierarchy, openContextMenu]);\n\n  // Ensure at least one main folder exists (important since we remove the + button)\n  React.useEffect(() => {\n    if (!companyId) return;\n    if (!didInitialLoadRef.current) return;\n    if (ensuredDefaultMainRef.current) return;\n    if (Array.isArray(hierarchy) && hierarchy.length === 0) {\n      ensuredDefaultMainRef.current = true;\n        setHierarchy([\n        {\n          id: (Math.random() * 100000).toFixed(0),\n          name: 'Huvudmapp',\n          expanded: false,\n          children: [],\n        },\n      ]);\n    }\n  }, [hierarchy, companyId]);\n\n  const renameMainFolderWeb = React.useCallback((mainId) => {\n    const current = hierarchy.find(m => m.id === mainId);\n    const currentName = current?.name || '';\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const nextName = (window.prompt('Byt namn på huvudmapp', currentName) || '').trim();\n      if (!nextName) return;\n      setHierarchy(prev => prev.map(m => (m.id === mainId ? { ...m, name: nextName } : m)));\n      return;\n    }\n    setEditModal({ visible: true, type: 'main', id: mainId, name: currentName });\n  }, [hierarchy]);\n\n  const renameSubFolderWeb = React.useCallback((subId) => {\n    let currentName = '';\n    hierarchy.forEach(m => {\n      (m.children || []).forEach(s => {\n        if (s.id === subId) currentName = s.name || '';\n      });\n    });\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const nextName = (window.prompt('Byt namn på undermapp', currentName) || '').trim();\n      if (!nextName) return;\n      setHierarchy(prev => prev.map(m => ({\n        ...m,\n        children: (m.children || []).map(s => (s.id === subId ? { ...s, name: nextName } : s)),\n      })));\n      return;\n    }\n    setEditModal({ visible: true, type: 'sub', id: subId, name: currentName });\n  }, [hierarchy]);\n\n  const deleteMainFolderGuarded = React.useCallback((mainId) => {\n    const mainName = (hierarchy || []).find(m => m.id === mainId)?.name || '';\n    if ((hierarchy || []).length <= 1) {\n      if (Platform.OS === 'web' && typeof window !== 'undefined') {\n        window.alert('Kan inte radera.\\n\\nDet måste finnas minst en huvudmapp.');\n      } else {\n        Alert.alert('Kan inte radera', 'Det måste finnas minst en huvudmapp.');\n      }\n      return;\n    }\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const ok = window.confirm(`Vill du verkligen radera huvudmappen${mainName ? ` \"${mainName}\"` : ''}?`);\n      if (!ok) return;\n      setHierarchy(prev => prev.filter(m => m.id !== mainId));\n      return;\n    }\n\n    Alert.alert('Radera huvudmapp', `Vill du verkligen radera huvudmappen${mainName ? ` \"${mainName}\"` : ''}?`, [\n      { text: 'Avbryt', style: 'cancel' },\n      {\n        text: 'Radera',\n        style: 'destructive',\n        onPress: () => setHierarchy(prev => prev.filter(m => m.id !== mainId)),\n      },\n    ]);\n  }, [hierarchy]);\n\n  const deleteSubFolder = React.useCallback((mainId, subId) => {\n    const main = (hierarchy || []).find(m => m.id === mainId);\n    const subName = (main?.children || []).find(s => s.id === subId)?.name || '';\n\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const ok = window.confirm(`Vill du verkligen radera undermappen${subName ? ` \"${subName}\"` : ''}?`);\n      if (!ok) return;\n      setHierarchy(prev => prev.map(m => (\n        m.id === mainId\n          ? { ...m, children: (m.children || []).filter(s => s.id !== subId) }\n          : m\n      )));\n      return;\n    }\n\n    Alert.alert('Radera undermapp', `Vill du verkligen radera undermappen${subName ? ` \"${subName}\"` : ''}?`, [\n      { text: 'Avbryt', style: 'cancel' },\n      {\n        text: 'Radera',\n        style: 'destructive',\n        onPress: () => setHierarchy(prev => prev.map(m => (\n          m.id === mainId\n            ? { ...m, children: (m.children || []).filter(s => s.id !== subId) }\n            : m\n        ))),\n      },\n    ]);\n  }, [hierarchy]);\n\n  const renameProjectWeb = React.useCallback((projectId) => {\n    let currentName = '';\n    hierarchy.forEach(m => {\n      (m.children || []).forEach(s => {\n        (s.children || []).forEach(ch => {\n          if (ch?.type === 'project' && ch.id === projectId) currentName = ch.name || '';\n        });\n      });\n    });\n\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const nextName = (window.prompt('Byt namn på projekt', currentName) || '').trim();\n      if (!nextName) return;\n      setHierarchy(prev => prev.map(m => ({\n        ...m,\n        children: (m.children || []).map(s => ({\n          ...s,\n          children: (s.children || []).map(ch => (\n            ch?.type === 'project' && ch.id === projectId ? { ...ch, name: nextName } : ch\n          )),\n        })),\n      })));\n      return;\n    }\n  }, [hierarchy]);\n\n  const deleteProject = React.useCallback((mainId, subId, projectId) => {\n    const main = (hierarchy || []).find(m => m.id === mainId);\n    const sub = (main?.children || []).find(s => s.id === subId);\n    const projName = (sub?.children || []).find(ch => ch?.type === 'project' && ch.id === projectId)?.name || '';\n\n    if (Platform.OS === 'web' && typeof window !== 'undefined') {\n      const ok = window.confirm(`Vill du verkligen radera projektet ${projectId}${projName ? ` — ${projName}` : ''}?`);\n      if (!ok) return;\n      setHierarchy(prev => prev.map(m => (\n        m.id !== mainId\n          ? m\n          : {\n            ...m,\n            children: (m.children || []).map(s => (\n              s.id !== subId\n                ? s\n                : { ...s, children: (s.children || []).filter(ch => !(ch?.type === 'project' && ch.id === projectId)) }\n            )),\n          }\n      )));\n      return;\n    }\n\n    Alert.alert('Radera projekt', `Vill du verkligen radera projektet ${projectId}${projName ? ` — ${projName}` : ''}?`, [\n      { text: 'Avbryt', style: 'cancel' },\n      {\n        text: 'Radera',\n        style: 'destructive',\n        onPress: () => setHierarchy(prev => prev.map(m => (\n          m.id !== mainId\n            ? m\n            : {\n              ...m,\n              children: (m.children || []).map(s => (\n                s.id !== subId\n                  ? s\n                  : { ...s, children: (s.children || []).filter(ch => !(ch?.type === 'project' && ch.id === projectId)) }\n              )),\n            }\n        ))),\n      },\n    ]);\n  }, [hierarchy]);\n\n  const copyProjectWeb = React.useCallback((mainId, subId, project) => {\n    if (Platform.OS !== 'web' || typeof window === 'undefined') return;\n    if (!project || project.type !== 'project') return;\n\n    const suggestedId = String(project.id || '').trim();\n    const suggestedName = String(project.name || '').trim();\n    const newId = (window.prompt('Nytt projektnummer', suggestedId) || '').trim();\n    if (!newId) return;\n    if (!isProjectNumberUnique(newId)) {\n      Alert.alert('Fel', 'Projektnummer används redan.');\n      return;\n    }\n    const newName = (window.prompt('Nytt projektnamn', suggestedName) || '').trim();\n    if (!newName) return;\n\n    const copy = {\n      ...project,\n      id: newId,\n      name: newName,\n      createdAt: new Date().toISOString(),\n      status: project.status || 'ongoing',\n    };\n\n    setHierarchy(prev => prev.map(m => (\n      m.id !== mainId\n        ? m\n        : {\n          ...m,\n          children: (m.children || []).map(s => (\n            s.id !== subId\n              ? s\n              : { ...s, children: [...(s.children || []), copy] }\n          )),\n        }\n    )));\n  }, [isProjectNumberUnique]);\n\n  const contextMenuItems = React.useMemo(() => {\n    const t = contextMenu.target;\n    if (!t) return [];\n    if (t.type === 'main') {\n      return [\n        { key: 'addMain', label: 'Lägg till huvudmapp', icon: '📁' },\n        { key: 'addSub', label: 'Lägg till undermapp', icon: '📂' },\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true, disabled: (hierarchy || []).length <= 1 },\n      ];\n    }\n    if (t.type === 'sub') {\n      return [\n        { key: 'addProject', label: 'Lägg till projekt', icon: '➕' },\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true },\n      ];\n    }\n    if (t.type === 'project') {\n      return [\n        { key: 'open', label: 'Öppna projekt', icon: '📄' },\n        { key: 'addControl', label: 'Skapa ny kontroll', icon: '✅' },\n        { key: 'copy', label: 'Kopiera projekt', icon: '📋' },\n        { key: 'rename', label: 'Byt namn', icon: '✏️' },\n        { key: 'delete', label: 'Radera', icon: '🗑️', danger: true },\n      ];\n    }\n    return [];\n  }, [contextMenu.target, hierarchy]);\n\n  const handleContextMenuSelect = React.useCallback((item) => {\n    const t = contextMenu.target;\n    if (!t) return;\n\n    if (t.type === 'main') {\n      const mainId = t.mainId;\n      switch (item.key) {\n        case 'addMain':\n          setNewFolderModalVisible(true);\n          setNewSubName('');\n          break;\n        case 'addSub':\n          setNewSubModal({ visible: true, parentId: mainId });\n          setNewSubName('');\n          break;\n        case 'rename':\n          renameMainFolderWeb(mainId);\n          break;\n        case 'delete':\n          deleteMainFolderGuarded(mainId);\n          break;\n      }\n    }\n\n    if (t.type === 'sub') {\n      const mainId = t.mainId;\n      const subId = t.subId;\n      switch (item.key) {\n        case 'addProject':\n          setNewProjectModal({ visible: true, parentSubId: subId });\n          setNewProjectName('');\n          setNewProjectNumber('');\n          break;\n        case 'rename':\n          renameSubFolderWeb(subId);\n          break;\n        case 'delete':\n          deleteSubFolder(mainId, subId);\n          break;\n      }\n    }\n\n    if (t.type === 'project') {\n      const mainId = t.mainId;\n      const subId = t.subId;\n      const project = t.project;\n      switch (item.key) {\n        case 'open':\n          if (project && Platform.OS === 'web') requestProjectSwitch(project, { selectedAction: null });\n          break;\n        case 'addControl':\n          if (project) {\n            setProjectControlSelectedType(controlTypeOptions[0]?.type || '');\n            setProjectControlTypePickerOpen(false);\n            setProjectControlTemplates([]);\n            setProjectControlSelectedTemplateId('');\n            setProjectControlTemplatePickerOpen(false);\n            setProjectControlTemplateSearch('');\n            (async () => {\n              try {\n                const cid = String(companyId || routeCompanyId || authClaims?.companyId || '').trim();\n                if (cid) {\n                  const items = await fetchCompanyMallar(cid).catch(() => []);\n                  const list = Array.isArray(items) ? items : [];\n                  setProjectControlTemplates(list);\n                }\n              } catch(_e) {}\n              setProjectControlModal({ visible: true, project });\n            })();\n          }\n          break;\n        case 'copy':\n          copyProjectWeb(mainId, subId, project);\n          break;\n        case 'rename':\n          if (project?.id) renameProjectWeb(project.id);\n          break;\n        case 'delete':\n          if (project?.id) deleteProject(mainId, subId, project.id);\n          break;\n      }\n    }\n  }, [contextMenu.target, deleteMainFolderGuarded, deleteSubFolder, renameMainFolderWeb, renameSubFolderWeb, requestProjectSwitch, copyProjectWeb, deleteProject, renameProjectWeb]);\n\n  function toggleExpand(level, id, parentArr = hierarchy) {\n    return parentArr.map(item => {\n      if (item.id === id) {\n        return { ...item, expanded: !item.expanded };\n      } else if (item.children) {\n        return { ...item, children: toggleExpand(level + 1, id, item.children) };\n      }\n      return item;\n    });\n  }\n\n  const handleToggleMainFolder = (mainId) => {\n    setHierarchy(prev => prev.map(m => m.id === mainId ? { ...m, expanded: !m.expanded } : { ...m, expanded: false }));\n    setSpinMain(prev => ({ ...prev, [mainId]: (prev[mainId] || 0) + 1 }));\n  };\n\n  const handleToggleSubFolder = (subId) => {\n    setHierarchy(prev => toggleExpand(1, subId, prev));\n    setSpinSub(prev => ({ ...prev, [subId]: (prev[subId] || 0) + 1 }));\n  };\n\n  // Stil för återanvändning\n// eslint-disable-next-line no-unused-vars\nconst _kontrollKnappStil = { backgroundColor: '#fff', borderRadius: 16, marginBottom: 16, alignItems: 'center', flexDirection: 'row', justifyContent: 'center', shadowColor: '#1976D2', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2, minHeight: 56, maxWidth: 240, width: '90%', paddingLeft: 14, paddingRight: 10, overflow: 'hidden', borderWidth: 2, borderColor: '#222' };\n// eslint-disable-next-line no-unused-vars\nconst _kontrollTextStil = { color: '#222', fontWeight: '600', fontSize: 17, letterSpacing: 0.5, zIndex: 1 };\n\n    // Dashboard: gemensamma stilar (återanvänd befintliga färger)\n    const dashboardContainerStyle = React.useMemo(() => ({ width: '100%', maxWidth: 1180, alignSelf: 'center' }), []);\n    const dashboardColumnsStyle = React.useMemo(() => ({ flexDirection: 'row', alignItems: 'flex-start', flexWrap: 'wrap' }), []);\n    const dashboardSectionTitleStyle = React.useMemo(() => ({ fontSize: 20, fontWeight: '700', color: '#222', marginBottom: 10 }), []);\n    const dashboardCardStyle = React.useMemo(() => ({ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' }), []);\n    const dashboardCardDenseStyle = React.useMemo(() => ({ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 10, backgroundColor: '#fff' }), []);\n    const dashboardEmptyTextStyle = React.useMemo(() => ({ color: '#777', padding: 12 }), []);\n    const dashboardMetaTextStyle = React.useMemo(() => ({ fontSize: 12, color: '#888', marginTop: 2 }), []);\n    const dashboardLinkTitleStyle = React.useMemo(() => ({ fontSize: 13, color: '#1976D2', fontWeight: '400' }), []);\n    const dashboardListItemStyle = React.useCallback((idx) => ({\n      paddingVertical: 8,\n      paddingHorizontal: 6,\n      borderTopWidth: idx === 0 ? 0 : 1,\n      borderTopColor: '#eee',\n    }), []);\n    // Compact variants for the activity list (reduce vertical footprint)\n    const dashboardActivityListItemStyle = React.useCallback((idx) => ({\n      paddingVertical: 6,\n      paddingHorizontal: 6,\n      borderTopWidth: idx === 0 ? 0 : 1,\n      borderTopColor: '#eee',\n    }), []);\n    const dashboardActivityTitleCompactStyle = React.useMemo(() => ({ fontSize: 14, color: '#222', fontWeight: '600' }), []);\n    const dashboardActivityMetaCompactStyle = React.useMemo(() => ({ fontSize: 12, color: '#777', marginTop: 0 }), []);\n    const dashboardStatRowStyle = React.useCallback((idx) => ({\n      flexDirection: 'row',\n      alignItems: 'center',\n      paddingVertical: 8,\n      borderTopWidth: idx === 0 ? 0 : 1,\n      borderTopColor: '#eee',\n    }), []);\n    const dashboardStatDotStyle = React.useCallback((color) => ({ width: 10, height: 10, borderRadius: 5, backgroundColor: color, marginRight: 12 }), []);\n    const dashboardStatLabelStyle = React.useMemo(() => ({ flex: 1, fontSize: 15, color: '#222' }), []);\n    const dashboardStatValueStyle = React.useMemo(() => ({ fontSize: 16, fontWeight: '400', color: '#222' }), []);\n    const dashboardActivityTitleStyle = React.useMemo(() => ({ fontSize: 15, color: '#222', fontWeight: '600' }), []);\n\n    const ActivityPanel = React.useCallback(() => {\n      return (\n        <View style={{ flex: 1, minWidth: 0 }}>\n          {/* Moved Overview: show Översikt at top of right-hand panel */}\n          <Text style={dashboardSectionTitleStyle}>Översikt</Text>\n          <View\n            style={[dashboardCardStyle, { padding: 12, marginBottom: 20 }]}\n            onLayout={Platform.OS === 'web' ? (e) => { dashboardCardLayoutRef.current.overview = e?.nativeEvent?.layout || null; } : undefined}\n          >\n            {[\n              { key: 'activeProjects', label: 'Pågående projekt', color: '#43A047', value: dashboardOverview.activeProjects, focus: 'activeProjects' },\n              { key: 'completedProjects', label: 'Avslutade projekt', color: '#222', value: (_countProjectStatus ? _countProjectStatus(hierarchy).completed : 0), focus: 'completedProjects' },\n              { key: 'controlsToSign', label: 'Kontroller att signera', color: '#D32F2F', value: dashboardOverview.controlsToSign, focus: 'controlsToSign' },\n              { key: 'drafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts' },\n            ].map((row, ridx) => {\n              const isWeb = Platform.OS === 'web';\n              const isHovered = isWeb && dashboardHoveredStatKey === row.key;\n              const isOpen = isWeb && dashboardFocus === row.focus && dashboardDropdownAnchor === 'overview';\n              const openFromRow = () => {\n                const cardLayout = dashboardCardLayoutRef.current.overview;\n                const rowLayout = dashboardStatRowLayoutRef.current[`overview:${row.key}`];\n                // Position top flush under the row (no extra gap)\n                const top = (cardLayout && rowLayout) ? (cardLayout.y + rowLayout.y + rowLayout.height) : undefined;\n                console.log && console.log('dashboard: overview row press', row.key, row.focus, { cardLayout, rowLayout, top });\n                setDashboardHoveredStatKey(row.key);\n                setDashboardDropdownRowKey(row.key);\n                toggleDashboardFocus(row.focus, 'overview', top);\n              };\n              return (\n                <TouchableOpacity\n                  key={row.key}\n                  style={{\n                    ...dashboardStatRowStyle(ridx),\n                    paddingHorizontal: 6,\n                    borderRadius: 8,\n                    borderWidth: 1,\n                    borderColor: isHovered ? '#1976D2' : 'transparent',\n                    backgroundColor: isHovered ? '#eee' : 'transparent',\n                    cursor: isWeb ? 'pointer' : undefined,\n                    transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\n                  }}\n                  activeOpacity={0.75}\n                  onPress={openFromRow}\n                  onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\n                  onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\n                  onLayout={isWeb ? (e) => {\n                    const l = e?.nativeEvent?.layout;\n                    if (l) dashboardStatRowLayoutRef.current[`overview:${row.key}`] = l;\n                  } : undefined}\n                >\n                  <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} />\n                  <View style={dashboardStatDotStyle(row.color)} />\n                  <Text style={dashboardStatLabelStyle}>{row.label}</Text>\n                  <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\n                </TouchableOpacity>\n              );\n            })}\n          </View>\n\n          {/* Overview dropdown overlay (renders inside ActivityPanel, below Overview card) */}\n          {Platform.OS === 'web' && dashboardFocus && dashboardDropdownAnchor === 'overview' ? (\n            <View\n              style={(function() {\n                try {\n                  const ov = dashboardCardLayoutRef.current.overview;\n                  const rKey = dashboardDropdownRowKey;\n                  const rowLayout = rKey ? dashboardStatRowLayoutRef.current[`overview:${rKey}`] : null;\n                  // compute top relative to card: prefer rowLayout.y + rowLayout.height so dropdown is flush\n                  let top;\n                  if (rowLayout && typeof rowLayout.y === 'number') {\n                    top = rowLayout.y + rowLayout.height;\n                  } else if (typeof dashboardDropdownTop === 'number' && ov && typeof ov.y === 'number') {\n                    top = Math.max(0, dashboardDropdownTop - ov.y);\n                  } else if (ov && typeof ov.height === 'number') {\n                    top = ov.height;\n                  } else {\n                    top = 46;\n                  }\n\n                  // compute left/width and use bottom to overlap the button (dropdown bottom == row top)\n                  if (rowLayout && typeof rowLayout.x === 'number' && typeof rowLayout.width === 'number' && ov && typeof ov.height === 'number' && typeof rowLayout.y === 'number') {\n                    // Align dropdown top to the row's bottom so it falls downwards\n                    const NUDGE_DOWN = 28; // small downward nudge so header/title remains visible\n                    const topPos = Math.max(0, rowLayout.y + rowLayout.height + NUDGE_DOWN);\n                    console.log && console.log('dashboard overlay positioning (exact, top)', { ovHeight: ov.height, rowY: rowLayout.y, rowHeight: rowLayout.height, topPos, nudge: NUDGE_DOWN });\n                    return { position: 'absolute', left: rowLayout.x, width: rowLayout.width, top: topPos, zIndex: 20 };\n                  }\n\n                  // fallback: full card width (use top so overlay appears under the card)\n                  if (ov && typeof ov.width === 'number' && typeof ov.height === 'number') {\n                    return { position: 'absolute', left: 0, width: ov.width, top: ov.height, zIndex: 20 };\n                  }\n                } catch (e) {}\n                return { position: 'absolute', left: 0, right: 0, top: 54, zIndex: 20 };\n              })()}\n            >\n              <View style={[dashboardCardStyle, { paddingTop: 0, borderTopLeftRadius: 0, borderTopRightRadius: 0 }]}> \n                <ScrollView style={{ maxHeight: Math.max(180, (webPaneHeight || 640) - 220 - 24), paddingTop: 0 }}>\n                  {dashboardLoading ? <Text style={dashboardEmptyTextStyle}>Laddar…</Text> : (\n                    (() => {\n                      const focus = dashboardFocus;\n                      if (focus === 'activeProjects') {\n                        const items = Array.isArray(dashboardActiveProjectsList) ? dashboardActiveProjectsList : [];\n                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga pågående projekt.</Text>;\n                        return items.map((p, idx) => (\n                          <TouchableOpacity key={`${p.id}-${idx}`} activeOpacity={0.85} onPress={() => { requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }} style={dashboardListItemStyle(idx)}>\n                            <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\n                          </TouchableOpacity>\n                        ));\n                      }\n                      if (focus === 'completedProjects') {\n                        try {\n                          const tree = hierarchyRef.current || [];\n                          const items = [];\n                          for (const main of tree) {\n                            for (const sub of (main.children || [])) {\n                              for (const child of (sub.children || [])) {\n                                if (child && child.type === 'project' && (child.status === 'completed' || String(child.status || '').toLowerCase() === 'completed')) {\n                                  items.push(child);\n                                }\n                              }\n                            }\n                          }\n                          if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga avslutade projekt.</Text>;\n                          return items.map((p, idx) => (\n                            <TouchableOpacity key={`${p.id}-${idx}`} activeOpacity={0.85} onPress={() => { requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }} style={dashboardListItemStyle(idx)}>\n                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\n                            </TouchableOpacity>\n                          ));\n                        } catch (_e) {\n                          return <Text style={dashboardEmptyTextStyle}>Inga avslutade projekt.</Text>;\n                        }\n                      }\n                      if (focus === 'drafts' || focus === 'controlsToSign') {\n                        const items = focus === 'controlsToSign' ? (Array.isArray(dashboardControlsToSignItems) ? dashboardControlsToSignItems : []) : (Array.isArray(dashboardDraftItems) ? dashboardDraftItems : []);\n                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga utkast.</Text>;\n                        return items.map((d, idx) => {\n                          const pid = d?.project?.id || d?.projectId || d?.project || null;\n                          const projectId = pid ? String(pid) : '';\n                          const projObj = projectId ? findProjectById(projectId) : null;\n                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                          const ts = d?.savedAt || d?.updatedAt || d?.createdAt || d?.date || null;\n                          const type = String(d?.type || 'Utkast');\n                          return (\n                            <TouchableOpacity key={`${projectId}-${type}-${idx}`} activeOpacity={0.85} onPress={() => {\n                              if (!projObj) return;\n                              requestProjectSwitch(projObj, { selectedAction: { id: `openDraft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`, kind: 'openDraft', type, initialValues: d }, clearActionAfter: true });\n                              setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null);\n                            }} style={dashboardListItemStyle(idx)}>\n                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                              <Text style={dashboardMetaTextStyle}>{type}{ts ? ` • Sparat: ${formatRelativeTime(ts)}` : ''}</Text>\n                            </TouchableOpacity>\n                          );\n                        });\n                      }\n                      if (focus === 'openDeviations') {\n                        const items = Array.isArray(dashboardOpenDeviationItems) ? dashboardOpenDeviationItems : [];\n                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga öppna avvikelser.</Text>;\n                        return items.map((entry, idx) => {\n                          const c = entry?.control;\n                          const pid = c?.project?.id || c?.projectId || c?.project || null;\n                          const projectId = pid ? String(pid) : '';\n                          const projObj = projectId ? findProjectById(projectId) : null;\n                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                          const openCount = entry?.openCount || 0;\n                          return (\n                            <TouchableOpacity key={`${projectId}-${c?.id || idx}`} activeOpacity={0.85} onPress={() => {\n                              if (!projObj || !c) return;\n                              requestProjectSwitch(projObj, { selectedAction: { id: `openControl-${c?.id || Date.now()}`, kind: 'openControlDetails', control: c }, clearActionAfter: true });\n                              setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null);\n                            }} style={dashboardListItemStyle(idx)}>\n                              <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\n                                <View style={[dashboardStatDotStyle('#FFD600'), { marginTop: 4 }]} />\n                                <View style={{ flex: 1, minWidth: 0 }}>\n                                  <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                                  <Text style={dashboardMetaTextStyle}>Skyddsrond • Öppna avvikelser: {String(openCount)}</Text>\n                                </View>\n                              </View>\n                            </TouchableOpacity>\n                          );\n                        });\n                      }\n                      if (focus === 'upcomingSkyddsrond') {\n                        const items = Array.isArray(dashboardUpcomingSkyddsrondItems) ? dashboardUpcomingSkyddsrondItems : [];\n                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga kommande skyddsronder.</Text>;\n                        return items.map((entry, idx) => {\n                          const p = entry?.project;\n                          const dueMs = Number(entry?.nextDueMs || 0);\n                          const dueLabel = dueMs ? new Date(dueMs).toLocaleDateString('sv-SE') : '';\n                          const state = entry?.state === 'overdue' ? 'Försenad' : 'Snart';\n                          return (\n                            <TouchableOpacity key={`${p?.id || 'proj'}-${idx}`} activeOpacity={0.85} onPress={() => { if (p) requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }} style={dashboardListItemStyle(idx)}>\n                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p?.id} — {p?.name}</Text>\n                              <Text style={dashboardMetaTextStyle}>{state}{dueLabel ? ` • Nästa: ${dueLabel}` : ''}</Text>\n                            </TouchableOpacity>\n                          );\n                        });\n                      }\n                      return <Text style={dashboardEmptyTextStyle}>Inget att visa.</Text>;\n                    })()\n                  )}\n                </ScrollView>\n              </View>\n            </View>\n          ) : null}\n\n          <Text style={dashboardSectionTitleStyle}>Senaste aktivitet</Text>\n          <View style={dashboardCardDenseStyle}>\n            {dashboardLoading ? (\n              <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\n            ) : (dashboardRecent || []).length === 0 ? (\n              <Text style={dashboardEmptyTextStyle}>Ingen aktivitet ännu.</Text>\n            ) : (\n              (dashboardRecent || []).map((a, idx) => {\n                const isLogin = String(a.type || '').toLowerCase() === 'login';\n                const hasOpenDeviations = !isLogin && a.kind !== 'draft' && a.type === 'Skyddsrond' && (a.openDeviationsCount || 0) > 0;\n                const iconName = isLogin ? 'log-in-outline' : (a.kind === 'draft' ? 'document-text-outline' : (hasOpenDeviations ? 'alert-circle' : 'checkmark-circle'));\n                const iconColor = isLogin ? '#1976D2' : (a.kind === 'draft' ? '#FFD600' : (hasOpenDeviations ? '#D32F2F' : '#43A047'));\n                const subtitle = !isLogin ? (a.projectName ? `i ${a.projectName}` : (a.projectId ? `i ${a.projectId}` : '')) : '';\n                const who = formatPersonName(a.actorName || a.actorEmail || a.actor || a.email || a.uid || '');\n                const title = isLogin\n                  ? (who ? `Loggade in: ${who}` : 'Loggade in')\n                  : (a.kind === 'draft'\n                    ? `Utkast sparat: ${a.type}${who ? ` — av ${who}` : ''}`\n                    : `Slutförd: ${a.type}${who ? ` — av ${who}` : ''}`);\n\n                return (\n                  <TouchableOpacity\n                    key={`${a.kind}-${a.ts || 'no-ts'}-${idx}`}\n                    activeOpacity={0.85}\n                    onPress={() => {\n                      if (isLogin) return;\n                      if (a.projectId) {\n                        const p = findProjectById(a.projectId);\n                        if (p) {\n                          if (a.kind === 'draft') {\n                            const raw = a.raw || null;\n                            const stableId = raw?.id || raw?.draftId || raw?.controlId || raw?.localId || raw?.savedAt || a.ts || Date.now();\n                            const selectedAction = {\n                              id: `openDraft:${String(a.projectId)}:${String(stableId)}`,\n                              kind: 'openDraft',\n                              type: a.type,\n                              initialValues: raw || undefined,\n                            };\n                            requestProjectSwitch(p, { selectedAction, clearActionAfter: true });\n                          } else {\n                            requestProjectSwitch(p, { selectedAction: null });\n                          }\n                        }\n                      }\n                    }}\n                    style={[{ flexDirection: 'row', alignItems: 'flex-start' }, dashboardActivityListItemStyle(idx)]}\n                  >\n                    <Ionicons name={iconName} size={16} color={iconColor} style={{ marginTop: 2, marginRight: 8 }} />\n                    <View style={{ flex: 1, minWidth: 0 }}>\n                      <Text style={dashboardActivityTitleCompactStyle} numberOfLines={1}>\n                        {title}\n                      </Text>\n                      { (a.projectId || a.projectName) ? (\n                        <Text style={{ fontSize: 13, color: '#1976D2', marginTop: 2 }} numberOfLines={1}>\n                          {a.projectId ? String(a.projectId) : ''}{(a.projectId && a.projectName) ? ' - ' : ''}{a.projectName ? String(a.projectName) : ''}\n                        </Text>\n                      ) : null}\n                      {a.desc && (!isLogin || a.desc !== title) ? (\n                        <Text style={{ fontSize: 12, color: '#666', marginTop: 2 }} numberOfLines={1}>\n                          {a.desc}\n                        </Text>\n                      ) : null}\n                      {\n                        // Show actor + relative time for non-login activities when available\n                        (!isLogin && who) ? (\n                          <Text style={dashboardActivityMetaCompactStyle} numberOfLines={1}>\n                            {`Av: ${who} ${formatRelativeTime(a.ts)}`}\n                          </Text>\n                        ) : (\n                          <Text style={dashboardActivityMetaCompactStyle}>\n                            {formatRelativeTime(a.ts)}\n                          </Text>\n                        )\n                      }\n                    </View>\n\n                    {Platform.OS === 'web' && hasOpenDeviations && (\n                      <TouchableOpacity\n                        onPress={(e) => {\n                          try { e && e.stopPropagation && e.stopPropagation(); } catch(_e) {}\n                          if (!a.projectId) return;\n                          const p = findProjectById(a.projectId);\n                          if (!p) return;\n                          const raw = a.raw || null;\n                          const stableId = raw?.id || raw?.controlId || raw?.localId || raw?.savedAt || a.ts || Date.now();\n                          const selectedAction = {\n                            id: `openControlDetails:${String(a.projectId)}:${String(stableId)}`,\n                            kind: 'openControlDetails',\n                            control: raw || undefined,\n                          };\n                          requestProjectSwitch(p, { selectedAction, clearActionAfter: true });\n                        }}\n                        style={{ marginLeft: 12, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600', alignSelf: 'center' }}\n                        activeOpacity={0.85}\n                        accessibilityLabel=\"Åtgärda avvikelse\"\n                      >\n                        <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\n                      </TouchableOpacity>\n                    )}\n                  </TouchableOpacity>\n                );\n              })\n            )}\n          </View>\n        </View>\n      );\n    }, [\n      dashboardRecent,\n      dashboardLoading,\n      dashboardSectionTitleStyle,\n      dashboardCardDenseStyle,\n      dashboardEmptyTextStyle,\n      dashboardListItemStyle,\n      dashboardActivityTitleStyle,\n      dashboardMetaTextStyle,\n      findProjectById,\n      formatRelativeTime,\n      requestProjectSwitch,\n      // Ensure overview/hover/focus state cause re-creation so chevrons and overlays update\n      dashboardFocus,\n      dashboardHoveredStatKey,\n      dashboardDropdownAnchor,\n      dashboardDropdownTop,\n      dashboardOverview,\n      dashboardActiveProjectsList,\n      dashboardDraftItems,\n      dashboardControlsToSignItems,\n      dashboardOpenDeviationItems,\n      dashboardUpcomingSkyddsrondItems,\n      webPaneHeight,\n      hierarchy,\n    ]);\n\n    function SelectProjectModal() {\n      const [expandedMain, setExpandedMain] = useState([]);\n      const [expandedSub, setExpandedSub] = useState([]);\n      // Quick-add project state (currently unused)\n      const isMainExpanded = id => expandedMain[0] === id;\n      const isSubExpanded = id => expandedSub.includes(id);\n      const toggleMain = id => setExpandedMain(exp => exp[0] === id ? [] : [id]);\n      const toggleSub = id => setExpandedSub(exp => exp.includes(id) ? exp.filter(e => e !== id) : [...exp, id]);\n\n      // Reset expanded state when project selector modal opens\n      const modalVisible = !!selectProjectModal?.visible;\n      React.useEffect(() => {\n        if (modalVisible) setExpandedMain([]);\n      }, [modalVisible]);\n\n      return (\n        <Modal\n          visible={selectProjectModal.visible}\n          transparent\n          animationType=\"fade\"\n          onRequestClose={() => setSelectProjectModal({ visible: false, type: null })}\n        >\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n            <Pressable\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n              onPress={() => setSelectProjectModal({ visible: false, type: null })}\n            />\n            <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 360, maxHeight: 540 }}>\n              {selectProjectModal.type && (\n                <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 6, color: '#222', textAlign: 'center' }}>\n                  {selectProjectModal.type}\n                </Text>\n              )}\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222', textAlign: 'center' }}>Välj projekt</Text>\n              <View style={{ position: 'relative', marginBottom: 14 }}>\n                <TextInput\n                  value={searchText}\n                  onChangeText={setSearchText}\n                  placeholder=\"Sök projektnamn eller nummer...\"\n                  style={{\n                    borderWidth: 1,\n                    borderColor: '#222',\n                    borderRadius: 16,\n                    padding: 10,\n                    fontSize: 16,\n                    backgroundColor: '#fff',\n                    color: '#222',\n                    paddingRight: 38\n                  }}\n                  autoCorrect={false}\n                  autoCapitalize=\"none\"\n                />\n                {searchText.trim().length > 0 && (\n                  <View style={{ position: 'absolute', top: 44, left: 0, right: 0, backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#e0e0e0', zIndex: 10, maxHeight: 180 }}>\n                    <ScrollView keyboardShouldPersistTaps=\"handled\">\n                      {hierarchy.flatMap(main =>\n                        main.children.flatMap(sub =>\n                          (sub.children || [])\n                            .filter(child => child.type === 'project' && (\n                              child.id.toLowerCase().includes(searchText.toLowerCase()) ||\n                              child.name.toLowerCase().includes(searchText.toLowerCase())\n                            ))\n                            .map(proj => (\n                              <TouchableOpacity\n                                key={proj.id}\n                                style={{ padding: 10, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\n                                onPress={() => {\n                                  const selType = selectProjectModal.type;\n                                  setSelectProjectModal({ visible: false, type: null });\n                                  if (selType) {\n                                    openInlineControlEditor(proj, selType);\n                                  }\n                                }}\n                              >\n                                <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\n                                <Text style={{ fontSize: 14, color: '#1976D2', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\n                              </TouchableOpacity>\n                            ))\n                        )\n                      )}\n                    </ScrollView>\n                  </View>\n                )}\n              </View>\n              <ScrollView style={{ maxHeight: 370 }}>\n                {[...hierarchy]\n                  .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                  .filter(main =>\n                    main.name.toLowerCase().includes(searchText.toLowerCase()) ||\n                    main.children.some(sub =>\n                      sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\n                      (sub.children || []).some(child =>\n                        child.type === 'project' && (\n                          child.name.toLowerCase().includes(searchText.toLowerCase()) ||\n                          child.id.toLowerCase().includes(searchText.toLowerCase())\n                        )\n                      )\n                    )\n                  )\n                  .map(main => (\n                    <View key={main.id} style={{ backgroundColor: '#fff', borderRadius: 16, marginBottom: 3, padding: 6, shadowColor: '#1976D2', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2 }}>\n                      <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }} onPress={() => toggleMain(main.id)} activeOpacity={0.7}>\n                        <Ionicons name={isMainExpanded(main.id) ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\n                        <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginLeft: 8 }}>{main.name}</Text>\n                      </TouchableOpacity>\n                      {isMainExpanded(main.id) && (\n                        !main.children || main.children.length === 0 ? (\n                          <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>Inga undermappar skapade</Text>\n                        ) : (\n                          [...main.children]\n                            .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                            .filter(sub =>\n                              sub.name.toLowerCase().includes(searchText.toLowerCase()) ||\n                              (sub.children || []).some(child =>\n                                child.type === 'project' && (\n                                  child.name.toLowerCase().includes(searchText.toLowerCase()) ||\n                                  child.id.toLowerCase().includes(searchText.toLowerCase())\n                                )\n                              )\n                            )\n                            .map(sub => (\n                              <View key={sub.id} style={{ marginLeft: 20, marginBottom: 0, padding: 0 }}>\n                                <View style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 0', userSelect: 'none' }}>\n                                  <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }} onPress={() => toggleSub(sub.id)} activeOpacity={0.7}>\n                                    <Ionicons name={isSubExpanded(sub.id) ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 4 }} />\n                                    <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', marginLeft: 2 }}>{sub.name}</Text>\n                                  </TouchableOpacity>\n                                </View>\n                                {isSubExpanded(sub.id) && (\n                                  (sub.children || []).filter(child => child.type === 'project').map(proj => (\n                                    <View key={proj.id} style={{ marginLeft: 32 }}>\n                                      <TouchableOpacity style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: 'transparent', borderRadius: 4, padding: '2px 4px', marginBottom: 0 }}\n                                        onPress={() => {\n                                          const selType = selectProjectModal.type;\n                                          setSelectProjectModal({ visible: false, type: null });\n                                          if (selType) {\n                                            openInlineControlEditor(proj, selType);\n                                          }\n                                        }}\n                                      >\n                                        <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 6, borderWidth: 1, borderColor: '#bbb' }} />\n                                        <Text style={{ fontSize: 13, color: '#1976D2', fontWeight: '400', marginLeft: 2, marginRight: 6, flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} — {proj.name}</Text>\n                                      </TouchableOpacity>\n                                    </View>\n                                  ))\n                                )}\n                              </View>\n                            ))\n                        )\n                      )}\n                    </View>\n                  ))}\n              </ScrollView>\n            </View>\n          </View>\n        </Modal>\n      );\n    }\n\n  return (\n    <View style={{ flex: 1 }}>\n      {/* App-only: filter modal */}\n      <Modal\n        visible={filterModalVisible}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={() => setFilterModalVisible(false)}\n      >\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <Pressable\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n            onPress={() => setFilterModalVisible(false)}\n          />\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 20, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6, position: 'relative' }}>\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center' }}>\n              Filtrera projekt\n            </Text>\n\n            {[{ key: 'all', label: 'Alla' }, { key: 'ongoing', label: 'Pågående' }, { key: 'completed', label: 'Avslutade' }].map(opt => {\n              const selected = projectStatusFilter === opt.key;\n              return (\n                <TouchableOpacity\n                  key={opt.key}\n                  style={{\n                    flexDirection: 'row',\n                    alignItems: 'center',\n                    paddingVertical: 10,\n                    paddingHorizontal: 12,\n                    borderRadius: 12,\n                    borderWidth: 1,\n                    borderColor: selected ? '#1976D2' : '#e0e0e0',\n                    backgroundColor: selected ? '#e3f2fd' : '#fff',\n                    marginBottom: 10,\n                  }}\n                  onPress={() => {\n                    setProjectStatusFilter(opt.key);\n                    setFilterModalVisible(false);\n                  }}\n                  activeOpacity={0.8}\n                >\n                  {opt.key === 'ongoing' && (\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#43A047', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\n                  )}\n                  {opt.key === 'completed' && (\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#222', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\n                  )}\n                  {opt.key === 'all' && (\n                    <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: '#fff', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\n                  )}\n                  <Text style={{ fontSize: 16, fontWeight: selected ? '700' : '600', color: '#222' }}>{opt.label}</Text>\n                </TouchableOpacity>\n              );\n            })}\n\n            <TouchableOpacity\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 12, paddingVertical: 10, alignItems: 'center' }}\n              onPress={() => setFilterModalVisible(false)}\n            >\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n\n      {/* Sök-popup/modal */}\n      <Modal\n        visible={searchModalVisible}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={closeSearchModal}\n      >\n        {Platform.OS === 'web' ? (\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>\n            <Pressable\n              style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n              onPress={closeSearchModal}\n            />\n            <View\n              style={{\n                backgroundColor: '#fff',\n                borderRadius: 18,\n                padding: 24,\n                width: 340,\n                maxHeight: 700,\n                shadowColor: '#000',\n                shadowOffset: { width: 0, height: 4 },\n                shadowOpacity: 0.18,\n                shadowRadius: 8,\n                elevation: 6,\n                position: 'relative',\n              }}\n            >\n              <TouchableOpacity\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n                onPress={closeSearchModal}\n                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n              >\n                <Ionicons name=\"close\" size={26} color=\"#222\" />\n              </TouchableOpacity>\n              <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center', marginTop: 6 }}>\n                Sök projekt\n              </Text>\n              <TextInput\n                value={searchText}\n                onChangeText={setSearchText}\n                placeholder=\"Skriv projektnummer...\"\n                style={{\n                  borderWidth: 1,\n                  borderColor: '#222',\n                  borderRadius: 16,\n                  padding: 10,\n                  fontSize: 16,\n                  backgroundColor: '#fff',\n                  color: '#222',\n                  marginBottom: 12\n                }}\n                autoFocus\n                keyboardType=\"default\"\n                autoCorrect={false}\n                autoCapitalize=\"none\"\n              />\n              <ScrollView style={{ maxHeight: 520 }} keyboardShouldPersistTaps=\"handled\">\n                {hierarchy.flatMap(main =>\n                  main.children.flatMap(sub =>\n                    (sub.children || [])\n                      .filter(child => child.type === 'project' &&\n                        searchText.trim() !== '' &&\n                        (\n                          child.id.toLowerCase().includes(searchText.toLowerCase()) ||\n                          child.name.toLowerCase().includes(searchText.toLowerCase())\n                        )\n                      )\n                      .map(proj => (\n                        <TouchableOpacity\n                          key={proj.id}\n                          style={{ paddingVertical: 8, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\n                          onPress={() => {\n                            closeSearchModal();\n                            requestProjectSwitch(proj, { selectedAction: null });\n                          }}\n                        >\n                          <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\n                        </TouchableOpacity>\n                      ))\n                  )\n                )}\n                {searchText.trim() !== '' && hierarchy.flatMap(main => main.children.flatMap(sub => (sub.children || []).filter(child => child.type === 'project' && (\n                  child.id.toLowerCase().includes(searchText.toLowerCase()) ||\n                  child.name.toLowerCase().includes(searchText.toLowerCase())\n                )))).length === 0 && (\n                  <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 12 }}>Inga projekt hittades.</Text>\n                )}\n              </ScrollView>\n            </View>\n          </View>\n        ) : (\n          <KeyboardAvoidingView\n            style={{ flex: 1 }}\n            behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\n            keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 0}\n          >\n            <View\n              style={{\n                flex: 1,\n                // Center the search dialog vertically on mobile\n                justifyContent: 'center',\n                alignItems: 'center',\n                paddingTop: 20,\n                paddingBottom: 8,\n              }}\n            >\n              <Pressable\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                onPress={closeSearchModal}\n              />\n              <View\n                style={{\n                  backgroundColor: '#fff',\n                  borderRadius: 18,\n                  padding: 24,\n                  width: 340,\n                  maxHeight: Math.max(320, Math.min(600, (windowHeight || 700) - (keyboardHeight || 0) - 80)),\n                  shadowColor: '#000',\n                  shadowOffset: { width: 0, height: 4 },\n                  shadowOpacity: 0.18,\n                  shadowRadius: 8,\n                  elevation: 6,\n                  position: 'relative',\n                }}\n              >\n                <TouchableOpacity\n                  style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n                  onPress={closeSearchModal}\n                  hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n                >\n                  <Ionicons name=\"close\" size={26} color=\"#222\" />\n                </TouchableOpacity>\n                <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 14, color: '#222', textAlign: 'center', marginTop: 6 }}>\n                  Sök projekt\n                </Text>\n                <TextInput\n                  value={searchText}\n                  onChangeText={setSearchText}\n                  placeholder=\"Skriv projektnummer...\"\n                  style={{\n                    borderWidth: 1,\n                    borderColor: '#222',\n                    borderRadius: 16,\n                    padding: 10,\n                    fontSize: 16,\n                    backgroundColor: '#fff',\n                    color: '#222',\n                    marginBottom: 12\n                  }}\n                  autoFocus\n                  keyboardType=\"default\"\n                  autoCorrect={false}\n                  autoCapitalize=\"none\"\n                />\n                <ScrollView\n                  style={{\n                    maxHeight: Math.max(180, (windowHeight || 700) - (keyboardHeight || 0) - 260),\n                  }}\n                  keyboardShouldPersistTaps=\"handled\"\n                >\n                  {hierarchy.flatMap(main =>\n                    main.children.flatMap(sub =>\n                      (sub.children || [])\n                        .filter(child => child.type === 'project' &&\n                          searchText.trim() !== '' &&\n                          (\n                            child.id.toLowerCase().includes(searchText.toLowerCase()) ||\n                            child.name.toLowerCase().includes(searchText.toLowerCase())\n                          )\n                        )\n                        .map(proj => (\n                          <TouchableOpacity\n                            key={proj.id}\n                            style={{ paddingVertical: 8, borderBottomWidth: 1, borderColor: '#eee', flexDirection: 'row', alignItems: 'center' }}\n                            onPress={() => {\n                              closeSearchModal();\n                              navigation.navigate('ProjectDetails', {\n                                project: {\n                                  id: proj.id,\n                                  name: proj.name,\n                                  ansvarig: proj.ansvarig || '',\n                                  adress: proj.adress || '',\n                                  fastighetsbeteckning: proj.fastighetsbeteckning || '',\n                                  client: proj.client || '',\n                                  status: proj.status || 'ongoing',\n                                  createdAt: proj.createdAt || '',\n                                  createdBy: proj.createdBy || ''\n                                },\n                                companyId\n                              });\n                            }}\n                          >\n                            <View style={{ width: 14, height: 14, borderRadius: 7, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\n                            <Text style={{ fontSize: 16, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} - {proj.name}</Text>\n                          </TouchableOpacity>\n                        ))\n                    )\n                  )}\n                  {searchText.trim() !== '' && hierarchy.flatMap(main => main.children.flatMap(sub => (sub.children || []).filter(child => child.type === 'project' && (\n                    child.id.toLowerCase().includes(searchText.toLowerCase()) ||\n                    child.name.toLowerCase().includes(searchText.toLowerCase())\n                  )))).length === 0 && (\n                    <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 12 }}>Inga projekt hittades.</Text>\n                  )}\n                </ScrollView>\n              </View>\n            </View>\n          </KeyboardAvoidingView>\n        )}\n      </Modal>\n      {newProjectModalComponent}\n      {(() => {\n        const RootContainer = ImageBackground;\n        const rootContainerProps = {\n          source: require('../assets/images/inlogg.webb.png'),\n          resizeMode: 'cover',\n          imageStyle: { width: '100%', height: '100%' },\n        };\n\n        return (\n          <RootContainer\n            {...rootContainerProps}\n            style={{ flex: 1, width: '100%', minHeight: Platform.OS === 'web' ? '100vh' : undefined, height: Platform.OS === 'web' ? windowHeight || undefined : undefined }}\n          >\n              <View\n                style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.12)', zIndex: 0 }}\n              />\n\n            {headerProjectQuery && headerSearchOpen ? (\n              (() => {\n                const innerDropdown = (\n                  <View\n                    style={{\n                      pointerEvents: 'auto',\n                      position: Platform.OS === 'web' ? 'fixed' : 'absolute',\n                      top: Platform.OS === 'web' ? headerSearchBottom : 8,\n                      left: Platform.OS === 'web' && headerSearchLeft !== null ? headerSearchLeft : 0,\n                      zIndex: 99999,\n                      alignItems: 'flex-start',\n                      marginTop: 0,\n                      paddingTop: 0,\n                    }}\n                  >\n                    <Animated.View\n                      style={{\n                          width: headerSearchWidth || 560,\n                          backgroundColor: '#fff',\n                          borderRadius: 16,\n                          borderTopLeftRadius: 0,\n                          borderTopRightRadius: 0,\n                          overflow: 'hidden',\n                          borderLeftWidth: 1,\n                          borderRightWidth: 1,\n                          borderBottomWidth: 1,\n                          borderTopWidth: 0,\n                          borderColor: '#666',\n                          shadowColor: '#000',\n                          shadowOffset: { width: 0, height: 6 },\n                          shadowOpacity: 0.18,\n                          shadowRadius: 14,\n                          elevation: 10,\n                          marginTop: 0,\n                          paddingTop: 0,\n                          opacity: Platform.OS === 'web' ? dropdownAnim : 1,\n                          transform: Platform.OS === 'web' ? [{ scale: dropdownAnim.interpolate({ inputRange: [0, 1], outputRange: [0.995, 1] }) }] : undefined,\n                        }}\n                    >\n                      <ScrollView style={{ maxHeight: 320 }} contentContainerStyle={{ paddingTop: 0 }} keyboardShouldPersistTaps=\"handled\">\n                        {headerProjectMatches.map((proj) => (\n                          <TouchableOpacity\n                            key={proj.id}\n                            onMouseEnter={Platform.OS === 'web' ? () => setHoveredProjectId(proj.id) : undefined}\n                            onMouseLeave={Platform.OS === 'web' ? () => setHoveredProjectId(null) : undefined}\n                            style={{ paddingVertical: 10, paddingHorizontal: 14, borderBottomWidth: 1, borderColor: '#f0f0f0', flexDirection: 'row', alignItems: 'center', backgroundColor: Platform.OS === 'web' && hoveredProjectId === proj.id ? '#F7FBFF' : '#fff' }}\n                            activeOpacity={0.8}\n                            onPress={() => {\n                                // Switch project inline and close the header dropdown (keep the query text).\n                                if (Platform.OS === 'web') {\n                                  try { navigation?.setParams?.({ headerSearchOpen: false, headerSearchKeepConnected: false }); } catch(_e) {}\n                                }\n                                requestProjectSwitch(proj, { selectedAction: null });\n                              }}\n                          >\n                            <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: (proj.status || 'ongoing') === 'completed' ? '#222' : '#43A047', marginRight: 10, borderWidth: 1, borderColor: '#bbb' }} />\n                            <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">\n                              {proj.id} - {proj.name}\n                            </Text>\n                          </TouchableOpacity>\n                        ))}\n\n                        {headerProjectMatches.length === 0 ? (\n                          <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', paddingVertical: 14 }}>\n                            Inga projekt hittades.\n                          </Text>\n                        ) : null}\n                      </ScrollView>\n                    </Animated.View>\n                  </View>\n                );\n\n                const PortalContent = (\n                  <>\n                    <View\n                      // backdrop to capture outside clicks and close the dropdown\n                      onStartShouldSetResponder={() => true}\n                      onResponderRelease={() => {\n                        if (Platform.OS === 'web') {\n                          try { navigation?.setParams?.({ headerSearchOpen: false, headerSearchKeepConnected: false }); } catch(_e) {}\n                        }\n                      }}\n                      style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 99998, backgroundColor: 'rgba(0,0,0,0)' }}\n                    />\n                    {innerDropdown}\n                  </>\n                );\n\n                if (Platform.OS === 'web' && createPortal && typeof document !== 'undefined') {\n                  try {\n                    let portalRoot = document.getElementById(portalRootId);\n                    if (!portalRoot) {\n                      portalRoot = document.createElement('div');\n                      portalRoot.id = portalRootId;\n                      portalRoot.style.position = 'relative';\n                      document.body.appendChild(portalRoot);\n                    }\n                    return createPortal(PortalContent, portalRoot);\n                  } catch(_e) {\n                    return PortalContent;\n                  }\n                }\n                return innerDropdown;\n              })()\n            ) : null}\n\n            <ScrollView style={{ flex: 1, backgroundColor: 'transparent' }} scrollEnabled={Platform.OS !== 'web'} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\n        {/* Header */}\n        <View\n          onLayout={(e) => {\n            const h = e?.nativeEvent?.layout?.height;\n            if (Platform.OS === 'web' && typeof h === 'number' && h > 0 && Math.abs(h - headerHeight) > 1) {\n              setHeaderHeight(h);\n            }\n          }}\n          style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', padding: 16, backgroundColor: '#F7FAFC', borderBottomWidth: 1, borderColor: '#e6e6e6' }}\n        >\n          <View>\n              {/* User button: icon + full name, opens dropdown */}\n            {/* User button: icon + full name, opens dropdown */}\n            {Platform.OS !== 'web' ? (() => {\n              let displayName = '';\n              if (route?.params?.displayName) displayName = route.params.displayName;\n              else if (auth?.currentUser) {\n                const user = auth.currentUser;\n                if (user.displayName && String(user.displayName).trim().includes(' ')) {\n                  displayName = String(user.displayName).trim();\n                } else {\n                  displayName = formatPersonName(user) || (user.displayName ? String(user.displayName).trim() : '');\n                }\n              }\n              displayName = displayName || firstName || 'Användare';\n              const _nameSeed = String(displayName || '').trim();\n              const initials = (_nameSeed.split(/\\s+/).filter(Boolean).slice(0,2).map(n => (n[0] || '').toUpperCase()).join('')) || (auth?.currentUser?.email ? String(auth.currentUser.email || '')[0].toUpperCase() : 'A');\n              const _hash = Array.from(_nameSeed).reduce((s, c) => (s * 31 + c.charCodeAt(0)) | 0, 0);\n              const _colors = ['#F44336','#E91E63','#9C27B0','#3F51B5','#2196F3','#03A9F4','#009688','#4CAF50','#FF9800','#FFC107'];\n              const avatarBg = _colors[Math.abs(_hash) % _colors.length];\n\n              const menuItems = [];\n              if (isSuperAdmin) {\n                // Superadmin: behåll alla befintliga adminval\n                menuItems.push({ key: 'manage_company', label: 'Hantera företag', icon: <Ionicons name=\"business\" size={16} color=\"#2E7D32\" /> });\n                menuItems.push({ key: 'manage_users', label: 'Hantera användare', icon: <Ionicons name=\"person-add\" size={16} color=\"#1976D2\" /> });\n                menuItems.push({ key: 'create_templates', label: 'Skapa mallar', icon: <Ionicons name=\"add-circle\" size={16} color=\"#43A047\" /> });\n                menuItems.push({ key: 'edit_templates', label: 'Ändra mallar', icon: <Ionicons name=\"pencil\" size={16} color=\"#FB8C00\" /> });\n                menuItems.push({ key: 'admin_audit', label: 'Adminlogg', icon: <Ionicons name=\"list\" size={16} color=\"#1565C0\" /> });\n              }\n\n              // Alla roller: logga ut längst ned. För admin/användare blir detta enda valet.\n              menuItems.push({ key: 'logout', label: 'Logga ut', icon: <Ionicons name=\"log-out-outline\" size={16} color=\"#D32F2F\" /> });\n\n              return (\n                <>\n                  <TouchableOpacity\n                    ref={userBtnRef}\n                    onPress={() => { try { openUserMenu(); } catch(_e) {} }}\n                    activeOpacity={0.8}\n                    style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}\n                  >\n                    <View style={{ width: 30, height: 30, borderRadius: 15, backgroundColor: avatarBg, alignItems: 'center', justifyContent: 'center' }}>\n                      <Ionicons name=\"person\" size={16} color=\"#fff\" />\n                    </View>\n                    <Text style={{ fontSize: 16, color: '#263238', fontWeight: '600' }}>{displayName}</Text>\n                    <Ionicons\n                      name=\"chevron-down\"\n                      size={14}\n                      color=\"#666\"\n                      style={{ marginLeft: 6, transform: [{ rotate: (userMenuVisible ? '180deg' : '0deg') }] }}\n                    />\n                  </TouchableOpacity>\n                  <ContextMenu\n                    visible={userMenuVisible}\n                    x={menuPos.x}\n                    y={menuPos.y}\n                    items={menuItems}\n                    onClose={() => setUserMenuVisible(false)}\n                    onSelect={async (it) => {\n                      try {\n                        setUserMenuVisible(false);\n                        if (!it) return;\n                        if (it.key === 'manage_company') {\n                          try { navigation.navigate('ManageCompany'); } catch(_e) { Alert.alert('Fel', 'Kunde inte öppna Hantera företag'); }\n                          return;\n                        }\n                        if (it.key === 'admin_audit') {\n                          try { navigation.navigate('AdminAuditLog'); } catch(_e) { Alert.alert('Fel', 'Kunde inte öppna adminlogg'); }\n                          return;\n                        }\n                        if (it.key === 'manage_users') {\n                          try { navigation.navigate('ManageUsers', { companyId: String(companyId || routeCompanyId || '') }); } catch(_e) { Alert.alert('Valt', it.label); }\n                          return;\n                        }\n                        if (it.key === 'create_templates') {\n                          try { navigation.navigate('ManageTemplates', { companyId: String(companyId || routeCompanyId || '') }); } catch(_e) { Alert.alert('Valt', it.label); }\n                          return;\n                        }\n                        if (it.key === 'edit_templates') {\n                          try { navigation.navigate('ManageTemplates', { companyId: String(companyId || routeCompanyId || '') }); } catch(_e) { Alert.alert('Valt', it.label); }\n                          return;\n                        }\n                        if (it.key === 'logout') {\n                          try { setLoggingOut(true); } catch(_e) {}\n                          try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                          try { await auth.signOut(); } catch(_e) {}\n                          try { setLoggingOut(false); } catch(_e) {}\n                          try {\n                            navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                          } catch(_e) {\n                            try { navigation.navigate('Login'); } catch(__e) {}\n                          }\n                          return;\n                        }\n                        // Default: show label as feedback\n                        Alert.alert('Valt', it.label);\n                      } catch(_e) {}\n                    }}\n                  />\n                </>\n              );\n            })() : null}\n            <View style={{ flexDirection: 'row', alignItems: 'center', gap: 12, marginTop: 8, marginLeft: 8 }}>\n              {Platform.OS === 'web' ? (\n                <View style={{ marginRight: 6 }}>\n                  {showHeaderUserMenu ? <HeaderUserMenu /> : <HeaderDisplayName />}\n                </View>\n              ) : null}\n              {allowedTools ? (\n                <TouchableOpacity\n                  style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                  onPress={() => setSupportMenuOpen(s => !s)}\n                >\n                  <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                </TouchableOpacity>\n              ) : null}\n            </View>\n            {canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#1565C0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={() => {\n                  try { navigation.navigate('AdminAuditLog'); } catch(_e) { Alert.alert('Fel', 'Kunde inte öppna adminlogg'); }\n                }}\n              >\n                <Text style={{ color: '#fff', fontWeight: '700' }}>Adminlogg</Text>\n              </TouchableOpacity>\n            )}\n            {__DEV__ && showAdminButton && canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => {\n                  await saveHierarchy('testdemo', testHierarchy);\n                  setShowAdminButton(false);\n                  alert('Testdata har lagts in!');\n                }}\n              >\n                <Text style={{ color: '#fff', fontWeight: 'bold' }}>Fyll på testdata</Text>\n              </TouchableOpacity>\n            )}\n            {__DEV__ && showAdminButton && canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#43A047', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => {\n                  await handleMakeDemoAdmin();\n                  alert('Din användare är nu markerad som demo/admin (client-side).');\n                }}\n              >\n                <Text style={{ color: '#fff', fontWeight: 'bold' }}>{adminActionRunning ? 'Kör...' : 'Gör mig demo-admin'}</Text>\n              </TouchableOpacity>\n            )}\n            {canShowSupportToolsInHeader && supportMenuOpen && localFallbackExists && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#FFB300', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => {\n                  // migrate local fallback (hierarki + controls) to Firestore with confirmation\n                  try {\n                    const rawHierarchy = await AsyncStorage.getItem('hierarchy_local');\n                    const rawCompleted = await AsyncStorage.getItem('completed_controls');\n                    const rawDrafts = await AsyncStorage.getItem('draft_controls');\n\n                    if (!rawHierarchy && !rawCompleted && !rawDrafts) {\n                      Alert.alert('Ingen lokal data', 'Ingen lokalt sparad hierarki eller kontroller hittades.');\n                      await refreshLocalFallbackFlag();\n                      return;\n                    }\n\n                    Alert.alert(\n                      'Migrera lokal data',\n                      'Vill du migrera lokalt sparad hierarki och kontroller till molnet för kontot? Detta kan skriva över befintlig molndata.',\n                      [\n                        { text: 'Avbryt', style: 'cancel' },\n                        { text: 'Migrera', onPress: async () => {\n                          try {\n                            let successMsgs = [];\n\n                            // Hierarki\n                            if (rawHierarchy) {\n                              try {\n                                const parsed = JSON.parse(rawHierarchy);\n                                const res = await saveHierarchy(companyId, parsed);\n                                const ok = res === true || (res && res.ok === true);\n                                if (ok) {\n                                  await AsyncStorage.removeItem('hierarchy_local');\n                                  setHierarchy(parsed);\n                                  successMsgs.push('Hierarki migrerad');\n                                } else {\n                                  successMsgs.push('Hierarki misslyckades');\n                                }\n                              } catch(_e) {\n                                successMsgs.push('Hierarki-fel');\n                              }\n                            }\n\n                            // Controls: backup locally first\n                            if (rawCompleted) {\n                              try {\n                                await AsyncStorage.setItem('completed_controls_backup', rawCompleted);\n                                const parsedCompleted = JSON.parse(rawCompleted);\n                                let okCount = 0;\n                                for (const ctl of parsedCompleted) {\n                                  try {\n                                    const ok = await saveControlToFirestore(ctl);\n                                    if (ok) okCount++;\n                                  } catch(_e) {}\n                                }\n                                if (okCount > 0) {\n                                  await AsyncStorage.removeItem('completed_controls');\n                                  successMsgs.push(`${okCount} utförda kontroller migrerade`);\n                                } else {\n                                  successMsgs.push('Inga utförda kontroller migrerade');\n                                }\n                              } catch(_e) {\n                                successMsgs.push('Backup/migrering av utförda kontroller misslyckades');\n                              }\n                            }\n\n                            if (rawDrafts) {\n                              try {\n                                await AsyncStorage.setItem('draft_controls_backup', rawDrafts);\n                                const parsedDrafts = JSON.parse(rawDrafts);\n                                let okDrafts = 0;\n                                for (const d of parsedDrafts) {\n                                  try {\n                                    const ok = await saveDraftToFirestore(d);\n                                    if (ok) okDrafts++;\n                                  } catch(_e) {}\n                                }\n                                if (okDrafts > 0) {\n                                  await AsyncStorage.removeItem('draft_controls');\n                                  successMsgs.push(`${okDrafts} utkast migrerade`);\n                                } else {\n                                  successMsgs.push('Inga utkast migrerade');\n                                }\n                              } catch(_e) {\n                                successMsgs.push('Backup/migrering av utkast misslyckades');\n                              }\n                            }\n\n                            Alert.alert('Migrering klar', successMsgs.join('\\n'));\n                            await refreshLocalFallbackFlag();\n                          } catch(_e) {\n                            Alert.alert('Fel', 'Kunde inte migrera: ' + (_e?.message || 'okänt fel'));\n                          }\n                        }}\n                      ],\n                    );\n                  } catch(_e) {\n                    Alert.alert('Fel', 'Kunde inte läsa lokal data.');\n                  }\n                }}\n              >\n                <Text style={{ color: '#222', fontWeight: '700' }}>Migrera lokal data</Text>\n              </TouchableOpacity>\n            )}\n            {canShowSupportToolsInHeader && supportMenuOpen && (auth && auth.currentUser) && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => {\n                  try {\n                    // Force refresh token\n                    await auth.currentUser.getIdToken(true);\n                    showAlert('Token uppdaterad', 'ID-token uppdaterad. Försöker migrera lokal data...');\n                    // attempt migration if local data exists\n                    const raw = await AsyncStorage.getItem('hierarchy_local');\n                    if (!raw) {\n                      showAlert('Ingen lokal data', 'Inget att migrera.');\n                      await refreshLocalFallbackFlag();\n                      return;\n                    }\n                    const parsed = JSON.parse(raw);\n                    const res = await saveHierarchy(companyId, parsed);\n                    const ok = res === true || (res && res.ok === true);\n                      if (ok) {\n                      await AsyncStorage.removeItem('hierarchy_local');\n                      await refreshLocalFallbackFlag();\n                      setHierarchy(parsed);\n                      showAlert('Klar', 'Lokal hierarki migrerad till molnet.');\n                    } else {\n                      showAlert('Misslyckades', 'Kunde inte spara till molnet. Fel: ' + (res && res.error ? res.error : 'okänt fel'));\n                    }\n                  } catch(_e) {\n                    showAlert('Fel', 'Kunde inte uppdatera token eller migrera: ' + (_e?.message || _e));\n                  }\n                }}\n              >\n                <Text style={{ color: '#fff', fontWeight: '700' }}>Uppdatera token & synka</Text>\n              </TouchableOpacity>\n            )}\n            {canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#eee', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => {\n                  try {\n                    const user = auth.currentUser;\n                    const tokenRes = user ? await auth.currentUser.getIdTokenResult(true).catch((e) => null) : null;\n                    const claims = tokenRes?.claims || {};\n                    const stored = await AsyncStorage.getItem('dk_companyId');\n                    showAlert('Auth info', `user: ${user ? user.email + ' (' + user.uid + ')' : 'not signed in'}\\nclaims.companyId: ${claims.companyId || '—'}\\ndk_companyId: ${stored || '—'}`);\n                  } catch(_e) {\n                    showAlert('Fel', 'Kunde inte läsa auth info: ' + (_e?.message || _e));\n                  }\n                }}\n              >\n                <Text style={{ color: '#222', fontWeight: '700' }}>Visa auth-info</Text>\n              </TouchableOpacity>\n            )}\n            {canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#ddd', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => { await dumpLocalRemoteControls(); }}\n              >\n                <Text style={{ color: '#222', fontWeight: '700' }}>Debug: visa lokal/moln</Text>\n              </TouchableOpacity>\n            )}\n            {canShowSupportToolsInHeader && supportMenuOpen && (\n              <TouchableOpacity\n                style={{ backgroundColor: '#f5f5f5', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 12, marginTop: 8, alignSelf: 'flex-start' }}\n                onPress={async () => { await showLastFsError(); }}\n              >\n                <Text style={{ color: '#222', fontWeight: '700' }}>Visa senaste FS-fel</Text>\n              </TouchableOpacity>\n            )}\n          </View>\n        </View>\n        {/* Allt under headern är skrollbart */}\n        {Platform.OS === 'web' ? (\n          <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\n                  <View style={{ width: leftWidth, padding: 8, borderRightWidth: 0, borderColor: '#e6e6e6', backgroundColor: '#f5f6f7', height: webPaneHeight, position: 'relative' }}>\n                    {/* Thin right-side divider for visual separation */}\n                    <View style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: 1, backgroundColor: '#e6e6e6' }} />\n                    {/* Draggable handle - sits above the divider */}\n                    <View\n                  {...(panResponder && panResponder.panHandlers)}\n                  style={Platform.OS === 'web' ? { position: 'absolute', right: -8, top: 0, bottom: 0, width: 16, cursor: 'col-resize', zIndex: 9 } : { position: 'absolute', right: -12, top: 0, bottom: 0, width: 24, zIndex: 9 }}\n                    />\n              <View style={{ paddingVertical: 6, paddingHorizontal: 6, borderBottomWidth: 2, borderColor: '#e0e0e0', marginBottom: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <Text style={{ fontSize: 20, fontWeight: '700', color: '#222' }}>Projekt</Text>\n                </View>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <TouchableOpacity\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\n                    onPress={() => {\n                      setSpinSidebarHome((n) => n + 1);\n                      if (selectedProject) closeSelectedProject();\n                    }}\n                    activeOpacity={0.7}\n                    accessibilityLabel=\"Hem\"\n                  >\n                    <Ionicons\n                      name=\"home-outline\"\n                      size={18}\n                      color=\"#1976D2\"\n                      style={{\n                        transform: [{ rotate: `${spinSidebarHome * 360}deg` }],\n                        transitionProperty: 'transform',\n                        transitionDuration: '0.4s',\n                        transitionTimingFunction: 'ease',\n                      }}\n                    />\n                  </TouchableOpacity>\n\n                  <TouchableOpacity\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\n                    onPress={() => {\n                      setSpinSidebarRefresh((n) => n + 1);\n                      if (selectedProject) {\n                        setProjectControlsRefreshNonce((n) => n + 1);\n                      } else {\n                        try { loadDashboard(); } catch(_e) {}\n                      }\n                    }}\n                    activeOpacity={0.7}\n                    accessibilityLabel=\"Uppdatera\"\n                  >\n                    <Ionicons\n                      name=\"refresh\"\n                      size={18}\n                      color=\"#1976D2\"\n                      style={{\n                        transform: [{ rotate: `${spinSidebarRefresh * 360}deg` }],\n                        transitionProperty: 'transform',\n                        transitionDuration: '0.4s',\n                        transitionTimingFunction: 'ease',\n                      }}\n                    />\n                  </TouchableOpacity>\n\n                  <TouchableOpacity\n                    style={{ padding: 6, borderRadius: 8, marginRight: 6 }}\n                    onPress={() => {\n                      setSpinSidebarFilter((n) => n + 1);\n                      setFilterModalVisible(true);\n                    }}\n                    activeOpacity={0.7}\n                  >\n                    <View style={{ position: 'relative' }}>\n                      <Ionicons\n                        name=\"filter\"\n                        size={18}\n                        color=\"#1976D2\"\n                        style={{\n                          transform: [{ rotate: `${spinSidebarFilter * 360}deg` }],\n                          transitionProperty: 'transform',\n                          transitionDuration: '0.4s',\n                          transitionTimingFunction: 'ease',\n                        }}\n                      />\n                      {projectStatusFilter !== 'all' && (\n                        <View\n                          style={{\n                            position: 'absolute',\n                            right: -1,\n                            top: -1,\n                            width: 9,\n                            height: 9,\n                            borderRadius: 5,\n                            backgroundColor: projectStatusFilter === 'completed' ? '#222' : '#43A047',\n                            borderWidth: 1,\n                            borderColor: '#f5f6f7',\n                          }}\n                        />\n                      )}\n                    </View>\n                  </TouchableOpacity>\n\n                  \n                </View>\n              </View>\n              <ScrollView ref={leftTreeScrollRef} style={{ flex: 1 }}>\n                {loadingHierarchy || hierarchy.length === 0 ? (\n                  <Text style={{ color: '#888', fontSize: 16, textAlign: 'center', marginTop: 32 }}>\n                    Inga mappar eller projekt skapade ännu.\n                  </Text>\n                ) : (\n                  <View style={{ paddingHorizontal: 4 }} nativeID={Platform.OS === 'web' ? 'dk-tree-root' : undefined}>\n                    {[...hierarchy]\n                      .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                      .map((main) => (\n                        <View key={main.id} style={{ marginBottom: 0, padding: 0 }}>\n                          <View\n                            style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 4px', userSelect: 'none' }}\n                            dataSet={Platform.OS === 'web' ? { dkType: 'main', dkMainid: String(main.id) } : undefined}\n                          >\n                            {(() => {\n                              const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('main', String(main.id));\n                              return (\n                            <TouchableOpacity\n                              dataSet={Platform.OS === 'web' ? { dkType: 'main', dkMainid: String(main.id) } : undefined}\n                              style={{\n                                flexDirection: 'row',\n                                alignItems: 'center',\n                                flex: 1,\n                                backgroundColor: isHovered ? '#eee' : 'transparent',\n                                borderRadius: 4,\n                                padding: '2px 4px',\n                                borderWidth: 1,\n                                borderColor: isHovered ? '#1976D2' : 'transparent',\n                                transition: 'background 0.15s, border 0.15s',\n                              }}\n                              onPress={() => handleToggleMainFolder(main.id)}\n                              activeOpacity={0.7}\n                              onLongPress={() => setEditModal({ visible: true, type: 'main', id: main.id, name: main.name })}\n                              delayLongPress={2000}\n                              onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('main', String(main.id))) : undefined}\n                              onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\n                              onPressIn={() => {\n                                if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\n                                mainTimersRef.current[main.id] = setTimeout(() => {\n                                  setEditModal({ visible: true, type: 'main', id: main.id, name: main.name });\n                                }, 2000);\n                              }}\n                              onPressOut={() => {\n                                if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\n                              }}\n                            >\n                              <Ionicons\n                                name={main.expanded ? 'chevron-down' : 'chevron-forward'}\n                                size={18}\n                                color=\"#222\"\n                                style={{\n                                  marginRight: 4,\n                                  transform: Platform.OS === 'web' ? [{ rotate: `${(spinMain[main.id] || 0) * 360}deg` }] : undefined,\n                                  transitionProperty: Platform.OS === 'web' ? 'transform' : undefined,\n                                  transitionDuration: Platform.OS === 'web' ? '0.35s' : undefined,\n                                  transitionTimingFunction: Platform.OS === 'web' ? 'ease' : undefined,\n                                }}\n                              />\n                              <Text style={{ fontSize: 15, fontWeight: isHovered ? '700' : '600', color: '#222', marginLeft: 2 }}>{main.name}</Text>\n                            </TouchableOpacity>\n                              );\n                            })()}\n                          </View>\n                          {main.expanded && (\n                            !main.children || main.children.length === 0 ? (\n                              <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 22, marginTop: 6 }}>\n                                Inga undermappar skapade\n                              </Text>\n                            ) : (\n                              [...main.children]\n                                .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                                .map((sub) => {\n                                  const allProjects = sub.children ? sub.children.filter(child => child.type === 'project') : [];\n                                  const projects = projectStatusFilter === 'all'\n                                    ? allProjects\n                                    : allProjects.filter((p) => {\n                                        const status = p?.status || 'ongoing';\n                                        return projectStatusFilter === 'completed'\n                                          ? status === 'completed'\n                                          : status !== 'completed';\n                                      });\n                                  return (\n                                    <View key={sub.id} style={{ marginLeft: 20, marginBottom: 0, padding: 0 }}>\n                                  <View\n                                    style={{ flexDirection: 'row', alignItems: 'center', padding: '2px 0 2px 0', userSelect: 'none' }}\n                                    dataSet={Platform.OS === 'web' ? { dkType: 'sub', dkMainid: String(main.id), dkSubid: String(sub.id) } : undefined}\n                                  >\n                                    {(() => {\n                                      const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('sub', String(main.id), String(sub.id));\n                                      return (\n                                    <TouchableOpacity\n                                      dataSet={Platform.OS === 'web' ? { dkType: 'sub', dkMainid: String(main.id), dkSubid: String(sub.id) } : undefined}\n                                      style={{\n                                        flexDirection: 'row',\n                                        alignItems: 'center',\n                                        flex: 1,\n                                        backgroundColor: isHovered ? '#eee' : 'transparent',\n                                        borderRadius: 4,\n                                        padding: '2px 4px',\n                                        borderWidth: 1,\n                                        borderColor: isHovered ? '#1976D2' : 'transparent',\n                                        transition: 'background 0.15s, border 0.15s',\n                                      }}\n                                      onPress={() => handleToggleSubFolder(sub.id)}\n                                      onLongPress={() => setEditModal({ visible: true, type: 'sub', id: sub.id, name: sub.name })}\n                                      delayLongPress={2000}\n                                      activeOpacity={0.7}\n                                      onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('sub', String(main.id), String(sub.id))) : undefined}\n                                      onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\n                                    >\n                                      <Ionicons\n                                        name={sub.expanded ? 'chevron-down' : 'chevron-forward'}\n                                        size={16}\n                                        color=\"#222\"\n                                        style={{\n                                          marginRight: 4,\n                                          transform: Platform.OS === 'web' ? [{ rotate: `${(spinSub[sub.id] || 0) * 360}deg` }] : undefined,\n                                          transitionProperty: Platform.OS === 'web' ? 'transform' : undefined,\n                                          transitionDuration: Platform.OS === 'web' ? '0.35s' : undefined,\n                                          transitionTimingFunction: Platform.OS === 'web' ? 'ease' : undefined,\n                                        }}\n                                      />\n                                      <Text style={{ fontSize: 14, fontWeight: isHovered ? '700' : '600', color: '#222', marginLeft: 2 }}>{sub.name}</Text>\n                                    </TouchableOpacity>\n                                      );\n                                    })()}\n                                  </View>\n                                  {sub.expanded && (\n                                    <React.Fragment>\n                                      {projects.length === 0 ? (\n                                        <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\n                                          {allProjects.length === 0 ? 'Inga projekt skapade' : 'Inga projekt matchar filtret'}\n                                        </Text>\n                                      ) : (\n                                        projects\n                                          .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                                          .map((proj) => (\n                                            <View\n                                              key={proj.id}\n                                              style={{ marginLeft: 32 }}\n                                              dataSet={Platform.OS === 'web' ? { dkType: 'project', dkMainid: String(main.id), dkSubid: String(sub.id), dkProjectid: String(proj.id) } : undefined}\n                                            >\n                                              {(() => {\n                                                const isHovered = Platform.OS === 'web' && hoveredRowKey === getRowKey('project', String(main.id), String(sub.id), String(proj.id));\n                                                return (\n                                              <TouchableOpacity\n                                                dataSet={Platform.OS === 'web' ? { dkType: 'project', dkMainid: String(main.id), dkSubid: String(sub.id), dkProjectid: String(proj.id) } : undefined}\n                                                style={{\n                                                  flexDirection: 'row',\n                                                  alignItems: 'center',\n                                                  backgroundColor: isHovered ? '#eee' : 'transparent',\n                                                  borderRadius: 4,\n                                                  padding: '2px 4px',\n                                                  marginBottom: 0,\n                                                  borderWidth: 1,\n                                                  borderColor: isHovered ? '#1976D2' : 'transparent',\n                                                  transition: 'background 0.15s, border 0.15s',\n                                                }}\n                                                onMouseEnter={Platform.OS === 'web' ? () => setHoveredRowKey(getRowKey('project', String(main.id), String(sub.id), String(proj.id))) : undefined}\n                                                onMouseLeave={Platform.OS === 'web' ? () => setHoveredRowKey(null) : undefined}\n                                                onPress={() => {\n                                                  if (Platform.OS === 'web') {\n                                                    requestProjectSwitch(proj, { selectedAction: null });\n                                                  } else {\n                                                    navigation.navigate('ProjectDetails', {\n                                                      project: {\n                                                        id: proj.id,\n                                                        name: proj.name,\n                                                        ansvarig: proj.ansvarig || '',\n                                                        adress: proj.adress || '',\n                                                        fastighetsbeteckning: proj.fastighetsbeteckning || '',\n                                                        client: proj.client || '',\n                                                        status: proj.status || 'ongoing',\n                                                        createdAt: proj.createdAt || '',\n                                                        createdBy: proj.createdBy || ''\n                                                      },\n                                                      companyId\n                                                    });\n                                                  }\n                                                }}\n                                              >\n                                                <View style={{ width: 12, height: 12, borderRadius: 6, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 6, borderWidth: 1, borderColor: '#bbb' }} />\n                                                <Text\n                                                  style={{ fontSize: 13, color: '#1976D2', fontWeight: isHovered ? '700' : '400', marginLeft: 2, marginRight: 6, flexShrink: 1 }}\n                                                  numberOfLines={1}\n                                                  ellipsizeMode=\"tail\"\n                                                >\n                                                  {proj.id} — {proj.name}\n                                                </Text>\n                                              </TouchableOpacity>\n                                                );\n                                              })()}\n                                            </View>\n                                          ))\n                                      )}\n                                    </React.Fragment>\n                                  )}\n                                </View>\n                                  );\n                                })\n                            )\n                          )}\n                        </View>\n                      ))}\n                  </View>\n                )}\n              </ScrollView>\n\n              {Platform.OS === 'web' && (\n                <ContextMenu\n                  visible={contextMenu.visible}\n                  x={contextMenu.x}\n                  y={contextMenu.y}\n                  items={contextMenuItems}\n                  onSelect={handleContextMenuSelect}\n                  onClose={closeContextMenu}\n                />\n              )}\n              \n              {/* Sidebar bottom-left: sync status + app version (web portal to avoid clipping) */}\n              {Platform.OS === 'web' && createPortal && typeof document !== 'undefined' ? (() => {\n                try {\n                  let footerRoot = document.getElementById('dk-footer-portal');\n                  if (!footerRoot) {\n                    footerRoot = document.createElement('div');\n                    footerRoot.id = 'dk-footer-portal';\n                    document.body.appendChild(footerRoot);\n                  }\n\n                  const FooterBox = (\n                    <View style={{ position: 'fixed', left: 12, bottom: 12, zIndex: 2147483647, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.96)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', shadowColor: '#000', shadowOffset: { width: 0, height: 6 }, shadowOpacity: 0.12, shadowRadius: 12, elevation: 12, ...(Platform && Platform.OS === 'web' ? { boxShadow: '0px 6px 12px rgba(0,0,0,0.12)' } : {}) }}>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', gap: 10 }}>\n                        <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\n                          Synk: {syncStatus}\n                        </Text>\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 6 }}>Version: {appVersion}</Text>\n                      </View>\n                    </View>\n                  );\n\n                  return createPortal(FooterBox, footerRoot);\n                } catch(_e) {\n                    return (\n                    <View style={{ position: 'absolute', left: 8, bottom: 8, zIndex: 9999, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.95)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', elevation: 8, ...(Platform && Platform.OS === 'web' ? { boxShadow: '0px 6px 12px rgba(0,0,0,0.12)' } : {}) }}>\n                      <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                        <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\n                          Synk: {syncStatus}\n                        </Text>\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 8 }}>Version: {appVersion}</Text>\n                      </View>\n                    </View>\n                  );\n                }\n              })() : (\n                <View style={{ position: 'absolute', left: 8, bottom: 8, zIndex: 9999, pointerEvents: 'auto', backgroundColor: 'rgba(255,255,255,0.95)', paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#e6e6e6', elevation: 8, ...(Platform && Platform.OS === 'web' ? { boxShadow: '0px 6px 12px rgba(0,0,0,0.12)' } : {}) }}>\n                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                    <Text style={{ fontSize: 12, color: syncStatus === 'synced' ? '#2E7D32' : syncStatus === 'syncing' ? '#F57C00' : syncStatus === 'offline' ? '#757575' : syncStatus === 'error' ? '#D32F2F' : '#444' }}>\n                      Synk: {syncStatus}\n                    </Text>\n                    <Text style={{ fontSize: 12, color: '#666', marginLeft: 8 }}>Version: {appVersion}</Text>\n                  </View>\n                </View>\n              )}\n\n            </View>\n            {Platform.OS === 'web' && (\n              <TouchableOpacity\n                onPress={() => scrollToEndSafe(leftTreeScrollRef)}\n                activeOpacity={0.85}\n                style={{\n                  position: 'absolute',\n                  right: 10,\n                  bottom: 10,\n                  zIndex: 20,\n                  backgroundColor: '#fff',\n                  borderRadius: 16,\n                  borderWidth: 1,\n                  borderColor: '#e0e0e0',\n                  padding: 6,\n                }}\n              >\n                <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n              </TouchableOpacity>\n            )}\n\n            <View style={{ flex: 1, height: webPaneHeight, position: 'relative' }}>\n              {Platform.OS === 'web' ? (\n                <View style={{ flex: 1, flexDirection: 'row', minWidth: 0 }}>\n                  {/* Main content (dashboard / project / control) */}\n                  <View style={{ flex: 1, minWidth: 0 }}>\n                    <ScrollView ref={rightPaneScrollRef} style={{ flex: 1 }} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\n                      {inlineControlEditor && inlineControlEditor.project ? (\n                        <View style={{ flex: 1, padding: 18 }}>\n                          <TemplateControlScreen\n                            project={inlineControlEditor.project}\n                            controlType={inlineControlEditor.controlType}\n                            route={{ params: { templateId: inlineControlEditor.templateId || null, companyId } }}\n                            onExit={closeInlineControlEditor}\n                            onFinished={handleInlineControlFinished}\n                          />\n                        </View>\n                      ) : selectedProject ? (\n                        <View style={{ flex: 1 }}>\n                          <ProjectDetails route={{ params: { project: selectedProject, companyId, selectedAction: projectSelectedAction, onInlineLockChange: handleInlineLockChange } }} navigation={navigation} inlineClose={closeSelectedProject} refreshNonce={projectControlsRefreshNonce} />\n                        </View>\n                      ) : (\n                        <View style={{ flex: 1, padding: 18 }}>\n                          <View style={{ position: 'relative' }}>\n                            {Platform.OS === 'web' && dashboardFocus ? (\n                              <Pressable\n                                style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, zIndex: 10 }}\n                                onPress={() => { setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }}\n                              />\n                            ) : null}\n\n                            <View style={dashboardContainerStyle}>\n                              {Platform.OS === 'web' ? (\n                                <View style={{ marginBottom: 14 }}>\n                                  <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: 36, flexWrap: 'wrap' }}>\n                                    <TouchableOpacity\n                                      activeOpacity={0.9}\n                                      onPress={() => { console.log('Dashboard button 1 clicked'); }}\n                                      style={{ borderRadius: 14, overflow: 'hidden', width: 380, height: 180, backgroundColor: '#fff' }}\n                                    >\n                                      <Image\n                                        source={dashboardBtn1Url && !dashboardBtn1Failed ? { uri: dashboardBtn1Url } : require('../assets/images/partial-react-logo.png')}\n                                        style={{ width: '100%', height: '100%' }}\n                                        resizeMode=\"cover\"\n                                        onError={() => { try { setDashboardBtn1Failed(true); } catch(_e) {} }}\n                                        onLoad={() => { try { setDashboardBtn1Failed(false); } catch(_e) {} }}\n                                      />\n                                    </TouchableOpacity>\n\n                                    <TouchableOpacity\n                                      activeOpacity={0.9}\n                                      onPress={() => { console.log('Dashboard button 2 clicked'); }}\n                                      style={{ borderRadius: 14, overflow: 'hidden', width: 380, height: 180, backgroundColor: '#fff' }}\n                                    >\n                                      <Image\n                                        source={dashboardBtn2Url && !dashboardBtn2Failed ? { uri: dashboardBtn2Url } : require('../assets/images/partial-react-logo.png')}\n                                        style={{ width: '100%', height: '100%' }}\n                                        resizeMode=\"cover\"\n                                        onError={() => { try { setDashboardBtn2Failed(true); } catch(_e) {} }}\n                                        onLoad={() => { try { setDashboardBtn2Failed(false); } catch(_e) {} }}\n                                      />\n                                    </TouchableOpacity>\n                                  </View>\n                                </View>\n                              ) : null}\n                            <View style={dashboardColumnsStyle}>\n                              {/* Column 1: Continue */}\n                              <View style={{ flex: 1, minWidth: 360, marginRight: 16 }}>\n                                <Text style={[dashboardSectionTitleStyle, { marginTop: 12 }]}>Senaste projekten</Text>\n                                <View style={dashboardCardStyle}>\n                                  {dashboardLoading ? (\n                                    <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\n                                  ) : (dashboardRecentProjects || []).length === 0 ? (\n                                    <Text style={dashboardEmptyTextStyle}>Inga senaste projekt ännu.</Text>\n                                  ) : (\n                                    (dashboardRecentProjects || []).map((entry, idx) => (\n                                      <TouchableOpacity\n                                        key={`${entry.projectId}-${idx}`}\n                                        activeOpacity={0.85}\n                                        onPress={() => {\n                                          if (entry?.project) {\n                                            requestProjectSwitch(entry.project, { selectedAction: null });\n                                          }\n                                        }}\n                                        style={dashboardListItemStyle(idx)}\n                                      >\n                                        <Text style={dashboardLinkTitleStyle} numberOfLines={1}>\n                                          {entry.project.id} — {entry.project.name}\n                                        </Text>\n                                        <Text style={dashboardMetaTextStyle}>\n                                          Senast aktivitet: {formatRelativeTime(entry.ts)}\n                                        </Text>\n                                      </TouchableOpacity>\n                                    ))\n                                  )}\n                                </View>\n                              </View>\n\n                              <View style={{ width: 320, minWidth: 280, position: 'relative' }}>\n                                {/* Overview moved to right-hand ActivityPanel on web */}\n\n                                <Text style={[dashboardSectionTitleStyle, { marginTop: 12 }]}>Påminnelser</Text>\n                                <View\n                                  style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}\n                                  onLayout={Platform.OS === 'web' ? (e) => { dashboardCardLayoutRef.current.reminders = e?.nativeEvent?.layout || null; } : undefined}\n                                >\n                                  {[\n                                    {\n                                      key: 'remindersSkyddsrondUpcoming',\n                                      label: 'Kommande skyddsronder',\n                                      color: '#FFD600',\n                                      value: (dashboardOverview.skyddsrondDueSoon ?? 0) + (dashboardOverview.skyddsrondOverdue ?? 0),\n                                      focus: 'upcomingSkyddsrond',\n                                    },\n                                    { key: 'remindersOpenDeviations', label: 'Öppna avvikelser', color: '#FFD600', value: dashboardOverview.openDeviations, focus: 'openDeviations' },\n                                    { key: 'remindersDrafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts' },\n                                  ].map((row, ridx) => {\n                                    const isWeb = Platform.OS === 'web';\n                                    const isHovered = isWeb && dashboardHoveredStatKey === row.key;\n                                    const isOpen = isWeb && dashboardFocus === row.focus && dashboardDropdownAnchor === 'reminders';\n                                    const openFromRow = () => {\n                                      const cardLayout = dashboardCardLayoutRef.current.reminders;\n                                      const rowLayout = dashboardStatRowLayoutRef.current[`reminders:${row.key}`];\n                                      // Position top flush under the row (no extra gap)\n                                      const top = (cardLayout && rowLayout) ? (cardLayout.y + rowLayout.y + rowLayout.height) : undefined;\n                                      console.log && console.log('dashboard: reminders row press', row.key, row.focus, { cardLayout, rowLayout, top });\n                                      setDashboardHoveredStatKey(row.key);\n                                      setDashboardDropdownRowKey(row.key);\n                                      toggleDashboardFocus(row.focus, 'reminders', top);\n                                    };\n                                    return (\n                                      <TouchableOpacity\n                                        key={row.key}\n                                        style={{\n                                          ...dashboardStatRowStyle(ridx),\n                                          paddingHorizontal: 6,\n                                          borderRadius: 8,\n                                          borderWidth: 1,\n                                          borderColor: isHovered ? '#1976D2' : 'transparent',\n                                          backgroundColor: isHovered ? '#eee' : 'transparent',\n                                          cursor: isWeb ? 'pointer' : undefined,\n                                          transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\n                                        }}\n                                        activeOpacity={0.75}\n                                        onPress={openFromRow}\n                                        onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\n                                        onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\n                                        onLayout={isWeb ? (e) => {\n                                          const l = e?.nativeEvent?.layout;\n                                          if (l) dashboardStatRowLayoutRef.current[`reminders:${row.key}`] = l;\n                                        } : undefined}\n                                      >\n                                        <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} />\n                                        <View style={dashboardStatDotStyle(row.color)} />\n                                        <Text style={dashboardStatLabelStyle}>{row.label}</Text>\n                                        <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\n                                      </TouchableOpacity>\n                                    );\n                                  })}\n                                </View>\n\n                                {/* Web-only: dropdown overlay for Reminders (renders in center column) */}\n                                {Platform.OS === 'web' && dashboardFocus && dashboardDropdownAnchor === 'reminders' ? (\n                                  <View\n                                    style={(function() {\n                                      try {\n                                        const card = dashboardCardLayoutRef && dashboardCardLayoutRef.current && dashboardCardLayoutRef.current.reminders;\n                                        const rKey = dashboardDropdownRowKey;\n                                        const rowLayout = rKey ? dashboardStatRowLayoutRef.current[`reminders:${rKey}`] : null;\n                                        // compute top relative to card: prefer rowLayout.y + rowLayout.height so dropdown is flush\n                                        let top;\n                                        const NUDGE_DOWN = 28; // small downward nudge so header/title remains visible\n                                        if (rowLayout && typeof rowLayout.y === 'number') {\n                                          top = rowLayout.y + rowLayout.height + NUDGE_DOWN;\n                                        } else if (typeof dashboardDropdownTop === 'number' && card && typeof card.y === 'number') {\n                                          top = Math.max(0, dashboardDropdownTop - card.y + NUDGE_DOWN);\n                                        } else if (card && typeof card.height === 'number') {\n                                          top = card.height + NUDGE_DOWN;\n                                        } else {\n                                          top = 210 + NUDGE_DOWN;\n                                        }\n\n                                        // align to row/button when possible and position dropdown below the row (dropdown top == row bottom + nudge)\n                                        if (rowLayout && typeof rowLayout.x === 'number' && typeof rowLayout.width === 'number' && card && typeof rowLayout.y === 'number' && typeof rowLayout.height === 'number') {\n                                          const topPos = rowLayout.y + rowLayout.height + NUDGE_DOWN;\n                                          console.log && console.log('dashboard reminders overlay positioning (top)', { cardHeight: card.height, rowY: rowLayout.y, rowHeight: rowLayout.height, top: topPos });\n                                          return { position: 'absolute', left: rowLayout.x, width: rowLayout.width, top: topPos, zIndex: 20 };\n                                        }\n\n                                        // fallback: place dropdown under the card\n                                        if (card && typeof card.width === 'number' && typeof card.height === 'number') return { position: 'absolute', left: 0, width: card.width, top: card.height, zIndex: 20 };\n                                      } catch (e) {}\n                                      return { position: 'absolute', left: 0, right: 0, top: 218, zIndex: 20 };\n                                    })()}\n                                  >\n                                    <View style={[dashboardCardStyle, { paddingTop: 0, borderTopLeftRadius: 0, borderTopRightRadius: 0 }]}> \n                                      <ScrollView\n                                        style={{\n                                          maxHeight: Math.max(\n                                            180,\n                                            (webPaneHeight || 640) -\n                                              (typeof dashboardDropdownTop === 'number' ? dashboardDropdownTop : 220) -\n                                              24\n                                          ),\n                                          paddingTop: 0,\n                                        }}\n                                      >\n                                        {dashboardLoading ? (\n                                          <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\n                                        ) : (\n                                          (() => {\n                                            const focus = dashboardFocus;\n\n                                            if (focus === 'activeProjects') {\n                                              const items = Array.isArray(dashboardActiveProjectsList) ? dashboardActiveProjectsList : [];\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga pågående projekt.</Text>;\n                                              return items.map((p, idx) => (\n                                                <TouchableOpacity\n                                                  key={`${p.id}-${idx}`}\n                                                  activeOpacity={0.85}\n                                                  onPress={() => { requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }}\n                                                  style={dashboardListItemStyle(idx)}\n                                                >\n                                                  <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\n                                                </TouchableOpacity>\n                                              ));\n                                            }\n\n                                            if (focus === 'drafts' || focus === 'controlsToSign') {\n                                              const items = focus === 'controlsToSign'\n                                                ? (Array.isArray(dashboardControlsToSignItems) ? dashboardControlsToSignItems : [])\n                                                : (Array.isArray(dashboardDraftItems) ? dashboardDraftItems : []);\n\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga utkast.</Text>;\n                                              return items.map((d, idx) => {\n                                                const pid = d?.project?.id || d?.projectId || d?.project || null;\n                                                const projectId = pid ? String(pid) : '';\n                                                const projObj = projectId ? findProjectById(projectId) : null;\n                                                const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                                                const ts = d?.savedAt || d?.updatedAt || d?.createdAt || d?.date || null;\n                                                const type = String(d?.type || 'Utkast');\n                                                return (\n                                                  <TouchableOpacity\n                                                    key={`${projectId}-${type}-${idx}`}\n                                                    activeOpacity={0.85}\n                                                    onPress={() => {\n                                                      if (!projObj) return;\n                                                      requestProjectSwitch(projObj, {\n                                                        selectedAction: {\n                                                          id: `openDraft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,\n                                                          kind: 'openDraft',\n                                                          type,\n                                                          initialValues: d,\n                                                        },\n                                                        clearActionAfter: true,\n                                                      });\n                                                      setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null);\n                                                    }}\n                                                    style={dashboardListItemStyle(idx)}\n                                                  >\n                                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                                                    <Text style={dashboardMetaTextStyle}>{type}{ts ? ` • Sparat: ${formatRelativeTime(ts)}` : ''}</Text>\n                                                  </TouchableOpacity>\n                                                );\n                                              });\n                                            }\n\n                                            if (focus === 'openDeviations') {\n                                              const items = Array.isArray(dashboardOpenDeviationItems) ? dashboardOpenDeviationItems : [];\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga öppna avvikelser.</Text>;\n                                              return items.map((entry, idx) => {\n                                                const c = entry?.control;\n                                                const pid = c?.project?.id || c?.projectId || c?.project || null;\n                                                const projectId = pid ? String(pid) : '';\n                                                const projObj = projectId ? findProjectById(projectId) : null;\n                                                const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                                                const openCount = entry?.openCount || 0;\n                                                return (\n                                                  <TouchableOpacity\n                                                    key={`${projectId}-${c?.id || idx}`}\n                                                    activeOpacity={0.85}\n                                                    onPress={() => {\n                                                      if (!projObj || !c) return;\n                                                      requestProjectSwitch(projObj, {\n                                                        selectedAction: {\n                                                          id: `openControl-${c?.id || Date.now()}`,\n                                                          kind: 'openControlDetails',\n                                                          control: c,\n                                                        },\n                                                        clearActionAfter: true,\n                                                      });\n                                                      setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null);\n                                                    }}\n                                                    style={dashboardListItemStyle(idx)}\n                                                  >\n                                                    <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\n                                                      <View style={[dashboardStatDotStyle('#FFD600'), { marginTop: 4 }]} />\n                                                      <View style={{ flex: 1, minWidth: 0 }}>\n                                                        <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                                                        <Text style={dashboardMetaTextStyle}>Skyddsrond • Öppna avvikelser: {String(openCount)}</Text>\n                                                      </View>\n                                                    </View>\n                                                  </TouchableOpacity>\n                                                );\n                                              });\n                                            }\n\n                                            if (focus === 'upcomingSkyddsrond') {\n                                              const items = Array.isArray(dashboardUpcomingSkyddsrondItems) ? dashboardUpcomingSkyddsrondItems : [];\n                                              if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga kommande skyddsronder.</Text>;\n                                              return items.map((entry, idx) => {\n                                                const p = entry?.project;\n                                                const dueMs = Number(entry?.nextDueMs || 0);\n                                                const dueLabel = dueMs ? new Date(dueMs).toLocaleDateString('sv-SE') : '';\n                                                const state = entry?.state === 'overdue' ? 'Försenad' : 'Snart';\n                                                return (\n                                                  <TouchableOpacity\n                                                    key={`${p?.id || 'proj'}-${idx}`}\n                                                    activeOpacity={0.85}\n                                                    onPress={() => { if (p) requestProjectSwitch(p, { selectedAction: null }); setDashboardFocus(null); setDashboardDropdownTop(null); setDashboardHoveredStatKey(null); }}\n                                                    style={dashboardListItemStyle(idx)}\n                                                  >\n                                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p?.id} — {p?.name}</Text>\n                                                    <Text style={dashboardMetaTextStyle}>{state}{dueLabel ? ` • Nästa: ${dueLabel}` : ''}</Text>\n                                                  </TouchableOpacity>\n                                                );\n                                              });\n                                            }\n\n                                            return <Text style={dashboardEmptyTextStyle}>Inget att visa.</Text>;\n                                          })()\n                                        )}\n                                      </ScrollView>\n                                    </View>\n                                  </View>\n                                ) : null}\n                              </View>\n                            </View>\n                          </View>\n                          </View>\n                        </View>\n                      )}\n                    </ScrollView>\n                    <TouchableOpacity\n                      onPress={() => scrollToEndSafe(rightPaneScrollRef)}\n                      activeOpacity={0.85}\n                      style={{\n                        position: 'absolute',\n                        right: 10,\n                        bottom: 10,\n                        zIndex: 20,\n                        backgroundColor: '#fff',\n                        borderRadius: 16,\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        padding: 6,\n                      }}\n                    >\n                      <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n                    </TouchableOpacity>\n                  </View>\n\n                  {/* Persistent right side: activity */}\n                  <View style={{ width: rightWidth, minWidth: 340, maxWidth: 520, padding: 18, borderLeftWidth: 1, borderLeftColor: '#e6e6e6', backgroundColor: '#F7FAFC', position: 'relative' }}>\n                    {/* Divider for visual separation */}\n                    <View style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: 1, backgroundColor: '#e6e6e6' }} />\n                    {/* Draggable handle - sits above the left divider of the right panel */}\n                    <View\n                      {...(panResponderRight && panResponderRight.panHandlers)}\n                      style={Platform.OS === 'web' ? { position: 'absolute', left: -8, top: 0, bottom: 0, width: 16, cursor: 'col-resize', zIndex: 9 } : { position: 'absolute', left: -12, top: 0, bottom: 0, width: 24, zIndex: 9 }}\n                    />\n                    <ScrollView ref={activityScrollRef} style={{ flex: 1 }} contentContainerStyle={{ paddingBottom: 24 }}>\n                      <ActivityPanel />\n                    </ScrollView>\n                    <TouchableOpacity\n                      onPress={() => scrollToEndSafe(activityScrollRef)}\n                      activeOpacity={0.85}\n                      style={{\n                        position: 'absolute',\n                        right: 10,\n                        bottom: 10,\n                        zIndex: 20,\n                        backgroundColor: '#fff',\n                        borderRadius: 16,\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        padding: 6,\n                      }}\n                    >\n                      <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n                    </TouchableOpacity>\n                  </View>\n                </View>\n              ) : (\n                <ScrollView ref={rightPaneScrollRef} style={{ flex: 1 }} contentContainerStyle={{ flexGrow: 1, paddingBottom: 24 }}>\n                  {selectedProject ? (\n                    <View style={{ flex: 1 }}>\n                      <ProjectDetails route={{ params: { project: selectedProject, companyId, selectedAction: projectSelectedAction, onInlineLockChange: handleInlineLockChange } }} navigation={navigation} inlineClose={closeSelectedProject} refreshNonce={projectControlsRefreshNonce} />\n                    </View>\n                  ) : (\n                    <View style={{ flex: 1, padding: 18 }}>\n                      <View style={dashboardContainerStyle}>\n                        <View style={dashboardColumnsStyle}>\n                          <View style={{ flex: 1, minWidth: 360, marginRight: 16 }}>\n                            <Text style={[dashboardSectionTitleStyle, { marginTop: 12 }]}>Senaste projekten</Text>\n                            <View style={dashboardCardStyle}>\n                              {dashboardLoading ? (\n                                <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\n                              ) : (dashboardRecentProjects || []).length === 0 ? (\n                                <Text style={dashboardEmptyTextStyle}>Inga senaste projekt ännu.</Text>\n                              ) : (\n                                (dashboardRecentProjects || []).map((entry, idx) => (\n                                  <TouchableOpacity\n                                    key={`${entry.projectId}-${idx}`}\n                                    activeOpacity={0.85}\n                                    onPress={() => {\n                                      if (entry?.project) {\n                                        requestProjectSwitch(entry.project, { selectedAction: null });\n                                      }\n                                    }}\n                                    style={dashboardListItemStyle(idx)}\n                                  >\n                                    <Text style={dashboardLinkTitleStyle} numberOfLines={1}>\n                                      {entry.project.id} — {entry.project.name}\n                                    </Text>\n                                    <Text style={dashboardMetaTextStyle}>\n                                      Senast aktivitet: {formatRelativeTime(entry.ts)}\n                                    </Text>\n                                  </TouchableOpacity>\n                                ))\n                              )}\n                            </View>\n\n                            {dashboardFocus ? (\n                              <View style={{ marginTop: 16 }}>\n                                <Text style={dashboardSectionTitleStyle}>\n                                  {dashboardFocus === 'activeProjects'\n                                    ? 'Pågående projekt'\n                                    : dashboardFocus === 'controlsToSign'\n                                      ? 'Kontroller att signera'\n                                      : dashboardFocus === 'drafts'\n                                        ? 'Sparade utkast'\n                                        : dashboardFocus === 'openDeviations'\n                                          ? 'Öppna avvikelser'\n                                          : dashboardFocus === 'upcomingSkyddsrond'\n                                            ? 'Kommande skyddsronder'\n                                            : 'Lista'}\n                                </Text>\n                                <View style={dashboardCardStyle}>\n                                  {dashboardLoading ? (\n                                    <Text style={dashboardEmptyTextStyle}>Laddar…</Text>\n                                  ) : (\n                                    (() => {\n                                      const focus = dashboardFocus;\n\n                                      if (focus === 'activeProjects') {\n                                        const items = Array.isArray(dashboardActiveProjectsList) ? dashboardActiveProjectsList : [];\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga pågående projekt.</Text>;\n                                        return items.map((p, idx) => (\n                                          <TouchableOpacity\n                                            key={`${p.id}-${idx}`}\n                                            activeOpacity={0.85}\n                                            onPress={() => requestProjectSwitch(p, { selectedAction: null })}\n                                            style={dashboardListItemStyle(idx)}\n                                          >\n                                            <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p.id} — {p.name}</Text>\n                                          </TouchableOpacity>\n                                        ));\n                                      }\n\n                                      if (focus === 'drafts' || focus === 'controlsToSign') {\n                                        const items = focus === 'controlsToSign'\n                                          ? (Array.isArray(dashboardControlsToSignItems) ? dashboardControlsToSignItems : [])\n                                          : (Array.isArray(dashboardDraftItems) ? dashboardDraftItems : []);\n\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga utkast.</Text>;\n                                        return items.map((d, idx) => {\n                                          const pid = d?.project?.id || d?.projectId || d?.project || null;\n                                          const projectId = pid ? String(pid) : '';\n                                          const projObj = projectId ? findProjectById(projectId) : null;\n                                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                                          const ts = d?.savedAt || d?.updatedAt || d?.createdAt || d?.date || null;\n                                          const type = String(d?.type || 'Utkast');\n                                          return (\n                                            <TouchableOpacity\n                                              key={`${projectId}-${type}-${idx}`}\n                                              activeOpacity={0.85}\n                                              onPress={() => {\n                                                if (!projObj) return;\n                                                requestProjectSwitch(projObj, {\n                                                  selectedAction: {\n                                                    id: `openDraft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,\n                                                    kind: 'openDraft',\n                                                    type,\n                                                    initialValues: d,\n                                                  },\n                                                  clearActionAfter: true,\n                                                });\n                                              }}\n                                              style={dashboardListItemStyle(idx)}\n                                            >\n                                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                                              <Text style={dashboardMetaTextStyle}>{type}{ts ? ` • Sparat: ${formatRelativeTime(ts)}` : ''}</Text>\n                                            </TouchableOpacity>\n                                          );\n                                        });\n                                      }\n\n                                      if (focus === 'openDeviations') {\n                                        const items = Array.isArray(dashboardOpenDeviationItems) ? dashboardOpenDeviationItems : [];\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga öppna avvikelser.</Text>;\n                                        return items.map((entry, idx) => {\n                                          const c = entry?.control;\n                                          const pid = c?.project?.id || c?.projectId || c?.project || null;\n                                          const projectId = pid ? String(pid) : '';\n                                          const projObj = projectId ? findProjectById(projectId) : null;\n                                          const title = projObj ? `${projObj.id} — ${projObj.name}` : (projectId || 'Projekt');\n                                          const openCount = entry?.openCount || 0;\n                                          return (\n                                            <TouchableOpacity\n                                              key={`${projectId}-${c?.id || idx}`}\n                                              activeOpacity={0.85}\n                                              onPress={() => {\n                                                if (!projObj || !c) return;\n                                                requestProjectSwitch(projObj, {\n                                                  selectedAction: {\n                                                    id: `openControl-${c?.id || Date.now()}`,\n                                                    kind: 'openControlDetails',\n                                                    control: c,\n                                                  },\n                                                  clearActionAfter: true,\n                                                });\n                                              }}\n                                              style={dashboardListItemStyle(idx)}\n                                            >\n                                              <View style={{ flexDirection: 'row', alignItems: 'flex-start' }}>\n                                                <View style={[dashboardStatDotStyle('#FFD600'), { marginTop: 4 }]} />\n                                                <View style={{ flex: 1, minWidth: 0 }}>\n                                                  <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{title}</Text>\n                                                  <Text style={dashboardMetaTextStyle}>Skyddsrond • Öppna avvikelser: {String(openCount)}</Text>\n                                                </View>\n                                              </View>\n                                            </TouchableOpacity>\n                                          );\n                                        });\n                                      }\n\n                                      if (focus === 'upcomingSkyddsrond') {\n                                        const items = Array.isArray(dashboardUpcomingSkyddsrondItems) ? dashboardUpcomingSkyddsrondItems : [];\n                                        if (items.length === 0) return <Text style={dashboardEmptyTextStyle}>Inga kommande skyddsronder.</Text>;\n                                        return items.map((entry, idx) => {\n                                          const p = entry?.project;\n                                          const dueMs = Number(entry?.nextDueMs || 0);\n                                          const dueLabel = dueMs ? new Date(dueMs).toLocaleDateString('sv-SE') : '';\n                                          const state = entry?.state === 'overdue' ? 'Försenad' : 'Snart';\n                                          return (\n                                            <TouchableOpacity\n                                              key={`${p?.id || 'proj'}-${idx}`}\n                                              activeOpacity={0.85}\n                                              onPress={() => { if (p) requestProjectSwitch(p, { selectedAction: null }); }}\n                                              style={dashboardListItemStyle(idx)}\n                                            >\n                                              <Text style={dashboardLinkTitleStyle} numberOfLines={1}>{p?.id} — {p?.name}</Text>\n                                              <Text style={dashboardMetaTextStyle}>{state}{dueLabel ? ` • Nästa: ${dueLabel}` : ''}</Text>\n                                            </TouchableOpacity>\n                                          );\n                                        });\n                                      }\n\n                                      return <Text style={dashboardEmptyTextStyle}>Inget att visa.</Text>;\n                                    })()\n                                  )}\n                                </View>\n                              </View>\n                            ) : null}\n                          </View>\n                          <View style={{ width: 320, minWidth: 280 }}>\n                            <Text style={dashboardSectionTitleStyle}>Översikt</Text>\n                            <View style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}>\n                              {[\n                                { key: 'activeProjects', label: 'Pågående projekt', color: '#43A047', value: dashboardOverview.activeProjects, focus: 'activeProjects', onPress: () => { toggleDashboardFocus('activeProjects'); } },\n                                { key: 'completedProjects', label: 'Avslutade projekt', color: '#222', value: (_countProjectStatus ? _countProjectStatus(hierarchy).completed : 0), focus: 'completedProjects', onPress: () => { toggleDashboardFocus('completedProjects'); } },\n                                { key: 'controlsToSign', label: 'Kontroller att signera', color: '#D32F2F', value: dashboardOverview.controlsToSign, focus: 'controlsToSign', onPress: () => toggleDashboardFocus('controlsToSign') },\n                                { key: 'drafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts', onPress: () => toggleDashboardFocus('drafts') },\n                              ].map((row, ridx) => {\n                                const isWeb = Platform.OS === 'web';\n                                const isHovered = isWeb && dashboardHoveredStatKey === row.key;\n                                const isOpen = !isWeb && dashboardFocus === row.focus;\n                                return (\n                                  <TouchableOpacity\n                                    key={row.key}\n                                    style={{\n                                      ...dashboardStatRowStyle(ridx),\n                                      paddingHorizontal: 6,\n                                      borderRadius: 8,\n                                      borderWidth: 1,\n                                      borderColor: isHovered ? '#1976D2' : 'transparent',\n                                      backgroundColor: isHovered ? '#eee' : 'transparent',\n                                      cursor: isWeb ? 'pointer' : undefined,\n                                      transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\n                                    }}\n                                    activeOpacity={0.75}\n                                    onPress={row.onPress}\n                                    onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\n                                    onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\n                                  >\n                                    {!isWeb ? <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} /> : null}\n                                    <View style={dashboardStatDotStyle(row.color)} />\n                                    <Text style={dashboardStatLabelStyle}>{row.label}</Text>\n                                    <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\n                                  </TouchableOpacity>\n                                );\n                              })}\n                            </View>\n\n                            {Platform.OS === 'web' ? null : (\n                              <>\n                                <Text style={[dashboardSectionTitleStyle, { marginTop: 12 }]}>Påminnelser</Text>\n                                <View style={[dashboardCardStyle, { padding: 16, marginBottom: 16 }]}>\n                                  {[\n                                    {\n                                      key: 'remindersSkyddsrondUpcoming',\n                                      label: 'Kommande skyddsronder',\n                                      color: '#FFD600',\n                                      value: (dashboardOverview.skyddsrondDueSoon ?? 0) + (dashboardOverview.skyddsrondOverdue ?? 0),\n                                      focus: 'upcomingSkyddsrond',\n                                      onPress: () => toggleDashboardFocus('upcomingSkyddsrond'),\n                                    },\n                                    { key: 'remindersOpenDeviations', label: 'Öppna avvikelser', color: '#FFD600', value: dashboardOverview.openDeviations, focus: 'openDeviations', onPress: () => toggleDashboardFocus('openDeviations') },\n                                    { key: 'remindersDrafts', label: 'Sparade utkast', color: '#888', value: dashboardOverview.drafts, focus: 'drafts', onPress: () => toggleDashboardFocus('drafts') },\n                                  ].map((row, ridx) => {\n                                    const isWeb = Platform.OS === 'web';\n                                    const isHovered = isWeb && dashboardHoveredStatKey === row.key;\n                                    const isOpen = !isWeb && dashboardFocus === row.focus;\n                                    return (\n                                      <TouchableOpacity\n                                        key={row.key}\n                                        style={{\n                                          ...dashboardStatRowStyle(ridx),\n                                          paddingHorizontal: 6,\n                                          borderRadius: 8,\n                                          borderWidth: 1,\n                                          borderColor: isHovered ? '#1976D2' : 'transparent',\n                                          backgroundColor: isHovered ? '#eee' : 'transparent',\n                                          cursor: isWeb ? 'pointer' : undefined,\n                                          transition: isWeb ? 'background 0.15s, border 0.15s' : undefined,\n                                        }}\n                                        activeOpacity={0.75}\n                                        onPress={row.onPress}\n                                        onMouseEnter={isWeb ? () => setDashboardHoveredStatKey(row.key) : undefined}\n                                        onMouseLeave={isWeb ? () => setDashboardHoveredStatKey(null) : undefined}\n                                      >\n                                        {!isWeb ? <Ionicons name={isOpen ? 'chevron-down' : 'chevron-forward'} size={16} color=\"#222\" style={{ marginRight: 6 }} /> : null}\n                                        <View style={dashboardStatDotStyle(row.color)} />\n                                        <Text style={dashboardStatLabelStyle}>{row.label}</Text>\n                                        <Text style={dashboardStatValueStyle}>{String(row.value ?? 0)}</Text>\n                                      </TouchableOpacity>\n                                    );\n                                  })}\n                                </View>\n                              </>\n                            )}\n                          </View>\n                          <View style={{ width: 420, minWidth: 320, position: 'relative' }}>\n                            <ActivityPanel />\n                          </View>\n                        </View>\n                      </View>\n                    </View>\n                  )}\n                </ScrollView>\n              )}\n            </View>\n          </View>\n        ) : null}\n          {/* Uppgifter-sektion + Skapa kontroll-knapp och popup för val av kontrolltyp */}\n          <View style={Platform.OS === 'web' ? { marginTop: 18, marginBottom: 16, alignItems: 'flex-start', paddingHorizontal: 16 } : { marginTop: 18, marginBottom: 16, alignItems: 'flex-start', paddingHorizontal: 16, width: '100%' }}>\n            {Platform.OS === 'web' ? (\n              <View>\n                <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '100%', marginBottom: 12 }} />\n                <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>\n                  {controlTypeOptions.map(({ type, icon, color }) => (\n                    <TouchableOpacity\n                      key={type}\n                      style={{\n                        flexDirection: 'row',\n                        alignItems: 'center',\n                        backgroundColor: '#fff',\n                        borderRadius: 12,\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        paddingVertical: 10,\n                        paddingHorizontal: 14,\n                        marginRight: 10,\n                        marginBottom: 10,\n                        shadowColor: '#000',\n                        shadowOffset: { width: 0, height: 2 },\n                        shadowOpacity: 0.06,\n                        shadowRadius: 4,\n                        elevation: 2,\n                        cursor: 'pointer'\n                      }}\n                      onPress={() => {\n                        setSelectProjectModal({ visible: true, type });\n                        setShowControlTypeModal(false);\n                      }}\n                      activeOpacity={0.85}\n                    >\n                      <Ionicons name={icon} size={18} color={color} style={{ marginRight: 10 }} />\n                      <Text style={{ color: '#222', fontWeight: '600', fontSize: 15 }}>{type}</Text>\n                    </TouchableOpacity>\n                  ))}\n                </View>\n              </View>\n            ) : (\n              <View>\n                <View style={{ width: '100%', marginBottom: 6 }}>\n                  <View style={{ width: '100%', backgroundColor: '#fff', borderRadius: 10, borderWidth: 1, borderColor: '#e0e0e0', overflow: 'hidden', shadowColor: '#222', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.06, shadowRadius: 4, elevation: 1 }}>\n                    <TouchableOpacity\n                      onPress={() => {\n                        try {\n                          if (!mainChevronSpinAnim.tasks) mainChevronSpinAnim.tasks = new Animated.Value(0);\n                          spinOnce(mainChevronSpinAnim.tasks);\n                        } catch (_) {}\n                        setTasksOpen(prev => {\n                          const next = !prev;\n                          if (next) setControlsOpen(false);\n                          return next;\n                        });\n                      }}\n                      activeOpacity={0.85}\n                      style={{\n                        width: '100%',\n                        flexDirection: 'row',\n                        alignItems: 'center',\n                        justifyContent: 'flex-start',\n                        paddingVertical: 12,\n                        paddingHorizontal: 12,\n                        minHeight: 44,\n                      }}\n                    >\n                      <Animated.View style={mainChevronSpinAnim.tasks ? { transform: [{ rotate: mainChevronSpinAnim.tasks.interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] }) }] } : undefined}>\n                        <Ionicons name={tasksOpen ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\n                      </Animated.View>\n                      <Text style={{ color: '#222', fontWeight: '700', fontSize: 16, marginLeft: 8, flex: 1 }}>{'Uppgifter'}</Text>\n                    </TouchableOpacity>\n\n                    {tasksOpen ? (\n                      <View>\n                        {[\n                          { key: 'task1', label: 'Uppgift 1', icon: 'list-outline', color: '#1976D2' },\n                          { key: 'task2', label: 'Uppgift 2', icon: 'time-outline', color: '#00897B' },\n                          { key: 'task3', label: 'Uppgift 3', icon: 'checkmark-circle-outline', color: '#7B1FA2' },\n                        ].map((btn, idx) => (\n                          <AnimatedRow\n                            key={btn.key}\n                            style={{\n                              backgroundColor: '#fff',\n                              flexDirection: 'row',\n                              alignItems: 'center',\n                              justifyContent: 'flex-start',\n                              paddingVertical: 12,\n                              paddingLeft: 28,\n                              paddingRight: 18,\n                              borderTopWidth: 1,\n                              borderColor: '#e0e0e0',\n                              minHeight: 44,\n                              width: '100%',\n                            }}\n                            onPress={() => {}}\n                          >\n                            <Ionicons name={btn.icon} size={18} color={btn.color} style={{ marginRight: 14 }} />\n                            <Text style={{ color: '#222', fontWeight: '600', fontSize: 15, letterSpacing: 0.2 }}>{btn.label}</Text>\n                          </AnimatedRow>\n                        ))}\n                      </View>\n                    ) : null}\n                  </View>\n                </View>\n\n                {/* Kontroll: grouped block (same style as Uppgifter) */}\n                <View style={{ width: '100%', marginTop: 4, marginBottom: 6, alignSelf: 'stretch' }}>\n                  <View style={{ width: '100%', backgroundColor: '#fff', borderRadius: 10, borderWidth: 1, borderColor: '#e0e0e0', overflow: 'hidden', shadowColor: '#222', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.06, shadowRadius: 4, elevation: 1 }}>\n                    <TouchableOpacity\n                      onPress={() => {\n                        try {\n                          if (!mainChevronSpinAnim.controls) mainChevronSpinAnim.controls = new Animated.Value(0);\n                          spinOnce(mainChevronSpinAnim.controls);\n                        } catch (_) {}\n                        setControlsOpen(prev => {\n                          const next = !prev;\n                          if (next) setTasksOpen(false);\n                          return next;\n                        });\n                      }}\n                      activeOpacity={0.85}\n                      style={{\n                        width: '100%',\n                        flexDirection: 'row',\n                        alignItems: 'center',\n                        justifyContent: 'flex-start',\n                        paddingVertical: 12,\n                        paddingHorizontal: 12,\n                        minHeight: 44,\n                      }}\n                    >\n                      <Animated.View style={mainChevronSpinAnim.controls ? { transform: [{ rotate: mainChevronSpinAnim.controls.interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] }) }] } : undefined}>\n                        <Ionicons name={controlsOpen ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\n                      </Animated.View>\n                      <Text style={{ color: '#222', fontWeight: '700', fontSize: 16, marginLeft: 8, flex: 1 }}>{'Skapa kontroll'}</Text>\n                    </TouchableOpacity>\n\n                    {controlsOpen ? (\n                      <View>\n                        {/* Skapa ny kontroll (keeps the add icon) */}\n                        <AnimatedRow\n                          onPress={() => setShowControlTypeModal(true)}\n                          style={{\n                            backgroundColor: '#fff',\n                            flexDirection: 'row',\n                            alignItems: 'center',\n                            justifyContent: 'flex-start',\n                            paddingVertical: 12,\n                            paddingLeft: 18,\n                            paddingRight: 18,\n                            borderTopWidth: 1,\n                            borderColor: '#e0e0e0',\n                            minHeight: 44,\n                            width: '100%',\n                          }}\n                        >\n                          <View style={{ width: 22, height: 22, borderRadius: 11, backgroundColor: '#1976D2', alignItems: 'center', justifyContent: 'center', marginRight: 12 }}>\n                            <Ionicons name=\"add\" size={16} color=\"#fff\" />\n                          </View>\n                          <Text style={{ color: '#222', fontWeight: '600', fontSize: 15, letterSpacing: 0.5 }}>Skapa ny kontroll</Text>\n                        </AnimatedRow>\n\n                        {/* Valfri 1-4 buttons */}\n                        {[1,2,3,4].map((n) => (\n                          <AnimatedRow\n                            key={`valfri-${n}`}\n                            style={{\n                              backgroundColor: '#fff',\n                              flexDirection: 'row',\n                              alignItems: 'center',\n                              justifyContent: 'flex-start',\n                              paddingVertical: 12,\n                              paddingLeft: 28,\n                              paddingRight: 18,\n                              borderTopWidth: 1,\n                              borderColor: '#e0e0e0',\n                              minHeight: 44,\n                              width: '100%',\n                            }}\n                            onPress={() => {}}\n                          >\n                            <Ionicons name=\"square-outline\" size={18} color=\"#78909C\" style={{ marginRight: 14 }} />\n                            <Text style={{ color: '#222', fontWeight: '600', fontSize: 15 }}>{`Valfri ${n}`}</Text>\n                          </AnimatedRow>\n                        ))}\n                      </View>\n                    ) : null}\n                  </View>\n                </View>\n              </View>\n            )}\n          \n            {/* Modal för val av kontrolltyp */}\n            {/* Modal för val av kontrolltyp */}\n            <Modal\n              visible={showControlTypeModal}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => setShowControlTypeModal(false)}\n            >\n              <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 18 }}>\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, paddingVertical: 20, paddingHorizontal: 20, width: 340, maxWidth: '90%', maxHeight: '60%', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 8, color: '#222', textAlign: 'center', marginTop: 6 }}>\n                    Välj kontrolltyp\n                  </Text>\n                  <View style={{ flexDirection: 'row', marginTop: 4 }}>\n                    <ScrollView\n                      style={{ maxHeight: 320, flex: 1 }}\n                      showsVerticalScrollIndicator\n                      onLayout={(e) => {\n                        const h = e?.nativeEvent?.layout?.height || 0;\n                        setControlTypeScrollMetrics(prev => ({ ...prev, containerHeight: h }));\n                      }}\n                      onContentSizeChange={(w, h) => {\n                        setControlTypeScrollMetrics(prev => ({ ...prev, contentHeight: h || 0 }));\n                      }}\n                      onScroll={(e) => {\n                        const y = e?.nativeEvent?.contentOffset?.y || 0;\n                        setControlTypeScrollMetrics(prev => ({ ...prev, scrollY: y }));\n                      }}\n                      scrollEventThrottle={16}\n                    >\n                      {controlTypeOptions.map(({ type, icon, color }) => (\n                        <TouchableOpacity\n                          key={type}\n                          style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 12, paddingHorizontal: 8, borderRadius: 8, marginBottom: 8, backgroundColor: '#f5f5f5', borderWidth: 1, borderColor: '#e0e0e0' }}\n                          onPress={() => {\n                            setSelectProjectModal({ visible: true, type });\n                            setShowControlTypeModal(false);\n                          }}\n                        >\n                          <Ionicons name={icon} size={22} color={color} style={{ marginRight: 12 }} />\n                          <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>{type}</Text>\n                        </TouchableOpacity>\n                      ))}\n                      {Array.isArray(companyProfile?.enabledControlTypes) && controlTypeOptions.length === 0 ? (\n                        <Text style={{ color: '#D32F2F', textAlign: 'center', marginTop: 6, marginBottom: 8 }}>\n                          Inga kontrolltyper är aktiverade för företaget.\n                        </Text>\n                      ) : null}\n                    </ScrollView>\n                    {controlTypeCanScroll ? (\n                      <View\n                          style={{\n                            pointerEvents: 'none',\n                            width: 3,\n                            marginLeft: 6,\n                            borderRadius: 999,\n                            backgroundColor: '#E0E0E0',\n                            height: controlTypeScrollMetrics.containerHeight || 0,\n                            overflow: 'hidden',\n                            alignSelf: 'flex-start',\n                            marginTop: 2,\n                          }}\n                        >\n                        <View\n                          style={{\n                            position: 'absolute',\n                            left: 0,\n                            right: 0,\n                            borderRadius: 999,\n                            backgroundColor: '#B0B0B0',\n                            height: controlTypeThumbHeight,\n                            top: controlTypeThumbTop,\n                          }}\n                        />\n                      </View>\n                    ) : null}\n                  </View>\n                  <TouchableOpacity\n                    style={{ marginTop: 8, alignSelf: 'center' }}\n                    onPress={() => setShowControlTypeModal(false)}\n                  >\n                    <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n            {/* Modal: skapa ny kontroll för valt projekt via högerklick på projekt i trädet */}\n            <Modal\n              visible={projectControlModal.visible}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => {\n                setProjectControlModal({ visible: false, project: null });\n                setProjectControlSelectedType('');\n                setProjectControlTypePickerOpen(false);\n                setProjectControlSelectedTemplateId('');\n                setProjectControlTemplatePickerOpen(false);\n                setProjectControlTemplateSearch('');\n              }}\n            >\n              <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 4, color: '#222', textAlign: 'center' }}>\n                    Skapa ny kontroll\n                  </Text>\n                  {projectControlModal.project && (\n                    <Text style={{ fontSize: 14, color: '#555', marginBottom: 14, textAlign: 'center' }}>\n                      {projectControlModal.project.id} - {projectControlModal.project.name}\n                    </Text>\n                  )}\n                  <Text style={{ fontSize: 13, color: '#555', marginBottom: 6 }}>Kontrolltyp</Text>\n                  <TouchableOpacity\n                    activeOpacity={0.85}\n                    onPress={() => setProjectControlTypePickerOpen(o => !o)}\n                    style={{\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                      borderRadius: 8,\n                      paddingVertical: 8,\n                      paddingHorizontal: 10,\n                      backgroundColor: '#fff',\n                      marginBottom: 4,\n                    }}\n                  >\n                    <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', flexShrink: 1 }}>\n                        {(() => {\n                          const meta = controlTypeOptions.find(o => o.type === projectControlSelectedType) || null;\n                          if (!meta) return null;\n                          return (\n                            <View\n                              style={{\n                                width: 22,\n                                height: 22,\n                                borderRadius: 6,\n                                backgroundColor: meta.color || '#00897B',\n                                alignItems: 'center',\n                                justifyContent: 'flex-start',\n                                marginRight: 8,\n                              }}\n                            >\n                              <Ionicons name={meta.icon} size={14} color=\"#fff\" />\n                            </View>\n                          );\n                        })()}\n                        <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', flexShrink: 1 }} numberOfLines={1}>\n                          {projectControlSelectedType || 'Välj kontrolltyp'}\n                        </Text>\n                      </View>\n                      <Ionicons\n                        name={projectControlTypePickerOpen ? 'chevron-up' : 'chevron-down'}\n                        size={18}\n                        color=\"#555\"\n                      />\n                    </View>\n                  </TouchableOpacity>\n                  {projectControlTypePickerOpen && controlTypeOptions.length > 0 && (\n                    <View\n                      style={{\n                        marginBottom: 10,\n                        borderWidth: 1,\n                        borderColor: '#ddd',\n                        borderRadius: 8,\n                        backgroundColor: '#fff',\n                        maxHeight: 220,\n                        overflow: 'auto',\n                      }}\n                    >\n                      {controlTypeOptions.map(({ type, icon, color }) => {\n                        const selected = type === projectControlSelectedType;\n                        return (\n                          <TouchableOpacity\n                            key={type}\n                            onPress={() => {\n                              setProjectControlSelectedType(type);\n                              setProjectControlTypePickerOpen(false);\n                            }}\n                            style={{\n                              flexDirection: 'row',\n                              alignItems: 'center',\n                              paddingVertical: 8,\n                              paddingHorizontal: 10,\n                              backgroundColor: selected ? '#E0F2F1' : '#fff',\n                              borderBottomWidth: 1,\n                              borderBottomColor: '#eee',\n                            }}\n                          >\n                            <Ionicons name={icon} size={18} color={color} style={{ marginRight: 10 }} />\n                            <Text style={{ fontSize: 14, color: '#263238' }}>{type}</Text>\n                          </TouchableOpacity>\n                        );\n                      })}\n                    </View>\n                  )}\n                  {Array.isArray(companyProfile?.enabledControlTypes) && controlTypeOptions.length === 0 ? (\n                    <Text style={{ color: '#D32F2F', textAlign: 'center', marginTop: 6, marginBottom: 8 }}>\n                      Inga kontrolltyper är aktiverade för företaget.\n                    </Text>\n                  ) : null}\n                  {/* Mall-val: visas om det finns minst en mall för vald kontrolltyp */}\n                  {(() => {\n                    const ct = String(projectControlSelectedType || '').trim();\n                    const allTemplates = Array.isArray(projectControlTemplates) ? projectControlTemplates : [];\n                    const baseForType = ct\n                      ? allTemplates.filter(t => String(t.controlType || '').trim() === ct)\n                      : [];\n                    // Om ingen mall överhuvudtaget finns för vald kontrolltyp, visa inget mall-fält.\n                    if (!ct || baseForType.length === 0) return null;\n\n                    let filtered = baseForType;\n                    const q = String(projectControlTemplateSearch || '').trim().toLowerCase();\n                    if (q) {\n                      filtered = filtered.filter((t) => {\n                        const title = String(t.title || '').toLowerCase();\n                        const desc = String(t.description || '').toLowerCase();\n                        const v = t.version != null ? String(t.version).toLowerCase() : '';\n                        return title.includes(q) || desc.includes(q) || v.includes(q);\n                      });\n                    }\n                    const selectedTemplate = baseForType.find(t => String(t.id) === String(projectControlSelectedTemplateId)) || null;\n                    const selectedLabel = selectedTemplate?.title || 'Välj mall';\n                    return (\n                      <>\n                        <Text style={{ fontSize: 13, color: '#555', marginBottom: 6, marginTop: 10 }}>Mall</Text>\n                        <TouchableOpacity\n                          activeOpacity={0.85}\n                          onPress={() => setProjectControlTemplatePickerOpen(o => !o)}\n                          style={{\n                            borderWidth: 1,\n                            borderColor: '#ddd',\n                            borderRadius: 8,\n                            paddingVertical: 8,\n                            paddingHorizontal: 10,\n                            backgroundColor: '#fff',\n                            marginBottom: 4,\n                          }}\n                        >\n                          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                            <Text style={{ fontSize: 14, fontWeight: '600', color: '#222', flexShrink: 1 }} numberOfLines={1}>\n                              {selectedLabel}\n                            </Text>\n                            <Ionicons\n                              name={projectControlTemplatePickerOpen ? 'chevron-up' : 'chevron-down'}\n                              size={18}\n                              color=\"#555\"\n                            />\n                          </View>\n                        </TouchableOpacity>\n                        {projectControlTemplatePickerOpen && (\n                          <View\n                            style={{\n                              marginBottom: 10,\n                              borderWidth: 1,\n                              borderColor: '#ddd',\n                              borderRadius: 8,\n                              backgroundColor: '#fff',\n                              maxHeight: 220,\n                              overflow: 'auto',\n                            }}\n                          >\n                            <TextInput\n                              placeholder=\"Sök mall\"\n                              value={projectControlTemplateSearch}\n                              onChangeText={setProjectControlTemplateSearch}\n                              style={{\n                                paddingVertical: 6,\n                                paddingHorizontal: 10,\n                                borderBottomWidth: 1,\n                                borderBottomColor: '#eee',\n                                fontSize: 13,\n                              }}\n                            />\n                            {filtered.length === 0 ? (\n                              <Text\n                                style={{ paddingVertical: 6, paddingHorizontal: 8, fontSize: 12, color: '#78909C' }}\n                              >\n                                Inga mallar hittades för din sökning.\n                              </Text>\n                            ) : filtered.map((tpl) => {\n                              const selected = String(tpl.id) === String(projectControlSelectedTemplateId);\n                              const title = tpl.title || 'Namnlös mall';\n                              const v = tpl.version != null ? String(tpl.version) : '';\n                              const versionLabel = v ? `v${v}` : '';\n                              return (\n                                <TouchableOpacity\n                                  key={tpl.id}\n                                  onPress={() => {\n                                    setProjectControlSelectedTemplateId(String(tpl.id));\n                                    setProjectControlTemplatePickerOpen(false);\n                                  }}\n                                  style={{\n                                    paddingVertical: 5,\n                                    paddingHorizontal: 8,\n                                    backgroundColor: selected ? '#E3F2FD' : '#fff',\n                                    borderBottomWidth: 1,\n                                    borderBottomColor: '#eee',\n                                  }}\n                                >\n                                  <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                                    <Text style={{ fontSize: 13, color: '#263238', flexShrink: 1 }} numberOfLines={1}>\n                                      {title}\n                                    </Text>\n                                    {!!versionLabel && (\n                                      <Text style={{ fontSize: 11, color: '#78909C', marginLeft: 6 }} numberOfLines={1}>\n                                        {versionLabel}\n                                      </Text>\n                                    )}\n                                  </View>\n                                </TouchableOpacity>\n                              );\n                            })}\n                          </View>\n                        )}\n                      </>\n                    );\n                  })()}\n                  <TouchableOpacity\n                    disabled={!projectControlSelectedType}\n                    style={{\n                      marginTop: 6,\n                      marginBottom: 4,\n                      alignSelf: 'stretch',\n                      backgroundColor: projectControlSelectedType ? '#1976D2' : '#B0BEC5',\n                      borderRadius: 10,\n                      paddingVertical: 10,\n                      alignItems: 'center',\n                    }}\n                    onPress={() => {\n                      if (!projectControlSelectedType) return;\n                      const proj = projectControlModal.project;\n                      setProjectControlModal({ visible: false, project: null });\n                      setProjectControlTypePickerOpen(false);\n                      if (proj) {\n                        const ct = projectControlSelectedType;\n                        const tplId = projectControlSelectedTemplateId || null;\n                        openInlineControlEditor(proj, ct, tplId);\n                      }\n                    }}\n                  >\n                    <Text style={{ color: '#fff', fontSize: 16, fontWeight: '600' }}>Skapa kontroll</Text>\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    style={{ marginTop: 8, alignSelf: 'center' }}\n                    onPress={() => {\n                      setProjectControlModal({ visible: false, project: null });\n                      setProjectControlSelectedType('');\n                      setProjectControlTypePickerOpen(false);\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n            {/* Modal för att välja projekt till kontroll */}\n            {/* Select project modal (render component instead of inlining hooks in a callback) */}\n            <SelectProjectModal />\n            {/* Utförda kontroller header removed from main screen; it's shown inside project details only */}\n          </View>\n          {/* Projektträd */}\n          {/* Rubrik och sök-knapp */}\n          <View style={{ width: '100%', alignItems: 'center', marginTop: 18, paddingHorizontal: 16 }}>\n            <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '100%', marginBottom: 12 }} />\n          </View>\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16, paddingHorizontal: 16 }}>\n            <TouchableOpacity\n              activeOpacity={0.7}\n              onPressIn={() => {\n                if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\n                projektLongPressTimer.current = setTimeout(() => {\n                  setNewFolderModalVisible(true);\n                }, 2000);\n              }}\n              onPressOut={() => {\n                if (projektLongPressTimer.current) clearTimeout(projektLongPressTimer.current);\n              }}\n            >\n              <Text style={{ fontSize: 26, fontWeight: '600', color: '#263238', letterSpacing: 0.2, textAlign: 'center' }}>Projekt</Text>\n            </TouchableOpacity>\n            {Platform.OS !== 'web' && (\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                <TouchableOpacity\n                  style={{ padding: 6, borderRadius: 8 }}\n                  onPress={() => {\n                    spinOnce(filterSpinAnim);\n                    setFilterModalVisible(true);\n                  }}\n                  activeOpacity={0.7}\n                >\n                  <View style={{ position: 'relative' }}>\n                    <Animated.View style={{ transform: [{ rotate: filterRotate }] }}>\n                      <Ionicons name=\"filter\" size={22} color=\"#1976D2\" />\n                    </Animated.View>\n                    {projectStatusFilter !== 'all' && (\n                      <View\n                        style={{\n                          position: 'absolute',\n                          right: -1,\n                          top: -1,\n                          width: 10,\n                          height: 10,\n                          borderRadius: 5,\n                          backgroundColor: projectStatusFilter === 'completed' ? '#222' : '#43A047',\n                          borderWidth: 1,\n                          borderColor: '#fff',\n                        }}\n                      />\n                    )}\n                  </View>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  style={{ padding: 6, borderRadius: 8, marginLeft: 10 }}\n                  onPress={() => {\n                    spinOnce(searchSpinAnim);\n                    openSearchModal();\n                  }}\n                  activeOpacity={0.7}\n                >\n                  <Animated.View style={{ transform: [{ rotate: searchRotate }] }}>\n                    <Ionicons name=\"search\" size={22} color=\"#1976D2\" />\n                  </Animated.View>\n                </TouchableOpacity>\n              </View>\n            )}\n          </View>\n          {/* Ny huvudmapp popup modal */}\n          <Modal\n            visible={newFolderModalVisible}\n            transparent\n            animationType=\"fade\"\n            onRequestClose={() => setNewFolderModalVisible(false)}\n          >\n            <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n              <Pressable\n                style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n                onPress={() => setNewFolderModalVisible(false)}\n              />\n              <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Skapa ny huvudmapp</Text>\n                <TextInput\n                  placeholder=\"Namn på huvudmapp...\"\n                  style={{\n                    borderWidth: 1,\n                    borderColor:\n                      newFolderModalVisible && (newSubName.trim() === '' || !isFolderNameUnique(newSubName))\n                        ? '#D32F2F'\n                        : '#e0e0e0',\n                    borderRadius: 8,\n                    padding: 10,\n                    fontSize: 16,\n                    marginBottom: 6\n                  }}\n                  autoFocus\n                  value={newSubName}\n                  onChangeText={setNewSubName}\n                />\n                {(newFolderModalVisible && newSubName.trim() === '') && (\n                  <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\n                    Du måste ange ett namn.\n                  </Text>\n                )}\n                {(newFolderModalVisible && newSubName.trim() !== '' && !isFolderNameUnique(newSubName)) && (\n                  <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\n                    Namnet används redan.\n                  </Text>\n                )}\n                <TouchableOpacity\n                  style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 10, alignItems: 'center', marginBottom: 8 }}\n                  onPress={async () => {\n                    if (newSubName.trim() === '' || !isFolderNameUnique(newSubName)) return;\n                    const newMain = {\n                      id: (Math.random() * 100000).toFixed(0),\n                      name: newSubName.trim(),\n                      expanded: false,\n                      children: [],\n                    };\n                    const newHierarchy = [...hierarchy, newMain];\n                    setHierarchy(newHierarchy);\n                    setNewSubName('');\n                    setNewFolderModalVisible(false);\n                    try {\n                      const ok = await saveHierarchy(companyId, newHierarchy);\n                      if (!ok) {\n                          await AsyncStorage.setItem('hierarchy_local', JSON.stringify(newHierarchy));\n                          setLocalFallbackExists(true);\n                          Alert.alert('Offline', 'Huvudmappen sparades lokalt. Appen kommer försöka synka senare.');\n                        } else {\n                          try { await AsyncStorage.removeItem('hierarchy_local'); } catch(_e) {}\n                          await refreshLocalFallbackFlag();\n                      }\n                    } catch(_e) {\n                      try { await AsyncStorage.setItem('hierarchy_local', JSON.stringify(newHierarchy)); } catch(_e) {}\n                      Alert.alert('Offline', 'Huvudmappen sparades lokalt. Appen kommer försöka synka senare.');\n                    }\n                  }}\n                  disabled={newSubName.trim() === '' || !isFolderNameUnique(newSubName)}\n                >\n                  <Text style={{ color: '#fff', fontWeight: '600', fontSize: 16, opacity: newSubName.trim() === '' || !isFolderNameUnique(newSubName) ? 0.5 : 1 }}>\n                    Skapa\n                  </Text>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 10, alignItems: 'center' }}\n                  onPress={() => {\n                    setNewSubName('');\n                    setNewFolderModalVisible(false);\n                  }}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </Modal>\n          {Platform.OS !== 'web' && (\n            <View style={{ flex: 1, paddingHorizontal: 4 }}>\n              {loadingHierarchy || hierarchy.length === 0 ? (\n                <Text style={{ color: '#888', fontSize: 16, textAlign: 'center', marginTop: 32 }}>\n                  Inga mappar eller projekt skapade ännu.\n                </Text>\n              ) : (\n                <View style={{ paddingHorizontal: 4 }}>\n                  {[...hierarchy]\n                    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                    .map((main) => (\n                      <View key={main.id} style={{ backgroundColor: '#fff', borderRadius: 10, borderWidth: 1, borderColor: '#e0e0e0', marginBottom: 0, paddingVertical: 10, paddingHorizontal: 12, shadowColor: '#1976D2', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.10, shadowRadius: 6, elevation: 2 }}>\n                        <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 0, borderBottomWidth: main.expanded ? 1 : 0, borderColor: '#e0e0e0' }}>\n                          <TouchableOpacity\n                            style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\n                            onPress={() => {\n                              if (!mainChevronSpinAnim[main.id]) {\n                                mainChevronSpinAnim[main.id] = new Animated.Value(0);\n                              }\n                              spinOnce(mainChevronSpinAnim[main.id]);\n                              setHierarchy(prev => prev.map(m => m.id === main.id ? { ...m, expanded: !m.expanded } : { ...m, expanded: false }));\n                            }}\n                            activeOpacity={0.7}\n                            onLongPress={() => setEditModal({ visible: true, type: 'main', id: main.id, name: main.name })}\n                            delayLongPress={2000}\n                            onPressIn={() => {\n                              if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\n                              mainTimersRef.current[main.id] = setTimeout(() => {\n                                setEditModal({ visible: true, type: 'main', id: main.id, name: main.name });\n                              }, 2000);\n                            }}\n                            onPressOut={() => {\n                              if (mainTimersRef.current[main.id]) clearTimeout(mainTimersRef.current[main.id]);\n                            }}\n                          >\n                            <Animated.View\n                              style={mainChevronSpinAnim[main.id]\n                                ? { transform: [{ rotate: mainChevronSpinAnim[main.id].interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] }) }] }\n                                : undefined}\n                            >\n                              <Ionicons name={main.expanded ? 'chevron-down' : 'chevron-forward'} size={22} color=\"#222\" />\n                            </Animated.View>\n                            <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginLeft: 8 }}>{main.name}</Text>\n                          </TouchableOpacity>\n                          {/* Visa endast om ingen undermapp är expanderad */}\n                          {main.expanded && !main.children?.some(sub => sub.expanded) && (\n                            <TouchableOpacity\n                              style={{ marginLeft: 8, padding: 4 }}\n                              onPress={() => {\n                                setNewSubModal({ visible: true, parentId: main.id });\n                                setNewSubName(\"\");\n                              }}\n                            >\n                              <Ionicons name=\"add-circle\" size={22} color=\"#1976D2\" />\n                            </TouchableOpacity>\n                          )}\n                        </View>\n                        {main.expanded && (\n                          !main.children || main.children.length === 0 ? (\n                            <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\n                              Inga undermappar skapade\n                            </Text>\n                          ) : (\n                            [...main.children]\n                              .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                              .map((sub) => {\n                                const allProjects = sub.children ? sub.children.filter(child => child.type === 'project') : [];\n                                const projects = projectStatusFilter === 'all'\n                                  ? allProjects\n                                  : allProjects.filter(p => {\n                                      const status = p?.status || 'ongoing';\n                                      return projectStatusFilter === 'completed' ? status === 'completed' : status !== 'completed';\n                                    });\n                                return (\n                                  <View key={sub.id} style={{ backgroundColor: '#fff', borderRadius: 12, marginVertical: 1, marginLeft: 12, padding: 5 }}>\n                                    <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 4 }}>\n                                      <TouchableOpacity\n                                        style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}\n                                        onPress={() => {\n                                          if (!subChevronSpinAnim[sub.id]) {\n                                            subChevronSpinAnim[sub.id] = new Animated.Value(0);\n                                          }\n                                          spinOnce(subChevronSpinAnim[sub.id]);\n                                          setHierarchy(toggleExpand(1, sub.id));\n                                        }}\n                                        onLongPress={() => setEditModal({ visible: true, type: 'sub', id: sub.id, name: sub.name })}\n                                        delayLongPress={2000}\n                                        activeOpacity={0.7}\n                                      >\n                                        <Animated.View\n                                          style={subChevronSpinAnim[sub.id]\n                                            ? { transform: [{ rotate: subChevronSpinAnim[sub.id].interpolate({ inputRange: [0, 1], outputRange: ['0deg', '360deg'] }) }] }\n                                            : undefined}\n                                        >\n                                          <Ionicons name={sub.expanded ? 'chevron-down' : 'chevron-forward'} size={18} color=\"#222\" />\n                                        </Animated.View>\n                                        <Text style={{ fontSize: 15, fontWeight: '600', color: '#222', marginLeft: 8 }}>{sub.name}</Text>\n                                      </TouchableOpacity>\n                                      {sub.expanded && (\n                                        <TouchableOpacity\n                                          style={{ padding: 4 }}\n                                          onPress={() => {\n                                            setNewProjectModal({ visible: true, parentSubId: sub.id });\n                                            setNewProjectName(\"\");\n                                            setNewProjectNumber(\"\");\n                                          }}\n                                        >\n                                          <Ionicons name=\"add-circle\" size={22} color=\"#1976D2\" />\n                                        </TouchableOpacity>\n                                      )}\n                                    </View>\n                                    {sub.expanded && (\n                                      <React.Fragment>\n                                        {projects.length === 0 ? (\n                                          <Text style={{ color: '#D32F2F', fontSize: 14, marginLeft: 18, marginTop: 8 }}>\n                                            {allProjects.length === 0 ? 'Inga projekt skapade' : 'Inga projekt matchar filtret'}\n                                          </Text>\n                                        ) : (\n                                          projects\n                                            .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }))\n                                            .map((proj) => (\n                                              <TouchableOpacity\n                                                key={proj.id}\n                                                style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 3, marginLeft: 14, backgroundColor: '#fff', borderRadius: 8, marginVertical: 2, paddingHorizontal: 6 }}\n                                                onPress={() => {\n                                                  if (Platform.OS === 'web') {\n                                                    setSelectedProject({ ...proj });\n                                                  } else {\n                                                    navigation.navigate('ProjectDetails', {\n                                                      project: {\n                                                        id: proj.id,\n                                                        name: proj.name,\n                                                        ansvarig: proj.ansvarig || '',\n                                                        adress: proj.adress || '',\n                                                        fastighetsbeteckning: proj.fastighetsbeteckning || '',\n                                                        client: proj.client || '',\n                                                        status: proj.status || 'ongoing',\n                                                        createdAt: proj.createdAt || '',\n                                                        createdBy: proj.createdBy || ''\n                                                      },\n                                                      companyId\n                                                    });\n                                                  }\n                                                }}\n                                              >\n                                                <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: proj.status === 'completed' ? '#222' : '#43A047', marginRight: 8, borderWidth: 1, borderColor: '#bbb' }} />\n                                                <Text style={{ fontSize: 15, color: '#1976D2', marginLeft: 4, marginRight: 8, flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{proj.id} — {proj.name}</Text>\n                                              </TouchableOpacity>\n                                            ))\n                                        )}\n                                      </React.Fragment>\n                                    )}\n                                  </View>\n                                );\n                              })\n                          )\n                        )}\n                      </View>\n                    ))}\n                </View>\n              )}\n            </View>\n          )}\n                  {/* Ny huvudmapp popup modal */}\n                  {/* Ny undermapp popup modal */}\n      {/* Ny undermapp popup modal */}\n      <Modal\n        visible={newSubModal.visible}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={() => setNewSubModal({ visible: false, parentId: null })}\n      >\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <Pressable\n            style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}\n            onPress={() => setNewSubModal({ visible: false, parentId: null })}\n          />\n          <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Skapa ny undermapp</Text>\n            <TextInput\n              value={newSubName}\n              onChangeText={setNewSubName}\n              placeholder=\"Namn på undermapp...\"\n              style={{\n                borderWidth: 1,\n                borderColor:\n                  newSubModal.visible && (newSubName.trim() === '' || (() => {\n                    // Check for duplicate name in selected main folder\n                    const parent = hierarchy.find(main => main.id === newSubModal.parentId);\n                    if (!parent) return false;\n                    return parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase());\n                  })())\n                    ? '#D32F2F'\n                    : '#e0e0e0',\n                borderRadius: 8,\n                padding: 10,\n                fontSize: 16,\n                marginBottom: 6\n              }}\n              autoFocus\n            />\n            {(newSubModal.visible && newSubName.trim() === '') && (\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\n                Du måste ange ett namn.\n              </Text>\n            )}\n            {(newSubModal.visible && newSubName.trim() !== '' && (() => {\n              const parent = hierarchy.find(main => main.id === newSubModal.parentId);\n              if (!parent) return false;\n              return parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase());\n            })()) && (\n              <Text style={{ color: '#D32F2F', fontSize: 13, marginBottom: 6, textAlign: 'center' }}>\n                Namnet används redan.\n              </Text>\n            )}\n            {(() => {\n              const parent = hierarchy.find(main => main.id === newSubModal.parentId);\n              const isDuplicate = parent ? parent.children.some(sub => sub.name.trim().toLowerCase() === newSubName.trim().toLowerCase()) : false;\n              const isDisabled = newSubName.trim() === '' || isDuplicate;\n              const opacity = isDisabled ? 0.5 : 1;\n              return (\n                <TouchableOpacity\n                  style={{ backgroundColor: '#1976D2', borderRadius: 8, paddingVertical: 10, alignItems: 'center', marginBottom: 8, opacity }}\n                  onPress={() => {\n                    if (!isDisabled) {\n                      setHierarchy(prev => prev.map(main => {\n                        if (main.id === newSubModal.parentId) {\n                          return {\n                            ...main,\n                            children: [\n                              ...(main.children || []),\n                              {\n                                id: (Math.random() * 100000).toFixed(0),\n                                name: newSubName.trim(),\n                                expanded: false,\n                                children: [],\n                              },\n                            ],\n                          };\n                        }\n                        return main;\n                      }));\n                      setNewSubName('');\n                      setNewSubModal({ visible: false, parentId: null });\n                    }\n                   }}\n                  disabled={isDisabled}\n                >\n                  <Text style={{ color: '#fff', fontWeight: '600', fontSize: 16 }}>\n                    Skapa\n                  </Text>\n                </TouchableOpacity>\n              );\n            })()}\n            <TouchableOpacity\n              style={{ backgroundColor: '#e0e0e0', borderRadius: 8, paddingVertical: 10, alignItems: 'center' }}\n              onPress={() => {\n                setNewSubName('');\n                setNewSubModal({ visible: false, parentId: null });\n              }}\n            >\n              <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n      </ScrollView>\n          </RootContainer>\n        );\n      })()}\n    </View>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/LoginScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":57,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DEV_BYPASS'. Either include it or remove the dependency array.","line":81,"column":6,"nodeType":"ArrayExpression","endLine":81,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [navigation, autoHandled, DEV_BYPASS]","fix":{"range":[3113,3138],"text":"[navigation, autoHandled, DEV_BYPASS]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":91,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":51},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":92,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":98,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":98,"endColumn":84},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkCompanyAccessForUser'. Either include it or remove the dependency array.","line":111,"column":6,"nodeType":"ArrayExpression","endLine":111,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [navigation, autoHandled, checkCompanyAccessForUser]","fix":{"range":[4271,4296],"text":"[navigation, autoHandled, checkCompanyAccessForUser]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":129,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":129,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":141,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":141,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":142,"column":71,"nodeType":"Identifier","messageId":"unusedVar","endLine":142,"endColumn":72},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":151,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":151,"endColumn":80},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":181,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":181,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useNavigation } from '@react-navigation/native';\nimport { useEffect, useRef, useState } from 'react';\nimport { Image, ImageBackground, Keyboard, KeyboardAvoidingView, Platform, StyleSheet, Text, TextInput, TouchableOpacity, TouchableWithoutFeedback, View } from 'react-native';\nimport { auth, fetchCompanyProfile, fetchUserProfile, signInEmailPassword } from '../components/firebase';\n\nexport default function LoginScreen() {\n  const navigation = useNavigation();\n  // Toggle this to `true` only for fast local development. Leave `false` for real login flow.\n  const DEV_BYPASS = false;\n  const [email, setEmail] = useState('');\n  const [password, setPassword] = useState('');\n  const [error, setError] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  const [autoHandled, setAutoHandled] = useState(false);\n  const isEmailValid = (val) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(val);\n  const isFormValid = isEmailValid(email.trim()) && password.length > 0;\n  const emailRef = useRef(null);\n  const passwordRef = useRef(null);\n  const [rememberMe, setRememberMe] = useState(false);\n\n  const isCompanyEnabled = (profile) => {\n    if (!profile) return true;\n    if (profile.deleted) return false;\n    if (typeof profile.enabled === 'boolean') return profile.enabled;\n    if (typeof profile.active === 'boolean') return profile.active;\n    return true;\n  };\n\n  const checkCompanyAccessForUser = async (user) => {\n    try {\n      if (!user) return { allowed: false, companyId: null };\n      const profile = await fetchUserProfile(user.uid).catch(() => null);\n      const companyId = profile?.companyId || null;\n      if (!companyId) return { allowed: true, companyId: null };\n      const companyProfile = await fetchCompanyProfile(companyId).catch(() => null);\n      const enabled = isCompanyEnabled(companyProfile || {});\n      return { allowed: !!enabled, companyId };\n    } catch (e) {\n      // Vid fel, tillåt inloggning men logga till konsol\n      console.log('[Login] checkCompanyAccessForUser error', e?.message || e);\n      return { allowed: true, companyId: null };\n    }\n  };\n\n  // Load saved email if user previously chose to be remembered\n  useEffect(() => {\n    (async () => {\n      try {\n        const saved = await AsyncStorage.getItem('dk_saved_email');\n        if (saved) {\n          setEmail(saved);\n          setRememberMe(true);\n        }\n      } catch(e) {}\n    })();\n  }, []);\n\n  // Dev-only: bypass login to speed up testing\n  useEffect(() => {\n    if (DEV_BYPASS && __DEV__ && !autoHandled) {\n      (async () => {\n        try {\n          const storedCompanyId = await AsyncStorage.getItem('dk_companyId');\n          navigation.reset({\n            index: 0,\n            routes: [\n              {\n                name: 'Home',\n                params: { email: 'dev@test.local', companyId: storedCompanyId || null }\n              }\n            ]\n          });\n        } finally {\n          setAutoHandled(true);\n        }\n      })();\n    }\n  }, [navigation, autoHandled]);\n\n  // Auto-redirect if already signed in\n  useEffect(() => {\n    const unsub = auth.onAuthStateChanged(async (user) => {\n      if (user && !autoHandled) {\n        const t0 = Date.now();\n        try {\n          const { allowed, companyId } = await checkCompanyAccessForUser(user);\n          if (!allowed) {\n            try { await auth.signOut(); } catch (e) {}\n            try { await AsyncStorage.removeItem('dk_companyId'); } catch (e) {}\n            setError('Företaget är pausat. Kontakta administratören.');\n            return;\n          }\n          const params = { email: user.email || '' };\n          if (companyId) {\n            try { await AsyncStorage.setItem('dk_companyId', companyId); } catch (e) {}\n            params.companyId = companyId;\n          }\n          navigation.reset({ index: 0, routes: [ { name: 'Home', params } ] });\n          console.log('[Login] Auto redirect total ms:', Date.now() - t0);\n        } catch(e) {\n          console.log('[Login] Auto redirect error', e?.code || e?.message);\n        } finally {\n          setAutoHandled(true);\n        }\n      }\n    });\n    return () => unsub();\n  }, [navigation, autoHandled]);\n\n  const handleLogin = async () => {\n    const t0 = Date.now();\n    try {\n      setLoading(true);\n      const cred = await signInEmailPassword(email.trim(), password);\n      console.log('[Login] Auth ms:', Date.now() - t0);\n      setError('');\n      // Förhindra dubbelnavigering från onAuthStateChanged tills vi har hanterat företagsstatus\n      setAutoHandled(true);\n      // Persist remembered email preference\n      try {\n        if (rememberMe) {\n          await AsyncStorage.setItem('dk_saved_email', email.trim());\n        } else {\n          await AsyncStorage.removeItem('dk_saved_email');\n        }\n      } catch(e) {}\n\n      // Refresh ID token to pick up any custom claims, then fetch and update companyId\n      try {\n        if (cred && cred.user) {\n          await auth.currentUser.getIdToken(true);\n        }\n      } catch(e) {\n        console.log('[Login] Token refresh failed', e?.message || e);\n      }\n      const { allowed, companyId } = await checkCompanyAccessForUser(cred.user);\n      if (!allowed) {\n        try { await auth.signOut(); } catch (e) {}\n        try { await AsyncStorage.removeItem('dk_companyId'); } catch (e) {}\n        setError('Företaget är pausat. Kontakta administratören.');\n        // Tillåt auto-redirect att köras igen om användaren loggar in på annat företag\n        setAutoHandled(false);\n        return;\n      }\n\n      const params = { email };\n      if (companyId) {\n        try { await AsyncStorage.setItem('dk_companyId', companyId); } catch (e) {}\n        params.companyId = companyId;\n      }\n      navigation.reset({ index: 0, routes: [ { name: 'Home', params } ] });\n      console.log('[Login] Profile+company check ms:', Date.now() - t0);\n    } catch(e) {\n      let message = 'Fel e-post eller lösenord';\n      if (e?.code) {\n        switch (e.code) {\n          case 'auth/invalid-email':\n            message = 'Ogiltig e-postadress';\n            break;\n          case 'auth/user-not-found':\n            message = 'Användaren hittades inte';\n            break;\n          case 'auth/wrong-password':\n            message = 'Fel lösenord';\n            break;\n          case 'auth/too-many-requests':\n            message = 'För många försök, försök igen senare';\n            break;\n          case 'auth/network-request-failed':\n            message = 'Nätverksfel, kontrollera uppkopplingen';\n            break;\n          default:\n            message = 'Kunde inte logga in. Försök igen.';\n        }\n      }\n      setError(message);\n      // focus email field when login fails\n      try { emailRef.current?.focus(); } catch(e) {}\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // On web, TouchableWithoutFeedback can interfere with input focus — use a plain View wrapper there.\n  const isWeb = Platform.OS === 'web';\n  if (isWeb) {\n    return (\n      <View style={{ flex: 1 }}>\n        <KeyboardAvoidingView style={styles.container} behavior={Platform.OS === 'ios' ? 'padding' : 'height'}>\n            <ImageBackground\n            source={require('../assets/images/inlogg.webb.png')}\n            style={styles.bg}\n            imageStyle={styles.bgImageWeb}\n              resizeMode=\"cover\"\n          >\n          <View style={styles.overlayWeb} />\n          <View style={styles.contentWrapper}>\n            <Image\n              source={require('../assets/images/digitalkontroll.lang.transparant.jpg')}\n              style={styles.logo}\n              resizeMode=\"contain\"\n            />\n            \n\n            {error ? (\n              <View style={styles.errorBox}>\n                <Text style={styles.errorText}>{error}</Text>\n              </View>\n            ) : null}\n\n            <View style={styles.inputContainer}>\n              <Text style={styles.label}>E-postadress</Text>\n              <TextInput\n                style={styles.input}\n                placeholder=\"Fyll i e-postadress\"\n                placeholderTextColor=\"#888\"\n                keyboardType=\"email-address\"\n                autoCapitalize=\"none\"\n                value={email}\n                onChangeText={setEmail}\n                ref={emailRef}\n                returnKeyType=\"next\"\n                onSubmitEditing={() => passwordRef.current?.focus()}\n              />\n              {!isEmailValid(email.trim()) && email.length > 0 ? (\n                <Text style={styles.hint}>Ogiltig e‑postadress</Text>\n              ) : null}\n            </View>\n\n            <View style={styles.inputContainer}>\n              <Text style={styles.label}>Lösenord</Text>\n              <TextInput\n                style={styles.input}\n                placeholder=\"Fyll i lösenord\"\n                placeholderTextColor=\"#888\"\n                secureTextEntry={!showPassword}\n                value={password}\n                onChangeText={setPassword}\n                autoCapitalize=\"none\"\n                ref={passwordRef}\n                returnKeyType=\"go\"\n                onSubmitEditing={() => { if (!loading && isFormValid) handleLogin(); }}\n              />\n              <TouchableOpacity onPress={() => setShowPassword((v) => !v)}>\n                <Text style={styles.toggleText}>{showPassword ? 'Dölj lösenord' : 'Visa lösenord'}</Text>\n              </TouchableOpacity>\n              {password.length === 0 && error ? (\n                <Text style={styles.hint}>Fyll i ditt lösenord</Text>\n              ) : null}\n            </View>\n\n            <TouchableOpacity onPress={() => setRememberMe(v => !v)} style={styles.rememberRow}>\n              <View style={styles.rememberBox}>\n                {rememberMe ? <View style={styles.rememberFill} /> : null}\n              </View>\n              <Text style={styles.rememberText}>Kom ihåg mig</Text>\n            </TouchableOpacity>\n\n            <TouchableOpacity style={[styles.button, (loading || !isFormValid) && styles.buttonDisabled]} onPress={loading || !isFormValid ? undefined : handleLogin} disabled={loading || !isFormValid}>\n              <Text style={styles.buttonText}>{loading ? 'Loggar in…' : 'LOGGA IN'}</Text>\n            </TouchableOpacity>\n\n          {/* Konto skapas av administratör – ingen självregistrering */}\n          </View>\n          </ImageBackground>\n        </KeyboardAvoidingView>\n      </View>\n    );\n  }\n\n  return (\n    <TouchableWithoutFeedback onPress={Keyboard.dismiss} accessible={false}>\n    <KeyboardAvoidingView style={styles.container} behavior={Platform.OS === 'ios' ? 'padding' : 'height'}>\n      <ImageBackground\n        source={require('../assets/images/inlogg.app.png')}\n        style={styles.bg}\n        imageStyle={styles.bgImage}\n        resizeMode=\"cover\"\n      >\n      <View style={styles.overlay} />\n      <View style={[styles.contentWrapper, { justifyContent: 'flex-start', paddingTop: 12, paddingBottom: 24 }]}>\n        <Image\n          source={require('../assets/images/digitalkontroll.lang.transparant.jpg')}\n          style={styles.logo}\n          resizeMode=\"contain\"\n        />\n        \n\n        {error ? (\n          <View style={styles.errorBox}>\n            <Text style={styles.errorText}>{error}</Text>\n          </View>\n        ) : null}\n\n        <View style={styles.inputContainer}>\n          <Text style={styles.label}>E-postadress</Text>\n          <TextInput\n            style={styles.input}\n            placeholder=\"Fyll i e-postadress\"\n            placeholderTextColor=\"#888\"\n            keyboardType=\"email-address\"\n            autoCapitalize=\"none\"\n            value={email}\n            onChangeText={setEmail}\n            ref={emailRef}\n            returnKeyType=\"next\"\n            onSubmitEditing={() => passwordRef.current?.focus()}\n          />\n          {!isEmailValid(email.trim()) && email.length > 0 ? (\n            <Text style={styles.hint}>Ogiltig e‑postadress</Text>\n          ) : null}\n        </View>\n\n        <View style={styles.inputContainer}>\n          <Text style={styles.label}>Lösenord</Text>\n          <TextInput\n            style={styles.input}\n            placeholder=\"Fyll i lösenord\"\n            placeholderTextColor=\"#888\"\n            secureTextEntry={!showPassword}\n            value={password}\n            onChangeText={setPassword}\n            autoCapitalize=\"none\"\n            ref={passwordRef}\n            returnKeyType=\"go\"\n            onSubmitEditing={() => { if (!loading && isFormValid) handleLogin(); }}\n          />\n          <TouchableOpacity onPress={() => setShowPassword((v) => !v)}>\n            <Text style={styles.toggleText}>{showPassword ? 'Dölj lösenord' : 'Visa lösenord'}</Text>\n          </TouchableOpacity>\n          {password.length === 0 && error ? (\n            <Text style={styles.hint}>Fyll i ditt lösenord</Text>\n          ) : null}\n        </View>\n\n        <TouchableOpacity onPress={() => setRememberMe(v => !v)} style={styles.rememberRow}>\n          <View style={styles.rememberBox}>\n            {rememberMe ? <View style={styles.rememberFill} /> : null}\n          </View>\n          <Text style={styles.rememberText}>Kom ihåg mig</Text>\n        </TouchableOpacity>\n\n        <TouchableOpacity style={[styles.button, (loading || !isFormValid) && styles.buttonDisabled]} onPress={loading || !isFormValid ? undefined : handleLogin} disabled={loading || !isFormValid}>\n          <Text style={styles.buttonText}>{loading ? 'Loggar in…' : 'LOGGA IN'}</Text>\n        </TouchableOpacity>\n\n      {/* Konto skapas av administratör – ingen självregistrering */}\n      </View>\n      </ImageBackground>\n    </KeyboardAvoidingView>\n    </TouchableWithoutFeedback>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: 'transparent',\n    paddingHorizontal: 0,\n  },\n  bg: {\n    flex: 1,\n    width: '100%',\n    height: '100%',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingHorizontal: 0,\n    paddingVertical: 0,\n  },\n  bgImage: {\n    width: '100%',\n    height: '100%',\n    backgroundColor: 'transparent',\n  },\n  bgImageWeb: {\n    width: '100%',\n    height: '100%'\n  },\n  overlayWeb: {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    right: 0,\n    bottom: 0,\n    backgroundColor: 'rgba(255,255,255,0.28)'\n  },\n  overlay: {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    right: 0,\n    bottom: 0,\n    backgroundColor: 'rgba(255,255,255,0.25)',\n  },\n  contentWrapper: {\n    width: '100%',\n    maxWidth: 420,\n    paddingHorizontal: 20,\n    paddingVertical: 20,\n    paddingTop: 24,\n    marginTop: 0,\n    alignItems: 'center',\n  },\n  title: {\n    fontSize: 28,\n    fontWeight: 'bold',\n    marginBottom: 10,\n    textAlign: 'center',\n    marginTop: 8,\n  },\n  inputContainer: {\n    width: '100%',\n    maxWidth: 350,\n    marginTop: 12,\n    marginBottom: 16,\n  },\n  label: {\n    fontSize: 16,\n    color: '#111',\n    fontWeight: 'bold',\n    marginBottom: 4,\n    marginLeft: 4,\n    alignSelf: 'flex-start',\n    paddingHorizontal: 10,\n    paddingVertical: 6,\n    borderRadius: 10,\n    backgroundColor: 'rgba(255,255,255,0.85)',\n  },\n  input: {\n    width: '100%',\n    maxWidth: 350,\n    height: 48,\n    borderColor: '#ccc',\n    borderWidth: 1,\n    borderRadius: 8,\n    paddingHorizontal: 12,\n    fontSize: 16,\n    backgroundColor: '#fff',\n    color: '#000',\n  },\n  toggleText: {\n    marginTop: 6,\n    marginLeft: 4,\n    color: '#263238',\n    fontSize: 14,\n    fontWeight: '600',\n    alignSelf: 'flex-start',\n    paddingHorizontal: 10,\n    paddingVertical: 6,\n    borderRadius: 10,\n    backgroundColor: 'rgba(255,255,255,0.85)',\n  },\n  logo: {\n    width: 200,\n    height: 90,\n    marginTop: 0,\n    marginBottom: 12,\n  },\n  slogan: {\n    fontSize: 16,\n    color: '#111',\n    textAlign: 'center',\n    marginBottom: 12,\n    marginTop: 8,\n    opacity: 0.9,\n    fontWeight: '600',\n  },\n  errorBox: {\n    width: '100%',\n    maxWidth: 350,\n    backgroundColor: '#fdecea',\n    borderLeftWidth: 4,\n    borderLeftColor: '#d32f2f',\n    padding: 10,\n    borderRadius: 6,\n    marginBottom: 12,\n  },\n  errorText: {\n    color: '#b71c1c',\n    fontSize: 14,\n  },\n  button: {\n    width: '100%',\n    maxWidth: 350,\n    height: 48,\n    backgroundColor: '#263238',\n    borderRadius: 8,\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginBottom: 12,\n  },\n  buttonDisabled: {\n    opacity: 0.6,\n  },\n  buttonText: {\n    color: '#fff',\n    fontSize: 18,\n    fontWeight: 'bold',\n  },\n  hint: {\n    marginTop: 6,\n    marginLeft: 4,\n    color: '#d32f2f',\n    fontSize: 13,\n  },\n  rememberRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginTop: 8,\n    marginBottom: 8,\n    paddingHorizontal: 10,\n    paddingVertical: 8,\n    borderRadius: 10,\n    backgroundColor: 'rgba(255,255,255,0.85)',\n  },\n  rememberBox: {\n    width: 20,\n    height: 20,\n    borderWidth: 1,\n    borderColor: '#222',\n    marginRight: 8,\n    alignItems: 'center',\n    justifyContent: 'center',\n    backgroundColor: '#fff',\n  },\n  rememberFill: {\n    width: 12,\n    height: 12,\n    backgroundColor: '#1976D2',\n  },\n  rememberText: {\n    color: '#222',\n    fontWeight: '600',\n  },\n  link: {\n    color: '#263238',\n    fontSize: 16,\n    marginTop: 8,\n  },\n});\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ManageCompany.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'orgNumber' is assigned a value but never used.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"orgNumber"},"fix":{"range":[1054,1063],"text":""},"desc":"Remove unused variable 'orgNumber'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'companyForm' is assigned a value but never used.","line":17,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"companyForm"},"fix":{"range":[1104,1115],"text":""},"desc":"Remove unused variable 'companyForm'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'streetAddress' is assigned a value but never used.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"streetAddress"},"fix":{"range":[1158,1171],"text":""},"desc":"Remove unused variable 'streetAddress'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'postalCode' is assigned a value but never used.","line":19,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"postalCode"},"fix":{"range":[1216,1226],"text":""},"desc":"Remove unused variable 'postalCode'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'city' is assigned a value but never used.","line":20,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"city"},"fix":{"range":[1268,1272],"text":""},"desc":"Remove unused variable 'city'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'country' is assigned a value but never used.","line":21,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"country"},"fix":{"range":[1308,1315],"text":""},"desc":"Remove unused variable 'country'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'contactName' is assigned a value but never used.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"contactName"},"fix":{"range":[1355,1366],"text":""},"desc":"Remove unused variable 'contactName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'contactEmail' is assigned a value but never used.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"contactEmail"},"fix":{"range":[1409,1421],"text":""},"desc":"Remove unused variable 'contactEmail'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'contactPhone' is assigned a value but never used.","line":25,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"contactPhone"},"fix":{"range":[1465,1477],"text":""},"desc":"Remove unused variable 'contactPhone'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'billingAddress' is assigned a value but never used.","line":27,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"billingAddress"},"fix":{"range":[1522,1536],"text":""},"desc":"Remove unused variable 'billingAddress'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'billingReference' is assigned a value but never used.","line":28,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"billingReference"},"fix":{"range":[1582,1598],"text":""},"desc":"Remove unused variable 'billingReference'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'paymentTerms' is assigned a value but never used.","line":29,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"paymentTerms"},"fix":{"range":[1646,1658],"text":""},"desc":"Remove unused variable 'paymentTerms'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'invoiceMethod' is assigned a value but never used.","line":30,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"invoiceMethod"},"fix":{"range":[1704,1717],"text":""},"desc":"Remove unused variable 'invoiceMethod'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'navigation'. Either include it or remove the dependency array.","line":56,"column":6,"nodeType":"ArrayExpression","endLine":56,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [navigation]","fix":{"range":[2652,2654],"text":"[navigation]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'loggingOut' is assigned a value but never used.","line":62,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"loggingOut"},"fix":{"range":[2934,2944],"text":""},"desc":"Remove unused variable 'loggingOut'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'dashboardSectionTitleStyle' is assigned a value but never used.","line":226,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":226,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"dashboardSectionTitleStyle"},"fix":{"range":[9600,9704],"text":""},"desc":"Remove unused variable 'dashboardSectionTitleStyle'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":296,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":296,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":352,"column":91,"nodeType":"Identifier","messageId":"unusedVar","endLine":352,"endColumn":92}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { getDownloadURL, ref as storageRef, uploadBytes } from 'firebase/storage';\nimport { useEffect, useRef, useState } from 'react';\nimport { Alert, ImageBackground, KeyboardAvoidingView, Platform, ScrollView, Text, TextInput, TouchableOpacity, View } from 'react-native';\nimport { auth, fetchAdminAuditForCompany, fetchCompanyProfile, resolveCompanyLogoUrl, saveCompanyProfile, storage } from '../components/firebase';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo } from '../components/HeaderComponents';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenuConditional from '../components/HeaderUserMenuConditional';\nimport MainLayout from '../components/MainLayout';\n\nexport default function ManageCompany({ navigation }) {\n  const [companyId, setCompanyId] = useState('');\n  const [companyName, setCompanyName] = useState('');\n  const [userLimit, setUserLimit] = useState('10');\n  const [orgNumber, setOrgNumber] = useState('');\n  const [companyForm, setCompanyForm] = useState('');\n  const [streetAddress, setStreetAddress] = useState('');\n  const [postalCode, setPostalCode] = useState('');\n  const [city, setCity] = useState('');\n  const [country, setCountry] = useState('');\n\n  const [contactName, setContactName] = useState('');\n  const [contactEmail, setContactEmail] = useState('');\n  const [contactPhone, setContactPhone] = useState('');\n\n  const [billingAddress, setBillingAddress] = useState('');\n  const [billingReference, setBillingReference] = useState('');\n  const [paymentTerms, setPaymentTerms] = useState('30');\n  const [invoiceMethod, setInvoiceMethod] = useState('email');\n  const [loading, setLoading] = useState(false);\n  const [logoUrl, setLogoUrl] = useState('');\n  const [logoUploading, setLogoUploading] = useState(false);\n  const [auditEvents, setAuditEvents] = useState([]);\n  const [auditLoading, setAuditLoading] = useState(false);\n  const fileInputRef = useRef(null);\n\n  useEffect(() => {\n    // Keep header consistent with project views (search + logos)\n    try {\n      navigation.setOptions({\n        headerTitle: () => null,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } catch (_e) {}\n  }, []);\n\n  // Decide if interactive tools (manage company/users) should be shown\n  const [allowedTools, setAllowedTools] = useState(false);\n  const [showHeaderUserMenu, setShowHeaderUserMenu] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  const [loggingOut, setLoggingOut] = useState(false);\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    let mounted = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        const isEmailSuperadmin = email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.com' || email === 'marcus.skogh@msbyggsystem';\n        if (email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se') {\n          if (mounted) {\n            setAllowedTools(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(false).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const isAdminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        const isSuperClaim = !!(claims && (claims.superadmin === true || claims.role === 'superadmin'));\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const companyId = companyFromClaims || stored || '';\n        const allowHeader = isEmailSuperadmin || isSuperClaim || isAdminClaim;\n        if (companyId === 'MS Byggsystem' && isAdminClaim) {\n          if (mounted) setAllowedTools(true);\n        }\n        if (mounted) setShowHeaderUserMenu(!!allowHeader);\n        return;\n      } catch(_e) {}\n      if (mounted) {\n        setAllowedTools(false);\n        setShowHeaderUserMenu(false);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  // Lyssna på global \"hem\"-händelse från ProjectSidebar (webb)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = () => {\n      try {\n        navigation.reset({ index: 0, routes: [{ name: 'Home' }] });\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkGoHome', handler);\n    return () => {\n      try { window.removeEventListener('dkGoHome', handler); } catch (_e) {}\n    };\n  }, [navigation]);\n\n  const handleSave = async () => {\n    if (!companyId) return Alert.alert('Fel', 'Ange ett företags-ID');\n    const limitNum = parseInt(String(userLimit || '0'), 10) || 0;\n    setLoading(true);\n    try {\n      const trimmedId = String(companyId).trim();\n      const trimmedName = String(companyName || '').trim();\n      const ok = await saveCompanyProfile(trimmedId, { companyName: trimmedName, userLimit: limitNum });\n      if (ok) {\n        Alert.alert('Sparat', 'Företagsprofil uppdaterad.');\n        // Inform sidebar (web) so it can refresh the visible company profile immediately\n        try {\n          if (Platform.OS === 'web' && typeof window !== 'undefined') {\n            window.dispatchEvent(new CustomEvent('dkCompanyProfileUpdated', {\n              detail: {\n                companyId: trimmedId,\n                profile: { companyName: trimmedName, userLimit: limitNum, logoUrl: logoUrl || undefined },\n              },\n            }));\n          }\n        } catch (_e) {}\n        // Läs tillbaka profilen från Firestore så formuläret visar faktiskt sparat värde\n        try {\n          const latest = await fetchCompanyProfile(trimmedId);\n          if (latest) {\n            setCompanyId(trimmedId);\n            setCompanyName(latest.companyName || trimmedName);\n            setUserLimit(typeof latest.userLimit !== 'undefined' && latest.userLimit !== null ? String(latest.userLimit) : String(limitNum));\n            setLogoUrl(latest.logoUrl || '');\n          } else {\n            setCompanyId(trimmedId);\n            setCompanyName(trimmedName);\n            setUserLimit(String(limitNum));\n          }\n        } catch (_e) {\n          setCompanyId(trimmedId);\n          setCompanyName(trimmedName);\n          setUserLimit(String(limitNum));\n        }\n      } else {\n        Alert.alert('Fel', 'Kunde inte spara företagsprofil.');\n      }\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    } finally { setLoading(false); }\n  };\n\n  const handleLogoFileChange = async (event) => {\n    try {\n      if (!companyId) {\n        Alert.alert('Fel', 'Välj först ett företag i listan till vänster.');\n        return;\n      }\n      const file = event?.target?.files && event.target.files[0] ? event.target.files[0] : null;\n      if (!file) return;\n      // Visa en direktförhandsvisning på webben medan uppladdning pågår\n      try {\n        if (Platform.OS === 'web' && typeof URL !== 'undefined' && URL.createObjectURL) {\n          const localPreview = URL.createObjectURL(file);\n          if (localPreview) {\n            setLogoUrl(localPreview);\n          }\n        }\n      } catch (_e) {}\n      setLogoUploading(true);\n      const safeCompanyId = String(companyId).trim();\n      const path = `company-logos/${encodeURIComponent(safeCompanyId)}/${Date.now()}_${file.name}`;\n      const ref = storageRef(storage, path);\n      await uploadBytes(ref, file);\n      const url = await getDownloadURL(ref);\n      const ok = await saveCompanyProfile(safeCompanyId, { logoUrl: url });\n      if (!ok) {\n        throw new Error('Kunde inte spara företagsprofil (logoUrl).');\n      }\n      // Försök alltid använda samma logik som i headern (hanterar gs://-URL:er)\n      try {\n        const resolved = await resolveCompanyLogoUrl(safeCompanyId);\n        setLogoUrl((resolved || url || '').trim());\n      } catch (_e) {\n        setLogoUrl(url || '');\n      }\n      // Inform sidebar / other views about updated profile\n      try {\n        if (Platform.OS === 'web' && typeof window !== 'undefined') {\n          window.dispatchEvent(new CustomEvent('dkCompanyProfileUpdated', {\n            detail: {\n              companyId: safeCompanyId,\n              profile: { logoUrl: url },\n            },\n          }));\n        }\n      } catch (_e) {}\n      Alert.alert('Logga uppdaterad', 'Företagsloggan har sparats.');\n    } catch (e) {\n      Alert.alert('Fel', 'Kunde inte ladda upp loggan: ' + String(e?.message || e));\n    } finally {\n      setLogoUploading(false);\n      try {\n        if (event?.target) {\n          event.target.value = '';\n        }\n      } catch (_e) {}\n    }\n  };\n\n  // Web: render inside the central dashboard area so layout and background remain consistent\n  if (Platform.OS === 'web') {\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\n    const dashboardColumnsStyle = { flexDirection: 'row', alignItems: 'flex-start' };\n    const dashboardSectionTitleStyle = { fontSize: 20, fontWeight: '700', color: '#222', marginBottom: 10 };\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\n\n    const RootContainer = ImageBackground;\n    const rootProps = {\n      source: require('../assets/images/inlogg.webb.png'),\n      resizeMode: 'cover',\n      imageStyle: { width: '100%', height: '100%' },\n    };\n\n    const handleSelectCompany = (payload) => {\n      try {\n        if (payload?.createNew) {\n          // Clear form for new company\n          setCompanyId('');\n          setCompanyName('');\n          setUserLimit('10');\n          setOrgNumber(''); setCompanyForm(''); setStreetAddress(''); setPostalCode(''); setCity(''); setCountry('');\n          setContactName(''); setContactEmail(''); setContactPhone('');\n          setBillingAddress(''); setBillingReference(''); setPaymentTerms('30'); setInvoiceMethod('email');\n          return;\n        }\n        const cid = String(payload?.companyId || payload?.id || '').trim();\n        const prof = payload?.profile || payload || {};\n        if (cid) setCompanyId(cid);\n        setCompanyName(prof?.companyName || prof?.name || '');\n        setUserLimit((prof && typeof prof.userLimit !== 'undefined') ? String(prof.userLimit) : '10');\n        setOrgNumber(prof?.orgNumber || prof?.organisationsnummer || '');\n        setCompanyForm(prof?.companyForm || prof?.företagsform || '');\n        setStreetAddress(prof?.streetAddress || prof?.address || '');\n        setPostalCode(prof?.postalCode || prof?.postnummer || '');\n        setCity(prof?.city || prof?.ort || '');\n        setCountry(prof?.country || '');\n        setContactName(prof?.contactName || '');\n        setContactEmail(prof?.contactEmail || '');\n        setContactPhone(prof?.contactPhone || '');\n        setBillingAddress(prof?.billingAddress || '');\n        setBillingReference(prof?.billingReference || '');\n        setPaymentTerms(prof?.paymentTerms ? String(prof.paymentTerms) : '30');\n        setInvoiceMethod(prof?.invoiceMethod || 'email');\n        // Förhandsläs logga: om det är en gammal gs://-URL vill vi omvandla den till https.\n        (async () => {\n          try {\n            const resolved = await resolveCompanyLogoUrl(cid);\n            if (resolved) {\n              setLogoUrl(resolved);\n            } else {\n              setLogoUrl(prof?.logoUrl || '');\n            }\n          } catch (_e) {\n            setLogoUrl(prof?.logoUrl || '');\n          }\n        })();\n\n        // Hämta senaste admin-loggposter för företaget (endast webb)\n        if (Platform.OS === 'web' && cid) {\n          (async () => {\n            try {\n              setAuditLoading(true);\n              const items = await fetchAdminAuditForCompany(cid, 50).catch(() => []);\n              setAuditEvents(Array.isArray(items) ? items : []);\n            } catch (_e) {\n              setAuditEvents([]);\n            } finally {\n              setAuditLoading(false);\n            }\n          })();\n        } else {\n          setAuditEvents([]);\n        }\n      } catch (e) {}\n    };\n\n    const hasSelectedCompany = !!(String(companyId || '').trim() || String(companyName || '').trim());\n    const formDisabled = !hasSelectedCompany;\n\n    return (\n      <RootContainer {...rootProps} style={{ flex: 1, width: '100%', minHeight: '100vh' }}>\n        <View style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0 }} />\n        <MainLayout\n          onSelectProject={handleSelectCompany}\n          sidebarTitle=\"Företagslista\"\n          sidebarIconName=\"business\"\n          sidebarIconColor=\"#2E7D32\"\n          sidebarSearchPlaceholder=\"sök företag\"\n          sidebarCompaniesMode={true}\n          sidebarShowMembers={allowedTools}\n          topBar={\n            <View style={{ height: 96, paddingLeft: 24, paddingRight: 24, backgroundColor: '#fff', justifyContent: 'center' }}>\n              <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', marginLeft: 8 }}>\n                  <View style={{ marginRight: 10 }}>\n                    {showHeaderUserMenu ? <HeaderUserMenuConditional /> : <HeaderDisplayName />}\n                  </View>\n                  {allowedTools ? (\n                    <TouchableOpacity\n                      style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                      onPress={() => setSupportMenuOpen(s => !s)}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                    </TouchableOpacity>\n                  ) : null}\n                </View>\n                <View style={{ alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 6, paddingHorizontal: 12, alignItems: 'center', minWidth: 72 }}\n                    onPress={async () => {\n                      setLoggingOut(true);\n                      try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                      await auth.signOut();\n                      setLoggingOut(false);\n                      navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Logga ut</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          }\n        >\n          <View style={dashboardContainerStyle}>\n            <View style={dashboardColumnsStyle}>\n              <View style={{ width: 640, maxWidth: 640, minWidth: 360, marginRight: 24 }}>\n                <View style={[dashboardCardStyle, { alignSelf: 'flex-start', maxWidth: 600 }] }>\n                  <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                    <TouchableOpacity onPress={() => { try { navigation.goBack(); } catch(e){} }} style={{ padding: 8, marginRight: 8 }} accessibilityLabel=\"Tillbaka\">\n                      <Ionicons name=\"chevron-back\" size={20} color=\"#222\" />\n                    </TouchableOpacity>\n                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                      <View style={{ width: 24, height: 24, borderRadius: 6, backgroundColor: '#2E7D32', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                        <Ionicons name=\"business\" size={14} color=\"#fff\" />\n                      </View>\n                      <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>Hantera företag</Text>\n                    </View>\n                  </View>\n\n                  <View style={{ maxWidth: 520 }}>\n                  {formDisabled && (\n                    <View style={{\n                      width: '84%',\n                      marginLeft: '8%',\n                      marginBottom: 12,\n                      paddingVertical: 8,\n                      paddingHorizontal: 10,\n                      borderRadius: 8,\n                      backgroundColor: '#FFF8E1',\n                      borderWidth: 1,\n                      borderColor: '#FFE082',\n                    }}>\n                      <Text style={{ fontSize: 13, color: '#5D4037' }}>\n                        Välj ett företag i listan till vänster för att visa och ändra dess företagsprofil.\n                      </Text>\n                    </View>\n                  )}\n                  <View style={{ paddingVertical: 6, width: '100%', alignItems: 'flex-start' }}>\n                    <Text style={{ marginBottom: 6, marginLeft: '8%' }}>Företags-ID (kort identifierare)</Text>\n                    <TextInput\n                      value={companyId}\n                      editable={false}\n                      placeholder=\"foretag-id\"\n                      style={{\n                        width: '84%',\n                        marginLeft: '8%',\n                        borderWidth: 1,\n                        borderColor: '#ddd',\n                        padding: 8,\n                        borderRadius: 6,\n                        backgroundColor: '#f5f5f5',\n                        color: '#555',\n                      }}\n                    />\n                  </View>\n\n                  <View style={{ paddingVertical: 6, width: '100%', alignItems: 'flex-start' }}>\n                    <Text style={{ marginBottom: 6, marginLeft: '8%' }}>Företagsnamn</Text>\n                    <TextInput\n                      value={companyName}\n                      editable={false}\n                      placeholder=\"Företagsnamn\"\n                      style={{\n                        width: '84%',\n                        marginLeft: '8%',\n                        borderWidth: 1,\n                        borderColor: '#ddd',\n                        padding: 8,\n                        borderRadius: 6,\n                        backgroundColor: '#f5f5f5',\n                        color: '#555',\n                      }}\n                    />\n                  </View>\n\n                  <View style={{ paddingVertical: 6, width: '100%', alignItems: 'flex-start' }}>\n                    <Text style={{ marginBottom: 6, marginLeft: '8%' }}>Licenser (userLimit)</Text>\n                    <View\n                      style={{\n                        width: '84%',\n                        marginLeft: '8%',\n                        paddingVertical: 10,\n                        paddingHorizontal: 8,\n                        borderRadius: 6,\n                        backgroundColor: '#f5f5f5',\n                        borderWidth: 1,\n                        borderColor: '#ddd',\n                      }}\n                    >\n                      <Text style={{ color: '#333' }}>\n                        {hasSelectedCompany\n                          ? `Max antal användare: ${userLimit !== undefined && userLimit !== null ? String(userLimit) : '—'}`\n                          : 'Ingen företag valt ännu.'}\n                      </Text>\n                      <Text style={{ marginTop: 4, fontSize: 12, color: '#666' }}>\n                        Ändra userLimit via högerklick på företaget i företagslistan till vänster.\n                      </Text>\n                    </View>\n                  </View>\n                  </View>\n\n                  <View style={{ paddingTop: 12 }}>\n                    <Text style={{ color: '#666', fontSize: 13 }}>Obs: företagsprofilen lagras i Firestore (foretag/&lt;företags‑ID&gt;/profil/public). Max antal användare (userLimit) ändras via högerklick på företag i listan till vänster.</Text>\n                  </View>\n                  {hasSelectedCompany ? (\n                    <View style={{ marginTop: 16 }}>\n                      <Text style={{ fontSize: 15, fontWeight: '700', marginBottom: 6 }}>Senaste åtgärder (admin-logg)</Text>\n                      <View style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 8, maxHeight: 260, overflow: 'auto', backgroundColor: '#fafafa' }}>\n                        {auditLoading ? (\n                          <Text style={{ fontSize: 13, color: '#666' }}>Laddar logg...</Text>\n                        ) : (Array.isArray(auditEvents) && auditEvents.length > 0 ? (\n                          auditEvents.map((ev) => {\n                            const ts = ev?.ts && ev.ts.toDate ? ev.ts.toDate() : null;\n                            const tsText = ts ? ts.toLocaleString('sv-SE') : '';\n                            const type = String(ev?.type || '').trim();\n                            let label = type;\n                            if (type === 'createUser') label = 'Skapa användare';\n                            else if (type === 'updateUser') label = 'Uppdatera användare';\n                            else if (type === 'deleteUser') label = 'Ta bort användare';\n                            else if (type === 'setCompanyUserLimit') label = 'Ändra antal användare (userLimit)';\n                            else if (type === 'setCompanyName') label = 'Ändra företagsnamn';\n                            else if (type === 'setCompanyStatus') label = 'Ändra status/dölj företag';\n                            else if (type === 'provisionCompany') label = 'Skapa företag';\n                            else if (type === 'purgeCompany') label = 'Permanent radering av företag';\n\n                            return (\n                              <View key={ev.id} style={{ paddingVertical: 4, borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                                <Text style={{ fontSize: 13, fontWeight: '600', color: '#333' }}>{label}</Text>\n                                {tsText ? <Text style={{ fontSize: 12, color: '#777' }}>{tsText}</Text> : null}\n                              </View>\n                            );\n                          })\n                        ) : (\n                          <Text style={{ fontSize: 13, color: '#666' }}>Inga loggposter hittades än.</Text>\n                        ))}\n                      </View>\n                    </View>\n                  ) : null}\n                </View>\n              </View>\n\n              <View style={{ width: 320, maxWidth: 360 }}>\n                <View style={[dashboardCardStyle, { alignSelf: 'flex-start' }] }>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222', marginBottom: 10 }}>Företagslogga</Text>\n                  {hasSelectedCompany ? (\n                    <>\n                      <View style={{ marginBottom: 12, alignItems: 'center', justifyContent: 'center' }}>\n                        {logoUrl ? (\n                          <img\n                            src={logoUrl}\n                            alt=\"Företagslogga\"\n                            style={{ maxHeight: 80, maxWidth: 260, objectFit: 'contain', borderRadius: 6, border: '1px solid #eee', backgroundColor: '#fff', padding: 4 }}\n                          />\n                        ) : (\n                          <View style={{ height: 80, width: '100%', borderRadius: 6, borderWidth: 1, borderColor: '#eee', backgroundColor: '#fafafa', alignItems: 'center', justifyContent: 'center' }}>\n                            <Text style={{ fontSize: 12, color: '#999' }}>Ingen logga uppladdad ännu.</Text>\n                          </View>\n                        )}\n                      </View>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                        <button\n                          type=\"button\"\n                          onClick={() => {\n                            try {\n                              if (fileInputRef.current) fileInputRef.current.click();\n                            } catch (_e) {}\n                          }}\n                          disabled={logoUploading}\n                          style={{\n                            padding: '6px 10px',\n                            borderRadius: 8,\n                            border: '1px solid #ccc',\n                            backgroundColor: '#fafafa',\n                            cursor: logoUploading ? 'default' : 'pointer',\n                            fontSize: 13,\n                          }}\n                        >\n                          {logoUploading ? 'Laddar upp logga…' : 'Byt logga'}\n                        </button>\n                        <input\n                          ref={fileInputRef}\n                          type=\"file\"\n                          accept=\"image/*\"\n                          style={{ display: 'none' }}\n                          onChange={handleLogoFileChange}\n                        />\n                      </div>\n                    </>\n                  ) : (\n                    <Text style={{ fontSize: 13, color: '#666' }}>\n                      Välj ett företag i listan till vänster för att visa och ändra företagsloggan.\n                    </Text>\n                  )}\n                </View>\n              </View>\n\n            </View>\n          </View>\n      </MainLayout>\n    </RootContainer>\n    );\n  }\n  return (\n    <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : undefined} style={{ flex: 1 }}>\n      <ScrollView contentContainerStyle={{ padding: 16 }}>\n        <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 8 }}>Hantera företag</Text>\n\n        <Text style={{ marginTop: 12, marginBottom: 6 }}>Företags-ID (kort identifierare)</Text>\n        <TextInput value={companyId} onChangeText={setCompanyId} placeholder=\"foretag-id\" style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }} />\n\n        <Text style={{ marginTop: 12, marginBottom: 6 }}>Företagsnamn</Text>\n        <TextInput value={companyName} onChangeText={setCompanyName} placeholder=\"Företagsnamn\" style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }} />\n\n        <Text style={{ marginTop: 12, marginBottom: 6 }}>Antal användare (userLimit)</Text>\n        <TextInput value={String(userLimit)} onChangeText={setUserLimit} placeholder=\"10\" keyboardType=\"numeric\" style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }} />\n\n        <TouchableOpacity onPress={handleSave} style={{ backgroundColor: '#1976D2', padding: 12, borderRadius: 8, marginTop: 16, alignItems: 'center' }}>\n          <Text style={{ color: '#fff', fontWeight: '700' }}>{loading ? 'Sparar...' : 'Spara företag'}</Text>\n        </TouchableOpacity>\n\n        <View style={{ height: 32 }} />\n        <Text style={{ color: '#666', fontSize: 13 }}>Obs: detta uppdaterar endast företagsprofil i Firestore (`foretag/{companyId}/profil/public`). För att koppla användare till Auth krävs server‑funktioner (Cloud Functions) som skapar/ta bort Auth‑konton.</Text>\n      </ScrollView>\n    </KeyboardAvoidingView>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ManageControlTypes.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":274,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":274,"endColumn":88},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":326,"column":86,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj &quot;Lägg till kontrolltyp\" för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj &ldquo;Lägg till kontrolltyp\" för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj &#34;Lägg till kontrolltyp\" för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj &rdquo;Lägg till kontrolltyp\" för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":326,"column":108,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj \"Lägg till kontrolltyp&quot; för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj \"Lägg till kontrolltyp&ldquo; för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj \"Lägg till kontrolltyp&#34; för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15178,15349],"text":"\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj \"Lägg till kontrolltyp&rdquo; för att lägga till egna kontrollpunkter.\n                    "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useEffect, useState } from 'react';\nimport { ImageBackground, Platform, Text, TextInput, TouchableOpacity, View } from 'react-native';\nimport { auth, createCompanyControlType, DEFAULT_CONTROL_TYPES, fetchCompanyControlTypes } from '../components/firebase';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo } from '../components/HeaderComponents';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenuConditional from '../components/HeaderUserMenuConditional';\nimport MainLayout from '../components/MainLayout';\n\n// Ikonuppsättning för nya kontrolltyper (ca 36 bygg-/kontrollrelaterade varianter)\nconst CONTROL_TYPE_ICON_CHOICES = [\n  { icon: 'construct-outline', color: '#1976D2' },\n  { icon: 'checkmark-done-outline', color: '#388E3C' },\n  { icon: 'water-outline', color: '#0288D1' },\n  { icon: 'checkbox-outline', color: '#7B1FA2' },\n  { icon: 'warning-outline', color: '#FFD600' },\n  { icon: 'shield-half-outline', color: '#388E3C' },\n  { icon: 'document-text-outline', color: '#455A64' },\n  { icon: 'document-outline', color: '#1976D2' },\n  { icon: 'clipboard-outline', color: '#1976D2' },\n  { icon: 'save-outline', color: '#D32F2F' },\n  { icon: 'calendar-outline', color: '#1976D2' },\n  { icon: 'cube-outline', color: '#1976D2' },\n  { icon: 'camera', color: '#1976D2' },\n  { icon: 'images', color: '#00897B' },\n  { icon: 'partly-sunny', color: '#FFA000' },\n  { icon: 'sunny-outline', color: '#FBC02D' },\n  { icon: 'alert-circle', color: '#D32F2F' },\n  { icon: 'checkmark-circle', color: '#43A047' },\n  { icon: 'remove-circle', color: '#607D8B' },\n  { icon: 'close-circle-outline', color: '#D32F2F' },\n  { icon: 'options-outline', color: '#6A1B9A' },\n  { icon: 'copy-outline', color: '#00897B' },\n  { icon: 'business', color: '#2E7D32' },\n  { icon: 'home-outline', color: '#1976D2' },\n  { icon: 'person-outline', color: '#1976D2' },\n  { icon: 'list', color: '#1565C0' },\n  { icon: 'filter', color: '#1976D2' },\n  { icon: 'search', color: '#1976D2' },\n  { icon: 'add-circle-outline', color: '#1976D2' },\n  { icon: 'add-circle', color: '#43A047' },\n  // Extra bygg-/installationsrelaterade ikoner för EL, VVS, mark, rivning, ventilation m.m.\n  { icon: 'flash-outline', color: '#FBC02D' },      // El\n  { icon: 'thermometer-outline', color: '#1976D2' }, // Klimat / VVS\n  { icon: 'flame-outline', color: '#D32F2F' },       // Heta arbeten / rivning\n  { icon: 'leaf-outline', color: '#43A047' },        // Miljö / energi\n  { icon: 'rainy-outline', color: '#0288D1' },       // Väder / fukt / mark\n  { icon: 'map-outline', color: '#6D4C41' },         // Mark / plats\n];\n\nexport default function ManageControlTypes({ route, navigation }) {\n  const [companyId, setCompanyId] = useState(() => route?.params?.companyId || '');\n  const [allowedTools, setAllowedTools] = useState(false);\n  const [canSeeAllCompanies, setCanSeeAllCompanies] = useState(false);\n  const [showHeaderUserMenu, setShowHeaderUserMenu] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  const [loggingOut, setLoggingOut] = useState(false);\n  const [controlTypes, setControlTypes] = useState(DEFAULT_CONTROL_TYPES);\n  const [newControlTypeName, setNewControlTypeName] = useState('');\n  const [savingControlType, setSavingControlType] = useState(false);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [selectedIcon, setSelectedIcon] = useState(CONTROL_TYPE_ICON_CHOICES[0]?.icon || 'document-text-outline');\n  const [selectedIconColor, setSelectedIconColor] = useState(CONTROL_TYPE_ICON_CHOICES[0]?.color || '#6A1B9A');\n\n  useEffect(() => {\n    try {\n      navigation.setOptions({\n        headerTitle: () => null,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } catch (_e) {}\n  }, [navigation]);\n\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    let mounted = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        const isEmailSuperadmin = email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.com' || email === 'marcus.skogh@msbyggsystem';\n        if (email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se') {\n          if (mounted) {\n            setAllowedTools(true);\n            setCanSeeAllCompanies(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(false).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const isAdminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        const isSuperClaim = !!(claims && (claims.superadmin === true || claims.role === 'superadmin'));\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const cid = companyFromClaims || stored || '';\n        const canSeeAll = isSuperClaim || isEmailSuperadmin || (cid === 'MS Byggsystem' && isAdminClaim);\n        const allowHeader = isEmailSuperadmin || isSuperClaim || isAdminClaim;\n        if (cid === 'MS Byggsystem' && isAdminClaim) {\n          if (mounted) setAllowedTools(true);\n        }\n        if (mounted) {\n          setCanSeeAllCompanies(!!canSeeAll);\n          setShowHeaderUserMenu(!!allowHeader);\n        }\n      } catch(_e) {}\n      if (mounted) {\n        setAllowedTools(prev => prev);\n        setCanSeeAllCompanies(prev => prev);\n        setShowHeaderUserMenu(prev => prev);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  // Ladda kontrolltyper när valt företag ändras\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      if (!companyId) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n        return;\n      }\n      try {\n        const list = await fetchCompanyControlTypes(companyId);\n        if (mounted && Array.isArray(list) && list.length > 0) setControlTypes(list);\n        else if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n      } catch (_e) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n      }\n    })();\n    return () => { mounted = false; };\n  }, [companyId]);\n\n\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = () => {\n      try {\n        navigation.reset({ index: 0, routes: [{ name: 'Home' }] });\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkGoHome', handler);\n    return () => {\n      try { window.removeEventListener('dkGoHome', handler); } catch (_e) {}\n    };\n  }, [navigation]);\n\n  // Uppdatera listan om kontrolltyperna ändras via sidomenyn (t.ex. byt namn/dölj/radera)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = (event) => {\n      try {\n        const cid = String(event?.detail?.companyId || '').trim();\n        const current = String(companyId || '').trim();\n        if (!cid || !current || cid !== current) return;\n      } catch (_e) {\n        return;\n      }\n\n      (async () => {\n        try {\n          const list = await fetchCompanyControlTypes(companyId);\n          setControlTypes(Array.isArray(list) && list.length > 0 ? list : DEFAULT_CONTROL_TYPES);\n        } catch (_e) {\n          setControlTypes(DEFAULT_CONTROL_TYPES);\n        }\n      })();\n    };\n\n    window.addEventListener('dkControlTypesUpdated', handler);\n    return () => {\n      try { window.removeEventListener('dkControlTypesUpdated', handler); } catch (_e) {}\n    };\n  }, [companyId]);\n\n  if (Platform.OS === 'web') {\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\n\n    const RootContainer = ImageBackground;\n    const rootProps = {\n      source: require('../assets/images/inlogg.webb.png'),\n      resizeMode: 'cover',\n      imageStyle: { width: '100%', height: '100%' },\n    };\n\n    const hasSelectedCompany = !!String(companyId || '').trim();\n    const sidebarRestrictId = canSeeAllCompanies ? null : companyId;\n\n    return (\n      <RootContainer {...rootProps} style={{ flex: 1, width: '100%', minHeight: '100vh' }}>\n        <View style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0 }} />\n        <MainLayout\n          onSelectProject={async (payload) => {\n            try {\n              if (payload?.createNew) return;\n              const cid = String(payload?.companyId || payload?.id || '').trim();\n              if (cid) setCompanyId(cid);\n              if (payload?.createControlType && cid) {\n                setNewControlTypeName('');\n                const baseIcon = CONTROL_TYPE_ICON_CHOICES[0]?.icon || 'document-text-outline';\n                const baseColor = CONTROL_TYPE_ICON_CHOICES[0]?.color || '#6A1B9A';\n                setSelectedIcon(baseIcon);\n                setSelectedIconColor(baseColor);\n                setShowAddModal(true);\n              }\n            } catch (_e) {}\n          }}\n          sidebarTitle=\"Kontrolltyper\"\n          sidebarIconName=\"options-outline\"\n          sidebarIconColor=\"#6A1B9A\"\n          sidebarSearchPlaceholder=\"Sök kontroll\"\n          sidebarCompaniesMode={true}\n          sidebarShowMembers={false}\n          sidebarRestrictCompanyId={sidebarRestrictId}\n          sidebarHideCompanyActions={true}\n          sidebarAutoExpandMembers={true}\n          sidebarTemplatesMode={false}\n          sidebarControlTypesMode={true}\n          topBar={\n            <View style={{ height: 96, paddingLeft: 24, paddingRight: 24, backgroundColor: '#fff', justifyContent: 'center' }}>\n              <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', marginLeft: 8 }}>\n                  <View style={{ marginRight: 10 }}>\n                    {showHeaderUserMenu ? <HeaderUserMenuConditional /> : <HeaderDisplayName />}\n                  </View>\n                  {allowedTools ? (\n                    <TouchableOpacity\n                      style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                      onPress={() => setSupportMenuOpen(s => !s)}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                    </TouchableOpacity>\n                  ) : null}\n                </View>\n                <View style={{ alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 6, paddingHorizontal: 12, alignItems: 'center', minWidth: 72 }}\n                    onPress={async () => {\n                      setLoggingOut(true);\n                      try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                      await auth.signOut();\n                      setLoggingOut(false);\n                      navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>{loggingOut ? 'Loggar ut…' : 'Logga ut'}</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          }\n        >\n          <View style={dashboardContainerStyle}>\n            <View style={[dashboardCardStyle, { alignSelf: 'flex-start', width: 760, maxWidth: '100%' }] }>\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                <TouchableOpacity onPress={() => { try { navigation.goBack(); } catch(e){} }} style={{ padding: 8, marginRight: 8 }} accessibilityLabel=\"Tillbaka\">\n                  <Ionicons name=\"chevron-back\" size={20} color=\"#222\" />\n                </TouchableOpacity>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <View style={{ width: 24, height: 24, borderRadius: 6, backgroundColor: '#6A1B9A', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                    <Ionicons name=\"options-outline\" size={14} color=\"#fff\" />\n                  </View>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>Kontrolltyper</Text>\n                </View>\n              </View>\n\n              <View style={{ maxWidth: 680 }}>\n                {!hasSelectedCompany && (\n                  <View style={{\n                    width: '84%',\n                    marginLeft: '8%',\n                    marginBottom: 12,\n                    paddingVertical: 8,\n                    paddingHorizontal: 10,\n                    borderRadius: 8,\n                    backgroundColor: '#FFF8E1',\n                    borderWidth: 1,\n                    borderColor: '#FFE082',\n                  }}>\n                    <Text style={{ fontSize: 13, color: '#5D4037' }}>\n                      Välj ett företag i listan till vänster för att kunna hantera dess kontrolltyper.\n                    </Text>\n                  </View>\n                )}\n\n                <View style={{ marginTop: 4, width: '84%', marginLeft: '8%' }}>\n                  <Text style={{ marginBottom: 4, fontSize: 13, color: '#444' }}>Sammanfattning</Text>\n                  <View\n                    style={{\n                      paddingVertical: 8,\n                      paddingHorizontal: 10,\n                      borderRadius: 6,\n                      backgroundColor: '#f5f5f5',\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                    }}\n                  >\n                    <Text style={{ color: '#333', fontSize: 13 }}>\n                      {hasSelectedCompany\n                        ? `Antal kontrolltyper: ${Array.isArray(controlTypes) ? controlTypes.length : 0}`\n                        : 'Inget företag valt ännu.'}\n                    </Text>\n                  </View>\n                </View>\n\n                <View style={{ marginTop: 18, width: '84%', marginLeft: '8%' }}>\n                  <Text style={{ fontSize: 13, color: '#555', lineHeight: 18 }}>\n                    Högerklicka på ett företagsnamnet i listan till vänster och välj \"Lägg till kontrolltyp\" för att lägga till egna kontrollpunkter.\n                    {'\\n'}{'\\n'}För att redigera kontrollen kan ni högerklicka på den i listan och välja mellan att byta namn, dölj/aktivera eller radera kontrollen.\n                  </Text>\n                </View>\n              </View>\n            </View>\n          </View>\n          {showAddModal && (\n            <View\n              style={{\n                position: 'fixed',\n                top: 0,\n                left: 0,\n                right: 0,\n                bottom: 0,\n                backgroundColor: 'rgba(0,0,0,0.35)',\n                alignItems: 'center',\n                justifyContent: 'center',\n                zIndex: 200,\n              }}\n            >\n              <View\n                style={{\n                  width: 440,\n                  maxWidth: '90%',\n                  backgroundColor: '#fff',\n                  borderRadius: 12,\n                  paddingVertical: 18,\n                  paddingHorizontal: 18,\n                  shadowColor: '#000',\n                  shadowOpacity: 0.2,\n                  shadowRadius: 10,\n                  shadowOffset: { width: 0, height: 4 },\n                }}\n              >\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 12 }}>\n                  <View style={{ width: 28, height: 28, borderRadius: 8, backgroundColor: '#6A1B9A', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                    <Ionicons name=\"options-outline\" size={16} color=\"#fff\" />\n                  </View>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>Ny kontrolltyp</Text>\n                </View>\n\n                <Text style={{ fontSize: 13, color: '#555', marginBottom: 6 }}>Namn</Text>\n                <TextInput\n                  value={newControlTypeName}\n                  onChangeText={setNewControlTypeName}\n                  placeholder=\"Namn på kontrolltyp (t.ex. Avprovning)\"\n                  style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6, backgroundColor: '#fff', marginBottom: 12 }}\n                />\n\n                <Text style={{ fontSize: 13, color: '#555', marginBottom: 6 }}>Välj ikon</Text>\n                <View style={{ flexDirection: 'row', flexWrap: 'wrap', marginBottom: 12 }}>\n                  {CONTROL_TYPE_ICON_CHOICES.map((t, index) => {\n                    const active = selectedIcon === t.icon;\n                    return (\n                      <TouchableOpacity\n                        key={t.icon + '-' + index}\n                        onPress={() => {\n                          setSelectedIcon(t.icon);\n                          setSelectedIconColor(t.color || '#6A1B9A');\n                        }}\n                        style={{\n                          flexDirection: 'row',\n                          alignItems: 'center',\n                          paddingVertical: 4,\n                          paddingHorizontal: 8,\n                          borderRadius: 8,\n                          borderWidth: 1,\n                          borderColor: active ? '#6A1B9A' : '#ddd',\n                          backgroundColor: active ? '#F3E5F5' : '#fff',\n                          marginRight: 8,\n                          marginBottom: 8,\n                        }}\n                      >\n                        <Ionicons name={t.icon} size={16} color={t.color || '#455A64'} />\n                      </TouchableOpacity>\n                    );\n                  })}\n                </View>\n\n                <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 4 }}>\n                  <TouchableOpacity\n                    onPress={() => {\n                      if (savingControlType) return;\n                      setShowAddModal(false);\n                      setNewControlTypeName('');\n                    }}\n                    style={{ paddingVertical: 8, paddingHorizontal: 12, marginRight: 8 }}\n                  >\n                    <Text style={{ fontSize: 13, color: '#555' }}>Avbryt</Text>\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    onPress={async () => {\n                      const name = String(newControlTypeName || '').trim();\n                      if (!companyId || !name) return;\n                      try {\n                        setSavingControlType(true);\n                        await createCompanyControlType({ name, icon: selectedIcon, color: selectedIconColor }, companyId);\n                        setNewControlTypeName('');\n                        setShowAddModal(false);\n                        try {\n                          const list = await fetchCompanyControlTypes(companyId);\n                          setControlTypes(Array.isArray(list) && list.length > 0 ? list : DEFAULT_CONTROL_TYPES);\n                        } catch (_e) {}\n                      } catch (_e) {\n                      } finally {\n                        setSavingControlType(false);\n                      }\n                    }}\n                    disabled={savingControlType || !newControlTypeName.trim()}\n                    style={{\n                      backgroundColor: savingControlType || !newControlTypeName.trim() ? '#B0BEC5' : '#6A1B9A',\n                      paddingVertical: 8,\n                      paddingHorizontal: 14,\n                      borderRadius: 8,\n                      alignItems: 'center',\n                    }}\n                  >\n                    <Text style={{ color: '#fff', fontWeight: '700', fontSize: 13 }}>\n                      {savingControlType ? 'Sparar…' : 'Spara kontrolltyp'}\n                    </Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          )}\n        </MainLayout>\n      </RootContainer>\n    );\n  }\n\n  return (\n    <View style={{ flex: 1, padding: 16 }}>\n      <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 12 }}>Kontrolltyper</Text>\n      <Text style={{ fontSize: 14, color: '#555' }}>\n        Här kommer du kunna hantera egna kontrolltyper per företag. Funktionen är under utveckling.\n      </Text>\n    </View>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ManageTemplates.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'KLICKAhandleDeleteTemplate' is assigned a value but never used.","line":317,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":317,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"KLICKAhandleDeleteTemplate"},"fix":{"range":[12832,14292],"text":""},"desc":"Remove unused variable 'KLICKAhandleDeleteTemplate'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'buildChecklistFromLayout' is assigned a value but never used.","line":431,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":431,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"buildChecklistFromLayout"},"fix":{"range":[16191,16908],"text":""},"desc":"Remove unused variable 'buildChecklistFromLayout'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleToggleMetaField' is assigned a value but never used.","line":510,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":510,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleToggleMetaField"},"fix":{"range":[18799,19473],"text":""},"desc":"Remove unused variable 'handleToggleMetaField'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleToggleSignatureField' is assigned a value but never used.","line":531,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":531,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleToggleSignatureField"},"fix":{"range":[19477,20156],"text":""},"desc":"Remove unused variable 'handleToggleSignatureField'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":824,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":824,"endColumn":31},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1002,"column":82,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj &quot;Lägg till mall\" eller använd knappen nedan.\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj &ldquo;Lägg till mall\" eller använd knappen nedan.\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj &#34;Lägg till mall\" eller använd knappen nedan.\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj &rdquo;Lägg till mall\" eller använd knappen nedan.\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1002,"column":97,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj \"Lägg till mall&quot; eller använd knappen nedan.\n                  "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj \"Lägg till mall&ldquo; eller använd knappen nedan.\n                  "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj \"Lägg till mall&#34; eller använd knappen nedan.\n                  "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[40317,40462],"text":"\n                    Högerklicka på en kontrolltyp i listan till vänster och välj \"Lägg till mall&rdquo; eller använd knappen nedan.\n                  "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1247,"column":56,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[54487,54544],"text":"\n                        Visar mallar för kontrolltypen &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[54487,54544],"text":"\n                        Visar mallar för kontrolltypen &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[54487,54544],"text":"\n                        Visar mallar för kontrolltypen &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[54487,54544],"text":"\n                        Visar mallar för kontrolltypen &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1247,"column":70,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[54557,54582],"text":"&quot;.\n                      "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[54557,54582],"text":"&ldquo;.\n                      "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[54557,54582],"text":"&#34;.\n                      "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[54557,54582],"text":"&rdquo;.\n                      "},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"no-undef","severity":2,"message":"'handleDeleteTemplate' is not defined.","line":1430,"column":19,"nodeType":"Identifier","messageId":"undef","endLine":1430,"endColumn":39}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useEffect, useRef, useState } from 'react';\nimport { Alert, FlatList, ImageBackground, KeyboardAvoidingView, Platform, Text, TextInput, TouchableOpacity, View } from 'react-native';\nimport ContextMenu from '../components/ContextMenu';\nimport { auth, createCompanyMall, DEFAULT_CONTROL_TYPES, deleteCompanyMall, fetchCompanyControlTypes, fetchCompanyMallar, updateCompanyMall } from '../components/firebase';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo } from '../components/HeaderComponents';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenuConditional from '../components/HeaderUserMenuConditional';\nimport MainLayout from '../components/MainLayout';\n\nexport default function ManageTemplates({ route, navigation }) {\n  const DESCRIPTION_MAX_LENGTH = 50;\n  const META_FIELD_CONFIG = [\n    { key: 'project', label: 'Projekt', defaultEnabled: true },\n    { key: 'date', label: 'Datum', defaultEnabled: true },\n    { key: 'weather', label: 'Väder', defaultEnabled: false },\n    { key: 'location', label: 'Plats/arbetsplats', defaultEnabled: false },\n    { key: 'responsible', label: 'Ansvarig person', defaultEnabled: true },\n    { key: 'participants', label: 'Deltagare', defaultEnabled: false },\n    { key: 'subcontractor', label: 'Entreprenör/underentreprenör', defaultEnabled: false },\n    { key: 'projectPart', label: 'Projekt/delmoment', defaultEnabled: false },\n    { key: 'notes', label: 'Övriga anteckningar', defaultEnabled: true },\n  ];\n  const SIGNATURE_CONFIG = [\n    { key: 'responsible', label: 'Signatur ansvarig', defaultEnabled: true },\n    { key: 'client', label: 'Signatur beställare', defaultEnabled: false },\n    { key: 'inspector', label: 'Signatur kontrollant', defaultEnabled: false },\n  ];\n  const [companyId, setCompanyId] = useState(() => route?.params?.companyId || '');\n  const [templates, setTemplates] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [newTitle, setNewTitle] = useState('');\n  const [newDescription, setNewDescription] = useState('');\n  const [controlType, setControlType] = useState('');\n  const [templatesVersion, setTemplatesVersion] = useState(0);\n  const [selectedTemplateId, setSelectedTemplateId] = useState(null);\n  const [hoveredTemplateId, setHoveredTemplateId] = useState(null);\n  const [controlTypes, setControlTypes] = useState(DEFAULT_CONTROL_TYPES);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [editingTemplate, setEditingTemplate] = useState(null); // null = skapa ny, objekt = redigera befintlig mall\n  const [modalControlType, setModalControlType] = useState('');\n  const [modalTypePickerOpen, setModalTypePickerOpen] = useState(false);\n  const [typePickerOpen, setTypePickerOpen] = useState(false);\n  const [modalMetaFields, setModalMetaFields] = useState(null);\n  const [modalSignatures, setModalSignatures] = useState(null);\n  const [modalVersion, setModalVersion] = useState('1');\n  const [modalMetaSectionOpen, setModalMetaSectionOpen] = useState(false);\n  const [modalSignatureSectionOpen, setModalSignatureSectionOpen] = useState(false);\n  const [modalAuthorSectionOpen, setModalAuthorSectionOpen] = useState(false);\n  const [modalControlSectionOpen, setModalControlSectionOpen] = useState(false);\n  const [previewTemplate, setPreviewTemplate] = useState(null);\n  const lastClickRef = useRef({ id: null, time: 0 });\n  const [listContextMenu, setListContextMenu] = useState(null);\n  const [hasClickedCompanyInSidebar, setHasClickedCompanyInSidebar] = useState(false);\n\n  const handleWheelScroll = (e) => {\n    try {\n      const target = e.currentTarget || (e.nativeEvent && e.nativeEvent.target);\n      if (!target) return;\n      const deltaY = typeof e.deltaY === 'number' ? e.deltaY : (e.nativeEvent && typeof e.nativeEvent.deltaY === 'number' ? e.nativeEvent.deltaY : 0);\n      const scrollTop = target.scrollTop || 0;\n      const scrollHeight = target.scrollHeight || 0;\n      const clientHeight = target.clientHeight || 0;\n      const isScrollingDown = deltaY > 0;\n      const isScrollingUp = deltaY < 0;\n\n      const atBottom = scrollTop + clientHeight >= scrollHeight - 1;\n      const atTop = scrollTop <= 0;\n\n      if ((isScrollingDown && atBottom) || (isScrollingUp && atTop)) {\n        if (typeof e.preventDefault === 'function') e.preventDefault();\n        if (typeof e.stopPropagation === 'function') e.stopPropagation();\n      }\n    } catch (_e) {}\n  };\n\n  useEffect(() => {\n    try {\n      navigation.setOptions({\n        headerTitle: () => null,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } catch (_e) {}\n  }, [navigation]);\n\n  const [allowedTools, setAllowedTools] = useState(false);\n  const [canSeeAllCompanies, setCanSeeAllCompanies] = useState(false);\n  const [showHeaderUserMenu, setShowHeaderUserMenu] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  const [loggingOut, setLoggingOut] = useState(false);\n\n  // Ladda kontrolltyper per företag (standard + ev. företags-specifika)\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      try {\n        const list = await fetchCompanyControlTypes(companyId || null);\n        if (mounted && Array.isArray(list) && list.length > 0) {\n          setControlTypes(list);\n        } else if (mounted) {\n          setControlTypes(DEFAULT_CONTROL_TYPES);\n        }\n      } catch (_e) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n      }\n    })();\n    return () => { mounted = false; };\n  }, [companyId]);\n\n\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    let mounted = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        const isEmailSuperadmin = email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.com' || email === 'marcus.skogh@msbyggsystem';\n        if (email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se') {\n          if (mounted) {\n            setAllowedTools(true);\n            setCanSeeAllCompanies(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(false).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const isAdminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        const isSuperClaim = !!(claims && (claims.superadmin === true || claims.role === 'superadmin'));\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const cid = companyFromClaims || stored || '';\n        const canSeeAll = isSuperClaim || isEmailSuperadmin || (cid === 'MS Byggsystem' && isAdminClaim);\n        const allowHeader = isEmailSuperadmin || isSuperClaim || isAdminClaim;\n        if (cid === 'MS Byggsystem' && isAdminClaim) {\n          if (mounted) setAllowedTools(true);\n        }\n        if (mounted) {\n          setCanSeeAllCompanies(!!canSeeAll);\n          setShowHeaderUserMenu(!!allowHeader);\n        }\n      } catch(_e) {}\n      if (mounted) {\n        setAllowedTools(prev => prev);\n        setCanSeeAllCompanies(prev => prev);\n        setShowHeaderUserMenu(prev => prev);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = () => {\n      try {\n        navigation.reset({ index: 0, routes: [{ name: 'Home' }] });\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkGoHome', handler);\n    return () => {\n      try { window.removeEventListener('dkGoHome', handler); } catch (_e) {}\n    };\n  }, [navigation]);\n\n  useEffect(() => {\n    (async () => {\n      try {\n        if (!companyId) {\n          setTemplates([]);\n          setSelectedTemplateId(null);\n          return;\n        }\n        setLoading(true);\n        const items = await fetchCompanyMallar(companyId);\n        const list = Array.isArray(items) ? items : [];\n        setTemplates(list);\n        // Om vi har ett valt templateId, försök återställa markeringen\n        if (selectedTemplateId) {\n          const exists = list.some(t => String(t.id) === String(selectedTemplateId));\n          if (!exists) {\n            setSelectedTemplateId(null);\n          }\n        }\n      } catch (e) {\n        console.warn(e);\n      } finally {\n        setLoading(false);\n      }\n    })();\n  }, [companyId, selectedTemplateId]);\n\n  // Lyssna på sidomenyn när mallar uppdateras (t.ex. raderas eller dölj/aktiveras via högerklick)\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = (event) => {\n      try {\n        const cid = String(event?.detail?.companyId || '').trim();\n        if (!cid || String(cid) !== String(companyId || '').trim()) return;\n      } catch (_e) {}\n\n      (async () => {\n        try {\n          if (!companyId) {\n            setTemplates([]);\n            setSelectedTemplateId(null);\n            return;\n          }\n          setLoading(true);\n          const items = await fetchCompanyMallar(companyId);\n          const list = Array.isArray(items) ? items : [];\n          setTemplates(list);\n          if (selectedTemplateId) {\n            const exists = list.some(t => String(t.id) === String(selectedTemplateId));\n            if (!exists) {\n              setSelectedTemplateId(null);\n            }\n          }\n        } catch (e) {\n          console.warn(e);\n        } finally {\n          setLoading(false);\n        }\n      })();\n    };\n\n    window.addEventListener('dkTemplatesUpdated', handler);\n    return () => {\n      try { window.removeEventListener('dkTemplatesUpdated', handler); } catch (_e) {}\n    };\n  }, [companyId, selectedTemplateId]);\n\n  const handleAddTemplate = async (overrideControlType) => {\n    if (!companyId) return Alert.alert('Fel', 'Välj först ett företag till vänster.');\n    const title = String(newTitle || '').trim();\n    if (!title) return Alert.alert('Fel', 'Ange en titel för mallen.');\n     const ct = String(overrideControlType || modalControlType || controlType || '').trim();\n     if (!ct) return Alert.alert('Fel', 'Välj vilken kontrolltyp mallen gäller.');\n\n    const metaFields = modalMetaFields || (() => {\n      const base = {};\n      META_FIELD_CONFIG.forEach(cfg => {\n        base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n      });\n      return base;\n    })();\n\n    const signatures = modalSignatures || (() => {\n      const base = {};\n      SIGNATURE_CONFIG.forEach(cfg => {\n        base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n      });\n      return base;\n    })();\n\n    const defaultLayout = {\n      version: 1,\n      metaFields,\n      sections: [\n        {\n          id: 'section-1',\n          title: 'Kontrollpunkter',\n          fields: [],\n        },\n      ],\n      signatures,\n    };\n\n    // Tillåt versionsnummer med punkter (t.ex. 1.0.0 eller 100.00).\n    // Ta bort ev. inledande \"v\"/\"V\" och spara resten som text.\n    let rawVersion = String(modalVersion || '').trim();\n    if (!rawVersion) rawVersion = '1';\n    if (/^[vV]/.test(rawVersion)) {\n      rawVersion = rawVersion.slice(1).trim();\n      if (!rawVersion) rawVersion = '1';\n    }\n    const effectiveVersion = rawVersion;\n\n    try {\n      await createCompanyMall({ title, description: newDescription, controlType: ct, layout: defaultLayout, version: effectiveVersion }, companyId);\n      setNewTitle('');\n      setNewDescription('');\n      setShowAddModal(false);\n      const items = await fetchCompanyMallar(companyId);\n      const list = Array.isArray(items) ? items : [];\n      setTemplates(list);\n      // Markera den senast skapade mallen om möjligt\n      try {\n        const last = list[list.length - 1];\n        if (last && last.id) setSelectedTemplateId(last.id);\n      } catch (_e) {}\n      setTemplatesVersion(v => v + 1);\n      try {\n        Alert.alert('Mall skapad', `Mallen har skapats under kontrolltypen \"${ct}\".`);\n      } catch (_e) {}\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const KLICKAhandleDeleteTemplate = (id) => {\n    if (!companyId || !id) return;\n\n    const performDelete = async () => {\n      try {\n        await deleteCompanyMall({ id }, companyId);\n        const items = await fetchCompanyMallar(companyId);\n        const list = Array.isArray(items) ? items : [];\n        setTemplates(list);\n        if (selectedTemplateId && String(selectedTemplateId) === String(id)) {\n          setSelectedTemplateId(null);\n        }\n        setTemplatesVersion(v => v + 1);\n        try {\n          if (Platform.OS === 'web' && typeof window !== 'undefined') {\n            window.dispatchEvent(new CustomEvent('dkTemplatesUpdated', { detail: { companyId } }));\n          }\n        } catch (_e) {}\n      } catch (e) {\n        Alert.alert('Fel', String(e?.message || e));\n      }\n    };\n\n    try {\n      if (Platform.OS === 'web') {\n        if (typeof window !== 'undefined') {\n          const ok = window.confirm('Är du säker på att du vill ta bort den här mallen?');\n          if (!ok) return;\n        }\n        performDelete();\n        return;\n      }\n\n      Alert.alert(\n        'Ta bort mall',\n        'Är du säker på att du vill ta bort den här mallen?',\n        [\n          { text: 'Avbryt', style: 'cancel' },\n          {\n            text: 'Ta bort',\n            style: 'destructive',\n            onPress: performDelete,\n          },\n        ]\n      );\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const handleTemplateRowPress = (tpl) => {\n    if (!tpl) return;\n    setSelectedTemplateId(prev => (prev && String(prev) === String(tpl.id) ? prev : tpl.id));\n\n    if (Platform.OS === 'web') {\n      const now = Date.now();\n      const last = lastClickRef.current || { id: null, time: 0 };\n      const DOUBLE_CLICK_MS = 350;\n\n      if (last.id === tpl.id && now - last.time < DOUBLE_CLICK_MS) {\n        // Double-click: open inline preview\n        lastClickRef.current = { id: null, time: 0 };\n        setPreviewTemplate(tpl);\n        return;\n      }\n\n      lastClickRef.current = { id: tpl.id, time: now };\n    } else {\n      // Native: treat single tap as preview for now\n      setPreviewTemplate(tpl);\n    }\n  };\n\n  const getEffectiveLayout = (template) => {\n    const raw = (template && template.layout) ? template.layout : {};\n    const metaFieldsRaw = raw.metaFields || {};\n    const signaturesRaw = raw.signatures || {};\n\n    const metaFields = META_FIELD_CONFIG.reduce((acc, cfg) => {\n      const existing = metaFieldsRaw[cfg.key] || {};\n      acc[cfg.key] = {\n        enabled: typeof existing.enabled === 'boolean' ? existing.enabled : cfg.defaultEnabled,\n        label: existing.label || cfg.label,\n      };\n      return acc;\n    }, {});\n\n    const signatures = SIGNATURE_CONFIG.reduce((acc, cfg) => {\n      const existing = signaturesRaw[cfg.key] || {};\n      acc[cfg.key] = {\n        enabled: typeof existing.enabled === 'boolean' ? existing.enabled : cfg.defaultEnabled,\n        label: existing.label || cfg.label,\n      };\n      return acc;\n    }, {});\n\n    const sections = Array.isArray(raw.sections) && raw.sections.length > 0\n      ? raw.sections\n      : [\n          {\n            id: 'section-1',\n            title: 'Kontrollpunkter',\n            fields: [],\n          },\n        ];\n\n    return {\n      ...raw,\n      metaFields,\n      signatures,\n      sections,\n    };\n  };\n\n  const buildChecklistFromLayout = (layout) => {\n    try {\n      if (!layout || !Array.isArray(layout.sections)) return [];\n      const sections = layout.sections || [];\n      const out = sections\n        .map((section) => {\n          const label = String(section?.title || section?.label || '').trim();\n          const fields = Array.isArray(section?.fields) ? section.fields : [];\n          const points = fields\n            .map((field) => String(field?.label || field?.title || '').trim())\n            .filter(Boolean);\n          if (!label && points.length === 0) return null;\n          return { label, points };\n        })\n        .filter(Boolean);\n      return out;\n    } catch (_e) {\n      return [];\n    }\n  };\n\n  const handleSaveEditedTemplate = async () => {\n    if (!companyId || !editingTemplate) return;\n\n    const title = String(newTitle || '').trim();\n    const description = String(newDescription || '').trim();\n    const ct = String(modalControlType || controlType || '').trim();\n    if (!title || !ct) {\n      Alert.alert('Fel', 'Ange både kontrolltyp och namn på mallen.');\n      return;\n    }\n\n    const baseLayout = getEffectiveLayout(editingTemplate);\n    const nextLayout = {\n      ...baseLayout,\n      metaFields: modalMetaFields || baseLayout.metaFields || {},\n      signatures: modalSignatures || baseLayout.signatures || {},\n    };\n\n    // Tillåt versionsnummer med punkter (t.ex. 1.0.0 eller 100.00).\n    // Ta bort ev. inledande \"v\"/\"V\" och spara resten som text.\n    let rawVersion = String(modalVersion || '').trim();\n    if (!rawVersion) rawVersion = String(editingTemplate.version || '1');\n    if (/^[vV]/.test(rawVersion)) {\n      rawVersion = rawVersion.slice(1).trim();\n      if (!rawVersion) rawVersion = String(editingTemplate.version || '1');\n    }\n    const effectiveVersion = rawVersion;\n\n    try {\n      await updateCompanyMall(\n        {\n          id: editingTemplate.id,\n          patch: {\n            title,\n            description,\n            controlType: ct,\n            layout: nextLayout,\n            version: effectiveVersion,\n          },\n        },\n        companyId,\n      );\n\n      const items = await fetchCompanyMallar(companyId);\n      const list = Array.isArray(items) ? items : [];\n      setTemplates(list);\n      setSelectedTemplateId(editingTemplate.id);\n      setTemplatesVersion(v => v + 1);\n      setShowAddModal(false);\n      setEditingTemplate(null);\n      try {\n        Alert.alert('Mall uppdaterad', `Mallen \"${title}\" har sparats.`);\n      } catch (_e) {}\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const handleToggleMetaField = async (template, key) => {\n    if (!template || !key) return;\n    const layout = getEffectiveLayout(template);\n    const current = layout.metaFields[key];\n    const nextLayout = {\n      ...layout,\n      metaFields: {\n        ...layout.metaFields,\n        [key]: { ...current, enabled: !current.enabled },\n      },\n    };\n\n    setTemplates(prev => prev.map(t => (t.id === template.id ? { ...t, layout: nextLayout } : t)));\n    try {\n      await updateCompanyMall({ id: template.id, patch: { layout: nextLayout } }, companyId);\n      setTemplatesVersion(v => v + 1);\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const handleToggleSignatureField = async (template, key) => {\n    if (!template || !key) return;\n    const layout = getEffectiveLayout(template);\n    const current = layout.signatures[key];\n    const nextLayout = {\n      ...layout,\n      signatures: {\n        ...layout.signatures,\n        [key]: { ...current, enabled: !current.enabled },\n      },\n    };\n\n    setTemplates(prev => prev.map(t => (t.id === template.id ? { ...t, layout: nextLayout } : t)));\n    try {\n      await updateCompanyMall({ id: template.id, patch: { layout: nextLayout } }, companyId);\n      setTemplatesVersion(v => v + 1);\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const renderTemplate = ({ item }) => {\n    const isHovered = hoveredTemplateId && String(hoveredTemplateId) === String(item.id);\n    const isHidden = !!item.hidden;\n    const creatorName = (() => {\n      const cb = item && item.createdBy ? item.createdBy : null;\n      if (!cb) return '';\n      const name = cb.displayName && String(cb.displayName).trim();\n      const email = cb.email && String(cb.email).trim();\n      return name || email || '';\n    })();\n    const createdDate = (() => {\n      try {\n        const ts = item && item.createdAt ? item.createdAt : null;\n        if (!ts) return '';\n        if (typeof ts.toDate === 'function') {\n          return ts.toDate().toLocaleDateString('sv-SE');\n        }\n        if (ts instanceof Date) {\n          return ts.toLocaleDateString('sv-SE');\n        }\n        return '';\n      } catch (_e) {\n        return '';\n      }\n    })();\n    const versionLabel = item && item.version ? String(item.version) : '';\n\n    return (\n      <View\n        style={{\n          paddingVertical: 8,\n          borderBottomWidth: 1,\n          borderColor: '#f0f0f0',\n          backgroundColor: isHovered ? '#eee' : '#fff',\n          paddingRight: 8,\n        }}\n        onMouseEnter={() => setHoveredTemplateId(item.id)}\n        onMouseLeave={() => setHoveredTemplateId(prev => (prev && String(prev) === String(item.id) ? null : prev))}\n        onContextMenu={(e) => {\n          if (Platform.OS !== 'web') return;\n          try {\n            if (e && typeof e.preventDefault === 'function') e.preventDefault();\n            if (e && typeof e.stopPropagation === 'function') e.stopPropagation();\n          } catch (_e) {}\n\n          const native = e && e.nativeEvent ? e.nativeEvent : e;\n          const x = (native && (native.pageX || native.clientX)) || 0;\n          const y = (native && (native.pageY || native.clientY)) || 0;\n\n          setSelectedTemplateId(item.id);\n          setListContextMenu({\n            x,\n            y,\n            template: item,\n          });\n        }}\n      >\n        <TouchableOpacity\n          onPress={() => handleTemplateRowPress(item)}\n          style={{ flexDirection: 'row', alignItems: 'center' }}\n        >\n          <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>\n            {/* Rubrik – tar all yta till vänster */}\n            <View style={{ flex: 1, marginRight: 8 }}>\n              <Text\n                style={{\n                  fontSize: 12,\n                  color: isHidden ? '#9E9E9E' : '#000',\n                  fontStyle: isHidden ? 'italic' : 'normal',\n                }}\n                numberOfLines={1}\n              >\n                {(item.title || 'Namnlös mall') + (isHidden ? ' (inaktiv)' : '')}\n              </Text>\n            </View>\n            {/* Skapad av och Datum i en kompakt grupp längst till höger */}\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginLeft: 'auto' }}>\n              <View style={{ width: 130, marginRight: 8 }}>\n                <Text\n                  style={{ fontSize: 12, color: '#607D8B' }}\n                  numberOfLines={1}\n                >\n                  {creatorName}\n                </Text>\n              </View>\n              <View style={{ width: 80, marginRight: 8 }}>\n                <Text\n                  style={{ fontSize: 12, color: '#607D8B' }}\n                  numberOfLines={1}\n                >\n                  {createdDate}\n                </Text>\n              </View>\n            </View>\n          </View>\n          <View\n            style={{\n              width: 128,\n              flexDirection: 'row',\n              alignItems: 'center',\n              justifyContent: 'flex-end',\n              marginLeft: 4,\n            }}\n          >\n            <Text style={{ fontSize: 12, color: '#455A64' }}>\n              {versionLabel ? `v${versionLabel}` : ''}\n            </Text>\n          </View>\n        </TouchableOpacity>\n      </View>\n    );\n  };\n\n  if (Platform.OS === 'web') {\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\n\n    const RootContainer = ImageBackground;\n    const rootProps = {\n      source: require('../assets/images/inlogg.webb.png'),\n      resizeMode: 'cover',\n      imageStyle: { width: '100%', height: '100%' },\n    };\n\n    const hasSelectedCompany = !!String(companyId || '').trim();\n    const sidebarRestrictId = canSeeAllCompanies ? null : companyId;\n    const isMultiCompanyAdmin = !!canSeeAllCompanies;\n\n    return (\n      <RootContainer {...rootProps} style={{ flex: 1, width: '100%', minHeight: '100vh' }}>\n        <View style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0 }} />\n        <MainLayout\n          onSelectProject={(payload) => {\n            try {\n              if (payload?.createNew) return;\n              const cid = String(payload?.companyId || payload?.id || '').trim();\n              const tplId = payload?.templateId;\n              const tpl = payload?.template;\n              setCompanyId(cid || '');\n              if (cid) {\n                setHasClickedCompanyInSidebar(true);\n              }\n              if (tplId) {\n                setSelectedTemplateId(tplId);\n                if (tpl && tpl.controlType) {\n                  setControlType(String(tpl.controlType));\n                }\n\n                // På webben: behandla dubbelklick i trädet som förhandsvisning av mallen\n                if (Platform.OS === 'web' && tpl) {\n                  const now = Date.now();\n                  const last = lastClickRef.current || { id: null, time: 0 };\n                  const DOUBLE_CLICK_MS = 350;\n                  const clickId = `sidebar-${tpl.id}`;\n\n                  if (last.id === clickId && now - last.time < DOUBLE_CLICK_MS) {\n                    lastClickRef.current = { id: null, time: 0 };\n                    setPreviewTemplate(tpl);\n                  } else {\n                    lastClickRef.current = { id: clickId, time: now };\n                  }\n                } else if (tpl) {\n                  // Native: enkeltryck räcker för att visa förhandsvisning\n                  setPreviewTemplate(tpl);\n                }\n              } else if (payload?.controlType) {\n                setControlType(String(payload.controlType));\n                setSelectedTemplateId(null);\n              }\n              if (payload?.openTemplateModal && cid && payload?.controlType) {\n                const ctLabel = String(payload.controlType || '').trim();\n\n                // Om en befintlig mall skickas med i payload => redigeringsläge\n                if (tpl) {\n                  setEditingTemplate(tpl);\n                  setNewTitle(String(tpl.title || ''));\n                  setNewDescription(String(tpl.description || ''));\n                  setModalControlType(ctLabel || String(tpl.controlType || ''));\n                  setControlType(ctLabel || String(tpl.controlType || ''));\n\n                  const layout = getEffectiveLayout(tpl);\n                  setModalMetaFields(layout.metaFields || null);\n                  setModalSignatures(layout.signatures || null);\n                  setModalVersion(String(tpl.version || '1'));\n                } else {\n                  // Skapa ny mall\n                  setEditingTemplate(null);\n                  setNewTitle('');\n                  setNewDescription('');\n                  setModalControlType(ctLabel);\n                  setModalMetaFields(() => {\n                    const base = {};\n                    META_FIELD_CONFIG.forEach(cfg => {\n                      base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n                    });\n                    return base;\n                  });\n                  setModalSignatures(() => {\n                    const base = {};\n                    SIGNATURE_CONFIG.forEach(cfg => {\n                      base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n                    });\n                    return base;\n                  });\n                  setModalVersion('1');\n                }\n\n                setModalMetaSectionOpen(false);\n                setModalControlSectionOpen(false);\n                setModalSignatureSectionOpen(false);\n                setModalAuthorSectionOpen(false);\n                setShowAddModal(true);\n              }\n            } catch (_e) {}\n          }}\n          sidebarTitle=\"Mallar\"\n          sidebarIconName=\"copy-outline\"\n          sidebarIconColor=\"#00897B\"\n          sidebarSearchPlaceholder=\"Sök företag\"\n          sidebarCompaniesMode={true}\n          sidebarShowMembers={false}\n          sidebarRestrictCompanyId={sidebarRestrictId}\n          sidebarHideCompanyActions={true}\n          sidebarAutoExpandMembers={true}\n          sidebarTemplatesMode={true}\n          sidebarTemplatesVersion={templatesVersion}\n          topBar={\n            <View style={{ height: 96, paddingLeft: 24, paddingRight: 24, backgroundColor: '#fff', justifyContent: 'center' }}>\n              <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', marginLeft: 8 }}>\n                  <View style={{ marginRight: 10 }}>\n                    {showHeaderUserMenu ? <HeaderUserMenuConditional /> : <HeaderDisplayName />}\n                  </View>\n                  {allowedTools ? (\n                    <TouchableOpacity\n                      style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                      onPress={() => setSupportMenuOpen(s => !s)}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                    </TouchableOpacity>\n                  ) : null}\n                </View>\n                <View style={{ alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 6, paddingHorizontal: 12, alignItems: 'center', minWidth: 72 }}\n                    onPress={async () => {\n                      setLoggingOut(true);\n                      try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                      await auth.signOut();\n                      setLoggingOut(false);\n                      navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>{loggingOut ? 'Loggar ut…' : 'Logga ut'}</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          }\n        >\n          <View style={dashboardContainerStyle}>\n            <View style={[dashboardCardStyle, { alignSelf: 'flex-start', width: 880, maxWidth: '100%' }] }>\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                <TouchableOpacity\n                  onPress={() => {\n                    try {\n                      if (previewTemplate) {\n                        // Stäng endast förhandsvisningen av mallen och stanna kvar på sidan\n                        setPreviewTemplate(null);\n                        return;\n                      }\n                      navigation.goBack();\n                    } catch (e) {}\n                  }}\n                  style={{ padding: 8, marginRight: 8 }}\n                  accessibilityLabel=\"Tillbaka\"\n                >\n                  <Ionicons name=\"chevron-back\" size={20} color=\"#222\" />\n                </TouchableOpacity>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <View style={{ width: 24, height: 24, borderRadius: 6, backgroundColor: '#00897B', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                    <Ionicons name=\"copy-outline\" size={14} color=\"#fff\" />\n                  </View>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>\n                    {previewTemplate ? `Förhandsvisning av mall: ${previewTemplate.title || 'Namnlös mall'}` : 'Mallar'}\n                  </Text>\n                </View>\n              </View>\n\n              <View style={{ maxWidth: 680 }}>\n                {(!hasSelectedCompany || (isMultiCompanyAdmin && !hasClickedCompanyInSidebar)) && (\n                  <View style={{\n                    width: '84%',\n                    marginLeft: '8%',\n                    marginBottom: 12,\n                    paddingVertical: 8,\n                    paddingHorizontal: 10,\n                    borderRadius: 8,\n                    backgroundColor: '#FFF8E1',\n                    borderWidth: 1,\n                    borderColor: '#FFE082',\n                  }}>\n                    <Text style={{ fontSize: 13, color: '#5D4037' }}>\n                      Välj ett företag i listan till vänster för att se och hantera dess mallar.\n                    </Text>\n                  </View>\n                )}\n\n                {!previewTemplate && (\n                <View style={{ marginTop: 4, width: '100%', alignItems: 'flex-start' }}>\n                  <Text style={{ marginBottom: 4, marginLeft: '8%', fontSize: 13, color: '#444' }}>Sammanfattning</Text>\n                  <View\n                    style={{\n                      width: '84%',\n                      marginLeft: '8%',\n                      paddingVertical: 8,\n                      paddingHorizontal: 10,\n                      borderRadius: 6,\n                      backgroundColor: '#f5f5f5',\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                    }}\n                  >\n                    <Text style={{ color: '#333', fontSize: 13 }}>\n                      {!hasSelectedCompany\n                        ? 'Inget företag valt ännu.'\n                        : (isMultiCompanyAdmin && !hasClickedCompanyInSidebar)\n                          ? 'Välj ett företag i listan till vänster för att se dess mallar.'\n                          : (loading\n                            ? 'Läser mallar…'\n                            : `Antal mallar: ${templates.length}`)}\n                    </Text>\n                  </View>\n                </View>\n                )}\n\n                {!previewTemplate && (\n                <View style={{ marginTop: 18, width: '84%', marginLeft: '8%', position: 'relative', zIndex: 10 }}>\n                  <Text style={{ fontSize: 13, color: '#555', lineHeight: 18 }}>\n                    Skapa och hantera återanvändbara mallar kopplade till företaget.\n                    Dessa kan användas som underlag vid onboarding och uppsättning av projekt.\n                  </Text>\n                </View>\n                )}\n\n                {!previewTemplate && (\n                <View style={{ marginTop: 18, width: '84%', marginLeft: '8%' }}>\n                  <Text style={{ fontSize: 13, fontWeight: '600', marginBottom: 6 }}>Kontrolltyp</Text>\n                  <TouchableOpacity\n                    activeOpacity={0.8}\n                    onPress={() => setTypePickerOpen(o => !o)}\n                    style={{\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                      borderRadius: 8,\n                      paddingVertical: 6,\n                      paddingHorizontal: 8,\n                      backgroundColor: '#fff',\n                      marginBottom: 4,\n                    }}\n                  >\n                    <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', flexShrink: 1 }}>\n                        {(() => {\n                          const ctMeta = (controlTypes || []).find(\n                            (ct) => String(ct?.name || ct?.key || '').trim() === String(controlType || '').trim()\n                          );\n                          if (!ctMeta) return null;\n                          return (\n                            <View\n                              style={{\n                                width: 22,\n                                height: 22,\n                                borderRadius: 6,\n                                backgroundColor: ctMeta.color || '#00897B',\n                                alignItems: 'center',\n                                justifyContent: 'center',\n                                marginRight: 6,\n                              }}\n                            >\n                              <Ionicons\n                                name={ctMeta.icon || 'document-text-outline'}\n                                size={14}\n                                color=\"#fff\"\n                              />\n                            </View>\n                          );\n                        })()}\n                        <Text style={{ fontSize: 13, fontWeight: '600', color: '#222', flexShrink: 1 }} numberOfLines={1}>\n                          {controlType || 'Välj kontrolltyp'}\n                        </Text>\n                      </View>\n                      <Ionicons\n                        name={typePickerOpen ? 'chevron-up' : 'chevron-down'}\n                        size={16}\n                        color=\"#555\"\n                      />\n                    </View>\n                  </TouchableOpacity>\n                  {typePickerOpen && (\n                    <View\n                      style={{\n                        position: 'absolute',\n                        top: 40,\n                        left: 0,\n                        right: 0,\n                        zIndex: 50,\n                        marginTop: 4,\n                        borderWidth: 1,\n                        borderColor: '#ddd',\n                        borderRadius: 8,\n                        backgroundColor: '#fff',\n                        maxHeight: 180,\n                        overflow: 'auto',\n                      }}\n                      onWheel={handleWheelScroll}\n                    >\n                      {controlTypes.map((ct) => {\n                        const label = ct.name || ct.key || '';\n                        if (!label) return null;\n                        const selected = String(label) === String(controlType || '');\n                        return (\n                          <TouchableOpacity\n                            key={ct.id || ct.key || label}\n                            onPress={() => {\n                              setControlType(label);\n                              setTypePickerOpen(false);\n                            }}\n                            style={{\n                              flexDirection: 'row',\n                              alignItems: 'center',\n                              paddingVertical: 6,\n                              paddingHorizontal: 8,\n                              backgroundColor: selected ? '#E0F2F1' : '#fff',\n                            }}\n                          >\n                            <Ionicons\n                              name={ct.icon || 'document-text-outline'}\n                              size={14}\n                              color={ct.color || '#455A64'}\n                              style={{ marginRight: 6 }}\n                            />\n                            <Text style={{ fontSize: 13, color: '#263238' }}>{label}</Text>\n                          </TouchableOpacity>\n                        );\n                      })}\n                    </View>\n                  )}\n                  <Text style={{ fontSize: 13, fontWeight: '600', marginBottom: 6 }}>Ny mall</Text>\n                  <Text style={{ fontSize: 13, color: '#555', marginBottom: 8 }}>\n                    Högerklicka på en kontrolltyp i listan till vänster och välj \"Lägg till mall\" eller använd knappen nedan.\n                  </Text>\n                  {!String(controlType || '').trim() && hasSelectedCompany && (\n                    <Text style={{ fontSize: 12, color: '#D32F2F', marginBottom: 4 }}>\n                      Välj först en kontrolltyp ovan för att kunna öppna formuläret.\n                    </Text>\n                  )}\n                  {!hasSelectedCompany && (\n                    <Text style={{ fontSize: 12, color: '#D32F2F', marginBottom: 4 }}>\n                      Välj först ett företag till vänster.\n                    </Text>\n                  )}\n                  {(() => {\n                    const ct = String(controlType || '').trim();\n                    const canOpen = hasSelectedCompany && !!ct;\n                    return (\n                  <TouchableOpacity\n                    onPress={() => {\n                      if (!canOpen) return;\n                      setEditingTemplate(null);\n                      setNewTitle('');\n                      setNewDescription('');\n                      setModalControlType(ct);\n                      setModalMetaFields(() => {\n                        const base = {};\n                        META_FIELD_CONFIG.forEach(cfg => {\n                          base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n                        });\n                        return base;\n                      });\n                      setModalSignatures(() => {\n                        const base = {};\n                        SIGNATURE_CONFIG.forEach(cfg => {\n                          base[cfg.key] = { enabled: cfg.defaultEnabled, label: cfg.label };\n                        });\n                        return base;\n                      });\n                      setModalVersion('1');\n                      setModalMetaSectionOpen(false);\n                      setModalControlSectionOpen(false);\n                      setModalSignatureSectionOpen(false);\n                      setModalAuthorSectionOpen(false);\n                      setShowAddModal(true);\n                    }}\n                    disabled={!canOpen}\n                    style={{\n                      backgroundColor: canOpen ? '#00897B' : '#B0BEC5',\n                      padding: 10,\n                      borderRadius: 8,\n                      marginTop: 4,\n                      alignItems: 'center',\n                      alignSelf: 'flex-start',\n                      minWidth: 160,\n                      opacity: canOpen ? 1 : 0.9,\n                    }}\n                  >\n                    <Text style={{ color: '#fff', fontWeight: '700', fontSize: 13 }}>Öppna formulär för ny mall</Text>\n                  </TouchableOpacity>\n                    );\n                  })()}\n                </View>\n                )}\n\n                {previewTemplate && (\n                  <View style={{ marginTop: 22, width: '100%', alignItems: 'center' }}>\n                    <View\n                      style={{\n                        width: 794,\n                        maxWidth: '92%',\n                        backgroundColor: '#fff',\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        borderRadius: 6,\n                        paddingVertical: 24,\n                        paddingHorizontal: 32,\n                        shadowColor: '#000',\n                        shadowOffset: { width: 0, height: 2 },\n                        shadowOpacity: 0.08,\n                        shadowRadius: 6,\n                        elevation: 1,\n                      }}\n                    >\n                      {(() => {\n                        const layout = getEffectiveLayout(previewTemplate);\n                        const meta = (layout && layout.metaFields) ? layout.metaFields : {};\n                        const today = new Date();\n                        const todayStr = !isNaN(today) ? today.toISOString().slice(0, 10) : '';\n\n                        const isEnabled = (key) => {\n                          try {\n                            const cfg = (META_FIELD_CONFIG || []).find(c => c.key === key);\n                            const field = meta && meta[key] ? meta[key] : null;\n                            if (!cfg && !field) return false;\n                            if (field && typeof field.enabled === 'boolean') return field.enabled;\n                            return cfg ? !!cfg.defaultEnabled : false;\n                          } catch (_e) {\n                            return false;\n                          }\n                        };\n\n                        return (\n                          <View>\n                            {/* Företagslogga + horisontell linje samma som i formulären */}\n                            <View style={{ marginBottom: 8 }}>\n                              <CompanyHeaderLogo />\n                            </View>\n                            <View\n                              style={{\n                                height: 2,\n                                backgroundColor: '#e0e0e0',\n                                width: '100%',\n                                marginBottom: 14,\n                              }}\n                            />\n\n                            {/* Projekt */}\n                            {isEnabled('project') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"document-text-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Projekt:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>12345 – Projektnamn (hämtas från valt projekt)</Text>\n                              </View>\n                            )}\n\n                            {/* Datum */}\n                            {isEnabled('date') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"calendar-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Datum:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>{`Skapad: ${todayStr || 'ÅÅÅÅ-MM-DD'}`}</Text>\n                              </View>\n                            )}\n\n                            {/* Väder */}\n                            {isEnabled('weather') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"partly-sunny\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Väderlek:</Text>\n                                <View style={{ flex: 1, flexDirection: 'row', flexWrap: 'wrap' }}>\n                                  {['Soligt', 'Delvis molnigt', 'Molnigt', 'Regn'].map(label => (\n                                    <View\n                                      key={label}\n                                      style={{\n                                        backgroundColor: '#f5f5f5',\n                                        borderRadius: 12,\n                                        paddingVertical: 3,\n                                        paddingHorizontal: 9,\n                                        marginRight: 6,\n                                        marginBottom: 4,\n                                      }}\n                                    >\n                                      <Text style={{ fontSize: 12.5, color: '#222' }}>{label}</Text>\n                                    </View>\n                                  ))}\n                                </View>\n                              </View>\n                            )}\n\n                            {/* Plats/arbetsplats */}\n                            {isEnabled('location') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"document-text-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Plats/arbetsplats:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>Exempel: Byggarbetsplats / adress</Text>\n                              </View>\n                            )}\n\n                            {/* Ansvarig person */}\n                            {isEnabled('responsible') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"person-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Ansvarig person:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>Förnamn Efternamn (ansvarig för kontrollen)</Text>\n                              </View>\n                            )}\n\n                            {/* Deltagare */}\n                            {isEnabled('participants') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 8 }}>\n                                <Ionicons name=\"person-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8, marginTop: 2 }} />\n                                <View style={{ flex: 1 }}>\n                                  <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 2 }}>\n                                    <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Deltagare:</Text>\n                                    <Text style={{ fontSize: 14, color: '#555' }}>Person 1</Text>\n                                  </View>\n                                  <View style={{ marginLeft: 0 }}>\n                                    {['Person 2', 'Person 3'].map(name => (\n                                      <Text key={name} style={{ fontSize: 14, color: '#555' }}>{name}</Text>\n                                    ))}\n                                  </View>\n                                </View>\n                              </View>\n                            )}\n\n                            {/* Entreprenör/underentreprenör */}\n                            {isEnabled('subcontractor') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"document-text-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Entreprenör/underentreprenör:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>Exempel: Företagsnamn AB</Text>\n                              </View>\n                            )}\n\n                            {/* Projekt/delmoment */}\n                            {isEnabled('projectPart') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                                <Ionicons name=\"cube-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8 }} />\n                                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginRight: 6 }}>Projekt/delmoment:</Text>\n                                <Text style={{ flex: 1, fontSize: 14, color: '#555' }}>Exempel: Stomme / Etapp 2</Text>\n                              </View>\n                            )}\n\n                            {/* Övriga anteckningar */}\n                            {isEnabled('notes') && (\n                              <View style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 4 }}>\n                                <Ionicons name=\"document-text-outline\" size={18} color=\"#1976D2\" style={{ marginRight: 8, marginTop: 2 }} />\n                                <View style={{ flex: 1 }}>\n                                  <Text style={{ fontSize: 15, color: '#222', fontWeight: '600', marginBottom: 4 }}>Övriga anteckningar:</Text>\n                                  <View style={{\n                                    borderWidth: 1,\n                                    borderColor: '#e0e0e0',\n                                    borderRadius: 8,\n                                    backgroundColor: '#fff',\n                                    paddingVertical: 8,\n                                    paddingHorizontal: 10,\n                                  }}>\n                                    <Text style={{ fontSize: 13, color: '#777' }}>\n                                      Här kan du skriva kompletterande information eller noteringar som hör till kontrollen.\n                                    </Text>\n                                  </View>\n                                </View>\n                              </View>\n                            )}\n                          </View>\n                        );\n                      })()}\n                    </View>\n                  </View>\n                )}\n\n                {!typePickerOpen && !previewTemplate && (\n                  <View style={{ marginTop: 22, width: '92%', marginLeft: '8%' }}>\n                    <Text style={{ fontSize: 13, fontWeight: '600', marginBottom: 8 }}>Befintliga mallar</Text>\n                    {hasSelectedCompany && String(controlType || '').trim() && templates.length > 0 && (\n                      <Text style={{ fontSize: 12, color: '#777', marginBottom: 4 }}>\n                        Visar mallar för kontrolltypen \"{controlType}\".\n                      </Text>\n                    )}\n                    {hasSelectedCompany && !String(controlType || '').trim() && templates.length > 0 && (\n                      <Text style={{ fontSize: 12, color: '#777', marginBottom: 4 }}>\n                        Välj en kontrolltyp ovan för att filtrera listan.\n                      </Text>\n                    )}\n                    {(() => {\n                      const ct = String(controlType || '').trim();\n                      const filtered = ct\n                        ? templates.filter(t => String(t.controlType || '').trim() === ct)\n                        : [];\n\n                      return (\n                        <>\n                          {loading && hasSelectedCompany ? (\n                            <Text style={{ fontSize: 13, color: '#666' }}>Laddar mallar…</Text>\n                          ) : !hasSelectedCompany ? (\n                            <Text style={{ fontSize: 13, color: '#666' }}>Välj ett företag för att se dess mallar.</Text>\n                          ) : templates.length === 0 ? (\n                            <Text style={{ fontSize: 13, color: '#666' }}>Inga mallar registrerade ännu.</Text>\n                          ) : (\n                            <>\n                              <View\n                                style={{\n                                  flexDirection: 'row',\n                                  alignItems: 'center',\n                                  paddingVertical: 4,\n                                  paddingRight: 8,\n                                  borderBottomWidth: 1,\n                                  borderColor: '#e0e0e0',\n                                  backgroundColor: '#fafafa',\n                                }}\n                              >\n                                <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>\n                                  {/* Rubrik-kolumn – flexibel till vänster */}\n                                  <View style={{ flex: 1, marginRight: 8 }}>\n                                    <Text\n                                      style={{\n                                        fontSize: 12,\n                                        fontWeight: '600',\n                                        color: '#555',\n                                      }}\n                                      numberOfLines={1}\n                                    >\n                                      Rubrik\n                                    </Text>\n                                  </View>\n                                  {/* Grupp med Skapad av och Datum längst till höger */}\n                                  <View style={{ flexDirection: 'row', alignItems: 'center', marginLeft: 'auto' }}>\n                                    <View style={{ width: 130, marginRight: 8 }}>\n                                      <Text\n                                        style={{\n                                          fontSize: 12,\n                                          fontWeight: '600',\n                                          color: '#555',\n                                        }}\n                                        numberOfLines={1}\n                                      >\n                                        Skapad av\n                                      </Text>\n                                    </View>\n                                    <View style={{ width: 80, marginRight: 8 }}>\n                                      <Text\n                                        style={{\n                                          fontSize: 12,\n                                          fontWeight: '600',\n                                          color: '#555',\n                                        }}\n                                        numberOfLines={1}\n                                      >\n                                        Datum\n                                      </Text>\n                                    </View>\n                                  </View>\n                                </View>\n                                <View style={{ marginLeft: 4, width: 128, alignItems: 'flex-end' }}>\n                                  <Text\n                                    style={{\n                                      fontSize: 12,\n                                      fontWeight: '600',\n                                      color: '#555',\n                                    }}\n                                    numberOfLines={1}\n                                  >\n                                    Version\n                                  </Text>\n                                </View>\n                              </View>\n                              {ct && filtered.length === 0 ? (\n                                <Text style={{ fontSize: 13, color: '#D32F2F', marginTop: 6 }}>\n                                  Inga mallar skapade.\n                                </Text>\n                              ) : (\n                                <FlatList\n                                  data={filtered}\n                                  keyExtractor={(i) => String(i.id || Math.random())}\n                                  renderItem={renderTemplate}\n                                />\n                              )}\n                            </>\n                          )}\n                        </>\n                      );\n                    })()}\n                  </View>\n                )}\n\n                {/* Tidigare visades \"Mallinnehåll\" här när en mall var markerad.\n                    Det är nu borttaget från huvudsidan – innehållet hanteras i\n                    stället i Ny/Redigera-mall-dialogen. */}\n              </View>\n            </View>\n          </View>\n        </MainLayout>\n        {Platform.OS === 'web' && listContextMenu && (\n          <ContextMenu\n            visible={!!listContextMenu}\n            x={listContextMenu.x || 0}\n            y={listContextMenu.y || 0}\n            onClose={() => setListContextMenu(null)}\n            items={(() => {\n              const tpl = listContextMenu && listContextMenu.template;\n              const isHidden = !!(tpl && tpl.hidden);\n              return [\n                { key: 'edit', label: 'Redigera' },\n                { key: isHidden ? 'activate' : 'hide', label: isHidden ? 'Aktivera' : 'Dölj' },\n                { key: 'delete', label: 'Radera', danger: true },\n              ];\n            })()}\n            onSelect={async (item) => {\n              const ctx = listContextMenu;\n              if (!ctx || !ctx.template || !companyId || !item) return;\n\n              const tpl = ctx.template;\n\n              const notifyTemplatesChange = () => {\n                try {\n                  if (Platform.OS === 'web' && typeof window !== 'undefined') {\n                    window.dispatchEvent(new CustomEvent('dkTemplatesUpdated', { detail: { companyId } }));\n                  }\n                } catch (_e) {}\n              };\n\n              try {\n                if (item.key === 'edit') {\n                  try {\n                    const editTpl = tpl;\n                    if (!editTpl) return;\n                    setEditingTemplate(editTpl);\n                    setNewTitle(String(editTpl.title || ''));\n                    setNewDescription(String(editTpl.description || ''));\n\n                    const ctLabel = String(editTpl.controlType || '').trim();\n                    if (ctLabel) {\n                      setModalControlType(ctLabel);\n                      setControlType(ctLabel);\n                    }\n\n                    const layout = getEffectiveLayout(editTpl);\n                    setModalMetaFields(layout.metaFields || null);\n                    setModalSignatures(layout.signatures || null);\n                    setModalVersion(String(editTpl.version || '1'));\n\n                    setModalMetaSectionOpen(false);\n                    setModalControlSectionOpen(false);\n                    setModalSignatureSectionOpen(false);\n                    setModalAuthorSectionOpen(false);\n                    setShowAddModal(true);\n                  } catch (_e) {}\n                  return;\n                }\n\n                if (item.key === 'hide' || item.key === 'activate') {\n                  const targetHidden = item.key === 'hide';\n                  await updateCompanyMall({ id: tpl.id, patch: { hidden: targetHidden } }, companyId);\n                  setTemplates(prev => prev.map(t => (t.id === tpl.id ? { ...t, hidden: targetHidden } : t)));\n                  notifyTemplatesChange();\n                  return;\n                }\n\n                if (item.key === 'delete') {\n                  handleDeleteTemplate(tpl.id);\n                  return;\n                }\n              } catch (e) {\n                Alert.alert('Fel', String(e?.message || e));\n              }\n            }}\n          />\n        )}\n        {showAddModal && (\n          <View\n            style={{\n              position: 'fixed',\n              top: 0,\n              left: 0,\n              right: 0,\n              bottom: 0,\n              backgroundColor: 'rgba(0,0,0,0.35)',\n              alignItems: 'center',\n              justifyContent: 'center',\n              zIndex: 200,\n            }}\n          >\n            <View\n              style={{\n                width: 460,\n                maxWidth: '90%',\n                backgroundColor: '#fff',\n                borderRadius: 12,\n                paddingVertical: 18,\n                paddingHorizontal: 18,\n                shadowColor: '#000',\n                shadowOpacity: 0.2,\n                shadowRadius: 10,\n                shadowOffset: { width: 0, height: 4 },\n              }}\n            >\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 12 }}>\n                <View style={{ width: 28, height: 28, borderRadius: 8, backgroundColor: '#00897B', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <Ionicons name=\"copy-outline\" size={16} color=\"#fff\" />\n                </View>\n                <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>\n                  {editingTemplate\n                    ? `Redigera mall: ${String(editingTemplate.title || 'Namnlös mall')}`\n                    : 'Ny mall'}\n                </Text>\n              </View>\n\n              <View style={{ marginBottom: 10 }}>\n                <Text style={{ fontSize: 13, color: '#555', marginBottom: 4 }}>Kontrolltyp</Text>\n                <TouchableOpacity\n                  activeOpacity={0.8}\n                  onPress={() => setModalTypePickerOpen(o => !o)}\n                  style={{\n                    borderWidth: 1,\n                    borderColor: '#ddd',\n                    borderRadius: 8,\n                    paddingVertical: 6,\n                    paddingHorizontal: 8,\n                    backgroundColor: '#fff',\n                  }}\n                >\n                  <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', minWidth: 200 }}>\n                    <View style={{ flexDirection: 'row', alignItems: 'center', flexShrink: 1 }}>\n                  {(() => {\n                    const ctMeta = (controlTypes || []).find(\n                      (ct) => String(ct?.name || ct?.key || '').trim() === String(modalControlType || controlType || '').trim()\n                    );\n                    if (!ctMeta) return null;\n                    return (\n                      <View\n                        style={{\n                          width: 22,\n                          height: 22,\n                          borderRadius: 6,\n                          backgroundColor: ctMeta.color || '#00897B',\n                          alignItems: 'center',\n                          justifyContent: 'center',\n                          marginRight: 6,\n                        }}\n                      >\n                        <Ionicons\n                          name={ctMeta.icon || 'document-text-outline'}\n                          size={14}\n                          color=\"#fff\"\n                        />\n                      </View>\n                    );\n                  })()}\n                    <Text style={{ fontSize: 13, fontWeight: '600', color: '#222', flexShrink: 1 }} numberOfLines={1}>\n                      {modalControlType || controlType || 'Välj kontrolltyp'}\n                    </Text>\n                  </View>\n                  <Ionicons\n                    name={modalTypePickerOpen ? 'chevron-up' : 'chevron-down'}\n                    size={16}\n                    color=\"#555\"\n                  />\n                  </View>\n                </TouchableOpacity>\n                {modalTypePickerOpen && (\n                  <View\n                    style={{\n                      marginTop: 4,\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                      borderRadius: 8,\n                      backgroundColor: '#fff',\n                      maxHeight: 180,\n                      overflow: 'auto',\n                    }}\n                    onWheel={handleWheelScroll}\n                  >\n                    {controlTypes.map((ct) => {\n                      const label = ct.name || ct.key || '';\n                      if (!label) return null;\n                      const selected = String(label) === String(modalControlType || controlType || '');\n                      return (\n                        <TouchableOpacity\n                          key={ct.id || ct.key || label}\n                          onPress={() => {\n                            setModalControlType(label);\n                            setControlType(label);\n                            setModalTypePickerOpen(false);\n                          }}\n                          style={{\n                            flexDirection: 'row',\n                            alignItems: 'center',\n                            paddingVertical: 6,\n                            paddingHorizontal: 8,\n                            backgroundColor: selected ? '#E0F2F1' : '#fff',\n                          }}\n                        >\n                          <Ionicons\n                            name={ct.icon || 'document-text-outline'}\n                            size={14}\n                            color={ct.color || '#455A64'}\n                            style={{ marginRight: 6 }}\n                          />\n                          <Text style={{ fontSize: 13, color: '#263238' }}>{label}</Text>\n                        </TouchableOpacity>\n                      );\n                    })}\n                  </View>\n                )}\n              </View>\n\n              <Text style={{ fontSize: 13, color: '#555', marginBottom: 6 }}>Namn på mall</Text>\n              <TextInput\n                value={newTitle}\n                onChangeText={setNewTitle}\n                placeholder=\"Titel på mall\"\n                placeholderTextColor=\"#D32F2F\"\n                style={{\n                  borderWidth: 1,\n                  borderColor: '#ddd',\n                  padding: 8,\n                  borderRadius: 6,\n                  backgroundColor: '#fff',\n                  marginBottom: 10,\n                  fontSize: 14,\n                  color: '#111',\n                }}\n              />\n\n              <Text style={{ fontSize: 13, color: '#555', marginBottom: 6 }}>Beskrivning (valfritt)</Text>\n              <TextInput\n                value={newDescription}\n                onChangeText={setNewDescription}\n                placeholder=\"Kort beskrivning av mallen\"\n                multiline\n                maxLength={DESCRIPTION_MAX_LENGTH}\n                placeholderTextColor=\"#D32F2F\"\n                style={{\n                  borderWidth: 1,\n                  borderColor: '#ddd',\n                  padding: 8,\n                  borderRadius: 6,\n                  minHeight: 60,\n                  textAlignVertical: 'top',\n                  backgroundColor: '#fff',\n                  marginBottom: 10,\n                  fontSize: 14,\n                  color: '#111',\n                }}\n              />\n\n              <Text style={{ fontSize: 13, fontWeight: '600', marginBottom: 6 }}>Innehåll i mall</Text>\n\n              <View\n                style={{\n                  marginTop: 4,\n                  borderRadius: 8,\n                  borderWidth: 1,\n                  borderColor: '#e0e0e0',\n                  backgroundColor: '#fafafa',\n                  marginBottom: 10,\n                }}\n              >\n                <TouchableOpacity\n                  onPress={() => {\n                    setModalMetaSectionOpen(open => {\n                      const next = !open;\n                      if (next) {\n                        setModalSignatureSectionOpen(false);\n                        setModalAuthorSectionOpen(false);\n                        setModalControlSectionOpen(false);\n                      }\n                      return next;\n                    });\n                  }}\n                  style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 10, paddingVertical: 8 }}\n                >\n                  <Text style={{ fontSize: 12, fontWeight: '600', color: '#333' }}>Standardfält i toppen</Text>\n                  <Ionicons\n                    name={modalMetaSectionOpen ? 'chevron-up' : 'chevron-down'}\n                    size={14}\n                    color=\"#555\"\n                  />\n                </TouchableOpacity>\n                {modalMetaSectionOpen && (META_FIELD_CONFIG || []).map((cfg) => {\n                  const field = (modalMetaFields && modalMetaFields[cfg.key]) || { enabled: cfg.defaultEnabled, label: cfg.label };\n                  const enabled = !!field.enabled;\n                  return (\n                    <TouchableOpacity\n                      key={cfg.key}\n                      onPress={() => {\n                        setModalMetaFields(prev => {\n                          const base = { ...(prev || {}) };\n                          const current = base[cfg.key] || { enabled: cfg.defaultEnabled, label: cfg.label };\n                          base[cfg.key] = { ...current, enabled: !current.enabled };\n                          return base;\n                        });\n                      }}\n                      style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 4 }}\n                    >\n                      <Ionicons\n                        name={enabled ? 'checkmark-circle' : 'ellipse-outline'}\n                        size={16}\n                        color={enabled ? '#00897B' : '#B0BEC5'}\n                        style={{ marginRight: 8 }}\n                      />\n                      <View style={{ flex: 1 }}>\n                        <Text style={{ fontSize: 13, color: '#222' }}>{field.label || cfg.label}</Text>\n                      </View>\n                    </TouchableOpacity>\n                  );\n                })}\n              </View>\n\n              <View\n                style={{\n                  marginTop: 4,\n                  borderRadius: 8,\n                  borderWidth: 1,\n                  borderColor: '#e0e0e0',\n                  backgroundColor: '#fafafa',\n                  marginBottom: 10,\n                }}\n              >\n                <TouchableOpacity\n                  onPress={() => {\n                    setModalControlSectionOpen(open => {\n                      const next = !open;\n                      if (next) {\n                        setModalMetaSectionOpen(false);\n                        setModalSignatureSectionOpen(false);\n                        setModalAuthorSectionOpen(false);\n                      }\n                      return next;\n                    });\n                  }}\n                  style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 10, paddingVertical: 8 }}\n                >\n                  <Text style={{ fontSize: 12, fontWeight: '600', color: '#333' }}>Kontroll</Text>\n                  <Ionicons\n                    name={modalControlSectionOpen ? 'chevron-up' : 'chevron-down'}\n                    size={14}\n                    color=\"#555\"\n                  />\n                </TouchableOpacity>\n                {modalControlSectionOpen && (\n                  <View style={{ paddingHorizontal: 10, paddingBottom: 8 }}>\n                    <Text style={{ fontSize: 12, color: '#555' }}>\n                      Här kommer kontroll-specifika inställningar att läggas till.\n                    </Text>\n                  </View>\n                )}\n              </View>\n\n              <View\n                style={{\n                  marginTop: 4,\n                  borderRadius: 8,\n                  borderWidth: 1,\n                  borderColor: '#e0e0e0',\n                  backgroundColor: '#fafafa',\n                  marginBottom: 10,\n                }}\n              >\n                <TouchableOpacity\n                  onPress={() => {\n                    setModalSignatureSectionOpen(open => {\n                      const next = !open;\n                      if (next) {\n                        setModalMetaSectionOpen(false);\n                        setModalAuthorSectionOpen(false);\n                        setModalControlSectionOpen(false);\n                      }\n                      return next;\n                    });\n                  }}\n                  style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 10, paddingVertical: 8 }}\n                >\n                  <Text style={{ fontSize: 12, fontWeight: '600', color: '#333' }}>Signaturer</Text>\n                  <Ionicons\n                    name={modalSignatureSectionOpen ? 'chevron-up' : 'chevron-down'}\n                    size={14}\n                    color=\"#555\"\n                  />\n                </TouchableOpacity>\n                {modalSignatureSectionOpen && (SIGNATURE_CONFIG || []).map((cfg) => {\n                  const field = (modalSignatures && modalSignatures[cfg.key]) || { enabled: cfg.defaultEnabled, label: cfg.label };\n                  const enabled = !!field.enabled;\n                  return (\n                    <TouchableOpacity\n                      key={cfg.key}\n                      onPress={() => {\n                        setModalSignatures(prev => {\n                          const base = { ...(prev || {}) };\n                          const current = base[cfg.key] || { enabled: cfg.defaultEnabled, label: cfg.label };\n                          base[cfg.key] = { ...current, enabled: !current.enabled };\n                          return base;\n                        });\n                      }}\n                      style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 4 }}\n                    >\n                      <Ionicons\n                        name={enabled ? 'checkmark-circle' : 'ellipse-outline'}\n                        size={16}\n                        color={enabled ? '#00897B' : '#B0BEC5'}\n                        style={{ marginRight: 8 }}\n                      />\n                      <View style={{ flex: 1 }}>\n                        <Text style={{ fontSize: 13, color: '#222' }}>{field.label || cfg.label}</Text>\n                      </View>\n                    </TouchableOpacity>\n                  );\n                })}\n              </View>\n\n              <View\n                style={{\n                  marginTop: 4,\n                  borderRadius: 8,\n                  backgroundColor: '#F5F5F5',\n                  borderWidth: 1,\n                  borderColor: '#E0E0E0',\n                  marginBottom: 10,\n                }}\n              >\n                <TouchableOpacity\n                  onPress={() => {\n                    setModalAuthorSectionOpen(open => {\n                      const next = !open;\n                      if (next) {\n                        setModalMetaSectionOpen(false);\n                        setModalSignatureSectionOpen(false);\n                      }\n                      return next;\n                    });\n                  }}\n                  style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingHorizontal: 10, paddingTop: 8, paddingBottom: 4 }}\n                >\n                  <Text style={{ fontSize: 12, fontWeight: '600', color: '#333' }}>Skapad av & version</Text>\n                  <Ionicons\n                    name={modalAuthorSectionOpen ? 'chevron-up' : 'chevron-down'}\n                    size={14}\n                    color=\"#555\"\n                  />\n                </TouchableOpacity>\n                {modalAuthorSectionOpen && (\n                  <View style={{ paddingHorizontal: 10, paddingBottom: 8 }}>\n                    <Text style={{ fontSize: 12, color: '#555', marginBottom: 2 }}>\n                      Skapad av\n                    </Text>\n                    <Text style={{ fontSize: 13, color: '#222', marginBottom: 6 }}>\n                      {(() => {\n                        const u = auth && auth.currentUser ? auth.currentUser : null;\n                        const name = (u && u.displayName) ? String(u.displayName).trim() : '';\n                        const email = (u && u.email) ? String(u.email).trim() : '';\n                        return name || email || 'Okänd användare';\n                      })()}\n                    </Text>\n                    <Text style={{ fontSize: 12, color: '#555', marginBottom: 2 }}>Skapad datum</Text>\n                    <Text style={{ fontSize: 13, color: '#222', marginBottom: 6 }}>\n                      {new Date().toLocaleDateString('sv-SE')}\n                    </Text>\n                    <Text style={{ fontSize: 12, color: '#555', marginBottom: 2 }}>Version</Text>\n                    <TextInput\n                      value={modalVersion}\n                      onChangeText={setModalVersion}\n                      placeholder=\"1\"\n                      // Tillåt fria versionssträngar, inklusive punkter (t.ex. 1.0.0)\n                      keyboardType={Platform.OS === 'ios' ? 'numbers-and-punctuation' : 'default'}\n                      style={{ borderWidth: 1, borderColor: '#ddd', borderRadius: 6, paddingVertical: 6, paddingHorizontal: 8, backgroundColor: '#fff', maxWidth: 80 }}\n                    />\n                  </View>\n                )}\n              </View>\n\n              <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 4 }}>\n                <TouchableOpacity\n                  onPress={() => {\n                    setShowAddModal(false);\n                    setEditingTemplate(null);\n                  }}\n                  style={{ paddingVertical: 8, paddingHorizontal: 12, marginRight: 8 }}\n                >\n                  <Text style={{ fontSize: 13, color: '#555' }}>Avbryt</Text>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  onPress={() => {\n                    if (editingTemplate) return handleSaveEditedTemplate();\n                    return handleAddTemplate(modalControlType);\n                  }}\n                  style={{\n                    backgroundColor: !newTitle.trim() || !String(modalControlType || controlType || '').trim() ? '#B0BEC5' : '#00897B',\n                    paddingVertical: 8,\n                    paddingHorizontal: 14,\n                    borderRadius: 8,\n                    alignItems: 'center',\n                  }}\n                  disabled={!newTitle.trim() || !String(modalControlType || controlType || '').trim()}\n                >\n                  <Text style={{ color: '#fff', fontWeight: '700', fontSize: 13 }}>Spara mall</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        )}\n      </RootContainer>\n    );\n  }\n\n  return (\n    <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : undefined} style={{ flex: 1 }}>\n      <View style={{ padding: 16 }}>\n        <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 12 }}>Mallar</Text>\n        <Text style={{ fontSize: 14, color: '#555', marginBottom: 12 }}>\n          Skapa och hantera återanvändbara mallar kopplade till ditt företag.\n        </Text>\n\n        <View style={{ marginTop: 4 }}>\n          <Text style={{ marginBottom: 6 }}>Titel</Text>\n          <TextInput\n            value={newTitle}\n            onChangeText={setNewTitle}\n            placeholder=\"Titel på mall\"\n            style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }}\n          />\n          <Text style={{ marginTop: 12, marginBottom: 6 }}>Beskrivning (valfritt)</Text>\n          <TextInput\n            value={newDescription}\n            onChangeText={setNewDescription}\n            placeholder=\"Kort beskrivning\"\n            multiline\n            maxLength={DESCRIPTION_MAX_LENGTH}\n            style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6, minHeight: 60, textAlignVertical: 'top' }}\n          />\n          <TouchableOpacity\n            onPress={handleAddTemplate}\n            style={{ backgroundColor: '#00897B', padding: 12, borderRadius: 8, marginTop: 12, alignItems: 'center' }}\n          >\n            <Text style={{ color: '#fff', fontWeight: '700' }}>Lägg till mall</Text>\n          </TouchableOpacity>\n        </View>\n\n        <View style={{ marginTop: 18 }}>\n          <Text style={{ fontSize: 16, fontWeight: '700', marginBottom: 8 }}>Befintliga mallar</Text>\n          {loading ? (\n            <Text style={{ color: '#666' }}>Laddar mallar…</Text>\n          ) : (\n            <FlatList\n              data={templates}\n              keyExtractor={(i) => String(i.id || Math.random())}\n              renderItem={renderTemplate}\n            />\n          )}\n        </View>\n      </View>\n    </KeyboardAvoidingView>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ManageUsers.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'loading' is assigned a value but never used.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"loading"},"fix":{"range":[1015,1022],"text":""},"desc":"Remove unused variable 'loading'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'loggingOut' is assigned a value but never used.","line":45,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"loggingOut"},"fix":{"range":[2133,2143],"text":""},"desc":"Remove unused variable 'loggingOut'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":286,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":286,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useEffect, useState } from 'react';\nimport { Alert, FlatList, ImageBackground, KeyboardAvoidingView, Platform, Text, TextInput, TouchableOpacity, View } from 'react-native';\nimport { auth, createUserRemote, fetchCompanyMembers, fetchCompanyProfile } from '../components/firebase';\nimport { formatPersonName } from '../components/formatPersonName';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo } from '../components/HeaderComponents';\nimport HeaderDisplayName from '../components/HeaderDisplayName';\nimport HeaderUserMenuConditional from '../components/HeaderUserMenuConditional';\nimport MainLayout from '../components/MainLayout';\n\nexport default function ManageUsers({ route, navigation }) {\n  const [companyId, setCompanyId] = useState(() => route?.params?.companyId || '');\n  const [members, setMembers] = useState([]);\n  const [profile, setProfile] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [newName, setNewName] = useState('');\n  const [newEmail, setNewEmail] = useState('');\n\n  useEffect(() => {\n    // Align header with other admin views (logos, no inline title)\n    try {\n      navigation.setOptions({\n        headerTitle: () => null,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } catch (_e) {}\n  }, [navigation]);\n\n  // Decide if interactive tools (manage company/users) should be shown (same gating as ManageCompany)\n  const [allowedTools, setAllowedTools] = useState(false);\n  const [canSeeAllCompanies, setCanSeeAllCompanies] = useState(false);\n  const [showHeaderUserMenu, setShowHeaderUserMenu] = useState(false);\n  const [supportMenuOpen, setSupportMenuOpen] = useState(false);\n  const [loggingOut, setLoggingOut] = useState(false);\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    let mounted = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        const isEmailSuperadmin = email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.com' || email === 'marcus.skogh@msbyggsystem';\n        if (email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se') {\n          if (mounted) {\n            setAllowedTools(true);\n            setCanSeeAllCompanies(true);\n            setShowHeaderUserMenu(true);\n          }\n          return;\n        }\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(false).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const isAdminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        const isSuperClaim = !!(claims && (claims.superadmin === true || claims.role === 'superadmin'));\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const cid = companyFromClaims || stored || '';\n        const canSeeAll = isSuperClaim || isEmailSuperadmin || (cid === 'MS Byggsystem' && isAdminClaim);\n        const allowHeader = isEmailSuperadmin || isSuperClaim || isAdminClaim;\n        if (cid === 'MS Byggsystem' && isAdminClaim) {\n          if (mounted) setAllowedTools(true);\n        }\n        if (mounted) {\n          setCanSeeAllCompanies(!!canSeeAll);\n          setShowHeaderUserMenu(!!allowHeader);\n        }\n      } catch(_e) {}\n      if (mounted) {\n        setAllowedTools(prev => prev);\n        setCanSeeAllCompanies(prev => prev);\n        setShowHeaderUserMenu(prev => prev);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  // Listen for global home event from sidebar (web) and navigate back to dashboard without logging out\n  useEffect(() => {\n    if (Platform.OS !== 'web') return undefined;\n    if (typeof window === 'undefined') return undefined;\n\n    const handler = () => {\n      try {\n        navigation.reset({ index: 0, routes: [{ name: 'Home' }] });\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkGoHome', handler);\n    return () => {\n      try { window.removeEventListener('dkGoHome', handler); } catch (_e) {}\n    };\n  }, [navigation]);\n\n  // Load profile + members whenever companyId changes\n  useEffect(() => {\n    (async () => {\n      try {\n        if (!companyId) {\n          setProfile(null);\n          setMembers([]);\n          return;\n        }\n        setLoading(true);\n        const prof = await fetchCompanyProfile(companyId);\n        setProfile(prof || null);\n        const mems = await fetchCompanyMembers(companyId) || [];\n        setMembers(mems);\n      } catch (e) {\n        console.warn(e);\n      } finally { setLoading(false); }\n    })();\n  }, [companyId]);\n\n  // Web: lyssna på uppdateringar från Hantera företag så att profil/userLimit\n  // uppdateras direkt om man har Hantera användare öppet samtidigt.\n  useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n\n    const handler = (event) => {\n      try {\n        const cid = event?.detail?.companyId;\n        const profilePatch = event?.detail?.profile || {};\n        if (!cid || cid !== companyId) return;\n\n        (async () => {\n          let latestProfile = null;\n          try {\n            latestProfile = await fetchCompanyProfile(companyId).catch(() => null);\n          } catch (_err) {\n            latestProfile = null;\n          }\n          const merged = latestProfile ? { ...(latestProfile || {}), ...profilePatch } : profilePatch;\n          setProfile(prev => ({ ...(prev || {}), ...merged }));\n        })();\n      } catch (_e) {}\n    };\n\n    window.addEventListener('dkCompanyProfileUpdated', handler);\n    return () => {\n      try { window.removeEventListener('dkCompanyProfileUpdated', handler); } catch (_e) {}\n    };\n  }, [companyId]);\n\n  let userLimitNumber = null;\n  if (profile && profile.userLimit !== undefined && profile.userLimit !== null && profile.userLimit !== '') {\n    try {\n      const raw = String(profile.userLimit).trim();\n      const m = raw.match(/-?\\d+/);\n      if (m && m[0]) {\n        const n = parseInt(m[0], 10);\n        if (!Number.isNaN(n) && Number.isFinite(n)) userLimitNumber = n;\n      }\n    } catch (_) {}\n  }\n\n  // Pragmatic fallback: MS Byggsystem standard 10 licenser om inget annat hittas\n  if (userLimitNumber === null && companyId === 'MS Byggsystem') {\n    userLimitNumber = 10;\n  }\n\n  const seatsLeft = (userLimitNumber !== null) ? Math.max(0, userLimitNumber - (Array.isArray(members) ? members.length : 0)) : null;\n\n  const handleAdd = async () => {\n    if (!newEmail) return Alert.alert('Fel', 'Ange e-post');\n    if (seatsLeft !== null && seatsLeft <= 0) return Alert.alert('Fel', 'Inga platser kvar enligt userLimit');\n    // Use callable Cloud Function to create Auth user + member doc\n    try {\n      const email = String(newEmail).trim().toLowerCase();\n      const displayName = String(newName).trim() || email.split('@')[0];\n      const payload = { companyId, email, displayName };\n      const result = await createUserRemote(payload);\n      if (result && result.ok) {\n        Alert.alert('Ok', `Användare skapad. Temporärt lösenord: ${result.tempPassword || result.tempPassword || result.tempPassword || result.tempPassword || result.tempPassword || ''}`.replace(/: $/, ''));\n        setNewName(''); setNewEmail('');\n        const mems = await fetchCompanyMembers(companyId) || [];\n        setMembers(mems);\n      } else if (result && result.uid) {\n        Alert.alert('Ok', 'Användare skapad.');\n        setNewName(''); setNewEmail('');\n        const mems = await fetchCompanyMembers(companyId) || [];\n        setMembers(mems);\n      } else {\n        Alert.alert('Fel', 'Kunde inte skapa användare.');\n      }\n    } catch (e) {\n      Alert.alert('Fel', String(e?.message || e));\n    }\n  };\n\n  const renderItem = ({ item }) => (\n    <View style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#f0f0f0' }}>\n      <Text style={{ fontSize: 15, fontWeight: '600' }}>{formatPersonName(item.displayName || item.email)}</Text>\n      <Text style={{ color: '#666', marginTop: 4 }}>{item.email || ''}</Text>\n    </View>\n  );\n\n  // Web: use same layout as ManageCompany (sidebar + top bar + background)\n  if (Platform.OS === 'web') {\n    const dashboardContainerStyle = { width: '100%', maxWidth: 1180, alignSelf: 'center' };\n    const dashboardCardStyle = { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 12, padding: 12, backgroundColor: '#fff' };\n\n    const RootContainer = ImageBackground;\n    const rootProps = {\n      source: require('../assets/images/inlogg.webb.png'),\n      resizeMode: 'cover',\n      imageStyle: { width: '100%', height: '100%' },\n    };\n\n    const hasSelectedCompany = !!String(companyId || '').trim();\n\n    // Superadmin / MS Byggsystem-admin (canSeeAllCompanies === true) ska kunna se alla\n    // företag i listan. Vanliga företags-admins ser bara sitt eget företag.\n    const sidebarRestrictId = canSeeAllCompanies ? null : companyId;\n\n    return (\n      <RootContainer {...rootProps} style={{ flex: 1, width: '100%', minHeight: '100vh' }}>\n        <View style={{ pointerEvents: 'none', position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(255,255,255,0.35)', zIndex: 0 }} />\n        <MainLayout\n          onSelectProject={(payload) => {\n            try {\n              if (payload?.createNew) return;\n              const cid = String(payload?.companyId || payload?.id || '').trim();\n              setCompanyId(cid || '');\n            } catch (_e) {}\n          }}\n          sidebarTitle=\"Användarlista\"\n          sidebarIconName=\"person\"\n          sidebarIconColor=\"#1976D2\"\n          sidebarSearchPlaceholder=\"Sök användare\"\n          sidebarCompaniesMode={true}\n          sidebarShowMembers={true}\n          sidebarRestrictCompanyId={sidebarRestrictId}\n          sidebarHideCompanyActions={true}\n          sidebarAutoExpandMembers={true}\n          sidebarSearchMembersOnly={true}\n          sidebarAllowCompanyManagementActions={false}\n          topBar={\n            <View style={{ height: 96, paddingLeft: 24, paddingRight: 24, backgroundColor: '#fff', justifyContent: 'center' }}>\n              <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n                <View style={{ display: 'flex', flexDirection: 'row', alignItems: 'center', marginLeft: 8 }}>\n                  <View style={{ marginRight: 10 }}>\n                    {showHeaderUserMenu ? <HeaderUserMenuConditional /> : <HeaderDisplayName />}\n                  </View>\n                  {allowedTools ? (\n                    <TouchableOpacity\n                      style={{ backgroundColor: '#f0f0f0', borderRadius: 8, paddingVertical: 6, paddingHorizontal: 10, alignSelf: 'flex-start' }}\n                      onPress={() => setSupportMenuOpen(s => !s)}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700' }}>{supportMenuOpen ? 'Stäng verktyg' : 'Verktyg'}</Text>\n                    </TouchableOpacity>\n                  ) : null}\n                </View>\n                <View style={{ alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#fff', borderRadius: 8, borderWidth: 1, borderColor: '#222', paddingVertical: 6, paddingHorizontal: 12, alignItems: 'center', minWidth: 72 }}\n                    onPress={async () => {\n                      setLoggingOut(true);\n                      try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n                      await auth.signOut();\n                      setLoggingOut(false);\n                      navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n                    }}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Logga ut</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          }\n        >\n          <View style={dashboardContainerStyle}>\n            <View style={[dashboardCardStyle, { alignSelf: 'flex-start', width: 760, maxWidth: '100%' }] }>\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 10 }}>\n                <TouchableOpacity onPress={() => { try { navigation.goBack(); } catch(e){} }} style={{ padding: 8, marginRight: 8 }} accessibilityLabel=\"Tillbaka\">\n                  <Ionicons name=\"chevron-back\" size={20} color=\"#222\" />\n                </TouchableOpacity>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <View style={{ width: 24, height: 24, borderRadius: 6, backgroundColor: '#1976D2', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                    <Ionicons name=\"person\" size={14} color=\"#fff\" />\n                  </View>\n                  <Text style={{ fontSize: 16, fontWeight: '700', color: '#222' }}>Hantera användare</Text>\n                </View>\n              </View>\n              <View style={{ maxWidth: 680 }}>\n                {!hasSelectedCompany && (\n                  <View style={{\n                    width: '84%',\n                    marginLeft: '8%',\n                    marginBottom: 12,\n                    paddingVertical: 8,\n                    paddingHorizontal: 10,\n                    borderRadius: 8,\n                    backgroundColor: '#FFF8E1',\n                    borderWidth: 1,\n                    borderColor: '#FFE082',\n                  }}>\n                    <Text style={{ fontSize: 13, color: '#5D4037' }}>\n                      Välj ett företag i listan till vänster för att se och hantera dess användare.\n                    </Text>\n                  </View>\n                )}\n\n                <View style={{ marginTop: 4, width: '100%', alignItems: 'flex-start' }}>\n                  <Text style={{ marginBottom: 4, marginLeft: '8%', fontSize: 13, color: '#444' }}>Sammanfattning</Text>\n                  <View\n                    style={{\n                      width: '84%',\n                      marginLeft: '8%',\n                      paddingVertical: 8,\n                      paddingHorizontal: 10,\n                      borderRadius: 6,\n                      backgroundColor: '#f5f5f5',\n                      borderWidth: 1,\n                      borderColor: '#ddd',\n                    }}\n                  >\n                    <Text style={{ color: '#333', fontSize: 13 }}>\n                      {profile\n                        ? `Platser: ${userLimitNumber !== null ? userLimitNumber : '—'} — Användare: ${members.length}`\n                        : hasSelectedCompany ? 'Läser profil…' : 'Inget företag valt ännu.'}\n                    </Text>\n                    {seatsLeft !== null ? (\n                      <Text style={{ marginTop: 4, fontSize: 12, color: seatsLeft > 0 ? '#2E7D32' : '#D32F2F' }}>\n                        {`Platser kvar: ${seatsLeft}`}\n                      </Text>\n                    ) : null}\n                  </View>\n                </View>\n\n                <View style={{ marginTop: 16, width: '84%', marginLeft: '8%' }}>\n                  <Text style={{ fontSize: 13, color: '#555', lineHeight: 18 }}>\n                    Användare skapas och hanteras via listan till vänster.\n                    Högerklicka på företaget för att lägga till eller ta bort användare.\n                  </Text>\n                </View>\n\n                {hasSelectedCompany && (\n                  <View style={{ marginTop: 20, width: '84%', marginLeft: '8%' }}>\n                    <Text style={{ fontSize: 14, fontWeight: '700', color: '#222', marginBottom: 6 }}>\n                      Användare i {companyId}\n                    </Text>\n                    <View style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, backgroundColor: '#fafafa' }}>\n                      {Array.isArray(members) && members.length > 0 ? (\n                        members.map((m) => {\n                          const role = String(m.role || '').trim();\n                          let roleLabel = 'Användare';\n                          let roleColor = '#455A64';\n                          if (role === 'admin') { roleLabel = 'Admin'; roleColor = '#1565C0'; }\n                          else if (role === 'superadmin') { roleLabel = 'Superadmin'; roleColor = '#C62828'; }\n\n                          return (\n                            <View\n                              key={m.uid || m.id || m.email}\n                              style={{\n                                paddingVertical: 8,\n                                paddingHorizontal: 10,\n                                borderBottomWidth: 1,\n                                borderBottomColor: '#e0e0e0',\n                                flexDirection: 'row',\n                                alignItems: 'center',\n                                justifyContent: 'space-between',\n                              }}\n                            >\n                              <View style={{ flex: 1, marginRight: 12 }}>\n                                <Text style={{ fontSize: 14, fontWeight: '600', color: '#222' }}>\n                                  {formatPersonName(m.displayName || m.email || '')}\n                                </Text>\n                                <Text style={{ fontSize: 12, color: '#666', marginTop: 2 }}>{m.email || ''}</Text>\n                              </View>\n                              <View style={{ paddingVertical: 3, paddingHorizontal: 8, borderRadius: 999, backgroundColor: '#ECEFF1' }}>\n                                <Text style={{ fontSize: 11, fontWeight: '600', color: roleColor }}>{roleLabel}</Text>\n                              </View>\n                            </View>\n                          );\n                        })\n                      ) : (\n                        <View style={{ paddingVertical: 10, paddingHorizontal: 10 }}>\n                          <Text style={{ fontSize: 13, color: '#D32F2F' }}>Ingen användare skapad.</Text>\n                        </View>\n                      )}\n                    </View>\n                  </View>\n                )}\n              </View>\n            </View>\n          </View>\n        </MainLayout>\n      </RootContainer>\n    );\n  }\n\n  return (\n    <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : undefined} style={{ flex: 1 }}>\n      <View style={{ padding: 16 }}>\n        <Text style={{ fontSize: 18, fontWeight: '700' }}>Hantera användare</Text>\n        <Text style={{ marginTop: 8 }}>{profile ? `Platser: ${userLimitNumber !== null ? userLimitNumber : '—'} — Användare: ${members.length}` : 'Läser profil...'}</Text>\n        {seatsLeft !== null ? <Text style={{ marginTop: 6, color: seatsLeft > 0 ? '#2E7D32' : '#D32F2F' }}>{`Platser kvar: ${seatsLeft}`}</Text> : null}\n\n        <View style={{ marginTop: 12 }}>\n          <Text style={{ marginBottom: 6 }}>Namn</Text>\n          <TextInput value={newName} onChangeText={setNewName} placeholder=\"Förnamn Efternamn\" style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }} />\n          <Text style={{ marginTop: 12, marginBottom: 6 }}>Email</Text>\n          <TextInput value={newEmail} onChangeText={setNewEmail} placeholder=\"user@company.se\" keyboardType=\"email-address\" style={{ borderWidth: 1, borderColor: '#ddd', padding: 8, borderRadius: 6 }} />\n          <TouchableOpacity onPress={handleAdd} style={{ backgroundColor: '#1976D2', padding: 12, borderRadius: 8, marginTop: 12, alignItems: 'center' }}>\n            <Text style={{ color: '#fff', fontWeight: '700' }}>Lägg till användare</Text>\n          </TouchableOpacity>\n        </View>\n\n        <View style={{ marginTop: 18 }}>\n          <Text style={{ fontSize: 16, fontWeight: '700', marginBottom: 8 }}>Nuvarande användare</Text>\n          <FlatList data={members} keyExtractor={(i) => String(i.uid || i.id || i.email || Math.random())} renderItem={renderItem} />\n        </View>\n      </View>\n    </KeyboardAvoidingView>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/MottagningskontrollScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":34,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":76,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":77,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":88,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":88,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":117,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":117,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useRoute } from '@react-navigation/native';\nimport { v4 as uuidv4 } from 'uuid';\nimport BaseControlForm from '../components/BaseControlForm';\nimport { auth, logCompanyActivity, saveControlToFirestore, saveDraftToFirestore } from '../components/firebase';\nimport { formatPersonName } from '../components/formatPersonName';\n\nconst LABELS = {\n  title: 'Mottagningskontroll',\n  saveButton: 'Spara',\n  saveDraftButton: 'Spara och slutför senare',\n};\n\nexport default function MottagningskontrollScreen({\n  date,\n  participants = [],\n  project: projectProp,\n  initialValues: initialValuesProp,\n  onExit,\n  onFinished,\n}) {\n  const route = useRoute();\n  const project = projectProp ?? route.params?.project;\n  const initialValues = (initialValuesProp ?? route.params?.initialValues) || undefined;\n\n  const handleSave = async (data) => {\n    try {\n      // Use existing id if present, otherwise create new\n      const controlId = data.id || uuidv4();\n      const completed = normalizeControl({ ...data, project, status: 'UTFÖRD', savedAt: new Date().toISOString(), id: controlId });\n      try {\n        const ok = await saveControlToFirestore(completed);\n        if (!ok) throw new Error('Firestore save failed');\n      } catch(e) {\n        const completedRaw = await AsyncStorage.getItem('completed_controls');\n        let completedList = completedRaw ? JSON.parse(completedRaw) : [];\n        // Remove all previous versions (by id if present, else by project+type+savedAt)\n        let filteredControls = completedList.filter((c) => {\n          if (data.id || completed.id) {\n            // Remove all with same id\n            return c.id !== (data.id || completed.id);\n          } else {\n            // Remove all with same project+type+savedAt\n            return !(\n              c.project === data.project &&\n              c.type === data.type &&\n              c.savedAt === data.savedAt\n            );\n          }\n        });\n        filteredControls.push(completed);\n        await AsyncStorage.setItem('completed_controls', JSON.stringify(filteredControls));\n      }\n      // Log activity (best-effort) with actor name\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: completed.type || 'Kontroll',\n          kind: 'completed',\n          projectId: completed.project?.id || null,\n          projectName: completed.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n        });\n      } catch(_e) {}\n      // Remove matching draft if exists\n      try {\n        const draftRaw = await AsyncStorage.getItem('draft_controls');\n        if (draftRaw) {\n          let drafts = JSON.parse(draftRaw) || [];\n          drafts = drafts.filter(d => !(d.project?.id === project?.id && d.type === 'Mottagningskontroll' && (d.id === data.id || d.id === controlId)));\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\n        }\n      } catch(e) {}\n    } catch(e) {\n      // Hantera fel\n    }\n  };\n\n  const handleSaveDraft = async (data) => {\n    try {\n      const draft = normalizeControl({ ...data, project, status: 'UTKAST', savedAt: new Date().toISOString(), type: 'Mottagningskontroll', id: data.id || uuidv4() });\n      try {\n        const ok = await saveDraftToFirestore(draft);\n        if (!ok) throw new Error('Firestore draft save failed');\n      } catch(e) {\n        let arr = [];\n        const existing = await AsyncStorage.getItem('draft_controls');\n        if (existing) arr = JSON.parse(existing);\n        // Ersätt om samma projekt+typ+id redan finns, annars lägg till\n        const idx = arr.findIndex(\n          c => c.project?.id === project?.id && c.type === 'Mottagningskontroll' && c.id === draft.id\n        );\n        if (idx !== -1) {\n          arr[idx] = draft;\n        } else {\n          arr.push(draft);\n        }\n        await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\n      }\n      // Log draft saved activity\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: draft.type || 'Kontroll',\n          kind: 'draft',\n          projectId: draft.project?.id || null,\n          projectName: draft.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n        });\n      } catch(_e) {}\n    } catch(e) {\n      // Hantera fel\n    }\n  };\n\n  // Ensure control object has new fields and migrate legacy ones where possible\n  function normalizeControl(obj) {\n    const c = { ...obj };\n    // Ensure fields exist\n    c.materialDesc = c.materialDesc || c.material || '';\n    c.qualityDesc = c.qualityDesc || '';\n    c.coverageDesc = c.coverageDesc || '';\n    // Migrate legacy single-signature uri to signatures array\n    if (c.mottagningsSignature && !c.mottagningsSignatures) {\n      // if it's boolean true without uri, leave empty\n      c.mottagningsSignatures = [];\n    }\n    if (!c.mottagningsSignatures) c.mottagningsSignatures = [];\n    if (c.mottagningsSignatureUri && (!c.mottagningsSignatures || c.mottagningsSignatures.length === 0)) {\n      c.mottagningsSignatures = [{ name: 'Signerad', uri: c.mottagningsSignatureUri }];\n    }\n    // Ensure checklist exists\n    if (!Array.isArray(c.checklist)) c.checklist = [];\n    return c;\n  }\n\n  return (\n    <BaseControlForm\n      project={project}\n      date={date}\n      participants={participants}\n      labels={LABELS}\n      onSave={handleSave}\n      onSaveDraft={handleSaveDraft}\n      initialValues={initialValues}\n      controlType=\"Mottagningskontroll\"\n      onExit={onExit}\n      onFinished={onFinished}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ProjectControlsList.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/ProjectDetails.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":53,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":85,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":73},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":97,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":125,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":125,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":141,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":141,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":162,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":162,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":169,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":169,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":319,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":319,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":352,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":352,"endColumn":26},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":364,"column":24,"nodeType":"Identifier","messageId":"undef","endLine":364,"endColumn":40},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":394,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":394,"endColumn":22},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":395,"column":103,"nodeType":"Identifier","messageId":"undef","endLine":395,"endColumn":106},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":398,"column":69,"nodeType":"Identifier","messageId":"undef","endLine":398,"endColumn":85},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":442,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":442,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":472,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":472,"endColumn":24},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":481,"column":64,"nodeType":"Identifier","messageId":"undef","endLine":481,"endColumn":80},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":508,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":508,"endColumn":20},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":509,"column":108,"nodeType":"Identifier","messageId":"undef","endLine":509,"endColumn":111},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":512,"column":67,"nodeType":"Identifier","messageId":"undef","endLine":512,"endColumn":83},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":559,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":559,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":573,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":573,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'inlineControl' and 'route?.params?.onInlineLockChange'. Either include them or remove the dependency array.","line":574,"column":6,"nodeType":"ArrayExpression","endLine":574,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [inlineControl, inlineControl.type, route?.params?.onInlineLockChange]","fix":{"range":[28564,28585],"text":"[inlineControl, inlineControl.type, route?.params?.onInlineLockChange]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":590,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":590,"endColumn":98},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":592,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":592,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'openInlineControl' and 'selectedAction'. Either include them or remove the dependency array.","line":593,"column":6,"nodeType":"ArrayExpression","endLine":593,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [openInlineControl, selectedAction, selectedAction.id]","fix":{"range":[29448,29468],"text":"[openInlineControl, selectedAction, selectedAction.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":677,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":677,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":689,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":689,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'project'. Either include it or remove the dependency array.","line":728,"column":6,"nodeType":"ArrayExpression","endLine":728,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [project, project?.id]","fix":{"range":[34608,34621],"text":"[project, project?.id]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showControlPicker' is assigned a value but never used.","line":729,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":729,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"showControlPicker"},"fix":{"range":[34633,34650],"text":""},"desc":"Remove unused variable 'showControlPicker'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setShowControlPicker' is assigned a value but never used.","line":729,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":729,"endColumn":49,"suggestions":[{"messageId":"removeVar","data":{"varName":"setShowControlPicker"},"fix":{"range":[34650,34672],"text":""},"desc":"Remove unused variable 'setShowControlPicker'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'selectedControls' is assigned a value but never used.","line":735,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":735,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedControls"},"fix":{"range":[35029,35045],"text":""},"desc":"Remove unused variable 'selectedControls'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setSelectedControls' is assigned a value but never used.","line":735,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":735,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSelectedControls"},"fix":{"range":[35045,35066],"text":""},"desc":"Remove unused variable 'setSelectedControls'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'expandedType' is assigned a value but never used.","line":736,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":736,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"expandedType"},"fix":{"range":[35093,35105],"text":""},"desc":"Remove unused variable 'expandedType'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setExpandedType' is assigned a value but never used.","line":736,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":736,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setExpandedType"},"fix":{"range":[35105,35122],"text":""},"desc":"Remove unused variable 'setExpandedType'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setUndoState' is assigned a value but never used.","line":737,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":737,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"setUndoState"},"fix":{"range":[35160,35174],"text":""},"desc":"Remove unused variable 'setUndoState'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setCompanyLogoUri' is assigned a value but never used.","line":738,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":738,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCompanyLogoUri"},"fix":{"range":[35254,35273],"text":""},"desc":"Remove unused variable 'setCompanyLogoUri'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":780,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":780,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":793,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":793,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":810,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":810,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'selectedControl' is assigned a value but never used.","line":1003,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1003,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedControl"},"fix":{"range":[44694,44709],"text":""},"desc":"Remove unused variable 'selectedControl'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showControlOptions' is assigned a value but never used.","line":1004,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1004,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"showControlOptions"},"fix":{"range":[44758,44776],"text":""},"desc":"Remove unused variable 'showControlOptions'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'undoTimerRef' is assigned a value but never used.","line":1007,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1007,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"undoTimerRef"},"fix":{"range":[44970,45004],"text":""},"desc":"Remove unused variable 'undoTimerRef'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1057,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":1057,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1074,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":1074,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1111,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":1111,"endColumn":84},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1122,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":1122,"endColumn":79},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1162,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1162,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2331,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":2331,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'allHandled' is assigned a value but never used.","line":2347,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2347,"endColumn":27},{"ruleId":"no-unused-vars","severity":1,"message":"'anyDeviation' is assigned a value but never used.","line":2348,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2348,"endColumn":29},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2372,"column":88,"nodeType":"Identifier","messageId":"unusedVar","endLine":2372,"endColumn":89},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2421,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":2421,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2566,"column":98,"nodeType":"Identifier","messageId":"unusedVar","endLine":2566,"endColumn":99},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2592,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":2592,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2620,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":2620,"endColumn":54},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":2630,"column":50,"nodeType":"Identifier","messageId":"undef","endLine":2630,"endColumn":66},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2662,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":2662,"endColumn":48},{"ruleId":"no-undef","severity":2,"message":"'err' is not defined.","line":2663,"column":120,"nodeType":"Identifier","messageId":"undef","endLine":2663,"endColumn":123},{"ruleId":"no-undef","severity":2,"message":"'buildSummaryHtml' is not defined.","line":2667,"column":53,"nodeType":"Identifier","messageId":"undef","endLine":2667,"endColumn":69},{"ruleId":"no-undef","severity":2,"message":"'companyNameForPdf' is not defined.","line":2669,"column":119,"nodeType":"Identifier","messageId":"undef","endLine":2669,"endColumn":136},{"ruleId":"no-undef","severity":2,"message":"'handleAddControl' is not defined.","line":2797,"column":64,"nodeType":"Identifier","messageId":"undef","endLine":2797,"endColumn":80},{"ruleId":"no-undef","severity":2,"message":"'handleUndo' is not defined.","line":2809,"column":38,"nodeType":"Identifier","messageId":"undef","endLine":2809,"endColumn":48}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":50,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport MaterialIcons from '@expo/vector-icons/MaterialIcons';\nimport { Asset } from 'expo-asset';\nimport * as Haptics from 'expo-haptics';\nimport * as Print from 'expo-print';\nimport * as Sharing from 'expo-sharing';\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport {\n    Animated,\n    Easing,\n    Image,\n    KeyboardAvoidingView,\n    Modal,\n    Platform,\n    Pressable,\n    ScrollView,\n    StyleSheet,\n    Switch,\n    Text,\n    TextInput,\n    TouchableOpacity,\n    View\n} from 'react-native';\nimport Svg, { Circle, Text as SvgText } from 'react-native-svg';\nimport { formatPersonName } from '../components/formatPersonName';\nimport { buildPdfHtmlForControl } from '../components/pdfExport';\nimport { emitProjectUpdated } from '../components/projectBus';\n\nimport ArbetsberedningScreen from './ArbetsberedningScreen';\nimport ControlDetails from './ControlDetails';\nimport EgenkontrollScreen from './EgenkontrollScreen';\nimport FuktmätningScreen from './FuktmätningScreen';\nimport MottagningskontrollScreen from './MottagningskontrollScreen';\nimport RiskbedömningScreen from './RiskbedömningScreen';\nimport SkyddsrondScreen from './SkyddsrondScreen';\n\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { CompanyHeaderLogo, DigitalKontrollHeaderLogo, HomeHeaderSearch } from '../components/HeaderComponents';\nimport { DEFAULT_CONTROL_TYPES, deleteControlFromFirestore, deleteDraftControlFromFirestore, fetchCompanyControlTypes, fetchCompanyMallar, fetchCompanyMembers, fetchCompanyProfile, fetchControlsForProject, fetchDraftControlsForProject } from '../components/firebase';\n// Note: `expo-file-system` is used only on native; avoid static top-level import\n// so web builds don't attempt to resolve native-only exports. Load dynamically\n// inside functions when needed.\nlet FileSystem = null;\n\n// Utility: read a file URI as base64 if possible\nasync function readUriAsBase64(uri) {\n  if (!uri) return null;\n  try {\n    // Dynamically load FileSystem only when running in an environment that supports it\n    if (!FileSystem) {\n      try {\n        FileSystem = await import('expo-file-system');\n      } catch (e) {\n        FileSystem = null;\n      }\n    }\n    // If already a data URI, strip prefix and return raw base64\n    if (typeof uri === 'string' && uri.startsWith('data:')) {\n      const parts = uri.split(',');\n      return parts[1] || null;\n    }\n    const encodingOption = (FileSystem && FileSystem.EncodingType && FileSystem.EncodingType.Base64) ? FileSystem.EncodingType.Base64 : 'base64';\n    if (!FileSystem || typeof FileSystem.readAsStringAsync !== 'function') return null;\n    const b = await FileSystem.readAsStringAsync(uri, { encoding: encodingOption });\n    return b;\n  } catch(e) {\n    console.warn('[PDF] readUriAsBase64 failed for', uri, e);\n    return null;\n  }\n}\n\n// Try to convert an image URI (file:// or http(s)) to a data URI (base64). Returns original uri on failure.\nasync function toDataUri(uri) {\n  if (!uri) return uri;\n  try {\n    if (typeof uri === 'string' && uri.startsWith('data:')) return uri;\n    // Try direct read (works for file:// and sometimes cached local URIs)\n    const b = await readUriAsBase64(uri);\n    if (b) return 'data:image/jpeg;base64,' + b;\n    // If http(s), try download to cache and read\n    if (/^https?:\\/\\//i.test(uri)) {\n      try {\n        // Ensure FileSystem is available\n        if (!FileSystem) {\n          try { FileSystem = await import('expo-file-system'); } catch(e) { FileSystem = null; }\n        }\n        const fileName = 'pdf-img-' + (Math.random().toString(36).slice(2, 9)) + '.jpg';\n        const baseDir = (FileSystem && (FileSystem.cacheDirectory || FileSystem.documentDirectory)) ? (FileSystem.cacheDirectory || FileSystem.documentDirectory) : null;\n        if (baseDir && FileSystem && typeof FileSystem.downloadAsync === 'function') {\n          const dest = baseDir + fileName;\n          const dl = await FileSystem.downloadAsync(uri, dest);\n          if (dl && dl.uri) {\n            const b2 = await readUriAsBase64(dl.uri);\n            if (b2) return 'data:image/jpeg;base64,' + b2;\n          }\n        }\n      } catch(e) {}\n    }\n  } catch(e) {\n    console.warn('[PDF] toDataUri failed for', uri, e);\n  }\n  return uri;\n}\n\n// Embed images (photos/signatures/checklist photos) in a control object by converting URIs to data URIs where possible.\nasync function embedImagesInControl(ctrl) {\n  if (!ctrl || typeof ctrl !== 'object') return ctrl;\n  const c = JSON.parse(JSON.stringify(ctrl));\n  try {\n    // Mottagnings photos / photos\n    const photoFields = ['mottagningsPhotos', 'photos'];\n    for (const field of photoFields) {\n      if (Array.isArray(c[field]) && c[field].length > 0) {\n        const mapped = await Promise.all(c[field].map(async (p) => {\n          try {\n            if (!p) return p;\n            if (typeof p === 'string') {\n              const d = await toDataUri(p);\n              return d || p;\n            }\n            // object with uri and comment\n            const src = p.uri || p;\n            const d = await toDataUri(src);\n            return Object.assign({}, p, { uri: d || src });\n          } catch(e) { return p; }\n        }));\n        c[field] = mapped;\n      }\n    }\n\n    // Signatures\n    if (Array.isArray(c.mottagningsSignatures) && c.mottagningsSignatures.length > 0) {\n      const sigs = await Promise.all(c.mottagningsSignatures.map(async (s) => {\n        try {\n          if (!s) return s;\n          if (s.uri) {\n            const d = await toDataUri(s.uri);\n            return Object.assign({}, s, { uri: d || s.uri });\n          }\n          return s;\n        } catch(e) { return s; }\n      }));\n      c.mottagningsSignatures = sigs;\n    }\n\n    // Checklist photos (sections -> photos arrays)\n    if (Array.isArray(c.checklist) && c.checklist.length > 0) {\n      for (let si = 0; si < c.checklist.length; si++) {\n        const sec = c.checklist[si];\n        if (!sec) continue;\n        if (Array.isArray(sec.photos) && sec.photos.length > 0) {\n          const newPhotos = await Promise.all(sec.photos.map(async (entry) => {\n            if (!entry) return entry;\n            // entry might be array of uris or single uri/object\n            if (Array.isArray(entry)) {\n              return await Promise.all(entry.map(async (it) => {\n                try {\n                  if (!it) return it;\n                  const src = it.uri || it;\n                  const d = await toDataUri(src);\n                  return (typeof it === 'string') ? (d || src) : Object.assign({}, it, { uri: d || src });\n                } catch(e) { return it; }\n              }));\n            }\n            try {\n              const src = entry.uri || entry;\n              const d = await toDataUri(src);\n              return (typeof entry === 'string') ? (d || src) : Object.assign({}, entry, { uri: d || src });\n            } catch(e) { return entry; }\n          }));\n          c.checklist[si].photos = newPhotos;\n        }\n      }\n    }\n  } catch(e) {\n    console.warn('[PDF] embedImagesInControl failed', e);\n  }\n  return c;\n}\n\nfunction getWeekAndYear(dateInput) {\n  const d = dateInput ? new Date(dateInput) : new Date();\n  if (isNaN(d)) return { week: '', year: '' };\n  d.setHours(0,0,0,0);\n  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));\n  const week1 = new Date(d.getFullYear(), 0, 4);\n  const weekNo = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);\n  return { week: weekNo, year: d.getFullYear() };\n}\n\nfunction isValidIsoDateYmd(value) {\n  const v = String(value || '').trim();\n  if (!v) return true;\n  if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(v)) return false;\n  const [yStr, mStr, dStr] = v.split('-');\n  const y = Number(yStr);\n  const m = Number(mStr);\n  const d = Number(dStr);\n  if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return false;\n  if (m < 1 || m > 12) return false;\n  if (d < 1 || d > 31) return false;\n  const dt = new Date(Date.UTC(y, m - 1, d));\n  return dt.getUTCFullYear() === y && (dt.getUTCMonth() + 1) === m && dt.getUTCDate() === d;\n}\n\nconst styles = StyleSheet.create({\n  container: { flex: 1, padding: 16, backgroundColor: '#fff' },\n  subtitle: { fontSize: 18, fontWeight: '600', marginBottom: 8 },\n  noControls: { fontSize: 16, fontStyle: 'italic', marginBottom: 12 },\n  groupContainer: { marginBottom: 18, backgroundColor: '#f7f7f7', borderRadius: 10, padding: 8 },\n  groupHeader: { flexDirection: 'row', alignItems: 'center', flexWrap: 'nowrap', paddingVertical: 8, paddingHorizontal: 4 },\n  groupTitle: { fontSize: 16, fontWeight: '700', marginLeft: 6, color: '#263238', flexShrink: 1 },\n  groupBadge: { backgroundColor: '#1976D2', borderRadius: 12, paddingHorizontal: 8, marginLeft: 8 },\n  groupBadgeText: { color: '#fff', fontWeight: '700', fontSize: 13 },\n  controlCard: { backgroundColor: '#fff', borderRadius: 8, padding: 10, marginVertical: 4, borderWidth: 1, borderColor: '#e0e0e0', minHeight: 54, flexDirection: 'row', alignItems: 'center' },\n  controlCardWeb: { width: '100%', flex: 1, alignSelf: 'stretch', paddingVertical: 4, paddingHorizontal: 10, minHeight: 40, marginVertical: 2 },\n  controlTextContainer: { flexDirection: 'column', flex: 1, minWidth: 0 },\n  controlTextContainerWeb: { flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 },\n  controlLine: { flexShrink: 1 },\n  controlTitle: { fontSize: 15, color: '#222', fontWeight: 'bold', flexShrink: 1 },\n  controlTitleInlineWeb: { fontSize: 14, color: '#222', fontWeight: '400' },\n  controlSubtitle: { color: '#555', fontSize: 13, marginTop: 4, flexShrink: 1 },\n  controlSubtitleInline: { color: '#555', fontSize: 12, fontWeight: '400' },\n  form: { backgroundColor: '#fff', borderRadius: 12, padding: 16, margin: 12 },\n  selectedType: { fontWeight: '700', fontSize: 16, marginBottom: 8 },\n  infoText: { fontSize: 14, color: '#555', marginBottom: 8 },\n  linkText: { color: '#1976D2', fontSize: 14, marginBottom: 8 },\n  input: { backgroundColor: '#f5f5f5', borderRadius: 8, padding: 10, fontSize: 15, marginBottom: 8, borderWidth: 1, borderColor: '#e0e0e0' },\n  saveButton: { backgroundColor: '#1976D2', borderRadius: 8, padding: 12, alignItems: 'center', marginTop: 8 },\n  saveButtonText: { color: '#fff', fontWeight: '700', fontSize: 16 },\n  cancelButton: { backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, alignItems: 'center', marginTop: 8 },\n  cancelText: { color: '#222', fontWeight: '600', fontSize: 16 },\n  undoBar: { backgroundColor: '#fffbe6', borderRadius: 8, padding: 10, margin: 12, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' },\n  undoText: { color: '#222', fontSize: 15 },\n  undoButtonText: { color: '#1976D2', fontWeight: '700', fontSize: 15 },\n  noticeBar: { backgroundColor: '#e3f2fd', borderRadius: 8, padding: 10, margin: 12 },\n  noticeText: { color: '#1976D2', fontSize: 15, textAlign: 'center' },\n  summaryCard: { backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 },\n  modalText: { fontSize: 20, fontWeight: '600', marginBottom: 18, color: '#222', textAlign: 'center', marginTop: 6 },\n  filterRow: { flexDirection: 'row', flexWrap: 'wrap', marginVertical: 8 },\n  filterChip: { backgroundColor: '#e0e0e0', borderRadius: 16, paddingHorizontal: 12, paddingVertical: 6, marginRight: 8, marginBottom: 8 },\n  filterChipSelected: { backgroundColor: '#1976D2' },\n  filterChipText: { color: '#222', fontSize: 14 },\n  filterChipTextSelected: { color: '#fff', fontWeight: '700' },\n  centerOverlay: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.25)' },\n});\n\nexport default function ProjectDetails({ route, navigation, inlineClose, refreshNonce }) {\n              const [showControlTypeModal, setShowControlTypeModal] = useState(false);\n            const [showDeleteModal, setShowDeleteModal] = useState(false);\n            const [showDeleteWarning, setShowDeleteWarning] = useState(false);\n            const [controlTypeScrollMetrics, setControlTypeScrollMetrics] = useState({\n              contentHeight: 0,\n              containerHeight: 0,\n              scrollY: 0,\n            });\n\n            const controlTypeCanScroll = controlTypeScrollMetrics.contentHeight > (controlTypeScrollMetrics.containerHeight + 1);\n            let controlTypeThumbHeight = 0;\n            let controlTypeThumbTop = 0;\n            if (controlTypeCanScroll) {\n              const { containerHeight, contentHeight, scrollY } = controlTypeScrollMetrics;\n              const minThumb = 24;\n              const thumbHeightRaw = (containerHeight * containerHeight) / (contentHeight || 1);\n              const thumbHeight = Math.max(minThumb, isFinite(thumbHeightRaw) ? thumbHeightRaw : minThumb);\n              const maxThumbTop = Math.max(0, containerHeight - thumbHeight);\n              const scrollableDistance = Math.max(0, contentHeight - containerHeight);\n              const thumbTop = scrollableDistance > 0 ? (scrollY / scrollableDistance) * maxThumbTop : 0;\n              controlTypeThumbHeight = thumbHeight;\n              controlTypeThumbTop = thumbTop;\n            }\n          // Anpassa header så den beter sig som Home:\n          // - Web: behåll sökrutan och företagsloggan.\n          // - Native: visa bara DigitalKontroll-loggan centrerad, utan sökfält.\n          React.useEffect(() => {\n    const isWeb = Platform.OS === 'web';\n    if (isWeb) {\n      navigation.setOptions({\n        headerTitle: () => <HomeHeaderSearch navigation={navigation} route={navigation.getState?.().routes?.find(r => r.name === 'ProjectDetails') || { params: route?.params }} />,\n        headerLeft: () => (\n          <View style={{ paddingLeft: 0, height: '100%', justifyContent: 'center' }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerRight: () => (\n          <View style={{ paddingRight: 0, height: '100%', justifyContent: 'center' }}>\n            <CompanyHeaderLogo companyId={route?.params?.companyId || ''} />\n          </View>\n        ),\n        headerBackTitle: '',\n      });\n    } else {\n      navigation.setOptions({\n        headerTitle: () => (\n          <View style={{ marginBottom: 4, marginLeft: -28 }}>\n            <DigitalKontrollHeaderLogo />\n          </View>\n        ),\n        headerLeft: () => null,\n        headerRight: () => null,\n        headerBackTitle: '',\n      });\n    }\n  }, [navigation, route]);\n    // State för att låsa upp skapad-datum\n    const [canEditCreated, setCanEditCreated] = useState(false);\n        const handlePreviewPdf = async () => {\n          if (!controls || controls.length === 0) return;\n          setExportingPdf(true);\n          try {\n            try { Haptics.selectionAsync(); } catch {}\n\n            // Prefer company profile logo for PDF (MVP branding: only on print/PDF)\n            let profile = companyProfile;\n            if (!profile && companyId) {\n              try {\n                profile = await fetchCompanyProfile(companyId);\n                if (profile) setCompanyProfile(profile);\n              } catch(e) {}\n            }\n            const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\n            const companyLogoFromProfile = profile?.logoUrl || null;\n\n            // Try to use a local file path for the logo for better reliability\n            let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\n            if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\n              try {\n                const fileName = 'company-logo.preview.png';\n                const baseDir = (FileSystem && (FileSystem.cacheDirectory || FileSystem.documentDirectory)) ? (FileSystem.cacheDirectory || FileSystem.documentDirectory) : null;\n                if (baseDir) {\n                  const dest = baseDir + fileName;\n                  const dl = await FileSystem.downloadAsync(logoForPrint, dest);\n                  if (dl?.uri) logoForPrint = dl.uri;\n                }\n              } catch {}\n            }\n\n            // Convert logo to base64 (if possible) to avoid asset-loading issues\n            let logoBase64 = null;\n            try {\n              logoBase64 = await readUriAsBase64(logoForPrint);\n              if (!logoBase64) {\n                // Try bundled asset fallback\n                try {\n                  const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\n                  await Asset.loadAsync(a);\n                  const local = a.localUri || a.uri;\n                  if (local) {\n                    logoBase64 = await readUriAsBase64(local);\n                    if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\n                  }\n                } catch(e) {\n                  // ignore\n                }\n              } else {\n                logoForPrint = 'data:image/png;base64,' + logoBase64;\n              }\n            } catch(e) { console.warn('[PDF] logo base64 conversion failed', e); }\n\n            // Build HTML safely and log length to aid debugging blank PDFs\n            let html;\n            try {\n              if (typeof buildSummaryHtml === 'function') {\n                html = buildSummaryHtml(exportFilter, logoForPrint);\n              } else {\n                console.warn('[PDF] buildSummaryHtml not available, falling back to per-control builder');\n                const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\n                const preparedControls = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\n                html = (preparedControls || []).map(c => buildPdfHtmlForControl({ control: c, project, company: companyObj })).join('<div style=\"page-break-after:always\"></div>');\n              }\n            } catch (hErr) {\n              console.error('[PDF] error while building HTML for preview', hErr);\n              html = null;\n            }\n\n            console.log('[PDF] preview HTML length:', html ? String(html).length : 0);\n            if (!html || String(html).trim().length < 20) throw new Error('Empty or too-small HTML');\n\n            try {\n              const fileResult = await Print.printToFileAsync({ html });\n              const pdfUri = fileResult?.uri;\n              if (pdfUri) {\n                try {\n                  const avail = await Sharing.isAvailableAsync();\n                  if (avail) await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\n                  else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\n                } catch (shareErr) {\n                  console.warn('[PDF] shareAsync failed, opening print dialog as fallback', shareErr);\n                  await Print.printAsync({ uri: pdfUri });\n                }\n              } else {\n                throw new Error('printToFileAsync returned no uri');\n              }\n            } catch(e) {\n              console.warn('[PDF] printToFileAsync with logo/fallback failed, retrying without logo', err);\n              try {\n                let html2 = null;\n                if (typeof buildSummaryHtml === 'function') html2 = buildSummaryHtml(exportFilter, null);\n                else {\n                  const preparedControls2 = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\n                  html2 = (preparedControls2 || []).map(c => buildPdfHtmlForControl({ control: c, project, company: { name: companyNameForPdf } })).join('<div style=\"page-break-after:always\"></div>');\n                }\n                console.log('[PDF] retry HTML length:', html2 ? String(html2).length : 0);\n                if (!html2 || String(html2).trim().length < 20) throw new Error('Empty retry HTML');\n                const fileResult2 = await Print.printToFileAsync({ html: html2 });\n                const pdfUri2 = fileResult2?.uri;\n                if (pdfUri2) {\n                  try {\n                    const avail2 = await Sharing.isAvailableAsync();\n                    if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\n                    else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\n                  } catch (shareErr2) {\n                    console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\n                    await Print.printAsync({ uri: pdfUri2 });\n                  }\n                } else {\n                  throw new Error('printToFileAsync retry returned no uri');\n                }\n              } catch (err2) { throw err2; }\n            }\n          } catch(e) {\n            console.error('[PDF] Preview error:', e);\n            setNotice({ visible: true, text: 'Kunde inte förhandsvisa PDF' });\n            setTimeout(() => setNotice({ visible: false, text: '' }), 4000);\n          } finally {\n            setExportingPdf(false);\n          }\n        };\n      // PDF export-funktion\n      const handleExportPdf = async () => {\n        if (!controls || controls.length === 0) return;\n        setExportingPdf(true);\n        try {\n          try { Haptics.selectionAsync(); } catch {}\n\n          // Prefer company profile logo for PDF (MVP branding: only on print/PDF)\n          let profile = companyProfile;\n          if (!profile && companyId) {\n            try {\n              profile = await fetchCompanyProfile(companyId);\n              if (profile) setCompanyProfile(profile);\n            } catch(e) {}\n          }\n          const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\n          const companyLogoFromProfile = profile?.logoUrl || null;\n\n          let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\n          if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\n            try {\n                const fileName = 'company-logo.export.png';\n              const baseDir = (FileSystem && (FileSystem.cacheDirectory || FileSystem.documentDirectory)) ? (FileSystem.cacheDirectory || FileSystem.documentDirectory) : null;\n              if (baseDir) {\n                const dest = baseDir + fileName;\n                const dl = await FileSystem.downloadAsync(logoForPrint, dest);\n                if (dl?.uri) logoForPrint = dl.uri;\n              }\n            } catch {}\n          }\n          // Try to convert logo to base64 for embedding\n          let logoBase64 = null;\n          try {\n            logoBase64 = await readUriAsBase64(logoForPrint);\n            if (!logoBase64) {\n              try {\n                const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\n                await Asset.loadAsync(a);\n                const local = a.localUri || a.uri;\n                if (local) {\n                  logoBase64 = await readUriAsBase64(local);\n                  if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\n                }\n              } catch(e) {}\n            } else {\n              logoForPrint = 'data:image/png;base64,' + logoBase64;\n            }\n          } catch(e) { console.warn('[PDF] logo base64 conversion failed', e); }\n\n          // Bygg HTML för export (alla eller filtrerat) — säkrare bygg och logg\n          let html;\n          try {\n            if (typeof buildSummaryHtml === 'function') html = buildSummaryHtml(exportFilter, logoForPrint);\n            else {\n                const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\n                const preparedControls = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\n              html = (preparedControls || []).map(c => buildPdfHtmlForControl({ control: c, project, company: companyObj })).join('<div style=\"page-break-after:always\"></div>');\n            }\n          } catch (hErr) {\n            console.error('[PDF] error while building HTML for export', hErr);\n            html = null;\n          }\n          console.log('[PDF] export HTML length:', html ? String(html).length : 0);\n          try {\n            if (!html || String(html).trim().length < 20) throw new Error('Empty export HTML');\n            const fileResult = await Print.printToFileAsync({ html });\n            const pdfUri = fileResult?.uri;\n            if (pdfUri) {\n              try {\n                const avail = await Sharing.isAvailableAsync();\n                if (avail) await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\n                else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\n              } catch (shareErr) {\n                console.warn('[PDF] shareAsync failed, falling back to open print dialog', shareErr);\n                await Print.printAsync({ uri: pdfUri });\n              }\n            } else {\n              throw new Error('printToFileAsync returned no uri');\n            }\n          } catch(e) {\n            console.warn('[PDF] printToFileAsync with logo failed or HTML invalid, retrying without logo', err);\n            try {\n              let html2 = null;\n              if (typeof buildSummaryHtml === 'function') html2 = buildSummaryHtml(exportFilter, null);\n              else {\n                const preparedControls2 = await Promise.all((controls || []).map(c => embedImagesInControl(c)));\n                html2 = (preparedControls2 || []).map(c => buildPdfHtmlForControl({ control: c, project, company: { name: companyNameForPdf } })).join('<div style=\"page-break-after:always\"></div>');\n              }\n              console.log('[PDF] retry export HTML length:', html2 ? String(html2).length : 0);\n              if (!html2 || String(html2).trim().length < 20) throw new Error('Empty retry export HTML');\n              const fileResult2 = await Print.printToFileAsync({ html: html2 });\n              const pdfUri2 = fileResult2?.uri;\n              if (pdfUri2) {\n                try {\n                  const avail2 = await Sharing.isAvailableAsync();\n                  if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\n                  else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\n                } catch (shareErr2) {\n                  console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\n                  await Print.printAsync({ uri: pdfUri2 });\n                }\n              } else {\n                throw new Error('printToFileAsync retry returned no uri');\n              }\n            } catch (err2) { throw err2; }\n          }\n          setNotice({ visible: true, text: 'PDF genererad' });\n          setTimeout(() => setNotice({ visible: false, text: '' }), 3000);\n        } catch(e) {\n          console.error('[PDF] Export error:', e);\n          setNotice({ visible: true, text: 'Kunde inte exportera PDF' });\n          setTimeout(() => setNotice({ visible: false, text: '' }), 4000);\n        } finally {\n          setExportingPdf(false);\n        }\n      };\n    const [notice, setNotice] = useState({ visible: false, text: '' });\n    const scrollRef = useRef(null);\n  // Destructure navigation params\n  const { project, companyId, initialCreator, selectedAction } = route.params || {};\n  const [inlineControl, setInlineControl] = useState(null);\n  const openInlineControl = (type, initialValues) => {\n    if (!type) return;\n    // Freeze the project snapshot at time of opening so the form can't \"jump\"\n    // if parent selection changes.\n    setInlineControl({ type, initialValues: initialValues || undefined, projectSnapshot: project || null });\n    try {\n      if (scrollRef?.current && typeof scrollRef.current.scrollTo === 'function') {\n        scrollRef.current.scrollTo({ y: 0, animated: false });\n      }\n    } catch(e) {}\n  };\n  const closeInlineControl = () => setInlineControl(null);\n\n  // Inform parent (HomeScreen) when an inline FORM is open on web.\n  // This is used to lock the project tree so the user can't switch projects mid-control.\n  useEffect(() => {\n    try {\n      const isWeb = Platform.OS === 'web';\n      const isInlineFormOpen = isWeb && !!(inlineControl && inlineControl.type && inlineControl.type !== 'ControlDetails');\n      const cb = route?.params?.onInlineLockChange;\n      // Backwards-compatible: allow both prop injection patterns\n      // 1) route.params.onInlineLockChange (if parent can't pass real props)\n      if (typeof cb === 'function') cb(isInlineFormOpen);\n    } catch(e) {}\n  }, [inlineControl?.type]);\n\n  // When HomeScreen passes a selectedAction (e.g. open a draft from the dashboard),\n  // process it once and open the corresponding inline control.\n  const lastProcessedActionIdRef = useRef('');\n  useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    const id = selectedAction && selectedAction.id ? String(selectedAction.id) : '';\n    if (!id) return;\n    if (lastProcessedActionIdRef.current === id) return;\n    lastProcessedActionIdRef.current = id;\n    try {\n      if (selectedAction.kind === 'openDraft' && selectedAction.type) {\n        openInlineControl(selectedAction.type, selectedAction.initialValues || undefined);\n      }\n      if (selectedAction.kind === 'openControlDetails' && selectedAction.control) {\n        try { openInlineControl('ControlDetails', { control: selectedAction.control }); } catch(e) {}\n      }\n    } catch(e) {}\n  }, [selectedAction?.id]);\n  const [adminPickerVisible, setAdminPickerVisible] = useState(false);\n  const [companyAdmins, setCompanyAdmins] = useState([]);\n  const [loadingCompanyAdmins, setLoadingCompanyAdmins] = useState(false);\n  const [companyAdminsError, setCompanyAdminsError] = useState(null);\n\n  useEffect(() => {\n    let cancelled = false;\n    const loadAdmins = async () => {\n      if (!adminPickerVisible) return;\n      if (!companyId) {\n        setCompanyAdmins([]);\n        setCompanyAdminsError('Saknar företag (companyId).');\n        return;\n      }\n\n      setLoadingCompanyAdmins(true);\n      setCompanyAdminsError(null);\n      try {\n        const members = await fetchCompanyMembers(companyId);\n        const admins = (Array.isArray(members) ? members : [])\n          .filter(m => String(m?.role || '').toLowerCase() === 'admin')\n          .slice()\n          .sort((a, b) => formatPersonName(a).localeCompare(formatPersonName(b), 'sv'));\n\n        if (!cancelled) setCompanyAdmins(admins);\n      } catch(e) {\n        if (!cancelled) {\n          setCompanyAdmins([]);\n          const msg = e?.code === 'permission-denied'\n            ? 'Behörighet saknas för att läsa admins.'\n            : 'Kunde inte ladda admins.';\n          setCompanyAdminsError(msg);\n        }\n      } finally {\n        if (!cancelled) setLoadingCompanyAdmins(false);\n      }\n    };\n\n    loadAdmins();\n    return () => {\n      cancelled = true;\n    };\n  }, [adminPickerVisible, companyId]);\n  const hasValidProject = !!(project && typeof project === 'object' && project.id);\n  const [controls, setControls] = useState([]);\n  // Sökfält för kontroller\n  const [searchText, setSearchText] = useState('');\n\n  // Ladda både utkast (pågående) och slutförda kontroller för projektet\n  const loadControls = useCallback(async () => {\n    if (!project?.id) return;\n    let allControls = [];\n    // Hämta utkast (pågående)\n    try {\n      const draftsRaw = await AsyncStorage.getItem('draft_controls');\n      if (draftsRaw) {\n        const drafts = JSON.parse(draftsRaw);\n        drafts.filter(d => d.project?.id === project.id).forEach(draft => {\n          allControls.push({ ...draft, isDraft: true });\n        });\n      }\n    } catch {}\n    // Hämta slutförda\n    try {\n      const completedRaw = await AsyncStorage.getItem('completed_controls');\n      if (completedRaw) {\n        const completed = JSON.parse(completedRaw);\n        completed.filter(c => c.project?.id === project.id).forEach(ctrl => {\n          allControls.push({ ...ctrl, isDraft: false });\n        });\n      }\n    } catch {}\n    // Try fetching from Firestore as well (merge remote completed controls)\n    try {\n      const remote = await fetchControlsForProject(project.id, companyId);\n      if (Array.isArray(remote) && remote.length > 0) {\n        remote.forEach(r => {\n          // avoid duplicates if already in allControls by id\n          if (!allControls.find(c => c.id && r.id && c.id === r.id)) {\n            allControls.push(Object.assign({}, r, { isDraft: false }));\n          }\n        });\n      }\n    } catch(e) { /* ignore Firestore errors - we already have local fallback */ }\n\n    // Fetch remote drafts too so a draft created in app can be finished on web\n    try {\n      const remoteDrafts = await fetchDraftControlsForProject(project.id, companyId);\n      if (Array.isArray(remoteDrafts) && remoteDrafts.length > 0) {\n        remoteDrafts.forEach(r => {\n          if (!allControls.find(c => c.id && r.id && c.id === r.id)) {\n            allControls.push(Object.assign({}, r, { isDraft: true }));\n          }\n        });\n      }\n    } catch(e) { /* ignore */ }\n    // Sort controls by date (prefer date || savedAt || createdAt) descending\n    allControls.sort((a,b) => {\n      const ta = new Date(a.date || a.savedAt || a.createdAt || 0).getTime() || 0;\n      const tb = new Date(b.date || b.savedAt || b.createdAt || 0).getTime() || 0;\n      return tb - ta;\n    });\n    setControls(allControls);\n  }, [project?.id, companyId]);\n\n  // Web: allow parent (HomeScreen header) to force-refresh the list.\n  useEffect(() => {\n    if (refreshNonce == null) return;\n    loadControls();\n  }, [refreshNonce, loadControls]);\n\n  // Ladda kontroller när sidan visas (fokus)\n  React.useEffect(() => {\n    const unsubscribe = navigation.addListener('focus', () => {\n      loadControls();\n    });\n    loadControls();\n    return unsubscribe;\n  }, [navigation, loadControls]);\n  const normalizeProject = (p) => {\n    if (!p || typeof p !== 'object') return p;\n    const formatted = formatPersonName(p.ansvarig || '');\n    if (!formatted || formatted === p.ansvarig) return p;\n    return { ...p, ansvarig: formatted };\n  };\n\n  const [editableProject, setEditableProject] = useState(() => normalizeProject(project));\n    // Store original id for update (keep up to date when route.project changes)\n    const [originalProjectId, setOriginalProjectId] = useState(project?.id || null);\n\n  // Update editableProject when parent passes a new project (e.g., selecting another project inline)\n  React.useEffect(() => {\n    setEditableProject(normalizeProject(project));\n    setOriginalProjectId(project?.id || null);\n  }, [project?.id]);\n  const [showControlPicker, setShowControlPicker] = useState(false);\n  const [showForm, setShowForm] = useState(false);\n  const [newControl, setNewControl] = useState({ type: '', date: '', description: '', byggdel: '' });\n  const [expandedByType, setExpandedByType] = useState({});\n  const [editingInfo, setEditingInfo] = useState(false);\n  const [showSummary, setShowSummary] = useState(false);\n  const [selectedControls, setSelectedControls] = useState([]);\n  const [expandedType, setExpandedType] = useState(null);\n  const [undoState, setUndoState] = useState({ visible: false, item: null, index: -1 });\n  const [companyLogoUri, setCompanyLogoUri] = useState(null);\n  const [companyProfile, setCompanyProfile] = useState(null);\n  const [skyddsrondWeeksPickerVisible, setSkyddsrondWeeksPickerVisible] = useState(false);\n  const [projectInfoExpanded, setProjectInfoExpanded] = useState(false);\n  const projectInfoSpin = useRef(new Animated.Value(0)).current;\n\n  const toggleProjectInfo = () => {\n    const next = !projectInfoExpanded;\n    setProjectInfoExpanded(next);\n    try {\n      Animated.timing(projectInfoSpin, {\n        toValue: next ? 1 : 0,\n        duration: 250,\n        easing: Easing.out(Easing.ease),\n        useNativeDriver: (Platform && Platform.OS === 'web') ? false : true,\n      }).start();\n    } catch (_e) {}\n  };\n\n  const projectInfoRotate = projectInfoSpin.interpolate({\n    inputRange: [0, 1],\n    outputRange: ['0deg', '180deg'],\n  });\n\n  const skyddsrondInfo = React.useMemo(() => {\n    const enabled = editableProject?.skyddsrondEnabled !== false;\n    const intervalWeeksRaw = Number(editableProject?.skyddsrondIntervalWeeks);\n    const intervalDaysRaw = Number(editableProject?.skyddsrondIntervalDays);\n    const intervalDays = (Number.isFinite(intervalWeeksRaw) && intervalWeeksRaw > 0)\n      ? (intervalWeeksRaw * 7)\n      : (Number.isFinite(intervalDaysRaw) && intervalDaysRaw > 0 ? intervalDaysRaw : 14);\n    const intervalWeeks = Math.max(1, Math.min(4, Math.round(intervalDays / 7) || 2));\n\n    const MS_DAY = 24 * 60 * 60 * 1000;\n    const now = Date.now();\n\n    const toMs = (v) => {\n      try {\n        if (!v) return 0;\n        if (typeof v === 'number') return v;\n        const t = new Date(v).getTime();\n        return Number.isFinite(t) ? t : 0;\n      } catch(e) {\n        return 0;\n      }\n    };\n\n    let lastMs = 0;\n    try {\n      (controls || []).forEach((c) => {\n        if (!c || c.isDraft) return;\n        if (c.type !== 'Skyddsrond') return;\n        const ts = toMs(c.date || c.savedAt || c.updatedAt || c.createdAt || null);\n        if (ts > lastMs) lastMs = ts;\n      });\n    } catch(e) {}\n\n    const createdMs = toMs(editableProject?.createdAt || null);\n    const firstDueMs = toMs(editableProject?.skyddsrondFirstDueDate || null);\n    const baselineMs = lastMs || createdMs || now;\n    const nextDueMs = lastMs\n      ? (baselineMs + intervalDays * MS_DAY)\n      : (firstDueMs || (baselineMs + intervalDays * MS_DAY));\n\n    const overdue = now > nextDueMs;\n    const daysUntil = Math.ceil((nextDueMs - now) / MS_DAY);\n    const soon = !overdue && Number.isFinite(daysUntil) && daysUntil <= 3;\n\n    const fmt = (ms) => {\n      try {\n        if (!ms) return '—';\n        return new Date(ms).toLocaleDateString('sv-SE');\n      } catch(e) {\n        return '—';\n      }\n    };\n\n    if (!enabled) {\n      return {\n        enabled: false,\n        intervalWeeks,\n        intervalDays,\n        lastLabel: lastMs ? fmt(lastMs) : 'Ingen registrerad',\n        nextLabel: fmt(nextDueMs),\n        overdue: false,\n        soon: false,\n      };\n    }\n\n    return {\n      enabled: true,\n      intervalWeeks,\n      intervalDays,\n      lastLabel: lastMs ? fmt(lastMs) : 'Ingen registrerad',\n      nextLabel: fmt(nextDueMs),\n      overdue,\n      soon,\n    };\n  }, [controls, editableProject?.createdAt, editableProject?.skyddsrondEnabled, editableProject?.skyddsrondIntervalWeeks, editableProject?.skyddsrondIntervalDays, editableProject?.skyddsrondFirstDueDate]);\n  // Kontrolltyper: använd samma company-specifika lista som HomeScreen\n  const [controlTypes, setControlTypes] = useState(DEFAULT_CONTROL_TYPES);\n\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      if (!companyId) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n        return;\n      }\n      try {\n        const list = await fetchCompanyControlTypes(companyId);\n        if (mounted && Array.isArray(list) && list.length > 0) {\n          setControlTypes(list);\n        } else if (mounted) {\n          setControlTypes(DEFAULT_CONTROL_TYPES);\n        }\n      } catch (_e) {\n        if (mounted) setControlTypes(DEFAULT_CONTROL_TYPES);\n      }\n    })();\n    return () => { mounted = false; };\n  }, [companyId]);\n\n  const controlTypeOptions = React.useMemo(() => {\n    const baseList = Array.isArray(controlTypes) && controlTypes.length > 0\n      ? controlTypes\n      : DEFAULT_CONTROL_TYPES;\n\n    // Om vi har custom-typer (från registret) använder vi den listan rätt upp och ned\n    // och bortser från äldre \"enabledControlTypes\" i companyProfile.\n    const hasCustomTypes = baseList.some(ct => ct && ct.builtin === false);\n\n    let visible = baseList.filter(ct => ct && ct.hidden !== true);\n\n    const enabled = companyProfile?.enabledControlTypes;\n    if (!hasCustomTypes && Array.isArray(enabled) && enabled.length > 0) {\n      const enabledSet = new Set(enabled.map(v => String(v || '').trim()).filter(Boolean));\n      visible = visible.filter((ct) => {\n        const name = String(ct.name || '').trim();\n        const key = String(ct.key || '').trim();\n        if (!enabledSet.size) return true;\n        return (name && enabledSet.has(name)) || (key && enabledSet.has(key));\n      });\n    }\n\n    return visible.map((ct) => ({\n      type: ct.name || ct.key || '',\n      key: ct.key || '',\n      icon: ct.icon || 'document-text-outline',\n      color: ct.color || '#455A64',\n    })).filter(o => o.type);\n  }, [controlTypes, companyProfile]);\n  const [templates, setTemplates] = useState([]);\n  const [templatePickerVisible, setTemplatePickerVisible] = useState(false);\n  const [templatePickerLabel, setTemplatePickerLabel] = useState('');\n  const [templatePickerItems, setTemplatePickerItems] = useState([]);\n  const [templatePickerSearch, setTemplatePickerSearch] = useState('');\n\n  useEffect(() => {\n    let cancelled = false;\n    (async () => {\n      try {\n        if (!companyId) {\n          if (!cancelled) setTemplates([]);\n          return;\n        }\n        const items = await fetchCompanyMallar(companyId).catch(() => []);\n        if (cancelled) return;\n        const list = Array.isArray(items) ? items : [];\n        // Filtrera bort mallar utan kontrolltyp; sortering sker redan i fetchCompanyMallar\n        const active = list.filter(tpl => String(tpl?.controlType || '').trim());\n        setTemplates(active);\n      } catch (_e) {\n        if (!cancelled) setTemplates([]);\n      }\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [companyId]);\n\n  const openTemplatePicker = (label, items) => {\n    setTemplatePickerLabel(label || '');\n    setTemplatePickerItems(Array.isArray(items) ? items : []);\n    setTemplatePickerSearch('');\n    setTemplatePickerVisible(true);\n  };\n\n  const handleStartControl = async (keyOrName, labelOverride) => {\n    const raw = String(keyOrName || '').trim();\n    const v = raw.toLowerCase();\n    const label = labelOverride || raw;\n\n    // Native: om det finns mallar för denna kontrolltyp, använd TemplateControlScreen\n    if (Platform.OS !== 'web') {\n      const relevantTemplates = (templates || []).filter((tpl) => {\n        const ct = String(tpl?.controlType || '').trim();\n        if (!ct) return false;\n        return ct === label;\n      });\n\n      if (relevantTemplates.length === 1) {\n        const tpl = relevantTemplates[0];\n        navigation.navigate('TemplateControlScreen', {\n          project,\n          controlType: label,\n          templateId: tpl.id,\n          template: tpl,\n          companyId,\n        });\n        return;\n      }\n\n      if (relevantTemplates.length > 1) {\n        openTemplatePicker(label, relevantTemplates);\n        return;\n      }\n    }\n\n    switch (v) {\n      case 'arbetsberedning':\n        if (Platform.OS === 'web') openInlineControl('Arbetsberedning');\n        else navigation.navigate('ArbetsberedningScreen', { project });\n        break;\n      case 'riskbedömning':\n      case 'riskbedomning':\n        if (Platform.OS === 'web') openInlineControl('Riskbedömning');\n        else navigation.navigate('RiskbedömningScreen', { project });\n        break;\n      case 'fuktmätning':\n      case 'fuktmatning':\n        if (Platform.OS === 'web') openInlineControl('Fuktmätning');\n        else navigation.navigate('FuktmätningScreen', { project });\n        break;\n      case 'egenkontroll':\n        if (Platform.OS === 'web') openInlineControl('Egenkontroll');\n        else navigation.navigate('EgenkontrollScreen', { project });\n        break;\n      case 'mottagningskontroll':\n        if (Platform.OS === 'web') openInlineControl('Mottagningskontroll');\n        else navigation.navigate('MottagningskontrollScreen', { project });\n        break;\n      case 'skyddsrond':\n        if (Platform.OS === 'web') openInlineControl('Skyddsrond');\n        else navigation.navigate('SkyddsrondScreen', { project });\n        break;\n      default:\n        {\n            const meta = (controlTypeOptions || []).find(o => (o.key && o.key.toLowerCase() === v) || o.type === label) || null;\n            const iconName = meta && meta.icon ? meta.icon : undefined;\n            const iconColor = meta && meta.color ? meta.color : undefined;\n            if (Platform.OS === 'web') {\n              openInlineControl(label);\n            } else {\n              navigation.navigate('ControlForm', {\n                project,\n                controlType: label,\n                controlIcon: iconName,\n                controlColor: iconColor,\n              });\n            }\n        }\n    }\n  };\n  const [exportFilter, setExportFilter] = useState('Alla');\n  const [selectedControl, setSelectedControl] = useState(null);\n  const [showControlOptions, setShowControlOptions] = useState(false);\n  const [exportingPdf, setExportingPdf] = useState(false);\n  const [deleteConfirm, setDeleteConfirm] = useState({ visible: false, control: null });\n  const undoTimerRef = useRef(null);\n  const [quickControlSlots, setQuickControlSlots] = useState(['', '', '', '']);\n  const [quickSlotConfigIndex, setQuickSlotConfigIndex] = useState(null);\n  const [showQuickSlotModal, setShowQuickSlotModal] = useState(false);\n  const quickSlotsLoadedRef = useRef(false);\n  // ...existing code...\n\n  // Prefetch company profile for PDF branding (logo/name) without affecting UI\n  React.useEffect(() => {\n    let active = true;\n    if (!companyId) {\n      setCompanyProfile(null);\n      return () => { active = false; };\n    }\n    fetchCompanyProfile(companyId)\n      .then((p) => { if (active) setCompanyProfile(p || null); })\n      .catch((e) => { /* ignore */ });\n    return () => { active = false; };\n  }, [companyId]);\n\n  // Load and persist per-user quick control button choices\n  const quickSlotsStorageKey = React.useMemo(() => {\n    const userKey = (initialCreator && (initialCreator.uid || initialCreator.id || initialCreator.email))\n      ? String(initialCreator.uid || initialCreator.id || initialCreator.email)\n      : 'local';\n    const companyKey = companyId ? String(companyId) : 'global';\n    return `quick_control_slots_${companyKey}_${userKey}`;\n  }, [companyId, initialCreator]);\n\n  React.useEffect(() => {\n    if (!controlTypeOptions || controlTypeOptions.length === 0) return;\n    if (quickSlotsLoadedRef.current) return;\n    let cancelled = false;\n    (async () => {\n      try {\n        const raw = await AsyncStorage.getItem(quickSlotsStorageKey);\n        if (cancelled) return;\n        if (raw) {\n          const arr = JSON.parse(raw);\n          if (Array.isArray(arr) && arr.length) {\n            setQuickControlSlots([\n              String(arr[0] || ''),\n              String(arr[1] || ''),\n              String(arr[2] || ''),\n              String(arr[3] || ''),\n            ]);\n            quickSlotsLoadedRef.current = true;\n            return;\n          }\n        }\n      } catch (e) {}\n      // No saved prefs: default to first four visible control types (store key when möjligt)\n      const defaults = (controlTypeOptions || []).slice(0, 4).map(o => o.key || o.type);\n      setQuickControlSlots([\n        defaults[0] || '',\n        defaults[1] || '',\n        defaults[2] || '',\n        defaults[3] || '',\n      ]);\n      quickSlotsLoadedRef.current = true;\n    })();\n    return () => { cancelled = true; };\n  }, [controlTypeOptions, quickSlotsStorageKey]);\n\n  const persistQuickSlots = React.useCallback(async (slots) => {\n    try {\n      await AsyncStorage.setItem(quickSlotsStorageKey, JSON.stringify(slots));\n    } catch (e) {}\n  }, [quickSlotsStorageKey]);\n\n  const openQuickSlotConfig = (index) => {\n    setQuickSlotConfigIndex(index);\n    setShowQuickSlotModal(true);\n  };\n\n  // Handler for long-press on a control\n  const handleControlLongPress = (control) => {\n    setSelectedControl(control);\n    setShowControlOptions(true);\n  };\n\n  // Handler for deleting selected control\n  const handleDeleteSelectedControl = async () => {\n    if (!deleteConfirm.control) return;\n    await actuallyDeleteControl(deleteConfirm.control);\n    setDeleteConfirm({ visible: false, control: null });\n    setShowControlOptions(false);\n    setSelectedControl(null);\n    loadControls && loadControls();\n  };\n\n  // Delete logic for a control (draft or completed)\n  const actuallyDeleteControl = async (control) => {\n    if (!control) return;\n    if (control.isDraft) {\n      // Remove from draft_controls\n      const draftsRaw = await AsyncStorage.getItem('draft_controls');\n      let drafts = draftsRaw ? JSON.parse(draftsRaw) : [];\n      drafts = drafts.filter(\n        c => c.id !== control.id\n      );\n      await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\n\n      // Best-effort: delete remote draft too\n      try { await deleteDraftControlFromFirestore(control.id, companyId); } catch(e) {}\n    } else {\n      // Remove from completed_controls\n      const completedRaw = await AsyncStorage.getItem('completed_controls');\n      let completed = completedRaw ? JSON.parse(completedRaw) : [];\n      completed = completed.filter(\n        c => c.id !== control.id\n      );\n      await AsyncStorage.setItem('completed_controls', JSON.stringify(completed));\n\n      // Best-effort: delete remote control too\n      try { await deleteControlFromFirestore(control.id, companyId); } catch(e) {}\n    }\n  };\n\n  // Huvud-UI return\n  if (!hasValidProject) {\n    return (\n      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 32 }}>\n        <Text style={{ fontSize: 18, color: '#D32F2F', textAlign: 'center' }}>\n          Kunde inte läsa projektdata.\n        </Text>\n        <Text style={{ fontSize: 14, color: '#888', marginTop: 8, textAlign: 'center' }}>\n          Projektet är inte korrekt laddat eller saknar ID.\n        </Text>\n        <TouchableOpacity\n          style={{ marginTop: 24, padding: 12, backgroundColor: '#1976D2', borderRadius: 8 }}\n          onPress={() => {\n            if (typeof inlineClose === 'function') inlineClose();\n            else navigation.goBack();\n          }}\n        >\n          <Text style={{ color: '#fff', fontWeight: '600' }}>Tillbaka</Text>\n        </TouchableOpacity>\n      </View>\n    );\n  }\n\n  // Web: keep header/tree and render control forms inside the right pane\n  if (Platform.OS === 'web' && inlineControl && inlineControl.type) {\n    const isInlineFormOpen = !!(inlineControl && inlineControl.type && inlineControl.type !== 'ControlDetails');\n\n    const handleInlineBack = () => {\n      // For forms: always route through the BaseControlForm exit-confirm flow\n      // so the user doesn't accidentally leave without saving/finishing.\n      if (isInlineFormOpen) {\n        try {\n          if (typeof window !== 'undefined' && window.dispatchEvent) {\n            window.dispatchEvent(new CustomEvent('dkInlineAttemptExit', { detail: { reason: 'headerBack' } }));\n            return;\n          }\n        } catch(e) {}\n      }\n\n      // For non-form inline views (e.g. ControlDetails), just go back to the project page.\n      closeInlineControl();\n    };\n\n    const getInlineHeaderMeta = () => {\n      const explicitType = String(inlineControl?.type || '').trim();\n      const detailsType = String(inlineControl?.initialValues?.control?.type || '').trim();\n      const type = (explicitType === 'ControlDetails' ? detailsType : explicitType) || explicitType;\n      const map = {\n        Arbetsberedning: { icon: 'construct-outline', color: '#1976D2', label: 'Arbetsberedning' },\n        Egenkontroll: { icon: 'checkmark-done-outline', color: '#388E3C', label: 'Egenkontroll' },\n        Fuktmätning: { icon: 'water-outline', color: '#0288D1', label: 'Fuktmätning' },\n        Mottagningskontroll: { icon: 'checkbox-outline', color: '#7B1FA2', label: 'Mottagningskontroll' },\n        Riskbedömning: { icon: 'warning-outline', color: '#FFD600', label: 'Riskbedömning' },\n        Skyddsrond: { icon: 'shield-half-outline', color: '#388E3C', label: 'Skyddsrond' },\n      };\n\n      const meta = map[type] || null;\n      if (meta) return meta;\n      if (type) return { icon: null, color: '#1976D2', label: type };\n      return { icon: null, color: '#1976D2', label: 'Kontrolldetaljer' };\n    };\n\n    const wrapInlineControlWithBack = (child) => (\n      <View style={{ flex: 1 }}>\n        <View style={{ paddingHorizontal: 16, paddingTop: 10, flexDirection: 'row', alignItems: 'center' }}>\n          <TouchableOpacity\n            onPress={handleInlineBack}\n            accessibilityLabel=\"Tillbaka\"\n            hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n            style={{ width: 36, height: 32, justifyContent: 'center', alignItems: 'flex-start', marginRight: 10 }}\n          >\n            <Ionicons name=\"chevron-back\" size={22} color=\"#1976D2\" />\n          </TouchableOpacity>\n\n          {(() => {\n            const meta = getInlineHeaderMeta();\n            return (\n              <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0, height: 32 }}>\n                {meta?.icon ? (\n                  <Ionicons name={meta.icon} size={18} color={meta.color} style={{ marginRight: 8 }} />\n                ) : null}\n                <Text style={{ fontSize: 16, fontWeight: '700', color: '#222', flexShrink: 1 }} numberOfLines={1}>\n                  {meta?.label || ''}\n                </Text>\n              </View>\n            );\n          })()}\n        </View>\n        {child}\n      </View>\n    );\n\n    const effectiveProject = inlineControl?.projectSnapshot || project;\n    const commonProps = {\n      project: effectiveProject,\n      initialValues: inlineControl.initialValues,\n      onExit: closeInlineControl,\n      onFinished: () => {\n        closeInlineControl();\n        loadControls();\n      },\n    };\n\n    switch (inlineControl.type) {\n      case 'Arbetsberedning':\n        return wrapInlineControlWithBack(<ArbetsberedningScreen {...commonProps} />);\n      case 'Riskbedömning':\n        return wrapInlineControlWithBack(<RiskbedömningScreen {...commonProps} />);\n      case 'Fuktmätning':\n        return wrapInlineControlWithBack(<FuktmätningScreen {...commonProps} />);\n      case 'Egenkontroll':\n        return wrapInlineControlWithBack(<EgenkontrollScreen {...commonProps} />);\n      case 'Mottagningskontroll':\n        return wrapInlineControlWithBack(<MottagningskontrollScreen {...commonProps} />);\n      case 'Skyddsrond':\n        return wrapInlineControlWithBack(<SkyddsrondScreen {...commonProps} />);\n      case 'ControlDetails':\n        return wrapInlineControlWithBack(\n          <ControlDetails\n            route={{\n              params: {\n                control: inlineControl?.initialValues?.control,\n                project: effectiveProject,\n                companyId,\n              },\n            }}\n          />\n        );\n      default:\n        return (\n          <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 24 }}>\n            <Text style={{ fontSize: 16, color: '#D32F2F', textAlign: 'center' }}>\n              Okänd kontrolltyp: {String(inlineControl.type)}\n            </Text>\n            <TouchableOpacity\n              style={{ marginTop: 16, padding: 12, backgroundColor: '#1976D2', borderRadius: 8 }}\n              onPress={closeInlineControl}\n            >\n              <Text style={{ color: '#fff', fontWeight: '600' }}>Tillbaka</Text>\n            </TouchableOpacity>\n          </View>\n        );\n    }\n  }\n\n  return (\n    <ScrollView\n      ref={scrollRef}\n      style={styles.container}\n      keyboardShouldPersistTaps=\"handled\"\n      contentContainerStyle={{ paddingBottom: 240 }}\n    >\n      {/* Rubrik för projektinfo (med tillbaka-pil i appen och redigera-knapp till höger) */}\n      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 18 }}>\n        <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 }}>\n          {(inlineClose || Platform.OS !== 'web') && (\n            <TouchableOpacity\n              onPress={() => {\n                if (inlineClose) {\n                  inlineClose();\n                } else {\n                  try { navigation.goBack(); } catch (_e) {}\n                }\n              }}\n              style={{ padding: 6, marginRight: 8 }}\n              accessibilityLabel=\"Tillbaka\"\n            >\n              <Ionicons name=\"chevron-back\" size={20} color=\"#1976D2\" />\n            </TouchableOpacity>\n          )}\n          <Ionicons name=\"document-text-outline\" size={20} color=\"#1976D2\" style={{ marginRight: 6 }} />\n          <Text style={{ fontSize: 18, fontWeight: 'bold', color: '#333', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">Projektinformation</Text>\n        </View>\n          {Platform.OS === 'web' ? (\n          <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'nowrap' }}>\n            <TouchableOpacity\n              onPress={() => setEditingInfo(true)}\n              accessibilityLabel=\"Ändra projektinfo\"\n              style={{ padding: 6, marginRight: 8 }}\n            >\n              <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\n            </TouchableOpacity>\n          </View>\n        ) : (\n          <TouchableOpacity\n            onPress={() => setEditingInfo(true)}\n            accessibilityLabel=\"Ändra projektinfo\"\n            style={{ padding: 6 }}\n          >\n            <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\n          </TouchableOpacity>\n        )}\n      </View>\n      {/* Projektinfo med logga, status, projektnummer, projektnamn (expanderbar) */}\n      <View style={{ flexDirection: 'row', alignItems: 'flex-start', marginBottom: 18, padding: 12, backgroundColor: '#f7f7f7', borderRadius: 10 }}>\n        {companyLogoUri ? (\n          <View style={{ marginRight: 16 }}>\n            <Image source={{ uri: companyLogoUri }} style={{ width: 56, height: 56, borderRadius: 8, backgroundColor: '#eee' }} resizeMode=\"contain\" />\n          </View>\n        ) : null}\n        <View style={{ flex: 1, position: 'relative' }}>\n          {/* Header-rad med projektnummer/namn och chevron */}\n          <TouchableOpacity\n            onPress={toggleProjectInfo}\n            activeOpacity={0.8}\n            style={{ flexDirection: 'row', alignItems: 'center', marginBottom: projectInfoExpanded ? 8 : 0 }}\n          >\n            <View style={{\n              width: 16,\n              height: 16,\n              borderRadius: 8,\n              backgroundColor: editableProject?.status === 'completed' ? '#222' : '#43A047',\n              marginRight: 8,\n              borderWidth: 2,\n              borderColor: '#bbb',\n            }} />\n            <Text style={{ fontSize: 20, fontWeight: '700', color: '#222', marginRight: 8 }}>{editableProject?.id}</Text>\n            <Text style={{ fontSize: 20, fontWeight: '700', color: '#222', flexShrink: 1 }} numberOfLines={1} ellipsizeMode=\"tail\">{editableProject?.name}</Text>\n            <Animated.View style={{ marginLeft: 8, transform: [{ rotate: projectInfoRotate }] }}>\n              <Ionicons name={projectInfoExpanded ? 'chevron-down' : 'chevron-forward'} size={18} color=\"#222\" />\n            </Animated.View>\n          </TouchableOpacity>\n\n          {projectInfoExpanded && (\n          <View style={{ marginBottom: 2 }}>\n            <View style={{ marginBottom: 2 }}>\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Skapad:</Text> {editableProject?.createdAt\n                  ? <Text>{new Date(editableProject.createdAt).toLocaleDateString()}</Text>\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Ansvarig:</Text> {editableProject?.ansvarig\n                  ? <Text>{formatPersonName(editableProject.ansvarig)}</Text>\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Status:</Text> {editableProject?.status === 'completed'\n                  ? <Text>Avslutat</Text>\n                  : editableProject?.status === 'ongoing'\n                    ? <Text>Pågående</Text>\n                    : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Kund:</Text> {editableProject?.client\n                  ? <Text>{editableProject.client}</Text>\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Adress:</Text> {editableProject?.adress\n                  ? <Text>{editableProject.adress}</Text>\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Saknas</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Fastighetsbeteckning:</Text> {editableProject?.fastighetsbeteckning\n                  ? <Text>{editableProject.fastighetsbeteckning}</Text>\n                  : <Text style={{ color: '#D32F2F', fontStyle: 'italic' }}>Valfritt</Text>}\n              </Text>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', marginVertical: 6 }} />\n              <Text style={{ fontSize: 15, color: '#555' }}>\n                <Text style={{ fontWeight: '700' }}>Skyddsronder:</Text>{' '}\n                {skyddsrondInfo.enabled\n                  ? (\n                    <>\n                      var {skyddsrondInfo.intervalWeeks} veckor. Senaste: {skyddsrondInfo.lastLabel}. Nästa senast:{' '}\n                      <Text\n                        style={{\n                          color: skyddsrondInfo.overdue ? '#D32F2F' : (skyddsrondInfo.soon ? '#FFD600' : '#555'),\n                          fontWeight: (skyddsrondInfo.overdue || skyddsrondInfo.soon) ? '700' : '400',\n                        }}\n                      >\n                        {skyddsrondInfo.nextLabel}\n                      </Text>\n                    </>\n                  )\n                  : <Text>Inaktiverad</Text>\n                }\n              </Text>\n            </View>\n          </View>\n          )}\n        </View>\n      </View>\n\n      {/* Modal för ändra projektinfo - uppdaterad layout liknande nya modaler (t.ex. Ny mall) */}\n      <Modal visible={editingInfo} transparent animationType=\"fade\" onRequestClose={() => setEditingInfo(false)}>\n        <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.35)' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 12, paddingVertical: 18, paddingHorizontal: 18, minWidth: 320, maxWidth: 420, maxHeight: '75%', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.2, shadowRadius: 10, elevation: 10 }}>\n            {/* Header med ikon, titel och stäng-kryss i samma stil som Ny mall-modal */}\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 12 }}>\n              <View style={{ width: 28, height: 28, borderRadius: 8, backgroundColor: '#1976D2', alignItems: 'center', justifyContent: 'center', marginRight: 8 }}>\n                <Ionicons name=\"briefcase-outline\" size={16} color=\"#fff\" />\n              </View>\n              <Text style={{ flex: 1, fontSize: 16, fontWeight: '700', color: '#222' }}>Projektinformation</Text>\n              <TouchableOpacity\n                onPress={() => setEditingInfo(false)}\n                hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}\n                style={{ padding: 4, marginLeft: 8 }}\n              >\n                <Ionicons name=\"close\" size={22} color=\"#666\" />\n              </TouchableOpacity>\n            </View>\n\n            <ScrollView\n              style={{ alignSelf: 'stretch' }}\n              contentContainerStyle={{ paddingHorizontal: 2, paddingBottom: 16 }}\n              keyboardShouldPersistTaps=\"handled\"\n              showsVerticalScrollIndicator={false}\n            >\n                            {/* Projektnummer */}\n                            <View style={{ marginBottom: 14 }}>\n                              <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Projektnummer</Text>\n                              <TextInput\n                                style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n                                value={editableProject?.id || ''}\n                                onChangeText={v => setEditableProject(p => ({ ...p, id: v }))}\n                                placeholder=\"Ange projektnummer\"\n                                placeholderTextColor=\"#bbb\"\n                                autoCapitalize=\"none\"\n                              />\n                            </View>\n                            {/* Projektnamn */}\n                            <View style={{ marginBottom: 14 }}>\n                              <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Projektnamn</Text>\n                              <TextInput\n                                style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n                                value={editableProject?.name || ''}\n                                onChangeText={v => setEditableProject(p => ({ ...p, name: v }))}\n                                placeholder=\"Ange projektnamn\"\n                                placeholderTextColor=\"#bbb\"\n                                autoCapitalize=\"words\"\n                              />\n                            </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Skapad</Text>\n                <TouchableOpacity\n                  activeOpacity={1}\n                  onLongPress={() => setCanEditCreated(true)}\n                  delayLongPress={2000}\n                >\n                  <TextInput\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: canEditCreated ? '#fff' : '#eee', color: canEditCreated ? '#222' : '#888', pointerEvents: 'none' }}\n                    value={editableProject?.createdAt ? new Date(editableProject.createdAt).toLocaleDateString() : ''}\n                    editable={false}\n                  />\n                  {!canEditCreated && (\n                    <Text style={{ fontSize: 13, color: '#888', marginTop: 4, textAlign: 'center' }}>\n                      Håll in 2 sekunder för att ändra datum\n                    </Text>\n                  )}\n                </TouchableOpacity>\n                {canEditCreated && (\n                  <Modal visible={canEditCreated} transparent animationType=\"fade\" onRequestClose={() => setCanEditCreated(false)}>\n                    <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.30)' }}>\n                      <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, minWidth: 260, maxWidth: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\n                        <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>Välj nytt skapad-datum</Text>\n                        <TextInput\n                          style={{ borderWidth: 1, borderColor: '#1976D2', borderRadius: 8, padding: 10, fontSize: 16, backgroundColor: '#fafafa', color: '#222', marginBottom: 12 }}\n                          value={editableProject?.createdAt ? new Date(editableProject.createdAt).toISOString().slice(0, 10) : ''}\n                          onChangeText={v => {\n                            // Validera att datumet inte är i framtiden\n                            const today = new Date();\n                            const inputDate = new Date(v);\n                            if (inputDate > today) return;\n                            setEditableProject(p => ({ ...p, createdAt: v }));\n                          }}\n                          placeholder=\"YYYY-MM-DD\"\n                          placeholderTextColor=\"#bbb\"\n                          keyboardType=\"numeric\"\n                        />\n                        <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n                          <TouchableOpacity\n                            style={{ backgroundColor: '#1976D2', borderRadius: 8, padding: 12, alignItems: 'center', flex: 1, marginRight: 8 }}\n                            onPress={() => setCanEditCreated(false)}\n                          >\n                            <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Spara</Text>\n                          </TouchableOpacity>\n                          <TouchableOpacity\n                            style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, alignItems: 'center', flex: 1, marginLeft: 8 }}\n                            onPress={() => setCanEditCreated(false)}\n                          >\n                            <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n                          </TouchableOpacity>\n                        </View>\n                      </View>\n                    </View>\n                  </Modal>\n                )}\n              </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Ansvarig</Text>\n                <TouchableOpacity\n                  activeOpacity={0.85}\n                  onPress={() => setAdminPickerVisible(true)}\n                  style={{\n                    borderWidth: 1,\n                    borderColor: '#e0e0e0',\n                    borderRadius: 8,\n                    padding: 10,\n                    backgroundColor: '#fff',\n                    flexDirection: 'row',\n                    alignItems: 'center',\n                    justifyContent: 'space-between',\n                    gap: 10,\n                  }}\n                >\n                  <Text\n                    style={{ fontSize: 15, color: editableProject?.ansvarig ? '#222' : '#bbb', flex: 1 }}\n                    numberOfLines={1}\n                  >\n                    {editableProject?.ansvarig ? formatPersonName(editableProject.ansvarig) : 'Välj ansvarig...'}\n                  </Text>\n                  <Ionicons name=\"chevron-down\" size={18} color=\"#888\" />\n                </TouchableOpacity>\n\n                <Modal\n                  visible={adminPickerVisible}\n                  transparent\n                  animationType=\"fade\"\n                  onRequestClose={() => setAdminPickerVisible(false)}\n                >\n                  <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 18 }}>\n                    <View style={{ backgroundColor: '#fff', borderRadius: 12, padding: 16, minWidth: 280, maxWidth: 360 }}>\n                      <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 10, textAlign: 'center' }}>\n                        Välj ansvarig\n                      </Text>\n\n                      {loadingCompanyAdmins ? (\n                        <Text style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 8 }}>\n                          Laddar...\n                        </Text>\n                      ) : (companyAdminsError ? (\n                        <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                          {companyAdminsError}\n                        </Text>\n                      ) : (companyAdmins.length === 0 ? (\n                        <Text style={{ color: '#D32F2F', fontSize: 14, textAlign: 'center', marginTop: 8 }}>\n                          Inga admins hittades i företaget.\n                        </Text>\n                      ) : (\n                        companyAdmins.length <= 5 ? (\n                          <View>\n                            {companyAdmins.map((m) => (\n                              <TouchableOpacity\n                                key={m.id || m.uid || m.email}\n                                style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\n                                onPress={() => {\n                                  const uid = m.uid || m.id || null;\n                                  const name = formatPersonName(m);\n                                  setEditableProject(p => ({\n                                    ...(p || {}),\n                                    ansvarig: name,\n                                    ansvarigId: uid,\n                                  }));\n                                  setAdminPickerVisible(false);\n                                }}\n                              >\n                                <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                                  {formatPersonName(m)}\n                                </Text>\n                              </TouchableOpacity>\n                            ))}\n                          </View>\n                        ) : (\n                          <ScrollView style={{ maxHeight: 260 }}>\n                            {companyAdmins.map((m) => (\n                              <TouchableOpacity\n                                key={m.id || m.uid || m.email}\n                                style={{ paddingVertical: 10, borderBottomWidth: 1, borderColor: '#eee' }}\n                                onPress={() => {\n                                  const uid = m.uid || m.id || null;\n                                  const name = formatPersonName(m);\n                                  setEditableProject(p => ({\n                                    ...(p || {}),\n                                    ansvarig: name,\n                                    ansvarigId: uid,\n                                  }));\n                                  setAdminPickerVisible(false);\n                                }}\n                              >\n                                <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>\n                                  {formatPersonName(m)}\n                                </Text>\n                              </TouchableOpacity>\n                            ))}\n                          </ScrollView>\n                        )\n                      )))}\n\n                      <TouchableOpacity\n                        style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                        onPress={() => setAdminPickerVisible(false)}\n                      >\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                      </TouchableOpacity>\n                    </View>\n                  </View>\n                </Modal>\n              </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Status</Text>\n                <View style={{ flexDirection: 'row', gap: 12 }}>\n                  <TouchableOpacity\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 12, borderRadius: 8, backgroundColor: editableProject?.status !== 'completed' ? '#e8f5e9' : '#fff', borderWidth: editableProject?.status !== 'completed' ? 2 : 1, borderColor: editableProject?.status !== 'completed' ? '#43A047' : '#e0e0e0', marginRight: 8 }}\n                    onPress={() => setEditableProject(p => ({ ...p, status: 'ongoing' }))}\n                  >\n                    <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: '#43A047', marginRight: 8, borderWidth: 2, borderColor: '#bbb' }} />\n                    <Text style={{ fontSize: 15, color: '#222' }}>Pågående</Text>\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 12, borderRadius: 8, backgroundColor: editableProject?.status === 'completed' ? '#f5f5f5' : '#fff', borderWidth: editableProject?.status === 'completed' ? 2 : 1, borderColor: editableProject?.status === 'completed' ? '#222' : '#e0e0e0' }}\n                    onPress={() => setEditableProject(p => ({ ...p, status: 'completed' }))}\n                  >\n                    <View style={{ width: 16, height: 16, borderRadius: 8, backgroundColor: '#222', marginRight: 8, borderWidth: 2, borderColor: '#bbb' }} />\n                    <Text style={{ fontSize: 15, color: '#222' }}>Avslutat</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Kund</Text>\n                <TextInput\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n                  value={editableProject?.client || ''}\n                  onChangeText={v => setEditableProject(p => ({ ...p, client: v }))}\n                  placeholder=\"Ange kund\"\n                  placeholderTextColor=\"#bbb\"\n                />\n              </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Adress</Text>\n                <TextInput\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n                  value={editableProject?.adress || ''}\n                  onChangeText={v => setEditableProject(p => ({ ...p, adress: v }))}\n                  placeholder=\"Ange adress\"\n                  placeholderTextColor=\"#bbb\"\n                />\n              </View>\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Fastighetsbeteckning</Text>\n                <TextInput\n                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n                  value={editableProject?.fastighetsbeteckning || ''}\n                  onChangeText={v => setEditableProject(p => ({ ...p, fastighetsbeteckning: v }))}\n                  placeholder=\"Ange fastighetsbeteckning\"\n                  placeholderTextColor=\"#bbb\"\n                />\n              </View>\n\n              <View style={{ marginBottom: 14 }}>\n                <Text style={{ fontSize: 15, color: '#888', marginBottom: 6 }}>Skyddsronder</Text>\n                {(() => {\n                  const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\n                  const isEnabled = editableProject?.skyddsrondEnabled !== false;\n                  const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\n                  return (\n                    <View>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>\n                        <Text style={{ fontSize: 15, color: '#222' }}>Aktiva</Text>\n                        <Switch\n                          value={editableProject?.skyddsrondEnabled !== false}\n                          onValueChange={(v) => setEditableProject(p => ({ ...p, skyddsrondEnabled: !!v }))}\n                        />\n                      </View>\n\n                      <Text style={{ fontSize: 15, color: '#888', marginBottom: 4 }}>Veckor mellan skyddsronder</Text>\n                      <TouchableOpacity\n                        style={{\n                          borderWidth: 1,\n                          borderColor: '#e0e0e0',\n                          borderRadius: 8,\n                          paddingVertical: 10,\n                          paddingHorizontal: 10,\n                          backgroundColor: '#fff',\n                          flexDirection: 'row',\n                          alignItems: 'center',\n                          justifyContent: 'space-between',\n                          opacity: (editableProject?.skyddsrondEnabled !== false) ? 1 : 0.5,\n                        }}\n                        disabled={editableProject?.skyddsrondEnabled === false}\n                        onPress={() => setSkyddsrondWeeksPickerVisible(true)}\n                        activeOpacity={0.85}\n                      >\n                        <Text style={{ fontSize: 15, color: '#222' }}>\n                          {String(editableProject?.skyddsrondIntervalWeeks || 2)}\n                        </Text>\n                        <Ionicons name=\"chevron-down\" size={18} color=\"#222\" />\n                      </TouchableOpacity>\n\n                      <Text style={{ fontSize: 15, color: '#888', marginBottom: 4, marginTop: 10 }}>Första skyddsrond senast</Text>\n                      <TextInput\n                        style={{\n                          borderWidth: 1,\n                          borderColor: (isEnabled && !isFirstDueValid) ? '#D32F2F' : '#e0e0e0',\n                          borderRadius: 8,\n                          padding: 10,\n                          fontSize: 15,\n                          backgroundColor: '#fff',\n                          opacity: (editableProject?.skyddsrondEnabled !== false) ? 1 : 0.5,\n                        }}\n                        value={String(editableProject?.skyddsrondFirstDueDate || '')}\n                        editable={editableProject?.skyddsrondEnabled !== false}\n                        onChangeText={v => setEditableProject(p => ({ ...p, skyddsrondFirstDueDate: v }))}\n                        placeholder=\"YYYY-MM-DD\"\n                        placeholderTextColor=\"#bbb\"\n                      />\n\n                      {isEnabled && !isFirstDueValid && (\n                        <Text style={{ color: '#D32F2F', fontSize: 13, marginTop: 6 }}>\n                          Du måste fylla i datum (YYYY-MM-DD).\n                        </Text>\n                      )}\n                    </View>\n                  );\n                })()}\n              </View>\n            </ScrollView>\n\n            <Modal\n              visible={skyddsrondWeeksPickerVisible}\n              transparent\n              animationType=\"fade\"\n              onRequestClose={() => setSkyddsrondWeeksPickerVisible(false)}\n            >\n              <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.30)' }}>\n                <Pressable\n                  style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: 0 }}\n                  onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n                />\n                <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 18, width: 340, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n                  <Text style={{ fontSize: 18, fontWeight: '700', color: '#222', marginBottom: 12, textAlign: 'center' }}>\n                    Veckor mellan skyddsronder\n                  </Text>\n                  {[1, 2, 3, 4].map((w) => (\n                    <TouchableOpacity\n                      key={String(w)}\n                      style={{ paddingVertical: 12, borderBottomWidth: 1, borderColor: '#eee' }}\n                      onPress={() => {\n                        setEditableProject(p => ({ ...p, skyddsrondIntervalWeeks: w }));\n                        setSkyddsrondWeeksPickerVisible(false);\n                      }}\n                    >\n                      <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>{w}</Text>\n                    </TouchableOpacity>\n                  ))}\n                  <TouchableOpacity\n                    style={{ backgroundColor: '#e0e0e0', borderRadius: 10, paddingVertical: 10, alignItems: 'center', marginTop: 12 }}\n                    onPress={() => setSkyddsrondWeeksPickerVisible(false)}\n                  >\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Stäng</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </Modal>\n\n            <View style={{ marginTop: 14, flexDirection: 'row', justifyContent: 'flex-end' }}>\n              <TouchableOpacity\n                onPress={() => setEditingInfo(false)}\n                style={{ paddingVertical: 8, paddingHorizontal: 14, marginRight: 8 }}\n              >\n                <Text style={{ fontSize: 14, color: '#555' }}>Avbryt</Text>\n              </TouchableOpacity>\n              <TouchableOpacity\n                onPress={() => {\n                  const firstDueTrim = String(editableProject?.skyddsrondFirstDueDate || '').trim();\n                  const isEnabled = editableProject?.skyddsrondEnabled !== false;\n                  const isFirstDueValid = (!isEnabled) || (firstDueTrim !== '' && isValidIsoDateYmd(firstDueTrim));\n                  if (!isFirstDueValid) return;\n\n                  const sanitizedProject = {\n                    ...editableProject,\n                    skyddsrondFirstDueDate: isEnabled ? (firstDueTrim || null) : null,\n                  };\n                  if (typeof navigation?.setParams === 'function') {\n                    navigation.setParams({ project: sanitizedProject });\n                  }\n                  emitProjectUpdated({ ...sanitizedProject, originalId: originalProjectId });\n                  setEditingInfo(false);\n                }}\n                style={{ backgroundColor: '#1976D2', borderRadius: 999, paddingVertical: 9, paddingHorizontal: 18, alignItems: 'center', justifyContent: 'center' }}\n              >\n                <Text style={{ color: '#fff', fontSize: 15, fontWeight: '600' }}>Spara</Text>\n              </TouchableOpacity>\n            </View>\n            <TouchableOpacity\n              onPress={() => {\n                setEditingInfo(false);\n                if ((controls || []).length === 0) {\n                  setShowDeleteModal(true);\n                } else {\n                  setShowDeleteWarning(true);\n                }\n              }}\n              style={{ marginTop: 10, paddingVertical: 10, alignItems: 'center' }}\n              activeOpacity={0.85}\n              accessibilityLabel=\"Radera projekt\"\n            >\n              <Text style={{ color: '#D32F2F', fontSize: 14, fontWeight: '600' }}>Radera projekt</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n      {/* Knapprad med horisontella linjer */}\n      <View style={{ marginBottom: 12 }}>\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', marginBottom: 16, marginTop: 8, width: '110%', marginLeft: '-5%' }} />\n        {Platform.OS === 'web' ? (\n          <>\n            <View style={{ marginBottom: 8, alignItems: 'flex-start', paddingHorizontal: 0 }}>\n              <Text style={{ fontSize: 18, fontWeight: '600', textAlign: 'left', marginBottom: 12, color: '#263238', letterSpacing: 0.2 }}>Skapa kontroll:</Text>\n            </View>\n            <View style={{ flexDirection: 'row', alignItems: 'center', flexWrap: 'wrap' }}>\n              {[\n                { type: 'Arbetsberedning', icon: 'construct-outline', color: '#1976D2' },\n                { type: 'Egenkontroll', icon: 'checkmark-done-outline', color: '#388E3C' },\n                { type: 'Fuktmätning', icon: 'water-outline', color: '#0288D1' },\n                { type: 'Mottagningskontroll', icon: 'checkbox-outline', color: '#7B1FA2' },\n                { type: 'Riskbedömning', icon: 'warning-outline', color: '#FFD600' },\n                { type: 'Skyddsrond', icon: 'shield-half-outline', color: '#388E3C' }\n              ].map(({ type, icon, color }) => (\n                <TouchableOpacity\n                  key={type}\n                  style={{\n                    flexDirection: 'row',\n                    alignItems: 'center',\n                    backgroundColor: '#fff',\n                    borderRadius: 12,\n                    borderWidth: 1,\n                    borderColor: '#e0e0e0',\n                    paddingVertical: 10,\n                    paddingHorizontal: 14,\n                    marginRight: 10,\n                    marginBottom: 10,\n                    shadowColor: '#000',\n                    shadowOffset: { width: 0, height: 2 },\n                    shadowOpacity: 0.06,\n                    shadowRadius: 4,\n                    elevation: 2,\n                    cursor: 'pointer'\n                  }}\n                  onPress={() => handleStartControl(type)}\n                  activeOpacity={0.85}\n                >\n                  <Ionicons name={icon} size={18} color={color} style={{ marginRight: 10 }} />\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 15 }}>{type}</Text>\n                </TouchableOpacity>\n              ))}\n            </View>\n          </>\n        ) : (\n          <>\n            <View style={{ width: '100%' }}>\n              <TouchableOpacity\n                style={{\n                  backgroundColor: '#fff',\n                  borderRadius: 10,\n                  borderWidth: 1,\n                  borderColor: '#e0e0e0',\n                  flexDirection: 'row',\n                  alignItems: 'center',\n                  justifyContent: 'center',\n                  paddingVertical: 10,\n                  paddingHorizontal: 18,\n                  shadowColor: '#222',\n                  shadowOffset: { width: 0, height: 2 },\n                  shadowOpacity: 0.08,\n                  shadowRadius: 4,\n                  elevation: 1,\n                  minHeight: 40,\n                  width: '100%',\n                  marginBottom: 8,\n                  overflow: 'hidden',\n                }}\n                activeOpacity={0.85}\n                onPress={() => setShowControlTypeModal(true)}\n              >\n                <View\n                  style={{\n                    width: 22,\n                    height: 22,\n                    borderRadius: 11,\n                    backgroundColor: '#1976D2',\n                    alignItems: 'center',\n                    justifyContent: 'center',\n                    marginRight: 10,\n                  }}\n                >\n                  <Ionicons name=\"add\" size={16} color=\"#fff\" />\n                </View>\n                <Text style={{ color: '#222', fontWeight: '600', fontSize: 15, letterSpacing: 0.5, zIndex: 1 }}>Skapa ny kontroll</Text>\n              </TouchableOpacity>\n            </View>\n            <Text style={{ marginTop: 10, marginBottom: 4, color: '#555', fontSize: 13, textAlign: 'left' }}>\n              Justerbara snabbval – håll in knappen 2 sek för att byta val.\n            </Text>\n            <View style={{ marginTop: 8, flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'space-between' }}>\n              {[0, 1, 2, 3].map((slotIndex) => {\n                const slotType = quickControlSlots[slotIndex];\n                const meta = (controlTypeOptions || []).find(o => o.key === slotType || o.type === slotType) || (controlTypeOptions || [])[slotIndex] || null;\n                const hasType = !!(meta && meta.type);\n                const iconName = hasType ? meta.icon : 'add-circle-outline';\n                const iconColor = hasType ? meta.color : '#1976D2';\n                const label = hasType ? meta.type : 'Välj';\n                return (\n                  <TouchableOpacity\n                    key={String(slotIndex)}\n                    style={{\n                      flexBasis: '48%',\n                      backgroundColor: '#fff',\n                      borderRadius: 12,\n                      borderWidth: 1,\n                      borderColor: '#e0e0e0',\n                      paddingVertical: 10,\n                      paddingHorizontal: 12,\n                      marginBottom: 8,\n                      flexDirection: 'row',\n                      alignItems: 'center',\n                      shadowColor: '#000',\n                      shadowOffset: { width: 0, height: 2 },\n                      shadowOpacity: 0.06,\n                      shadowRadius: 4,\n                      elevation: 2,\n                    }}\n                    activeOpacity={0.85}\n                    onPress={() => {\n                      if (hasType) handleStartControl(meta.key || meta.type, meta.type);\n                      else openQuickSlotConfig(slotIndex);\n                    }}\n                    onLongPress={() => openQuickSlotConfig(slotIndex)}\n                    delayLongPress={1500}\n                  >\n                    <Ionicons name={iconName} size={18} color={iconColor} style={{ marginRight: 8 }} />\n                    <Text style={{ color: '#222', fontWeight: '600', fontSize: 14 }} numberOfLines={1}>\n                      {label}\n                    </Text>\n                  </TouchableOpacity>\n                );\n              })}\n            </View>\n          </>\n        )}\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', marginTop: 16, width: '110%', marginLeft: '-5%' }} />\n      </View>\n\n      <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 16, marginBottom: 8, minHeight: 32 }}>\n\n      {/* Modal för val av kontrolltyp */}\n      <Modal\n        visible={showControlTypeModal}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={() => setShowControlTypeModal(false)}\n      >\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 18 }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, paddingVertical: 20, paddingHorizontal: 20, width: 340, maxWidth: '90%', maxHeight: '60%', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Text style={{ fontSize: 20, fontWeight: '600', marginBottom: 8, color: '#222', textAlign: 'center', marginTop: 6 }}>\n              Välj kontrolltyp\n            </Text>\n            <View style={{ flexDirection: 'row', marginTop: 4 }}>\n              <ScrollView\n                style={{ maxHeight: 320, flex: 1 }}\n                showsVerticalScrollIndicator\n                onLayout={(e) => {\n                  const h = e?.nativeEvent?.layout?.height || 0;\n                  setControlTypeScrollMetrics(prev => ({ ...prev, containerHeight: h }));\n                }}\n                onContentSizeChange={(w, h) => {\n                  setControlTypeScrollMetrics(prev => ({ ...prev, contentHeight: h || 0 }));\n                }}\n                onScroll={(e) => {\n                  const y = e?.nativeEvent?.contentOffset?.y || 0;\n                  setControlTypeScrollMetrics(prev => ({ ...prev, scrollY: y }));\n                }}\n                scrollEventThrottle={16}\n              >\n                {controlTypeOptions.map(({ type, icon, color, key }) => (\n                  <TouchableOpacity\n                    key={type}\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 12, paddingHorizontal: 8, borderRadius: 8, marginBottom: 8, backgroundColor: '#f5f5f5', borderWidth: 1, borderColor: '#e0e0e0' }}\n                    onPress={() => {\n                      setShowControlTypeModal(false);\n                      handleStartControl(key || type, type);\n                    }}\n                  >\n                    <Ionicons name={icon} size={22} color={color} style={{ marginRight: 12 }} />\n                    <Text style={{ fontSize: 16, color: '#222', fontWeight: '600' }}>{type}</Text>\n                  </TouchableOpacity>\n                ))}\n                {Array.isArray(companyProfile?.enabledControlTypes) && controlTypeOptions.length === 0 ? (\n                  <Text style={{ color: '#D32F2F', textAlign: 'center', marginTop: 6, marginBottom: 8 }}>\n                    Inga kontrolltyper är aktiverade för företaget.\n                  </Text>\n                ) : null}\n              </ScrollView>\n                {controlTypeCanScroll ? (\n                <View\n                  style={{\n                    width: 3,\n                    marginLeft: 6,\n                    borderRadius: 999,\n                    backgroundColor: '#E0E0E0',\n                    height: controlTypeScrollMetrics.containerHeight || 0,\n                    overflow: 'hidden',\n                    alignSelf: 'flex-start',\n                    marginTop: 2,\n                    pointerEvents: 'none',\n                  }}\n                >\n                  <View\n                    style={{\n                      position: 'absolute',\n                      left: 0,\n                      right: 0,\n                      borderRadius: 999,\n                      backgroundColor: '#B0B0B0',\n                      height: controlTypeThumbHeight,\n                      top: controlTypeThumbTop,\n                    }}\n                  />\n                </View>\n              ) : null}\n            </View>\n            <TouchableOpacity\n              style={{ marginTop: 8, alignSelf: 'center' }}\n              onPress={() => setShowControlTypeModal(false)}\n            >\n              <Text style={{ color: '#222', fontSize: 16 }}>Avbryt</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n\n      {/* Modal: välj mall när en kontrolltyp har flera mallar */}\n      <Modal\n        visible={templatePickerVisible}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={() => setTemplatePickerVisible(false)}\n      >\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 18 }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, paddingVertical: 20, paddingHorizontal: 20, width: 340, maxWidth: '90%', maxHeight: '60%', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 8, color: '#222', textAlign: 'center' }}>\n              {templatePickerLabel ? `Välj mall för ${templatePickerLabel}` : 'Välj mall'}\n            </Text>\n            <TextInput\n              placeholder=\"Sök mall...\"\n              placeholderTextColor=\"#999\"\n              value={templatePickerSearch}\n              onChangeText={setTemplatePickerSearch}\n              style={{\n                marginTop: 8,\n                marginBottom: 10,\n                borderWidth: 1,\n                borderColor: '#e0e0e0',\n                borderRadius: 8,\n                paddingHorizontal: 10,\n                paddingVertical: 8,\n                fontSize: 14,\n                backgroundColor: '#f9f9f9',\n              }}\n            />\n            <ScrollView style={{ maxHeight: 320, marginTop: 4 }}>\n              {(() => {\n                const all = Array.isArray(templatePickerItems) ? templatePickerItems : [];\n                const qRaw = String(templatePickerSearch || '').trim();\n                const q = qRaw.toLowerCase();\n                const filtered = all.filter((tpl) => {\n                  if (!q) return true;\n                  const title = String(tpl?.title || '').toLowerCase();\n                  return title.includes(q);\n                });\n\n                if (!filtered.length) {\n                  const hasQuery = !!qRaw;\n                  return (\n                    <Text style={{ fontSize: 14, color: '#D32F2F', textAlign: 'center', marginTop: 8 }}>\n                      {hasQuery\n                        ? `Ingen mall hittades för \"${qRaw}\".`\n                        : 'Inga mallar tillgängliga.'}\n                    </Text>\n                  );\n                }\n\n                return filtered.map((tpl) => {\n                  const isHidden = !!tpl.hidden;\n                  const title = String(tpl?.title || 'Namnlös mall');\n                  const versionLabel = (typeof tpl?.version === 'number' || typeof tpl?.version === 'string')\n                    ? `v${tpl.version}`\n                    : '';\n                  return (\n                    <TouchableOpacity\n                      key={tpl.id || title}\n                      style={{\n                        paddingVertical: 6,\n                        paddingHorizontal: 4,\n                        marginBottom: 2,\n                      }}\n                      onPress={() => {\n                        setTemplatePickerVisible(false);\n                        if (!tpl) return;\n                        navigation.navigate('TemplateControlScreen', {\n                          project,\n                          controlType: templatePickerLabel || tpl.controlType || 'Kontroll',\n                          templateId: tpl.id,\n                          template: tpl,\n                          companyId,\n                        });\n                      }}\n                    >\n                      <View\n                        style={{\n                          flexDirection: 'row',\n                          alignItems: 'center',\n                          justifyContent: 'space-between',\n                          paddingVertical: 4,\n                          borderBottomWidth: 1,\n                          borderBottomColor: '#eee',\n                        }}\n                      >\n                        <Text\n                          style={{ fontSize: 15, fontWeight: '600', color: isHidden ? '#9E9E9E' : '#222', flexShrink: 1 }}\n                          numberOfLines={1}\n                        >\n                          {title + (isHidden ? ' (inaktiv)' : '')}\n                        </Text>\n                        {versionLabel ? (\n                          <Text style={{ fontSize: 13, color: '#555', marginLeft: 8 }} numberOfLines={1}>\n                            {versionLabel}\n                          </Text>\n                        ) : null}\n                      </View>\n                    </TouchableOpacity>\n                  );\n                });\n              })()}\n            </ScrollView>\n            <TouchableOpacity\n              style={{ marginTop: 12, alignSelf: 'center' }}\n              onPress={() => setTemplatePickerVisible(false)}\n            >\n              <Text style={{ color: '#222', fontSize: 16 }}>Stäng</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n\n      {/* Modal: välj kontrolltyp för snabbknapp */}\n      <Modal\n        visible={showQuickSlotModal}\n        transparent\n        animationType=\"fade\"\n        onRequestClose={() => setShowQuickSlotModal(false)}\n      >\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 18, padding: 24, width: 320, shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 12, color: '#222', textAlign: 'center' }}>\n              Välj snabbknapp\n            </Text>\n            <ScrollView style={{ maxHeight: 320 }}>\n              {controlTypeOptions.map(({ type, icon, color, key }) => (\n                <TouchableOpacity\n                  key={type}\n                  style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 10, paddingHorizontal: 8, borderRadius: 8, marginBottom: 6, backgroundColor: '#f5f5f5', borderWidth: 1, borderColor: '#e0e0e0' }}\n                  onPress={() => {\n                    if (quickSlotConfigIndex == null) return;\n                    const next = [...quickControlSlots];\n                    next[quickSlotConfigIndex] = key || type;\n                    setQuickControlSlots(next);\n                    persistQuickSlots(next);\n                    setShowQuickSlotModal(false);\n                  }}\n                >\n                  <Ionicons name={icon} size={20} color={color} style={{ marginRight: 10 }} />\n                  <Text style={{ fontSize: 15, color: '#222', fontWeight: '600' }}>{type}</Text>\n                </TouchableOpacity>\n              ))}\n            </ScrollView>\n            <TouchableOpacity\n              style={{ marginTop: 10, alignSelf: 'center' }}\n              onPress={() => setShowQuickSlotModal(false)}\n            >\n              <Text style={{ color: '#222', fontSize: 16 }}>Stäng</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n      </Modal>\n\n              {/* Modal: Bekräfta radering om inga kontroller */}\n              <Modal visible={showDeleteModal} transparent animationType=\"fade\" onRequestClose={() => setShowDeleteModal(false)}>\n                <View style={styles.centerOverlay}>\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\n                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#222', textAlign: 'center' }}>Vill du ta bort projektet?</Text>\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\n                      <TouchableOpacity style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }} onPress={() => {/* TODO: Lägg till raderingslogik här */ setShowDeleteModal(false); }}>\n                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Ta bort</Text>\n                      </TouchableOpacity>\n                      <TouchableOpacity style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }} onPress={() => setShowDeleteModal(false)}>\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n                      </TouchableOpacity>\n                    </View>\n                  </View>\n                </View>\n              </Modal>\n              {/* Modal: Extra varning om kontroller finns */}\n              <Modal visible={showDeleteWarning} transparent animationType=\"fade\" onRequestClose={() => setShowDeleteWarning(false)}>\n                <View style={styles.centerOverlay}>\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\n                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#D32F2F', textAlign: 'center' }}>Projektet har kontroller kopplade.\\nÄr du säker på att du vill ta bort projektet? Allt kommer att förloras.</Text>\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\n                      <TouchableOpacity style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }} onPress={() => {/* TODO: Lägg till raderingslogik här */ setShowDeleteWarning(false); }}>\n                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Ta bort</Text>\n                      </TouchableOpacity>\n                      <TouchableOpacity style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }} onPress={() => setShowDeleteWarning(false)}>\n                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n                      </TouchableOpacity>\n                    </View>\n                  </View>\n                </View>\n              </Modal>\n        <View style={{ marginTop: 0, marginBottom: 0, alignItems: 'flex-start' }}>\n          <Text style={{ fontSize: 18, fontWeight: '600', textAlign: 'left', marginBottom: 12, color: '#263238', letterSpacing: 0.2 }}>\n            Utförda kontroller:\n          </Text>\n        </View>\n      </View>\n\n      {/* Sökfält för kontroller */}\n      <View style={{ marginBottom: 10 }}>\n        <TextInput\n          style={[styles.input, { marginBottom: 0 }]}\n          placeholder=\"Sök kontroller (t.ex. gips, arbetsmoment, leverans...)\"\n          placeholderTextColor=\"#888\"\n          value={searchText}\n          onChangeText={setSearchText}\n          autoCorrect={false}\n          autoCapitalize=\"none\"\n        />\n      </View>\n\n      {(() => {\n        const baseControls = Array.isArray(controls) ? controls : [];\n        // Filtrera kontroller baserat på söktext\n        const lowerSearch = (searchText || '').toLowerCase();\n        const filteredControls = !lowerSearch\n          ? baseControls\n          : baseControls.filter(c => {\n              const fields = [c.deliveryDesc, c.materialDesc, c.generalNote, c.description, c.arbetsmoment];\n              return fields.some(f => f && String(f).toLowerCase().includes(lowerSearch));\n            });\n        const grouped = controlTypes\n          .map((t) => ({ type: t, items: filteredControls.filter(c => (c.type || '') === t) }))\n          .filter(g => g.items.length > 0);\n\n        if (grouped.length === 0) {\n          const msg = lowerSearch\n            ? 'Inga kontroller matchar sökningen.'\n            : 'Inga kontroller utförda än';\n          return (\n            <Text style={[styles.noControls, { color: '#D32F2F' }]}>{msg}</Text>\n          );\n        }\n\n        const toggleType = (t) => {\n              try { Haptics.selectionAsync(); } catch {}\n              setExpandedByType((prev) => ({ ...prev, [t]: !(prev[t] ?? false) }));\n            };\n\n            const pluralLabels = {\n              Arbetsberedning: 'Arbetsberedningar',\n              Egenkontroll: 'Egenkontroller',\n              Fuktmätning: 'Fuktmätningar',\n              Skyddsrond: 'Skyddsronder',\n              Riskbedömning: 'Riskbedömningar',\n            };\n\n            // Helper: count open/total deviations in a Skyddsrond.\n            // Supports both newer schema (checklist + remediation keyed by point text)\n            // and legacy schema (checklistSections + remediation indexed by point index).\n            function getSkyddsrondDeviationStats(ctrl) {\n              try {\n                const sections = Array.isArray(ctrl?.checklist)\n                  ? ctrl.checklist\n                  : (Array.isArray(ctrl?.checklistSections) ? ctrl.checklistSections : null);\n                if (!Array.isArray(sections) || sections.length === 0) return { total: 0, open: 0 };\n\n                let total = 0;\n                let open = 0;\n                for (const section of sections) {\n                  if (!section || !Array.isArray(section.statuses)) continue;\n                  const points = Array.isArray(section.points) ? section.points : [];\n                  for (let i = 0; i < section.statuses.length; i++) {\n                    if (section.statuses[i] !== 'avvikelse') continue;\n                    total += 1;\n                    const pt = points[i];\n                    const rem = section.remediation\n                      ? ((pt !== undefined && pt !== null) ? section.remediation[pt] : null) || section.remediation[i]\n                      : null;\n                    if (!rem) open += 1;\n                  }\n                }\n                return { total, open };\n              } catch(e) {\n                return { total: 0, open: 0 };\n              }\n            }\n\n        // For group header: are ALL Skyddsrond controls handled?\n        return (\n          <View>\n            {grouped.map(({ type, items }) => {\n              const t = type;\n              const typeMeta = (controlTypeOptions || []).find(o => o.type === t) || null;\n              let allHandled = true;\n              let anyDeviation = false;\n              let anyOpenDeviation = false;\n              if (t === 'Skyddsrond') {\n                const stats = (items || []).map(ctrl => getSkyddsrondDeviationStats(ctrl));\n                allHandled = stats.length > 0 && stats.every(s => s.total > 0 && s.open === 0);\n                anyDeviation = stats.some(s => s.total > 0);\n                anyOpenDeviation = stats.some(s => s.open > 0);\n              }\n              const expanded = expandedByType[t] ?? false;\n              return (\n                <View key={t} style={styles.groupContainer}>\n                  <TouchableOpacity style={styles.groupHeader} onPress={() => toggleType(t)}>\n                    <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>\n                      <MaterialIcons name={expanded ? 'expand-less' : 'expand-more'} size={22} color=\"#263238\" />\n                      {typeMeta ? (\n                        <Ionicons\n                          name={typeMeta.icon}\n                          size={18}\n                          color={typeMeta.color}\n                          style={{ marginLeft: 8 }}\n                          accessibilityLabel={`${t} ikon`}\n                        />\n                      ) : null}\n                      <Text style={styles.groupTitle} numberOfLines={1} ellipsizeMode=\"tail\">{pluralLabels[t] || t}</Text>\n                    </View>\n\n                    {t === 'Skyddsrond' && anyOpenDeviation && (\n                      <TouchableOpacity\n                        onPress={(e) => {\n                          try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\n                          // Expand the group so the problematic rond becomes visible (and highlighted).\n                          setExpandedByType((prev) => ({ ...prev, [t]: true }));\n                        }}\n                        style={{ marginRight: 10, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600' }}\n                        activeOpacity={0.85}\n                        accessibilityLabel=\"Åtgärda\"\n                      >\n                        <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\n                      </TouchableOpacity>\n                    )}\n                    <View style={styles.groupBadge}><Text style={styles.groupBadgeText}>{items.length}</Text></View>\n                  </TouchableOpacity>\n                  {expanded ? (\n                    items\n                      .slice()\n                      .sort((a, b) => (b.date || '').localeCompare(a.date || ''))\n                      .map((item, idx) => {\n                        // ...existerande rendering av kontrollkortet...\n                        const isWeb = Platform.OS === 'web';\n                        const leadingIconSize = isWeb ? 20 : 22;\n                        const leadingIconMarginRight = isWeb ? 6 : 8;\n                        const trailingIconPadding = isWeb ? 4 : 6;\n                        const trailingIconMarginLeft = isWeb ? 6 : 8;\n                        let subtitle = null;\n                        let parsedDate = '';\n                        let label = '';\n                        if (item.type === 'Skyddsrond' || item.type === 'Riskbedömning') {\n                          let dateStr = '';\n                          if (item.date && item.date.length >= 10) {\n                            const d = new Date(item.date);\n                            if (!isNaN(d)) dateStr = d.toISOString().slice(0, 10);\n                          }\n                          if (!dateStr) dateStr = '(okänt datum)';\n                          const wy = getWeekAndYear(item.date || item.savedAt || item.createdAt || dateStr);\n                          const weekStr = wy && wy.week ? (wy.week < 10 ? '0' + wy.week : String(wy.week)) : '';\n                          label = (weekStr ? `V.${weekStr} - ` : '') + dateStr;\n                          subtitle = (item.deliveryDesc && String(item.deliveryDesc).trim())\n                            ? String(item.deliveryDesc).trim()\n                            : (item.materialDesc && String(item.materialDesc).trim()) ? String(item.materialDesc).trim()\n                            : (item.generalNote && String(item.generalNote).trim()) ? String(item.generalNote).trim()\n                            : (item.description && String(item.description).trim()) ? String(item.description).trim()\n                            : null;\n                        } else if (item.type === 'Mottagningskontroll') {\n                          const tryParse = (v) => {\n                            if (!v) return null;\n                            try {\n                              const d = new Date(v);\n                              if (!isNaN(d)) return d.toLocaleDateString('sv-SE');\n                            } catch(e) {}\n                            return null;\n                          };\n                          parsedDate = tryParse(item.date) || tryParse(item.dateValue) || tryParse(item.savedAt) || tryParse(item.createdAt) || tryParse(item.created) || '';\n                          if (!parsedDate && item.date) parsedDate = item.date;\n                          const dateLabel = parsedDate || '(okänt datum)';\n                          const wy = getWeekAndYear(parsedDate || item.date || item.savedAt || item.createdAt);\n                          const weekStr = wy && wy.week ? (wy.week < 10 ? '0' + wy.week : String(wy.week)) : '';\n                          const header = weekStr ? `V.${weekStr} - ${dateLabel}` : dateLabel;\n                          label = header;\n                          subtitle = (item.deliveryDesc && String(item.deliveryDesc).trim())\n                            ? String(item.deliveryDesc).trim()\n                            : (item.materialDesc && String(item.materialDesc).trim()) ? String(item.materialDesc).trim()\n                            : (item.generalNote && String(item.generalNote).trim()) ? String(item.generalNote).trim()\n                            : (item.description && String(item.description).trim()) ? String(item.description).trim()\n                            : null;\n                        } else {\n                          label = `${item.type}${item.date ? ' ' + item.date : ''}`;\n                          if (item.deliveryDesc && String(item.deliveryDesc).trim()) {\n                            label = `${label} — ${String(item.deliveryDesc).trim()}`;\n                          }\n                        }\n                        // Skyddsrond deviation status (open deviations => highlight)\n                        let hasDeviation = false;\n                        let allHandled = false;\n                        if (item.type === 'Skyddsrond') {\n                          const stats = getSkyddsrondDeviationStats(item);\n                          allHandled = stats.total > 0 && stats.open === 0;\n                          hasDeviation = stats.open > 0;\n                        }\n                        return (\n                          <View key={`${item.id || 'noid'}-${item.date || 'nodate'}-${idx}`} style={{ flexDirection: 'row', alignItems: 'center', width: '100%' }}>\n                            <TouchableOpacity\n                              style={[\n                                styles.controlCard,\n                                (Platform.OS === 'web' ? styles.controlCardWeb : null),\n                                (item.isDraft\n                                  ? { backgroundColor: '#fff', borderColor: '#222' }\n                                  : item.type === 'Skyddsrond' && hasDeviation\n                                    ? { backgroundColor: '#FFD600', borderColor: '#D32F2F', borderWidth: 2 }\n                                    : item.type === 'Skyddsrond' && allHandled\n                                      ? { backgroundColor: '#fff', borderColor: '#43A047', borderWidth: 2 }\n                                      : { backgroundColor: '#fff', borderColor: '#e0e0e0' }\n                                )\n                              ]}\n                              onPress={() => {\n                                if (item.isDraft) {\n                                  switch (item.type) {\n                                    case 'Arbetsberedning':\n                                      if (Platform.OS === 'web') openInlineControl('Arbetsberedning', item);\n                                      else navigation.navigate('ArbetsberedningScreen', { initialValues: item, project });\n                                      break;\n                                    case 'Riskbedömning':\n                                      if (Platform.OS === 'web') openInlineControl('Riskbedömning', item);\n                                      else navigation.navigate('RiskbedömningScreen', { initialValues: item, project });\n                                      break;\n                                    case 'Fuktmätning':\n                                      if (Platform.OS === 'web') openInlineControl('Fuktmätning', item);\n                                      else navigation.navigate('FuktmätningScreen', { initialValues: item, project });\n                                      break;\n                                    case 'Egenkontroll':\n                                      if (Platform.OS === 'web') openInlineControl('Egenkontroll', item);\n                                      else navigation.navigate('EgenkontrollScreen', { initialValues: item, project });\n                                      break;\n                                    case 'Mottagningskontroll':\n                                      if (Platform.OS === 'web') openInlineControl('Mottagningskontroll', item);\n                                      else navigation.navigate('MottagningskontrollScreen', { initialValues: item, project });\n                                      break;\n                                    case 'Skyddsrond':\n                                      if (Platform.OS === 'web') openInlineControl('Skyddsrond', item);\n                                      else navigation.navigate('SkyddsrondScreen', { initialValues: item, project });\n                                      break;\n                                    default:\n                                      if (Platform.OS === 'web') openInlineControl(item.type, item);\n                                      else navigation.navigate('ControlForm', { initialValues: item, project });\n                                  }\n                                } else {\n                                  if (Platform.OS === 'web') {\n                                    openInlineControl('ControlDetails', { control: item });\n                                  } else {\n                                    navigation.navigate('ControlDetails', { control: item, project, companyId });\n                                  }\n                                }\n                              }}\n                              onLongPress={item.isDraft ? undefined : () => handleControlLongPress(item)}\n                              delayLongPress={item.isDraft ? undefined : 600}\n                            >\n                              {item.isDraft ? (\n                                <Ionicons name=\"document-text-outline\" size={leadingIconSize} color=\"#FFD600\" style={{ marginRight: leadingIconMarginRight }} />\n                              ) : item.type === 'Skyddsrond' ? (\n                                hasDeviation\n                                  ? <Ionicons name=\"alert-circle\" size={leadingIconSize} color=\"#D32F2F\" style={{ marginRight: leadingIconMarginRight }} />\n                                  : (\n                                    <Svg width={leadingIconSize} height={leadingIconSize} viewBox=\"0 0 24 24\" style={{ marginRight: leadingIconMarginRight }}>\n                                      <Circle cx={12} cy={12} r={10} fill=\"#43A047\" stroke=\"#222\" strokeWidth={1} />\n                                      <SvgText\n                                        x=\"12\"\n                                        y=\"13.5\"\n                                        fontSize=\"16\"\n                                        fontWeight=\"bold\"\n                                        fill=\"#fff\"\n                                        textAnchor=\"middle\"\n                                        alignmentBaseline=\"middle\"\n                                      >\n                                        ✓\n                                      </SvgText>\n                                    </Svg>\n                                  )\n                              ) : (\n                                <Svg width={leadingIconSize} height={leadingIconSize} viewBox=\"0 0 24 24\" style={{ marginRight: leadingIconMarginRight }}>\n                                  <Circle cx={12} cy={12} r={10} fill=\"#43A047\" stroke=\"#222\" strokeWidth={1} />\n                                  <SvgText\n                                    x=\"12\"\n                                    y=\"13.5\"\n                                    fontSize=\"16\"\n                                    fontWeight=\"bold\"\n                                    fill=\"#fff\"\n                                    textAnchor=\"middle\"\n                                    alignmentBaseline=\"middle\"\n                                  >\n                                    ✓\n                                  </SvgText>\n                                </Svg>\n                              )}\n                              <View style={(Platform.OS === 'web') ? styles.controlTextContainerWeb : styles.controlTextContainer}>\n                                {Platform.OS === 'web' ? (\n                                  <Text style={styles.controlLine} numberOfLines={1} ellipsizeMode=\"tail\">\n                                    <Text style={styles.controlTitleInlineWeb}>{label}</Text>\n                                    {subtitle ? <Text style={styles.controlSubtitleInline}> — {subtitle}</Text> : null}\n                                  </Text>\n                                ) : (\n                                  <>\n                                    <Text style={styles.controlTitle} numberOfLines={1} ellipsizeMode=\"tail\">{label}</Text>\n                                    {subtitle ? (\n                                      <Text style={styles.controlSubtitle} numberOfLines={1} ellipsizeMode=\"tail\">{subtitle}</Text>\n                                    ) : null}\n                                  </>\n                                )}\n                              </View>\n\n                              {Platform.OS === 'web' && !item.isDraft && item.type === 'Skyddsrond' && hasDeviation && (\n                                <TouchableOpacity\n                                  style={{ marginLeft: trailingIconMarginLeft, paddingVertical: 4, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600', alignSelf: 'center' }}\n                                  activeOpacity={0.85}\n                                  onPress={(e) => {\n                                    try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\n                                    navigation.navigate('ControlDetails', { control: item, project, companyId });\n                                  }}\n                                  accessibilityLabel=\"Åtgärda\"\n                                >\n                                  <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\n                                </TouchableOpacity>\n                              )}\n\n                              {/* Skriv ut-ikon (endast för slutförda) */}\n                              {!item.isDraft && (\n                                <TouchableOpacity\n                                  style={{ marginLeft: trailingIconMarginLeft, padding: trailingIconPadding }}\n                                  onPress={async (e) => {\n                                    e.stopPropagation && e.stopPropagation();\n                                    try {\n                                      setExportingPdf(true);\n                                      // Bygg HTML för EN kontroll\n                                      try {\n                                        console.log('[PDF] using buildSummaryHtml?', typeof buildSummaryHtml);\n                                        // Prepare logo (prefer company profile for PDF; try downloading + base64 embed)\n                                        let profile = companyProfile;\n                                        if (!profile && companyId) {\n                                          try {\n                                            profile = await fetchCompanyProfile(companyId);\n                                            if (profile) setCompanyProfile(profile);\n                                          } catch(e) {}\n                                        }\n                                        const companyNameForPdf = profile?.name || profile?.companyName || project?.client || project?.name || 'FÖRETAG AB';\n                                        const companyLogoFromProfile = profile?.logoUrl || null;\n                                        let logoForPrint = companyLogoFromProfile || companyLogoUri || null;\n                                        if (logoForPrint && /^https?:\\/\\//i.test(logoForPrint)) {\n                                          try {\n                                            const fileName = 'company-logo.single.png';\n                                            const baseDir = (FileSystem && (FileSystem.cacheDirectory || FileSystem.documentDirectory)) ? (FileSystem.cacheDirectory || FileSystem.documentDirectory) : null;\n                                            if (baseDir) {\n                                              const dest = baseDir + fileName;\n                                              const dl = await FileSystem.downloadAsync(logoForPrint, dest);\n                                              if (dl?.uri) logoForPrint = dl.uri;\n                                            }\n                                          } catch(e) { console.warn('[PDF] download logo failed', e); }\n                                        }\n                                        let logoBase64 = null;\n                                        try {\n                                          logoBase64 = await readUriAsBase64(logoForPrint);\n                                          if (!logoBase64) {\n                                            try {\n                                              const a = Asset.fromModule(require('../assets/images/foretag_ab.png'));\n                                              await Asset.loadAsync(a);\n                                              const local = a.localUri || a.uri;\n                                              if (local) {\n                                                logoBase64 = await readUriAsBase64(local);\n                                                if (logoBase64) logoForPrint = 'data:image/png;base64,' + logoBase64;\n                                              }\n                                            } catch(e) { /* ignore */ }\n                                          } else {\n                                            logoForPrint = 'data:image/png;base64,' + logoBase64;\n                                          }\n                                        } catch(e) { console.warn('[PDF] logo base64 convert failed', e); }\n\n                                        let html;\n                                        // Embed images for this item before building HTML\n                                        const embeddedItem = await embedImagesInControl(item);\n                                        if (typeof buildSummaryHtml === 'function') {\n                                          html = buildSummaryHtml('En', logoForPrint, [embeddedItem]);\n                                          } else {\n                                          console.warn('[PDF] buildSummaryHtml not found, falling back to type-aware builder');\n                                          const companyObj = { name: companyNameForPdf, logoUrl: companyLogoFromProfile, logoBase64 };\n                                          html = buildPdfHtmlForControl({ control: embeddedItem, project, company: companyObj });\n                                        }\n                                        // Generate PDF file and present share/save dialog instead of directly printing\n                                        const fileResult = await Print.printToFileAsync({ html });\n                                        const pdfUri = fileResult?.uri;\n                                        if (pdfUri) {\n                                          try {\n                                            // On iOS/Android this opens native share/save UI (Save to Files, etc.)\n                                            if (Sharing && Sharing.isAvailableAsync) {\n                                              const avail = await Sharing.isAvailableAsync();\n                                              if (avail) {\n                                                await Sharing.shareAsync(pdfUri, { dialogTitle: 'Spara PDF' });\n                                              } else {\n                                                // Fallback: just log path and show notice\n                                                console.log('[PDF] PDF generated at', pdfUri);\n                                                setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\n                                              }\n                                            } else {\n                                              console.log('[PDF] PDF generated at', pdfUri);\n                                              setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri });\n                                            }\n                                          } catch (shareErr) {\n                                            console.warn('[PDF] shareAsync failed, opening print dialog as fallback', shareErr);\n                                            await Print.printAsync({ uri: pdfUri });\n                                          }\n                                        } else {\n                                          throw new Error('printToFileAsync returned no uri');\n                                        }\n                                      } catch(e) {\n                                        console.warn('[PDF] single-item PDF generation failed, retrying without logo', err);\n                                        try {\n                                          let html2;\n                                          if (typeof buildSummaryHtml === 'function') {\n                                            html2 = buildSummaryHtml('En', null, [item]);\n                                          } else {\n                                            html2 = buildPdfHtmlForControl({ control: item, project, company: { name: companyNameForPdf } });\n                                          }\n                                          // Try generating file again without logo\n                                          const fileResult2 = await Print.printToFileAsync({ html: html2 });\n                                          const pdfUri2 = fileResult2?.uri;\n                                          if (pdfUri2) {\n                                            try {\n                                              const avail2 = await Sharing.isAvailableAsync();\n                                              if (avail2) await Sharing.shareAsync(pdfUri2, { dialogTitle: 'Spara PDF' });\n                                              else setNotice({ visible: true, text: 'PDF genererad: ' + pdfUri2 });\n                                            } catch (shareErr2) {\n                                              console.warn('[PDF] shareAsync failed (retry), falling back to print dialog', shareErr2);\n                                              await Print.printAsync({ uri: pdfUri2 });\n                                            }\n                                          } else {\n                                            throw new Error('printToFileAsync retry returned no uri');\n                                          }\n                                        } catch (err2) {\n                                          console.error('[PDF] single-item print fallback failed', err2);\n                                          setNotice({ visible: true, text: 'Kunde inte generera eller dela PDF — se konsolen för detaljer' });\n                                        }\n                                      }\n                                    } finally {\n                                      setExportingPdf(false);\n                                    }\n                                  }}\n                                  accessibilityLabel=\"Exportera denna kontroll som PDF\"\n                                >\n                                  <Ionicons name=\"document-outline\" size={leadingIconSize} color=\"#1976D2\" />\n                                </TouchableOpacity>\n                              )}\n                              {/* Papperskorg-ikon med bekräftelsemodal (både för utkast och slutförda) */}\n                              <TouchableOpacity\n                                style={{ marginLeft: trailingIconMarginLeft, padding: trailingIconPadding }}\n                                onPress={(e) => {\n                                  e.stopPropagation && e.stopPropagation();\n                                  setDeleteConfirm({ visible: true, control: item });\n                                }}\n                                accessibilityLabel={item.isDraft ? \"Radera pågående kontroll\" : \"Radera denna kontroll\"}\n                              >\n                                <Ionicons name=\"trash-outline\" size={leadingIconSize} color=\"#D32F2F\" />\n                              </TouchableOpacity>\n\n                              {/* Modal för raderingsbekräftelse (läggs i JSX utanför listan) */}\n                              {/* Bekräftelsemodal för radering av kontroll */}\n                              <Modal\n                                visible={deleteConfirm.visible}\n                                transparent\n                                animationType=\"fade\"\n                                onRequestClose={() => setDeleteConfirm({ visible: false, control: null })}\n                              >\n                                <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.35)' }}>\n                                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, minWidth: 260, maxWidth: 340, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 8 }, shadowOpacity: 0.22, shadowRadius: 16, elevation: 12 }}>\n                                    <Text style={{ fontSize: 18, fontWeight: '700', marginBottom: 18, color: '#D32F2F', textAlign: 'center' }}>\n                                      Vill du verkligen radera denna kontroll?\n                                    </Text>\n                                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\n                                      <TouchableOpacity\n                                        style={{ backgroundColor: '#D32F2F', borderRadius: 8, padding: 12, flex: 1, marginRight: 8, alignItems: 'center' }}\n                                        onPress={handleDeleteSelectedControl}\n                                      >\n                                        <Text style={{ color: '#fff', fontWeight: '700', fontSize: 16 }}>Radera</Text>\n                                      </TouchableOpacity>\n                                      <TouchableOpacity\n                                        style={{ backgroundColor: '#e0e0e0', borderRadius: 8, padding: 12, flex: 1, marginLeft: 8, alignItems: 'center' }}\n                                        onPress={() => setDeleteConfirm({ visible: false, control: null })}\n                                      >\n                                        <Text style={{ color: '#222', fontWeight: '600', fontSize: 16 }}>Avbryt</Text>\n                                      </TouchableOpacity>\n                                    </View>\n                                  </View>\n                                </View>\n                              </Modal>\n                            </TouchableOpacity>\n                          </View>\n                        );\n                      })\n                  ) : null}\n                </View>\n              );\n            })}\n          </View>\n        );\n      })()}\n\n      {/* Formulär */}\n      {showForm && (\n        <KeyboardAvoidingView\n          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\n          keyboardVerticalOffset={Platform.OS === 'ios' ? 80 : 0}\n          style={styles.form}\n        >\n          <Text style={styles.selectedType}>Vald kontroll: {newControl.type}</Text>\n\n          {/* Visa dagens datum och möjlighet att välja eget */}\n          <Text style={styles.infoText}>Dagens datum: {newControl.date}</Text>\n          <TouchableOpacity onPress={() => setNewControl({ ...newControl, date: '' })}>\n            <Text style={styles.linkText}>Välj eget datum</Text>\n          </TouchableOpacity>\n\n          <TextInput\n            style={styles.input}\n            placeholder=\"Datum (ÅÅÅÅ-MM-DD)\"\n            placeholderTextColor=\"#888\"\n            value={newControl.date}\n            onChangeText={(text) => setNewControl({ ...newControl, date: text })}\n            onFocus={() => {\n              setTimeout(() => {\n                if (scrollRef.current && typeof scrollRef.current.scrollToEnd === 'function') {\n                  try { scrollRef.current.scrollToEnd({ animated: true }); } catch {}\n                }\n              }, 50);\n            }}\n          />\n          <TextInput\n            style={styles.input}\n            placeholder={newControl.type === 'Skyddsrond' ? 'Skyddsrond omfattar' : 'Beskrivning'}\n            placeholderTextColor=\"#888\"\n            value={newControl.description}\n            onChangeText={(text) => setNewControl({ ...newControl, description: text })}\n            onFocus={() => {\n              setTimeout(() => {\n                if (scrollRef.current && typeof scrollRef.current.scrollToEnd === 'function') {\n                  try { scrollRef.current.scrollToEnd({ animated: true }); } catch {}\n                }\n              }, 50);\n            }}\n          />\n          <TouchableOpacity style={styles.saveButton} onPress={handleAddControl}>\n            <Text style={styles.saveButtonText}>Skapa kontroll</Text>\n          </TouchableOpacity>\n          <TouchableOpacity style={styles.cancelButton} onPress={() => { try { Haptics.selectionAsync(); } catch {}; setShowForm(false); }}>\n            <Text style={styles.cancelText}>Avbryt</Text>\n          </TouchableOpacity>\n        </KeyboardAvoidingView>\n      )}\n\n      {undoState.visible ? (\n        <View style={styles.undoBar}>\n          <Text style={styles.undoText}>Kontroll borttagen</Text>\n          <TouchableOpacity onPress={handleUndo}>\n            <Text style={styles.undoButtonText}>Ångra</Text>\n          </TouchableOpacity>\n        </View>\n      ) : null}\n\n      {notice.visible ? (\n        <View style={styles.noticeBar}>\n          <Text style={styles.noticeText}>{notice.text}</Text>\n        </View>\n      ) : null}\n\n      <Modal visible={showSummary} transparent animationType=\"fade\" onRequestClose={() => setShowSummary(false)}>\n        <TouchableOpacity style={styles.centerOverlay} activeOpacity={1} onPress={() => setShowSummary(false)}>\n          <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : 'height'} keyboardVerticalOffset={80}>\n            <View style={styles.summaryCard}>\n              {/* Stäng (X) knapp uppe till höger */}\n              <TouchableOpacity\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 2, padding: 6 }}\n                onPress={() => { try { Haptics.selectionAsync(); } catch {}; setShowSummary(false); }}\n                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n              >\n                <Ionicons name=\"close\" size={26} color=\"#222\" />\n              </TouchableOpacity>\n              <Text style={styles.modalText}>Skriv ut</Text>\n              {/* Export filter selector */}\n              {(() => {\n                const byType = controls.reduce((acc, c) => {\n                  const t = c.type || 'Okänd';\n                  (acc[t] = acc[t] || []).push(c);\n                  return acc;\n                }, {});\n                const types = Object.keys(byType).sort((a, b) => a.localeCompare(b));\n                if (types.length === 0) return null;\n                const labels = {\n                  Arbetsberedning: 'Arbetsberedningar',\n                  Egenkontroll: 'Egenkontroller',\n                  Fuktmätning: 'Fuktmätningar',\n                  Skyddsrond: 'Skyddsronder',\n                  Riskbedömning: 'Riskbedömningar',\n                };\n                return (\n                  <View style={styles.filterRow}>\n                    {['Alla', ...types].map((t) => (\n                      <TouchableOpacity\n                        key={t}\n                        onPress={() => { try { Haptics.selectionAsync(); } catch {}; setExportFilter(t); }}\n                        style={[styles.filterChip, exportFilter === t && styles.filterChipSelected]}\n                      >\n                        <Text style={[styles.filterChipText, exportFilter === t && styles.filterChipTextSelected]}>\n                          {t === 'Alla' ? 'Alla' : (labels[t] || t)}\n                        </Text>\n                      </TouchableOpacity>\n                    ))}\n                  </View>\n                );\n              })()}\n\n              <ScrollView style={{ maxHeight: 380 }}>\n                {/* Här kan du lägga till en preview av PDF-innehållet om du vill */}\n              </ScrollView>\n              <View style={{ marginTop: 10 }}>\n                <TouchableOpacity\n                  style={[\n                    {\n                      backgroundColor: '#fff',\n                      borderRadius: 8,\n                      borderWidth: 2,\n                      borderColor: '#222',\n                      alignItems: 'center',\n                      justifyContent: 'center',\n                      height: 44,\n                      marginBottom: 8,\n                      opacity: exportingPdf || controls.length === 0 ? 0.7 : 1,\n                    },\n                  ]}\n                  onPress={handlePreviewPdf}\n                  disabled={exportingPdf || controls.length === 0}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 14, letterSpacing: 0.2 }}>Förhandsvisa PDF</Text>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  style={[\n                    {\n                      backgroundColor: '#fff',\n                      borderRadius: 8,\n                      borderWidth: 2,\n                      borderColor: '#222',\n                      alignItems: 'center',\n                      justifyContent: 'center',\n                      height: 44,\n                      marginBottom: 8,\n                      opacity: exportingPdf || controls.length === 0 ? 0.7 : 1,\n                    },\n                  ]}\n                  onPress={handleExportPdf}\n                  disabled={exportingPdf || controls.length === 0}\n                >\n                  <Text style={{ color: '#222', fontWeight: '600', fontSize: 14, letterSpacing: 0.2 }}>{exportingPdf ? 'Genererar…' : 'Exportera PDF'}</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </KeyboardAvoidingView>\n        </TouchableOpacity>\n      </Modal>\n    </ScrollView>\n  );\n}\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/RiskbedömningScreen.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/SkyddsrondScreen.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":151,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":151,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":192,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":192,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":225,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":225,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useRoute } from '@react-navigation/native';\nimport BaseControlForm from '../components/BaseControlForm';\nimport { auth, logCompanyActivity, saveControlToFirestore } from '../components/firebase';\nimport { formatPersonName } from '../components/formatPersonName';\n// Skyddsrond checklist config: sections with control points\nconst SKYDDSROND_CHECKLIST = [\n  {\n    label: 'Allmän ordning och reda',\n    points: [\n      'Är gångvägar och arbetsytor fria från hinder?',\n      'Är material och verktyg rätt placerade?',\n      'Är städning tillfredsställande?',\n      'KMA tavla finns på plats?',\n      'Arbetsmiljöplan är signerad av beställare?'\n    ]\n  },\n  {\n    label: 'Fallrisker och ställningar',\n    points: [\n      'Finns skyddsräcken där det behövs?',\n      'Är ställningar och stegar i gott skick?',\n      'Är öppningar och hål skyddade?',\n      'Övertagning av ställning har signerats och finns på plats',\n      'Sparkskydd finns monterade'\n    ]\n  },\n  {\n    label: 'Personlig skyddsutrustning',\n    points: [\n      'Används hjälm, skyddsskor och väst?',\n      'Finns behov av hörselskydd, ögonskydd eller handskar?'\n    ]\n  },\n  {\n    label: 'Maskiner och verktyg',\n    points: [\n      'Är maskiner och verktyg hela och rätt använda?',\n      'Finns skydd på maskiner där det krävs?'\n    ]\n  },\n  {\n    label: 'El och belysning',\n    points: [\n      'Är provisorisk el korrekt dragen?',\n      'Är kablar hela och rätt placerade?',\n      'Är arbetsbelysning tillräcklig?',\n      'Ledlister och elkablar sitter upphängda i den mån det går?'\n    ]\n  },\n  {\n    label: 'Kemi och farliga ämnen',\n    points: [\n      'Förvaras kemikalier och farliga ämnen säkert?',\n      'Är märkning och skyddsutrustning på plats?',\n      'Kemikaliepärm finns på plats?'\n    ]\n  },\n  {\n    label: 'Brandskydd',\n    points: [\n      'Finns brandsläckare och brandfilt?',\n      'Är brandsläckare besiktigade och godkända?',\n      'Är utrymningsvägar fria och skyltade?',\n      'Brandfarliga arbeten hanteras korrekt?'\n    ]\n  },\n  {\n    label: 'Lyft och transporter',\n    points: [\n      'Används rätt lyftanordningar?',\n      'Är kranar och truckar besiktigade?'\n    ]\n  },\n  {\n    label: 'Första hjälpen och olycksberedskap',\n    points: [\n      'Finns förbandslåda och rutiner?',\n      'Behöver förbandslådor fyllas på med material?',\n      'Nödsituation och skyddsorganisation finns anslaget?'\n    ]\n  },\n  {\n    label: 'Skyltning och avspärrningar',\n    points: [\n      'Finns nödvändiga varningsskyltar?',\n      'Är riskområden avspärrade?'\n    ]\n  },\n  {\n    label: 'Miljö',\n    points: [\n      'Hanteras avfall och spill korrekt?',\n      'Avfallscontainer är skyltade med fraktioner?',\n      'Förebyggs utsläpp?'\n    ]\n  }\n];\n\n\nfunction getWeekAndYear(dateInput) {\n  const d = dateInput ? new Date(dateInput) : new Date();\n  d.setHours(0, 0, 0, 0);\n  // Thursday in current week decides the year.\n  d.setDate(d.getDate() + 3 - ((d.getDay() + 6) % 7));\n  const week1 = new Date(d.getFullYear(), 0, 4);\n  // Calculate full weeks to nearest Thursday\n  const weekNo = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + ((week1.getDay() + 6) % 7)) / 7);\n  return { week: weekNo, year: d.getFullYear() };\n}\n\n\n\nexport default function SkyddsrondScreen({\n  date,\n  participants = [],\n  project: projectProp,\n  initialValues: initialValuesProp,\n  onExit,\n  onFinished,\n}) {\n  const route = useRoute();\n  const project = projectProp ?? route.params?.project;\n  const initialValuesRaw = (initialValuesProp ?? route.params?.initialValues) || {};\n  const initialValues = {\n    ...initialValuesRaw,\n    mottagningsSignatures: initialValuesRaw.mottagningsSignatures || [],\n  };\n  const { week, year } = getWeekAndYear(date);\n  const LABELS = {\n    title: `Skyddsrond ${year} V.${week < 10 ? '0' + week : week}`,\n    saveButton: 'Spara',\n    saveDraftButton: 'Spara och slutför senare',\n  };\n\n  const handleSave = async (data) => {\n    try {\n      const completed = {\n        ...data,\n        project: data.project || project,\n        status: 'UTFÖRD',\n        savedAt: new Date().toISOString(),\n        type: 'Skyddsrond',\n        id: data.id || require('uuid').v4(),\n      };\n      // Try saving to Firestore first (best-effort). If Firestore fails, fall back to local AsyncStorage.\n      try {\n        const ok = await saveControlToFirestore(completed);\n        if (!ok) throw new Error('Firestore save failed');\n      } catch(e) {\n        // fallback to local storage below\n      }\n      const existing = await AsyncStorage.getItem('completed_controls');\n      let arr = [];\n      if (existing) arr = JSON.parse(existing);\n      // Ersätt befintlig kontroll med samma id, annars lägg till\n      const idx = arr.findIndex(c => c.id === completed.id);\n      if (idx !== -1) {\n        arr[idx] = completed;\n      } else {\n        arr.push(completed);\n      }\n      await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\n      // Log activity (best-effort)\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: completed.type || 'Kontroll',\n          kind: 'completed',\n          projectId: completed.project?.id || null,\n          projectName: completed.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n        });\n      } catch(_e) {}\n      // Remove any matching drafts for this project+type\n      try {\n        const draftRaw = await AsyncStorage.getItem('draft_controls');\n        if (draftRaw) {\n          let drafts = JSON.parse(draftRaw) || [];\n          // If we have an id, remove only that draft. Otherwise remove drafts matching project+type.\n          if (data && data.id) {\n            drafts = drafts.filter(d => !(d.id === data.id && d.project?.id === project?.id && d.type === 'Skyddsrond'));\n          } else {\n            drafts = drafts.filter(d => !(d.project?.id === project?.id && d.type === 'Skyddsrond'));\n          }\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(drafts));\n        }\n      } catch(e) {}\n      // ...existing code...\n    } catch(e) {\n      alert('Kunde inte spara kontrollen: ' + e.message);\n    }\n  };\n\n  const handleSaveDraft = async (data) => {\n    // Persistence is handled centrally in BaseControlForm.saveDraftControl().\n    // This screen should not write to AsyncStorage to avoid overwriting richer\n    // draft objects maintained by the form (which include photos, participants).\n    try {\n      const draft = {\n        ...data,\n        project: data.project || project,\n        status: 'UTKAST',\n        savedAt: new Date().toISOString(),\n        type: 'Skyddsrond',\n        id: data.id || require('uuid').v4(),\n      };\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: draft.type || 'Kontroll',\n          kind: 'draft',\n          projectId: draft.project?.id || null,\n          projectName: draft.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n        });\n      } catch(_e) {}\n    } catch(e) {}\n  };\n\n  const WEATHER_OPTIONS = [\n    { key: 'Soligt', icon: 'sunny' },\n    { key: 'Delvis molnigt', icon: 'partly-sunny' },\n    { key: 'Molnigt', icon: 'cloudy' },\n    { key: 'Regn', icon: 'rainy' },\n    { key: 'Snö', icon: 'snow' },\n    { key: 'Åska', icon: 'thunderstorm' },\n  ];\n\n  return (\n    <BaseControlForm\n      date={date}\n      controlType=\"Skyddsrond\"\n      labels={LABELS}\n      participants={participants}\n      initialValues={initialValues}\n      project={project}\n      onSave={handleSave}\n      onSaveDraft={handleSaveDraft}\n      weatherOptions={WEATHER_OPTIONS}\n      checklistConfig={SKYDDSROND_CHECKLIST}\n      onExit={onExit}\n      onFinished={onFinished}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/Screens/TemplateControlScreen.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'routeParams' logical expression could make the dependencies of useMemo Hook (at line 122) change on every render. To fix this, wrap the initialization of 'routeParams' in its own useMemo() Hook.","line":40,"column":9,"nodeType":"VariableDeclarator","endLine":40,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useRoute } from '@react-navigation/native';\nimport { useEffect, useMemo, useState } from 'react';\nimport { Alert, Text, View } from 'react-native';\nimport { v4 as uuidv4 } from 'uuid';\nimport BaseControlForm from '../components/BaseControlForm';\nimport { auth, fetchCompanyMallar, logCompanyActivity, saveControlToFirestore } from '../components/firebase';\nimport { formatPersonName } from '../components/formatPersonName';\n\nfunction buildChecklistFromLayout(layout) {\n  try {\n    if (!layout || !Array.isArray(layout.sections)) return [];\n    const sections = layout.sections || [];\n    const out = sections\n      .map((section) => {\n        const label = String(section?.title || section?.label || '').trim();\n        const fields = Array.isArray(section?.fields) ? section.fields : [];\n        const points = fields\n          .map((field) => String(field?.label || field?.title || '').trim())\n          .filter(Boolean);\n        if (!label && points.length === 0) return null;\n        return { label, points };\n      })\n      .filter(Boolean);\n    return out;\n  } catch (_e) {\n    return [];\n  }\n}\n\nexport default function TemplateControlScreen({\n  date,\n  participants = [],\n  project: projectProp,\n  initialValues: initialValuesProp,\n  controlType: controlTypeProp,\n  onExit,\n  onFinished,\n}) {\n  const route = useRoute();\n  const routeParams = route?.params || {};\n  const project = projectProp ?? routeParams.project;\n  const initialValues = (initialValuesProp ?? routeParams.initialValues) || {};\n\n  const [template, setTemplate] = useState(routeParams.template || null);\n  const [loading, setLoading] = useState(!routeParams.template && !!routeParams.templateId && !!routeParams.companyId);\n  const [error, setError] = useState('');\n\n  useEffect(() => {\n    let cancelled = false;\n    (async () => {\n      try {\n        if (template || !routeParams.templateId || !routeParams.companyId) return;\n        setLoading(true);\n        const items = await fetchCompanyMallar(routeParams.companyId).catch(() => []);\n        if (cancelled) return;\n        const found = Array.isArray(items)\n          ? items.find((tpl) => String(tpl.id) === String(routeParams.templateId))\n          : null;\n        if (found) {\n          setTemplate(found);\n          setError('');\n        } else {\n          setError('Kunde inte hitta vald mall.');\n        }\n      } catch (e) {\n        if (!cancelled) {\n          setError(String(e?.message || e));\n        }\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [template, routeParams.templateId, routeParams.companyId]);\n\n  const layout = useMemo(() => (template && template.layout ? template.layout : null), [template]);\n\n  const checklistConfig = useMemo(() => buildChecklistFromLayout(layout), [layout]);\n\n  const hideWeather = useMemo(() => {\n    try {\n      const meta = layout && layout.metaFields ? layout.metaFields : null;\n      if (!meta || !Object.prototype.hasOwnProperty.call(meta, 'weather')) return true;\n      const w = meta.weather;\n      return !(w && typeof w.enabled === 'boolean' ? w.enabled : false);\n    } catch (_e) {\n      return true;\n    }\n  }, [layout]);\n\n  const hideProjectHeader = useMemo(() => {\n    try {\n      const meta = layout && layout.metaFields ? layout.metaFields : null;\n      if (!meta || !Object.prototype.hasOwnProperty.call(meta, 'project')) return false;\n      const p = meta.project;\n      return !(p && typeof p.enabled === 'boolean' ? p.enabled : false);\n    } catch (_e) {\n      return false;\n    }\n  }, [layout]);\n\n  const WEATHER_OPTIONS = useMemo(\n    () => [\n      { key: 'Soligt', icon: 'sunny' },\n      { key: 'Delvis molnigt', icon: 'partly-sunny' },\n      { key: 'Molnigt', icon: 'cloudy' },\n      { key: 'Regn', icon: 'rainy' },\n      { key: 'Snö', icon: 'snow' },\n      { key: 'Åska', icon: 'thunderstorm' },\n    ],\n    []\n  );\n\n  const controlType = useMemo(() => {\n    if (template && template.controlType) return String(template.controlType);\n    if (template && template.title) return String(template.title);\n    if (controlTypeProp) return String(controlTypeProp);\n    if (routeParams && routeParams.controlType) return String(routeParams.controlType);\n    return 'Kontroll';\n  }, [template, controlTypeProp, routeParams]);\n\n  const LABELS = useMemo(\n    () => ({\n      title: template?.title || controlType || 'Kontroll',\n      saveButton: 'Spara',\n      saveDraftButton: 'Spara och slutför senare',\n    }),\n    [template, controlType]\n  );\n\n  const handleSave = async (data) => {\n    try {\n      const completed = {\n        ...data,\n        project: data.project || project,\n        status: 'UTFÖRD',\n        savedAt: new Date().toISOString(),\n        type: controlType || 'Kontroll',\n        id: data.id || uuidv4(),\n        templateId: template?.id || routeParams.templateId || null,\n        templateVersion: template?.version || null,\n      };\n\n      await saveControlToFirestore(completed);\n\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: completed.type || 'Kontroll',\n          kind: 'completed',\n          projectId: completed.project?.id || null,\n          projectName: completed.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n          templateId: completed.templateId || null,\n          templateVersion: completed.templateVersion || null,\n        });\n      } catch (_e) {}\n    } catch (e) {\n      try {\n        Alert.alert('Fel', 'Kunde inte spara kontrollen: ' + (e && e.message ? e.message : String(e)));\n      } catch (_e) {\n        // Fallback för web om Alert inte finns\n         \n        alert('Kunde inte spara kontrollen: ' + (e && e.message ? e.message : String(e)));\n      }\n    }\n  };\n\n  const handleSaveDraft = async (data) => {\n    try {\n      const draft = {\n        ...data,\n        project: data.project || project,\n        status: 'UTKAST',\n        savedAt: new Date().toISOString(),\n        type: controlType || 'Kontroll',\n        id: data.id || uuidv4(),\n        templateId: template?.id || routeParams.templateId || null,\n        templateVersion: template?.version || null,\n      };\n\n      try {\n        const user = auth?.currentUser;\n        const actorName = user ? (user.displayName || formatPersonName(user.email || user)) : null;\n        await logCompanyActivity({\n          type: draft.type || 'Kontroll',\n          kind: 'draft',\n          projectId: draft.project?.id || null,\n          projectName: draft.project?.name || null,\n          actorName: actorName || null,\n          actorEmail: user?.email || null,\n          uid: user?.uid || null,\n          templateId: draft.templateId || null,\n          templateVersion: draft.templateVersion || null,\n        });\n      } catch (_e) {}\n    } catch (_e) {}\n  };\n\n  if (loading && !template) {\n    return (\n      <View style={{ flex: 1, alignItems: 'center', justifyContent: 'center', padding: 16 }}>\n        <Text style={{ fontSize: 16, color: '#555' }}>Laddar mall...</Text>\n      </View>\n    );\n  }\n\n  if (!template && error) {\n    return (\n      <View style={{ flex: 1, alignItems: 'center', justifyContent: 'center', padding: 16 }}>\n        <Text style={{ fontSize: 16, color: '#D32F2F', textAlign: 'center' }}>{error}</Text>\n      </View>\n    );\n  }\n\n  return (\n    <BaseControlForm\n      date={date}\n      controlType={controlType}\n      labels={LABELS}\n      participants={participants}\n      project={project}\n      initialValues={initialValues}\n      onSave={handleSave}\n      onSaveDraft={handleSaveDraft}\n      hideWeather={hideWeather}\n      hideProjectHeader={hideProjectHeader}\n      weatherOptions={WEATHER_OPTIONS}\n      checklistConfig={checklistConfig}\n      onExit={onExit}\n      onFinished={onFinished}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ActivityPanel.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":15,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":26,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":44,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":46,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":53,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":44},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'nameMap'. Either include it or remove the dependency array.","line":79,"column":6,"nodeType":"ArrayExpression","endLine":79,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [items, nameMap]","fix":{"range":[2817,2824],"text":"[items, nameMap]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState } from 'react';\nimport { fetchUserProfile, subscribeCompanyActivity } from './firebase';\n\nfunction _toDisplayDate(ts) {\n  try {\n    if (ts === null || ts === undefined) return '';\n    if (typeof ts === 'number') return new Date(ts).toLocaleString();\n    if (typeof ts === 'string') return new Date(ts).toLocaleString();\n    if (typeof ts?.toDate === 'function') return new Date(ts.toDate().getTime()).toLocaleString();\n    if (typeof ts?.seconds === 'number') {\n      const ms = (Number(ts.seconds) * 1000) + (typeof ts.nanoseconds === 'number' ? Math.floor(ts.nanoseconds / 1e6) : 0);\n      return new Date(ms).toLocaleString();\n    }\n    return new Date(ts).toLocaleString();\n  } catch (e) {\n    return '';\n  }\n}\n\nfunction _resolveWebCompanyId() {\n  try {\n    if (typeof window !== 'undefined' && window.localStorage) {\n      const v = String(window.localStorage.getItem('dk_companyId') || '').trim();\n      if (v) return v;\n    }\n  } catch (e) {}\n  return null;\n}\n\nexport default function ActivityPanel() {\n  const [items, setItems] = useState([]);\n  const [nameMap, setNameMap] = useState({});\n  const pendingRef = useRef({});\n\n  useEffect(() => {\n    const cid = _resolveWebCompanyId();\n    const unsub = subscribeCompanyActivity(cid || null, {\n      onData: (data) => {\n        try {\n          if (typeof window !== 'undefined' && window.console && window.console.debug) {\n            try {\n              const sample = Array.isArray(data) ? data.slice(0, 12) : data;\n              console.debug('subscribeCompanyActivity: raw items (sample):', sample);\n            } catch (e) {}\n          }\n        } catch (e) {}\n        const arr = Array.isArray(data) ? data.slice(0, 12) : [];\n        setItems(arr);\n      },\n      onError: () => {},\n      limitCount: 25,\n    });\n    return () => { try { unsub(); } catch(e) {} };\n  }, []);\n\n  // Resolve display names for any uid present in items\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      try {\n        const uids = Array.from(new Set(items.map(it => it && (it.uid || it.userId)).filter(Boolean)));\n        const toFetch = uids.filter(u => !nameMap[u] && !pendingRef.current[u]);\n        if (toFetch.length === 0) return;\n        for (const uid of toFetch) pendingRef.current[uid] = true;\n        await Promise.all(toFetch.map(async (uid) => {\n          try {\n            const profile = await fetchUserProfile(uid);\n            if (!mounted) return;\n            setNameMap(prev => ({ ...prev, [uid]: (profile && (profile.displayName || (profile.name || '')) ) || null }));\n          } catch(_e) {\n            // ignore\n          } finally {\n            try { delete pendingRef.current[uid]; } catch(_e) {}\n          }\n        }));\n      } catch(_e) {}\n    })();\n    return () => { mounted = false; };\n  }, [items]);\n\n  return (\n    <div style={{ width: 260, padding: 8, fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif' }}>\n      <div style={{ background: '#fff', borderRadius: 8, padding: 10, border: '1px solid #eee' }}>\n        <div style={{ fontSize: 14, fontWeight: 600, color: '#222', marginBottom: 6 }}>Senaste aktivitet</div>\n        {items.length === 0 ? (\n          <div style={{ color: '#888', fontSize: 13 }}>Inga händelser än.</div>\n        ) : (\n          items.map(it => {\n            const uid = it?.uid || it?.userId || it?.createdBy || null;\n            const actorDisplay = it?.actorName || nameMap[uid] || it?.actorEmail || it?.displayName || '';\n            const baseLabel = (it?.label || it?.message || (it?.eventType || 'Händelse')) || '';\n            const labelText = actorDisplay ? `${baseLabel} — av ${actorDisplay}` : baseLabel;\n            return (\n              <div key={it.id} style={{ padding: '6px 0', borderBottom: '1px solid #f3f3f3' }}>\n                <div style={{ fontSize: 13, color: '#222', marginBottom: 4 }}>{labelText}</div>\n                <div style={{ display: 'flex', justifyContent: 'flex-end', alignItems: 'center' }}>\n                  <div style={{ fontSize: 12, color: '#888' }}>{_toDisplayDate(it?.ts || it?.createdAt || it?.updatedAt)}</div>\n                </div>\n              </div>\n            );\n          })\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/BaseControlForm.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":61,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":73,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'clearAllPhotos' is assigned a value but never used.","line":250,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":250,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"clearAllPhotos"},"fix":{"range":[8517,8857],"text":""},"desc":"Remove unused variable 'clearAllPhotos'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'signerKeyboardShift' is assigned a value but never used.","line":262,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":262,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"signerKeyboardShift"},"fix":{"range":[8988,9007],"text":""},"desc":"Remove unused variable 'signerKeyboardShift'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":270,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":270,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'setQualityDesc' is assigned a value but never used.","line":293,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":293,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setQualityDesc"},"fix":{"range":[10284,10300],"text":""},"desc":"Remove unused variable 'setQualityDesc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setCoverageDesc' is assigned a value but never used.","line":294,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":294,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCoverageDesc"},"fix":{"range":[10368,10385],"text":""},"desc":"Remove unused variable 'setCoverageDesc'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'visibleTint' is assigned a value but never used.","line":311,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":311,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"visibleTint"},"fix":{"range":[11384,11478],"text":""},"desc":"Remove unused variable 'visibleTint'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onTintColor' is assigned a value but never used.","line":312,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":312,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"onTintColor"},"fix":{"range":[11481,11569],"text":""},"desc":"Remove unused variable 'onTintColor'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'routeParams' conditional could make the dependencies of useMemo Hook (at line 733) change on every render. To fix this, wrap the initialization of 'routeParams' in its own useMemo() Hook.","line":319,"column":9,"nodeType":"VariableDeclarator","endLine":319,"endColumn":64},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":344,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":344,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":348,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":47},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":387,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":387,"endColumn":51},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":407,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":407,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":415,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":415,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":416,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":416,"endColumn":58},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":417,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":417,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":425,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":425,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":432,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":432,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":438,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":438,"endColumn":74},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":439,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":439,"endColumn":88},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":482,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":482,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":498,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":498,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":535,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":535,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":642,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":642,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'dateValue', 'initialValues', and 'todayIso'. Either include them or remove the dependency array.","line":811,"column":6,"nodeType":"ArrayExpression","endLine":811,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [date, dateValue, initialValues, todayIso]","fix":{"range":[35254,35297],"text":"[date, dateValue, initialValues, todayIso]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":811,"column":13,"nodeType":"LogicalExpression","endLine":811,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'setGeneralNote' is assigned a value but never used.","line":813,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":813,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"setGeneralNote"},"fix":{"range":[35425,35441],"text":""},"desc":"Remove unused variable 'setGeneralNote'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'participantsLabel'. Either include it or remove the dependency array.","line":850,"column":6,"nodeType":"ArrayExpression","endLine":850,"endColumn":115,"suggestions":[{"desc":"Update the dependencies array to be: [missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures, participantsLabel]","fix":{"range":[37221,37330],"text":"[missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures, participantsLabel]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'shallowEqual'. Either include it or remove the dependency array.","line":867,"column":6,"nodeType":"ArrayExpression","endLine":867,"endColumn":426,"suggestions":[{"desc":"Update the dependencies array to be: [shallowEqual, localParticipants, initialParticipants, checklist, initialChecklist, dateValue, initialDate, selectedWeather, initialWeather, byggdel, initialByggdel, deliveryDesc, initialDeliveryDesc, generalNote, initialGeneralNote, materialDesc, initialMaterialDesc, qualityDesc, initialQualityDesc, coverageDesc, initialCoverageDesc, mottagningsSignatures, initialMottagningsSignatures, mottagningsPhotos, initialMottagningsPhotos]","fix":{"range":[38220,38640],"text":"[shallowEqual, localParticipants, initialParticipants, checklist, initialChecklist, dateValue, initialDate, selectedWeather, initialWeather, byggdel, initialByggdel, deliveryDesc, initialDeliveryDesc, generalNote, initialGeneralNote, materialDesc, initialMaterialDesc, qualityDesc, initialQualityDesc, coverageDesc, initialCoverageDesc, mottagningsSignatures, initialMottagningsSignatures, mottagningsPhotos, initialMottagningsPhotos]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'showCreateByggdelMoment' is assigned a value but never used.","line":902,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":902,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"showCreateByggdelMoment"},"fix":{"range":[41280,41303],"text":""},"desc":"Remove unused variable 'showCreateByggdelMoment'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'newByggdelMomentName' is assigned a value but never used.","line":903,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":903,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"newByggdelMomentName"},"fix":{"range":[41361,41381],"text":""},"desc":"Remove unused variable 'newByggdelMomentName'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'createMallKeyboardHeight'. Either include it or remove the dependency array.","line":912,"column":6,"nodeType":"ArrayExpression","endLine":912,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [createMallKeyboardHeight, showCreateByggdelMallModal]","fix":{"range":[41899,41927],"text":"[createMallKeyboardHeight, showCreateByggdelMallModal]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":929,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":929,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":930,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":930,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":950,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":950,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":951,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":951,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":956,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":956,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":968,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":968,"endColumn":60},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1117,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1117,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1127,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":1127,"endColumn":42},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1131,"column":72,"nodeType":"Identifier","messageId":"unusedVar","endLine":1131,"endColumn":73},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1138,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1138,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1142,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1142,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1203,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1203,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1227,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1227,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1301,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1301,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1355,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1355,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'applySelectedCategoriesToChecklist', 'checklist', and 'project'. Either include them or remove the dependency array.","line":1357,"column":6,"nodeType":"ArrayExpression","endLine":1357,"endColumn":74,"suggestions":[{"desc":"Update the dependencies array to be: [controlType, checklistConfig, initialValues, project, checklist, applySelectedCategoriesToChecklist]","fix":{"range":[62295,62363],"text":"[controlType, checklistConfig, initialValues, project, checklist, applySelectedCategoriesToChecklist]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":1357,"column":20,"nodeType":"LogicalExpression","endLine":1357,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1427,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1427,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'defaultByggdelMomentsByGroup' and 'project'. Either include them or remove the dependency array.","line":1431,"column":6,"nodeType":"ArrayExpression","endLine":1431,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [controlType, defaultByggdelMomentsByGroup, project]","fix":{"range":[65178,65214],"text":"[controlType, defaultByggdelMomentsByGroup, project]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":1431,"column":20,"nodeType":"LogicalExpression","endLine":1431,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1479,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":1479,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1486,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1486,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1490,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1490,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1589,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":1589,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1591,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1591,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1597,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1597,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1606,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1606,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1634,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1634,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1647,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1647,"endColumn":14},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'processCameraResult' function makes the dependencies of useEffect Hook (at line 1878) change on every render. To fix this, wrap the definition of 'processCameraResult' in its own useCallback() Hook.","line":1670,"column":9,"nodeType":"VariableDeclarator","endLine":1821,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'processCameraResult' in its own useCallback() Hook.","fix":{"range":[76901,84105],"text":"useCallback((cameraResult) => {\n    if (!cameraResult) return;\n    // ...existing code...\n    const { uri, sectionIdx, pointIdx, returnedMottagningsPhotos } = cameraResult;\n    if (returnedMottagningsPhotos && Array.isArray(returnedMottagningsPhotos)) {\n      try {\n        const norm = normalizePhotos(returnedMottagningsPhotos);\n        // Filter duplicates by uri\n        const prev = mottagningsPhotosRef.current || [];\n        const existingUris = new Set(prev.map(p => p && p.uri).filter(Boolean));\n        const toAdd = norm.filter(p => p && p.uri && !existingUris.has(p.uri));\n        // Attach any new returned photo URIs to the specific checklist point (if provided)\n        try {\n          if (sectionIdx !== undefined && pointIdx !== undefined) {\n            const urisToAttach = toAdd.map(p => p.uri).filter(Boolean);\n              if (urisToAttach.length > 0) {\n              // ...existing code...\n              const prevChecklist = checklistRef.current || [];\n              const updated = prevChecklist.map((section, sIdx) => {\n                if (sIdx !== sectionIdx) return section;\n                const points = Array.isArray(section.points) ? section.points : [];\n                let photos = Array.isArray(section.photos) && section.photos.length === points.length\n                  ? [...section.photos]\n                  : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\n                photos[pointIdx] = Array.isArray(photos[pointIdx]) ? photos[pointIdx] : [];\n                photos[pointIdx] = [...photos[pointIdx], ...urisToAttach];\n                return { ...section, photos, points };\n              });\n              setChecklist(updated);\n              checklistRef.current = updated;\n              setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\n              // Persist draft with updated checklist (merge/upsert to avoid overwriting richer state)\n              (async () => {\n                try {\n                  const toSaveId = draftId || uuidv4();\n                  try { setDraftId(toSaveId); } catch(e) {}\n                  const draftObj = {\n                    id: toSaveId,\n                    date: dateValue,\n                    project,\n                    ...weatherPayload,\n                    byggdel,\n                    byggdelTemplate,\n                    participants: localParticipants,\n                    materialDesc,\n                    qualityDesc,\n                    coverageDesc,\n                    mottagningsSignatures,\n                    mottagningsPhotos,\n                    checklist: updated,\n                    expandedChecklist,\n                    deliveryDesc,\n                    generalNote,\n                    type: controlType,\n                    savedAt: new Date().toISOString(),\n                  };\n                  try {\n                    await persistDraftObject(draftObj);\n                    // ...existing code...\n                  } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\n                } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\n              })();\n            }\n          }\n        } catch(e) {}\n        if (toAdd.length === 0) {\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n          return;\n        }\n        setMottagningsPhotos(prevState => {\n          const next = [...(prevState || []), ...toAdd];\n          mottagningsPhotosRef.current = next;\n          return next;\n        });\n        // ...existing code...\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n      } catch(e) {}\n    } else if (uri) {\n      if (processedCameraUrisRef.current.has(uri)) {\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n        return;\n      }\n      if (controlType === 'Mottagningskontroll') {\n        try {\n          processedCameraUrisRef.current.add(uri);\n          setMottagningsPhotos(prev => {\n            const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\n            // avoid duplicates\n            if (prevArr.findIndex(x => x && x.uri === uri) !== -1) return prevArr;\n            const newItem = { uri, comment: '' };\n            const next = [...prevArr, newItem];\n            mottagningsPhotosRef.current = next;\n            return next;\n          });\n          try { console.log('[BaseControlForm] appended uri to mottagningsPhotos, item:', uri); } catch(e) {}\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n        } catch(e) {}\n      } else if (sectionIdx !== undefined && pointIdx !== undefined) {\n        try {\n          const prev = checklistRef.current || [];\n          const newChecklist = prev.map((section, sIdx) => {\n            if (sIdx !== sectionIdx) return section;\n            const points = Array.isArray(section.points) ? section.points : [];\n            let photos = Array.isArray(section.photos) && section.photos.length === points.length\n              ? [...section.photos]\n              : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\n            if (!Array.isArray(photos[pointIdx])) photos[pointIdx] = photos[pointIdx] ? [photos[pointIdx]] : [];\n            photos[pointIdx] = [...photos[pointIdx], uri];\n            return { ...section, photos, points };\n          });\n          setChecklist(newChecklist);\n          checklistRef.current = newChecklist;\n          setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n          // Persist updated checklist (including photos) to draft controls immediately so\n          // photos added from CameraCapture are not lost if the user navigates away.\n          (async () => {\n            try {\n              const toSaveId = draftId || uuidv4();\n              try { setDraftId(toSaveId); } catch(e) {}\n              const draftObj = {\n                id: toSaveId,\n                date: dateValue,\n                project,\n                ...weatherPayload,\n                byggdel,\n                byggdelTemplate,\n                participants: localParticipants,\n                materialDesc,\n                qualityDesc,\n                coverageDesc,\n                mottagningsSignatures,\n                mottagningsPhotos,\n                checklist: newChecklist,\n                expandedChecklist,\n                deliveryDesc,\n                generalNote,\n                type: controlType,\n                savedAt: new Date().toISOString(),\n              };\n              try {\n                await persistDraftObject(draftObj);\n                try { console.log('[BaseControlForm] persisted draft after uri add, id:', draftObj.id); } catch(e) {}\n              } catch(e) { try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {} }\n            } catch(e) {\n              try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {}\n            }\n          })();\n        } catch(e) {}\n      }\n    }\n  })"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1705,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":1705,"endColumn":56},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1729,"column":112,"nodeType":"Identifier","messageId":"unusedVar","endLine":1729,"endColumn":113},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1730,"column":110,"nodeType":"Identifier","messageId":"unusedVar","endLine":1730,"endColumn":111},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1734,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1734,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1736,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1736,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1745,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":1745,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1746,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1746,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1749,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":1749,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1764,"column":105,"nodeType":"Identifier","messageId":"unusedVar","endLine":1764,"endColumn":106},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1765,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1765,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1766,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1766,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1783,"column":76,"nodeType":"Identifier","messageId":"unusedVar","endLine":1783,"endColumn":77},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1789,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":1789,"endColumn":52},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1812,"column":113,"nodeType":"Identifier","messageId":"unusedVar","endLine":1812,"endColumn":114},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1813,"column":109,"nodeType":"Identifier","messageId":"unusedVar","endLine":1813,"endColumn":110},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1815,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":1815,"endColumn":97},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1818,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1818,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'processCameraResult'. Either include it or remove the dependency array.","line":1829,"column":6,"nodeType":"ArrayExpression","endLine":1829,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [processCameraResult, route.params?.cameraResult]","fix":{"range":[84413,84441],"text":"[processCameraResult, route.params?.cameraResult]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'prev' is assigned a value but never used.","line":1847,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1847,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"prev"},"fix":{"range":[85265,85346],"text":""},"desc":"Remove unused variable 'prev'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1849,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":1849,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1851,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1851,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'processCameraResult'. Either include it or remove the dependency array.","line":1857,"column":6,"nodeType":"ArrayExpression","endLine":1857,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [navigation, processCameraResult, route.key]","fix":{"range":[85665,85688],"text":"[navigation, processCameraResult, route.key]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1869,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":1869,"endColumn":61},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1872,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1872,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1910,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1910,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1917,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1917,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1926,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1926,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1980,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":1980,"endColumn":44},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1989,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":1989,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1991,"column":94,"nodeType":"Identifier","messageId":"unusedVar","endLine":1991,"endColumn":95},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1998,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":1998,"endColumn":68},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2018,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2018,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2068,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2068,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2072,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2072,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2077,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2077,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2079,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":2079,"endColumn":53},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2095,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2095,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2156,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2156,"endColumn":50},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2157,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":2157,"endColumn":49},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2160,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":2160,"endColumn":57},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2170,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":2170,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2172,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":2172,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2268,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2268,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2331,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":2331,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2462,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2462,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2799,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":2799,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2988,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":2988,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3749,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":3749,"endColumn":36},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":3896,"column":81,"nodeType":"Identifier","messageId":"unusedVar","endLine":3896,"endColumn":82},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4175,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4175,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4473,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4473,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4535,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":4535,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'showGreenCheck' is assigned a value but never used.","line":4542,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":4542,"endColumn":33},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4554,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":4554,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'total' is assigned a value but never used.","line":4582,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":4582,"endColumn":34,"suggestions":[{"messageId":"removeVar","data":{"varName":"total"},"fix":{"range":[255022,255071],"text":""},"desc":"Remove unused variable 'total'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4632,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":4632,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4633,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":4633,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4644,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":4644,"endColumn":34},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4656,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":4656,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4838,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":4838,"endColumn":48},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":4854,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":4854,"endColumn":46},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5069,"column":181,"nodeType":"Identifier","messageId":"unusedVar","endLine":5069,"endColumn":182},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5077,"column":159,"nodeType":"Identifier","messageId":"unusedVar","endLine":5077,"endColumn":160},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5088,"column":160,"nodeType":"Identifier","messageId":"unusedVar","endLine":5088,"endColumn":161},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5218,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":5218,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5219,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":5219,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5248,"column":123,"nodeType":"Identifier","messageId":"unusedVar","endLine":5248,"endColumn":124},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5272,"column":62,"nodeType":"Identifier","messageId":"unusedVar","endLine":5272,"endColumn":63},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":5275,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":5275,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":132,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\n\n\n\n\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useNavigation, useRoute } from '@react-navigation/native';\nimport { useEffect, useMemo, useRef, useState } from 'react';\n\n// import BottomSheet from '@gorhom/bottom-sheet';\nimport { Alert, Dimensions, Image, InteractionManager, Keyboard, KeyboardAvoidingView, LayoutAnimation, Modal, PanResponder, Platform, Pressable, ScrollView, Text, TextInput, TouchableOpacity, UIManager, useColorScheme, useWindowDimensions, View } from 'react-native';\n\nimport Ionicons from '@expo/vector-icons/Ionicons';\nimport MaterialIcons from '@expo/vector-icons/MaterialIcons';\nimport 'react-native-get-random-values';\nimport Svg, { Path } from 'react-native-svg';\nimport { v4 as uuidv4 } from 'uuid';\nimport { Colors } from '../constants/theme';\nimport { createByggdelMall, deleteByggdelMall, deleteDraftControlFromFirestore, fetchByggdelHierarchy, fetchByggdelMallar, saveByggdelHierarchy, saveDraftToFirestore, updateByggdelMall } from './firebase';\nimport { CompanyHeaderLogo } from './HeaderComponents';\n// Load ImagePicker dynamically inside handlers to avoid web-only export issues\nlet ImagePicker = null;\n\nexport default function BaseControlForm({\n  project,\n  participants = [],\n  date,\n  weatherOptions = [],\n  checklistConfig = [],\n  controlType = '',\n  labels = {},\n  onSave,\n  onSaveDraft,\n  onExit,\n  onFinished,\n  initialValues = {},\n  hideWeather = false,\n  hideProjectHeader = false,\n  templatePreviewMode = false,\n}) {\n  const { height: windowHeight } = useWindowDimensions();\n  const onExitRef = useRef(onExit);\n  useEffect(() => {\n    onExitRef.current = onExit;\n  }, [onExit]);\n\n  const arbetsberedningCategoryKey = (projectId) => `dk_ab_categories_${String(projectId || '').trim()}`;\n  const arbetsberedningActiveByggdelKey = (projectId) => `dk_ab_active_byggdel_${String(projectId || '').trim()}`;\n  const didInitArbetsberedningCategoriesRef = useRef(false);\n  const loadedAktivaByggdelPidRef = useRef('');\n\n  const suppressNextMallPressRef = useRef(false);\n  const formatByggdelLabelFromTemplate = (tpl) => {\n    try {\n      if (!tpl) return '';\n      const hg = tpl.huvudgrupp || '';\n      const mm = tpl.moment || '';\n      const nm = tpl.mallName || tpl.name || '';\n      const parts = [hg, mm, nm].map(x => String(x || '').trim()).filter(Boolean);\n      return parts.join(' / ');\n    } catch(e) {\n      return '';\n    }\n  };\n\n  const formatByggdelMomentLabelFromTemplate = (tpl) => {\n    try {\n      if (!tpl) return '';\n      const hg = tpl.huvudgrupp || '';\n      const mm = tpl.moment || '';\n      const parts = [hg, mm].map(x => String(x || '').trim()).filter(Boolean);\n      return parts.join(' / ');\n    } catch(e) {\n      return '';\n    }\n  };\n\n  const fixedByggdelHuvudgrupper = useMemo(() => (\n    [\n      '0 - Sammansatta byggdelar',\n      '1 - Mark',\n      '2 - Husunderbyggnad',\n      '3 - Stomme',\n      '4 - Yttertak',\n      '5 - Fasad',\n      '6 - Stomkomplettering',\n      '7 - Invändiga ytskikt',\n      '8 - Installationer',\n      '9 - Gemensamma arbeten',\n    ]\n  ), []);\n\n  const byggdelHuvudgruppOptions = fixedByggdelHuvudgrupper;\n\n  const defaultByggdelMomentsByGroup = useMemo(() => (\n    {\n      // Prefer numeric prefix keys so labels can change without breaking lookups\n      '0': ['03 - Rivning', '06 - Håltagning'],\n      '1': ['10 - Markarbeten'],\n      '2': ['23 - Markförstärkningar', '24 - Grundkonstruktioner', '25 - Kulvert', '27 - Platta på mark'],\n      '3': [\n        '30 - Sammansatta',\n        '31 - Väggar',\n        '32 - Pelare',\n        '33 - Prefab',\n        '34 - Bjälklag/Balkar',\n        '35 - Smide',\n        '36 - Trappor/Hiss/Schakt',\n        '37 - Samverkande takstomme',\n        '38 - Huskomplettering',\n        '39 - Hall/UE (Tätt hus)',\n      ],\n      '4': [\n        '40 - Sammansatta',\n        '41 - Takstomme',\n        '42 - Taklagskomplettering',\n        '43 - Taktäckning',\n        '44 - Takfot & gavlar',\n        '45 - Öppningskomplettering (takluckor)',\n        '47 - Terrasser/altaner',\n        '48 - Huskomplettering',\n        '49 - Plåt',\n      ],\n      '5': [\n        '50 - Sammansatta',\n        '51 - Stomkomplettering (utfackning)',\n        '53 - Fasadbeklädnad/ytskikt',\n        '55 - Fönster/dörrar/partier',\n        '56 - Utvändiga trappor',\n        '58 - Huskomplettering',\n      ],\n      '6': [\n        '60 - Sammansatta',\n        '61 - Insida yttervägg',\n        '62 - Undergolv',\n        '63 - Innerväggar',\n        '64 - Innertak',\n        '65 - Invändiga dörrar & partier',\n        '66 - Invändiga trappor',\n        '67 - Brandskydd',\n        '68 - Huskomplettering',\n        '69 - Lås & passer',\n      ],\n      '7': [\n        '70 - Sammansatta',\n        '71 - Kakel/klinkers/keramik',\n        '72 - Ytskikt golv & trappor',\n        '73 - Ytskikt vägg',\n        '74 - Ytskikt tak/undertak',\n        '75 - Målning',\n        '76 - Vita varor',\n        '77 - Skåp & inredningssnickerier',\n        '78 - Rumskomplettering/övrigt',\n      ],\n      '8': [\n        '80 - Sammansatta',\n        '81 - Sprinkler',\n        '82 - Process',\n        '83 - Storkök',\n        '84 - Sanitet/värme',\n        '85 - Luft',\n        '86 - El',\n        '87 - Transport',\n        '88 - Styr',\n        '89 - Kyla',\n      ],\n      '9': [\n        '90 - Hyresmaskiner',\n        '91 - Gemensamma arbeten',\n        '92 - Ställningar',\n        '94 - Kran & lyft',\n        '96 - Bodar/etablering',\n        '98 - Konsulter',\n        '99 - TJ-tid',\n      ],\n    }\n  ), []);\n\n  const mergeByggdelMomentsByGroup = (existing) => {\n    const safeExisting = (existing && typeof existing === 'object') ? existing : {};\n    let changed = false;\n    const merged = { ...safeExisting };\n\n    const mergeList = (current, additions) => {\n      const base = Array.isArray(current) ? current.map(x => String(x || '').trim()).filter(Boolean) : [];\n      const add = Array.isArray(additions) ? additions.map(x => String(x || '').trim()).filter(Boolean) : [];\n      const set = new Set(base);\n      const out = [...base];\n      for (const item of add) {\n        if (!set.has(item)) {\n          set.add(item);\n          out.push(item);\n        }\n      }\n      return out;\n    };\n\n    for (const key of Object.keys(defaultByggdelMomentsByGroup)) {\n      const defaults = defaultByggdelMomentsByGroup[key];\n      const current = merged[key];\n      const next = mergeList(current, defaults);\n      if (!Array.isArray(current) || next.length !== (Array.isArray(current) ? current.length : 0)) {\n        merged[key] = next;\n        changed = true;\n      }\n    }\n\n    return { merged, changed };\n  };\n  // State för deltagar-modalens fält (måste ligga här!)\n  const [participantName, setParticipantName] = useState('');\n  const [participantCompany, setParticipantCompany] = useState('');\n  // State för åtgärd (remediation)\n  const [remediationModal, setRemediationModal] = useState({ visible: false, sectionIdx: null, pointIdx: null, comment: '', name: '', date: '', infoMode: false });\n  // expandedChecklist is declared above (moved earlier)\n  // State for adding custom checklist points\n  const [addPointModal, setAddPointModal] = useState({ visible: false, sectionIdx: null });\n  const [newPointText, setNewPointText] = useState('');\n  const [newPointActionText, setNewPointActionText] = useState('');\n  const [sectionMenuIndex, setSectionMenuIndex] = useState(null);\n  const [participantRole, setParticipantRole] = useState('');\n  const [participantPhone, setParticipantPhone] = useState('');\n  const [editParticipantIndex, setEditParticipantIndex] = useState(null);\n  // State for cancel edit confirmation modal\n  const [showCancelEditConfirm, setShowCancelEditConfirm] = useState(false);\n  // Refs för TextInput-fokus i deltagar-modal (måste ligga här!)\n  const nameRef = useRef();\n  const companyRef = useRef();\n  const roleRef = useRef();\n\n  // Enable LayoutAnimation on Android\n  useEffect(() => {\n    if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {\n      UIManager.setLayoutAnimationEnabledExperimental(true);\n    }\n  }, []);\n\n  // Keep all sections closed by default; user will open manually (accordion behavior)\n\n  const markAllOk = (sectionIdx) => {\n    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n    setChecklist(prev => prev.map((s, idx) => {\n      if (idx !== sectionIdx) return s;\n      const statuses = Array((s.points || []).length).fill('ok');\n      return { ...s, statuses };\n    }));\n    setSectionMenuIndex(null);\n  };\n\n  const clearAllPhotos = (sectionIdx) => {\n    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n    setChecklist(prev => prev.map((s, idx) => {\n      if (idx !== sectionIdx) return s;\n      const photos = Array((s.points || []).length).fill([]);\n      return { ...s, photos };\n    }));\n    setSectionMenuIndex(null);\n  };\n  const phoneRef = useRef();\n  const [missingFields, setMissingFields] = useState([]);\n  const scrollRef = useRef(null);\n  const [signerKeyboardShift, setSignerKeyboardShift] = useState(0);\n\n  useEffect(() => {\n    const onShow = (e) => {\n      try {\n        const h = e && e.endCoordinates ? e.endCoordinates.height : 0;\n        const shift = Math.max(0, h - 80);\n        setSignerKeyboardShift(shift);\n      } catch(e) {\n        setSignerKeyboardShift(0);\n      }\n    };\n    const onHide = () => setSignerKeyboardShift(0);\n    const showSub = Keyboard.addListener('keyboardDidShow', onShow);\n    const hideSub = Keyboard.addListener('keyboardDidHide', onHide);\n    return () => {\n      showSub.remove();\n      hideSub.remove();\n    };\n  }, []);\n  // Add state for draftId and selectedWeather\n  const [draftId, setDraftId] = useState(initialValues.id || null);\n  const [selectedWeather, setSelectedWeather] = useState(initialValues.weather || null);\n\n  const weatherPayload = useMemo(\n    () => (hideWeather ? {} : { weather: selectedWeather }),\n    [hideWeather, selectedWeather]\n  );\n  const [byggdelTemplate, setByggdelTemplate] = useState(initialValues.byggdelTemplate || null);\n  const [byggdel, setByggdel] = useState(initialValues.byggdel || formatByggdelLabelFromTemplate(initialValues.byggdelTemplate) || '');\n  const [materialDesc, setMaterialDesc] = useState(initialValues.materialDesc || '');\n  const [qualityDesc, setQualityDesc] = useState(initialValues.qualityDesc || '');\n  const [coverageDesc, setCoverageDesc] = useState(initialValues.coverageDesc || '');\n  const [mottagningsSignatures, setMottagningsSignatures] = useState(initialValues.mottagningsSignatures || []);\n  // Normalize mottagningsPhotos to array of objects { uri, comment }\n  const normalizePhotos = (arr) => {\n    if (!Array.isArray(arr)) return [];\n    return arr.map(p => {\n      if (!p) return null;\n      if (typeof p === 'string') return { uri: p, comment: '' };\n      if (typeof p === 'object' && p.uri) return { uri: p.uri, comment: p.comment || '' };\n      return null;\n    }).filter(Boolean);\n  };\n  const [mottagningsPhotos, setMottagningsPhotos] = useState(() => normalizePhotos(initialValues.mottagningsPhotos || []));\n  const [showPhotoChoice, setShowPhotoChoice] = useState(false);\n  const _theme = useColorScheme() || 'light';\n  const tintColor = (Colors && Colors[_theme] && Colors[_theme].tint) ? Colors[_theme].tint : '#1976D2';\n  // Ensure visibility: if tintColor is pure white (dark theme), use a contrasting fallback\n  const visibleTint = (tintColor === '#fff' || tintColor === '#ffffff') ? '#0a7ea4' : tintColor;\n  const onTintColor = (tintColor === '#fff' || tintColor === '#ffffff') ? '#000' : '#fff';\n  // const bottomSheetRef = useReactRef(null);\n  // The misplaced Modal and logic block above was removed because it must be inside a component or function, not at the top level.\n  // If you want to use this Modal, move it inside your component's return statement or a function.\n  const route = useRoute();\n  const navigation = useNavigation();\n  // ...existing code...\n  const routeParams = route && route.params ? route.params : {};\n  const isTemplatePreview = !!(templatePreviewMode || (routeParams && routeParams.previewFromTemplate));\n  const participantsLabel = controlType === 'Mottagningskontroll' ? 'Mottagare' : 'Deltagare';\n  const addParticipantsLabel = controlType === 'Mottagningskontroll' ? 'Lägg till mottagare' : 'Lägg till deltagare';\n  const editParticipantsLabel = controlType === 'Mottagningskontroll' ? 'Redigera mottagare' : 'Redigera deltagare';\n  const [showBackConfirm, setShowBackConfirm] = useState(false);\n  const [backConfirmMode, setBackConfirmMode] = useState('dirty'); // 'dirty' | 'exit'\n  const [showFinishConfirm, setShowFinishConfirm] = useState(false);\n  const [showDraftSavedConfirm, setShowDraftSavedConfirm] = useState(false);\n  const finishingSaveRef = useRef(false);\n  // Ref to store blocked navigation event\n  const blockedNavEvent = useRef(null);\n  // Keep a ref copy of isDirty so the beforeRemove listener can be attached once\n  const isDirtyRef = useRef(false);\n  // Prevent duplicate rapid saves of drafts\n  const savingDraftRef = useRef(false);\n  const lastSavedDraftRef = useRef(null);\n\n  // Web-only: allow parent (HomeScreen) to coordinate project switching\n  // when the user is inside an inline control form.\n  const dispatchInlineExitDecision = (decision) => {\n    if (Platform.OS !== 'web') return;\n    try {\n      if (typeof window === 'undefined' || !window.dispatchEvent) return;\n      window.dispatchEvent(new CustomEvent('dkInlineExitDecision', { detail: { decision: String(decision || '') } }));\n    } catch(e) {}\n  };\n\n  const closeBackConfirm = (decision) => {\n    try { setShowBackConfirm(false); } catch(e) {}\n    if (decision) dispatchInlineExitDecision(decision);\n  };\n\n  const handleAttemptFinish = () => {\n    // Special validation rules for Mottagningskontroll and Skyddsrond\n    if (controlType !== 'Mottagningskontroll' && controlType !== 'Skyddsrond') {\n      handleSave();\n      return;\n    }\n    const missing = [];\n    // Date is optional for Mottagningskontroll; do not mark as missing\n    if (!Array.isArray(localParticipants) || localParticipants.length === 0) missing.push(participantsLabel);\n    const descLabel = (controlType === 'Skyddsrond') ? 'Omfattning / beskrivning av skyddsrond' : 'Beskriv leverans';\n    if (!(controlType === 'Skyddsrond' ? deliveryDesc : materialDesc) || !(controlType === 'Skyddsrond' ? deliveryDesc : materialDesc).trim()) missing.push(descLabel);\n    if (Array.isArray(checklist) && checklist.length > 0) {\n      const anyMissing = checklist.some(sec => !(Array.isArray(sec.statuses) && sec.statuses.every(s => !!s)));\n      if (anyMissing) missing.push('Kontrollpunkter');\n    }\n    if (!Array.isArray(mottagningsSignatures) || mottagningsSignatures.length === 0) missing.push('Signaturer');\n    if (missing.length === 0) {\n      handleSave();\n    } else {\n      setMissingFields(missing);\n      // More descriptive guidance when saving fails validation\n      const humanMsg = 'Följande saknas: ' + missing.join(', ') + '.\\nFyll i saknade fält eller markera kontrollpunkter. Om en avvikelse är åtgärdad, öppna punkten och tryck Åtgärda för att spara åtgärdsinfo.';\n      Alert.alert('Saknas', humanMsg);\n      if (scrollRef && scrollRef.current && scrollRef.current.scrollTo) {\n        scrollRef.current.scrollTo({ y: 0, animated: true });\n      }\n    }\n  };\n\n  // Add beforeRemove event once to block navigation if dirty (use ref inside)\n  useEffect(() => {\n    const unsubscribe = navigation.addListener('beforeRemove', (e) => {\n      if (!isDirtyRef.current) return; // Allow navigation if not dirty\n      e.preventDefault();\n      blockedNavEvent.current = e;\n      try { setBackConfirmMode('dirty'); } catch(e) {}\n      setShowBackConfirm(true);\n    });\n    return unsubscribe;\n  }, [navigation]);\n\n  // Web (inline mode): allow browser back button to trigger the same\n  // unsaved-changes flow (save draft or abort) instead of forcing the user\n  // to press the in-app \"Avbryt\" button.\n  useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n    if (!window.history || typeof window.history.pushState !== 'function') return;\n    // Only enable this guard when the form is rendered inline (i.e. it has an onExit handler)\n    if (typeof onExitRef.current !== 'function') return;\n\n    const guardId = String(Date.now()) + '-' + Math.random().toString(36).slice(2);\n    const pushGuard = () => {\n      try {\n        window.history.pushState({ ...(window.history.state || {}), dkInlineControl: guardId }, '');\n      } catch(e) {}\n    };\n    pushGuard();\n\n    const requestExitConfirm = (mode) => {\n      try {\n        // Re-add guard entry so the user stays \"here\" until they choose.\n        pushGuard();\n      } catch(e) {}\n      try { setBackConfirmMode(mode || 'exit'); } catch(e) {}\n      try { setShowBackConfirm(true); } catch(e) {}\n    };\n\n    const onPopState = () => {\n      try {\n        // Always confirm when leaving an inline control (prevents accidental project switch)\n        if (isDirtyRef.current) requestExitConfirm('dirty');\n        else requestExitConfirm('exit');\n      } catch(e) {}\n    };\n\n    const onAttemptExit = () => {\n      try {\n        if (isDirtyRef.current) requestExitConfirm('dirty');\n        else requestExitConfirm('exit');\n      } catch(e) {}\n    };\n\n    window.addEventListener('popstate', onPopState);\n    window.addEventListener('dkInlineAttemptExit', onAttemptExit);\n    return () => {\n      try { window.removeEventListener('popstate', onPopState); } catch(e) {}\n      try { window.removeEventListener('dkInlineAttemptExit', onAttemptExit); } catch(e) {}\n    };\n  }, []);\n  const [photoModal, setPhotoModal] = useState({ visible: false, uris: [], index: 0 });\n  const handleDeletePhoto = () => {\n    const { uris, index } = photoModal || {};\n    if (!uris || uris.length === 0) {\n      setPhotoModal({ visible: false, uris: [], index: 0 });\n      return;\n    }\n    const photoObj = uris[index];\n    const uri = photoObj ? (photoObj.uri || photoObj) : null;\n    if (!uri) {\n      setPhotoModal({ visible: false, uris: [], index: 0 });\n      return;\n    }\n\n    // 0) If viewing mall (template) photos, remove only from mall draft\n    try {\n      const mallSectionId = photoModal && photoModal.mallSectionId ? String(photoModal.mallSectionId) : '';\n      const mallPointIdx = (photoModal && typeof photoModal.mallPointIdx === 'number') ? photoModal.mallPointIdx : null;\n      if (mallSectionId && mallPointIdx !== null && mallPointIdx >= 0) {\n        setByggdelMallSectionsDraft(prev => {\n          const arr = Array.isArray(prev) ? prev : [];\n          return arr.map(s => {\n            if (String(s && s.id ? s.id : '') !== mallSectionId) return s;\n            const pts = Array.isArray(s && s.points) ? s.points : [];\n            const photosOuter = Array.isArray(s && s.photos) ? s.photos : Array(pts.length).fill(null).map(() => []);\n            const photos = photosOuter.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []));\n            if (!Array.isArray(photos[mallPointIdx])) photos[mallPointIdx] = [];\n            const list = photos[mallPointIdx] || [];\n            const pos = list.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri);\n            if (pos !== -1) {\n              photos[mallPointIdx] = list.filter((_, i) => i !== pos);\n            }\n            return Object.assign({}, s, { photos });\n          });\n        });\n        const newUris = uris.filter((u, i) => i !== index);\n        const newIndex = Math.max(0, index - 1);\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0, mallSectionId, mallPointIdx });\n        return;\n      }\n    } catch(e) {}\n\n    // 1) Try remove from mottagningsPhotos (central photos list)\n    try {\n      const mp = mottagningsPhotosRef.current || [];\n      const mpIdx = mp.findIndex(x => (x && x.uri) ? x.uri === uri : x === uri);\n      if (mpIdx !== -1) {\n        const newMp = [...mp];\n        newMp.splice(mpIdx, 1);\n        setMottagningsPhotos(newMp);\n        mottagningsPhotosRef.current = newMp;\n        const newUris = uris.filter((u, i) => i !== index);\n        const newIndex = Math.max(0, index - 1);\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\n        return;\n      }\n    } catch(e) {\n      // ignore and try checklist removal\n    }\n\n    // 2) Try remove from checklist photos (per-section/point)\n    try {\n      const prev = checklistRef.current || [];\n      let found = false;\n      const newChecklist = prev.map((section) => {\n        const points = Array.isArray(section.points) ? section.points : [];\n        // Normalize photos array to match points length\n        const photosArr = Array.isArray(section.photos) && section.photos.length === points.length\n          ? section.photos.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []))\n          : Array(points.length).fill(null).map(() => []);\n        // Remove uri if present in any point\n        for (let p = 0; p < photosArr.length; p++) {\n          const arr = photosArr[p] || [];\n          const pos = arr.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri);\n          if (pos !== -1) {\n            photosArr[p] = arr.filter((_, i) => i !== pos);\n            found = true;\n            break;\n          }\n        }\n        return { ...section, photos: photosArr, points };\n      });\n      if (found) {\n        setChecklist(newChecklist);\n        checklistRef.current = newChecklist;\n        // Expand the section containing the removed photo (if any)\n        const sectionIndex = newChecklist.findIndex(sec => Array.isArray(sec.photos) && sec.photos.some(arr => arr && arr.findIndex(item => (item && item.uri) ? item.uri === uri : item === uri) !== -1));\n        if (sectionIndex !== -1) setExpandedChecklist(prev => prev.includes(sectionIndex) ? prev : [sectionIndex]);\n        const newUris = uris.filter((u, i) => i !== index);\n        const newIndex = Math.max(0, index - 1);\n        setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\n        return;\n      }\n    } catch(e) {\n      // ignore and fallback to removing from modal only\n    }\n\n    // 3) Fallback: remove from modal list only\n    const newUris = uris.filter((u, i) => i !== index);\n    const newIndex = Math.max(0, index - 1);\n    setPhotoModal({ visible: newUris.length > 0, uris: newUris, index: newUris.length > 0 ? newIndex : 0 });\n  };\n  // Ref to avoid stale closures for mottagningsPhotos\n  const mottagningsPhotosRef = useRef(mottagningsPhotos);\n  useEffect(() => { mottagningsPhotosRef.current = mottagningsPhotos; }, [mottagningsPhotos]);\n  // Only initialize checklist ONCE, never re-initialize from checklistConfig after mount\n  // Checklist state: restore from route.params if present, else initialize\n  // Predefined sections for Mottagningskontroll (option B - pre-filled rows)\n  const mottagningsTemplate = [\n    {\n      label: 'Leverans',\n      points: [\n        'Kontrollera att levererat material överensstämmer med följesedel',\n        'Kontrollera antal och att inga kollin saknas eller är skadade',\n        'Kontrollera märkning och produktinformation på kollin',\n      ],\n    },\n    {\n      label: 'Kvalitet och skick',\n      points: [\n        'Inspektera ytskador (bulor, sprickor, fuktfläckar)',\n        'Kontrollera att dimensioner och toleranser stämmer',\n        'Kontrollera att rätt materialleverans lämnats (typ/spec)',\n      ],\n    },\n    {\n      label: 'Täckning och väderskydd',\n      points: [\n        'Kontrollera att material är täckt vid risk för nederbörd',\n        'Säkerställ att vindskydd eller presenningar är korrekt fästa',\n        'Kontrollera att täckning inte skadar materialet (kondens, gnidning)',\n      ],\n    },\n  ];\n  const [checklist, setChecklist] = useState(() => {\n    // Always prefer params.savedChecklist if present and non-empty, else checklistConfig\n    let raw = [];\n    if (!isTemplatePreview && routeParams && Array.isArray(routeParams.savedChecklist) && routeParams.savedChecklist.length > 0) {\n      raw = routeParams.savedChecklist;\n    } else if (!isTemplatePreview && initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\n      raw = initialValues.checklist;\n    } else if (Array.isArray(checklistConfig) && checklistConfig.length > 0) {\n      // Arbetsberedning: start with no visible sections until user selects categories\n      if (controlType === 'Arbetsberedning') {\n        raw = [];\n      } else {\n      raw = checklistConfig.map(section => ({\n        label: section.label,\n        points: Array.isArray(section.points) ? [...section.points] : [],\n        statuses: Array(Array.isArray(section.points) ? section.points.length : 0).fill(null),\n        photos: Array(Array.isArray(section.points) ? section.points.length : 0).fill([]),\n          comments: Array(Array.isArray(section.points) ? section.points.length : 0).fill(''),\n      }));\n      }\n    } else if (controlType === 'Mottagningskontroll') {\n      // Use predefined Mottagningskontroll sections when no checklistConfig is provided\n      raw = mottagningsTemplate.map(section => ({ label: section.label, points: Array.isArray(section.points) ? [...section.points] : [] }));\n    }\n    // Robustify: ensure every section has valid points, statuses, photos arrays\n    return (raw || []).map(section => {\n      const points = Array.isArray(section.points) ? section.points : [];\n      const statuses = Array.isArray(section.statuses) && Array.isArray(points) && section.statuses.length === points.length\n        ? section.statuses\n        : Array(Array.isArray(points) ? points.length : 0).fill(null);\n      let photos = Array.isArray(section.photos) && Array.isArray(points) && section.photos.length === points.length\n        ? section.photos\n        : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\n      // Ensure every photos[i] is an array\n      photos = photos.map(arr => Array.isArray(arr) ? arr : (arr ? [arr] : []));\n      const comments = Array.isArray(section.comments) && Array.isArray(points) && section.comments.length === points.length\n        ? section.comments\n        : Array(Array.isArray(points) ? points.length : 0).fill('');\n      return {\n        label: section.label,\n        points,\n        statuses,\n        photos,\n        comments,\n      };\n    });\n  });\n\n  // Keep a ref of checklist to avoid stale closures when updating params\n  const checklistRef = useRef(checklist);\n  useEffect(() => { checklistRef.current = checklist; }, [checklist]);\n\n  const byggdelMallLocksCategories = useMemo(() => {\n    if (controlType !== 'Arbetsberedning') return false;\n    const tpl = byggdelTemplate || null;\n    return !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\n  }, [controlType, byggdelTemplate]);\n\n  const hasAnyChecklistPoints = (list) => {\n    try {\n      const arr = Array.isArray(list) ? list : [];\n      for (const sec of arr) {\n        const pts = Array.isArray(sec && sec.points) ? sec.points : [];\n        if (pts.length > 0) return true;\n      }\n      return false;\n    } catch (e) {\n      return false;\n    }\n  };\n\n  const buildChecklistFromMallPoints = ({ mallName, points, sections }) => {\n    const coerceArrayLike = (v) => {\n      if (Array.isArray(v)) return v;\n      if (v && typeof v === 'object') {\n        const keys = Object.keys(v).filter(k => String(parseInt(k, 10)) === k).map(k => parseInt(k, 10)).sort((a, b) => a - b);\n        if (!keys.length) return [];\n        const arr = [];\n        keys.forEach(k => { arr[k] = v[k]; });\n        return arr;\n      }\n      return [];\n    };\n\n    const secArr = Array.isArray(sections) ? sections : [];\n    const normalizedSections = secArr\n      .map(s => {\n        const label = String(s && (s.title ?? s.label ?? '')).trim();\n        const pts = (Array.isArray(s && s.points) ? s.points : []).map(p => String(p || '').trim()).filter(Boolean);\n        const rawStatuses = coerceArrayLike(s && s.statuses);\n        const statuses = pts.map((_, i) => {\n          const v = rawStatuses[i];\n          return (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\n        });\n        const rawPhotosOuter = coerceArrayLike(s && s.photos);\n        const photos = pts.map((_, i) => {\n          const row = rawPhotosOuter[i];\n          const list = Array.isArray(row) ? row : (row ? [row] : []);\n          return list\n            .map(item => {\n              if (!item) return null;\n              if (typeof item === 'string') return item;\n              if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\n              return null;\n            })\n            .filter(Boolean);\n        });\n        return { label, points: pts, statuses, photos };\n      })\n      .filter(s => (String(s.label || '').trim() || (Array.isArray(s.points) && s.points.length > 0)));\n\n    if (normalizedSections.length > 0) {\n      return normalizedSections.map(s => {\n        const lbl = String(s.label || '').trim() || String(mallName || 'Mall');\n        const pts = Array.isArray(s.points) ? s.points : [];\n        return {\n          label: lbl,\n          points: pts,\n          statuses: (Array.isArray(s.statuses) && s.statuses.length === pts.length) ? s.statuses : Array(pts.length).fill(null),\n          photos: (Array.isArray(s.photos) && s.photos.length === pts.length) ? s.photos.map(a => Array.isArray(a) ? a : (a ? [a] : [])) : Array(pts.length).fill(null).map(() => []),\n          comments: Array(pts.length).fill(''),\n        };\n      });\n    }\n\n    const pts = (Array.isArray(points) ? points : []).map(p => String(p || '').trim()).filter(Boolean);\n    return [\n      {\n        label: String(mallName || 'Mall'),\n        points: pts,\n        statuses: Array(pts.length).fill(null),\n        photos: Array(pts.length).fill([]),\n        comments: Array(pts.length).fill(''),\n      },\n    ];\n  };\n\n  // Track initial state for dirty checking\n  const initialChecklist = useMemo(() => {\n    if (!isTemplatePreview && routeParams && Array.isArray(routeParams.savedChecklist) && routeParams.savedChecklist.length > 0) {\n      return routeParams.savedChecklist;\n    }\n    if (!isTemplatePreview && initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\n      return initialValues.checklist;\n    }\n    // Arbetsberedning: baseline is empty until user selects categories\n    if (controlType === 'Arbetsberedning') return [];\n    if (Array.isArray(checklistConfig)) {\n      return checklistConfig.map(section => ({\n        label: section.label,\n        points: Array.isArray(section.points) ? [...section.points] : [],\n        statuses: Array(Array.isArray(section.points) ? section.points.length : 0).fill(null),\n        photos: Array(Array.isArray(section.points) ? section.points.length : 0).fill([]),\n        comments: Array(Array.isArray(section.points) ? section.points.length : 0).fill(''),\n      }));\n    }\n    return [];\n  }, [checklistConfig, controlType, initialValues, routeParams, isTemplatePreview]);\n\n  const initialParticipants = useMemo(() => {\n    if (initialValues && Array.isArray(initialValues.participants) && initialValues.participants.length > 0) return initialValues.participants;\n    return Array.isArray(participants) ? participants : [];\n  }, [participants, initialValues]);\n  const initialDate = useMemo(() => date || initialValues.date || '', [date, initialValues.date]);\n  const initialWeather = useMemo(() => initialValues.weather || null, [initialValues.weather]);\n  const initialByggdel = useMemo(() => initialValues.byggdel || formatByggdelLabelFromTemplate(initialValues.byggdelTemplate) || '', [initialValues.byggdel, initialValues.byggdelTemplate]);\n  const initialDeliveryDesc = useMemo(() => initialValues.deliveryDesc || '', [initialValues.deliveryDesc]);\n  const initialGeneralNote = useMemo(() => initialValues.generalNote || '', [initialValues.generalNote]);\n  const initialMaterialDesc = useMemo(() => initialValues.materialDesc || '', [initialValues.materialDesc]);\n  const initialQualityDesc = useMemo(() => initialValues.qualityDesc || '', [initialValues.qualityDesc]);\n  const initialCoverageDesc = useMemo(() => initialValues.coverageDesc || '', [initialValues.coverageDesc]);\n  const initialMottagningsSignatures = useMemo(() => initialValues.mottagningsSignatures || [], [initialValues.mottagningsSignatures]);\n  const initialMottagningsPhotos = useMemo(() => initialValues.mottagningsPhotos || [], [initialValues.mottagningsPhotos]);\n\n  // Helper to compare arrays/objects shallowly\n  function shallowEqual(a, b) {\n\n    if (a === b) return true;\n    if (!a || !b) return false;\n    if (Array.isArray(a) && Array.isArray(b)) {\n      if (a.length !== b.length) return false;\n      for (let i = 0; i < a.length; i++) {\n        if (!shallowEqual(a[i], b[i])) return false;\n      }\n      return true;\n    }\n    if (typeof a === 'object' && typeof b === 'object') {\n      const aKeys = Object.keys(a);\n      const bKeys = Object.keys(b);\n      if (aKeys.length !== bKeys.length) return false;\n      for (let key of aKeys) {\n        if (!shallowEqual(a[key], b[key])) return false;\n      }\n      return true;\n    }\n    return a === b;\n  }\n\n    // Convert an array of points to a smooth SVG path using Catmull-Rom -> cubic Bezier\n    function pointsToPath(points) {\n      if (!Array.isArray(points) || points.length === 0) return '';\n      if (points.length === 1) return `M ${points[0].x} ${points[0].y}`;\n      const p = points.map(pt => ({ x: Number(pt.x), y: Number(pt.y) }));\n      let d = `M ${p[0].x} ${p[0].y}`;\n      for (let i = 0; i < p.length - 1; i++) {\n        const p0 = i > 0 ? p[i - 1] : p[i];\n        const p1 = p[i];\n        const p2 = p[i + 1];\n        const p3 = i + 2 < p.length ? p[i + 2] : p2;\n        const b1x = p1.x + (p2.x - p0.x) / 6;\n        const b1y = p1.y + (p2.y - p0.y) / 6;\n        const b2x = p2.x - (p3.x - p1.x) / 6;\n        const b2y = p2.y - (p3.y - p1.y) / 6;\n        d += ` C ${b1x} ${b1y}, ${b2x} ${b2y}, ${p2.x} ${p2.y}`;\n      }\n      return d;\n    }\n\n  // Local participants state (initialize from participants prop)\n  // Prefer participants passed via initialValues when viewing a saved/completed control\n  const [localParticipants, setLocalParticipants] = useState(() => {\n    if (initialValues && Array.isArray(initialValues.participants) && initialValues.participants.length > 0) return initialValues.participants;\n    return Array.isArray(participants) ? participants : [];\n  });\n\n  // NOTE: These states must be declared before any hook (e.g. isDirty) references them.\n  // Otherwise web can crash with \"Cannot access '<var>' before initialization\".\n  const todayIso = new Date().toISOString().slice(0, 10);\n  const [dateValue, setDateValue] = useState(date || (initialValues && initialValues.date) || todayIso);\n  // Ensure dateValue is populated if props arrive asynchronously or after hot restart\n  useEffect(() => {\n    if (!dateValue || dateValue === '') {\n      const fallback = date || (initialValues && initialValues.date) || todayIso;\n      setDateValue(fallback);\n    }\n  }, [date, initialValues && initialValues.date]);\n  const [deliveryDesc, setDeliveryDesc] = useState((initialValues && initialValues.deliveryDesc) || '');\n  const [generalNote, setGeneralNote] = useState((initialValues && initialValues.generalNote) || '');\n\n  // Keep missing-field highlights until the user fixes them.\n  // IMPORTANT: This must be declared after the dependent state variables,\n  // otherwise web can crash with \"Cannot access '<var>' before initialization\".\n  useEffect(() => {\n    if (!Array.isArray(missingFields) || missingFields.length === 0) return;\n\n    const descLabel = (controlType === 'Skyddsrond') ? 'Omfattning / beskrivning av skyddsrond' : 'Beskriv leverans';\n\n    const stillMissing = (label) => {\n      if (label === participantsLabel || label === 'Deltagare') {\n        return !(Array.isArray(localParticipants) && localParticipants.length > 0);\n      }\n      if (label === descLabel) {\n        if (controlType === 'Skyddsrond') {\n          return !(typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0);\n        }\n        // Mottagningskontroll has historically used both fields; accept either.\n        const hasDelivery = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\n        const hasMaterial = typeof materialDesc === 'string' && materialDesc.trim().length > 0;\n        return !(hasDelivery || hasMaterial);\n      }\n      if (label === 'Kontrollpunkter') {\n        if (!Array.isArray(checklist) || checklist.length === 0) return false;\n        return checklist.some(sec => !(Array.isArray(sec.statuses) && sec.statuses.every(s => !!s)));\n      }\n      if (label === 'Signaturer' || label === 'Signatur') {\n        return !(Array.isArray(mottagningsSignatures) && mottagningsSignatures.length > 0);\n      }\n      return true;\n    };\n\n    const nextMissing = missingFields.filter(stillMissing);\n    if (nextMissing.length !== missingFields.length) {\n      setMissingFields(nextMissing);\n    }\n  }, [missingFields, controlType, localParticipants, deliveryDesc, materialDesc, checklist, mottagningsSignatures]);\n\n  // Dirty state: true if any field differs from initial\n  const isDirty = useMemo(() => {\n    if (!shallowEqual(localParticipants, initialParticipants)) return true;\n    if (!shallowEqual(checklist, initialChecklist)) return true;\n    if (dateValue !== initialDate) return true;\n    if (selectedWeather !== initialWeather) return true;\n    if ((byggdel || '') !== (initialByggdel || '')) return true;\n    if (deliveryDesc !== initialDeliveryDesc) return true;\n    if (generalNote !== initialGeneralNote) return true;\n    if (materialDesc !== initialMaterialDesc) return true;\n    if (qualityDesc !== initialQualityDesc) return true;\n    if (coverageDesc !== initialCoverageDesc) return true;\n    if (!shallowEqual(mottagningsSignatures, initialMottagningsSignatures)) return true;\n    if (!shallowEqual(mottagningsPhotos, initialMottagningsPhotos)) return true;\n    return false;\n  }, [localParticipants, checklist, dateValue, selectedWeather, byggdel, deliveryDesc, generalNote, materialDesc, qualityDesc, coverageDesc, mottagningsSignatures, mottagningsPhotos, initialParticipants, initialChecklist, initialDate, initialWeather, initialByggdel, initialDeliveryDesc, initialGeneralNote, initialMaterialDesc, initialQualityDesc, initialCoverageDesc, initialMottagningsSignatures, initialMottagningsPhotos]);\n  // Keep isDirtyRef in sync with latest computed isDirty\n  useEffect(() => { isDirtyRef.current = isDirty; }, [isDirty]);\n  const [showAddParticipantModal, setShowAddParticipantModal] = useState(false);\n  const [showAddSignerModal, setShowAddSignerModal] = useState(false);\n  const [signerName, setSignerName] = useState('');\n  const [showWeatherModal, setShowWeatherModal] = useState(false);\n  const [showByggdelModal, setShowByggdelModal] = useState(false);\n  const [showAktivaByggdelarModal, setShowAktivaByggdelarModal] = useState(false);\n  const [aktivaByggdelarSelectedKeys, setAktivaByggdelarSelectedKeys] = useState([]);\n  const [aktivaByggdelarDraftKeys, setAktivaByggdelarDraftKeys] = useState([]);\n  const [aktivaByggdelarExpandedPrefix, setAktivaByggdelarExpandedPrefix] = useState('');\n  const [byggdelHierarchyLoading, setByggdelHierarchyLoading] = useState(false);\n  const [byggdelMomentsByGroup, setByggdelMomentsByGroup] = useState(() => defaultByggdelMomentsByGroup);\n  const [byggdelMallarLoading, setByggdelMallarLoading] = useState(false);\n  const [byggdelMallar, setByggdelMallar] = useState([]);\n  const [byggdelHuvudgruppDraft, setByggdelHuvudgruppDraft] = useState('');\n  const [byggdelMomentDraft, setByggdelMomentDraft] = useState('');\n  const [byggdelMallDraft, setByggdelMallDraft] = useState(null);\n  const [byggdelExpandedHuvudgrupp, setByggdelExpandedHuvudgrupp] = useState('');\n  const [byggdelExpandedMomentKey, setByggdelExpandedMomentKey] = useState('');\n  const [showByggdelHuvudgruppRolldown, setShowByggdelHuvudgruppRolldown] = useState(true);\n  const [showKontrollplanRolldown, setShowKontrollplanRolldown] = useState(true);\n  const [newByggdelMallName, setNewByggdelMallName] = useState('');\n  const [savingByggdelMall, setSavingByggdelMall] = useState(false);\n  const [deletingByggdelMallId, setDeletingByggdelMallId] = useState('');\n  const [showCreateByggdelMallModal, setShowCreateByggdelMallModal] = useState(false);\n  const [createByggdelMallContext, setCreateByggdelMallContext] = useState(null);\n  const [showByggdelMallEditor, setShowByggdelMallEditor] = useState(false);\n  const [byggdelMallEditor, setByggdelMallEditor] = useState(null);\n  const [byggdelMallSectionsDraft, setByggdelMallSectionsDraft] = useState([]);\n  const [newByggdelMallSectionTitle, setNewByggdelMallSectionTitle] = useState('');\n  const [byggdelMallEditorExpandedSectionId, setByggdelMallEditorExpandedSectionId] = useState('');\n  const [newByggdelMallPointBySectionId, setNewByggdelMallPointBySectionId] = useState({});\n  const [savingByggdelMallPoints, setSavingByggdelMallPoints] = useState(false);\n  const [showCreateByggdelMoment, setShowCreateByggdelMoment] = useState(false);\n  const [newByggdelMomentName, setNewByggdelMomentName] = useState('');\n\n  // Keep create-mall popup bottom aligned right above the keyboard.\n  const DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS = 320;\n  const [createMallKeyboardHeight, setCreateMallKeyboardHeight] = useState(Platform.OS === 'ios' ? DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS : 0);\n  useEffect(() => {\n    if (showCreateByggdelMallModal && Platform.OS === 'ios' && !(createMallKeyboardHeight > 0)) {\n      setCreateMallKeyboardHeight(DEFAULT_CREATE_MALL_KEYBOARD_HEIGHT_IOS);\n    }\n  }, [showCreateByggdelMallModal]);\n\n  // Shift mall editor up when keyboard is visible so footer buttons aren't covered.\n  const [mallEditorKeyboardHeight, setMallEditorKeyboardHeight] = useState(0);\n  useEffect(() => {\n    const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';\n    const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';\n\n    const onShow = (e) => {\n      const h = (e && e.endCoordinates && typeof e.endCoordinates.height === 'number') ? e.endCoordinates.height : 0;\n      setMallEditorKeyboardHeight(h || 0);\n    };\n    const onHide = () => setMallEditorKeyboardHeight(0);\n\n    const subShow = Keyboard.addListener(showEvent, onShow);\n    const subHide = Keyboard.addListener(hideEvent, onHide);\n    return () => {\n      try { subShow && subShow.remove && subShow.remove(); } catch(e) {}\n      try { subHide && subHide.remove && subHide.remove(); } catch(e) {}\n    };\n  }, []);\n  useEffect(() => {\n    const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';\n    const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';\n\n    const onShow = (e) => {\n      const h = (e && e.endCoordinates && typeof e.endCoordinates.height === 'number') ? e.endCoordinates.height : 0;\n      setCreateMallKeyboardHeight(h || 0);\n    };\n    const onHide = () => {\n      // iOS: keep last height to avoid jumping down and showing underlying footer.\n      if (Platform.OS === 'ios') return;\n      setCreateMallKeyboardHeight(0);\n    };\n\n    const subShow = Keyboard.addListener(showEvent, onShow);\n    const subHide = Keyboard.addListener(hideEvent, onHide);\n    return () => {\n      try { subShow && subShow.remove && subShow.remove(); } catch(e) {}\n      try { subHide && subHide.remove && subHide.remove(); } catch(e) {}\n    };\n  }, []);\n\n  const closeByggdelModal = () => {\n    try { Keyboard.dismiss && Keyboard.dismiss(); } catch(e) {}\n    setShowByggdelModal(false);\n    setShowAktivaByggdelarModal(false);\n    setNewByggdelMallName('');\n    setSavingByggdelMall(false);\n    setShowCreateByggdelMallModal(false);\n    setCreateByggdelMallContext(null);\n    setShowCreateByggdelMoment(false);\n    setNewByggdelMomentName('');\n  };\n\n  const closeCreateByggdelMallModal = () => {\n    try { Keyboard.dismiss && Keyboard.dismiss(); } catch(e) {}\n    setShowCreateByggdelMallModal(false);\n    setCreateByggdelMallContext(null);\n    setNewByggdelMallName('');\n    setSavingByggdelMall(false);\n  };\n\n  const submitCreateByggdelMall = async () => {\n    try {\n      const nm = String(newByggdelMallName || '').trim();\n      if (!nm) {\n        Alert.alert('Ange namn', 'Skriv ett namn på mallen.');\n        return;\n      }\n      if (savingByggdelMall) return;\n\n      const ctx = createByggdelMallContext;\n      const hgKeyPrefix = String(ctx && ctx.huvudgrupp ? ctx.huvudgrupp : '').trim();\n      const momentLabel = String(ctx && ctx.moment ? ctx.moment : '').trim();\n      if (!hgKeyPrefix || !momentLabel) {\n        Alert.alert('Kunde inte skapa', 'Saknar byggdel/moment. Försök igen.');\n        return;\n      }\n\n      setSavingByggdelMall(true);\n      const createdId = await createByggdelMall({ huvudgrupp: hgKeyPrefix, moment: momentLabel, name: nm });\n\n      // Optimistic insert so the mall is visible immediately under this moment.\n      setByggdelMallar(prev => {\n        const current = Array.isArray(prev) ? prev : [];\n        const next = [\n          ...current.filter(x => String(x && x.id ? x.id : '') !== String(createdId || '')),\n          { id: createdId, huvudgrupp: hgKeyPrefix, moment: momentLabel, name: nm, points: [], sections: [] },\n        ];\n        next.sort((a, b) => {\n          const ag = String(a && (a.huvudgrupp ?? '')).trim();\n          const bg = String(b && (b.huvudgrupp ?? '')).trim();\n          if (ag !== bg) return ag.localeCompare(bg, 'sv');\n          const am = String(a && (a.moment ?? '')).trim();\n          const bm = String(b && (b.moment ?? '')).trim();\n          if (am !== bm) return am.localeCompare(bm, 'sv');\n          const an = String(a && (a.name ?? '')).trim();\n          const bn = String(b && (b.name ?? '')).trim();\n          return an.localeCompare(bn, 'sv');\n        });\n        return next;\n      });\n\n      // Best-effort refresh (keeps list in sync across devices)\n      refreshByggdelMallar();\n\n      setByggdelMallDraft({ id: createdId || null, name: nm });\n      closeCreateByggdelMallModal();\n      if (createdId) {\n        // iOS/Expo Go: avoid stacking RN Modals; close Byggdel modal before opening editor.\n        setShowByggdelModal(false);\n        setTimeout(() => {\n          openByggdelMallEditor({ id: createdId, name: nm, huvudgrupp: hgKeyPrefix, moment: momentLabel, points: [], sections: [] });\n        }, 250);\n      }\n    } catch(e) {\n      const code = e && e.code ? String(e.code) : '';\n      const msg = (e && e.message) ? String(e.message) : '';\n      const isDuplicate = code === 'already-exists' || code === 'already_exists' || (msg && msg.toLowerCase().includes('already') && msg.toLowerCase().includes('exist'));\n      const isPermission = code === 'permission-denied' || (msg && msg.toLowerCase().includes('permission'));\n      const isAuth = code === 'unauthenticated';\n      const isOffline = code === 'unavailable' || (msg && (msg.toLowerCase().includes('network') || msg.toLowerCase().includes('offline')));\n      if (isDuplicate) {\n        Alert.alert('Finns redan', 'Det finns redan en mall med detta namn i företaget. Välj ett annat namn.');\n      } else if (isPermission) {\n        Alert.alert('Kunde inte skapa', 'Du saknar behörighet till företaget. Logga ut och in igen (eller be admin sätta rätt företag på användaren) och försök igen.');\n      } else if (isAuth) {\n        Alert.alert('Kunde inte skapa', 'Du är inte inloggad. Logga in igen och försök igen.');\n      } else if (isOffline) {\n        Alert.alert('Kunde inte skapa', 'Ingen kontakt med servern. Kontrollera internetanslutningen och försök igen.');\n      } else if (code === 'no_company') {\n        Alert.alert('Kunde inte skapa', 'Saknar företag på användaren. Logga ut/in eller be admin koppla användaren till ett företag.');\n      } else {\n        Alert.alert('Kunde inte skapa', 'Försök igen.');\n      }\n    } finally {\n      setSavingByggdelMall(false);\n    }\n  };\n\n  const openByggdelMallEditor = (mall) => {\n    try {\n      const id = mall && mall.id ? String(mall.id) : '';\n      const name = String(mall && (mall.name || '')).trim();\n      if (!id) {\n        Alert.alert('Kunde inte öppna', 'Mallen saknar id.');\n        return;\n      }\n      const coerceArrayLike = (v) => {\n        if (Array.isArray(v)) return v;\n        if (v && typeof v === 'object') {\n          const keys = Object.keys(v).filter(k => String(parseInt(k, 10)) === k).map(k => parseInt(k, 10)).sort((a, b) => a - b);\n          if (!keys.length) return [];\n          const arr = [];\n          keys.forEach(k => { arr[k] = v[k]; });\n          return arr;\n        }\n        return [];\n      };\n      const normalizeStatus = (v) => (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\n\n      const makeSectionId = (idx) => `sec-${Date.now()}-${idx}`;\n      const rawSections = Array.isArray(mall && mall.sections) ? mall.sections : [];\n\n      let sections = [];\n      if (rawSections.length > 0) {\n        sections = rawSections\n          .map((s, idx) => {\n            const title = String(s && (s.title ?? s.label ?? '')).trim();\n            const pts = (Array.isArray(s && s.points) ? s.points : []).map(p => String(p || '').trim()).filter(Boolean);\n            const rawStatuses = coerceArrayLike(s && s.statuses);\n            const statuses = pts.map((_, i) => normalizeStatus(rawStatuses[i]));\n            const rawPhotosOuter = coerceArrayLike(s && s.photos);\n            const photos = pts.map((_, i) => {\n              const row = rawPhotosOuter[i];\n              const list = Array.isArray(row) ? row : (row ? [row] : []);\n              return list.map(item => {\n                if (!item) return null;\n                if (typeof item === 'string') return item;\n                if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\n                return null;\n              }).filter(Boolean);\n            });\n            return { id: makeSectionId(idx), title, points: pts, statuses, photos };\n          })\n          .filter(s => String(s && s.title ? s.title : '').trim() || (Array.isArray(s && s.points) && s.points.length > 0));\n      } else {\n        const pts = Array.isArray(mall && mall.points) ? mall.points : [];\n        const normalized = pts.map(p => String(p || '').trim()).filter(Boolean);\n        if (normalized.length > 0) {\n          sections = [{ id: makeSectionId(0), title: 'Kontrollpunkter', points: normalized, statuses: Array(normalized.length).fill(null), photos: Array(normalized.length).fill(null).map(() => []) }];\n        }\n      }\n      setByggdelMallEditor({\n        id,\n        name,\n        huvudgrupp: String(mall && (mall.huvudgrupp || '')).trim(),\n        moment: String(mall && (mall.moment || '')).trim(),\n      });\n      setByggdelMallSectionsDraft(sections);\n      setByggdelMallEditorExpandedSectionId((sections && sections[0] && sections[0].id) ? String(sections[0].id) : '');\n      setNewByggdelMallSectionTitle('');\n      setNewByggdelMallPointBySectionId({});\n      setShowByggdelMallEditor(true);\n    } catch(e) {\n      Alert.alert('Kunde inte öppna', 'Försök igen.');\n    }\n  };\n\n  const handlePickMallPointFromLibrary = async (mallSectionId, mallPointIdx) => {\n    try {\n      const sid = String(mallSectionId || '').trim();\n      const pIdx = (typeof mallPointIdx === 'number') ? mallPointIdx : -1;\n      if (!sid || pIdx < 0) return;\n      try { Keyboard.dismiss(); } catch(e) {}\n\n      // Dynamically import ImagePicker when needed\n      if (!ImagePicker) {\n        try { ImagePicker = await import('expo-image-picker'); } catch(e) { ImagePicker = null; }\n      }\n      let perm = null;\n      try {\n        if (ImagePicker && typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\n          perm = await ImagePicker.getMediaLibraryPermissionsAsync();\n        }\n      } catch(e) {}\n      if (!perm || !(perm.granted === true || perm.status === 'granted')) {\n        try {\n          perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\n        } catch(e) {}\n      }\n      const ok = (perm && (perm.granted === true || perm.status === 'granted'));\n      if (!ok) {\n        alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\n        return;\n      }\n\n      const mediaTypesOption = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images)\n        ? ImagePicker.MediaTypeOptions.Images\n        : undefined;\n      const pickerOptions = { quality: 0.8 };\n      if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\n      await new Promise(resolve => InteractionManager.runAfterInteractions(() => setTimeout(resolve, 200)));\n      const res = (ImagePicker && typeof ImagePicker.launchImageLibraryAsync === 'function') ? await ImagePicker.launchImageLibraryAsync(pickerOptions) : null;\n      const assets = (res && Array.isArray(res.assets) && res.assets.length) ? res.assets : (res && res.uri ? [{ uri: res.uri }] : []);\n      const photos = (assets || [])\n        .map(a => {\n          const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\n          return uri ? { uri, comment: '' } : null;\n        })\n        .filter(Boolean);\n      if (!photos.length) return;\n\n      let modalUris = [];\n      setByggdelMallSectionsDraft(prev => {\n        const arr = Array.isArray(prev) ? prev : [];\n        return arr.map(s => {\n          if (String(s && s.id ? s.id : '') !== sid) return s;\n          const pts = Array.isArray(s && s.points) ? s.points : [];\n          const photosOuter = Array.isArray(s && s.photos) && s.photos.length === pts.length\n            ? s.photos.map(a => Array.isArray(a) ? [...a] : (a ? [a] : []))\n            : Array(pts.length).fill(null).map(() => []);\n          if (!Array.isArray(photosOuter[pIdx])) photosOuter[pIdx] = [];\n          const existingUris = new Set((photosOuter[pIdx] || []).map(p => (p && p.uri) ? p.uri : p).filter(Boolean));\n          const toAdd = photos.filter(p => p && p.uri && !existingUris.has(p.uri));\n          if (toAdd.length) {\n            photosOuter[pIdx] = [...(photosOuter[pIdx] || []), ...toAdd];\n          }\n          modalUris = photosOuter[pIdx];\n          return Object.assign({}, s, { photos: photosOuter });\n        });\n      });\n      setPhotoModal({ visible: true, uris: Array.isArray(modalUris) ? modalUris : [], index: 0, mallSectionId: sid, mallPointIdx: pIdx });\n    } catch(e) {\n      alert('Kunde inte välja bild: ' + (e?.message || e));\n    }\n  };\n\n  const refreshByggdelHierarchy = async () => {\n    try {\n      setByggdelHierarchyLoading(true);\n      const res = await fetchByggdelHierarchy();\n      const mbg = res && typeof res.momentsByGroup === 'object' && res.momentsByGroup ? res.momentsByGroup : {};\n      const { merged, changed } = mergeByggdelMomentsByGroup(mbg);\n      setByggdelMomentsByGroup(merged);\n\n      // Best-effort: persist defaults once per company so web/app share the same baseline.\n      if (changed) {\n        saveByggdelHierarchy({ momentsByGroup: merged }).catch((e) => {});\n      }\n    } catch(e) {\n      setByggdelMomentsByGroup(defaultByggdelMomentsByGroup);\n    } finally {\n      setByggdelHierarchyLoading(false);\n    }\n  };\n\n  const refreshByggdelMallar = async () => {\n    try {\n      setByggdelMallarLoading(true);\n      const list = await fetchByggdelMallar();\n      const arr = Array.isArray(list) ? list : [];\n      arr.sort((a, b) => {\n        const ag = String(a && (a.huvudgrupp ?? '')).trim();\n        const bg = String(b && (b.huvudgrupp ?? '')).trim();\n        if (ag !== bg) return ag.localeCompare(bg, 'sv');\n        const am = String(a && (a.moment ?? '')).trim();\n        const bm = String(b && (b.moment ?? '')).trim();\n        if (am !== bm) return am.localeCompare(bm, 'sv');\n        const an = String(a && (a.name ?? '')).trim();\n        const bn = String(b && (b.name ?? '')).trim();\n        return an.localeCompare(bn, 'sv');\n      });\n      setByggdelMallar(arr);\n    } catch(e) {\n      setByggdelMallar([]);\n    } finally {\n      setByggdelMallarLoading(false);\n    }\n  };\n  const [showCategoryModal, setShowCategoryModal] = useState(false);\n  const [selectedCategories, setSelectedCategories] = useState(() => {\n    if (!Array.isArray(checklistConfig) || checklistConfig.length === 0) return [];\n    // Arbetsberedning: start with all categories unchecked\n    if (controlType === 'Arbetsberedning') {\n      if (initialValues && Array.isArray(initialValues.selectedCategories) && initialValues.selectedCategories.length === checklistConfig.length) {\n        return initialValues.selectedCategories;\n      }\n      if (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0) {\n        const selectedLabels = new Set((initialValues.checklist || []).map(s => s && s.label).filter(Boolean));\n        return checklistConfig.map(sec => selectedLabels.has(sec.label));\n      }\n      return checklistConfig.map(() => false);\n    }\n    // Other controls: default to all categories enabled\n    return checklistConfig.map(() => true);\n  });\n\n  const applySelectedCategoriesToChecklist = (categoryFlags) => {\n    try {\n      const cfg = (Array.isArray(checklistConfig) ? checklistConfig : []);\n      const flags = Array.isArray(categoryFlags) ? categoryFlags : [];\n      const current = Array.isArray(checklist) ? checklist : [];\n      const existingByLabel = new Map(current.map(s => [s && s.label ? s.label : '', s]));\n      const newChecklist = cfg\n        .filter((_, i) => !!flags[i])\n        .map(section => {\n          const points = Array.isArray(section.points) ? [...section.points] : [];\n          const existing = existingByLabel.get(section.label) || null;\n          if (existing && Array.isArray(existing.points)) {\n            const existingStatuses = Array.isArray(existing.statuses) ? existing.statuses : [];\n            const existingPhotos = Array.isArray(existing.photos) ? existing.photos : [];\n            const existingComments = Array.isArray(existing.comments) ? existing.comments : [];\n            const idxByPoint = new Map((existing.points || []).map((pt, idx) => [pt, idx]));\n            const statuses = points.map(pt => {\n              const exIdx = idxByPoint.get(pt);\n              return (exIdx === undefined) ? null : (existingStatuses[exIdx] ?? null);\n            });\n            const photos = points.map(pt => {\n              const exIdx = idxByPoint.get(pt);\n              const p = (exIdx === undefined) ? [] : existingPhotos[exIdx];\n              return Array.isArray(p) ? p : (p ? [p] : []);\n            });\n            const comments = points.map(pt => {\n              const exIdx = idxByPoint.get(pt);\n              return (exIdx === undefined) ? '' : (existingComments[exIdx] ?? '');\n            });\n            return {\n              ...existing,\n              label: section.label,\n              points,\n              statuses,\n              photos,\n              comments,\n            };\n          }\n          return {\n            label: section.label,\n            points,\n            statuses: Array(points.length).fill(null),\n            photos: Array(points.length).fill([]),\n            comments: Array(points.length).fill(''),\n          };\n        });\n      if (!shallowEqual(newChecklist, checklist)) {\n        setChecklist(newChecklist);\n      }\n      setExpandedChecklist([]);\n    } catch(e) {}\n  };\n\n  useEffect(() => {\n    // Arbetsberedning: load project-level category defaults (local AsyncStorage)\n    if (controlType !== 'Arbetsberedning') return;\n    const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\n    const pid = project && project.id ? String(project.id) : '';\n    if (!pid || cfg.length === 0) return;\n    if (didInitArbetsberedningCategoriesRef.current) return;\n\n    const hasInitialSelection = !!(\n      (initialValues && Array.isArray(initialValues.selectedCategories) && initialValues.selectedCategories.length === cfg.length) ||\n      (initialValues && Array.isArray(initialValues.checklist) && initialValues.checklist.length > 0)\n    );\n    if (hasInitialSelection) {\n      didInitArbetsberedningCategoriesRef.current = true;\n      return;\n    }\n\n    didInitArbetsberedningCategoriesRef.current = true;\n    (async () => {\n      try {\n        const raw = await AsyncStorage.getItem(arbetsberedningCategoryKey(pid));\n        if (!raw) return;\n        const parsed = JSON.parse(raw);\n\n        let flags = null;\n        if (Array.isArray(parsed) && parsed.length > 0) {\n          // Backward compatible formats:\n          // - boolean[] same length as cfg\n          // - string[] of selected labels\n          if (parsed.every(v => typeof v === 'boolean') && parsed.length === cfg.length) {\n            flags = parsed;\n          } else if (parsed.every(v => typeof v === 'string')) {\n            const selectedLabels = new Set(parsed.map(s => String(s || '').trim()).filter(Boolean));\n            flags = cfg.map(sec => selectedLabels.has(String(sec && sec.label ? sec.label : '').trim()));\n          }\n        } else if (parsed && typeof parsed === 'object') {\n          // Newer format: { selectedLabels: string[] }\n          if (Array.isArray(parsed.selectedLabels) && parsed.selectedLabels.every(v => typeof v === 'string')) {\n            const selectedLabels = new Set(parsed.selectedLabels.map(s => String(s || '').trim()).filter(Boolean));\n            flags = cfg.map(sec => selectedLabels.has(String(sec && sec.label ? sec.label : '').trim()));\n          }\n        }\n\n        if (!flags || flags.length !== cfg.length) return;\n        setSelectedCategories(flags);\n\n        // If this is a new control with empty checklist, apply immediately.\n        const currentChecklist = Array.isArray(checklistRef?.current) ? checklistRef.current : (Array.isArray(checklist) ? checklist : []);\n        if (!currentChecklist || currentChecklist.length === 0) {\n          applySelectedCategoriesToChecklist(flags);\n        }\n      } catch(e) {}\n    })();\n  }, [controlType, project && project.id, checklistConfig, initialValues]);\n\n  useEffect(() => {\n    // Arbetsberedning: load project-level active byggdel filter (local AsyncStorage)\n    if (controlType !== 'Arbetsberedning') return;\n    const pid = project && project.id ? String(project.id) : '';\n    if (!pid) return;\n    if (loadedAktivaByggdelPidRef.current === pid) return;\n    loadedAktivaByggdelPidRef.current = pid;\n\n    (async () => {\n      try {\n        const raw = await AsyncStorage.getItem(arbetsberedningActiveByggdelKey(pid));\n        if (!raw) {\n          setAktivaByggdelarSelectedKeys([]);\n          return;\n        }\n        const parsed = JSON.parse(raw);\n        let keys = [];\n        let legacyPrefixes = [];\n\n        if (Array.isArray(parsed) && parsed.every(v => typeof v === 'string')) {\n          // Backward compatible formats:\n          // - string[] of \"prefix\" (e.g. \"3\")\n          // - string[] of \"prefix||moment\" keys\n          const anyKey = parsed.some(v => String(v || '').includes('||'));\n          if (anyKey) {\n            keys = parsed;\n          } else {\n            legacyPrefixes = parsed;\n          }\n        } else if (parsed && typeof parsed === 'object') {\n          if (Array.isArray(parsed.selectedKeys) && parsed.selectedKeys.every(v => typeof v === 'string')) {\n            keys = parsed.selectedKeys;\n          } else if (Array.isArray(parsed.selectedPrefixes) && parsed.selectedPrefixes.every(v => typeof v === 'string')) {\n            legacyPrefixes = parsed.selectedPrefixes;\n          }\n        }\n\n        const normalizedKeys = (Array.isArray(keys) ? keys : [])\n          .map(x => String(x || '').trim())\n          .filter(x => !!x && x.includes('||'));\n\n        if (normalizedKeys.length > 0) {\n          setAktivaByggdelarSelectedKeys(normalizedKeys);\n          return;\n        }\n\n        // Migrate legacy huvudgrupp-prefix filter to moment keys (select all moments in those prefixes)\n        const prefixes = (Array.isArray(legacyPrefixes) ? legacyPrefixes : [])\n          .map(x => String(x || '').trim())\n          .filter(Boolean);\n        if (prefixes.length === 0) {\n          setAktivaByggdelarSelectedKeys([]);\n          return;\n        }\n\n        const migrated = [];\n        prefixes.forEach(prefix => {\n          const momentsCandidate = (defaultByggdelMomentsByGroup && defaultByggdelMomentsByGroup[prefix]) || [];\n          const moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\n          moments.forEach(mm => {\n            const m = String(mm || '').trim();\n            if (!m) return;\n            migrated.push(`${prefix}||${m}`);\n          });\n        });\n\n        const uniq = Array.from(new Set(migrated.map(x => String(x || '').trim()).filter(Boolean)));\n        setAktivaByggdelarSelectedKeys(uniq);\n      } catch(e) {\n        setAktivaByggdelarSelectedKeys([]);\n      }\n    })();\n  }, [controlType, project && project.id]);\n\n  useEffect(() => {\n    // If checklistConfig arrives/changes, initialize checkbox array length once without overriding user toggles\n    const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\n    setSelectedCategories(prev => {\n      if (Array.isArray(prev) && prev.length === cfg.length) return prev;\n      if (cfg.length === 0) return [];\n      if (controlType === 'Arbetsberedning') return cfg.map(() => false);\n      return cfg.map(() => true);\n    });\n  }, [checklistConfig, controlType]);\n  const windowWidth = Dimensions.get('window').width;\n  const startX = useRef(0);\n  const handleTouchStart = (e) => {\n    startX.current = e.nativeEvent.pageX;\n  };\n  const handleTouchEnd = (e, uris, index) => {\n    const dx = e.nativeEvent.pageX - startX.current;\n    if (dx > 40 && index > 0) {\n      setPhotoModal((m) => ({ ...m, index: m.index - 1 }));\n    } else if (dx < -40 && index < uris.length - 1) {\n      setPhotoModal((m) => ({ ...m, index: m.index + 1 }));\n    }\n  };\n\n  // Handle cameraResult photo adding logic in a useEffect\n    // Save checklist state to route.params before navigating to CameraCapture\n    const handleNavigateToCamera = (sectionIdx, pointIdx, project) => {\n        // Always pass the current checklist state to CameraCapture\n        // include returnScreen so CameraCapture can navigate back to the correct form\n        navigation.navigate('CameraCapture', {\n          sectionIdx,\n          pointIdx,\n          project,\n          // Provide the caller route key so CameraCapture can set params on return\n          returnKey: route.key || null,\n          // Provide the caller route name so CameraCapture can fallback to navigating back\n          // to the correct screen if key-based setParams doesn't reach it.\n          returnScreen: route.name || null,\n          autoSave: controlType === 'Mottagningskontroll',\n          mottagningsPhotos: mottagningsPhotosRef.current || [],\n        });\n      };\n\n    const handlePickFromLibrary = async () => {\n      try {\n        console.log('[BaseControlForm] handlePickFromLibrary start');\n        try { Keyboard.dismiss(); } catch(e) {}\n        setShowPhotoChoice(false);\n        let perm = null;\n        try {\n          if (typeof ImagePicker.getMediaLibraryPermissionsAsync === 'function') {\n            perm = await ImagePicker.getMediaLibraryPermissionsAsync();\n          }\n        } catch(e) {}\n        if (!perm || !(perm.granted === true || perm.status === 'granted')) {\n          try {\n            perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\n          } catch(e) {}\n        }\n        const ok = (perm && (perm.granted === true || perm.status === 'granted'));\n        if (!ok) {\n          alert('Behöver tillgång till bildbiblioteket för att välja bilder.');\n          return;\n        }\n        const mediaTypesOption = (ImagePicker && ImagePicker.MediaTypeOptions && ImagePicker.MediaTypeOptions.Images)\n          ? ImagePicker.MediaTypeOptions.Images\n          : undefined;\n        const pickerOptions = { quality: 0.8 };\n        if (mediaTypesOption) pickerOptions.mediaTypes = mediaTypesOption;\n        await new Promise(resolve => InteractionManager.runAfterInteractions(() => setTimeout(resolve, 500)));\n        const launchPromise = ImagePicker.launchImageLibraryAsync(pickerOptions);\n        let res;\n        try {\n          res = await Promise.race([\n            launchPromise,\n            new Promise((_, reject) => setTimeout(() => reject(new Error('picker_timeout')), 7000)),\n          ]);\n        } catch (launchErr) {\n          if (launchErr && launchErr.message === 'picker_timeout') {\n            alert('Bildväljaren svarade inte. Försök igen.');\n            return;\n          }\n          alert('Kunde inte öppna bildväljaren: ' + (launchErr?.message || launchErr));\n          return;\n        }\n        const extractAssets = (r) => {\n          if (!r) return [];\n          if (Array.isArray(r.assets) && r.assets.length) return r.assets;\n          if (Array.isArray(r.selectedAssets) && r.selectedAssets.length) return r.selectedAssets;\n          if (r.uri) return [{ uri: r.uri }];\n          if (r.cancelled === false && r.uri) return [{ uri: r.uri }];\n          return [];\n        };\n        const assets = extractAssets(res);\n        if (assets && assets.length > 0) {\n          const photos = assets.map(a => {\n            const uri = a?.uri || a?.uriString || a?.localUri || (a?.base64 ? `data:image/jpeg;base64,${a.base64}` : null);\n            return uri ? { uri, comment: '' } : null;\n          }).filter(Boolean);\n          if (photos.length > 0) {\n            // If a checklist photo modal is open, add to the correct checklist point\n            if (photoModal && typeof photoModal.sectionIdx === 'number' && typeof photoModal.pointIdx === 'number') {\n              setChecklist(prev => prev.map((section, sIdx) => {\n                if (sIdx !== photoModal.sectionIdx) return section;\n                const points = Array.isArray(section.points) ? section.points : [];\n                let photosArr = Array.isArray(section.photos) && section.photos.length === points.length\n                  ? [...section.photos]\n                  : Array(points.length).fill([]);\n                if (!Array.isArray(photosArr[photoModal.pointIdx])) photosArr[photoModal.pointIdx] = [];\n                // Avoid duplicates\n                const existingUris = new Set((photosArr[photoModal.pointIdx] || []).map(p => (p && p.uri) ? p.uri : p));\n                const toAdd = photos.filter(p => p && p.uri && !existingUris.has(p.uri));\n                photosArr[photoModal.pointIdx] = [...(photosArr[photoModal.pointIdx] || []), ...toAdd];\n                return { ...section, photos: photosArr };\n              }));\n              // Also update modal state to show new images\n              setPhotoModal(m => {\n                const newUris = [...(m.uris || []), ...photos.filter(p => p && p.uri && !(m.uris || []).some(u => (u && u.uri) ? u.uri === p.uri : u === p.uri))];\n                return { ...m, uris: newUris, index: newUris.length > 0 ? newUris.length - 1 : 0 };\n              });\n            } else {\n              // Otherwise, add to main mottagningsPhotos\n              setMottagningsPhotos(prev => {\n                const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\n                const existing = new Set(prevArr.map(p => p && p.uri).filter(Boolean));\n                const toAdd = photos.filter(p => p && p.uri && !existing.has(p.uri));\n                if (!toAdd.length) return prevArr;\n                const next = [...prevArr, ...toAdd];\n                mottagningsPhotosRef.current = next;\n                return next;\n              });\n            }\n          }\n        }\n        // User cancelled or no assets: No-op\n      } catch(e) {\n        console.warn('Image pick error', e);\n        alert('Kunde inte välja bild: ' + (e?.message || e));\n      }\n    };\n\n  // Guarded camera result handling to avoid re-processing and param cycles\n  const cameraHandledRef = useRef(false);\n  const processedCameraUrisRef = useRef(new Set());\n\n  // Helper: merge two drafts conservatively (preserve photos, participants, signatures, checklist photos)\n  const mergeDrafts = (existing, incoming) => {\n    if (!existing) return incoming;\n    if (!incoming) return existing;\n    const out = { ...existing, ...incoming };\n    // Merge participants (unique by name+company)\n    try {\n      const a = Array.isArray(existing.participants) ? existing.participants : [];\n      const b = Array.isArray(incoming.participants) ? incoming.participants : [];\n      const key = (p) => ((p && p.name) ? p.name : JSON.stringify(p)) + '::' + ((p && p.company) ? p.company : '');\n      const map = new Map();\n      a.concat(b).forEach(p => { try { map.set(key(p), p); } catch(e) {} });\n      out.participants = Array.from(map.values());\n    } catch(e) {}\n    // Merge mottagningsSignatures\n    try {\n      const a = Array.isArray(existing.mottagningsSignatures) ? existing.mottagningsSignatures : [];\n      const b = Array.isArray(incoming.mottagningsSignatures) ? incoming.mottagningsSignatures : [];\n      out.mottagningsSignatures = [...a, ...b.filter(s => !a.includes(s))];\n    } catch(e) {}\n    // Merge mottagningsPhotos by uri\n    try {\n      const a = Array.isArray(existing.mottagningsPhotos) ? existing.mottagningsPhotos : [];\n      const b = Array.isArray(incoming.mottagningsPhotos) ? incoming.mottagningsPhotos : [];\n      const seen = new Set(a.map(x => x && x.uri).filter(Boolean));\n      const merged = [...a];\n      b.forEach(x => { if (x && x.uri && !seen.has(x.uri)) { seen.add(x.uri); merged.push(x); } });\n      out.mottagningsPhotos = merged;\n    } catch(e) {}\n    // Merge checklist: prefer incoming structure but union photos per point\n    try {\n      const A = Array.isArray(existing.checklist) ? existing.checklist : [];\n      const B = Array.isArray(incoming.checklist) ? incoming.checklist : [];\n      if (B.length === 0) {\n        out.checklist = A;\n      } else if (A.length === 0) {\n        out.checklist = B;\n      } else {\n        const mergedChecklist = B.map((secB, sIdx) => {\n          const secA = A[sIdx] || {};\n          const points = Array.isArray(secB.points) ? secB.points : (Array.isArray(secA.points) ? secA.points : []);\n          const statuses = Array.isArray(secB.statuses) && secB.statuses.length === points.length ? secB.statuses : (secA.statuses || Array(points.length).fill(null));\n          const photosA = Array.isArray(secA.photos) ? secA.photos : Array(points.length).fill([]);\n          const photosB = Array.isArray(secB.photos) ? secB.photos : Array(points.length).fill([]);\n          const photos = points.map((_, pIdx) => {\n            const aArr = Array.isArray(photosA[pIdx]) ? photosA[pIdx] : (photosA[pIdx] ? [photosA[pIdx]] : []);\n            const bArr = Array.isArray(photosB[pIdx]) ? photosB[pIdx] : (photosB[pIdx] ? [photosB[pIdx]] : []);\n            const seen = new Set(aArr.map(x => (x && x.uri) ? x.uri : x).filter(Boolean));\n            const outArr = [...aArr];\n            bArr.forEach(item => { const uri = (item && item.uri) ? item.uri : item; if (uri && !seen.has(uri)) { seen.add(uri); outArr.push(item); } });\n            return outArr;\n          });\n          return { ...secB, points, statuses, photos };\n        });\n        out.checklist = mergedChecklist;\n      }\n    } catch(e) {}\n    return out;\n  };\n\n  // Persist a draft object by merging with existing matching draft(s)\n  const persistDraftObject = async (draftObj) => {\n    if (!draftObj || !draftObj.project) {\n      // still write minimal object to avoid losing the id\n    }\n    let arr = [];\n    try {\n      const raw = await AsyncStorage.getItem('draft_controls');\n      if (raw) arr = JSON.parse(raw) || [];\n    } catch(e) { arr = []; }\n    // Find matching draft by id first\n    let idx = -1;\n    if (draftObj && draftObj.id) {\n      idx = arr.findIndex(c => c.id === draftObj.id && c.project?.id === draftObj.project?.id && c.type === draftObj.type);\n    }\n    // If not found, try match by project+type (to merge newer content into older draft)\n    if (idx === -1 && draftObj && draftObj.project) {\n      idx = arr.findIndex(c => c.project?.id === draftObj.project?.id && c.type === draftObj.type);\n    }\n    if (idx !== -1) {\n      const merged = mergeDrafts(arr[idx], draftObj);\n      arr[idx] = merged;\n      lastSavedDraftRef.current = merged;\n    } else {\n      arr.push(draftObj);\n      lastSavedDraftRef.current = draftObj;\n    }\n    await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\n    // ...existing code...\n    return arr;\n  };\n\n  const processCameraResult = (cameraResult) => {\n    if (!cameraResult) return;\n    // ...existing code...\n    const { uri, sectionIdx, pointIdx, returnedMottagningsPhotos } = cameraResult;\n    if (returnedMottagningsPhotos && Array.isArray(returnedMottagningsPhotos)) {\n      try {\n        const norm = normalizePhotos(returnedMottagningsPhotos);\n        // Filter duplicates by uri\n        const prev = mottagningsPhotosRef.current || [];\n        const existingUris = new Set(prev.map(p => p && p.uri).filter(Boolean));\n        const toAdd = norm.filter(p => p && p.uri && !existingUris.has(p.uri));\n        // Attach any new returned photo URIs to the specific checklist point (if provided)\n        try {\n          if (sectionIdx !== undefined && pointIdx !== undefined) {\n            const urisToAttach = toAdd.map(p => p.uri).filter(Boolean);\n              if (urisToAttach.length > 0) {\n              // ...existing code...\n              const prevChecklist = checklistRef.current || [];\n              const updated = prevChecklist.map((section, sIdx) => {\n                if (sIdx !== sectionIdx) return section;\n                const points = Array.isArray(section.points) ? section.points : [];\n                let photos = Array.isArray(section.photos) && section.photos.length === points.length\n                  ? [...section.photos]\n                  : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\n                photos[pointIdx] = Array.isArray(photos[pointIdx]) ? photos[pointIdx] : [];\n                photos[pointIdx] = [...photos[pointIdx], ...urisToAttach];\n                return { ...section, photos, points };\n              });\n              setChecklist(updated);\n              checklistRef.current = updated;\n              setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\n              // Persist draft with updated checklist (merge/upsert to avoid overwriting richer state)\n              (async () => {\n                try {\n                  const toSaveId = draftId || uuidv4();\n                  try { setDraftId(toSaveId); } catch(e) {}\n                  const draftObj = {\n                    id: toSaveId,\n                    date: dateValue,\n                    project,\n                    ...weatherPayload,\n                    byggdel,\n                    byggdelTemplate,\n                    participants: localParticipants,\n                    materialDesc,\n                    qualityDesc,\n                    coverageDesc,\n                    mottagningsSignatures,\n                    mottagningsPhotos,\n                    checklist: updated,\n                    expandedChecklist,\n                    deliveryDesc,\n                    generalNote,\n                    type: controlType,\n                    savedAt: new Date().toISOString(),\n                  };\n                  try {\n                    await persistDraftObject(draftObj);\n                    // ...existing code...\n                  } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\n                } catch(e) { try { console.warn('[BaseControlForm] persist after attach failed', e); } catch(e) {} }\n              })();\n            }\n          }\n        } catch(e) {}\n        if (toAdd.length === 0) {\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n          return;\n        }\n        setMottagningsPhotos(prevState => {\n          const next = [...(prevState || []), ...toAdd];\n          mottagningsPhotosRef.current = next;\n          return next;\n        });\n        // ...existing code...\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n      } catch(e) {}\n    } else if (uri) {\n      if (processedCameraUrisRef.current.has(uri)) {\n        try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n        return;\n      }\n      if (controlType === 'Mottagningskontroll') {\n        try {\n          processedCameraUrisRef.current.add(uri);\n          setMottagningsPhotos(prev => {\n            const prevArr = Array.isArray(prev) ? prev : (mottagningsPhotosRef.current || []);\n            // avoid duplicates\n            if (prevArr.findIndex(x => x && x.uri === uri) !== -1) return prevArr;\n            const newItem = { uri, comment: '' };\n            const next = [...prevArr, newItem];\n            mottagningsPhotosRef.current = next;\n            return next;\n          });\n          try { console.log('[BaseControlForm] appended uri to mottagningsPhotos, item:', uri); } catch(e) {}\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n        } catch(e) {}\n      } else if (sectionIdx !== undefined && pointIdx !== undefined) {\n        try {\n          const prev = checklistRef.current || [];\n          const newChecklist = prev.map((section, sIdx) => {\n            if (sIdx !== sectionIdx) return section;\n            const points = Array.isArray(section.points) ? section.points : [];\n            let photos = Array.isArray(section.photos) && section.photos.length === points.length\n              ? [...section.photos]\n              : Array(Array.isArray(points) ? points.length : 0).fill(null).map(() => []);\n            if (!Array.isArray(photos[pointIdx])) photos[pointIdx] = photos[pointIdx] ? [photos[pointIdx]] : [];\n            photos[pointIdx] = [...photos[pointIdx], uri];\n            return { ...section, photos, points };\n          });\n          setChecklist(newChecklist);\n          checklistRef.current = newChecklist;\n          setExpandedChecklist(prev => prev.includes(sectionIdx) ? prev : [sectionIdx]);\n          try { navigation.setParams({ cameraResult: undefined }); } catch(e) {}\n          // Persist updated checklist (including photos) to draft controls immediately so\n          // photos added from CameraCapture are not lost if the user navigates away.\n          (async () => {\n            try {\n              const toSaveId = draftId || uuidv4();\n              try { setDraftId(toSaveId); } catch(e) {}\n              const draftObj = {\n                id: toSaveId,\n                date: dateValue,\n                project,\n                ...weatherPayload,\n                byggdel,\n                byggdelTemplate,\n                participants: localParticipants,\n                materialDesc,\n                qualityDesc,\n                coverageDesc,\n                mottagningsSignatures,\n                mottagningsPhotos,\n                checklist: newChecklist,\n                expandedChecklist,\n                deliveryDesc,\n                generalNote,\n                type: controlType,\n                savedAt: new Date().toISOString(),\n              };\n              try {\n                await persistDraftObject(draftObj);\n                try { console.log('[BaseControlForm] persisted draft after uri add, id:', draftObj.id); } catch(e) {}\n              } catch(e) { try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {} }\n            } catch(e) {\n              try { console.warn('[BaseControlForm] persist after uri add failed', e); } catch(e) {}\n            }\n          })();\n        } catch(e) {}\n      }\n    }\n  };\n\n  // Primary effect: react to explicit route.params changes (fast path)\n  useEffect(() => {\n    const cameraResult = route.params?.cameraResult;\n    // ...existing code...\n    if (cameraResult) processCameraResult(cameraResult);\n    if (!route.params?.cameraResult) cameraHandledRef.current = false;\n  }, [route.params?.cameraResult]);\n\n  // Secondary: on focus / navigation state, attempt to find cameraResult set via setParams-by-key\n  useEffect(() => {\n    const checkStateForCameraResult = () => {\n      try {\n        const state = navigation.getState && navigation.getState();\n        if (!state || !Array.isArray(state.routes)) return;\n        // ...existing code...\n        const ourRoute = state.routes.find(r => r.key === route.key);\n        const cr = ourRoute && ourRoute.params && ourRoute.params.cameraResult;\n        if (cr) {\n          // ...existing code...\n          processCameraResult(cr);\n        } else {\n          // Log which route appears previous to the current index for debugging\n          try {\n            const idx = typeof state.index === 'number' ? state.index : state.routes.findIndex(r => r.key === route.key);\n            const prev = (typeof idx === 'number' && idx > 0) ? state.routes[idx - 1] : null;\n            // ...existing code...\n          } catch(e) {}\n        }\n      } catch(e) {}\n    };\n    const unsub = navigation.addListener('focus', () => { checkStateForCameraResult(); });\n    // also check immediately (in case params were set while backgrounded)\n    checkStateForCameraResult();\n    return unsub;\n  }, [navigation, route.key]);\n\n  // Drain any pending camera photos stored in AsyncStorage by CameraCapture as a fallback\n  useEffect(() => {\n    const drainPending = async () => {\n      try {\n        const raw = await AsyncStorage.getItem('pending_camera_photos');\n        if (!raw) return;\n        const arr = JSON.parse(raw || '[]') || [];\n        if (!Array.isArray(arr) || arr.length === 0) return;\n        // ...existing code...\n        for (const cameraResult of arr) {\n          try { processCameraResult(cameraResult); } catch(e) {}\n        }\n        await AsyncStorage.removeItem('pending_camera_photos');\n      } catch(e) {}\n    };\n    const unsub2 = navigation.addListener('focus', () => { drainPending(); });\n    // run now as well\n    drainPending();\n    return unsub2;\n  }, [navigation, processCameraResult]);\n  const [showDateModal, setShowDateModal] = useState(false);\n  const [tempDate, setTempDate] = useState('');\n  const [expandedChecklist, setExpandedChecklist] = useState([]);\n  const [signatureForIndex, setSignatureForIndex] = useState(null);\n  const [sigStrokes, setSigStrokes] = useState([]);\n  const [sigCurrent, setSigCurrent] = useState([]);\n  const sigCurrentRef = useRef([]);\n  const sigStrokesRef = useRef([]);\n  const sigCanvasSize = Math.min(Dimensions.get('window').width * 0.9, 760);\n  const panResponder = useRef(PanResponder.create({\n    onStartShouldSetPanResponder: () => true,\n    onMoveShouldSetPanResponder: () => true,\n    onPanResponderGrant: (e) => {\n      const { locationX, locationY } = e.nativeEvent;\n      const next = [{ x: locationX, y: locationY }];\n      sigCurrentRef.current = next;\n      setSigCurrent(next);\n    },\n    onPanResponderMove: (e) => {\n      const { locationX, locationY } = e.nativeEvent;\n      try {\n        const last = sigCurrentRef.current && sigCurrentRef.current.length ? sigCurrentRef.current[sigCurrentRef.current.length - 1] : null;\n        const dx = last ? Math.abs(locationX - last.x) : Infinity;\n        const dy = last ? Math.abs(locationY - last.y) : Infinity;\n        // Only add a new point if movement exceeds threshold (reduces noise)\n        const THRESH = 2; // pixels\n        if (!last || dx >= THRESH || dy >= THRESH) {\n          const next = [...sigCurrentRef.current, { x: locationX, y: locationY }];\n          sigCurrentRef.current = next;\n          setSigCurrent(next);\n        }\n      } catch(e) {}\n    },\n    onPanResponderRelease: () => {\n      try {\n        const curr = (sigCurrentRef.current && sigCurrentRef.current.length) ? [...(Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []), sigCurrentRef.current] : (Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []);\n        sigStrokesRef.current = curr;\n        setSigStrokes(curr);\n      } catch(e) {}\n      sigCurrentRef.current = [];\n      setSigCurrent([]);\n    },\n    onPanResponderTerminate: () => {\n      try {\n        const curr = (sigCurrentRef.current && sigCurrentRef.current.length) ? [...(Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []), sigCurrentRef.current] : (Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : []);\n        sigStrokesRef.current = curr;\n        setSigStrokes(curr);\n      } catch(e) {}\n      sigCurrentRef.current = [];\n      setSigCurrent([]);\n    }\n  })).current;\n\n  // Spara utkast till AsyncStorage (flera per projekt/kontrolltyp)\n  const saveDraftControl = async () => {\n    // Prevent concurrent saves causing duplicates\n    if (savingDraftRef.current) return lastSavedDraftRef.current;\n    savingDraftRef.current = true;\n    let draft = null;\n    try {\n      // Guard: avoid creating a new empty draft unless there's meaningful data\n      const hasChecklistContent = Array.isArray(checklist) && checklist.some(sec => {\n        if (!sec) return false;\n        if (Array.isArray(sec.statuses) && sec.statuses.some(s => !!s)) return true;\n        if (Array.isArray(sec.photos) && sec.photos.some(pArr => Array.isArray(pArr) && pArr.length > 0)) return true;\n        return false;\n      });\n      const hasText = (deliveryDesc && String(deliveryDesc).trim().length > 0) || (materialDesc && String(materialDesc).trim().length > 0) || (generalNote && String(generalNote).trim().length > 0) || (byggdel && String(byggdel).trim().length > 0);\n      const hasPhotos = Array.isArray(mottagningsPhotos) && mottagningsPhotos.length > 0;\n      const hasSignatures = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length > 0;\n      const hasParticipantsLocal = Array.isArray(localParticipants) && localParticipants.length > 0;\n      const hasWeather = !hideWeather && !!selectedWeather;\n      const shouldPersist = !!lastSavedDraftRef.current || isDirtyRef.current || hasChecklistContent || hasText || hasPhotos || hasSignatures || hasParticipantsLocal || hasWeather;\n      if (!shouldPersist) {\n        // Nothing meaningful to save; avoid creating an empty draft\n        savingDraftRef.current = false;\n        return lastSavedDraftRef.current;\n      }\n      // ...existing code...\n      draft = {\n        id: draftId || uuidv4(),\n        date: dateValue,\n        project,\n        ...weatherPayload,\n        byggdel,\n        byggdelTemplate,\n        selectedCategories,\n        participants: localParticipants,\n        materialDesc,\n        qualityDesc,\n        coverageDesc,\n        mottagningsSignatures,\n        mottagningsPhotos,\n        checklist,\n        expandedChecklist,\n        deliveryDesc,\n        generalNote,\n        type: controlType,\n        savedAt: new Date().toISOString(),\n      };\n      // Ensure subsequent saves update the same draft instead of creating a new one\n      try { setDraftId(draft.id); } catch(e) {}\n\n      // Persist draft using merge-upsert helper so we don't overwrite richer data\n      try {\n        // ...existing code...\n        await persistDraftObject(draft);\n        try {\n          // Best-effort: also save draft to Firestore so web/app can sync\n          await saveDraftToFirestore(draft);\n        } catch(e) {}\n      } catch(e) {\n        try { console.warn('[BaseControlForm] failed to persist draft_controls', e); } catch(e) {}\n      }\n      // store last saved draft so concurrent attempts can reuse it\n      lastSavedDraftRef.current = draft;\n      return draft;\n    } catch(e) {\n      // If persistence fails, still return the constructed draft so callers/upserters reuse same id\n      try { if (draft) lastSavedDraftRef.current = draft; } catch(e) {}\n      alert('Kunde inte spara utkast: ' + (e && e.message ? e.message : String(e)));\n      return draft;\n    } finally {\n      savingDraftRef.current = false;\n    }\n  };\n\n  // Spara slutförd kontroll och ta bort ev. utkast\n  const handleSave = async () => {\n    if (finishingSaveRef.current) return;\n    finishingSaveRef.current = true;\n\n    const isEditingCompleted = !!(initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed));\n    const resolvedId = (initialValues && initialValues.id)\n      ? initialValues.id\n      : (draftId || uuidv4());\n    // Ensure repeated saves (e.g. accidental double click) target the same record.\n    try {\n      if (!(initialValues && initialValues.id) && !draftId) setDraftId(resolvedId);\n    } catch(e) {}\n\n    try {\n      if (onSave) {\n        await Promise.resolve(onSave({\n          id: resolvedId,\n          date: dateValue,\n          project,\n          ...weatherPayload,\n          byggdel,\n          byggdelTemplate,\n          selectedCategories,\n          participants: localParticipants,\n          materialDesc,\n          qualityDesc,\n          coverageDesc,\n          mottagningsSignatures,\n          mottagningsPhotos,\n          checklist,\n          expandedChecklist,\n          deliveryDesc,\n          generalNote,\n          type: controlType,\n        }));\n      }\n    } catch(e) {\n      finishingSaveRef.current = false;\n      Alert.alert('Kunde inte spara', (e && e.message) ? e.message : String(e));\n      return;\n    }\n    // Ta bort ev. utkast för detta projekt+typ\n    try {\n      const existing = await AsyncStorage.getItem('draft_controls');\n      if (existing) {\n        let arr = JSON.parse(existing);\n        arr = arr.filter(\n          c => !(c.project?.id === project?.id && c.type === controlType)\n        );\n        await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\n      }\n    } catch {}\n\n    // Best-effort: also delete the draft in Firestore so web/app stay in sync\n    try {\n      const draftIdToDelete = (initialValues && initialValues.id)\n        ? initialValues.id\n        : (draftId || null);\n      if (draftIdToDelete) {\n        await deleteDraftControlFromFirestore(draftIdToDelete);\n      }\n    } catch(e) {}\n    // Clear dirty flag so beforeRemove won't intercept navigation\n    try {\n      isDirtyRef.current = false;\n    } catch(e) {}\n\n    // For \"Slutför\" on web: show a lightweight confirmation (like \"Spara utkast\")\n    // and then exit back to the project automatically.\n    if (!isEditingCompleted) {\n      try { setShowFinishConfirm(true); } catch(e) {}\n      setTimeout(() => {\n        try { setShowFinishConfirm(false); } catch(e) {}\n        finishingSaveRef.current = false;\n        try {\n          if (typeof onFinished === 'function') {\n            onFinished();\n            return;\n          }\n          if (typeof onExit === 'function') {\n            onExit();\n            return;\n          }\n          if (navigation && navigation.navigate && project) {\n            navigation.navigate('ProjectDetails', { project });\n          } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\n            navigation.goBack();\n          }\n        } catch(e) {}\n      }, 900);\n      return;\n    }\n\n    // Editing an already completed control: keep the explicit OK flow.\n    finishingSaveRef.current = false;\n    setTimeout(() => {\n      Alert.alert(\n        'Sparad',\n        'Dina ändringar är sparade i kontrollen.',\n        [\n          {\n            text: 'OK',\n            onPress: () => {\n              if (typeof onFinished === 'function') {\n                onFinished();\n                return;\n              }\n              if (typeof onExit === 'function') {\n                onExit();\n                return;\n              }\n              if (navigation && navigation.navigate && project) {\n                navigation.navigate('ProjectDetails', { project });\n              } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\n                navigation.goBack();\n              }\n            },\n          },\n        ],\n        { cancelable: false }\n      );\n    }, 100);\n  };\n\n  // Spara utkast\n  const handleSaveDraft = async () => {\n    const draft = await saveDraftControl();\n    // ...existing code...\n    if (onSaveDraft) await onSaveDraft(draft || {\n      date: dateValue,\n      project,\n      ...weatherPayload,\n      byggdel,\n      byggdelTemplate,\n      selectedCategories,\n      participants: localParticipants,\n      materialDesc,\n      qualityDesc,\n      coverageDesc,\n      mottagningsSignatures,\n      mottagningsPhotos,\n      checklist,\n      expandedChecklist,\n      deliveryDesc,\n      generalNote,\n      type: controlType,\n    });\n    try {\n      // Mark form as not dirty and hide any back-confirm modal so navigation proceeds cleanly\n      try { isDirtyRef.current = false; } catch(e) {}\n      try { setShowBackConfirm(false); } catch(e) {}\n      setShowDraftSavedConfirm(true);\n      setTimeout(() => {\n        try { setShowDraftSavedConfirm(false); } catch(e) {}\n        try {\n          if (blockedNavEvent.current) {\n            blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\n            blockedNavEvent.current = null;\n          } else if (typeof onExit === 'function') {\n            onExit();\n          } else if (navigation && navigation.canGoBack && navigation.canGoBack()) {\n            navigation.goBack();\n          }\n        } catch(e) {}\n      }, 1000);\n    } catch(e) {}\n  };\n\n  // Render\n  // Determine whether the control may be completed (enabled \"Slutför\").\n  // For Riskbedömning: require date, >=1 participant, 'Beskriv arbetsmoment', all checklist points, and at least one signature.\n  // For Mottagningskontroll: require date, >=1 participant, material description, all checklist points, and at least one signature.\n  // For Skyddsrond: require date, >=1 participant, scope/description, all checklist points, and at least one signature.\n  const canFinish = (() => {\n    if (controlType === 'Riskbedömning') {\n      const hasDate = typeof dateValue === 'string' && dateValue.trim().length > 0;\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\n      const hasScope = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\n      const checklistComplete = (() => {\n        if (!Array.isArray(checklist) || checklist.length === 0) return false;\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\n      })();\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\n      return hasDate && hasParticipants && hasScope && checklistComplete && hasSignature;\n    }\n    if (controlType === 'Skyddsrond') {\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\n      const hasScope = typeof deliveryDesc === 'string' && deliveryDesc.trim().length > 0;\n      const checklistComplete = (() => {\n        if (!Array.isArray(checklist) || checklist.length === 0) return true;\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\n      })();\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\n      return hasParticipants && hasScope && checklistComplete && hasSignature;\n    }\n    if (controlType === 'Mottagningskontroll') {\n      const hasParticipants = Array.isArray(localParticipants) && localParticipants.length >= 1;\n      const hasMaterial = typeof materialDesc === 'string' && materialDesc.trim().length > 0;\n      const checklistComplete = (() => {\n        if (!Array.isArray(checklist) || checklist.length === 0) return true;\n        return checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s));\n      })();\n      const hasSignature = Array.isArray(mottagningsSignatures) && mottagningsSignatures.length >= 1;\n      return hasParticipants && hasMaterial && checklistComplete && hasSignature;\n    }\n    // Default: allow finish\n    return true;\n  })();\n\n  return (\n    <>\n      {/* Modal för åtgärd/åtgärdsinfo */}\n      <Modal visible={remediationModal.visible} transparent animationType=\"fade\" onRequestClose={() => setRemediationModal({ ...remediationModal, visible: false })}>\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 20, width: 320, alignItems: 'center' }}>\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 10, color: '#222' }}>{remediationModal.infoMode ? 'Åtgärdsinfo' : 'Åtgärda avvikelse'}</Text>\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 8 }}>Punkt: {remediationModal.sectionIdx !== null && remediationModal.pointIdx !== null ? checklist[remediationModal.sectionIdx].points[remediationModal.pointIdx] : ''}</Text>\n            <TextInput\n              value={remediationModal.comment}\n              onChangeText={text => setRemediationModal(m => ({ ...m, comment: text }))}\n              placeholder=\"Beskriv åtgärd\"\n              placeholderTextColor=\"#888\"\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: remediationModal.infoMode ? '#f5f5f5' : '#fff', width: '100%', marginBottom: 10 }}\n              editable={!remediationModal.infoMode}\n              multiline\n            />\n            <TextInput\n              value={remediationModal.name}\n              onChangeText={text => setRemediationModal(m => ({ ...m, name: text }))}\n              placeholder=\"Namn på åtgärdande person\"\n              placeholderTextColor=\"#888\"\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: remediationModal.infoMode ? '#f5f5f5' : '#fff', width: '100%', marginBottom: 10 }}\n              editable={!remediationModal.infoMode}\n            />\n            {/* Spara/avbryt/info-knappar */}\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%', marginTop: 8 }}>\n              <TouchableOpacity onPress={() => setRemediationModal({ ...remediationModal, visible: false })} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\n                <Text style={{ color: '#777' }}>Avbryt</Text>\n              </TouchableOpacity>\n              {!remediationModal.infoMode && (\n                <TouchableOpacity\n                  onPress={() => {\n                    // Spara åtgärd i checklistan\n                    const { sectionIdx, pointIdx, comment, name } = remediationModal;\n                    if (sectionIdx === null || pointIdx === null) return;\n                    setChecklist(prev => prev.map((s, sIdx) => {\n                      if (sIdx !== sectionIdx) return s;\n                      const remediation = { ...(s.remediation || {}) };\n                      const pt = s.points[pointIdx];\n                      remediation[pt] = {\n                        comment,\n                        name,\n                        date: new Date().toISOString(),\n                      };\n                      return { ...s, remediation };\n                    }));\n                    setRemediationModal({ ...remediationModal, visible: false });\n                    // Persist draft immediately so the saved åtgärd is not lost\n                    (async () => {\n                      try {\n                        await saveDraftControl();\n                      } catch(e) { }\n                    })();\n                  }}\n                  style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\n                >\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Spara</Text>\n                </TouchableOpacity>\n              )}\n            </View>\n          </View>\n        </View>\n      </Modal>\n\n      {/* ...ingen testknapp/modal... */}\n      {/* Modal för bekräftelse vid tillbaka om formuläret är ändrat */}\n      <Modal\n        visible={showBackConfirm}\n        transparent={true}\n        animationType=\"fade\"\n        onRequestClose={() => closeBackConfirm('cancel')}\n      >\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 28, width: 320, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6, position: 'relative' }}>\n            {/* Close (X) icon in top right */}\n            <TouchableOpacity\n              onPress={() => closeBackConfirm('cancel')}\n              style={{ position: 'absolute', top: 12, right: 12, zIndex: 10, padding: 6 }}\n              accessibilityLabel=\"Stäng\"\n              hitSlop={{ top: 12, bottom: 12, left: 12, right: 12 }}\n            >\n              <Ionicons name=\"close\" size={26} color=\"#888\" />\n            </TouchableOpacity>\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 16, color: '#222', textAlign: 'center', marginTop: 4 }}>\n              {backConfirmMode === 'dirty' ? 'Vill du avbryta kontrollen?' : 'Vill du lämna kontrollen?'}\n            </Text>\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 28, textAlign: 'center' }}>\n              {backConfirmMode === 'dirty'\n                ? 'Du har osparade ändringar. Välj om du vill spara utkast eller avbryta.'\n                : 'Välj om du vill spara som utkast eller avbryta.'}\n            </Text>\n            <View style={{ flexDirection: 'row', width: '100%', justifyContent: 'space-between' }}>\n              <TouchableOpacity\n                style={{ flex: 1, borderWidth: 1, borderColor: '#1976D2', borderRadius: 8, paddingVertical: 14, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent' }}\n                onPress={async () => {\n                  const draft = await saveDraftControl();\n                      if (onSaveDraft) await onSaveDraft(draft || {\n                        date: dateValue,\n                        project,\n                        ...weatherPayload,\n                        byggdel,\n                        byggdelTemplate,\n                        selectedCategories,\n                        participants: localParticipants,\n                        materialDesc,\n                        qualityDesc,\n                        coverageDesc,\n                        mottagningsSignatures,\n                        checklist,\n                        deliveryDesc,\n                        generalNote,\n                        type: controlType,\n                      });\n                  // Ensure navigation won't be blocked by dirty flag after saving\n                  try { isDirtyRef.current = false; } catch(e) {}\n                  closeBackConfirm('draft');\n                  if (blockedNavEvent.current) {\n                    blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\n                    blockedNavEvent.current = null;\n                  } else if (typeof onExit === 'function') {\n                    onExit();\n                  } else {\n                    navigation.goBack();\n                  }\n                }}\n              >\n                <Text style={{ color: '#1976D2', fontWeight: 'normal', fontSize: 16 }}>Spara utkast</Text>\n              </TouchableOpacity>\n              <TouchableOpacity\n                style={{ flex: 1, borderWidth: 1, borderColor: '#D32F2F', borderRadius: 8, paddingVertical: 14, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent' }}\n                onPress={() => {\n                  closeBackConfirm('abort');\n                  if (blockedNavEvent.current) {\n                    blockedNavEvent.current.data.action && navigation.dispatch(blockedNavEvent.current.data.action);\n                    blockedNavEvent.current = null;\n                  } else if (typeof onExit === 'function') {\n                    onExit();\n                  } else {\n                    navigation.goBack();\n                  }\n                }}\n              >\n                <Text style={{ color: '#D32F2F', fontWeight: 'normal', fontSize: 16 }}>Avbryt</Text>\n              </TouchableOpacity>\n            </View>\n            </View>\n          </View>\n      </Modal>\n      {/* Confirmation after successful finish */}\n      <Modal visible={showFinishConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowFinishConfirm(false)}>\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 12, padding: 20, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Ionicons name=\"checkmark-circle\" size={44} color=\"#43A047\" style={{ marginBottom: 8 }} />\n            <Text style={{ fontSize: 16, color: '#222', textAlign: 'center', fontWeight: '600' }}>Kontrollen är slutförd och sparad i projektet.</Text>\n          </View>\n        </View>\n      </Modal>\n      {/* Confirmation after saving draft */}\n      <Modal visible={showDraftSavedConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowDraftSavedConfirm(false)}>\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 12, padding: 20, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Ionicons name=\"save-outline\" size={44} color=\"#D32F2F\" style={{ marginBottom: 8 }} />\n            <Text style={{ fontSize: 16, color: '#222', textAlign: 'center', fontWeight: '600' }}>Kontrollen sparas som utkast.</Text>\n          </View>\n        </View>\n      </Modal>\n      {/* Modal för bildgranskning med swipe */}\n      <Modal\n        visible={photoModal.visible}\n        transparent={true}\n        animationType=\"fade\"\n        onRequestClose={() => setPhotoModal({ ...photoModal, visible: false })}\n      >\n        <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === 'ios' ? 'padding' : 'height'} keyboardVerticalOffset={80}>\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.95)', justifyContent: 'center', alignItems: 'center' }}>\n            {/* Close (X) icon in top right */}\n            <TouchableOpacity\n              style={{ position: 'absolute', top: 32, right: 24, zIndex: 10, padding: 8 }}\n              onPress={() => setPhotoModal({ ...photoModal, visible: false })}\n              accessibilityLabel=\"Stäng\"\n            >\n              <Text style={{ fontSize: 28, color: '#fff', fontWeight: 'bold' }}>×</Text>\n            </TouchableOpacity>\n            {photoModal.uris.length > 0 && (\n              <View style={{ width: windowWidth, alignItems: 'center', justifyContent: 'center', flex: 1 }}>\n                {/* Modal header with title and close X */}\n                <View style={{ width: '100%', alignItems: 'center', justifyContent: 'center', marginBottom: 8, position: 'relative' }}>\n                  <Text style={{ fontSize: 22, fontWeight: 'bold', color: '#222', marginTop: 8, marginBottom: 8 }}>Bilder för kontrollpunkt</Text>\n                  <TouchableOpacity\n                    style={{ position: 'absolute', top: 0, right: 18, zIndex: 10, padding: 8 }}\n                    onPress={() => setPhotoModal({ ...photoModal, visible: false })}\n                    accessibilityLabel=\"Stäng\"\n                  >\n                    <Text style={{ fontSize: 28, color: '#222', fontWeight: 'bold' }}>×</Text>\n                  </TouchableOpacity>\n                </View>\n                <View style={{\n                  width: Math.min(windowWidth * 0.92, 420),\n                  height: Math.min(windowWidth * 0.92, 420),\n                  maxWidth: 420,\n                  maxHeight: 420,\n                  borderRadius: 18,\n                  backgroundColor: '#222',\n                  alignItems: 'center',\n                  justifyContent: 'center',\n                  overflow: 'hidden',\n                }}>\n                  <Image\n                    source={{ uri: (photoModal.uris[photoModal.index] && photoModal.uris[photoModal.index].uri) ? photoModal.uris[photoModal.index].uri : photoModal.uris[photoModal.index] }}\n                    style={{ width: '100%', aspectRatio: 4/3, backgroundColor: '#111' }}\n                    resizeMode=\"contain\"\n                    onTouchStart={handleTouchStart}\n                    onTouchEnd={(e) => handleTouchEnd(e, photoModal.uris, photoModal.index)}\n                  />\n                </View>\n                {/* Thumbnails row */}\n                <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 10, marginBottom: 8, maxHeight: 60 }}>\n                  {photoModal.uris.map((p, i) => (\n                    <TouchableOpacity\n                      key={i}\n                      onPress={() => setPhotoModal(m => ({ ...m, index: i }))}\n                      style={{ borderWidth: i === photoModal.index ? 2 : 0, borderColor: '#1976D2', borderRadius: 6, marginHorizontal: 2 }}\n                    >\n                      <Image source={{ uri: p.uri || p }} style={{ width: 48, height: 48, borderRadius: 6 }} />\n                    </TouchableOpacity>\n                  ))}\n                </ScrollView>\n                {/* Comment input and delete button */}\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8, width: 320 }}>\n                  <TextInput\n                    value={(photoModal.uris[photoModal.index] && photoModal.uris[photoModal.index].comment) ? photoModal.uris[photoModal.index].comment : ''}\n                    onChangeText={(text) => {\n                      try {\n                        const newUris = (photoModal.uris || []).map((p, i) => i === photoModal.index ? ({ uri: (p && p.uri) ? p.uri : p, comment: text }) : (p && p.uri ? { uri: p.uri, comment: p.comment || '' } : p));\n                        setPhotoModal({ ...photoModal, uris: newUris });\n                        // Persist to mottagningsPhotos if central\n                        const current = photoModal.uris[photoModal.index];\n                        const currentUri = current && current.uri ? current.uri : current;\n                        const mp = mottagningsPhotosRef.current || [];\n                        const idxFound = mp.findIndex(x => x && x.uri === currentUri);\n                        if (idxFound !== -1) {\n                          const mpNew = mp.map((x, xi) => xi === idxFound ? ({ uri: x.uri, comment: text }) : x);\n                          setMottagningsPhotos(mpNew);\n                          mottagningsPhotosRef.current = mpNew;\n                        }\n                      } catch(e) {}\n                    }}\n                    placeholder=\"Lägg till kommentar...\"\n                    placeholderTextColor=\"#ddd\"\n                    style={{ flex: 1, backgroundColor: '#fff', borderRadius: 6, paddingHorizontal: 10, paddingVertical: 6, fontSize: 15, marginRight: 8 }}\n                    multiline\n                    maxLength={120}\n                  />\n                  <TouchableOpacity\n                    onPress={() => {\n                      setPhotoModal({ ...photoModal, visible: false });\n                      Alert.alert('Kommentar sparad');\n                    }}\n                    style={{ backgroundColor: '#1976D2', borderRadius: 24, padding: 10, marginRight: 8, elevation: 3, shadowColor: '#000', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.18, shadowRadius: 4, alignItems: 'center', justifyContent: 'center' }}\n                    accessibilityLabel=\"Spara kommentar\"\n                  >\n                    <MaterialIcons name=\"save\" size={28} color=\"#fff\" />\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    onPress={handleDeletePhoto}\n                    style={{ backgroundColor: '#e53935', borderRadius: 24, padding: 10, elevation: 3, shadowColor: '#000', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.18, shadowRadius: 4 }}\n                    accessibilityLabel=\"Ta bort foto\"\n                  >\n                    <MaterialIcons name=\"delete-forever\" size={28} color=\"#fff\" style={{}} />\n                  </TouchableOpacity>\n                </View>\n                {/* Action buttons row (tight layout) */}\n                <View style={{ flexDirection: 'row', justifyContent: 'center', alignItems: 'center', width: 320, marginBottom: 8 }}>\n                  <TouchableOpacity\n                    onPress={() => {\n                      setPhotoModal({ ...photoModal, visible: false });\n                      setTimeout(() => handleNavigateToCamera(), 300);\n                    }}\n                    style={{ backgroundColor: '#1976D2', borderRadius: 6, paddingVertical: 8, paddingHorizontal: 12, marginHorizontal: 4 }}\n                  >\n                    <Text style={{ color: '#fff', fontWeight: 'bold', fontSize: 15 }}>Ta nytt foto</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            )}\n          </View>\n        </KeyboardAvoidingView>\n      </Modal>\n      <ScrollView\n        ref={scrollRef}\n        style={[\n          { flex: 1, backgroundColor: '#fff' },\n          Platform.OS === 'web' ? { height: windowHeight || undefined, minHeight: 0 } : null,\n        ]}\n        keyboardShouldPersistTaps=\"handled\"\n      >\n        <View style={{ flex: 1 }}>\n                {/* Förklaring av statusknappar för riskbedömning (legend row removed from top, now only in checklist section header) */}\n        {/* Project Info and meta */}\n        <View style={{ padding: 16, paddingBottom: 0 }}>\n        {/* Company logo header (always shown) */}\n        <View style={{ marginBottom: 8 }}>\n          <CompanyHeaderLogo />\n        </View>\n        <View style={{ height: 2, backgroundColor: '#e0e0e0', width: '100%', marginBottom: hideProjectHeader ? 10 : 6 }} />\n        {/* Project number and name (toggled via meta-fältet \"Projekt\") */}\n        {project && !hideProjectHeader && (\n          <Text style={{ fontSize: 20, color: '#222', fontWeight: 'bold', marginBottom: 10, letterSpacing: 0.2 }}>\n            {project.id ? project.id : ''}{project.id && project.name ? ' – ' : ''}{project.name ? project.name : ''}\n          </Text>\n        )}\n        {/* Date row - long press to edit */}\n        {/* Date row with icon, text, and edit button */}\n        {/* Created date row - show as 'Skapad' (date only) */}\n        <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 6, justifyContent: 'space-between' }}>\n          <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n            <Ionicons name=\"calendar-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n            <View>\n              <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>{`Skapad: ${(() => {\n                // Prefer the local `dateValue` (may be defaulted to today) so new forms show today's date\n                const src = (dateValue && dateValue !== '') ? dateValue : (initialValues && initialValues.date ? initialValues.date : '');\n                if (!src) return '-';\n                const d = new Date(src);\n                if (isNaN(d)) return src;\n                return d.toISOString().slice(0, 10);\n              })()}`}</Text>\n              {(() => {\n                const status = initialValues && initialValues.status ? initialValues.status : null;\n                const savedAt = initialValues && initialValues.savedAt ? initialValues.savedAt : null;\n                if (!status || !savedAt) return null;\n                const label = status === 'UTFÖRD' ? 'Slutförd' : (status === 'UTKAST' ? 'Sparad' : null);\n                if (!label) return null;\n                const d = new Date(savedAt);\n                const dateOnly = isNaN(d) ? savedAt : d.toISOString().slice(0, 10);\n                return <Text style={{ fontSize: 13, color: '#666', marginTop: 4 }}>{`${label}: ${dateOnly}`}</Text>;\n              })()}\n            </View>\n          </View>\n          <TouchableOpacity\n            onPress={() => {\n              setTempDate(dateValue ? new Date(dateValue).toISOString().slice(0, 10) : new Date().toISOString().slice(0, 10));\n              setShowDateModal(true);\n            }}\n            style={{ marginLeft: 12, padding: 4 }}\n            activeOpacity={0.7}\n            accessibilityLabel=\"Ändra datum\"\n          >\n            <Ionicons name=\"create-outline\" size={22} color=\"#1976D2\" />\n          </TouchableOpacity>\n        </View>\n        {/* Soft horizontal divider under date */}\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\n        {/* Date edit modal */}\n        <Modal\n          visible={showDateModal}\n          transparent\n          animationType=\"fade\"\n          onRequestClose={() => setShowDateModal(false)}\n        >\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', padding: 16 }}>\n            <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 24, width: 280, maxWidth: '90%', alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n              {/* Close (X) icon in top right */}\n              <TouchableOpacity\n                onPress={() => setShowDateModal(false)}\n                style={{ position: 'absolute', top: 10, right: 10, zIndex: 10, padding: 4 }}\n                accessibilityLabel=\"Stäng\"\n                hitSlop={{ top: 16, bottom: 16, left: 16, right: 16 }}\n              >\n                <Ionicons name=\"close\" size={24} color=\"#888\" />\n              </TouchableOpacity>\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Ändra datum</Text>\n              <TextInput\n                value={tempDate}\n                onChangeText={text => {\n                  // Only allow numbers and hyphens, auto-insert hyphens for yyyy-mm-dd\n                  let cleaned = text.replace(/[^0-9]/g, '');\n                  if (cleaned.length > 8) cleaned = cleaned.slice(0, 8);\n                  let formatted = cleaned;\n                  if (cleaned.length > 4) formatted = cleaned.slice(0, 4) + '-' + cleaned.slice(4);\n                  if (cleaned.length > 6) formatted = formatted.slice(0, 7) + '-' + formatted.slice(7);\n                  setTempDate(formatted);\n                }}\n                style={{\n                  borderWidth: 1,\n                  borderColor: '#bbb',\n                  borderRadius: 8,\n                  padding: 8,\n                  fontSize: 16,\n                  color: '#222',\n                  backgroundColor: '#fafafa',\n                  width: 160,\n                  marginBottom: 8\n                }}\n                placeholder=\"ÅÅÅÅ-MM-DD\"\n                keyboardType=\"numeric\"\n                autoCapitalize=\"none\"\n                autoCorrect={false}\n                maxLength={10}\n              />\n              {/* Red warning if date is in the future */}\n              {(() => {\n                if (tempDate.length === 10) {\n                  const today = new Date();\n                  const inputDate = new Date(tempDate);\n                  if (!isNaN(inputDate) && inputDate > today) {\n                    return <Text style={{ color: '#D32F2F', marginBottom: 8, fontSize: 13 }}>Du kan inte välja ett framtida datum.</Text>;\n                  }\n                }\n                return null;\n              })()}\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\n                <TouchableOpacity\n                  style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\n                  onPress={() => {\n                    setDateValue(tempDate);\n                    setShowDateModal(false);\n                  }}\n                  disabled={(() => {\n                    if (tempDate.length === 10) {\n                      const today = new Date();\n                      const inputDate = new Date(tempDate);\n                      return isNaN(inputDate) || inputDate > today;\n                    }\n                    return true;\n                  })()}\n                >\n                  <Text style={{ color: '#1976D2', fontWeight: '400', fontSize: 16, opacity: (() => {\n                    if (tempDate.length === 10) {\n                      const today = new Date();\n                      const inputDate = new Date(tempDate);\n                      return (!isNaN(inputDate) && inputDate <= today) ? 1 : 0.4;\n                    }\n                    return 0.4;\n                  })() }}>Spara</Text>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\n                  onPress={() => setShowDateModal(false)}\n                >\n                  <Text style={{ color: '#D32F2F', fontWeight: '400', fontSize: 16 }}>Avbryt</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        </Modal>\n        {/* Participants (own row) and Weather (separate row below) */}\n        <View style={{ flexDirection: 'column', marginBottom: 2 }}>\n          <View style={{ flexDirection: 'row', alignItems: 'flex-start', justifyContent: 'space-between' }}>\n            <View style={{ flexDirection: 'row', alignItems: 'flex-start', flex: 1 }}>\n              <Ionicons name=\"person-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10, marginTop: 2 }} />\n              <View style={{ flex: 1 }}>\n                <Text style={{ fontSize: 18, color: (missingFields && (missingFields.includes(participantsLabel) || missingFields.includes('Deltagare'))) ? '#D32F2F' : '#222', fontWeight: '600', marginBottom: 6, marginTop: 4 }}>{participantsLabel}</Text>\n                <View style={{ paddingVertical: 6 }}>\n                  {(Array.isArray(localParticipants) ? localParticipants : []).map((p, idx) => {\n                    const name = (typeof p === 'string') ? p : (p && p.name) ? p.name : `${participantsLabel} ${idx+1}`;\n                    const key = (typeof p === 'object' && p && p.id) ? `participant-${p.id}` : `participant-${idx}-${name}`;\n                    return (\n                      <View key={key} style={{ backgroundColor: '#f5f5f5', borderRadius: 16, paddingVertical: 8, paddingHorizontal: 12, marginBottom: 8, flexDirection: 'row', alignItems: 'center' }}>\n                        <Text style={{ fontSize: 14, color: '#222', marginRight: 8 }}>{name}</Text>\n                        <TouchableOpacity onPress={() => { setParticipantName(typeof p === 'string' ? p : (p.name || '')); setParticipantCompany(typeof p === 'object' && p ? (p.company || '') : ''); setParticipantRole(typeof p === 'object' && p ? (p.role || '') : ''); setParticipantPhone(typeof p === 'object' && p ? (p.phone || '') : ''); setEditParticipantIndex(idx); setShowAddParticipantModal(true); }} style={{ marginRight: 6 }}>\n                          <Ionicons name=\"create-outline\" size={18} color=\"#1976D2\" />\n                        </TouchableOpacity>\n                        <TouchableOpacity onPress={() => { const nameToDelete = name; setLocalParticipants(prev => (Array.isArray(prev) ? prev.filter((_, i) => i !== idx) : [])); setMottagningsSignatures(prev => (Array.isArray(prev) ? prev.filter(s => s.name !== nameToDelete) : [])); }}>\n                          <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\n                        </TouchableOpacity>\n                      </View>\n                    );\n                  })}\n                </View>\n              </View>\n            </View>\n            <TouchableOpacity onPress={() => { setParticipantName(''); setParticipantCompany(''); setParticipantRole(''); setParticipantPhone(''); setEditParticipantIndex(null); setShowAddParticipantModal(true); }} style={{ padding: 4, marginLeft: 8 }} accessibilityLabel={addParticipantsLabel}>\n              <Ionicons name=\"add-circle-outline\" size={26} color=\"#1976D2\" />\n            </TouchableOpacity>\n          </View>\n\n          {/* Divider between participants and weather/byggdel */}\n          {(!hideWeather || controlType === 'Egenkontroll') && (\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 8 }} />\n          )}\n\n          {/* Weather row (separate) */}\n          {!hideWeather && (\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 8, justifyContent: 'space-between' }}>\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                {/* Fixed weather icon on the left, same blue as other icons */}\n                <Ionicons name=\"partly-sunny\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Väderlek</Text>\n                  {!selectedWeather && (\n                    <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\n                  )}\n                  {selectedWeather && (\n                    <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10 }}>\n                      <Ionicons\n                        name={(() => {\n                          const defaultWeatherOptions = [\n                            { key: 'Soligt', icon: 'sunny' },\n                            { key: 'Delvis molnigt', icon: 'partly-sunny' },\n                            { key: 'Molnigt', icon: 'cloudy' },\n                            { key: 'Regn', icon: 'rainy' },\n                            { key: 'Snö', icon: 'snow' },\n                            { key: 'Åska', icon: 'thunderstorm' },\n                          ];\n                          const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\n                            ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\n                            : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\n                          const meta = localWeather.find(w => (w.key || w) === selectedWeather);\n                          return (meta && meta.icon) ? meta.icon : 'sunny';\n                        })()}\n                        size={14}\n                        color={(() => {\n                          const cmap = { sunny: '#FFD54F', 'partly-sunny': '#FFB74D', cloudy: '#90A4AE', rainy: '#4FC3F7', snow: '#90CAF9', thunderstorm: '#9575CD' };\n                          const defaultWeatherOptions = [\n                            { key: 'Soligt', icon: 'sunny' },\n                            { key: 'Delvis molnigt', icon: 'partly-sunny' },\n                            { key: 'Molnigt', icon: 'cloudy' },\n                            { key: 'Regn', icon: 'rainy' },\n                            { key: 'Snö', icon: 'snow' },\n                            { key: 'Åska', icon: 'thunderstorm' },\n                          ];\n                          const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\n                            ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\n                            : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\n                          const meta = localWeather.find(w => (w.key || w) === selectedWeather);\n                          const icon = meta && meta.icon ? meta.icon : 'sunny';\n                          return cmap[icon] || '#1976D2';\n                        })()}\n                        style={{ marginRight: 6 }}\n                      />\n                      <Text style={{ color: '#222', marginRight: 8 }}>{selectedWeather}</Text>\n                      <TouchableOpacity onPress={() => setSelectedWeather(null)}>\n                        <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\n                      </TouchableOpacity>\n                    </View>\n                  )}\n                </View>\n              </View>\n              <TouchableOpacity onPress={() => setShowWeatherModal(true)} style={{ padding: 4, marginLeft: 8 }} accessibilityLabel=\"Lägg till väder\">\n                <Ionicons name=\"add-circle-outline\" size={26} color=\"#1976D2\" />\n              </TouchableOpacity>\n            </View>\n          )}\n\n          {/* Byggdel row (Egenkontroll, where weather usually is) */}\n          {hideWeather && controlType === 'Egenkontroll' && (\n            <View style={{ flexDirection: 'column', marginTop: 8 }}>\n              <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                <Ionicons name=\"cube-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Byggdel</Text>\n                  {!((byggdelTemplate && (byggdelTemplate.huvudgrupp || byggdelTemplate.moment)) || byggdel) && (\n                    <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\n                  )}\n                  {!!((byggdelTemplate && (byggdelTemplate.huvudgrupp || byggdelTemplate.moment)) || byggdel) && (\n                    <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10, flexShrink: 1, minWidth: 0 }}>\n                      <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\n                        {(() => {\n                          const tpl = byggdelTemplate || null;\n                          const lbl = tpl ? formatByggdelMomentLabelFromTemplate(tpl) : '';\n                          return lbl || byggdel;\n                        })()}\n                      </Text>\n                      <TouchableOpacity\n                        onPress={() => {\n                          const tpl = byggdelTemplate || null;\n                          const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\n                          const clearOnlySelection = () => {\n                            setByggdel('');\n                            setByggdelTemplate(null);\n                          };\n                          const clearSelectionAndChecklist = () => {\n                            setByggdel('');\n                            setByggdelTemplate(null);\n                            setChecklist([]);\n                            setExpandedChecklist([]);\n                            try {\n                              if (controlType === 'Arbetsberedning') {\n                                const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\n                                if (cfg.length > 0) setSelectedCategories(cfg.map(() => false));\n                              }\n                            } catch(e) {}\n                          };\n\n                          if (hadMall && hasAnyChecklistPoints(checklistRef.current)) {\n                            Alert.alert(\n                              'Ta bort mall?'\n                              ,\n                              'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\n                              ,\n                              [\n                                { text: 'Avbryt', style: 'cancel' },\n                                { text: 'Behåll punkter', onPress: clearOnlySelection },\n                                { text: 'Rensa punkter', style: 'destructive', onPress: clearSelectionAndChecklist },\n                              ]\n                            );\n                            return;\n                          }\n\n                          if (hadMall) {\n                            clearSelectionAndChecklist();\n                            return;\n                          }\n\n                          clearOnlySelection();\n                        }}\n                        accessibilityLabel=\"Rensa byggdel\"\n                      >\n                        <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\n                      </TouchableOpacity>\n                    </View>\n                  )}\n                </View>\n              </View>\n              <TouchableOpacity\n                onPress={() => {\n                  const tpl = byggdelTemplate || null;\n                  const hg = String(tpl?.huvudgrupp || '').trim();\n                  const mm = String(tpl?.moment || '').trim();\n                  setByggdelHuvudgruppDraft(hg);\n                  setByggdelMomentDraft(mm);\n                  setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\n                  setByggdelExpandedHuvudgrupp(hg);\n                  setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\n                  setNewByggdelMallName('');\n                  setShowCreateByggdelMoment(false);\n                  setNewByggdelMomentName('');\n                  setShowCreateByggdelMallModal(false);\n                  setCreateByggdelMallContext(null);\n                  setShowKontrollplanRolldown(true);\n                  refreshByggdelHierarchy();\n                  refreshByggdelMallar();\n                  setShowByggdelModal(true);\n                }}\n                style={{ padding: 4, marginLeft: 8 }}\n                accessibilityLabel=\"Ange byggdel\"\n              >\n                <Ionicons name={byggdel ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\n              </TouchableOpacity>\n              </View>\n\n              {/* Divider between byggdel and kontrollplan */}\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\n\n              {/* Kontrollplan row (Egenkontroll) */}\n              <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 10, justifyContent: 'space-between' }}>\n                <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                  <Ionicons name=\"clipboard-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n                  <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8 }}>\n                    <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Kontrollplan</Text>\n                    {!String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() && (\n                      <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\n                    )}\n                    {!!String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() && (\n                      <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, marginLeft: 10, flexShrink: 1, minWidth: 0 }}>\n                        <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\n                          {String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim()}\n                        </Text>\n                        <TouchableOpacity\n                          onPress={() => {\n                            const tpl = byggdelTemplate || null;\n                            const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\n                            if (!hadMall) return;\n\n                            const clearOnlyPlan = () => {\n                              const nextTpl = { huvudgrupp: tpl.huvudgrupp, moment: tpl.moment };\n                              setByggdelTemplate(nextTpl);\n                              setByggdel(formatByggdelMomentLabelFromTemplate(nextTpl));\n                            };\n                            const clearPlanAndChecklist = () => {\n                              const nextTpl = { huvudgrupp: tpl.huvudgrupp, moment: tpl.moment };\n                              setByggdelTemplate(nextTpl);\n                              setByggdel(formatByggdelMomentLabelFromTemplate(nextTpl));\n                              setChecklist([]);\n                              setExpandedChecklist([]);\n                            };\n\n                            if (hasAnyChecklistPoints(checklistRef.current)) {\n                              Alert.alert(\n                                'Ta bort mall?'\n                                ,\n                                'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\n                                ,\n                                [\n                                  { text: 'Avbryt', style: 'cancel' },\n                                  { text: 'Behåll punkter', onPress: clearOnlyPlan },\n                                  { text: 'Rensa punkter', style: 'destructive', onPress: clearPlanAndChecklist },\n                                ]\n                              );\n                              return;\n                            }\n\n                            clearOnlyPlan();\n                          }}\n                          accessibilityLabel=\"Rensa kontrollplan\"\n                        >\n                          <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\n                        </TouchableOpacity>\n                      </View>\n                    )}\n                  </View>\n                </View>\n\n                <TouchableOpacity\n                  onPress={() => {\n                    const tpl = byggdelTemplate || null;\n                    const hg = String(tpl?.huvudgrupp || '').trim();\n                    const mm = String(tpl?.moment || '').trim();\n                    setByggdelHuvudgruppDraft(hg);\n                    setByggdelMomentDraft(mm);\n                    setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\n                    setByggdelExpandedHuvudgrupp(hg);\n                    setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\n                    setNewByggdelMallName('');\n                    setShowCreateByggdelMoment(false);\n                    setNewByggdelMomentName('');\n                    setShowCreateByggdelMallModal(false);\n                    setCreateByggdelMallContext(null);\n                    setShowKontrollplanRolldown(true);\n                    refreshByggdelHierarchy();\n                    refreshByggdelMallar();\n                    setShowByggdelModal(true);\n                  }}\n                  style={{ padding: 4, marginLeft: 8 }}\n                  accessibilityLabel=\"Ange kontrollplan\"\n                >\n                  <Ionicons name={String((byggdelTemplate && (byggdelTemplate.mallName || byggdelTemplate.name)) || '').trim() ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\n                </TouchableOpacity>\n              </View>\n            </View>\n          )}\n\n          {/* Soft horizontal divider between weather and byggdel (same as date -> participants) */}\n          {controlType === 'Arbetsberedning' && !hideWeather && (\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\n          )}\n\n          {/* Byggdel row (Arbetsberedning only) */}\n          {controlType === 'Arbetsberedning' && (\n            <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: hideWeather ? 12 : 2, justifyContent: 'space-between' }}>\n              <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: 0 }}>\n                <Ionicons name=\"cube-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 10, flexShrink: 0 }}>\n                  <Text style={{ fontSize: 18, color: '#222', fontWeight: '600' }}>Byggdel</Text>\n                  <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\n                </View>\n\n                {!!byggdel && (\n                  <View style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: '#f5f5f5', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 10, flexShrink: 1, minWidth: 0 }}>\n                    <Text style={{ color: '#222', marginRight: 8, flexShrink: 1 }} numberOfLines={1}>\n                      {byggdel}\n                    </Text>\n                    <TouchableOpacity\n                      onPress={() => {\n                        const tpl = byggdelTemplate || null;\n                        const hadMall = !!(tpl && (tpl.mallId || tpl.mallName || tpl.name));\n                        const clearOnlySelection = () => {\n                          setByggdel('');\n                          setByggdelTemplate(null);\n                        };\n                        const clearSelectionAndChecklist = () => {\n                          setByggdel('');\n                          setByggdelTemplate(null);\n                          setChecklist([]);\n                          setExpandedChecklist([]);\n                          try {\n                            if (controlType === 'Arbetsberedning') {\n                              const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\n                              if (cfg.length > 0) setSelectedCategories(cfg.map(() => false));\n                            }\n                          } catch(e) {}\n                        };\n\n                        if (hadMall && hasAnyChecklistPoints(checklistRef.current)) {\n                          Alert.alert(\n                            'Ta bort mall?'\n                            ,\n                            'Du har valt en mall. Vill du behålla kontrollpunkterna eller rensa dem?'\n                            ,\n                            [\n                              { text: 'Avbryt', style: 'cancel' },\n                              { text: 'Behåll punkter', onPress: clearOnlySelection },\n                              { text: 'Rensa punkter', style: 'destructive', onPress: clearSelectionAndChecklist },\n                            ]\n                          );\n                          return;\n                        }\n\n                        if (hadMall) {\n                          clearSelectionAndChecklist();\n                          return;\n                        }\n\n                        clearOnlySelection();\n                      }}\n                      accessibilityLabel=\"Rensa byggdel\"\n                    >\n                      <Ionicons name=\"close-circle\" size={18} color=\"#D32F2F\" />\n                    </TouchableOpacity>\n                  </View>\n                )}\n              </View>\n              <TouchableOpacity\n                onPress={() => {\n                  const tpl = byggdelTemplate || null;\n                  const hg = String(tpl?.huvudgrupp || '').trim();\n                  const mm = String(tpl?.moment || '').trim();\n                  setByggdelHuvudgruppDraft(hg);\n                  setByggdelMomentDraft(mm);\n                  setByggdelMallDraft(tpl && (tpl.mallId || tpl.mallName || tpl.name) ? { id: tpl.mallId || null, name: tpl.mallName || tpl.name || '' } : null);\n                  setByggdelExpandedHuvudgrupp(hg);\n                  setByggdelExpandedMomentKey(hg && mm ? `${String(hg || '').split('-')[0].trim()}||${mm}` : '');\n                  setNewByggdelMallName('');\n                  setShowCreateByggdelMoment(false);\n                  setNewByggdelMomentName('');\n                  setShowCreateByggdelMallModal(false);\n                  setCreateByggdelMallContext(null);\n                  refreshByggdelHierarchy();\n                  refreshByggdelMallar();\n                  setShowByggdelModal(true);\n                }}\n                style={{ padding: 4, marginLeft: 8 }}\n                accessibilityLabel=\"Ange byggdel\"\n              >\n                <Ionicons name={byggdel ? 'create-outline' : 'add-circle-outline'} size={26} color=\"#1976D2\" />\n              </TouchableOpacity>\n            </View>\n          )}\n        </View>\n        {/* Horizontal divider between participants and material description */}\n        <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 10, marginBottom: 10 }} />\n        {/* Weather selection modal triggered from participants area */}\n        <Modal visible={showWeatherModal} transparent animationType=\"fade\" onRequestClose={() => setShowWeatherModal(false)}>\n          <TouchableOpacity activeOpacity={1} onPress={() => setShowWeatherModal(false)} style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n            <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\n              <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Välj väder</Text>\n              </View>\n              <View style={{ padding: 16, flexDirection: 'row', flexWrap: 'wrap' }}>\n                {(() => {\n                  const defaultWeatherOptions = [\n                    { key: 'Soligt', icon: 'sunny' },\n                    { key: 'Delvis molnigt', icon: 'partly-sunny' },\n                    { key: 'Molnigt', icon: 'cloudy' },\n                    { key: 'Regn', icon: 'rainy' },\n                    { key: 'Snö', icon: 'snow' },\n                    { key: 'Åska', icon: 'thunderstorm' },\n                  ];\n                  const localWeather = (Array.isArray(weatherOptions) && weatherOptions.length > 0)\n                    ? weatherOptions.map(w => (typeof w === 'string' ? { key: w, icon: null } : w))\n                    : (controlType === 'Mottagningskontroll' ? defaultWeatherOptions : []);\n                  return localWeather.map(w => {\n                    const label = w.key || w;\n                    const iconName = w.icon || null;\n                    const isSelected = selectedWeather === label;\n                    return (\n                        <TouchableOpacity key={`wm-${label}`} onPress={() => { setSelectedWeather(label); setShowWeatherModal(false); }} style={{ width: '48%', padding: 12, margin: '1%', backgroundColor: isSelected ? '#E8F0FF' : '#fff', borderRadius: 8, borderWidth: 1, borderColor: isSelected ? '#1976D2' : '#e0e0e0', alignItems: 'center' }}>\n                          {iconName ? <Ionicons name={iconName} size={22} color={(() => { const cmap = { sunny: '#FFD54F', 'partly-sunny': '#FFB74D', cloudy: '#90A4AE', rainy: '#4FC3F7', snow: '#90CAF9', thunderstorm: '#9575CD' }; return isSelected ? '#1976D2' : (iconName && cmap[iconName] ? cmap[iconName] : '#444'); })()} style={{ marginBottom: 6 }} /> : null}\n                          <Text style={{ color: isSelected ? '#1976D2' : '#444' }}>{label}</Text>\n                        </TouchableOpacity>\n                      );\n                  });\n                })()}\n              </View>\n              <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', alignItems: 'center' }}>\n                <TouchableOpacity onPress={() => setShowWeatherModal(false)} style={{ paddingVertical: 10 }}>\n                  <Text style={{ color: '#1976D2' }}>Stäng</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </TouchableOpacity>\n        </Modal>\n\n        {/* Byggdel modal (Arbetsberedning + Egenkontroll) */}\n        {(controlType === 'Arbetsberedning' || controlType === 'Egenkontroll') && (\n          <Modal visible={showByggdelModal} transparent animationType=\"fade\" onRequestClose={closeByggdelModal}>\n            <View style={{ pointerEvents: 'box-none', flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n              <Pressable onPress={closeByggdelModal} style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0 }} />\n              <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\n                <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                  <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Byggdel</Text>\n                </View>\n                <View style={{ padding: 16 }}>\n                  {byggdelHierarchyLoading ? (\n                    <Text style={{ color: '#444' }}>Laddar moment…</Text>\n                  ) : null}\n\n                  {byggdelMallarLoading ? (\n                    <Text style={{ color: '#444' }}>Laddar mallar…</Text>\n                  ) : null}\n\n                  {controlType === 'Arbetsberedning' ? (\n                    <TouchableOpacity\n                      onPress={() => {\n                        const current = (Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : []);\n                        setAktivaByggdelarDraftKeys(current);\n                        setAktivaByggdelarExpandedPrefix('');\n                        setShowAktivaByggdelarModal(true);\n                      }}\n                      style={{\n                        paddingVertical: 10,\n                        paddingHorizontal: 12,\n                        borderRadius: 10,\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        backgroundColor: '#fff',\n                        alignSelf: 'flex-start',\n                        marginBottom: 10,\n                      }}\n                      accessibilityRole=\"button\"\n                      accessibilityLabel=\"Aktiva byggdelar\"\n                    >\n                      <Text style={{ color: '#1976D2', fontWeight: '700' }}>Aktiva byggdelar</Text>\n                    </TouchableOpacity>\n                  ) : null}\n\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 10 }}>Välj byggdel och moment.</Text>\n\n                  {controlType === 'Arbetsberedning' && (!Array.isArray(aktivaByggdelarSelectedKeys) || aktivaByggdelarSelectedKeys.length === 0) ? (\n                    <Text style={{ fontSize: 13, color: '#666', marginBottom: 10 }}>\n                      Inga byggdelar är aktiva ännu. Tryck på “Aktiva byggdelar” och välj vilka moment som är aktuella i projektet.\n                    </Text>\n                  ) : null}\n\n                  {/* Step 1: Huvudgrupp */}\n                  {controlType === 'Egenkontroll' && (\n                    <TouchableOpacity\n                      onPress={() => {\n                        LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                        setShowByggdelHuvudgruppRolldown(prev => !prev);\n                      }}\n                      style={{\n                        paddingVertical: 10,\n                        paddingHorizontal: 12,\n                        borderRadius: 10,\n                        borderWidth: 1,\n                        borderColor: '#e0e0e0',\n                        backgroundColor: '#fff',\n                        flexDirection: 'row',\n                        alignItems: 'center',\n                        justifyContent: 'space-between',\n                        marginBottom: 8,\n                      }}\n                      accessibilityLabel=\"Byggdel\"\n                    >\n                      <View style={{ flexDirection: 'row', alignItems: 'baseline', flex: 1, minWidth: 0 }}>\n                        <Text style={{ fontSize: 14, color: '#222', fontWeight: '700' }}>Byggdel</Text>\n                        <Text style={{ fontSize: 12, color: '#666', marginLeft: 8, flexShrink: 1 }} numberOfLines={1}>\n                          {byggdelHuvudgruppDraft ? byggdelHuvudgruppDraft : 'Välj'}\n                        </Text>\n                      </View>\n                      <Ionicons name={showByggdelHuvudgruppRolldown ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\n                    </TouchableOpacity>\n                  )}\n\n                  {(controlType !== 'Egenkontroll' || showByggdelHuvudgruppRolldown) && (\n                    <View style={{ flexDirection: 'column' }}>\n                      {(() => {\n                        const options = Array.isArray(byggdelHuvudgruppOptions) ? byggdelHuvudgruppOptions : [];\n                        if (controlType !== 'Arbetsberedning') return options;\n                        const selected = Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : [];\n                        if (!selected || selected.length === 0) return [];\n                        const selectedPrefixes = new Set(selected\n                          .map(k => String(k || '').split('||')[0].trim())\n                          .filter(Boolean));\n                        return options.filter(hg => selectedPrefixes.has(String(hg || '').split('-')[0].trim()));\n                      })().map(hg => {\n                      const isSelected = String(byggdelHuvudgruppDraft || '') === hg;\n                      const isExpanded = String(byggdelExpandedHuvudgrupp || '') === hg;\n                      const hgKeyPrefix = String(hg || '').split('-')[0].trim();\n                      const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[hgKeyPrefix])) || [];\n                      let moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\n                      if (controlType === 'Arbetsberedning') {\n                        const selected = Array.isArray(aktivaByggdelarSelectedKeys) ? aktivaByggdelarSelectedKeys : [];\n                        if (!selected || selected.length === 0) {\n                          moments = [];\n                        } else {\n                          const activeSet = new Set(selected\n                            .filter(k => String(k || '').startsWith(`${hgKeyPrefix}||`))\n                            .map(k => String(k || '').split('||')[1])\n                            .map(x => String(x || '').trim())\n                            .filter(Boolean));\n                          moments = moments.filter(mm => activeSet.has(String(mm || '').trim()));\n                        }\n                      }\n                      return (\n                        <View key={`hg-${hg}`} style={{ marginBottom: 8 }}>\n                          <TouchableOpacity\n                            onPress={() => {\n                              LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n\n                              // Toggle expansion\n                              const nextExpanded = isExpanded ? '' : hg;\n                              setByggdelExpandedHuvudgrupp(nextExpanded);\n\n                              // Selecting a huvudgrupp resets moment (unless staying on same group)\n                              if (!isSelected) {\n                                setByggdelHuvudgruppDraft(hg);\n                                setByggdelMomentDraft('');\n                                setByggdelMallDraft(null);\n                                setByggdelExpandedMomentKey('');\n                                setShowCreateByggdelMallModal(false);\n                                setCreateByggdelMallContext(null);\n                                setNewByggdelMallName('');\n                              }\n                              setShowCreateByggdelMoment(false);\n                              setNewByggdelMomentName('');\n                            }}\n                            style={{\n                              paddingVertical: 10,\n                              paddingHorizontal: 12,\n                              borderRadius: 10,\n                              borderWidth: 1,\n                              borderColor: isExpanded ? '#1976D2' : '#e0e0e0',\n                              backgroundColor: isExpanded ? '#E8F0FF' : '#fff',\n                              flexDirection: 'row',\n                              alignItems: 'center',\n                              justifyContent: 'space-between',\n                            }}\n                          >\n                            <Text style={{ color: isExpanded ? '#1976D2' : '#444', fontWeight: isExpanded ? '700' : '500', flex: 1 }} numberOfLines={2}>\n                              {hg}\n                            </Text>\n                            <Ionicons name={isExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={isExpanded ? '#1976D2' : '#666'} style={{ marginLeft: 8 }} />\n                          </TouchableOpacity>\n\n                          {isExpanded ? (\n                            <View style={{ marginTop: 4, paddingLeft: 12, paddingRight: 12, paddingBottom: 2 }}>\n\n                              {moments.length === 0 ? (\n                                <Text style={{ color: '#666' }}>Inga moment finns ännu för denna byggdel.</Text>\n                              ) : (\n                                <View style={{ flexDirection: 'column' }}>\n                                  {moments.map((mm) => {\n                                    const momentKey = `${hgKeyPrefix}||${String(mm || '')}`;\n                                    const isMomentExpanded = String(byggdelExpandedMomentKey || '') === momentKey;\n                                    const mallarForMoment = (Array.isArray(byggdelMallar) ? byggdelMallar : []).filter(m => {\n                                      const mg = String(m && (m.huvudgrupp ?? '')).trim();\n                                      const mom = String(m && (m.moment ?? '')).trim();\n                                      return mg === hgKeyPrefix && mom === String(mm || '').trim();\n                                    });\n                                    return (\n                                      <View key={`mm-${hg}-${mm}`} style={{ marginBottom: 6 }}>\n                                        <TouchableOpacity\n                                          onPress={() => {\n                                            LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                                            setByggdelMomentDraft(String(mm || ''));\n                                            setByggdelMallDraft(null);\n                                            setNewByggdelMallName('');\n                                            setByggdelExpandedMomentKey(isMomentExpanded ? '' : momentKey);\n                                          }}\n                                          style={{\n                                            paddingVertical: 10,\n                                            paddingHorizontal: 12,\n                                            borderRadius: 10,\n                                            borderWidth: 1,\n                                            borderColor: isMomentExpanded ? '#1976D2' : '#e0e0e0',\n                                            backgroundColor: isMomentExpanded ? '#E8F0FF' : '#fff',\n                                            flexDirection: 'row',\n                                            alignItems: 'center',\n                                            justifyContent: 'space-between',\n                                          }}\n                                        >\n                                          <Text style={{ color: isMomentExpanded ? '#1976D2' : '#444', fontWeight: isMomentExpanded ? '700' : '500', flex: 1 }} numberOfLines={2}>\n                                            {String(mm || '')}\n                                          </Text>\n                                          <Ionicons name={isMomentExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={isMomentExpanded ? '#1976D2' : '#666'} style={{ marginLeft: 8 }} />\n                                        </TouchableOpacity>\n\n                                        {isMomentExpanded ? (\n                                          <View style={{ marginTop: 4, paddingLeft: 12, paddingRight: 12, paddingBottom: 2 }}>\n                                            {controlType === 'Egenkontroll' && (\n                                              <TouchableOpacity\n                                                onPress={() => {\n                                                  LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                                                  setShowKontrollplanRolldown(prev => !prev);\n                                                }}\n                                                style={{\n                                                  paddingVertical: 10,\n                                                  paddingHorizontal: 12,\n                                                  borderRadius: 10,\n                                                  borderWidth: 1,\n                                                  borderColor: '#e0e0e0',\n                                                  backgroundColor: '#fff',\n                                                  flexDirection: 'row',\n                                                  alignItems: 'center',\n                                                  justifyContent: 'space-between',\n                                                  marginBottom: 8,\n                                                }}\n                                                accessibilityLabel=\"Kontrollplan\"\n                                              >\n                                                <View style={{ flexDirection: 'row', alignItems: 'baseline', flex: 1, minWidth: 0 }}>\n                                                  <Text style={{ fontSize: 14, color: '#222', fontWeight: '700' }}>Kontrollplan</Text>\n                                                  <Text style={{ fontSize: 12, color: '#666', marginLeft: 8, flexShrink: 1 }} numberOfLines={1}>\n                                                    {(() => {\n                                                      const tpl = byggdelTemplate || null;\n                                                      const tplHg = String(tpl?.huvudgrupp || '').trim();\n                                                      const tplMom = String(tpl?.moment || '').trim();\n                                                      const tplMall = String((tpl && (tpl.mallName || tpl.name)) || '').trim();\n                                                      const isForThis = tplHg === String(hgKeyPrefix || '').trim() && tplMom === String(mm || '').trim();\n                                                      return (isForThis && tplMall) ? tplMall : 'Välj';\n                                                    })()}\n                                                  </Text>\n                                                </View>\n                                                <Ionicons name={showKontrollplanRolldown ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\n                                              </TouchableOpacity>\n                                            )}\n\n                                            {(controlType !== 'Egenkontroll' || showKontrollplanRolldown) && (\n                                              <View>\n                                                {mallarForMoment.length === 0 ? (\n                                                  <Text style={{ color: '#666', marginBottom: 8 }}>Inga mallar skapade.</Text>\n                                                ) : (\n                                                  <View style={{ marginBottom: 8 }}>\n                                                    {mallarForMoment.map((m) => {\n                                                      const id = m && m.id ? String(m.id) : '';\n                                                      const name = String(m && (m.name || '')).trim();\n                                                      const isSelectedMall = !!(byggdelMallDraft && ((byggdelMallDraft.id && id && byggdelMallDraft.id === id) || (byggdelMallDraft.name && name && byggdelMallDraft.name === name)));\n                                                      return (\n                                                        <TouchableOpacity\n                                                          key={`mall-${momentKey}-${id || name}`}\n                                                          onPress={() => {\n                                                            if (suppressNextMallPressRef.current) return;\n                                                            setByggdelMallDraft({ id: id || null, name });\n                                                            openByggdelMallEditor(m);\n                                                          }}\n                                                          delayLongPress={2000}\n                                                          onLongPress={() => {\n                                                            if (!id && !name) return;\n                                                            suppressNextMallPressRef.current = true;\n                                                            setTimeout(() => { suppressNextMallPressRef.current = false; }, 350);\n\n                                                            Alert.alert(\n                                                              'Mall',\n                                                              name || '(namnlös mall)',\n                                                              [\n                                                                { text: 'Avbryt', style: 'cancel' },\n                                                                {\n                                                                  text: 'Ändra mall',\n                                                                  onPress: () => {\n                                                                    openByggdelMallEditor(m);\n                                                                  }\n                                                                },\n                                                                {\n                                                                  text: 'Radera',\n                                                                  style: 'destructive',\n                                                                  onPress: () => {\n                                                                    if (!id) {\n                                                                      Alert.alert('Kunde inte radera', 'Mallen saknar id.');\n                                                                      return;\n                                                                    }\n\n                                                                    Alert.alert(\n                                                                      'Radera mall?',\n                                                                      `Vill du radera \"${name || '(namnlös mall)'}\"?`,\n                                                                      [\n                                                                        { text: 'Avbryt', style: 'cancel' },\n                                                                        {\n                                                                          text: 'Radera',\n                                                                          style: 'destructive',\n                                                                          onPress: async () => {\n                                                                            try {\n                                                                              if (deletingByggdelMallId) return;\n                                                                              setDeletingByggdelMallId(id);\n                                                                              await deleteByggdelMall({ mallId: id });\n\n                                                                              setByggdelMallar(prev => (Array.isArray(prev) ? prev.filter(x => String(x && x.id ? x.id : '') !== id) : []));\n\n                                                                              // Clear current selection if it was this mall\n                                                                              if (byggdelMallDraft) {\n                                                                                const pid = byggdelMallDraft.id ? String(byggdelMallDraft.id) : '';\n                                                                                const pname = byggdelMallDraft.name ? String(byggdelMallDraft.name).trim() : '';\n                                                                                if ((pid && pid === id) || (!pid && pname && pname === name)) {\n                                                                                  setByggdelMallDraft(null);\n                                                                                }\n                                                                              }\n\n                                                                              // Clear saved template reference if it was this mall (avoid dangling mallId)\n                                                                              if (byggdelTemplate) {\n                                                                                const pmid = byggdelTemplate.mallId ? String(byggdelTemplate.mallId) : '';\n                                                                                const pmname = byggdelTemplate.mallName ? String(byggdelTemplate.mallName).trim() : '';\n                                                                                const isMatch = (pmid && pmid === id) || (!pmid && pmname && pmname === name);\n                                                                                if (isMatch) {\n                                                                                  const nextTpl = { huvudgrupp: byggdelTemplate.huvudgrupp, moment: byggdelTemplate.moment };\n                                                                                  setByggdelTemplate(nextTpl);\n                                                                                  setByggdel(formatByggdelLabelFromTemplate(nextTpl));\n                                                                                }\n                                                                              }\n\n                                                                              if (byggdelMallEditor && String(byggdelMallEditor.id || '') === id) {\n                                                                                setShowByggdelMallEditor(false);\n                                                                                setByggdelMallEditor(null);\n                                                                                setByggdelMallSectionsDraft([]);\n                                                                                setNewByggdelMallSectionTitle('');\n                                                                              }\n                                                                            } catch(e) {\n                                                                              const msg = (e && e.message) ? String(e.message) : '';\n                                                                              const code = e && e.code ? String(e.code) : '';\n                                                                              const isPermission = code === 'permission-denied' || (msg && msg.toLowerCase().includes('permission'));\n                                                                              if (isPermission) {\n                                                                                Alert.alert('Kunde inte radera', 'Du saknar behörighet att radera mallar i företaget.');\n                                                                              } else {\n                                                                                Alert.alert('Kunde inte radera', 'Försök igen.');\n                                                                              }\n                                                                            } finally {\n                                                                              setDeletingByggdelMallId('');\n                                                                            }\n                                                                          }\n                                                                        }\n                                                                      ]\n                                                                    );\n                                                                  }\n                                                                }\n                                                              ]\n                                                            );\n                                                          }}\n                                                          style={{\n                                                            paddingVertical: 10,\n                                                            paddingHorizontal: 12,\n                                                            borderRadius: 10,\n                                                            borderWidth: 1,\n                                                            borderColor: isSelectedMall ? '#1976D2' : '#e0e0e0',\n                                                            backgroundColor: isSelectedMall ? '#E8F0FF' : '#fff',\n                                                            marginBottom: 6,\n                                                            opacity: deletingByggdelMallId && deletingByggdelMallId === id ? 0.5 : 1,\n                                                          }}\n                                                        >\n                                                          <Text style={{ color: isSelectedMall ? '#1976D2' : '#444', fontWeight: isSelectedMall ? '700' : '500' }}>\n                                                            {name || '(namnlös mall)'}\n                                                          </Text>\n                                                        </TouchableOpacity>\n                                                      );\n                                                    })}\n                                                  </View>\n                                                )}\n\n                                                <TouchableOpacity\n                                                  onPress={() => {\n                                                    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                                                    setCreateByggdelMallContext({ huvudgrupp: hgKeyPrefix, moment: String(mm || '').trim(), momentKey });\n                                                    setNewByggdelMallName('');\n                                                    setShowCreateByggdelMallModal(true);\n                                                  }}\n                                                  style={{\n                                                    paddingVertical: 10,\n                                                    paddingHorizontal: 2,\n                                                    alignItems: 'flex-start',\n                                                  }}\n                                                  accessibilityRole=\"button\"\n                                                  accessibilityLabel=\"Skapa ny mall\"\n                                                >\n                                                  <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Skapa ny mall</Text>\n                                                </TouchableOpacity>\n                                              </View>\n                                            )}\n                                          </View>\n                                        ) : null}\n                                      </View>\n                                    );\n                                  })}\n                                </View>\n                              )}\n                            </View>\n                          ) : null}\n                        </View>\n                      );\n                      })}\n                    </View>\n                  )}\n\n                </View>\n\n                {/* Create mall overlay (inside Byggdel modal for iOS/Expo Go stability) */}\n                {showCreateByggdelMallModal ? (\n                  <View style={{ pointerEvents: 'box-none', position: 'absolute', top: 0, right: 0, bottom: 0, left: 0, backgroundColor: 'rgba(0,0,0,0.25)' }}>\n                    <View\n                      style={{\n                        flex: 1,\n                        justifyContent: 'flex-end',\n                        alignItems: 'center',\n                        paddingTop: 14,\n                        paddingHorizontal: 14,\n                        paddingBottom: createMallKeyboardHeight > 0 ? createMallKeyboardHeight : 14,\n                      }}\n                    >\n                      <View style={{ width: '100%', maxWidth: 380, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\n                        <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                          <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Skapa ny mall</Text>\n                          {!!(createByggdelMallContext && createByggdelMallContext.moment) ? (\n                            <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\n                              {String(createByggdelMallContext.moment || '').trim()}\n                            </Text>\n                          ) : null}\n                        </View>\n\n                        <View style={{ padding: 16 }}>\n                          <TextInput\n                            value={newByggdelMallName}\n                            onChangeText={setNewByggdelMallName}\n                            placeholder=\"Mallnamn\"\n                            placeholderTextColor=\"#888\"\n                            style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff' }}\n                          />\n                        </View>\n\n                        <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\n                          <TouchableOpacity onPress={closeCreateByggdelMallModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\n                            <Text style={{ color: '#777' }}>Avbryt</Text>\n                          </TouchableOpacity>\n                          <TouchableOpacity onPress={submitCreateByggdelMall} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\n                            <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMall ? 'Sparar…' : 'Spara'}</Text>\n                          </TouchableOpacity>\n                        </View>\n                      </View>\n                    </View>\n                  </View>\n                ) : null}\n\n                <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\n                  <TouchableOpacity onPress={closeByggdelModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\n                    <Text style={{ color: '#777' }}>Avbryt</Text>\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    onPress={() => {\n                      const hg = String(byggdelHuvudgruppDraft || '').trim();\n                      const mm = String(byggdelMomentDraft || '').trim();\n\n                      if (!hg) {\n                        setByggdelTemplate(null);\n                        setByggdel('');\n                        closeByggdelModal();\n                        return;\n                      }\n\n                      const hgKeyPrefix = String(hg || '').split('-')[0].trim();\n                      const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[hgKeyPrefix])) || [];\n                      const availableMoments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\n\n                      if (!mm && availableMoments.length > 0) {\n                        Alert.alert('Välj moment', 'Välj ett moment under vald byggdel innan du sparar.');\n                        return;\n                      }\n\n                      const mid = byggdelMallDraft && byggdelMallDraft.id ? String(byggdelMallDraft.id) : null;\n                      const mname = byggdelMallDraft && byggdelMallDraft.name ? String(byggdelMallDraft.name) : '';\n                      const tpl = mm\n                        ? (mid || mname ? { huvudgrupp: hg, moment: mm, mallId: mid, mallName: mname } : { huvudgrupp: hg, moment: mm })\n                        : { huvudgrupp: hg };\n\n                      const finishSave = () => {\n                        setByggdelTemplate(tpl);\n                        setByggdel(formatByggdelLabelFromTemplate(tpl));\n                        setShowCategoryModal(false);\n                        closeByggdelModal();\n                      };\n\n                      // If a mall is selected, apply its points as the Arbetsberedning checklist.\n                      if (controlType === 'Arbetsberedning' && (mid || mname)) {\n                        const mallList = Array.isArray(byggdelMallar) ? byggdelMallar : [];\n                        const selectedMall = (mid\n                          ? mallList.find(m => String(m && m.id ? m.id : '') === String(mid))\n                          : null) || mallList.find(m => {\n                          const nm = String(m && (m.name ?? '')).trim();\n                          const hg2 = String(m && (m.huvudgrupp ?? '')).trim();\n                          const mm2 = String(m && (m.moment ?? '')).trim();\n                          return !!mname && nm === String(mname).trim() && hg2 === hgKeyPrefix && mm2 === String(mm || '').trim();\n                        });\n                        const mallPoints = Array.isArray(selectedMall && selectedMall.points) ? selectedMall.points : [];\n                        const mallSections = Array.isArray(selectedMall && selectedMall.sections) ? selectedMall.sections : [];\n                        const nextChecklist = buildChecklistFromMallPoints({ mallName: mname || (selectedMall && selectedMall.name) || 'Mall', points: mallPoints, sections: mallSections });\n                        const shouldConfirm = hasAnyChecklistPoints(checklistRef.current);\n\n                        if (shouldConfirm) {\n                          Alert.alert(\n                            'Ersätta kontrollpunkter?',\n                            'Detta ersätter dina nuvarande punkter.',\n                            [\n                              { text: 'Avbryt', style: 'cancel' },\n                              {\n                                text: 'Fortsätt',\n                                style: 'destructive',\n                                onPress: () => {\n                                  setChecklist(nextChecklist);\n                                  setExpandedChecklist([]);\n                                  finishSave();\n                                }\n                              }\n                            ]\n                          );\n                          return;\n                        }\n\n                        setChecklist(nextChecklist);\n                        setExpandedChecklist([]);\n                        finishSave();\n                        return;\n                      }\n\n                      finishSave();\n                    }}\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\n                  >\n                    <Text style={{ color: '#1976D2', fontWeight: '600' }}>Spara</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n\n              {showAktivaByggdelarModal ? (\n                <View style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center', zIndex: 350 }}>\n                  <Pressable onPress={() => setShowAktivaByggdelarModal(false)} style={{ position: 'absolute', top: 0, right: 0, bottom: 0, left: 0 }} />\n                  <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 20, width: 320, height: '80%', alignItems: 'stretch', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 8 }}>\n                    <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Aktiva byggdelar</Text>\n                    <ScrollView style={{ flex: 1, marginBottom: 12 }}>\n                      {(Array.isArray(byggdelHuvudgruppOptions) ? byggdelHuvudgruppOptions : []).map((hg) => {\n                        const prefix = String(hg || '').split('-')[0].trim();\n                        const isExpanded = String(aktivaByggdelarExpandedPrefix || '') === String(prefix || '');\n                        const momentsCandidate = (byggdelMomentsByGroup && (byggdelMomentsByGroup[hg] || byggdelMomentsByGroup[prefix])) || [];\n                        const moments = Array.isArray(momentsCandidate) ? momentsCandidate : [];\n                        const draftSet = new Set((Array.isArray(aktivaByggdelarDraftKeys) ? aktivaByggdelarDraftKeys : []).map(x => String(x || '').trim()).filter(Boolean));\n\n                        return (\n                          <View key={`ab-hg-active-${hg}`} style={{ marginBottom: 6 }}>\n                            <TouchableOpacity\n                              onPress={() => {\n                                LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                                setAktivaByggdelarExpandedPrefix(prev => (String(prev || '') === String(prefix || '') ? '' : prefix));\n                              }}\n                              style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 10 }}\n                              hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\n                            >\n                              <Text style={{ fontSize: 15, color: '#222', fontWeight: '700', flex: 1 }} numberOfLines={2}>{hg}</Text>\n                              <Ionicons name={isExpanded ? 'chevron-up' : 'chevron-down'} size={18} color={'#666'} style={{ marginLeft: 8 }} />\n                            </TouchableOpacity>\n\n                            {isExpanded ? (\n                              <View style={{ paddingLeft: 14, paddingBottom: 8 }}>\n                                {moments.length === 0 ? (\n                                  <Text style={{ color: '#666', marginBottom: 6 }}>Inga byggdelar finns ännu för denna nivå.</Text>\n                                ) : (\n                                  <View style={{ flexDirection: 'column' }}>\n                                    <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>\n                                      <TouchableOpacity\n                                        onPress={() => {\n                                          setAktivaByggdelarDraftKeys(prev => {\n                                            const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\n                                            const next = new Set(cur);\n                                            (Array.isArray(moments) ? moments : []).forEach(mm => {\n                                              const momentLabel = String(mm || '').trim();\n                                              if (!prefix || !momentLabel) return;\n                                              next.add(`${prefix}||${momentLabel}`);\n                                            });\n                                            return Array.from(next);\n                                          });\n                                        }}\n                                        style={{ paddingVertical: 6, paddingHorizontal: 0 }}\n                                        accessibilityRole=\"button\"\n                                        accessibilityLabel={`Välj alla byggdelar i ${hg}`}\n                                      >\n                                        <Text style={{ color: '#1976D2', fontWeight: '700', fontSize: 13 }}>Välj alla i nivån</Text>\n                                      </TouchableOpacity>\n                                      <TouchableOpacity\n                                        onPress={() => {\n                                          setAktivaByggdelarDraftKeys(prev => {\n                                            const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\n                                            const next = new Set(cur);\n                                            (Array.isArray(moments) ? moments : []).forEach(mm => {\n                                              const momentLabel = String(mm || '').trim();\n                                              if (!prefix || !momentLabel) return;\n                                              next.delete(`${prefix}||${momentLabel}`);\n                                            });\n                                            return Array.from(next);\n                                          });\n                                        }}\n                                        style={{ paddingVertical: 6, paddingHorizontal: 0 }}\n                                        accessibilityRole=\"button\"\n                                        accessibilityLabel={`Rensa byggdelar i ${hg}`}\n                                      >\n                                        <Text style={{ color: '#777', fontWeight: '700', fontSize: 13 }}>Rensa nivån</Text>\n                                      </TouchableOpacity>\n                                    </View>\n\n                                    {moments.map((mm) => {\n                                      const momentLabel = String(mm || '').trim();\n                                      const key = `${prefix}||${momentLabel}`;\n                                      const checked = !!(prefix && momentLabel && draftSet.has(key));\n                                      return (\n                                        <TouchableOpacity\n                                          key={`ab-mm-active-${prefix}-${momentLabel}`}\n                                          onPress={() => {\n                                            setAktivaByggdelarDraftKeys(prev => {\n                                              const cur = new Set((Array.isArray(prev) ? prev : []).map(x => String(x || '').trim()).filter(Boolean));\n                                              if (!prefix || !momentLabel) return Array.from(cur);\n                                              if (cur.has(key)) cur.delete(key);\n                                              else cur.add(key);\n                                              return Array.from(cur);\n                                            });\n                                          }}\n                                          style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8 }}\n                                          hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\n                                        >\n                                          <Ionicons name={checked ? 'checkbox' : 'square-outline'} size={20} color={checked ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\n                                          <Text style={{ fontSize: 14, color: '#222', flex: 1 }} numberOfLines={2}>{momentLabel}</Text>\n                                        </TouchableOpacity>\n                                      );\n                                    })}\n                                  </View>\n                                )}\n                              </View>\n                            ) : null}\n                          </View>\n                        );\n                      })}\n                    </ScrollView>\n                    <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n                      <TouchableOpacity onPress={() => setShowAktivaByggdelarModal(false)} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\n                        <Text style={{ color: '#777' }}>Avbryt</Text>\n                      </TouchableOpacity>\n                      <TouchableOpacity\n                        onPress={() => {\n                          try {\n                            const draftSet = new Set((Array.isArray(aktivaByggdelarDraftKeys) ? aktivaByggdelarDraftKeys : [])\n                              .map(x => String(x || '').trim())\n                              .filter(x => !!x && x.includes('||')));\n\n                            const normalized = Array.from(draftSet);\n\n                            setAktivaByggdelarSelectedKeys(normalized);\n                            const pid = project && project.id ? String(project.id) : '';\n                            if (pid) {\n                              AsyncStorage.setItem(arbetsberedningActiveByggdelKey(pid), JSON.stringify({ selectedKeys: normalized })).catch((e) => {});\n                            }\n                          } catch(e) {}\n                          setShowAktivaByggdelarModal(false);\n                        }}\n                        style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\n                      >\n                        <Text style={{ color: '#1976D2', fontWeight: '600' }}>Bekräfta</Text>\n                      </TouchableOpacity>\n                    </View>\n                  </View>\n                </View>\n              ) : null}\n            </View>\n          </Modal>\n        )}\n\n        {/* Create mall popup (separate from Byggdel modal to avoid nested Modals) */}\n        {controlType === 'Arbetsberedning' && (\n          <Modal visible={showCreateByggdelMallModal && !showByggdelModal} transparent animationType=\"fade\" onRequestClose={() => {}}>\n            <View style={{ pointerEvents: 'box-none', flex: 1, backgroundColor: 'rgba(0,0,0,0.25)' }}>\n              <View\n                style={{\n                  flex: 1,\n                  justifyContent: 'flex-end',\n                  alignItems: 'center',\n                  paddingTop: 14,\n                  paddingHorizontal: 14,\n                  paddingBottom: createMallKeyboardHeight > 0 ? createMallKeyboardHeight : 14,\n                }}\n              >\n                <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\n                  <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                    <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Skapa ny mall</Text>\n                    {!!(createByggdelMallContext && createByggdelMallContext.moment) ? (\n                      <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\n                        {String(createByggdelMallContext.moment || '').trim()}\n                      </Text>\n                    ) : null}\n                  </View>\n\n                <View style={{ padding: 16 }}>\n                  <TextInput\n                    value={newByggdelMallName}\n                    onChangeText={setNewByggdelMallName}\n                    placeholder=\"Mallnamn\"\n                    placeholderTextColor=\"#888\"\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff' }}\n                  />\n                </View>\n\n                  <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\n                    <TouchableOpacity onPress={closeCreateByggdelMallModal} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\n                      <Text style={{ color: '#777' }}>Avbryt</Text>\n                    </TouchableOpacity>\n                    <TouchableOpacity onPress={submitCreateByggdelMall} style={{ paddingVertical: 10, paddingHorizontal: 12 }}>\n                      <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMall ? 'Sparar…' : 'Spara'}</Text>\n                    </TouchableOpacity>\n                  </View>\n                </View>\n              </View>\n            </View>\n          </Modal>\n        )}\n\n        {/* Byggdel mall editor (kontrollpunkter) */}\n        {controlType === 'Arbetsberedning' && (\n          <Modal\n            visible={showByggdelMallEditor}\n            transparent\n            animationType=\"fade\"\n            onRequestClose={() => {}}\n          >\n            <View style={{ pointerEvents: 'box-none', flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n              <View style={{ width: '90%', maxWidth: 420, height: '85%', backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd', marginBottom: mallEditorKeyboardHeight > 0 ? Math.min(mallEditorKeyboardHeight, 220) : 0 }}>\n                <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                  <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }} numberOfLines={2}>\n                    {String(byggdelMallEditor && byggdelMallEditor.name ? byggdelMallEditor.name : 'Mall')}\n                  </Text>\n                  {!!(byggdelMallEditor && (byggdelMallEditor.huvudgrupp || byggdelMallEditor.moment)) ? (\n                    <Text style={{ color: '#666', fontSize: 12, marginTop: 4 }} numberOfLines={2}>\n                      {String(byggdelMallEditor.huvudgrupp || '').trim()}{byggdelMallEditor.moment ? ` / ${String(byggdelMallEditor.moment || '').trim()}` : ''}\n                    </Text>\n                  ) : null}\n                </View>\n\n                <ScrollView style={{ flex: 1 }} keyboardShouldPersistTaps=\"handled\" contentContainerStyle={{ padding: 16 }}>\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 10 }}>\n                    Rubriker/huvudmoment. Tryck för att visa/dölja kontrollpunkter.\n                  </Text>\n\n                  {Array.isArray(byggdelMallSectionsDraft) && byggdelMallSectionsDraft.length > 0 ? (\n                    <View style={{ marginBottom: 12 }}>\n                      {byggdelMallSectionsDraft.map((sec) => {\n                        const sid = String(sec && sec.id ? sec.id : '');\n                        const title = String(sec && (sec.title || '')).trim();\n                        const pts = Array.isArray(sec && sec.points) ? sec.points : [];\n                        const isExpanded = sid && String(byggdelMallEditorExpandedSectionId || '') === sid;\n\n                        return (\n                          <View key={`bsec-${sid}`} style={{ marginBottom: 10, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', borderWidth: 1, borderColor: '#e0e0e0' }}>\n                            <TouchableOpacity\n                              onPress={() => {\n                                LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                                setByggdelMallEditorExpandedSectionId(prev => (String(prev || '') === sid ? '' : sid));\n                              }}\n                              style={{ flexDirection: 'row', alignItems: 'center', padding: 12, backgroundColor: isExpanded ? '#E8F0FF' : '#fff' }}\n                              accessibilityRole=\"button\"\n                              accessibilityLabel={`Visa eller dölj ${title || 'rubrik'}`}\n                            >\n                              <Ionicons name={isExpanded ? 'chevron-down' : 'chevron-forward'} size={18} color={isExpanded ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\n                              <Text style={{ flex: 1, color: isExpanded ? '#1976D2' : '#222', fontWeight: '700' }} numberOfLines={2}>\n                                {title || '(Rubrik)'}\n                              </Text>\n                            </TouchableOpacity>\n\n                            {isExpanded ? (\n                              <View style={{ padding: 12, paddingTop: 0 }}>\n                                <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>\n                                  <TextInput\n                                    value={title}\n                                    onChangeText={(txt) => {\n                                      setByggdelMallSectionsDraft(prev => {\n                                        const arr = Array.isArray(prev) ? prev : [];\n                                        return arr.map(s => {\n                                          if (String(s && s.id ? s.id : '') !== sid) return s;\n                                          return Object.assign({}, s, { title: txt });\n                                        });\n                                      });\n                                    }}\n                                    placeholder=\"Rubrik / huvudmoment\"\n                                    placeholderTextColor=\"#888\"\n                                    style={{ flex: 1, marginRight: 10, paddingVertical: 8, paddingHorizontal: 10, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 10, fontWeight: '700', color: '#222', backgroundColor: '#fff' }}\n                                  />\n                                  <TouchableOpacity\n                                    onPress={() => {\n                                      Alert.alert(\n                                        'Ta bort rubrik?',\n                                        `Vill du ta bort \"${title || '(Rubrik)'}\"?`,\n                                        [\n                                          { text: 'Avbryt', style: 'cancel' },\n                                          {\n                                            text: 'Ta bort',\n                                            style: 'destructive',\n                                            onPress: () => {\n                                              setByggdelMallSectionsDraft(prev => (Array.isArray(prev) ? prev.filter(s => String(s && s.id ? s.id : '') !== sid) : []));\n                                              setByggdelMallEditorExpandedSectionId(prev => (String(prev || '') === sid ? '' : prev));\n                                              setNewByggdelMallPointBySectionId(prev => {\n                                                const next = Object.assign({}, (prev && typeof prev === 'object') ? prev : {});\n                                                try { delete next[sid]; } catch(e) {}\n                                                return next;\n                                              });\n                                            }\n                                          }\n                                        ]\n                                      );\n                                    }}\n                                    accessibilityRole=\"button\"\n                                    accessibilityLabel=\"Ta bort rubrik\"\n                                    style={{ padding: 6 }}\n                                  >\n                                    <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\n                                  </TouchableOpacity>\n                                </View>\n\n                                {pts.length > 0 ? (\n                                  <View style={{ marginBottom: 10 }}>\n                                    {pts.map((p, idx) => {\n                                      const statusVal = (sec && Array.isArray(sec.statuses)) ? (sec.statuses[idx] ?? null) : null;\n                                      const photosOuter = (sec && Array.isArray(sec.photos)) ? sec.photos : [];\n                                      const photoList = Array.isArray(photosOuter[idx]) ? photosOuter[idx] : (photosOuter[idx] ? [photosOuter[idx]] : []);\n                                      const hasPhotos = Array.isArray(photoList) && photoList.length > 0;\n\n                                      return (\n                                        <View key={`bp-${sid}-${idx}`} style={{ flexDirection: 'row', alignItems: 'flex-start', justifyContent: 'space-between', paddingVertical: 8, paddingHorizontal: 10, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 10, marginBottom: 8, backgroundColor: '#fff' }}>\n                                          <View style={{ flexDirection: 'row', alignItems: 'center', marginRight: 8, paddingTop: 2 }}>\n                                            <TouchableOpacity\n                                              onPress={() => {\n                                                setByggdelMallSectionsDraft(prev => {\n                                                  const arr = Array.isArray(prev) ? prev : [];\n                                                  return arr.map(s => {\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? [...s.statuses] : Array(pp.length).fill(null);\n                                                    const next = (statuses[idx] === 'ok') ? null : 'ok';\n                                                    statuses[idx] = next;\n                                                    return Object.assign({}, s, { statuses });\n                                                  });\n                                                });\n                                              }}\n                                              style={{ padding: 4, marginRight: 6 }}\n                                              accessibilityRole=\"button\"\n                                              accessibilityLabel=\"Markera som godkänd\"\n                                            >\n                                              <Ionicons name={statusVal === 'ok' ? 'checkmark-circle' : 'ellipse-outline'} size={20} color={statusVal === 'ok' ? '#43A047' : '#bbb'} />\n                                            </TouchableOpacity>\n                                            <TouchableOpacity\n                                              onPress={() => {\n                                                setByggdelMallSectionsDraft(prev => {\n                                                  const arr = Array.isArray(prev) ? prev : [];\n                                                  return arr.map(s => {\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? [...s.statuses] : Array(pp.length).fill(null);\n                                                    const next = (statuses[idx] === 'avvikelse') ? null : 'avvikelse';\n                                                    statuses[idx] = next;\n                                                    return Object.assign({}, s, { statuses });\n                                                  });\n                                                });\n                                              }}\n                                              style={{ padding: 4 }}\n                                              accessibilityRole=\"button\"\n                                              accessibilityLabel=\"Markera som avvikelse\"\n                                            >\n                                              <View style={{ width: 20, height: 20, borderRadius: 10, alignItems: 'center', justifyContent: 'center', backgroundColor: statusVal === 'avvikelse' ? '#D32F2F' : 'transparent' }}>\n                                                {statusVal === 'avvikelse' ? (\n                                                  <Ionicons name=\"alert\" size={14} color=\"#fff\" />\n                                                ) : (\n                                                  <Ionicons name=\"ellipse-outline\" size={20} color=\"#bbb\" />\n                                                )}\n                                              </View>\n                                            </TouchableOpacity>\n                                          </View>\n\n                                          <TextInput\n                                            value={String(p || '')}\n                                            onChangeText={(txt) => {\n                                              setByggdelMallSectionsDraft(prev => {\n                                                const arr = Array.isArray(prev) ? prev : [];\n                                                return arr.map(s => {\n                                                  if (String(s && s.id ? s.id : '') !== sid) return s;\n                                                  const pp = Array.isArray(s && s.points) ? [...s.points] : [];\n                                                  if (idx < 0 || idx >= pp.length) return s;\n                                                  pp[idx] = txt;\n                                                  return Object.assign({}, s, { points: pp });\n                                                });\n                                              });\n                                            }}\n                                            multiline\n                                            placeholderTextColor=\"#888\"\n                                            style={{ color: '#222', flex: 1, marginRight: 10, paddingVertical: 6, paddingHorizontal: 8, borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, backgroundColor: '#fff', minHeight: 36, textAlignVertical: 'top' }}\n                                          />\n\n                                          <View style={{ flexDirection: 'row', alignItems: 'center', paddingTop: 2 }}>\n                                            <TouchableOpacity\n                                              onPress={() => {\n                                                if (hasPhotos) {\n                                                  setPhotoModal({ visible: true, uris: photoList, index: 0, mallSectionId: sid, mallPointIdx: idx });\n                                                  return;\n                                                }\n                                                handlePickMallPointFromLibrary(sid, idx);\n                                              }}\n                                              style={{ padding: 6, marginRight: 2 }}\n                                              accessibilityRole=\"button\"\n                                              accessibilityLabel={hasPhotos ? 'Visa bilder' : 'Lägg till bilder'}\n                                            >\n                                              <Ionicons name={hasPhotos ? 'camera' : 'camera-outline'} size={18} color={'#1976D2'} />\n                                            </TouchableOpacity>\n                                            <TouchableOpacity\n                                              onPress={() => {\n                                                setByggdelMallSectionsDraft(prev => {\n                                                  const arr = Array.isArray(prev) ? prev : [];\n                                                  return arr.map(s => {\n                                                    if (String(s && s.id ? s.id : '') !== sid) return s;\n                                                    const pp = Array.isArray(s && s.points) ? s.points : [];\n                                                    const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? s.statuses : Array(pp.length).fill(null);\n                                                    const photos = Array.isArray(s && s.photos) && s.photos.length === pp.length ? s.photos : Array(pp.length).fill(null).map(() => []);\n                                                    return Object.assign({}, s, {\n                                                      points: pp.filter((_, i) => i !== idx),\n                                                      statuses: statuses.filter((_, i) => i !== idx),\n                                                      photos: photos.filter((_, i) => i !== idx),\n                                                    });\n                                                  });\n                                                });\n                                              }}\n                                              accessibilityRole=\"button\"\n                                              accessibilityLabel=\"Ta bort kontrollpunkt\"\n                                              style={{ padding: 6 }}\n                                            >\n                                              <Ionicons name=\"trash-outline\" size={18} color=\"#D32F2F\" />\n                                            </TouchableOpacity>\n                                          </View>\n                                        </View>\n                                      );\n                                    })}\n                                  </View>\n                                ) : (\n                                  <Text style={{ color: '#666', marginBottom: 10 }}>Inga kontrollpunkter under denna rubrik ännu.</Text>\n                                )}\n\n                                <Text style={{ fontSize: 13, color: '#444', marginBottom: 6 }}>Lägg till kontrollpunkt</Text>\n                                <TextInput\n                                  value={String((newByggdelMallPointBySectionId && newByggdelMallPointBySectionId[sid]) ? newByggdelMallPointBySectionId[sid] : '')}\n                                  onChangeText={(txt) => {\n                                    setNewByggdelMallPointBySectionId(prev => Object.assign({}, (prev && typeof prev === 'object') ? prev : {}, { [sid]: txt }));\n                                  }}\n                                  multiline\n                                  placeholder=\"Ny kontrollpunkt\"\n                                  placeholderTextColor=\"#888\"\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', marginBottom: 10, minHeight: 44, textAlignVertical: 'top' }}\n                                />\n                                <TouchableOpacity\n                                  onPress={() => {\n                                    const raw = (newByggdelMallPointBySectionId && newByggdelMallPointBySectionId[sid]) ? newByggdelMallPointBySectionId[sid] : '';\n                                    const txt = String(raw || '').trim();\n                                    if (!txt) {\n                                      Alert.alert('Ange text', 'Skriv en kontrollpunkt.');\n                                      return;\n                                    }\n                                    setByggdelMallSectionsDraft(prev => {\n                                      const arr = Array.isArray(prev) ? prev : [];\n                                      return arr.map(s => {\n                                        if (String(s && s.id ? s.id : '') !== sid) return s;\n                                        const pp = Array.isArray(s && s.points) ? s.points : [];\n                                        const statuses = Array.isArray(s && s.statuses) && s.statuses.length === pp.length ? s.statuses : Array(pp.length).fill(null);\n                                        const photos = Array.isArray(s && s.photos) && s.photos.length === pp.length ? s.photos : Array(pp.length).fill(null).map(() => []);\n                                        return Object.assign({}, s, {\n                                          points: [...pp, txt],\n                                          statuses: [...statuses, null],\n                                          photos: [...photos, []],\n                                        });\n                                      });\n                                    });\n                                    setNewByggdelMallPointBySectionId(prev => Object.assign({}, (prev && typeof prev === 'object') ? prev : {}, { [sid]: '' }));\n                                  }}\n                                  style={{ paddingVertical: 10, paddingHorizontal: 12, borderRadius: 10, borderWidth: 1, borderColor: '#1976D2', backgroundColor: '#E8F0FF', alignItems: 'center' }}\n                                  accessibilityRole=\"button\"\n                                  accessibilityLabel=\"Lägg till kontrollpunkt\"\n                                >\n                                  <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Lägg till kontrollpunkt</Text>\n                                </TouchableOpacity>\n                              </View>\n                            ) : null}\n                          </View>\n                        );\n                      })}\n                    </View>\n                  ) : (\n                    <Text style={{ color: '#666', marginBottom: 12 }}>Inga rubriker ännu.</Text>\n                  )}\n\n                  <Text style={{ fontSize: 13, color: '#444', marginBottom: 6 }}>Lägg till rubrik</Text>\n                  <TextInput\n                    value={newByggdelMallSectionTitle}\n                    onChangeText={setNewByggdelMallSectionTitle}\n                    placeholder=\"Ny rubrik / huvudmoment\"\n                    placeholderTextColor=\"#888\"\n                    style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', marginBottom: 10 }}\n                  />\n\n                  <TouchableOpacity\n                    onPress={() => {\n                      const title = String(newByggdelMallSectionTitle || '').trim();\n                      if (!title) {\n                        Alert.alert('Ange rubrik', 'Skriv en rubrik/huvudmoment.');\n                        return;\n                      }\n                      const sid = `sec-${Date.now()}-${Math.random().toString(16).slice(2)}`;\n                      setByggdelMallSectionsDraft(prev => {\n                        const arr = Array.isArray(prev) ? prev : [];\n                        return [...arr, { id: sid, title, points: [], statuses: [], photos: [] }];\n                      });\n                      setNewByggdelMallSectionTitle('');\n                      LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                      setByggdelMallEditorExpandedSectionId(sid);\n                    }}\n                    style={{ paddingVertical: 10, paddingHorizontal: 12, borderRadius: 10, borderWidth: 1, borderColor: '#1976D2', backgroundColor: '#E8F0FF', alignItems: 'center', marginBottom: 14 }}\n                    accessibilityRole=\"button\"\n                    accessibilityLabel=\"Lägg till rubrik\"\n                  >\n                    <Text style={{ color: '#1976D2', fontWeight: '700' }}>+ Lägg till rubrik</Text>\n                  </TouchableOpacity>\n                </ScrollView>\n\n                <View style={{ padding: 12, borderTopWidth: 1, borderTopColor: '#eee', flexDirection: 'row', justifyContent: 'space-between' }}>\n                  <TouchableOpacity\n                    onPress={() => setShowByggdelMallEditor(false)}\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\n                    accessibilityRole=\"button\"\n                    accessibilityLabel=\"Stäng mall\"\n                  >\n                    <Text style={{ color: '#777' }}>Stäng</Text>\n                  </TouchableOpacity>\n                  <TouchableOpacity\n                    onPress={async () => {\n                      try {\n                        if (!byggdelMallEditor || !byggdelMallEditor.id) return;\n                        if (savingByggdelMallPoints) return;\n                        setSavingByggdelMallPoints(true);\n                        const secs = Array.isArray(byggdelMallSectionsDraft) ? byggdelMallSectionsDraft : [];\n                        const sectionsForSave = secs\n                          .map(s => {\n                            const title = String(s && (s.title || '')).trim();\n                            const rawPts = Array.isArray(s && s.points) ? s.points : [];\n                            const rawStatuses = Array.isArray(s && s.statuses) ? s.statuses : [];\n                            const rawPhotosOuter = Array.isArray(s && s.photos) ? s.photos : [];\n                            const normalizeStatus = (v) => (v === 'ok' || v === 'avvikelse' || v === 'ejaktuell') ? v : null;\n                            const items = rawPts\n                              .map((p, i) => ({\n                                text: String(p || '').trim(),\n                                status: rawStatuses[i],\n                                photos: rawPhotosOuter[i],\n                              }))\n                              .filter(it => !!it.text);\n                            const pts = items.map(it => it.text);\n                            const statuses = items.map(it => normalizeStatus(it.status));\n                            const photos = items.map(it => {\n                              const list = Array.isArray(it.photos) ? it.photos : (it.photos ? [it.photos] : []);\n                              return list\n                                .map(item => {\n                                  if (!item) return null;\n                                  if (typeof item === 'string') return item;\n                                  if (item && typeof item === 'object' && item.uri) return { uri: item.uri, comment: item.comment || '' };\n                                  return null;\n                                })\n                                .filter(Boolean);\n                            });\n                            return { title, points: pts, statuses, photos };\n                          })\n                          .filter(s => String(s && s.title ? s.title : '').trim() || (Array.isArray(s && s.points) && s.points.length > 0));\n                        const flatPoints = sectionsForSave.reduce((acc, s) => acc.concat(Array.isArray(s.points) ? s.points : []), []);\n                        const ok = await updateByggdelMall({ mallId: byggdelMallEditor.id, patch: { sections: sectionsForSave, points: flatPoints } });\n                        if (!ok) {\n                          Alert.alert('Kunde inte spara', 'Försök igen.');\n                          return;\n                        }\n                        await refreshByggdelMallar();\n                        setShowByggdelMallEditor(false);\n                      } catch(e) {\n                        Alert.alert('Kunde inte spara', 'Försök igen.');\n                      } finally {\n                        setSavingByggdelMallPoints(false);\n                      }\n                    }}\n                    style={{ paddingVertical: 10, paddingHorizontal: 12 }}\n                    accessibilityRole=\"button\"\n                    accessibilityLabel=\"Spara kontrollpunkter\"\n                  >\n                    <Text style={{ color: '#1976D2', fontWeight: '700' }}>{savingByggdelMallPoints ? 'Sparar…' : 'Spara'}</Text>\n                  </TouchableOpacity>\n                </View>\n              </View>\n            </View>\n          </Modal>\n        )}\n        {/* Material description for Mottagningskontroll */}\n        {controlType === 'Mottagningskontroll' && (\n          <View style={{ marginTop: 8, marginBottom: 10, paddingHorizontal: 16 }}>\n            <Text style={{ fontSize: 15, color: (missingFields && missingFields.includes('Beskriv leverans')) ? '#D32F2F' : '#222', marginBottom: 6, fontWeight: '600' }}>Beskriv leverans</Text>\n            <TextInput\n              value={materialDesc}\n              onChangeText={setMaterialDesc}\n              placeholder=\"Ex: Gipsskivor, isolering, fönster...\"\n              placeholderTextColor=\"#888\"\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n            />\n          </View>\n        )}\n\n        {/* Beskriv arbetsmoment endast för Riskbedömning */}\n        {controlType === 'Riskbedömning' && (\n          <View style={{ marginTop: 8, marginBottom: 10, paddingHorizontal: 16 }}>\n            <Text style={{ fontSize: 15, color: '#222', marginBottom: 6, fontWeight: '600' }}>Beskriv arbetsmoment</Text>\n            <TextInput\n              value={deliveryDesc}\n              onChangeText={setDeliveryDesc}\n              placeholder=\"Vad ska göras? T.ex. Lossning av stålbalkar\"\n              placeholderTextColor=\"#888\"\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n              multiline\n            />\n          </View>\n        )}\n        {/* Button to choose categories for Arbetsberedning */}\n        {controlType === 'Arbetsberedning' && Array.isArray(checklistConfig) && (\n          <View style={{ paddingHorizontal: 16, marginBottom: 8 }}>\n            <TouchableOpacity\n              onPress={() => {\n                if (byggdelMallLocksCategories) return;\n                setShowCategoryModal(true);\n              }}\n              disabled={byggdelMallLocksCategories}\n              style={{\n                flexDirection: 'row',\n                alignItems: 'center',\n                paddingVertical: 10,\n                paddingHorizontal: 10,\n                borderRadius: 10,\n                backgroundColor: (Array.isArray(checklist) && checklist.length > 0) ? 'transparent' : '#E8F0FF',\n                borderWidth: (Array.isArray(checklist) && checklist.length > 0) ? 0 : 1,\n                borderColor: (Array.isArray(checklist) && checklist.length > 0) ? 'transparent' : '#1976D2',\n                opacity: byggdelMallLocksCategories ? 0.4 : 1,\n              }}\n              accessibilityRole=\"button\"\n            >\n              <Ionicons name=\"options-outline\" size={26} color=\"#1976D2\" style={{ marginRight: 10 }} />\n              <Text style={{ color: '#1976D2', fontWeight: '600', fontSize: 16 }}>Välj kategorier att gå igenom</Text>\n            </TouchableOpacity>\n          </View>\n        )}\n        {/* Add Participant Modal */}\n        {/* Modal för Lägg till deltagare */}\n        <Modal visible={showAddParticipantModal} transparent animationType=\"fade\" onRequestClose={() => setShowAddParticipantModal(false)}>\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)' }}>\n            <KeyboardAvoidingView\n              behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\n              keyboardVerticalOffset={Platform.OS === 'ios' ? 60 : 20}\n              style={{ flex: 1 }}\n            >\n              <ScrollView keyboardShouldPersistTaps=\"handled\" contentContainerStyle={{ flexGrow: 1, justifyContent: 'center', alignItems: 'center', paddingTop: 140, paddingBottom: 24 }}>\n                <View style={{ width: '100%', maxWidth: 300, backgroundColor: '#fff', borderRadius: 12, padding: 16, marginTop: 0, marginVertical: 8 }}>\n                  <TouchableOpacity\n                    onPress={() => setShowAddParticipantModal(false)}\n                    style={{ position: 'absolute', top: 8, right: 8, zIndex: 10, padding: 6 }}\n                    accessibilityLabel=\"Stäng\"\n                    hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}\n                  >\n                    <Ionicons name=\"close\" size={22} color=\"#888\" />\n                  </TouchableOpacity>\n                  <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 8, textAlign: 'center' }}>{editParticipantIndex !== null ? editParticipantsLabel : addParticipantsLabel}</Text>\n                  <TextInput\n                    value={participantName}\n                    onChangeText={setParticipantName}\n                    placeholder=\"Namn\"\n                    placeholderTextColor=\"#888\"\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\n                    returnKeyType=\"next\"\n                    onSubmitEditing={() => companyRef && companyRef.current && companyRef.current.focus()}\n                    ref={nameRef}\n                  />\n                  <TextInput\n                    value={participantCompany}\n                    onChangeText={setParticipantCompany}\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\n                    placeholderTextColor=\"#888\"\n                    placeholder=\"Företag\"\n                    autoCapitalize=\"words\"\n                    autoCorrect={false}\n                    returnKeyType=\"next\"\n                    onSubmitEditing={() => roleRef && roleRef.current && roleRef.current.focus()}\n                    ref={companyRef}\n                  />\n                  <TextInput\n                    value={participantRole}\n                    onChangeText={setParticipantRole}\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 10 }}\n                    placeholderTextColor=\"#888\"\n                    placeholder=\"Roll\"\n                    autoCapitalize=\"words\"\n                    autoCorrect={false}\n                    returnKeyType=\"next\"\n                    onSubmitEditing={() => phoneRef && phoneRef.current && phoneRef.current.focus()}\n                    ref={roleRef}\n                  />\n                  <TextInput\n                    value={participantPhone}\n                    onChangeText={text => {\n                      // Only allow numbers, auto-insert spaces: xxx xxx xx xx\n                      let cleaned = text.replace(/[^0-9]/g, '');\n                      if (cleaned.length > 10) cleaned = cleaned.slice(0, 10);\n                      let formatted = cleaned;\n                      if (cleaned.length > 3) formatted = cleaned.slice(0, 3) + ' ' + cleaned.slice(3);\n                      if (cleaned.length > 6) formatted = formatted.slice(0, 7) + ' ' + formatted.slice(7);\n                      if (cleaned.length > 8) formatted = formatted.slice(0, 10) + ' ' + formatted.slice(10);\n                      setParticipantPhone(formatted);\n                    }}\n                    style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 8, fontSize: 16, color: '#222', backgroundColor: '#fafafa', width: '100%', marginBottom: 16 }}\n                    placeholderTextColor=\"#888\"\n                    placeholder=\"Mobilnummer\"\n                    keyboardType=\"numeric\"\n                    autoCapitalize=\"none\"\n                    autoCorrect={false}\n                    maxLength={13}\n                    returnKeyType=\"done\"\n                    onSubmitEditing={() => {\n                      // Save or update participant\n                      if (!participantName.trim()) return;\n                      const newP = { name: participantName.trim(), company: participantCompany.trim(), role: participantRole.trim(), phone: participantPhone.trim() };\n                      if (editParticipantIndex !== null && editParticipantIndex >= 0) {\n                        setLocalParticipants(prev => {\n                          const a = Array.isArray(prev) ? [...prev] : [];\n                          a[editParticipantIndex] = newP;\n                          return a;\n                        });\n                      } else {\n                        setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), newP]));\n                      }\n                      setShowAddParticipantModal(false);\n                      setParticipantName('');\n                      setParticipantCompany('');\n                      setParticipantRole('');\n                      setParticipantPhone('');\n                      setEditParticipantIndex(null);\n                    }}\n                    ref={phoneRef}\n                  />\n                  <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%' }}>\n                    <TouchableOpacity\n                      style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\n                      onPress={() => {\n                        if (!participantName.trim()) return;\n                        const newP = { name: participantName.trim(), company: participantCompany.trim(), role: participantRole.trim(), phone: participantPhone.trim() };\n                        if (editParticipantIndex !== null && editParticipantIndex >= 0) {\n                          setLocalParticipants(prev => {\n                            const a = Array.isArray(prev) ? [...prev] : [];\n                            a[editParticipantIndex] = newP;\n                            return a;\n                          });\n                        } else {\n                          setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), newP]));\n                        }\n                        setShowAddParticipantModal(false);\n                        setParticipantName('');\n                        setParticipantCompany('');\n                        setParticipantRole('');\n                        setParticipantPhone('');\n                        setEditParticipantIndex(null);\n                      }}\n                      disabled={!participantName.trim()}\n                    >\n                      <Text style={{ color: '#1976D2', fontWeight: '400', fontSize: 16, opacity: participantName.trim() ? 1 : 0.4 }}>{editParticipantIndex !== null ? 'Spara' : 'Spara'}</Text>\n                    </TouchableOpacity>\n                    <TouchableOpacity\n                      style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 10, paddingHorizontal: 0 }}\n                      onPress={() => {\n                        setShowAddParticipantModal(false);\n                        setParticipantName('');\n                        setParticipantCompany('');\n                        setParticipantRole('');\n                        setParticipantPhone('');\n                        setEditParticipantIndex(null);\n                      }}\n                    >\n                      <Text style={{ color: '#D32F2F', fontWeight: '400', fontSize: 16 }}>Avbryt</Text>\n                    </TouchableOpacity>\n                  </View>\n                </View>\n              </ScrollView>\n            </KeyboardAvoidingView>\n          </View>\n        </Modal>\n        {/* Divider under participants, before weather (removed duplicate) */}\n        {/* Modal to add an extra signer (used by Lägg till signerare) */}\n        <Modal visible={showAddSignerModal} transparent animationType=\"fade\" onRequestClose={() => setShowAddSignerModal(false)}>\n          <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n            <View style={{ width: '90%', maxWidth: 340, backgroundColor: '#fff', borderRadius: 12, padding: 16 }}>\n              <TouchableOpacity onPress={() => { setShowAddSignerModal(false); setSignerName(''); }} style={{ position: 'absolute', top: 8, right: 8, zIndex: 10, padding: 6 }}>\n                <Ionicons name=\"close\" size={22} color=\"#888\" />\n              </TouchableOpacity>\n              <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 12, textAlign: 'center' }}>Lägg till signerare</Text>\n              <TextInput\n                value={signerName}\n                onChangeText={setSignerName}\n                placeholder=\"Namn på signerare\"\n                placeholderTextColor=\"#888\"\n                style={{ borderWidth: 1, borderColor: '#bbb', borderRadius: 8, padding: 10, fontSize: 16, marginBottom: 12 }}\n              />\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n                <TouchableOpacity onPress={() => { setShowAddSignerModal(false); setSignerName(''); }} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\n                </TouchableOpacity>\n                <TouchableOpacity onPress={() => {\n                  const name = (signerName || '').trim();\n                  if (!name) return;\n                  setLocalParticipants(prev => ([...(Array.isArray(prev) ? prev : []), { name }]));\n                  setSignerName('');\n                  setShowAddSignerModal(false);\n                }} style={{ flex: 1, alignItems: 'center', paddingVertical: 12 }}>\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Lägg till</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        </Modal>\n\n        {/* Omfattning / beskrivning för Skyddsrond */}\n        {controlType === 'Skyddsrond' && (\n          <View style={{ marginTop: 8, marginBottom: 12, paddingHorizontal: 16 }}>\n            <Text style={{ fontSize: 15, color: (missingFields && missingFields.includes('Omfattning / beskrivning av skyddsrond')) ? '#D32F2F' : '#222', marginBottom: 4, fontWeight: 'bold' }}>Omfattning / beskrivning av skyddsrond</Text>\n            <TextInput\n              style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 15, backgroundColor: '#fff' }}\n              value={deliveryDesc}\n              onChangeText={setDeliveryDesc}\n              placeholder=\"Ex: Hus A, yttertak, ställning, endast inomhus eller utomhus...\"\n              placeholderTextColor=\"#bbb\"\n              multiline\n            />\n            {/* Divider under Omfattning */}\n            <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 12, marginBottom: 0 }} />\n          </View>\n        )}\n        {/* Category selection modal for Arbetsberedning */}\n        {showCategoryModal && !byggdelMallLocksCategories && (\n          <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'flex-start', alignItems: 'center', zIndex: 300 }}>\n            <View style={{ backgroundColor: '#fff', borderRadius: 16, padding: 20, width: 320, maxHeight: '70%', alignItems: 'stretch', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 8, marginTop: 120 }}>\n              <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 12, color: '#222' }}>Välj kategorier</Text>\n              <ScrollView style={{ marginBottom: 12 }}>\n                {Array.isArray(checklistConfig) && checklistConfig.map((sec, idx) => (\n                  <TouchableOpacity\n                    key={`cat-${idx}`}\n                    onPress={() => setSelectedCategories(prev => { const s = [...prev]; s[idx] = !s[idx]; return s; })}\n                    style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8 }}\n                    hitSlop={{ top: 6, bottom: 6, left: 6, right: 6 }}\n                  >\n                    <Ionicons name={selectedCategories[idx] ? 'checkbox' : 'square-outline'} size={20} color={selectedCategories[idx] ? '#1976D2' : '#666'} style={{ marginRight: 10 }} />\n                    <Text style={{ fontSize: 15, color: '#222' }}>{sec.label}</Text>\n                  </TouchableOpacity>\n                ))}\n              </ScrollView>\n              <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>\n                <TouchableOpacity onPress={() => setShowCategoryModal(false)} style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}>\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\n                </TouchableOpacity>\n                <TouchableOpacity\n                  onPress={() => {\n                    applySelectedCategoriesToChecklist(selectedCategories);\n\n                    // Persist as project default (local device) for Arbetsberedning\n                    if (controlType === 'Arbetsberedning') {\n                      try {\n                        const pid = project && project.id ? String(project.id) : '';\n                        const cfg = Array.isArray(checklistConfig) ? checklistConfig : [];\n                        if (pid && cfg.length > 0 && Array.isArray(selectedCategories) && selectedCategories.length === cfg.length) {\n                          const selectedLabels = cfg.filter((_, i) => !!selectedCategories[i]).map(sec => sec && sec.label ? sec.label : '').filter(Boolean);\n                          AsyncStorage.setItem(arbetsberedningCategoryKey(pid), JSON.stringify({ selectedLabels })).catch((e) => {});\n                        }\n                      } catch(e) {}\n                    }\n                    setShowCategoryModal(false);\n                  }}\n                  style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\n                >\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>Bekräfta</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        )}\n      {/* Checklist rendering for Skyddsrond och andra kontroller */}\n      {(controlType === 'Arbetsberedning' || (Array.isArray(checklist) && checklist.length > 0)) && (\n        <View style={{ marginTop: 8, marginBottom: 16, paddingHorizontal: 16 }}>\n          <Text style={{ fontSize: 18, fontWeight: 'bold', color: (missingFields && missingFields.includes('Kontrollpunkter')) ? '#D32F2F' : '#222', marginBottom: 10, marginLeft: 2 }}>Kontrollpunkter</Text>\n          {(!Array.isArray(checklist) || checklist.length === 0) ? (\n            <Text style={{ color: '#666', fontSize: 14, marginLeft: 2 }}>\n              Inga kategorier är valda än. Tryck på “Välj kategorier att gå igenom” ovan.\n            </Text>\n          ) : null}\n          {(Array.isArray(checklist) ? checklist : []).map((section, sectionIdx) => {\n            const expanded = expandedChecklist.includes(sectionIdx);\n            // Check if any point in this section is not filled in\n            const sectionStatuses = checklist[sectionIdx]?.statuses || [];\n            const anyMissing = section.points.some((_, idx) => !sectionStatuses[idx]);\n            let sectionHeaderBg = anyMissing ? '#FFE5E5' : '#e9ecef';\n            let sectionHeaderText = anyMissing ? '#D32F2F' : '#222';\n            // Ikonlogik: visa fotoikon om något foto finns, varning om någon avvikelse, grön check om alla är ifyllda (oavsett status)\n            const allFilled = section.points.every((_, idx) => !!sectionStatuses[idx]);\n            // Only consider unhandled avvikelser as active warnings\n            const hasAvvikelse = (sectionStatuses || []).some((s, si) => s === 'avvikelse' && !(section.remediation && section.remediation[(section.points || [])[si]]));\n\n            // Web: make sections with unhandled deviations stand out in yellow\n            if (Platform.OS === 'web' && !anyMissing && hasAvvikelse) {\n              sectionHeaderBg = '#FFD600';\n              sectionHeaderText = '#222';\n            }\n\n            const photos = checklist[sectionIdx]?.photos || [];\n            const hasPhoto = photos.some(photoArr => Array.isArray(photoArr) && photoArr.length > 0);\n            // Web-only: show a small thumbnail preview in the row when photos exist\n            let sectionPhotoItems = [];\n            let sectionThumbIndex = 0;\n            let sectionThumbUri = null;\n            if (hasPhoto) {\n              try {\n                const out = [];\n                const outer = Array.isArray(photos) ? photos : [];\n                for (const arr of outer) {\n                  const inner = Array.isArray(arr) ? arr : (arr ? [arr] : []);\n                  for (const item of inner) {\n                    const uri = (item && typeof item === 'object' && item.uri) ? item.uri : item;\n                    if (uri) out.push(item);\n                  }\n                }\n                sectionPhotoItems = out;\n                if (out.length > 0) {\n                  sectionThumbIndex = out.length - 1;\n                  const thumbItem = out[sectionThumbIndex];\n                  sectionThumbUri = (thumbItem && typeof thumbItem === 'object' && thumbItem.uri) ? thumbItem.uri : thumbItem;\n                }\n              } catch(e) {\n                sectionPhotoItems = [];\n                sectionThumbIndex = 0;\n                sectionThumbUri = null;\n              }\n            }\n            // Show green check if all filled, regardless of status\n            const showGreenCheck = allFilled;\n\n            // Web-only helper: find the first unhandled deviation in this section\n            const firstUnhandledDeviationIdx = (() => {\n              try {\n                const pts = Array.isArray(section.points) ? section.points : [];\n                for (let i = 0; i < pts.length; i++) {\n                  if ((sectionStatuses || [])[i] !== 'avvikelse') continue;\n                  const pt = pts[i];\n                  const rem = section.remediation && section.remediation[pt];\n                  if (!rem) return i;\n                }\n              } catch(e) {}\n              return -1;\n            })();\n\n            return (\n                <View key={section.id ? `section-${section.id}` : btoa(unescape(encodeURIComponent(section.label))) + '-' + sectionIdx} style={{ marginBottom: 10, backgroundColor: '#fff', borderRadius: 8, overflow: 'hidden', borderWidth: 1, borderColor: '#e0e0e0' }}>\n                <TouchableOpacity\n                  style={{ flexDirection: 'row', alignItems: 'center', padding: 14, backgroundColor: sectionHeaderBg }}\n                  onPress={() => {\n                    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\n                    setExpandedChecklist(prev => prev.includes(sectionIdx) ? [] : [sectionIdx]);\n                  }}\n                  activeOpacity={0.7}\n                  hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}\n                  accessibilityRole=\"button\"\n                  accessibilityLabel={`Visa eller dölj ${section.label}`}\n                >\n                  <Ionicons name={expanded ? 'chevron-down' : 'chevron-forward'} size={20} color={'#1976D2'} style={{ marginRight: 8 }} />\n                  <View style={{ flex: 1, flexDirection: 'column' }}>\n                    <Text numberOfLines={1} ellipsizeMode=\"tail\" style={{ fontSize: 16, fontWeight: 'bold', color: sectionHeaderText }}>{section.label}</Text>\n                    {(() => {\n                      // Count only unhandled deviations (exclude points with saved remediation info)\n                      const deviationCount = (sectionStatuses || []).reduce((acc, s, si) => {\n                        const rem = section.remediation && section.remediation[(section.points || [])[si]];\n                        return acc + ((s === 'avvikelse' && !rem) ? 1 : 0);\n                      }, 0);\n                      const okCount = (sectionStatuses || []).filter(s => s === 'ok').length;\n                      const notRelevantCount = (sectionStatuses || []).filter(s => s === 'ejaktuell').length;\n                      const total = (section.points || []).length || 0;\n                      const filledCount = okCount + deviationCount + notRelevantCount;\n\n                      // Web: always show labels + counts (even when 0)\n                      if (Platform.OS === 'web') {\n                        return (\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6, flexWrap: 'wrap' }}>\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 4 }} />\n                            <Text style={{ fontSize: 12, color: '#43A047', marginRight: 10 }}>{`Godkänd ${okCount}`}</Text>\n                            <Ionicons name=\"alert-circle\" size={18} color=\"#D32F2F\" style={{ marginRight: 4 }} />\n                            <Text style={{ fontSize: 12, color: '#D32F2F', marginRight: 10 }}>{`Avvikelse ${deviationCount}`}</Text>\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 4 }} />\n                            <Text style={{ fontSize: 12, color: '#607D8B' }}>{`Ej aktuell ${notRelevantCount}`}</Text>\n                          </View>\n                        );\n                      }\n\n                      if (filledCount === 0) {\n                        // Show legend only if nothing is filled\n                        return (\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6 }}>\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 2 }} />\n                            <Text style={{ fontSize: 11, color: '#43A047', marginRight: 8 }}>Godkänd</Text>\n                            <Ionicons name=\"alert-circle\" size={18} color=\"#D32F2F\" style={{ marginRight: 2 }} />\n                            <Text style={{ fontSize: 11, color: '#D32F2F', marginRight: 8 }}>Avvikelse</Text>\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 2 }} />\n                            <Text style={{ fontSize: 11, color: '#607D8B' }}>Ej aktuell</Text>\n                          </View>\n                        );\n                      } else {\n                        // Native: compact icon + count only\n                        return (\n                          <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 6 }}>\n                            <Ionicons name=\"checkmark-circle\" size={18} color=\"#43A047\" style={{ marginRight: 2 }} />\n                            <Text style={{ fontSize: 13, color: '#43A047', fontWeight: '600', marginRight: 12 }}>{okCount}</Text>\n                            <View style={{ width: 18, height: 18, borderRadius: 9, backgroundColor: '#D32F2F', alignItems: 'center', justifyContent: 'center', marginRight: 2 }}>\n                              <Ionicons name=\"alert\" size={13} color=\"#fff\" />\n                            </View>\n                            <Text style={{ fontSize: 13, color: '#D32F2F', fontWeight: '600', marginRight: 12 }}>{deviationCount}</Text>\n                            <Ionicons name=\"remove-circle\" size={18} color=\"#607D8B\" style={{ marginRight: 2 }} />\n                            <Text style={{ fontSize: 13, color: '#607D8B', fontWeight: '600' }}>{notRelevantCount}</Text>\n                          </View>\n                        );\n                      }\n                    })()}\n                  </View>\n                  {/* Camera / check icons */}\n                  {Platform.OS === 'web' && controlType === 'Skyddsrond' && hasAvvikelse && firstUnhandledDeviationIdx >= 0 && (\n                    <TouchableOpacity\n                      onPress={(e) => {\n                        try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\n                        try { setExpandedChecklist([sectionIdx]); } catch(e) {}\n                        try {\n                          setRemediationModal({\n                            visible: true,\n                            sectionIdx,\n                            pointIdx: firstUnhandledDeviationIdx,\n                            comment: '',\n                            name: '',\n                            date: '',\n                            infoMode: false,\n                          });\n                        } catch(e) {}\n                      }}\n                      style={{ marginLeft: 10, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#FFD600' }}\n                      activeOpacity={0.85}\n                      accessibilityLabel={`Åtgärda avvikelse i ${section.label}`}\n                    >\n                      <Text style={{ color: '#222', fontWeight: '700', fontSize: 13 }}>Åtgärda</Text>\n                    </TouchableOpacity>\n                  )}\n                  {Platform.OS === 'web' && sectionThumbUri && sectionPhotoItems.length > 0 && (\n                    <TouchableOpacity\n                      onPress={(e) => {\n                        try { e && e.stopPropagation && e.stopPropagation(); } catch(e) {}\n                        setPhotoModal({ visible: true, uris: sectionPhotoItems, index: sectionThumbIndex });\n                      }}\n                      style={{ marginLeft: 8 }}\n                      activeOpacity={0.8}\n                      accessibilityLabel={`Visa bilder ${section.label}`}\n                    >\n                      <Image\n                        source={{ uri: sectionThumbUri }}\n                        style={{ width: 28, height: 28, borderRadius: 4, backgroundColor: '#eee' }}\n                        resizeMode=\"cover\"\n                      />\n                    </TouchableOpacity>\n                  )}\n                  {hasPhoto && (\n                    <Ionicons name=\"camera\" size={20} color=\"#1976D2\" style={{ marginLeft: 8 }} />\n                  )}\n                  {/* Section menu button */}\n                  <TouchableOpacity onPress={(e) => { e.stopPropagation && e.stopPropagation(); setSectionMenuIndex(prev => prev === sectionIdx ? null : sectionIdx); }} style={{ marginLeft: 10, padding: 6 }} accessibilityLabel={`Sektion meny ${section.label}`}>\n                    <Ionicons name=\"ellipsis-vertical\" size={18} color=\"#666\" />\n                  </TouchableOpacity>\n                </TouchableOpacity>\n                {sectionMenuIndex === sectionIdx && (\n                  <View style={{ paddingHorizontal: 14, paddingBottom: 8, backgroundColor: '#fff' }}>\n                    <View style={{ flexDirection: 'row', justifyContent: 'flex-end' }}>\n                      <TouchableOpacity onPress={() => markAllOk(sectionIdx)} style={{ marginRight: 12 }}>\n                        <Text style={{ color: '#1976D2' }}>Markera alla OK</Text>\n                      </TouchableOpacity>\n                          {/* Removed \"Radera alla foton\" as requested */}\n                      <TouchableOpacity onPress={() => setSectionMenuIndex(null)}>\n                        <Text style={{ color: '#777' }}>Stäng</Text>\n                      </TouchableOpacity>\n                    </View>\n                  </View>\n                )}\n                {expanded && (\n                  <View style={{ padding: 10, paddingTop: 0 }}>\n                    {section.points.map((point, pointIdx) => {\n                      const photosArr = Array.isArray(section.photos) ? section.photos : [];\n                      const hasPhotos = Array.isArray(photosArr[pointIdx]) && photosArr[pointIdx].length > 0;\n                      const remediation = section.remediation && section.remediation[point] ? section.remediation[point] : null;\n                      const isDeviation = section.statuses[pointIdx] === 'avvikelse';\n                      const isHandled = !!remediation;\n                      const pointText = (typeof point === 'string') ? point : String(point || '');\n                      const actionText = (controlType === 'Arbetsberedning' && Array.isArray(section.comments) && typeof section.comments[pointIdx] === 'string')\n                        ? section.comments[pointIdx]\n                        : '';\n                      return (\n                        <View key={`point-${pointIdx}`} style={{ marginBottom: 0 }}>\n                          <View style={{ flexDirection: 'row', alignItems: controlType === 'Arbetsberedning' ? 'flex-start' : 'center', paddingVertical: 8 }}>\n                            {/* Status button (OK) */}\n                            <TouchableOpacity\n                              onPress={() => {\n                                setChecklist(prev => prev.map((s, sIdx) => {\n                                  if (sIdx !== sectionIdx) return s;\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\n                                  statuses[pointIdx] = statuses[pointIdx] === 'ok' ? null : 'ok';\n                                  return { ...s, statuses };\n                                }));\n                              }}\n                              style={{ marginRight: 10, padding: 6 }}\n                              accessibilityLabel={`Markera ${pointText} som OK`}\n                            >\n                              <Ionicons name={section.statuses[pointIdx] === 'ok' ? 'checkmark-circle' : 'ellipse-outline'} size={22} color={section.statuses[pointIdx] === 'ok' ? '#43A047' : '#bbb'} />\n                            </TouchableOpacity>\n                            {/* Status button (Avvikelse) */}\n                            <TouchableOpacity\n                              onPress={() => {\n                                setChecklist(prev => prev.map((s, sIdx) => {\n                                  if (sIdx !== sectionIdx) return s;\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\n                                  statuses[pointIdx] = statuses[pointIdx] === 'avvikelse' ? null : 'avvikelse';\n                                  return { ...s, statuses };\n                                }));\n                              }}\n                              style={{ marginRight: 10, padding: 6 }}\n                              accessibilityLabel={`Markera ${pointText} som avvikelse`}\n                            >\n                              <View style={{ width: 22, height: 22, borderRadius: 11, alignItems: 'center', justifyContent: 'center', backgroundColor: section.statuses[pointIdx] === 'avvikelse' ? '#D32F2F' : 'transparent' }}>\n                                {section.statuses[pointIdx] === 'avvikelse' ? (\n                                  <Ionicons name=\"alert\" size={18} color=\"#fff\" />\n                                ) : (\n                                  <Ionicons name=\"ellipse-outline\" size={22} color=\"#bbb\" />\n                                )}\n                              </View>\n                            </TouchableOpacity>\n                            {/* Status button (Ej aktuell) */}\n                            <TouchableOpacity\n                              onPress={() => {\n                                setChecklist(prev => prev.map((s, sIdx) => {\n                                  if (sIdx !== sectionIdx) return s;\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses] : Array(s.points.length).fill(null);\n                                  statuses[pointIdx] = statuses[pointIdx] === 'ejaktuell' ? null : 'ejaktuell';\n                                  return { ...s, statuses };\n                                }));\n                              }}\n                              style={{ marginRight: 10, padding: 6 }}\n                              accessibilityLabel={`Markera ${pointText} som ej aktuell`}\n                            >\n                              <Ionicons name={section.statuses[pointIdx] === 'ejaktuell' ? 'remove-circle' : 'ellipse-outline'} size={22} color={section.statuses[pointIdx] === 'ejaktuell' ? '#607D8B' : '#bbb'} />\n                            </TouchableOpacity>\n                            {/* Kontrollpunkt text */}\n                            {controlType === 'Arbetsberedning' ? (\n                              <View style={{ flex: 1, marginRight: 10 }}>\n                                <TextInput\n                                  value={pointText}\n                                  onChangeText={(txt) => {\n                                    setChecklist(prev => prev.map((s, sIdx) => {\n                                      if (sIdx !== sectionIdx) return s;\n                                      const pointsArr = Array.isArray(s.points) ? [...s.points] : [];\n                                      if (pointIdx < 0 || pointIdx >= pointsArr.length) return s;\n                                      pointsArr[pointIdx] = txt;\n                                      return { ...s, points: pointsArr };\n                                    }));\n                                  }}\n                                  placeholder=\"Risk / moment\"\n                                  placeholderTextColor=\"#888\"\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', color: '#222' }}\n                                  multiline\n                                />\n                                <TextInput\n                                  value={actionText}\n                                  onChangeText={(txt) => {\n                                    setChecklist(prev => prev.map((s, sIdx) => {\n                                      if (sIdx !== sectionIdx) return s;\n                                      const pointsArr = Array.isArray(s.points) ? s.points : [];\n                                      const comments = Array.isArray(s.comments) && s.comments.length === pointsArr.length\n                                        ? [...s.comments]\n                                        : Array(pointsArr.length).fill('');\n                                      comments[pointIdx] = txt;\n                                      return { ...s, comments };\n                                    }));\n                                  }}\n                                  placeholder=\"Åtgärd / hantering (hur ska risken hanteras?)\"\n                                  placeholderTextColor=\"#888\"\n                                  style={{ borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, padding: 10, fontSize: 14, backgroundColor: '#fff', color: '#222', marginTop: 8 }}\n                                  multiline\n                                  textAlignVertical=\"top\"\n                                />\n                              </View>\n                            ) : (\n                              <Text style={{ flex: 1, fontSize: 15, color: '#222' }}>{pointText}</Text>\n                            )}\n                            {/* Photo button */}\n                            <TouchableOpacity\n                              onPress={() => {\n                                if (hasPhotos) {\n                                  setPhotoModal({\n                                    visible: true,\n                                    uris: section.photos[pointIdx].map(uri => (typeof uri === 'string' ? { uri, comment: '' } : uri)),\n                                    index: 0,\n                                    sectionIdx,\n                                    pointIdx,\n                                  });\n                                } else {\n                                  handleNavigateToCamera(sectionIdx, pointIdx, project);\n                                }\n                              }}\n                              style={{ marginLeft: 8, padding: 6 }}\n                              accessibilityLabel={hasPhotos ? `Visa och hantera bilder för ${pointText}` : `Lägg till foto för ${pointText}`}\n                            >\n                              <Ionicons name={hasPhotos ? 'camera' : 'camera-outline'} size={20} color={'#1976D2'} />\n                            </TouchableOpacity>\n                            {/* Åtgärda-knapp / Info för avvikelse (Skyddsrond).\n                                När en åtgärd sparas lagras remediation-info och avvikelsen\n                                betraktas som handlad (visas ej som aktiv varning i header),\n                                men vi sparar åtgärden för spårbarhet. */}\n                            {controlType === 'Skyddsrond' && isDeviation && (\n                              isHandled ? (\n                                <>\n                                  <TouchableOpacity\n                                    onPress={() => {\n                                      try {\n                                        setRemediationModal({\n                                          visible: true,\n                                          sectionIdx,\n                                          pointIdx,\n                                          comment: remediation && remediation.comment ? remediation.comment : '',\n                                          name: remediation && remediation.name ? remediation.name : '',\n                                          date: remediation && remediation.date ? remediation.date : '',\n                                          infoMode: true,\n                                        });\n                                      } catch(e) {}\n                                    }}\n                                    style={{ marginLeft: 8, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, backgroundColor: '#E8F5E9' }}\n                                    accessibilityLabel={`Visa åtgärdsinfo för ${pointText}`}\n                                  >\n                                    <Text style={{ color: '#388E3C', fontSize: 13, fontWeight: '600' }}>Info</Text>\n                                  </TouchableOpacity>\n                                  <Text style={{ marginLeft: 8, color: '#388E3C', fontSize: 12 }}>\n                                    Åtgärdad {remediation.date ? remediation.date.slice(0, 10) : ''} av {remediation.name || ''}\n                                  </Text>\n                                </>\n                              ) : (\n                                <TouchableOpacity\n                                  onPress={() => {\n                                    try {\n                                      setRemediationModal({ visible: true, sectionIdx, pointIdx, comment: '', name: '', date: '', infoMode: false });\n                                    } catch(e) {}\n                                  }}\n                                  style={{ marginLeft: 8, paddingVertical: 6, paddingHorizontal: 10, borderRadius: 8, borderWidth: 0, backgroundColor: '#FFD600' }}\n                                  accessibilityLabel={`Åtgärda avvikelse för ${pointText}`}\n                                >\n                                  <Text style={{ color: '#222', fontSize: 13, fontWeight: '700' }}>Åtgärda</Text>\n                                </TouchableOpacity>\n                              )\n                            )}\n                          </View>\n                          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 6, marginBottom: 6 }} />\n                        </View>\n                      );\n                    })}\n                    {/* Add custom checklist point button */}\n                    <TouchableOpacity\n                      style={{ flexDirection: 'row', alignItems: 'center', marginTop: 8, marginBottom: 8 }}\n                      onPress={() => {\n                        setAddPointModal({ visible: true, sectionIdx });\n                        setNewPointText('');\n                        setNewPointActionText('');\n                      }}\n                      accessibilityLabel=\"Lägg till kontrollpunkt\"\n                    >\n                      <Text style={{ fontSize: 20, color: '#1976D2', marginRight: 4 }}>+</Text>\n                      <Text style={{ color: '#1976D2', fontWeight: 'bold' }}>Lägg till kontrollpunkt</Text>\n                    </TouchableOpacity>\n                    {/* Modal for adding a new checklist point */}\n                    {addPointModal.visible && addPointModal.sectionIdx === sectionIdx && (\n                      <Modal\n                        visible={addPointModal.visible}\n                        transparent\n                        animationType=\"fade\"\n                        onRequestClose={() => {\n                          setAddPointModal({ visible: false, sectionIdx: null });\n                          setNewPointText('');\n                          setNewPointActionText('');\n                        }}\n                      >\n                        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.3)', justifyContent: 'center', alignItems: 'center' }}>\n                          <View style={{ backgroundColor: '#fff', borderRadius: 10, padding: 20, width: '80%', elevation: 5 }}>\n                            <Text style={{ fontWeight: 'bold', fontSize: 16, marginBottom: 8 }}>Ny kontrollpunkt</Text>\n                            <TextInput\n                              value={newPointText}\n                              onChangeText={setNewPointText}\n                              placeholder={controlType === 'Arbetsberedning' ? 'Risk / moment' : 'Skriv rubrik på kontrollpunkt'}\n                              style={{ borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 8, fontSize: 16, backgroundColor: '#fafafa' }}\n                              autoFocus\n                            />\n                            {controlType === 'Arbetsberedning' && (\n                              <TextInput\n                                value={newPointActionText}\n                                onChangeText={setNewPointActionText}\n                                placeholder=\"Åtgärd / hantering (hur ska risken hanteras?)\"\n                                style={{ borderWidth: 1, borderColor: '#ccc', borderRadius: 6, padding: 8, fontSize: 16, backgroundColor: '#fafafa', marginTop: 10 }}\n                                multiline\n                                textAlignVertical=\"top\"\n                              />\n                            )}\n                            <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 12 }}>\n                              <TouchableOpacity onPress={() => {\n                                setAddPointModal({ visible: false, sectionIdx: null });\n                                setNewPointText('');\n                                setNewPointActionText('');\n                              }} style={{ marginRight: 16 }}>\n                                <Text style={{ color: '#1976D2' }}>Avbryt</Text>\n                              </TouchableOpacity>\n                              <TouchableOpacity onPress={() => {\n                                if (!newPointText.trim()) return;\n                                setChecklist(prev => prev.map((s, sIdx) => {\n                                  if (sIdx !== sectionIdx) return s;\n                                  const points = [...s.points, newPointText.trim()];\n                                  const statuses = Array.isArray(s.statuses) ? [...s.statuses, null] : Array(points.length).fill(null);\n                                  const photos = Array.isArray(s.photos) ? [...s.photos, []] : Array(points.length).fill([]);\n                                  if (controlType === 'Arbetsberedning') {\n                                    const comments = Array.isArray(s.comments) ? [...s.comments, String(newPointActionText || '')] : Array(points.length).fill('');\n                                    if (comments.length === points.length) {\n                                      comments[points.length - 1] = String(newPointActionText || '');\n                                    }\n                                    return { ...s, points, statuses, photos, comments };\n                                  }\n                                  return { ...s, points, statuses, photos };\n                                }));\n                                setAddPointModal({ visible: false, sectionIdx: null });\n                                setNewPointText('');\n                                setNewPointActionText('');\n                              }}>\n                                <Text style={{ color: '#1976D2', fontWeight: 'bold' }}>Lägg till</Text>\n                              </TouchableOpacity>\n                            </View>\n                          </View>\n                        </View>\n                      </Modal>\n                    )}\n                  </View>\n                )}\n              </View>\n            );\n          })}\n          {/* Divider under checklist */}\n          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 8 }} />\n\n          {/* Summary under checklist */}\n          {(() => {\n            // Count sections\n            const numSections = checklist.length;\n            // Count all points\n            let totalPoints = 0;\n            let approvedPoints = 0;\n            let deviationPoints = 0;\n            let completedSections = 0;\n            checklist.forEach((section, sectionIdx) => {\n              totalPoints += (section.points || []).length;\n              const statuses = checklist[sectionIdx]?.statuses || [];\n              let allFilled = true;\n              (section.points || []).forEach((_, pointIdx) => {\n                if (statuses[pointIdx] === 'ok') approvedPoints++;\n                // Count only unhandled deviations\n                if (statuses[pointIdx] === 'avvikelse' && !(section.remediation && section.remediation[section.points[pointIdx]])) deviationPoints++;\n                if (!statuses[pointIdx]) allFilled = false;\n              });\n              if ((section.points || []).length > 0 && allFilled) completedSections++;\n            });\n            return (\n              <View style={{ marginTop: 16, marginBottom: 8, padding: 16, backgroundColor: '#f5f5f5', borderRadius: 10, borderWidth: 1, borderColor: '#e0e0e0' }}>\n                <Text style={{ fontSize: 16, fontWeight: 'bold', color: '#222', marginBottom: 4 }}>\n                  Sammanställning\n                </Text>\n                <Text style={{ fontSize: 15, color: '#222', marginBottom: 2 }}>\n                  Gått igenom: {completedSections} av {numSections} områden\n                </Text>\n                <Text style={{ fontSize: 15, color: '#43A047', marginBottom: 2 }}>\n                  Godkända kontrollpunkter: {approvedPoints} av {totalPoints}\n                </Text>\n                <Text style={{ fontSize: 15, color: deviationPoints > 0 ? '#FFD600' : '#222' }}>\n                  Avvikelser: {deviationPoints}\n                </Text>\n              </View>\n            );\n          })()}\n        </View>\n      )}\n          {/* Centralized photos (for Mottagningskontroll) */}\n          {controlType === 'Mottagningskontroll' && (\n            <View style={{ paddingHorizontal: 16, marginTop: 8 }}>\n              <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 12 }} />\n              <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                <Text style={{ fontSize: 15, color: '#222', fontWeight: '600' }}>Foton</Text>\n                {(!Array.isArray(mottagningsPhotos) || mottagningsPhotos.length === 0) && (\n                  <Text style={{ fontSize: 12, color: '#666', fontWeight: '400', marginLeft: 6 }}>(valfritt)</Text>\n                )}\n                {/* Debug: show count of mottagningsPhotos */}\n                <View style={{ marginLeft: 10 }}>\n                  <Text style={{ fontSize: 12, color: '#1976D2' }}>{`Bilder: ${Array.isArray(mottagningsPhotos) ? mottagningsPhotos.length : 0}`}</Text>\n                  {/* Removed verbose file path display (Senast: file://...) per UX request */}\n                </View>\n              </View>\n              <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'flex-start', marginTop: 8 }}>\n                <TouchableOpacity onPress={() => setShowPhotoChoice(true)} style={{ flexDirection: 'row', alignItems: 'center', paddingVertical: 8, paddingHorizontal: 10, borderRadius: 8, borderWidth: 1, borderColor: '#000', backgroundColor: 'transparent' }}>\n                  <Ionicons name=\"camera\" size={20} color=\"#000\" style={{ marginRight: 8 }} />\n                  <Text style={{ color: '#000', fontWeight: '600' }}>Lägg till foto</Text>\n                </TouchableOpacity>\n              </View>\n              {Array.isArray(mottagningsPhotos) && mottagningsPhotos.length > 0 && (\n                <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginTop: 8 }}>\n                  {mottagningsPhotos.map((uri, idx) => (\n                    <TouchableOpacity key={`m-photo-${idx}-${(uri && uri.uri) ? uri.uri.substring(uri.uri.length-8) : idx}`} onPress={() => setPhotoModal({ visible: true, uris: mottagningsPhotos, index: idx })} activeOpacity={0.85} style={{ marginRight: 8 }}>\n                      <Image source={{ uri: uri && uri.uri ? uri.uri : uri }} style={{ width: 84, height: 84, borderRadius: 8, borderWidth: 1, borderColor: '#ddd', backgroundColor: '#eee' }} />\n                      {uri && uri.comment ? (\n                        <View style={{ position: 'absolute', left: 6, right: 6, bottom: 6, backgroundColor: 'rgba(0,0,0,0.45)', paddingVertical: 2, paddingHorizontal: 6, borderRadius: 6 }}>\n                          <Text numberOfLines={1} style={{ color: '#fff', fontSize: 12 }}>{uri.comment}</Text>\n                        </View>\n                      ) : null}\n                    </TouchableOpacity>\n                  ))}\n                </ScrollView>\n              )}\n            </View>\n          )}\n      {(controlType === 'Mottagningskontroll' || controlType === 'Skyddsrond' || controlType === 'Riskbedömning') && (\n        <View style={{ paddingHorizontal: 16, marginTop: 12 }}>\n          <View style={{ height: 1, backgroundColor: '#e0e0e0', width: '100%', marginTop: 8, marginBottom: 12 }} />\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', width: '100%' }}>\n            <Text style={{ fontSize: 15, color: (missingFields && (missingFields.includes('Signaturer') || missingFields.includes('Signatur'))) ? '#D32F2F' : '#222', fontWeight: '600', marginBottom: 8 }}>Signaturer</Text>\n            <TouchableOpacity onPress={() => setShowAddSignerModal(true)} style={{ paddingHorizontal: 8, paddingVertical: 4 }}>\n              <Text style={{ color: '#1976D2' }}>Lägg till signerare</Text>\n            </TouchableOpacity>\n          </View>\n          {localParticipants && localParticipants.length > 0 ? (\n            localParticipants.map((p, pIdx) => {\n              const name = (typeof p === 'object' && p !== null) ? (p.name || `${p.company || ''}`) : (p || `${participantsLabel} ${pIdx+1}`);\n              const existing = (mottagningsSignatures || []).find(s => s.name === name);\n              return (\n                <View key={`sig-${pIdx}-${name}`} style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>\n                  <Text style={{ fontSize: 15, color: '#222' }}>{name}</Text>\n                  <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n                    {existing ? (\n                      <>\n                        {existing.strokes ? (\n                          <Svg width={120} height={48} viewBox={`0 0 ${sigCanvasSize} ${sigCanvasSize / 2}`} style={{ marginRight: 8 }}>\n                            {existing.strokes.map((stroke, si) => (\n                              <Path\n                                key={`ps-${si}`}\n                                d={pointsToPath(stroke)}\n                                fill=\"none\"\n                                stroke=\"#000\"\n                                strokeWidth={2}\n                                strokeLinecap=\"round\"\n                                strokeLinejoin=\"round\"\n                              />\n                            ))}\n                          </Svg>\n                        ) : (\n                          <Image source={{ uri: existing.uri }} style={{ width: 120, height: 48, borderRadius: 6, marginRight: 8, borderWidth: 1, borderColor: '#e0e0e0' }} />\n                        )}\n                        <TouchableOpacity onPress={() => { const v = existing.strokes || []; setSignatureForIndex(pIdx); setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingHorizontal: 10, paddingVertical: 6, marginRight: 8 }}>\n                          <Text style={{ color: '#1976D2' }}>Byt</Text>\n                        </TouchableOpacity>\n                        <TouchableOpacity onPress={() => setMottagningsSignatures(prev => prev.filter(s => s.name !== name))} style={{ paddingHorizontal: 10, paddingVertical: 6 }}>\n                          <Text style={{ color: '#D32F2F' }}>Ta bort</Text>\n                        </TouchableOpacity>\n                      </>\n                    ) : (\n                      <TouchableOpacity onPress={() => { setSignatureForIndex(pIdx); const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingHorizontal: 6, paddingVertical: 2 }} accessibilityLabel=\"Lägg till signatur\">\n                        <Ionicons name=\"add-circle-outline\" size={24} color=\"#1976D2\" />\n                      </TouchableOpacity>\n                    )}\n                  </View>\n                </View>\n              );\n            })\n          ) : (\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n              <Text style={{ fontSize: 15, color: '#222' }}>Signatur</Text>\n              <TouchableOpacity onPress={() => { setSignatureForIndex('mottagnings'); const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} }} style={{ paddingVertical: 4, paddingHorizontal: 6 }} accessibilityLabel=\"Lägg till signatur\">\n                <Ionicons name=\"add-circle-outline\" size={28} color=\"#1976D2\" />\n              </TouchableOpacity>\n            </View>\n          )}\n          \n          <Modal visible={showPhotoChoice} transparent animationType=\"fade\" onRequestClose={() => setShowPhotoChoice(false)}>\n            <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.5)', justifyContent: 'center', alignItems: 'center' }}>\n              <View style={{ width: '90%', maxWidth: 420, backgroundColor: '#fff', borderRadius: 12, overflow: 'hidden', elevation: 8, borderWidth: 1, borderColor: '#ddd' }}>\n                    <View style={{ backgroundColor: '#fff', paddingVertical: 12, paddingHorizontal: 16, alignItems: 'center', borderBottomWidth: 1, borderBottomColor: '#eee' }}>\n                      <Text style={{ color: '#000', fontSize: 18, fontWeight: '700' }}>Bifoga bild</Text>\n                    </View>\n                    <View style={{ padding: 16 }}>\n                      <TouchableOpacity onPress={() => { setShowPhotoChoice(false); handleNavigateToCamera(null, null, project); }} style={{ paddingVertical: 12, flexDirection: 'row', alignItems: 'center' }}>\n                        <Ionicons name=\"camera\" size={20} color=\"#000\" style={{ marginRight: 10 }} />\n                        <Text style={{ color: '#1976D2', fontSize: 16 }}>Ta foto</Text>\n                      </TouchableOpacity>\n                      <TouchableOpacity onPress={() => { setShowPhotoChoice(false); setTimeout(() => handlePickFromLibrary(), 200); }} style={{ paddingVertical: 12, flexDirection: 'row', alignItems: 'center' }}>\n                        <Ionicons name=\"images\" size={20} color=\"#000\" style={{ marginRight: 10 }} />\n                        <Text style={{ color: '#1976D2', fontSize: 16 }}>Välj från bibliotek</Text>\n                      </TouchableOpacity>\n                  <View style={{ flexDirection: 'row', justifyContent: 'flex-end', marginTop: 8 }}>\n                    <TouchableOpacity onPress={() => setShowPhotoChoice(false)} style={{ padding: 8 }}>\n                      <Text style={{ color: '#777' }}>Avbryt</Text>\n                    </TouchableOpacity>\n                  </View>\n                </View>\n              </View>\n            </View>\n          </Modal>\n        </View>\n      )}\n      <View style={{\n        flexDirection: 'row',\n        justifyContent: 'space-between',\n        width: '100%',\n        paddingHorizontal: 16,\n        marginTop: 16,\n        marginBottom: 32,\n        backgroundColor: '#fafafa',\n        borderWidth: 1,\n        borderColor: '#e0e0e0',\n        borderRadius: 12,\n        paddingVertical: 10,\n        shadowColor: '#000',\n        shadowOffset: { width: 0, height: 2 },\n        shadowOpacity: 0.06,\n        shadowRadius: 4,\n        elevation: 2,\n      }}>\n        <TouchableOpacity\n          onPress={() => {\n            if (!canFinish && controlType === 'Riskbedömning') {\n              // Build missing fields list\n              const missing = [];\n              if (!dateValue || dateValue.trim().length === 0) missing.push('Datum');\n              if (!Array.isArray(localParticipants) || localParticipants.length === 0) missing.push('Deltagare');\n              if (!deliveryDesc || deliveryDesc.trim().length === 0) missing.push('Beskriv arbetsmoment');\n              if (!Array.isArray(checklist) || checklist.length === 0 || !checklist.every(sec => Array.isArray(sec.statuses) && sec.statuses.length > 0 && sec.statuses.every(s => !!s))) missing.push('Alla kontrollpunkter');\n              if (!Array.isArray(mottagningsSignatures) || mottagningsSignatures.length === 0) missing.push('Signatur');\n              Alert.alert('Kan inte slutföra', 'Följande saknas: ' + missing.join(', '));\n              return;\n            }\n\n            // For Skyddsrond + Mottagningskontroll: show a clear popup of missing fields\n            // instead of doing nothing when canFinish is false (especially important on web).\n            if (!canFinish && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll')) {\n              handleAttemptFinish();\n              return;\n            }\n\n            if (canFinish) {\n              handleAttemptFinish();\n            }\n          }}\n          style={{ flex: 1, alignItems: 'center', marginRight: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0, opacity: canFinish ? 1 : 0.55 }}\n        >\n          <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\n            <Ionicons name=\"checkmark-circle\" size={18} color={(canFinish || (Platform.OS === 'web' && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll'))) ? '#1976D2' : '#AAA'} style={{ marginRight: 8 }} />\n            <Text style={{ color: (canFinish || (Platform.OS === 'web' && (controlType === 'Skyddsrond' || controlType === 'Mottagningskontroll'))) ? '#1976D2' : '#AAA', fontWeight: 'bold', fontSize: 16 }}>\n              {((initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed)) ? 'Spara' : 'Slutför')}\n            </Text>\n          </View>\n        </TouchableOpacity>\n        {((initialValues && (initialValues.status === 'UTFÖRD' || initialValues.completed)) || !isDirtyRef.current) ? (\n          <TouchableOpacity\n            onPress={() => {\n              if (!isDirtyRef.current) {\n                // No changes, exit immediately\n                if (typeof onExit === 'function') onExit();\n                else if (navigation && navigation.goBack) navigation.goBack();\n              } else {\n                setShowCancelEditConfirm(true);\n              }\n            }}\n            style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0 }}\n          >\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\n              <Ionicons name=\"close-circle-outline\" size={18} color=\"#D32F2F\" style={{ marginRight: 8 }} />\n              <Text style={{ color: '#D32F2F', fontWeight: 'bold', fontSize: 16 }}>Avbryt</Text>\n            </View>\n          </TouchableOpacity>\n        ) : (\n          <TouchableOpacity\n            onPress={handleSaveDraft}\n            style={{ flex: 1, alignItems: 'center', marginLeft: 8, backgroundColor: 'transparent', paddingVertical: 14, paddingHorizontal: 0 }}\n          >\n            <View style={{ flexDirection: 'row', alignItems: 'center', justifyContent: 'center' }}>\n              <Ionicons name=\"save-outline\" size={18} color=\"#D32F2F\" style={{ marginRight: 8 }} />\n              <Text style={{ color: '#D32F2F', fontWeight: 'bold', fontSize: 16 }}>Spara utkast</Text>\n            </View>\n          </TouchableOpacity>\n        )}\n\n      {/* Modal for cancel edit confirmation */}\n      <Modal visible={!!showCancelEditConfirm} transparent animationType=\"fade\" onRequestClose={() => setShowCancelEditConfirm(false)}>\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.25)', justifyContent: 'center', alignItems: 'center' }}>\n          <View style={{ backgroundColor: '#fff', borderRadius: 14, padding: 24, width: 300, alignItems: 'center', shadowColor: '#000', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.18, shadowRadius: 8, elevation: 6 }}>\n            <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 16, color: '#222', textAlign: 'center' }}>Vill du verkligen avbryta ändringen?</Text>\n            <View style={{ flexDirection: 'row', justifyContent: 'space-between', width: '100%', marginTop: 12 }}>\n              <TouchableOpacity\n                onPress={() => setShowCancelEditConfirm(false)}\n                style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginRight: 8 }}\n              >\n                <Text style={{ color: '#1976D2', fontWeight: '600' }}>Nej</Text>\n              </TouchableOpacity>\n              <TouchableOpacity\n                onPress={() => {\n                  setShowCancelEditConfirm(false);\n                  setShowBackConfirm(false); // Prevent double modal\n                  try { isDirtyRef.current = false; } catch(e) {}\n                  try { if (blockedNavEvent) blockedNavEvent.current = null; } catch(e) {}\n                  if (typeof onExit === 'function') onExit();\n                  else if (navigation && navigation.goBack) navigation.goBack();\n                }}\n                style={{ flex: 1, alignItems: 'center', paddingVertical: 12, marginLeft: 8 }}\n              >\n                <Text style={{ color: '#D32F2F', fontWeight: '600' }}>Ja, avbryt</Text>\n              </TouchableOpacity>\n            </View>\n          </View>\n        </View>\n      </Modal>\n      </View>\n      {/* Signature Modal (JS fallback) */}\n      <Modal visible={signatureForIndex !== null} transparent animationType=\"slide\" onRequestClose={() => setSignatureForIndex(null)}>\n        <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.45)', justifyContent: 'flex-end', alignItems: 'center', paddingBottom: 12 }}>\n          <View style={{ width: '100%', maxWidth: sigCanvasSize + 32, backgroundColor: '#fff', borderTopLeftRadius: 12, borderTopRightRadius: 12, padding: 12, alignItems: 'center' }}>\n            <Text style={{ fontSize: 18, fontWeight: '600', marginBottom: 8 }}>Signera med fingret</Text>\n            <View style={{ width: sigCanvasSize, height: sigCanvasSize / 2, backgroundColor: '#fff', borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 8, overflow: 'hidden' }} {...panResponder.panHandlers}>\n              <Svg width={sigCanvasSize} height={sigCanvasSize / 2}>\n                {sigStrokes.map((stroke, si) => (\n                  <Path key={`s-${si}`} d={pointsToPath(stroke)} fill=\"none\" stroke=\"#000\" strokeWidth={2} strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n                ))}\n                {sigCurrent && sigCurrent.length > 0 && (\n                  <Path d={pointsToPath(sigCurrent)} fill=\"none\" stroke=\"#000\" strokeWidth={2} strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n                )}\n              </Svg>\n            </View>\n            <View style={{ flexDirection: 'row', marginTop: 12, width: '100%', justifyContent: 'space-between' }}>\n              <TouchableOpacity onPress={() => { const v = []; setSigStrokes(v); try { sigStrokesRef.current = v; } catch(e) {} setSigCurrent([]); }} style={{ padding: 10 }}>\n                <Text style={{ color: '#D32F2F' }}>Rensa</Text>\n              </TouchableOpacity>\n              <View style={{ flexDirection: 'row' }}>\n                <TouchableOpacity onPress={() => setSignatureForIndex(null)} style={{ padding: 10, marginRight: 8 }}>\n                  <Text style={{ color: '#777' }}>Avbryt</Text>\n                </TouchableOpacity>\n                <TouchableOpacity onPress={() => {\n                  try {\n                    const strokesToSave = Array.isArray(sigStrokesRef.current) ? sigStrokesRef.current : sigStrokes;\n                    // Save signature strokes for participant or generic\n                    if (signatureForIndex === 'mottagnings') {\n                      setMottagningsSignatures(prev => [...(prev || []), { name: 'Signerad', strokes: strokesToSave }]);\n                    } else if (typeof signatureForIndex === 'number') {\n                      const p = localParticipants[signatureForIndex];\n                      const name = (typeof p === 'object' && p !== null) ? (p.name || `${p.company || ''}`) : (p || `${participantsLabel} ${signatureForIndex+1}`);\n                      setMottagningsSignatures(prev => {\n                        const others = (prev || []).filter(s => s.name !== name);\n                        return [...others, { name, strokes: strokesToSave }];\n                      });\n                    }\n                    // Reset local signature drawing state and close modal\n                    const v = [];\n                    setSigStrokes(v);\n                    try { sigStrokesRef.current = v; } catch(e) {}\n                    setSigCurrent([]);\n                    setSignatureForIndex(null);\n                  } catch(e) {}\n                }} style={{ padding: 10 }}>\n                  <Text style={{ color: '#1976D2', fontWeight: '600' }}>OK</Text>\n                </TouchableOpacity>\n                \n              </View>\n            </View>\n          </View>\n        </View>\n      </Modal>\n    </View>\n  </View>\n  </ScrollView>\n  </>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ContextMenu.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ControlPreview.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ErrorBoundary.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/HeaderComponents.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useMemo has a missing dependency: 'route.params'. Either include it or remove the dependency array.","line":77,"column":6,"nodeType":"ArrayExpression","endLine":77,"endColumn":46,"suggestions":[{"desc":"Update the dependencies array to be: [route.params, query]","fix":{"range":[2699,2739],"text":"[route.params, query]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useMemo has a missing dependency: 'route.params'. Either include it or remove the dependency array.","line":84,"column":6,"nodeType":"ArrayExpression","endLine":84,"endColumn":48,"suggestions":[{"desc":"Update the dependencies array to be: [route.params]","fix":{"range":[2983,3025],"text":"[route.params]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport React from 'react';\nimport { Image, Platform, Text, TextInput, TouchableOpacity, View } from 'react-native';\n\nimport { resolveCompanyLogoUrl } from './firebase';\n\nexport function CompanyHeaderLogo({ companyId }) {\n  const [logoUrl, setLogoUrl] = React.useState(null);\n\n  React.useEffect(() => {\n    let active = true;\n    (async () => {\n      try {\n        const stored = await AsyncStorage.getItem('dk_companyId');\n        let cid = String(companyId || '').trim() || String(stored || '').trim();\n        // On web also try window.localStorage in case AsyncStorage isn't populated\n        try {\n          if ((!cid || cid === '') && typeof window !== 'undefined' && window.localStorage) {\n            cid = String(window.localStorage.getItem('dk_companyId') || '').trim();\n          }\n        } catch (_e) {}\n        if (!cid) {\n          if (active) setLogoUrl(null);\n          return;\n        }\n        const url = await resolveCompanyLogoUrl(cid);\n        if (active) setLogoUrl(url || null);\n      } catch (_e) {\n        if (active) setLogoUrl(null);\n      }\n    })();\n    return () => { active = false; };\n  }, [companyId]);\n\n    return (\n    logoUrl ? (\n      <Image\n        source={{ uri: logoUrl }}\n        style={{ width: 250, height: 60 }}\n        resizeMode=\"contain\"\n        accessibilityLabel=\"Företagslogotyp\"\n      />\n    ) : null\n  );\n}\n\nexport function DigitalKontrollHeaderLogo() {\n  return (\n    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\n      <Image\n        source={Platform.OS === 'web'\n          ? require('../assets/images/app.icon.webb.png')\n          : require('../assets/images/app.icon.png')}\n        style={{ width: 40, height: 40, marginRight: 10 }}\n        resizeMode=\"contain\"\n        accessibilityLabel=\"DigitalKontroll ikon\"\n      />\n      <Text style={{ fontSize: 20, color: '#111', fontFamily: 'Inter_700Bold' }}>DigitalKontroll</Text>\n    </View>\n  );\n}\n\nexport function HomeHeaderSearch({ navigation, route }) {\n  const query = String(route?.params?.headerProjectSearchText || '');\n  const [isFocused, setIsFocused] = React.useState(false);\n  const containerRef = React.useRef(null);\n  const [measuredWidth, setMeasuredWidth] = React.useState(null);\n\n  // Determine whether header search dropdown is considered open.\n  // Prefer explicit route param when present, otherwise fall back to query presence.\n  const headerSearchOpen = React.useMemo(() => {\n    if (Object.prototype.hasOwnProperty.call(route?.params || {}, 'headerSearchOpen')) {\n      return !!route.params.headerSearchOpen;\n    }\n    return !!query;\n  }, [route?.params?.headerSearchOpen, query]);\n\n  const headerSearchKeepConnected = React.useMemo(() => {\n    if (Object.prototype.hasOwnProperty.call(route?.params || {}, 'headerSearchKeepConnected')) {\n      return !!route.params.headerSearchKeepConnected;\n    }\n    return false;\n  }, [route?.params?.headerSearchKeepConnected]);\n\n  const setHeaderSearchParams = React.useCallback((params) => {\n    if (Platform.OS !== 'web') return;\n    try { navigation?.setParams?.(params); } catch (_e) {}\n  }, [navigation]);\n\n  React.useEffect(() => {\n    if (measuredWidth) {\n      setHeaderSearchParams({ headerSearchWidth: measuredWidth });\n    }\n  }, [measuredWidth, setHeaderSearchParams]);\n\n  const measureAbsolute = React.useCallback(() => {\n    try {\n      const node = containerRef.current;\n      if (node && typeof node.measureInWindow === 'function') {\n        node.measureInWindow((x, y, w, h) => {\n          if (typeof w === 'number' && w > 0) setMeasuredWidth(prev => (prev && Math.abs(prev - w) < 1 ? prev : w));\n          const bottomY = (y || 0) + (h || 0) - 1;\n          const leftX = (x || 0);\n          setHeaderSearchParams({ headerSearchWidth: w, headerSearchBottom: bottomY, headerSearchLeft: leftX, headerSearchTop: y || 0 });\n        });\n      }\n    } catch (_e) {}\n  }, [setHeaderSearchParams]);\n\n  React.useEffect(() => {\n    if (Platform.OS === 'web') {\n      const timer = setTimeout(measureAbsolute, 50);\n      return () => clearTimeout(timer);\n    }\n  }, [measureAbsolute, query]);\n\n  React.useEffect(() => {\n    if (Platform.OS !== 'web') return;\n    const onResize = () => measureAbsolute();\n    try { window.addEventListener('resize', onResize); } catch (_e) {}\n    return () => { try { window.removeEventListener('resize', onResize); } catch (_e) {} };\n  }, [measureAbsolute]);\n\n  const submitSearch = React.useCallback(() => {\n    try {\n      const q = String(query || '').trim();\n      setHeaderSearchParams({ headerProjectSearchText: q, headerSearchOpen: true });\n    } catch (_e) {}\n  }, [setHeaderSearchParams, query]);\n\n  return (\n    <View\n      ref={containerRef}\n      onLayout={(e) => {\n        const w = e?.nativeEvent?.layout?.width;\n        if (typeof w === 'number' && w > 0) {\n          if (!measuredWidth || Math.abs(measuredWidth - w) > 1) setMeasuredWidth(w);\n        }\n        measureAbsolute();\n      }}\n      style={{ width: '100%', maxWidth: 720, minWidth: 260 }}\n    >\n      <View\n          style={{\n            height: 46,\n            borderWidth: 1,\n            borderColor: (isFocused || headerSearchKeepConnected) ? '#666' : '#e0e0e0',\n            borderTopLeftRadius: 16,\n            borderTopRightRadius: 16,\n            borderBottomLeftRadius: (headerSearchOpen || headerSearchKeepConnected) ? 0 : 16,\n            borderBottomRightRadius: (headerSearchOpen || headerSearchKeepConnected) ? 0 : 16,\n            borderBottomWidth: (headerSearchOpen || headerSearchKeepConnected) ? 0 : 1,\n            backgroundColor: '#fff',\n            paddingHorizontal: 14,\n            flexDirection: 'row',\n            alignItems: 'center',\n          }}\n      >\n        <TouchableOpacity\n          onPress={submitSearch}\n          activeOpacity={0.7}\n          hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}\n          style={{ marginRight: 10 }}\n          accessibilityLabel=\"Sök\"\n        >\n          <Ionicons name=\"search\" size={18} color=\"#666\" />\n        </TouchableOpacity>\n\n        <TextInput\n          value={query}\n          onChangeText={(t) => {\n            setHeaderSearchParams({ headerProjectSearchText: t, headerSearchOpen: true });\n          }}\n          placeholder=\"Sök projekt…\"\n          placeholderTextColor=\"#888\"\n          style={{\n            flex: 1,\n            minWidth: 0,\n            fontSize: 15,\n            color: '#222',\n            paddingVertical: 0,\n            fontFamily: 'Inter_400Regular',\n            fontWeight: '400',\n            ...(Platform.OS === 'web'\n              ? { outlineStyle: 'none', outlineWidth: 0 }\n              : null),\n          }}\n          returnKeyType=\"search\"\n          onSubmitEditing={submitSearch}\n          onFocus={() => {\n            setIsFocused(true);\n            setHeaderSearchParams({ headerSearchOpen: true, headerSearchKeepConnected: false });\n          }}\n          onBlur={() => {\n            setIsFocused(false);\n            setHeaderSearchParams({ headerSearchOpen: false });\n          }}\n          autoCorrect={false}\n          autoCapitalize=\"none\"\n        />\n      </View>\n    </View>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/HeaderDisplayName.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/HeaderUserMenu.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'spinChevron' is assigned a value but never used.","line":22,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"spinChevron"},"fix":{"range":[928,939],"text":""},"desc":"Remove unused variable 'spinChevron'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'cid' is assigned a value but never used.","line":50,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"cid"},"fix":{"range":[2479,2482],"text":""},"desc":"Remove unused variable 'cid'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { useNavigation } from '@react-navigation/native';\nimport { useEffect, useRef, useState } from 'react';\nimport { Animated, Easing, Platform, Text, TouchableOpacity, View } from 'react-native';\nimport ContextMenu from './ContextMenu';\nimport { auth } from './firebase';\nimport { formatPersonName } from './formatPersonName';\n\nlet createPortal = null;\nif (Platform.OS === 'web') {\n  try { createPortal = require('react-dom').createPortal; } catch(_e) { createPortal = null; }\n}\nlet portalRootId = 'dk-header-portal';\n\nexport default function HeaderUserMenu() {\n  const navigation = useNavigation();\n  const btnRef = useRef(null);\n  const [menuVisible, setMenuVisible] = useState(false);\n  const [menuPos, setMenuPos] = useState({ x: 20, y: 64 });\n  const [roleLabel, setRoleLabel] = useState('');\n  const [spinChevron, setSpinChevron] = useState(0);\n  const chevronSpinAnim = useRef(new Animated.Value(0)).current;\n  const chevronDeg = useRef(0);\n\n  const openMenu = () => {\n    try {\n      const node = btnRef.current;\n      if (node && typeof node.measureInWindow === 'function') {\n        node.measureInWindow((x, y, w, h) => {\n          setMenuPos({ x: Math.max(8, x), y: y + (h || 36) + 6 });\n          // spin chevron and open menu\n          try { chevronDeg.current = (chevronDeg.current || 0) + 360; Animated.timing(chevronSpinAnim, { toValue: chevronDeg.current, duration: 350, easing: Easing.out(Easing.ease), useNativeDriver: (Platform && Platform.OS === 'web') ? false : true }).start(); } catch(_e) {}\n          setSpinChevron((n) => n + 1);\n          setMenuVisible(true);\n        });\n        return;\n      }\n    } catch(_e) {}\n    try { chevronDeg.current = (chevronDeg.current || 0) + 360; Animated.timing(chevronSpinAnim, { toValue: chevronDeg.current, duration: 350, easing: Easing.out(Easing.ease), useNativeDriver: (Platform && Platform.OS === 'web') ? false : true }).start(); } catch(_e) {}\n    setSpinChevron((n) => n + 1);\n    setMenuVisible(true);\n  };\n\n  const displayName = (auth && auth.currentUser) ? formatPersonName(auth.currentUser.displayName || auth.currentUser.email || '') : 'Användare';\n  const [isOwner, setIsOwner] = useState(false);\n  const [isMsAdmin, setIsMsAdmin] = useState(false);\n  const [isCompanyAdmin, setIsCompanyAdmin] = useState(false);\n  const [isSuperadmin, setIsSuperadmin] = useState(false);\n  const [cid, setCid] = useState('');\n\n  useEffect(() => {\n    let active = true;\n    (async () => {\n      try {\n        const email = String(auth?.currentUser?.email || '').toLowerCase();\n        if (!active) return;\n        setIsOwner(email === 'marcus@msbyggsystem.se' || email === 'marcus.skogh@msbyggsystem.se');\n        // Try to read claims and local fallback for companyId\n        let tokenRes = null;\n        try { tokenRes = await auth.currentUser?.getIdTokenResult(true).catch(() => null); } catch(_e) { tokenRes = null; }\n        const claims = tokenRes?.claims || {};\n        const companyFromClaims = String(claims?.companyId || '').trim();\n        const stored = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n        const companyId = companyFromClaims || stored || '';\n        setCid(companyId);\n        const adminClaim = !!(claims && (claims.admin === true || claims.role === 'admin'));\n        if (!active) return;\n        // MS Byggsystem-admin (behörighet till globala företagsverktyg)\n        setIsMsAdmin(adminClaim && companyId === 'MS Byggsystem');\n        // Admin i valfritt företag (ska kunna hantera sina egna användare)\n        setIsCompanyAdmin(adminClaim);\n\n        // Beräkna rolltext och superadmin-flagga för headern\n        const emailLower = email;\n        const isEmailSuperadmin = emailLower === 'marcus@msbyggsystem.se' || emailLower === 'marcus.skogh@msbyggsystem.se' || emailLower === 'marcus.skogh@msbyggsystem.com' || emailLower === 'marcus.skogh@msbyggsystem';\n        const superadminFlag = !!(claims.superadmin === true || claims.role === 'superadmin' || isEmailSuperadmin);\n        const isAdmin = !!(claims.admin === true || claims.role === 'admin');\n        let label = '';\n        if (superadminFlag) label = 'Superadmin';\n        else if (isAdmin) label = 'Admin';\n        else label = 'Användare';\n        if (active) {\n          setRoleLabel(label);\n          setIsSuperadmin(superadminFlag);\n        }\n      } catch(_e) {}\n    })();\n    return () => { active = false; };\n  }, []);\n\n  const menuItems = [];\n  const isSuperOrMsAdmin = isOwner || isMsAdmin;\n  // För superadmin: visa samma admin-menypunkter som tidigare\n  if (isSuperadmin) {\n    if (isSuperOrMsAdmin) {\n      menuItems.push({ key: 'manage_company', label: 'Företag', icon: <Ionicons name=\"business\" size={16} color=\"#2E7D32\" /> });\n    }\n    if (isOwner || isCompanyAdmin) {\n      menuItems.push({ key: 'manage_users', label: 'Användare', icon: <Ionicons name=\"person\" size={16} color=\"#1976D2\" /> });\n      menuItems.push({ key: 'manage_control_types', label: 'Kontrolltyper', icon: <Ionicons name=\"options-outline\" size={16} color=\"#6A1B9A\" /> });\n      menuItems.push({ key: 'manage_templates', label: 'Mallar', icon: <Ionicons name=\"copy-outline\" size={16} color=\"#00897B\" /> });\n    }\n  }\n\n  // Alla roller (superadmin, admin, användare) ska kunna logga ut här\n  menuItems.push({ key: 'logout', label: 'Logga ut', icon: <Ionicons name=\"log-out-outline\" size={16} color=\"#D32F2F\" /> });\n\n  const PortalContent = (\n    <ContextMenu\n      visible={menuVisible}\n      x={menuPos.x}\n      y={menuPos.y}\n      items={menuItems}\n      onClose={() => setMenuVisible(false)}\n      onSelect={async (it) => {\n        try {\n          setMenuVisible(false);\n          if (!it) return;\n          const cid = String(await AsyncStorage.getItem('dk_companyId') || '').trim();\n          if (it.key === 'manage_company') return navigation.navigate('ManageCompany');\n          if (it.key === 'manage_users') return navigation.navigate('ManageUsers', { companyId: cid });\n          if (it.key === 'manage_control_types') return navigation.navigate('ManageControlTypes', { companyId: cid });\n          if (it.key === 'manage_templates') return navigation.navigate('ManageTemplates', { companyId: cid });\n          if (it.key === 'logout') {\n            try { await AsyncStorage.removeItem('dk_companyId'); } catch(_e) {}\n            try { await auth.signOut(); } catch(_e) {}\n            try {\n              navigation.reset({ index: 0, routes: [{ name: 'Login' }] });\n            } catch(_e) {\n              try { navigation.navigate('Login'); } catch(__e) {}\n            }\n            return;\n          }\n        } catch(_e) {}\n      }}\n    />\n  );\n\n  return (\n    <>\n      <TouchableOpacity ref={btnRef} onPress={openMenu} style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}>\n        <View style={{ width: 30, height: 30, borderRadius: 15, backgroundColor: '#4caf50', alignItems: 'center', justifyContent: 'center' }}>\n          <Ionicons name=\"person\" size={16} color=\"#fff\" />\n        </View>\n        <View style={{ flexDirection: 'column' }}>\n          <Text style={{ fontSize: 16, color: '#263238', fontWeight: '600' }}>{displayName}</Text>\n          {!!roleLabel && (\n            <Text style={{ fontSize: 12, color: '#607D8B', marginTop: 2 }}>{roleLabel}</Text>\n          )}\n        </View>\n        <Animated.View style={{ marginLeft: 6, transform: [\n          { rotate: chevronSpinAnim.interpolate({ inputRange: [0, 360], outputRange: ['0deg', '360deg'] }) },\n          { rotate: menuVisible ? '180deg' : '0deg' }\n        ] }}>\n          <Ionicons name=\"chevron-down\" size={14} color=\"#666\" />\n        </Animated.View>\n      </TouchableOpacity>\n      {Platform.OS === 'web' && createPortal && typeof document !== 'undefined' ? (() => {\n        try {\n          let portalRoot = document.getElementById(portalRootId);\n          if (!portalRoot) {\n            portalRoot = document.createElement('div');\n            portalRoot.id = portalRootId;\n            portalRoot.style.position = 'relative';\n            document.body.appendChild(portalRoot);\n          }\n          return createPortal(PortalContent, portalRoot);\n        } catch(_e) { return PortalContent; }\n      })() : PortalContent}\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/HeaderUserMenuConditional.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/InfoPopup.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/MainLayout.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/NativeSignatureModal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ProjectSidebar.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'spinAdd' is assigned a value but never used.","line":37,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"spinAdd"},"fix":{"range":[2720,2727],"text":""},"desc":"Remove unused variable 'spinAdd'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setSpinAdd' is assigned a value but never used.","line":37,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSpinAdd"},"fix":{"range":[2727,2739],"text":""},"desc":"Remove unused variable 'setSpinAdd'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'templateFetchErrors' is assigned a value but never used.","line":53,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"templateFetchErrors"},"fix":{"range":[3719,3738],"text":""},"desc":"Remove unused variable 'templateFetchErrors'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":61,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":73,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":99,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":109,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":109,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":122,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":122,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":141,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":141,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":154,"column":99,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":100},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'companyId'. Either include it or remove the dependency array.","line":169,"column":6,"nodeType":"ArrayExpression","endLine":169,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [companiesMode, companyId, restrictCompanyId]","fix":{"range":[8015,8049],"text":"[companiesMode, companyId, restrictCompanyId]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":205,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":205,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":262,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":262,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":322,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":322,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":446,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":446,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":483,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":483,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":573,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":573,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'handleShowAuthDebug' is assigned a value but never used.","line":589,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":589,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleShowAuthDebug"},"fix":{"range":[25397,26005],"text":""},"desc":"Remove unused variable 'handleShowAuthDebug'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":901,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":901,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1057,"column":119,"nodeType":"Identifier","messageId":"unusedVar","endLine":1057,"endColumn":120},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1061,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":1061,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1097,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":1097,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1126,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":1126,"endColumn":41},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1160,"column":124,"nodeType":"Identifier","messageId":"unusedVar","endLine":1160,"endColumn":125},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1171,"column":112,"nodeType":"Identifier","messageId":"unusedVar","endLine":1171,"endColumn":113},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1175,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":1175,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1199,"column":97,"nodeType":"Identifier","messageId":"unusedVar","endLine":1199,"endColumn":98},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1203,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":1203,"endColumn":38},{"ruleId":"no-unused-vars","severity":1,"message":"'isHidden' is assigned a value but never used.","line":1254,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":1254,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"isHidden"},"fix":{"range":[62687,62717],"text":""},"desc":"Remove unused variable 'isHidden'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1914,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":1914,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1919,"column":86,"nodeType":"Identifier","messageId":"unusedVar","endLine":1919,"endColumn":87},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1964,"column":197,"nodeType":"Identifier","messageId":"unusedVar","endLine":1964,"endColumn":198},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1967,"column":107,"nodeType":"Identifier","messageId":"unusedVar","endLine":1967,"endColumn":108},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1973,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":1973,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1977,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":1977,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1980,"column":111,"nodeType":"Identifier","messageId":"unusedVar","endLine":1980,"endColumn":112},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1988,"column":104,"nodeType":"Identifier","messageId":"unusedVar","endLine":1988,"endColumn":105},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1993,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":1993,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1999,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":1999,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":2005,"column":119,"nodeType":"Identifier","messageId":"unusedVar","endLine":2005,"endColumn":120}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":40,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\n\n\nimport { Ionicons } from '@expo/vector-icons';\nimport { useEffect, useState } from 'react';\nimport { Alert, Platform, TouchableOpacity } from 'react-native';\nimport ContextMenu from './ContextMenu';\nimport { adminFetchCompanyMembers, auth, createUserRemote, DEFAULT_CONTROL_TYPES, deleteCompanyControlType, deleteCompanyMall, deleteUserRemote, fetchCompanies, fetchCompanyControlTypes, fetchCompanyMallar, fetchCompanyMembers, fetchCompanyProfile, fetchHierarchy, provisionCompanyRemote, purgeCompanyRemote, saveUserProfile, setCompanyNameRemote, setCompanyStatusRemote, setCompanyUserLimitRemote, updateCompanyControlType, updateCompanyMall, updateUserRemote } from './firebase';\nimport UserEditModal from './UserEditModal';\n\nfunction ProjectSidebar({ onSelectProject, title = 'Projektlista', searchPlaceholder = 'Sök projektnamn eller nr...', companiesMode = false, showMembers = false, restrictCompanyId = null, hideCompanyActions = false, autoExpandMembers = false, memberSearchMode = false, allowCompanyManagementActions = true, templatesMode = false, templatesVersion = 0, iconName = null, iconColor = null, controlTypesMode = false }) {\n  const [search, setSearch] = useState('');\n  const [expandedGroups, setExpandedGroups] = useState({});\n  const [expandedSubs, setExpandedSubs] = useState({});\n  const [hierarchy, setHierarchy] = useState([]);\n  const [companies, setCompanies] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [expandedCompanies, setExpandedCompanies] = useState({});\n  const [membersByCompany, setMembersByCompany] = useState({});\n  const [hoveredCompany, setHoveredCompany] = useState(null);\n  const [hoveredUser, setHoveredUser] = useState(null);\n  const [hoveredControlTypeKey, setHoveredControlTypeKey] = useState(null);\n  const [hoveredTemplateItemKey, setHoveredTemplateItemKey] = useState(null);\n  const [userContextMenu, setUserContextMenu] = useState(null); // { companyId, member, x, y }\n  const [expandedMemberRoles, setExpandedMemberRoles] = useState({});\n  const [editingUser, setEditingUser] = useState(null);\n  const [savingUser, setSavingUser] = useState(false);\n  const [editingUserError, setEditingUserError] = useState('');\n  const [contextMenuVisible, setContextMenuVisible] = useState(false);\n  const [contextMenuX, setContextMenuX] = useState(0);\n  const [contextMenuY, setContextMenuY] = useState(0);\n  const [contextMenuCompany, setContextMenuCompany] = useState(null);\n  const [memberFetchErrors, setMemberFetchErrors] = useState({});\n  const [effectiveGlobalAdmin, setEffectiveGlobalAdmin] = useState(false);\n  const [showDeletedCompanies, setShowDeletedCompanies] = useState(false);\n  const [spinHome, setSpinHome] = useState(0);\n  const [spinAdd, setSpinAdd] = useState(0);\n  const [spinRefresh, setSpinRefresh] = useState(0);\n  const [spinTemplateTypes, setSpinTemplateTypes] = useState({});\n  const [spinGroups, setSpinGroups] = useState({});\n  const [spinSubs, setSpinSubs] = useState({});\n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [addCompanyName, setAddCompanyName] = useState('');\n  const [addCompanyId, setAddCompanyId] = useState('');\n  const [addCompanySaving, setAddCompanySaving] = useState(false);\n  const [addCompanyError, setAddCompanyError] = useState('');\n  const [toast, setToast] = useState({ visible: false, message: '' });\n  const [selectedTemplateKey, setSelectedTemplateKey] = useState(null);\n  const [hoveredTemplateKey, setHoveredTemplateKey] = useState(null);\n  const [expandedTemplateTypes, setExpandedTemplateTypes] = useState({});\n  const [controlTypesByCompany, setControlTypesByCompany] = useState({});\n  const [templatesByCompany, setTemplatesByCompany] = useState({});\n  const [templateFetchErrors, setTemplateFetchErrors] = useState({});\n  const [controlTypeContextMenu, setControlTypeContextMenu] = useState(null); // { companyId, profile, controlTypeId, controlTypeKey, controlTypeName, builtin, hidden, x, y }\n  const [templateContextMenu, setTemplateContextMenu] = useState(null); // { companyId, profile, controlType, template, x, y }\n\n  const showToast = (msg, timeout = 3000) => {\n    try {\n      setToast({ visible: true, message: msg });\n      setTimeout(() => setToast({ visible: false, message: '' }), timeout);\n    } catch (e) {}\n  };\n\n  function slugify(s) {\n    try {\n      return String(s || '')\n        .normalize('NFKD')\n        .replace(/\\p{Diacritic}/gu, '')\n        .replace(/[^a-zA-Z0-9\\s-]/g, '')\n        .trim()\n        .toLowerCase()\n        .replace(/\\s+/g, '-');\n    } catch (e) {\n      return String(s || '').replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();\n    }\n  }\n\n  const isAdmin = (m) => {\n    if (!m) return false;\n    return !!(\n      m.isAdmin ||\n      m.admin ||\n      m.role === 'admin' ||\n      m.role === 'superadmin' ||\n      (m.customClaims && m.customClaims.admin) ||\n      (m.claims && m.claims.admin) ||\n      (m.access === 'admin')\n    );\n  };\n\n  const isCompanyEnabled = (company) => {\n    try {\n      const profile = company && company.profile ? company.profile : {};\n      if (profile.deleted) return false;\n      if (typeof profile.enabled === 'boolean') return profile.enabled;\n      if (typeof profile.active === 'boolean') return profile.active;\n      // Default: företag utan explicit flagga räknas som aktiva\n      return true;\n    } catch (e) {\n      return true;\n    }\n  };\n\n  const visibleCompanies = (Array.isArray(companies) ? companies : []).filter((c) => {\n    try {\n      const deleted = !!(c && c.profile && c.profile.deleted);\n      if (!showDeletedCompanies && deleted) return false;\n      return true;\n    } catch (e) {\n      return true;\n    }\n  });\n\n  // Ange ditt företags-ID här (eller hämta dynamiskt från inloggning)\n  // Prefer prop, otherwise try web localStorage (dk_companyId), fallback to 'testdemo' for demos.\n  const propCompanyId = null;\n  let companyId = propCompanyId || '';\n  try {\n    if (!companyId && typeof window !== 'undefined' && window.localStorage) {\n      companyId = String(window.localStorage.getItem('dk_companyId') || '').trim();\n    }\n  } catch (e) { companyId = '' }\n  if (!companyId) companyId = 'testdemo';\n\n  useEffect(() => {\n    setLoading(true);\n    if (companiesMode) {\n      fetchCompanies().then(async (items) => {\n        if (items && items.length > 0) {\n          const filtered = restrictCompanyId ? items.filter(c => c && c.id === restrictCompanyId) : items;\n          setCompanies(filtered);\n          setLoading(false);\n          return;\n        }\n        // Fallback: try a small set of expected company ids/names (helps when rules block listing)\n        const fallbackIds = ['MS Byggsystem', 'MS Byggsystem DEMO', 'Wilzéns Bygg'];\n        const fetched = await Promise.all(fallbackIds.map(async id => {\n          try {\n            const prof = await fetchCompanyProfile(id);\n            return { id, profile: prof };\n          } catch (e) { return null; }\n        }));\n        let good = (fetched || []).filter(x => x && (x.profile || x.id));\n        if (restrictCompanyId) {\n          good = good.filter(c => c && c.id === restrictCompanyId);\n        }\n        if (good.length > 0) setCompanies(good);\n        else setCompanies([]);\n        setLoading(false);\n      }).catch(async () => {\n        // Try fallback on error as well\n        const fallbackIds = ['MS Byggsystem', 'MS Byggsystem DEMO', 'Wilzéns Bygg'];\n        const fetched = await Promise.all(fallbackIds.map(async id => {\n          try { const prof = await fetchCompanyProfile(id); return { id, profile: prof }; } catch(e) { return null; }\n        }));\n        let good = (fetched || []).filter(x => x && (x.profile || x.id));\n        if (restrictCompanyId) {\n          good = good.filter(c => c && c.id === restrictCompanyId);\n        }\n        setCompanies(good);\n        setLoading(false);\n      });\n      return;\n    }\n    fetchHierarchy(companyId).then(items => {\n      setHierarchy(items || []);\n      setLoading(false);\n    }).catch(() => { setHierarchy([]); setLoading(false); });\n  }, [companiesMode, restrictCompanyId]);\n\n  // Web: react to company profile updates from ManageCompany (e.g. userLimit changes)\n  useEffect(() => {\n    if (!companiesMode) return;\n    if (Platform.OS !== 'web') return;\n    if (typeof window === 'undefined') return;\n\n    const handler = (event) => {\n      try {\n        const cid = event?.detail?.companyId;\n        const profilePatch = event?.detail?.profile || {};\n        if (!cid) return;\n\n        // Fetch latest profile from Firestore so sidebar always reflects\n        // the persisted value (in case anything changed server-side).\n        (async () => {\n          let latestProfile = null;\n          try {\n            latestProfile = await fetchCompanyProfile(cid).catch(() => null);\n          } catch (_err) {\n            latestProfile = null;\n          }\n          const mergedPatch = latestProfile ? { ...(latestProfile || {}), ...profilePatch } : profilePatch;\n\n          setCompanies((prev) => {\n            if (!Array.isArray(prev) || prev.length === 0) return prev;\n            let changed = false;\n            const next = prev.map((c) => {\n              if (c.id !== cid) return c;\n              changed = true;\n              return { ...c, profile: { ...(c.profile || {}), ...mergedPatch } };\n            });\n            return changed ? next : prev;\n          });\n        })();\n      } catch (e) {}\n    };\n\n    if (typeof window !== 'undefined') {\n      window.addEventListener('dkCompanyProfileUpdated', handler);\n    }\n    return () => {\n      try { if (typeof window !== 'undefined') window.removeEventListener('dkCompanyProfileUpdated', handler); } catch (_e) {}\n    };\n  }, [companiesMode]);\n\n  // When used for user management with a restricted company, optionally auto-expand\n  // that company and show its Admin/Användare lists directly.\n  useEffect(() => {\n    if (!companiesMode) return;\n    if (!autoExpandMembers) return;\n    if (!restrictCompanyId) return;\n    if (!Array.isArray(companies) || companies.length === 0) return;\n\n    const cid = restrictCompanyId;\n    const hasCompany = companies.some(c => c && c.id === cid);\n    if (!hasCompany) return;\n\n    setExpandedCompanies(prev => {\n      if (prev && prev[cid]) return prev;\n      return { [cid]: true };\n    });\n\n    setExpandedMemberRoles(prev => ({\n      ...prev,\n      [cid]: { ...(prev[cid] || {}), admin: true, users: true },\n    }));\n\n    if (!showMembers) return;\n    if (membersByCompany && membersByCompany[cid]) return;\n\n    (async () => {\n      let loaded = false;\n      try {\n        const r = await adminFetchCompanyMembers(cid);\n        const mems = r && (r.members || (r.data && r.data.members)) ? (r.members || (r.data && r.data.members)) : [];\n        if (Array.isArray(mems)) {\n          setMembersByCompany(prev => ({ ...prev, [cid]: mems }));\n          loaded = true;\n        }\n      } catch (e) {\n        try {\n          const raw = String(e && e.message ? e.message : (e || ''));\n          if (raw && raw.trim().toLowerCase() !== 'internal') {\n            setMemberFetchErrors(prev => ({ ...prev, [cid]: raw }));\n          }\n        } catch (_) {}\n      }\n      if (!loaded) {\n        try {\n          const members = await fetchCompanyMembers(cid).catch(() => []);\n          setMembersByCompany(prev => ({ ...prev, [cid]: members }));\n        } catch (e) {\n          setMembersByCompany(prev => ({ ...prev, [cid]: [] }));\n        }\n      }\n    })();\n  }, [companiesMode, autoExpandMembers, restrictCompanyId, companies, showMembers, membersByCompany]);\n\n  // If the current user är \"global\" admin (superadmin eller MS Byggsystem-admin),\n  // prefetcha medlemmar för alla företag så vi kan visa användarantal i listan.\n  // Vanliga företags-admins (t.ex. Wilzéns) räknas inte som global admin här.\n  useEffect(() => {\n    let cancelled = false;\n    (async () => {\n      if (!companiesMode || !Array.isArray(companies) || companies.length === 0) return;\n      try {\n        const user = auth && auth.currentUser;\n        if (!user || !user.getIdTokenResult) return;\n        const token = await user.getIdTokenResult(false).catch(() => null);\n        const claims = token && token.claims ? token.claims : {};\n        const companyFromClaims = String(claims.companyId || '').trim();\n        const isMsAdminClaim = !!((claims.admin === true || claims.role === 'admin') && companyFromClaims === 'MS Byggsystem');\n        const isSuperClaim = !!(claims.superadmin === true || claims.role === 'superadmin');\n        const userEmail = (user && user.email) ? String(user.email).toLowerCase() : '';\n        // Allowlist override: allow specific known superadmin emails to see all members\n        const isEmailSuperadmin = userEmail === 'marcus@msbyggsystem.se' || userEmail === 'marcus.skogh@msbyggsystem.se' || userEmail === 'marcus.skogh@msbyggsystem.com' || userEmail === 'marcus.skogh@msbyggsystem';\n        const effectiveGlobalAdmin = isSuperClaim || isMsAdminClaim || isEmailSuperadmin;\n        try { setEffectiveGlobalAdmin(!!effectiveGlobalAdmin); } catch (_) {}\n        if (!effectiveGlobalAdmin) return;\n        // Fetch members for each company in parallel (but limit concurrency to avoid bursts)\n        const results = await Promise.all(companies.map(async (c) => {\n          try {\n            // Try admin callable first for global admins\n            if (effectiveGlobalAdmin && typeof adminFetchCompanyMembers === 'function') {\n              try {\n                const r = await adminFetchCompanyMembers(c.id).catch(err => { throw err; });\n                const mems = r && (r.members || r.data && r.data.members) ? (r.members || r.data && r.data.members) : [];\n                return { id: c.id, members: Array.isArray(mems) ? mems : [] };\n              } catch(e) {\n                // record non-generic errors for debugging and fall back to client fetch\n                try {\n                  const raw = String(e && e.message ? e.message : (e || ''));\n                  if (raw && raw.trim().toLowerCase() !== 'internal') {\n                    setMemberFetchErrors(prev => ({ ...prev, [c.id]: raw }));\n                  }\n                } catch (_) {}\n              }\n            }\n            try {\n              const mems = await fetchCompanyMembers(c.id).catch(err => { throw err; });\n              return { id: c.id, members: Array.isArray(mems) ? mems : [] };\n            } catch (e) {\n              setMemberFetchErrors(prev => ({ ...prev, [c.id]: String(e?.message || e) }));\n              return { id: c.id, members: [] };\n            }\n          } catch(e) { setMemberFetchErrors(prev => ({ ...prev, [c.id]: String(e?.message || e) })); return { id: c.id, members: [] }; }\n        }));\n        if (cancelled) return;\n        const map = {};\n        results.forEach(r => { map[r.id] = r.members; });\n        setMembersByCompany(prev => ({ ...prev, ...map }));\n      } catch(e) {}\n    })();\n    return () => { cancelled = true; };\n  }, [companiesMode, companies]);\n\n  // When used in Mallar-läge (templatesMode), hämta mallar per företag för att\n  // kunna visa räknare både på företagsnivå och per kontrolltyp.\n  useEffect(() => {\n    if (!companiesMode || !templatesMode) return;\n    if (!Array.isArray(companies) || companies.length === 0) return;\n\n    let cancelled = false;\n    (async () => {\n      try {\n        // Hämta mallar per företag\n        const results = await Promise.all(\n          companies.map(async (c) => {\n            try {\n              const items = await fetchCompanyMallar(c.id);\n              const list = Array.isArray(items) ? items : [];\n              const perType = {};\n              list.forEach((tpl) => {\n                const ct = String(tpl?.controlType || '').trim();\n                if (!ct) return;\n                perType[ct] = (perType[ct] || 0) + 1;\n              });\n              return { id: c.id, total: list.length, perType, items: list };\n            } catch (e) {\n              return { id: c.id, total: 0, perType: {}, items: [], error: String(e?.message || e) };\n            }\n          })\n        );\n        if (cancelled) return;\n        const nextMap = {};\n        const nextErr = {};\n        results.forEach((r) => {\n          nextMap[r.id] = { total: r.total, perType: r.perType, items: Array.isArray(r.items) ? r.items : [] };\n          if (r.error) nextErr[r.id] = r.error;\n        });\n        setTemplatesByCompany((prev) => ({ ...prev, ...nextMap }));\n        if (Object.keys(nextErr).length > 0) {\n          setTemplateFetchErrors((prev) => ({ ...prev, ...nextErr }));\n        }\n      } catch (_e) {}\n    })();\n\n    return () => {\n      cancelled = true;\n    };\n  }, [companiesMode, templatesMode, companies, templatesVersion]);\n\n  // När vi är i Mallar-läge eller Kontrolltyper-läge, hämta kontrolltyper per företag så\n  // vänstersidans lista kan visa både standard- och företags-specifika typer.\n  useEffect(() => {\n    if (!companiesMode || (!templatesMode && !controlTypesMode)) return;\n    if (!Array.isArray(companies) || companies.length === 0) return;\n\n    let cancelled = false;\n    (async () => {\n      try {\n        const results = await Promise.all(\n          companies.map(async (c) => {\n            try {\n              const list = await fetchCompanyControlTypes(c.id).catch(() => DEFAULT_CONTROL_TYPES);\n              return { id: c.id, types: Array.isArray(list) && list.length > 0 ? list : DEFAULT_CONTROL_TYPES };\n            } catch (_e) {\n              return { id: c.id, types: DEFAULT_CONTROL_TYPES };\n            }\n          })\n        );\n        if (cancelled) return;\n        const next = {};\n        results.forEach((r) => { next[r.id] = r.types; });\n        setControlTypesByCompany(next);\n      } catch (_e) {}\n    })();\n\n    return () => { cancelled = true; };\n  }, [companiesMode, templatesMode, controlTypesMode, companies]);\n\n  // Filtrera projekt baserat på söksträng (namn eller \"nummer\")\n  const filterTree = (tree) => tree\n    .map(group => {\n      const filteredSubs = (group.children || []).map(sub => {\n        const filteredProjects = (sub.children || []).filter(project =>\n          project.name.toLowerCase().includes(search.toLowerCase()) ||\n          String(project.id).toLowerCase().includes(search.toLowerCase())\n        );\n        return { ...sub, children: filteredProjects };\n      }).filter(sub => sub.children.length > 0 || sub.name.toLowerCase().includes(search.toLowerCase()));\n      return { ...group, children: filteredSubs };\n    })\n    .filter(group => group.children.length > 0 || group.name.toLowerCase().includes(search.toLowerCase()));\n\n  const filteredGroups = filterTree(hierarchy);\n\n  const toggleGroup = (id) => {\n    setExpandedGroups(prev => ({ ...prev, [id]: !prev[id] }));\n    setSpinGroups(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));\n  };\n\n  const toggleSub = (id) => {\n    setExpandedSubs(prev => ({ ...prev, [id]: !prev[id] }));\n    setSpinSubs(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));\n  };\n\n  if (loading) {\n    return (\n      <div style={{ width: 280, padding: 16, fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif', color: '#888' }}>\n        {companiesMode ? 'Laddar företagslista...' : 'Laddar projektlista...'}\n      </div>\n    );\n  }\n\n  const handleGoHome = () => {\n    try {\n      if (typeof window !== 'undefined') {\n        // Signalera till omgivande skärm att vi vill tillbaka till dashboarden.\n        // Själva navigationen hanteras i skärmen (t.ex. ManageCompany/AdminAuditLog)\n        // så att användaren förblir inloggad.\n        try {\n          window.dispatchEvent(new CustomEvent('dkGoHome'));\n        } catch (_e) {}\n      }\n    } catch (e) {}\n  };\n\n  const handleAddCompany = () => {\n    try {\n      setAddCompanyError('');\n      setAddCompanyName('');\n      setAddCompanyId('');\n      setAddDialogOpen(true);\n    } catch (_) {}\n  };\n\n  const handleConfirmAddCompany = async () => {\n    if (addCompanySaving) return;\n    try {\n      if (typeof window === 'undefined') return;\n      const name = String(addCompanyName || '').trim();\n      let id = String(addCompanyId || '').trim();\n      if (!id && name) {\n        id = slugify(name);\n      }\n      if (!id) {\n        setAddCompanyError('Ange ett företags-ID');\n        return;\n      }\n      setAddCompanyError('');\n      setAddCompanySaving(true);\n\n      const prev = Array.isArray(companies) ? companies : [];\n      // Optimistic UI: add placeholder immediately\n      setCompanies(prev.concat([{ id, profile: { companyName: name || id } }]));\n\n      // Ensure token/claims are fresh before attempting writes that depend on claims\n      try {\n        if (auth && auth.currentUser && typeof auth.currentUser.getIdToken === 'function') {\n          await auth.currentUser.getIdToken(true);\n        }\n      } catch (e) {\n        // Non-fatal: continue but visa info i dialogen\n        setAddCompanyError('Kunde inte uppdatera autentiseringstoken, försök logga ut/in om fel uppstår.');\n      }\n\n      // Prefer server-side provisioning (callable) because Firestore rules restrict\n      // client-side creation of company profiles to superadmins / MS Byggsystem admins.\n      try {\n        console.log('[debug] calling provisionCompanyRemote', { id, name });\n        const p = await provisionCompanyRemote({ companyId: id, companyName: name || id });\n        console.log('[debug] provisionCompanyRemote result', p);\n        if (!p || !p.ok) {\n          setAddCompanyError('Serverfel: provisioning kunde inte slutföras automatiskt. Kontrollera loggar för provisionCompany.');\n          setCompanies(prev);\n          setAddCompanySaving(false);\n          return;\n        }\n      } catch (e) {\n        console.error('[debug] provisionCompanyRemote threw', e);\n        const rawCode = e && e.code ? String(e.code) : '';\n        const normCode = rawCode.startsWith('functions/') ? rawCode.slice('functions/'.length) : (rawCode || null);\n        const rawMsg = e && e.message ? String(e.message) : String(e || '');\n        let cleanMsg = rawMsg.replace(/^functions\\.https\\.HttpsError:\\s*/i, '');\n        if (!cleanMsg) cleanMsg = 'Okänt fel från servern.';\n\n        if (normCode === 'permission-denied' || rawMsg.toLowerCase().includes('permission')) {\n          setAddCompanyError('Ingen behörighet att skapa företag (permission-denied). Be en superadmin kontrollera dina rättigheter.');\n        } else if (normCode === 'unauthenticated' || rawMsg.toLowerCase().includes('unauthenticated')) {\n          setAddCompanyError('Du är utloggad eller din session har gått ut. Försök logga ut och in igen.');\n        } else {\n          setAddCompanyError(`Serverfel från provisionCompany (${normCode || 'okänt fel'}): ${cleanMsg}`);\n        }\n        // revert optimistic add\n        setCompanies(prev);\n        setAddCompanySaving(false);\n        return;\n      }\n      // Refresh companies list\n      try {\n        const items = await fetchCompanies();\n        if (Array.isArray(items)) setCompanies(items);\n      } catch (_) {}\n      setAddDialogOpen(false);\n    } catch (e) {\n      setAddCompanyError('Fel vid skapande: ' + String(e?.message || e));\n    } finally {\n      setAddCompanySaving(false);\n    }\n  };\n\n  const handleHardRefresh = () => {\n    // Do an in-app refresh without toggling `loading` (so the sidebar/list stays visible).\n    (async () => {\n      try {\n        if (companiesMode) {\n          const prev = Array.isArray(companies) ? companies : [];\n          const items = await fetchCompanies();\n          if (Array.isArray(items) && items.length > 0) {\n            // Apply same filtering as initial load: respect restrictCompanyId\n            const filtered = restrictCompanyId ? items.filter(c => c && c.id === restrictCompanyId) : items;\n            setCompanies(filtered);\n          } else {\n            // keep previous companies if fetch returned empty — avoid wiping the UI\n            showToast('Uppdateringen gav inga nya företag.');\n            setCompanies(prev);\n          }\n\n          // If we show members and some companies are expanded, refresh those member lists\n          if (showMembers && expandedCompanies) {\n            Object.keys(expandedCompanies).forEach(async (compId) => {\n              if (expandedCompanies[compId]) {\n                try {\n                  const mems = await fetchCompanyMembers(compId).catch(() => []);\n                  setMembersByCompany(prevState => ({ ...prevState, [compId]: mems }));\n                } catch (_) {}\n              }\n            });\n          }\n          return;\n        }\n\n        // Project mode: re-fetch hierarchy for current companyId without hiding UI\n        const prevH = Array.isArray(hierarchy) ? hierarchy : [];\n        const items = await fetchHierarchy(companyId);\n        if (Array.isArray(items) && items.length > 0) setHierarchy(items);\n        else {\n          showToast('Uppdateringen gav inga nya projekt.');\n          setHierarchy(prevH);\n        }\n        return;\n      } catch (e) {\n        // Fallback: cache-busting reload on same path\n        try {\n          if (typeof window !== 'undefined') {\n            try { window.location.reload(); } catch(_) {}\n            try {\n              const path = window.location.pathname + (window.location.search || '');\n              const sep = path.includes('?') ? '&' : '?';\n              window.location.href = path + sep + '_cb=' + Date.now();\n            } catch(_) {}\n          }\n        } catch (_) {}\n      }\n    })();\n  };\n\n  const handleShowAuthDebug = async () => {\n    try {\n      const user = auth && auth.currentUser ? auth.currentUser : null;\n      let claims = null;\n      if (user && user.getIdTokenResult) {\n        try { const t = await user.getIdTokenResult(false); claims = t.claims; } catch(e) { claims = { error: String(e?.message || e) }; }\n      }\n      const out = { user: user ? { uid: user.uid, email: user.email, displayName: user.displayName } : null, claims };\n      alert('Auth debug:\\n' + JSON.stringify(out, null, 2));\n    } catch (e) {\n      alert('Auth debug failed: ' + String(e?.message || e));\n    }\n  };\n\n  return (\n    <div style={{ width: 320, minWidth: 280, background: '#f7f7f7', height: '100vh', overflowY: 'auto', overflowX: 'hidden', borderRight: '1px solid #ddd', padding: 16, fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif', position: 'relative', boxSizing: 'border-box', flexShrink: 0 }}>\n      {addDialogOpen && (\n        <div\n          style={{\n            position: 'fixed',\n            top: 0,\n            left: 0,\n            right: 0,\n            bottom: 0,\n            backgroundColor: 'rgba(0,0,0,0.35)',\n            zIndex: 50,\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'center'\n          }}\n          onClick={() => { if (!addCompanySaving) setAddDialogOpen(false); }}\n        >\n          <div\n            onClick={(e) => e.stopPropagation()}\n            style={{\n              backgroundColor: '#fff',\n              borderRadius: 12,\n              padding: 16,\n              width: 280,\n              maxWidth: '90vw',\n              boxShadow: '0 4px 16px rgba(0,0,0,0.25)',\n              fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif'\n            }}\n          >\n            <h4 style={{ margin: 0, marginBottom: 8, fontSize: 16, fontWeight: 700, color: '#222' }}>Nytt företag</h4>\n            <div style={{ marginBottom: 8 }}>\n              <label style={{ fontSize: 13, marginBottom: 4, display: 'block', color: '#444' }}>Företagsnamn (valfritt)</label>\n              <input\n                type=\"text\"\n                value={addCompanyName}\n                onChange={(e) => setAddCompanyName(e.target.value)}\n                placeholder=\"Företagsnamn\"\n                style={{ width: '100%', padding: '6px 8px', borderRadius: 6, border: '1px solid #ccc', fontSize: 14, boxSizing: 'border-box' }}\n              />\n            </div>\n            <div style={{ marginBottom: 8 }}>\n              <label style={{ fontSize: 13, marginBottom: 4, display: 'block', color: '#444' }}>Företags-ID (kort identifierare)</label>\n              <input\n                type=\"text\"\n                value={addCompanyId}\n                onChange={(e) => setAddCompanyId(e.target.value)}\n                placeholder={addCompanyName ? slugify(addCompanyName) : 'foretags-id (får ej vara mellanrum)'}\n                style={{ width: '100%', padding: '6px 8px', borderRadius: 6, border: '1px solid #ccc', fontSize: 14, boxSizing: 'border-box' }}\n              />\n            </div>\n            {addCompanyError ? (\n              <div style={{ color: '#D32F2F', fontSize: 12, marginBottom: 8 }}>{addCompanyError}</div>\n            ) : null}\n            <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: 4, gap: 8 }}>\n              <button\n                type=\"button\"\n                onClick={() => { if (!addCompanySaving) setAddDialogOpen(false); }}\n                style={{\n                  padding: '6px 10px',\n                  borderRadius: 6,\n                  border: '1px solid #ccc',\n                  backgroundColor: '#fff',\n                  fontSize: 14,\n                  cursor: 'pointer'\n                }}\n              >\n                Avbryt\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleConfirmAddCompany}\n                disabled={addCompanySaving}\n                style={{\n                  padding: '6px 10px',\n                  borderRadius: 6,\n                  border: '1px solid #1976D2',\n                  backgroundColor: addCompanySaving ? '#90CAF9' : '#1976D2',\n                  color: '#fff',\n                  fontSize: 14,\n                  cursor: addCompanySaving ? 'default' : 'pointer'\n                }}\n              >\n                {addCompanySaving ? 'Skapar...' : 'Skapa'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n          {iconName ? (\n            <div style={{ width: 22, height: 22, borderRadius: 6, backgroundColor: iconColor || '#1976D2', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\n              <Ionicons name={iconName} size={13} color=\"#fff\" />\n            </div>\n          ) : null}\n          <h3 style={{ margin: 0, fontFamily: 'Inter_700Bold, Inter, Arial, sans-serif', fontWeight: 700, letterSpacing: 0.2, color: '#222', fontSize: 20 }}>{title}</h3>\n        </div>\n        {companiesMode ? (\n          <div style={{ display: 'flex', gap: 8, alignItems: 'center', position: 'relative' }}>\n            <TouchableOpacity\n              style={{ padding: 6, borderRadius: 8, marginRight: 6, backgroundColor: 'transparent' }}\n              onPress={() => {\n                setSpinHome(n => n + 1);\n                handleGoHome();\n              }}\n              accessibilityLabel=\"Hem\"\n            >\n              <Ionicons\n                name=\"home-outline\"\n                size={18}\n                color=\"#1976D2\"\n                style={{\n                  transform: `rotate(${spinHome * 360}deg)`,\n                  transition: 'transform 0.4s ease'\n                }}\n              />\n            </TouchableOpacity>\n\n            <TouchableOpacity\n              style={{ padding: 6, borderRadius: 8, marginRight: 6, backgroundColor: 'transparent' }}\n              onPress={() => {\n                setSpinRefresh(n => n + 1);\n                handleHardRefresh();\n              }}\n              accessibilityLabel=\"Uppdatera\"\n            >\n              <Ionicons\n                name=\"refresh\"\n                size={18}\n                color=\"#1976D2\"\n                style={{\n                  transform: `rotate(${spinRefresh * 360}deg)`,\n                  transition: 'transform 0.4s ease'\n                }}\n              />\n            </TouchableOpacity>\n          </div>\n        ) : null}\n      </div>\n        {/* Toast/snackbar (döljs när dialogen för nytt företag är öppen) */}\n        {toast.visible && !addDialogOpen ? (\n          <div style={{ position: 'absolute', top: 16, right: 16, background: 'rgba(0,0,0,0.85)', color: '#fff', padding: '8px 12px', borderRadius: 6, fontSize: 13, zIndex: 40 }}>\n            {toast.message}\n          </div>\n        ) : null}\n      <input\n        type=\"text\"\n        placeholder={searchPlaceholder}\n        value={search}\n        onChange={e => setSearch(e.target.value)}\n        style={{\n          width: '100%',\n          padding: '8px 10px',\n          margin: '8px 0 8px 0',\n          borderRadius: 8,\n          border: '1px solid #bbb',\n          fontSize: 15,\n          fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n          outline: 'none',\n          boxSizing: 'border-box',\n        }}\n      />\n      {companiesMode && !hideCompanyActions ? (\n        <>\n          <div style={{ marginTop: 8, marginBottom: 4 }}>\n            <button\n              onClick={handleAddCompany}\n              style={{ background: '#fff', border: '1px solid #1976d2', color: '#1976d2', padding: '6px 10px', borderRadius: 8, cursor: 'pointer', fontSize: 14 }}\n            >\n              + Lägg till företag\n            </button>\n          </div>\n          {effectiveGlobalAdmin ? (\n            <div style={{ marginBottom: 8, fontSize: 12, color: '#555', display: 'flex', alignItems: 'center', gap: 6 }}>\n              <input\n                type=\"checkbox\"\n                checked={showDeletedCompanies}\n                onChange={e => setShowDeletedCompanies(!!e.target.checked)}\n                style={{ margin: 0 }}\n              />\n              <span>Visa dolda företag</span>\n            </div>\n          ) : null}\n        </>\n      ) : null}\n      <hr style={{ border: 0, borderTop: '1px solid #e0e0e0', margin: '12px 0 16px 0' }} />\n      {companiesMode ? (<>\n        <ul style={{ listStyle: 'none', padding: 0 }}>\n          {(() => {\n            const filtered = visibleCompanies.filter(c => {\n              // In memberSearchMode (Hantera användare) eller när sidomenyn är\n              // låst till ett enda företag (restrictCompanyId) ska sökfältet\n              // inte filtrera bort själva företaget – bara användarna under.\n              if (memberSearchMode || restrictCompanyId) return true;\n              const q = search.toLowerCase();\n              const name = String((c.profile && (c.profile.companyName || c.profile.name)) || '').toLowerCase();\n              if (!q) return true;\n\n              // I Kontrolltyper-läget: filtrera även på kontrolltypernas namn.\n              if (controlTypesMode) {\n                const types = (controlTypesByCompany[c.id] || DEFAULT_CONTROL_TYPES) || [];\n                const hasTypeMatch = types.some(t => {\n                  const label = String(t.name || t.key || '').toLowerCase();\n                  return label && label.includes(q);\n                });\n                if (hasTypeMatch) return true;\n              }\n\n              return name.includes(q) || String(c.id || '').toLowerCase().includes(q);\n            });\n            if (!memberSearchMode && !restrictCompanyId && filtered.length === 0) {\n              return (\n                <li style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 24 }}>Inga företag hittades.</li>\n              );\n            }\n            return filtered.map(company => {\n                const companyEnabled = isCompanyEnabled(company);\n                return (\n                <li key={company.id}>\n                  <div style={{ display: 'flex', flexDirection: 'column', width: '100%' }}>\n                    <div\n                      onMouseEnter={() => setHoveredCompany(company.id)}\n                      onMouseLeave={() => setHoveredCompany(null)}\n                      onContextMenu={(e) => {\n                        try { e.preventDefault(); } catch(_e) {}\n                        const x = (e && e.clientX) ? e.clientX : 60;\n                        const y = (e && e.clientY) ? e.clientY : 60;\n                        setContextMenuX(x);\n                        setContextMenuY(y);\n                        setContextMenuCompany(company);\n                        setContextMenuVisible(true);\n                      }}\n                      style={{\n                        display: 'flex',\n                        alignItems: 'center',\n                        cursor: 'pointer',\n                        userSelect: 'none',\n                        flex: 1,\n                        background: hoveredCompany === company.id ? '#eee' : 'transparent',\n                        borderRadius: 4,\n                        padding: '2px 4px',\n                        borderWidth: 1,\n                        borderStyle: 'solid',\n                        borderColor: hoveredCompany === company.id ? '#1976D2' : 'transparent',\n                        transition: 'background 0.15s, border-color 0.15s',\n                        boxSizing: 'border-box',\n                      }}\n                    >\n                      <button\n                        style={{\n                        background: 'none',\n                        border: 'none',\n                        padding: 0,\n                        cursor: 'pointer',\n                        color: '#222',\n                        textAlign: 'left',\n                        fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n                        fontSize: 15,\n                        letterSpacing: 0.1,\n                        display: 'flex',\n                        alignItems: 'center',\n                        width: '100%',\n                        justifyContent: 'space-between',\n                      }}\n                        onClick={async () => {\n                          setExpandedCompanies(prev => {\n                            const isOpen = !!prev[company.id];\n                            // Allow only one expanded company at a time\n                            if (isOpen) return {};\n                            return { [company.id]: true };\n                          });\n                          // Whenever we change which company is öppnad, reset\n                          // the per-company member role expansion so that\n                          // \"Admin\" och \"Användare\" listas alltid startar stängda.\n                          try { setExpandedMemberRoles({}); } catch(_e) {}\n                          if (showMembers && !membersByCompany[company.id]) {\n                            // Try admin callable first (works across companies as superadmin), then fallback to client fetch\n                            let loaded = false;\n                            try {\n                              const r = await adminFetchCompanyMembers(company.id);\n                              const mems = r && (r.members || (r.data && r.data.members)) ? (r.members || (r.data && r.data.members)) : [];\n                              if (Array.isArray(mems)) {\n                                setMembersByCompany(prev => ({ ...prev, [company.id]: mems }));\n                                loaded = true;\n                              }\n                            } catch (e) {\n                              try {\n                                const raw = String(e && e.message ? e.message : (e || ''));\n                                if (raw && raw.trim().toLowerCase() !== 'internal') {\n                                  setMemberFetchErrors(prev => ({ ...prev, [company.id]: raw }));\n                                }\n                              } catch (_) {}\n                            }\n                            if (!loaded) {\n                              try {\n                                const members = await fetchCompanyMembers(company.id).catch(() => []);\n                                setMembersByCompany(prev => ({ ...prev, [company.id]: members }));\n                              } catch (e) {\n                                setMembersByCompany(prev => ({ ...prev, [company.id]: [] }));\n                              }\n                            }\n                          }\n                          if (onSelectProject) {\n                            onSelectProject({ companyId: company.id, profile: company.profile });\n                          }\n                        }}\n                      >\n                        <span style={{ fontWeight: 600, display: 'inline-flex', alignItems: 'center', gap: 6, flex: 1, minWidth: 0, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>\n                          <Ionicons\n                            name=\"briefcase\"\n                            size={16}\n                            color={company.profile && company.profile.deleted ? '#999' : '#555'}\n                            style={{\n                              transform: expandedCompanies[company.id] ? 'rotate(360deg)' : 'rotate(0deg)',\n                              transition: 'transform 0.4s ease'\n                            }}\n                          />\n                          {(() => {\n                            const baseName = (company.profile && (company.profile.companyName || company.profile.name)) || company.id;\n                            if (company.profile && company.profile.deleted) return `${baseName} (dolt)`;\n                            return baseName;\n                          })()}\n                          {(() => {\n                            if (templatesMode) {\n                              const summary = templatesByCompany && templatesByCompany[company.id];\n                              const totalTemplates = summary && typeof summary.total === 'number' ? summary.total : 0;\n                              return ` (${totalTemplates})`;\n                            }\n\n                            // I Kontrolltyper-läget vill vi visa antal kontrolltyper per företag,\n                            // inte antal användare/licenser.\n                            if (controlTypesMode && controlTypesByCompany && controlTypesByCompany[company.id]) {\n                              const types = controlTypesByCompany[company.id] || [];\n                              const count = Array.isArray(types) ? types.length : 0;\n                              if (count > 0) return ` (${count})`;\n                            }\n\n                            const mems = membersByCompany && membersByCompany[company.id] ? (membersByCompany[company.id] || []) : null;\n                            if (!mems) return '';\n                            const used = mems.length;\n                            let limit = null;\n                            if (company.profile && company.profile.userLimit !== undefined && company.profile.userLimit !== null && company.profile.userLimit !== '') {\n                              try {\n                                const raw = String(company.profile.userLimit).trim();\n                                const m = raw.match(/-?\\d+/);\n                                if (m && m[0]) {\n                                  const n = parseInt(m[0], 10);\n                                  if (!Number.isNaN(n) && Number.isFinite(n)) limit = n;\n                                }\n                              } catch (_) {}\n                            }\n                            if (typeof limit === 'number') return ` (${used}/${limit})`;\n                            return ` (${used})`;\n                          })()}\n                        </span>\n                        {effectiveGlobalAdmin ? (\n                          <span\n                            style={{\n                              marginLeft: 8,\n                              padding: '0 6px',\n                              minWidth: 32,\n                              display: 'flex',\n                              alignItems: 'center',\n                              justifyContent: 'flex-end',\n                              boxSizing: 'border-box',\n                              flexShrink: 0,\n                            }}\n                            title={companyEnabled ? 'Företaget är aktivt (visas bara för superadmin)' : 'Företaget är pausat/inaktivt (visas bara för superadmin)'}\n                          >\n                            <span\n                              style={{\n                                width: 12,\n                                height: 12,\n                                borderRadius: 999,\n                                backgroundColor: companyEnabled ? '#4CAF50' : '#E53935',\n                                border: '1px solid rgba(0,0,0,0.08)',\n                                boxSizing: 'border-box',\n                                display: 'inline-block',\n                              }}\n                            />\n                          </span>\n                        ) : null}\n                      </button>\n                    </div>\n                    <ContextMenu\n                      visible={contextMenuVisible && contextMenuCompany && contextMenuCompany.id === company.id}\n                      x={contextMenuX}\n                      y={contextMenuY}\n                      onClose={() => setContextMenuVisible(false)}\n                      items={(() => {\n                        const enabled = companyEnabled;\n                        const deleted = !!(company.profile && company.profile.deleted);\n\n                        // I Kontrolltyper-läget använder vi ett enklare menyupplägg\n                        // där huvudfokus är att lägga till kontrolltyper.\n                        if (controlTypesMode) {\n                          return [\n                            { key: 'addControlType', label: 'Lägg till kontrolltyp', icon: '➕' },\n                          ];\n                        }\n\n                        // I Mallar-läget: företagsmenyn ska bara erbjuda \"Lägg till mall\".\n                        if (templatesMode) {\n                          return [\n                            { key: 'addTemplate', label: 'Lägg till mall', icon: '➕' },\n                          ];\n                        }\n\n                        const base = [{ key: 'addUser', label: 'Lägg till användare', icon: '➕' }];\n                        if (!effectiveGlobalAdmin || !allowCompanyManagementActions) return base;\n                        return base.concat([\n                          { key: 'rename', label: 'Byt företagsnamn', icon: '✏️' },\n                          { key: 'setLimit', label: 'Justera antal användare (userLimit)', icon: '👥' },\n                          { key: 'activate', label: 'Aktivera företag', icon: '▶️', disabled: enabled },\n                          { key: 'pause', label: 'Pausa företag', icon: '⏸️', disabled: !enabled },\n                          { key: 'deleteCompany', label: deleted ? 'Radera företag' : 'Dölj företag', icon: '🗑️', danger: true },\n                        ]);\n                      })()}\n                      onSelect={async (item) => {\n                        if (!contextMenuCompany) return;\n                        const compId = contextMenuCompany.id;\n                        if (controlTypesMode && item.key === 'addControlType') {\n                          setContextMenuVisible(false);\n                          if (onSelectProject) {\n                            onSelectProject({ companyId: compId, profile: contextMenuCompany.profile, createControlType: true });\n                          }\n                          return;\n                        }\n                        if (templatesMode && item.key === 'addTemplate') {\n                          setContextMenuVisible(false);\n                          if (onSelectProject) {\n                            // Välj bara företaget; själva formuläret för ny mall finns i mitten\n                            onSelectProject({ companyId: compId, profile: contextMenuCompany.profile });\n                          }\n                          return;\n                        }\n                        if (item.key === 'addUser') {\n                          // Open the same modal as edit, but in \"create\" mode.\n                          setEditingUser({ companyId: compId, member: {}, create: true });\n                          setContextMenuVisible(false);\n                          return;\n                        } else if (item.key === 'activate' || item.key === 'pause') {\n                          const wantEnable = item.key === 'activate';\n                          const label = wantEnable ? 'aktivera' : 'pausa';\n                          const conf = (typeof window !== 'undefined') ? window.confirm(label.charAt(0).toUpperCase() + label.slice(1) + ' företaget ' + compId + '?') : true;\n                          if (!conf) return;\n                          try {\n                            const res = await setCompanyStatusRemote({ companyId: compId, enabled: wantEnable });\n                            const ok = !!(res && (res.ok === true || res.success === true));\n                            if (!ok) {\n                              showToast('Kunde inte ändra företagsstatus (servern avvisade ändringen).');\n                              return;\n                            }\n                            try { Alert.alert('Ok', `Företaget ${wantEnable ? 'aktiverades' : 'pausades'}.`); } catch(e) { try { window.alert('Ok'); } catch(_) {} }\n                            try {\n                              const updated = await fetchCompanyProfile(compId);\n                              setCompanies(prev => prev.map(c => c.id === compId ? { ...c, profile: updated || c.profile } : c));\n                            } catch(e) {}\n                          } catch (e) {\n                            const rawCode = e && e.code ? String(e.code) : '';\n                            const rawMsg = e && e.message ? String(e.message) : String(e || '');\n                            const combined = rawCode ? `${rawCode}: ${rawMsg}` : rawMsg;\n                            showToast('Kunde inte ändra företagsstatus: ' + combined);\n                            try { Alert.alert('Fel', 'Kunde inte ändra status: ' + combined); } catch(_) { try { window.alert('Kunde inte ändra status'); } catch(__) {} }\n                          }\n                        } else if (item.key === 'deleteCompany') {\n                          const prof = contextMenuCompany && contextMenuCompany.profile ? contextMenuCompany.profile : {};\n                          const alreadyDeleted = !!prof.deleted;\n\n                          if (!alreadyDeleted) {\n                            const conf = (typeof window !== 'undefined')\n                              ? window.confirm('Dölj företaget ' + compId + '? Företaget pausas och döljs i listan. Du kan visa det igen via \"Visa dolda företag\".')\n                              : true;\n                            if (!conf) return;\n                            try {\n                              const res = await setCompanyStatusRemote({ companyId: compId, deleted: true, enabled: false });\n                              const ok = !!(res && (res.ok === true || res.success === true));\n                              if (!ok) {\n                                showToast('Kunde inte radera företaget (servern avvisade ändringen).');\n                                return;\n                              }\n                              // Markera som raderat lokalt istället för att ta bort helt.\n                              setCompanies(prev =>\n                                Array.isArray(prev)\n                                  ? prev.map(c =>\n                                      c.id === compId\n                                        ? { ...c, profile: { ...(c.profile || {}), deleted: true, enabled: false } }\n                                        : c\n                                    )\n                                  : prev\n                              );\n                              try {\n                                Alert.alert('Dolt', 'Företaget har pausats och dolts från listan.');\n                              } catch (e) {\n                                try { window.alert('Företaget har dolts från listan.'); } catch (_) {}\n                              }\n                            } catch (e) {\n                              const rawCode = e && e.code ? String(e.code) : '';\n                              const rawMsg = e && e.message ? String(e.message) : String(e || '');\n                              const combined = rawCode ? `${rawCode}: ${rawMsg}` : rawMsg;\n                              showToast('Kunde inte radera företaget: ' + combined);\n                              try { Alert.alert('Fel', 'Kunde inte radera företaget: ' + combined); } catch (_) { try { window.alert('Kunde inte radera företaget.'); } catch (__ ) {} }\n                            }\n                          } else {\n                            const conf = (typeof window !== 'undefined')\n                              ? window.confirm(\n                                  'Företaget ' +\n                                    compId +\n                                    ' är redan dolt. Vill du radera det PERMANENT? Detta tar bort all historik och kan inte ångras.'\n                                )\n                              : true;\n                            if (!conf) return;\n                            try {\n                              const res = await purgeCompanyRemote({ companyId: compId });\n                              const ok = !!(res && (res.ok === true || res.success === true));\n                              if (!ok) {\n                                showToast('Kunde inte radera företaget permanent (servern avvisade ändringen).');\n                                return;\n                              }\n                              setCompanies(prev => (Array.isArray(prev) ? prev.filter(c => c.id !== compId) : prev));\n                              try {\n                                Alert.alert('Borttaget', 'Företaget har raderats permanent och all historik är borttagen.');\n                              } catch (e) {\n                                try { window.alert('Företaget har raderats permanent.'); } catch (_) {}\n                              }\n                            } catch (e) {\n                              const rawCode = e && e.code ? String(e.code) : '';\n                              const rawMsg = e && e.message ? String(e.message) : String(e || '');\n                              const combined = rawCode ? `${rawCode}: ${rawMsg}` : rawMsg;\n                              showToast('Kunde inte radera företaget permanent: ' + combined);\n                              try { Alert.alert('Fel', 'Kunde inte radera företaget permanent: ' + combined); } catch (_) { try { window.alert('Kunde inte radera företaget permanent.'); } catch (__ ) {} }\n                            }\n                          }\n                        } else if (item.key === 'setLimit') {\n                          if (typeof window === 'undefined') return;\n                          // Förifyll med nuvarande limit om den finns\n                          let currentLimit = null;\n                          try {\n                            const prof = contextMenuCompany && contextMenuCompany.profile ? contextMenuCompany.profile : null;\n                            if (prof && prof.userLimit !== undefined && prof.userLimit !== null && prof.userLimit !== '') {\n                              const raw = String(prof.userLimit).trim();\n                              const m = raw.match(/-?\\d+/);\n                              if (m && m[0]) {\n                                const n = parseInt(m[0], 10);\n                                if (!Number.isNaN(n) && Number.isFinite(n)) currentLimit = n;\n                              }\n                            }\n                          } catch (_) {}\n\n                          const initial = currentLimit !== null ? String(currentLimit) : '';\n                          const raw = window.prompt('Ange max antal användare (userLimit) för ' + compId + ':', initial);\n                          if (raw === null) return; // avbrutet\n                          const trimmed = String(raw).trim();\n                          if (!trimmed) return;\n                          const parsed = parseInt(trimmed, 10);\n                          if (Number.isNaN(parsed) || !Number.isFinite(parsed) || parsed < 0) {\n                            try { Alert.alert('Fel', 'Ogiltigt antal användare. Ange ett heltal 0 eller större.'); } catch(e) { try { window.alert('Ogiltigt antal användare.'); } catch(_) {} }\n                            return;\n                          }\n\n                          try {\n                            const res = await setCompanyUserLimitRemote({ companyId: compId, userLimit: parsed });\n                            const ok = !!(res && (res.ok === true || res.success === true));\n                            if (!ok) {\n                              showToast('Kunde inte spara userLimit (servern avvisade ändringen).');\n                              return;\n                            }\n                            try { Alert.alert('Ok', `Max antal användare uppdaterat till ${parsed}.`); } catch(e) { try { window.alert('Max antal användare uppdaterat.'); } catch(_) {} }\n                            try {\n                              const updated = await fetchCompanyProfile(compId);\n                              setCompanies(prev => prev.map(c => c.id === compId ? { ...c, profile: updated || c.profile } : c));\n                            } catch(e) {}\n                          } catch (e) {\n                            const rawCode = e && e.code ? String(e.code) : '';\n                            const rawMsg = e && e.message ? String(e.message) : String(e || '');\n                            const combined = rawCode ? `${rawCode}: ${rawMsg}` : rawMsg;\n                            showToast('Kunde inte uppdatera userLimit: ' + combined);\n                            try { Alert.alert('Fel', 'Kunde inte uppdatera userLimit: ' + combined); } catch(_) { try { window.alert('Kunde inte uppdatera userLimit.'); } catch(__) {} }\n                          }\n                        } else if (item.key === 'rename') {\n                          if (typeof window === 'undefined') return;\n                          const prof = contextMenuCompany && contextMenuCompany.profile ? contextMenuCompany.profile : {};\n                          const currentName = (prof && (prof.companyName || prof.name)) || compId;\n                          const raw = window.prompt('Ange nytt företagsnamn för ' + compId + ':', currentName);\n                          if (raw === null) return; // avbrutet\n                          const trimmed = String(raw).trim();\n                          if (!trimmed) return;\n\n                          try {\n                            const res = await setCompanyNameRemote({ companyId: compId, companyName: trimmed });\n                            const ok = !!(res && (res.ok === true || res.success === true));\n                            if (!ok) {\n                              showToast('Kunde inte uppdatera företagsnamnet (servern avvisade ändringen).');\n                              return;\n                            }\n                            try { Alert.alert('Ok', 'Företagsnamnet har uppdaterats.'); } catch(e) { try { window.alert('Företagsnamnet har uppdaterats.'); } catch(_) {} }\n                            try {\n                              const updated = await fetchCompanyProfile(compId);\n                              setCompanies(prev => prev.map(c => c.id === compId ? { ...c, profile: updated || c.profile } : c));\n                            } catch(e) {}\n                          } catch (e) {\n                            const rawCode = e && e.code ? String(e.code) : '';\n                            const rawMsg = e && e.message ? String(e.message) : String(e || '');\n                            const combined = rawCode ? `${rawCode}: ${rawMsg}` : rawMsg;\n                            showToast('Kunde inte uppdatera företagsnamn: ' + combined);\n                            try { Alert.alert('Fel', 'Kunde inte uppdatera företagsnamn: ' + combined); } catch(_) { try { window.alert('Kunde inte uppdatera företagsnamn.'); } catch(__) {} }\n                          }\n                        }\n                      }}\n                    />\n\n                    {(controlTypesMode || templatesMode) && controlTypeContextMenu && controlTypeContextMenu.companyId === company.id && (\n                      <ContextMenu\n                        visible={!!controlTypeContextMenu}\n                        x={controlTypeContextMenu.x}\n                        y={controlTypeContextMenu.y}\n                        onClose={() => setControlTypeContextMenu(null)}\n                        items={(function () {\n                          if (templatesMode) {\n                            return [\n                              { key: 'addTemplate', label: 'Lägg till mall', icon: '➕' },\n                            ];\n                          }\n\n                          const isHidden = !!controlTypeContextMenu.hidden;\n                          return [\n                            { key: 'rename', label: 'Byt namn' },\n                            { key: isHidden ? 'activate' : 'hide', label: isHidden ? 'Aktivera' : 'Dölj' },\n                            { key: 'delete', label: 'Radera' },\n                          ];\n                        })()}\n                        onSelect={async (item) => {\n                          const ctx = controlTypeContextMenu;\n                          setControlTypeContextMenu(null);\n                          if (!ctx || !item) return;\n                          if (templatesMode && item.key === 'addTemplate') {\n                            const compId = ctx.companyId;\n                            const typeName = ctx.controlTypeName || ctx.controlTypeKey || '';\n                            if (onSelectProject && compId && typeName) {\n                              onSelectProject({ companyId: compId, profile: company.profile, controlType: typeName, openTemplateModal: true });\n                            }\n                            return;\n                          }\n\n                          if (!controlTypesMode) return;\n                          const compId = ctx.companyId;\n                          const ctId = ctx.controlTypeId;\n                          const ctName = ctx.controlTypeName || '';\n                          const ctKey = ctx.controlTypeKey || '';\n                          const isBuiltin = !!ctx.builtin;\n                          const isHidden = !!ctx.hidden;\n                          if (!compId) return;\n\n                          const notifyChange = () => {\n                            try {\n                              if (typeof window !== 'undefined') {\n                                window.dispatchEvent(new CustomEvent('dkControlTypesUpdated', { detail: { companyId: compId } }));\n                              }\n                            } catch (_) {}\n                          };\n\n                          try {\n                            if (item.key === 'rename') {\n                              let raw = ctName;\n                              try {\n                                if (typeof window !== 'undefined' && window.prompt) {\n                                  raw = window.prompt('Nytt namn för kontrolltypen', ctName || '') || '';\n                                }\n                              } catch (_) {}\n                              const trimmed = String(raw || '').trim();\n                              if (!trimmed || trimmed === ctName) return;\n                              if (isBuiltin || !ctId) {\n                                await updateCompanyControlType({ key: ctKey || ctName || trimmed, name: trimmed }, compId);\n                              } else {\n                                await updateCompanyControlType({ id: ctId, name: trimmed }, compId);\n                              }\n                              try {\n                                const list = await fetchCompanyControlTypes(compId).catch(() => null);\n                                if (Array.isArray(list) && list.length > 0) {\n                                  setControlTypesByCompany(prev => ({ ...prev, [compId]: list }));\n                                }\n                              } catch (_) {}\n                              notifyChange();\n                              return;\n                            }\n\n                            if (item.key === 'hide' || item.key === 'activate') {\n                              const targetHidden = item.key === 'hide';\n                              if (isBuiltin || !ctId) {\n                                await updateCompanyControlType({ key: ctKey || ctName, hidden: targetHidden }, compId);\n                              } else {\n                                await updateCompanyControlType({ id: ctId, hidden: targetHidden }, compId);\n                              }\n                              try {\n                                const list = await fetchCompanyControlTypes(compId).catch(() => null);\n                                if (Array.isArray(list) && list.length > 0) {\n                                  setControlTypesByCompany(prev => ({ ...prev, [compId]: list }));\n                                }\n                              } catch (_) {}\n                              notifyChange();\n                              return;\n                            }\n\n                            if (item.key === 'delete') {\n                              let confirmed = true;\n                              try {\n                                if (typeof window !== 'undefined' && window.confirm) {\n                                  confirmed = window.confirm(`Är du säker på att du vill radera kontrolltypen \"${ctName || ''}\"? Detta går inte att ångra.`);\n                                }\n                              } catch (_) { confirmed = true; }\n                              if (!confirmed) return;\n                              if (isBuiltin || !ctId) {\n                                // För inbyggda kontrolltyper kan vi inte radera globalt,\n                                // behandla \"Radera\" som att dölja typen för detta företag.\n                                await updateCompanyControlType({ key: ctKey || ctName, hidden: true }, compId);\n                              } else {\n                                await deleteCompanyControlType({ id: ctId }, compId);\n                              }\n                              try {\n                                const list = await fetchCompanyControlTypes(compId).catch(() => null);\n                                if (Array.isArray(list) && list.length > 0) {\n                                  setControlTypesByCompany(prev => ({ ...prev, [compId]: list }));\n                                }\n                              } catch (_) {}\n                              notifyChange();\n                              return;\n                            }\n                          } catch (e) {\n                            try {\n                              showToast('Kunde inte uppdatera kontrolltyp: ' + String(e?.message || e));\n                            } catch (_) {}\n                          }\n                        }}\n                      />\n                    )}\n\n                    {templatesMode && expandedCompanies[company.id] && (\n                      <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 6 }}>\n                        {(controlTypesByCompany[company.id] || DEFAULT_CONTROL_TYPES).map(({ name, icon, color, key: ctKey, id, hidden, builtin }) => {\n                          const type = name || ctKey || '';\n                          if (!type) return null;\n                          const key = `${company.id}:${type}`;\n                          const spin = spinTemplateTypes[key] || 0;\n                          const isSelected = selectedTemplateKey === key;\n                          const isHovered = hoveredTemplateKey === key;\n                          const isExpanded = !!expandedTemplateTypes[key];\n                          const isHidden = !!hidden;\n                          const summary = templatesByCompany && templatesByCompany[company.id];\n                          const count = summary && summary.perType && typeof summary.perType[type] === 'number'\n                            ? summary.perType[type]\n                            : 0;\n                          const templatesForType = summary && Array.isArray(summary.items)\n                            ? summary.items.filter(tpl => String(tpl?.controlType || '').trim() === type)\n                            : [];\n                          return (\n                            <li key={key}>\n                              <button\n                                style={{\n                                  background: 'none',\n                                  border: 'none',\n                                  padding: 0,\n                                  cursor: 'pointer',\n                                  width: '100%',\n                                  textAlign: 'left',\n                                  fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n                                  fontSize: 14,\n                                }}\n                                onContextMenu={(e) => {\n                                  try { if (e && e.preventDefault) e.preventDefault(); } catch (_) {}\n                                  const x = (e && e.clientX) ? e.clientX : 60;\n                                  const y = (e && e.clientY) ? e.clientY : 60;\n                                  setControlTypeContextMenu({\n                                    companyId: company.id,\n                                    profile: company.profile,\n                                    controlTypeId: id,\n                                    controlTypeKey: ctKey,\n                                    controlTypeName: type,\n                                    builtin: !!builtin,\n                                    hidden: isHidden,\n                                    x,\n                                    y,\n                                  });\n                                }}\n                                onClick={() => {\n                                  // Visa bara klick-feedback tillfälligt; vi vill inte\n                                  // ha kvar en \"markerad\" kontrolltyp efter att\n                                  // användaren har klickat bort fokus.\n                                  setSelectedTemplateKey(key);\n                                  setSpinTemplateTypes(prev => ({ ...prev, [key]: (prev[key] || 0) + 1 }));\n                                  setExpandedTemplateTypes(prev => {\n                                    const isOpen = !!prev[key];\n                                    // Allow max en öppen kontrolltyp åt gången\n                                    if (isOpen) return {};\n                                    return { [key]: true };\n                                  });\n                                  if (onSelectProject) {\n                                    onSelectProject({ companyId: company.id, profile: company.profile, controlType: type });\n                                  }\n                                  // Rensa markeringsstate strax efter klick så att\n                                  // raden beter sig mer som hover (likt användarlistor).\n                                  setTimeout(() => {\n                                    try {\n                                      setSelectedTemplateKey(prev => (prev === key ? null : prev));\n                                    } catch (_) {}\n                                  }, 150);\n                                }}\n                              >\n                                <div\n                                  style={{\n                                    display: 'flex',\n                                    alignItems: 'center',\n                                    padding: '4px 4px',\n                                    paddingLeft: 24,\n                                    borderRadius: 4,\n                                    backgroundColor: isSelected ? '#e3f2fd' : (isHovered ? '#f5f5f5' : 'transparent'),\n                                    borderWidth: 1,\n                                    borderStyle: 'solid',\n                                    borderColor: isSelected ? '#1976D2' : (isHovered ? '#ccc' : 'transparent'),\n                                    transition: 'background 0.15s, border-color 0.15s',\n                                  }}\n                                  onMouseEnter={() => setHoveredTemplateKey(key)}\n                                  onMouseLeave={() => { setHoveredTemplateKey(prev => (prev === key ? null : prev)); }}\n                                >\n                                  <Ionicons\n                                    name={icon}\n                                    size={14}\n                                    color={color}\n                                    style={{\n                                      marginRight: 8,\n                                      transform: `rotate(${spin * 360}deg)`,\n                                      transition: 'transform 0.4s ease',\n                                    }}\n                                  />\n                                  <span style={{ color: isHidden ? '#9E9E9E' : '#333', fontStyle: isHidden ? 'italic' : 'normal' }}>\n                                    {count > 0 ? `${type} (${count})` : type}\n                                  </span>\n                                  <span\n                                    style={{\n                                      marginLeft: 'auto',\n                                      padding: '1px 6px',\n                                      borderRadius: 999,\n                                      fontSize: 10,\n                                      lineHeight: '14px',\n                                      backgroundColor: isHidden ? '#FFEBEE' : '#E8F5E9',\n                                      color: isHidden ? '#C62828' : '#2E7D32',\n                                      border: `1px solid ${isHidden ? '#FFCDD2' : '#C8E6C9'}`,\n                                    }}\n                                  >\n                                    {isHidden ? 'Inaktiv' : 'Aktiv'}\n                                  </span>\n                                </div>\n                              </button>\n                              {isExpanded && (\n                                templatesForType.length > 0 ? (\n                                  <ul style={{ listStyle: 'none', paddingLeft: 40, marginTop: 2 }}>\n                                    {templatesForType.map((tpl) => {\n                                      const itemKey = `${company.id}:${type}:${tpl.id}`;\n                                      const isHoveredItem = hoveredTemplateItemKey === itemKey;\n                                      const isHiddenItem = !!tpl.hidden;\n                                      return (\n                                        <li key={tpl.id}>\n                                          <button\n                                            style={{\n                                              background: isHoveredItem ? '#eee' : 'transparent',\n                                              border: 'none',\n                                              padding: 0,\n                                              cursor: 'pointer',\n                                              width: '100%',\n                                              textAlign: 'left',\n                                              fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n                                              fontSize: 13,\n                                            }}\n                                            onMouseEnter={() => setHoveredTemplateItemKey(itemKey)}\n                                            onMouseLeave={() => setHoveredTemplateItemKey(prev => (prev === itemKey ? null : prev))}\n                                            onContextMenu={(e) => {\n                                              try { if (e && e.preventDefault) e.preventDefault(); } catch (_) {}\n                                              const x = (e && e.clientX) ? e.clientX : 60;\n                                              const y = (e && e.clientY) ? e.clientY : 60;\n                                              setTemplateContextMenu({\n                                                companyId: company.id,\n                                                profile: company.profile,\n                                                controlType: type,\n                                                template: tpl,\n                                                x,\n                                                y,\n                                              });\n                                            }}\n                                            onClick={() => {\n                                              if (onSelectProject) {\n                                                onSelectProject({\n                                                  companyId: company.id,\n                                                  profile: company.profile,\n                                                  controlType: type,\n                                                  templateId: tpl.id,\n                                                  template: tpl,\n                                                });\n                                              }\n                                            }}\n                                          >\n                                            <span\n                                              style={{\n                                                display: 'block',\n                                                padding: '3px 4px',\n                                                paddingLeft: 32,\n                                                borderRadius: 4,\n                                                borderWidth: 1,\n                                                borderStyle: 'solid',\n                                                borderColor: isHoveredItem ? '#1976D2' : 'transparent',\n                                                transition: 'background 0.15s, border 0.15s',\n                                                color: isHiddenItem ? '#9E9E9E' : '#444',\n                                                fontStyle: isHiddenItem ? 'italic' : 'normal',\n                                              }}\n                                            >\n                                              {(tpl.title || 'Namnlös mall') + (isHiddenItem ? ' (inaktiv)' : '')}\n                                            </span>\n                                          </button>\n                                        </li>\n                                      );\n                                    })}\n                                  </ul>\n                                ) : (\n                                  <div style={{ paddingLeft: 48, marginTop: 2, fontSize: 12, color: '#D32F2F' }}>\n                                    Inga mallar skapade\n                                  </div>\n                                )\n                              )}\n                            </li>\n                          );\n                        })}\n                      </ul>\n                    )}\n                    {templatesMode && templateContextMenu && templateContextMenu.companyId === company.id && (\n                      <ContextMenu\n                        visible={!!templateContextMenu}\n                        x={templateContextMenu.x}\n                        y={templateContextMenu.y}\n                        onClose={() => setTemplateContextMenu(null)}\n                        items={(function () {\n                          const ctx = templateContextMenu;\n                          const isHidden = !!(ctx && ctx.template && ctx.template.hidden);\n                          return [\n                            { key: 'edit', label: 'Redigera' },\n                            { key: isHidden ? 'activate' : 'hide', label: isHidden ? 'Aktivera' : 'Dölj' },\n                            { key: 'delete', label: 'Radera', danger: true },\n                          ];\n                        })()}\n                        onSelect={async (item) => {\n                          const ctx = templateContextMenu;\n                          setTemplateContextMenu(null);\n                          if (!ctx || !ctx.template || !ctx.companyId || !item) return;\n\n                          const compId = ctx.companyId;\n                          const tpl = ctx.template;\n                          const type = ctx.controlType || '';\n\n                          const refreshTemplatesForCompany = async () => {\n                            try {\n                              const items = await fetchCompanyMallar(compId);\n                              const list = Array.isArray(items) ? items : [];\n                              const perType = {};\n                              list.forEach((t) => {\n                                const ct = String(t?.controlType || '').trim();\n                                if (!ct) return;\n                                perType[ct] = (perType[ct] || 0) + 1;\n                              });\n                              setTemplatesByCompany(prev => ({\n                                ...prev,\n                                [compId]: { total: list.length, perType, items: list },\n                              }));\n                            } catch (e) {\n                              setTemplateFetchErrors(prev => ({ ...prev, [compId]: String(e?.message || e) }));\n                            }\n                          };\n\n                          const notifyTemplatesChange = () => {\n                            try {\n                              if (typeof window !== 'undefined') {\n                                window.dispatchEvent(new CustomEvent('dkTemplatesUpdated', { detail: { companyId: compId } }));\n                              }\n                            } catch (_) {}\n                          };\n\n                          try {\n                            if (item.key === 'edit') {\n                              if (onSelectProject) {\n                                onSelectProject({\n                                  companyId: compId,\n                                  profile: ctx.profile,\n                                  controlType: type,\n                                  templateId: tpl.id,\n                                  template: tpl,\n                                  openTemplateModal: true,\n                                });\n                              }\n                              return;\n                            }\n\n                            if (item.key === 'hide' || item.key === 'activate') {\n                              const targetHidden = item.key === 'hide';\n                              await updateCompanyMall({ id: tpl.id, patch: { hidden: targetHidden } }, compId);\n                              await refreshTemplatesForCompany();\n                              notifyTemplatesChange();\n                              return;\n                            }\n\n                            if (item.key === 'delete') {\n                              let confirmed = true;\n                              try {\n                                if (typeof window !== 'undefined' && window.confirm) {\n                                  confirmed = window.confirm(`Är du säker på att du vill radera mallen \"${String(tpl.title || 'Namnlös mall')}\"? Detta går inte att ångra.`);\n                                }\n                              } catch (_) { confirmed = true; }\n                              if (!confirmed) return;\n                              await deleteCompanyMall({ id: tpl.id }, compId);\n                              await refreshTemplatesForCompany();\n                              notifyTemplatesChange();\n                              return;\n                            }\n                          } catch (e) {\n                            try {\n                              showToast('Kunde inte uppdatera mall: ' + String(e?.message || e));\n                            } catch (_) {}\n                          }\n                        }}\n                      />\n                    )}\n\n                    {controlTypesMode && expandedCompanies[company.id] && (\n                      <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 6 }}>\n                        {(controlTypesByCompany[company.id] || DEFAULT_CONTROL_TYPES)\n                          .filter((ct) => {\n                            const type = (ct && (ct.name || ct.key)) || '';\n                            if (!type) return false;\n                            const q = search.toLowerCase();\n                            if (!q) return true;\n                            return String(type).toLowerCase().includes(q);\n                          })\n                          .map((ct) => {\n                          const { name, icon, color, key: ctKey, id, hidden, builtin } = ct || {};\n                          const type = name || ctKey || '';\n                          if (!type) return null;\n                          const key = `${company.id}:ct:${id || type}`;\n                          const isHidden = !!hidden;\n                          const isHovered = hoveredControlTypeKey === key;\n                          return (\n                            <li key={key}>\n                              <button\n                                style={{\n                                  background: 'none',\n                                  border: 'none',\n                                  padding: 0,\n                                  cursor: 'default',\n                                  width: '100%',\n                                  textAlign: 'left',\n                                  fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n                                  fontSize: 14,\n                                }}\n                                onContextMenu={(e) => {\n                                  try { if (e && e.preventDefault) e.preventDefault(); } catch (_) {}\n                                  const x = (e && e.clientX) ? e.clientX : 60;\n                                  const y = (e && e.clientY) ? e.clientY : 60;\n                                  setControlTypeContextMenu({\n                                    companyId: company.id,\n                                    profile: company.profile,\n                                    controlTypeId: id,\n                                    controlTypeKey: ctKey,\n                                    controlTypeName: type,\n                                    builtin: !!builtin,\n                                    hidden: isHidden,\n                                    x,\n                                    y,\n                                  });\n                                }}\n                                onClick={() => {\n                                  if (onSelectProject) {\n                                    onSelectProject({ companyId: company.id, profile: company.profile, controlType: type });\n                                  }\n                                }}\n                              >\n                                <div\n                                  style={{\n                                    display: 'flex',\n                                    alignItems: 'center',\n                                    padding: '4px 4px',\n                                    paddingLeft: 24,\n                                    borderRadius: 4,\n                                    backgroundColor: isHovered ? '#f5f5f5' : 'transparent',\n                                    borderWidth: 1,\n                                    borderStyle: 'solid',\n                                    borderColor: isHovered ? '#1976D2' : 'transparent',\n                                    transition: 'background 0.15s, border-color 0.15s',\n                                  }}\n                                  onMouseEnter={() => setHoveredControlTypeKey(key)}\n                                  onMouseLeave={() => { setHoveredControlTypeKey(prev => (prev === key ? null : prev)); }}\n                                >\n                                  <Ionicons\n                                    name={icon}\n                                    size={14}\n                                    color={color}\n                                    style={{ marginRight: 8 }}\n                                  />\n                                  <span style={{ color: isHidden ? '#9E9E9E' : '#333', fontStyle: isHidden ? 'italic' : 'normal' }}>{type}</span>\n                                  <span\n                                    style={{\n                                      marginLeft: 'auto',\n                                      padding: '1px 6px',\n                                      borderRadius: 999,\n                                      fontSize: 10,\n                                      lineHeight: '14px',\n                                      backgroundColor: isHidden ? '#FFEBEE' : '#E8F5E9',\n                                      color: isHidden ? '#C62828' : '#2E7D32',\n                                      border: `1px solid ${isHidden ? '#FFCDD2' : '#C8E6C9'}`,\n                                    }}\n                                  >\n                                    {isHidden ? 'Inaktiv' : 'Aktiv'}\n                                  </span>\n                                </div>\n                              </button>\n                            </li>\n                          );\n                        })}\n                      </ul>\n                    )}\n\n                    {showMembers && expandedCompanies[company.id] && (\n                      <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 6 }}>\n                        {(() => {\n                          const membersRaw = membersByCompany[company.id];\n                          if (!membersRaw) {\n                            return (\n                              <li style={{ color: '#666', fontSize: 13 }}>Laddar användare…</li>\n                            );\n                          }\n                          const members = Array.isArray(membersRaw) ? membersRaw : [];\n                          const q = memberSearchMode ? search.toLowerCase() : '';\n                          const matchesQuery = (m) => {\n                            if (!q) return true;\n                            const text = `${m.displayName || ''} ${m.firstName || ''} ${m.lastName || ''} ${m.email || ''}`.toLowerCase();\n                            return text.includes(q);\n                          };\n                          const admins = members.filter(m => isAdmin(m) && matchesQuery(m));\n                          const usersList = members.filter(m => !isAdmin(m) && matchesQuery(m));\n                          if (!admins.length && !usersList.length) {\n                            return (\n                              <li style={{ color: '#D32F2F', fontSize: 13 }}>Inga användare matchar sökningen.</li>\n                            );\n                          }\n                          const roleState = expandedMemberRoles[company.id] || {};\n                          return (\n                            <>\n                              <li>\n                                <div\n                                  onClick={() => setExpandedMemberRoles(prev => ({ ...prev, [company.id]: { ...(prev[company.id] || {}), admin: !prev[company.id]?.admin } }))}\n                                  style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', userSelect: 'none', padding: '2px 0' }}\n                                >\n                                  <span style={{ fontWeight: 700, fontSize: 14, display: 'inline-flex', alignItems: 'center', gap: 4 }}>\n                                    <Ionicons\n                                      name=\"shield-checkmark\"\n                                      size={14}\n                                      color=\"#1976D2\"\n                                      style={{\n                                        transform: roleState.admin ? 'rotate(360deg)' : 'rotate(0deg)',\n                                        transition: 'transform 0.4s ease'\n                                      }}\n                                    />\n                                    Admin ({admins.length})\n                                  </span>\n                                </div>\n                                {roleState.admin && (\n                                  <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 2 }}>\n                                    {admins.length === 0 && (<li style={{ color: '#D32F2F', fontSize: 13 }}>Ingen admin skapad.</li>)}\n                                    {admins.map(m => {\n                                      const memKey = String(m.uid || m.id || '');\n                                      const isHoveredUser = hoveredUser === `${company.id}:${memKey}`;\n                                      return (\n                                        <li key={memKey}>\n                                          <div\n                                            onMouseEnter={() => setHoveredUser(`${company.id}:${memKey}`)}\n                                            onMouseLeave={() => setHoveredUser(null)}\n                                            onContextMenu={(e) => {\n                                              try { e.preventDefault(); } catch(_) {}\n                                              const x = (e && e.clientX) ? e.clientX : 60;\n                                              const y = (e && e.clientY) ? e.clientY : 60;\n                                              setUserContextMenu({ companyId: company.id, member: m, x, y });\n                                            }}\n                                            onClick={() => {\n                                              // open edit form\n                                              setEditingUser({ companyId: company.id, member: m });\n                                            }}\n                                            style={{\n                                              fontSize: 14,\n                                              color: '#333',\n                                              display: 'block',\n                                              borderRadius: 4,\n                                              padding: '4px 4px',\n                                              paddingLeft: 24,\n                                              background: isHoveredUser ? '#eee' : 'transparent',\n                                              borderWidth: 1,\n                                              borderStyle: 'solid',\n                                              borderColor: isHoveredUser ? '#1976D2' : 'transparent',\n                                              transition: 'background 0.15s, border 0.15s',\n                                              cursor: 'pointer',\n                                              whiteSpace: 'nowrap',\n                                            }}\n                                          >\n                                            <span style={{ fontWeight: isHoveredUser ? '700' : '400' }}>{m.displayName || `${m.firstName || ''} ${m.lastName || ''}`.trim() || m.email || m.uid || m.id}</span>\n                                          </div>\n                                        </li>\n                                      );\n                                    })}\n                                  </ul>\n                                )}\n                              </li>\n\n                              <li>\n                                <div\n                                  onClick={() => setExpandedMemberRoles(prev => ({ ...prev, [company.id]: { ...(prev[company.id] || {}), users: !prev[company.id]?.users } }))}\n                                  style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', userSelect: 'none', padding: '2px 0' }}\n                                >\n                                  <span style={{ fontWeight: 700, fontSize: 14, display: 'inline-flex', alignItems: 'center', gap: 4 }}>\n                                    <Ionicons\n                                      name=\"person\"\n                                      size={14}\n                                      color=\"#555\"\n                                      style={{\n                                        transform: roleState.users ? 'rotate(360deg)' : 'rotate(0deg)',\n                                        transition: 'transform 0.4s ease'\n                                      }}\n                                    />\n                                    Användare ({usersList.length})\n                                  </span>\n                                </div>\n                                {roleState.users && (\n                                  <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 2 }}>\n                                    {usersList.length === 0 && (<li style={{ color: '#D32F2F', fontSize: 13 }}>Ingen användare skapad.</li>)}\n                                    {usersList.map(m => {\n                                      const memKey = String(m.uid || m.id || '');\n                                      const isHoveredUser = hoveredUser === `${company.id}:${memKey}`;\n                                      return (\n                                        <li key={memKey}>\n                                          <div\n                                            onMouseEnter={() => setHoveredUser(`${company.id}:${memKey}`)}\n                                            onMouseLeave={() => setHoveredUser(null)}\n                                            onContextMenu={(e) => {\n                                              try { e.preventDefault(); } catch(_) {}\n                                              const x = (e && e.clientX) ? e.clientX : 60;\n                                              const y = (e && e.clientY) ? e.clientY : 60;\n                                              setUserContextMenu({ companyId: company.id, member: m, x, y });\n                                            }}\n                                            onClick={() => {\n                                              setEditingUser({ companyId: company.id, member: m });\n                                            }}\n                                            style={{\n                                              fontSize: 14,\n                                              color: '#333',\n                                              display: 'block',\n                                              borderRadius: 4,\n                                              padding: '4px 4px',\n                                              paddingLeft: 24,\n                                              background: isHoveredUser ? '#eee' : 'transparent',\n                                              borderWidth: 1,\n                                              borderStyle: 'solid',\n                                              borderColor: isHoveredUser ? '#1976D2' : 'transparent',\n                                              transition: 'background 0.15s, border 0.15s',\n                                              cursor: 'pointer',\n                                              whiteSpace: 'nowrap',\n                                            }}\n                                          >\n                                            <span style={{ fontWeight: isHoveredUser ? '700' : '400' }}>{m.displayName || `${m.firstName || ''} ${m.lastName || ''}`.trim() || m.email || m.uid || m.id}</span>\n                                          </div>\n                                        </li>\n                                      );\n                                    })}\n                                  </ul>\n                                )}\n                              </li>\n                            </>\n                          );\n                        })()}\n                      </ul>\n                    )}\n                  </div>\n                </li>\n                );\n              });\n          })()}\n        </ul>\n      {userContextMenu && (\n        <ContextMenu\n          visible={!!userContextMenu}\n          x={userContextMenu.x}\n          y={userContextMenu.y}\n          onClose={() => setUserContextMenu(null)}\n          items={[{ key: 'delete', label: 'Ta bort användare', danger: true, icon: '🗑️' }]}\n          onSelect={async (item) => {\n            if (!userContextMenu || item.key !== 'delete') return;\n            const compId = userContextMenu.companyId;\n            const member = userContextMenu.member || {};\n            const uid = member.uid || member.id;\n            if (!uid || !compId) return;\n            const name = member.displayName || `${member.firstName || ''} ${member.lastName || ''}`.trim() || member.email || uid;\n            const confirmed = (typeof window !== 'undefined') ? window.confirm(`Ta bort användaren ${name} från ${compId}? Detta tar även bort Auth-kontot.`) : true;\n            if (!confirmed) return;\n            try {\n              await deleteUserRemote({ companyId: compId, uid });\n              try {\n                let mems = [];\n                try {\n                  const r = await adminFetchCompanyMembers(compId);\n                  mems = r && (r.members || (r.data && r.data.members)) ? (r.members || (r.data && r.data.members)) : [];\n                } catch(e) {\n                  try { mems = await fetchCompanyMembers(compId); } catch(_) { mems = []; }\n                }\n                setMembersByCompany(prev => ({ ...prev, [compId]: mems }));\n              } catch(_) {}\n              try { Alert.alert('Borttagen', 'Användaren har tagits bort.'); } catch(e) { try { window.alert('Användaren har tagits bort.'); } catch(_) {} }\n            } catch (e) {\n              console.warn('delete user failed', e);\n              try { Alert.alert('Fel', 'Kunde inte ta bort användaren: ' + String(e?.message || e)); } catch(_) { try { window.alert('Kunde inte ta bort användaren.'); } catch(__) {} }\n            } finally {\n              setUserContextMenu(null);\n            }\n          }}\n        />\n      )}\n      <UserEditModal\n        visible={!!editingUser}\n        member={editingUser?.member}\n        companyId={editingUser?.companyId}\n        isNew={!!editingUser?.create}\n        onClose={() => setEditingUser(null)}\n        saving={savingUser}\n        errorMessage={editingUserError}\n        onSave={async ({ firstName, lastName, email, role, password }) => {\n          if (!editingUser) return;\n          const displayName = `${(firstName || '').trim()} ${(lastName || '').trim()}`.trim() || (email ? email.split('@')[0] : '');\n          setEditingUserError('');\n          setSavingUser(true);\n          try {\n            if (editingUser.create) {\n              // Create new user via callable\n              const createRes = await createUserRemote({ companyId: editingUser.companyId, email: String(email || '').trim().toLowerCase(), displayName, role: role || 'user' });\n              const newUid = createRes && (createRes.uid || (createRes.data && createRes.data.uid)) ? (createRes.uid || (createRes.data && createRes.data.uid)) : null;\n              const tempPassword = createRes && (createRes.tempPassword || (createRes.data && createRes.data.tempPassword)) ? (createRes.tempPassword || (createRes.data && createRes.data.tempPassword)) : null;\n              if (!newUid) {\n                // No uid returned => treat as error and surface any message\n                const rawMsg = createRes && (createRes.message || createRes.error || createRes.code) ? String(createRes.message || createRes.error || createRes.code) : 'Okänt fel vid skapande av användare.';\n                setEditingUserError('Kunde inte skapa användare: ' + rawMsg);\n                try {\n                  Alert.alert('Fel', 'Kunde inte skapa användare: ' + rawMsg);\n                } catch (_) {\n                  try { window.alert('Kunde inte skapa användare: ' + rawMsg); } catch(__) {}\n                }\n                return;\n              }\n              if (newUid) {\n                // If role or password specified different from default, call updateUserRemote to set them\n                const needRoleChange = role && role !== 'user';\n                const needPassword = password && password.length > 0;\n                if (needRoleChange || needPassword) {\n                  try { await updateUserRemote({ companyId: editingUser.companyId, uid: newUid, displayName, email, role: role || 'user', password: needPassword ? password : undefined }); } catch(e) {}\n                }\n                // update client-side users doc\n                try { await saveUserProfile(newUid, { displayName, email, firstName, lastName }); } catch(e) {}\n                try {\n                  let mems = [];\n                  try {\n                    const r = await adminFetchCompanyMembers(editingUser.companyId);\n                    mems = r && (r.members || (r.data && r.data.members)) ? (r.members || (r.data && r.data.members)) : [];\n                  } catch(e) {\n                    try { mems = await fetchCompanyMembers(editingUser.companyId); } catch(_) { mems = []; }\n                  }\n                  setMembersByCompany(prev => ({ ...prev, [editingUser.companyId]: mems }));\n                } catch(e) {}\n              }\n              setEditingUser(null);\n              try { Alert.alert('Ok', `Användare skapad. Temporärt lösenord: ${tempPassword || ''}`); } catch(e) { try { window.alert('Användare skapad.'); } catch(_) {} }\n            } else {\n              // Edit existing user\n              const uid = editingUser.member && (editingUser.member.uid || editingUser.member.id);\n              if (!uid) return;\n              const theRole = role || (editingUser.member && (editingUser.member.role || (editingUser.member.isAdmin ? 'admin' : 'user'))) || 'user';\n              try {\n                await updateUserRemote({ companyId: editingUser.companyId, uid, displayName, email, role: theRole, password });\n                try { await saveUserProfile(uid, { displayName, email, firstName, lastName }); } catch(e) {}\n                try {\n                  if (auth && auth.currentUser && typeof auth.currentUser.getIdToken === 'function') {\n                    await auth.currentUser.getIdToken(true);\n                  }\n                } catch(e) { /* non-blocking */ }\n                try {\n                  let mems = [];\n                  try {\n                    const r = await adminFetchCompanyMembers(editingUser.companyId);\n                    mems = r && (r.members || (r.data && r.data.members)) ? (r.members || (r.data && r.data.members)) : [];\n                  } catch(e) {\n                    try { mems = await fetchCompanyMembers(editingUser.companyId); } catch(_) { mems = []; }\n                  }\n                  setMembersByCompany(prev => ({ ...prev, [editingUser.companyId]: mems }));\n                } catch (_e) {}\n                setEditingUser(null);\n                try { Alert.alert('Sparat', 'Användaren uppdaterades. Behörighet och uppgifter är sparade.'); } catch(e) { try { window.alert('Användaren uppdaterades.'); } catch(_) {} }\n              } catch (e) {\n                console.warn('Could not save user', e);\n              }\n            }\n          } catch (e) {\n            console.warn('User save error', e);\n            try {\n              const code = e && e.code ? String(e.code) : '';\n\n              // Specifik text när licenstaket är nått\n              if (code === 'functions/failed-precondition') {\n                const msg = 'Max antal användare är uppnådd';\n                setEditingUserError(msg);\n                Alert.alert('Fel', msg);\n                return;\n              }\n\n              // För övriga fel: bygg ett mer tekniskt meddelande\n              const details = (e && (e.details || e.data)) || '';\n              const msgText = e && e.message ? String(e.message) : '';\n              let detailText = '';\n              if (typeof details === 'string') detailText = details;\n              else if (details) {\n                try { detailText = JSON.stringify(details); } catch (_) { detailText = String(details); }\n              }\n              let combined = '';\n              if (code) combined += code;\n              if (detailText) combined += (combined ? ' — ' : '') + detailText;\n              if (!combined && msgText) combined = msgText;\n              if (!combined) combined = 'Okänt fel från servern.';\n              const finalMsg = 'Kunde inte spara användare: ' + combined;\n              setEditingUserError(finalMsg);\n              Alert.alert('Fel', finalMsg);\n            } catch (_alertErr) {\n              const fallbackMsg = 'Kunde inte spara användare: ' + String(e && e.message ? e.message : e);\n              setEditingUserError(fallbackMsg);\n              try { window.alert(fallbackMsg); } catch (_) {}\n            }\n          } finally { setSavingUser(false); }\n        }}\n      />\n      {effectiveGlobalAdmin && Object.keys(memberFetchErrors).length > 0 && (\n        <div style={{ marginTop: 12, padding: 8, borderRadius: 6, background: '#fff6f6', border: '1px solid #f2c2c2' }}>\n          <div style={{ fontWeight: 700, marginBottom: 6 }}>Debug: Fel vid hämtning av användare</div>\n          {Object.keys(memberFetchErrors).map(k => (\n            <div key={k} style={{ fontSize: 13, color: '#b71c1c' }}><strong>{k}:</strong> {String(memberFetchErrors[k]).slice(0, 300)}</div>\n          ))}\n        </div>\n      )}\n      </> ) : (\n        <ul style={{ listStyle: 'none', padding: 0 }}>\n          {filteredGroups.length === 0 && (\n            <li style={{ color: '#888', fontSize: 15, textAlign: 'center', marginTop: 24 }}>Inga projekt hittades.</li>\n          )}\n          {filteredGroups.map(group => {\n            const groupSpin = spinGroups[group.id] || 0;\n            const groupAngle = expandedGroups[group.id] ? (groupSpin * 360 + 90) : (groupSpin * 360);\n            return (\n            <li key={group.id}>\n              <div style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', userSelect: 'none' }} onClick={() => toggleGroup(group.id)}>\n                <span\n                  style={{\n                    color: '#222',\n                    fontSize: 18,\n                    fontWeight: 700,\n                    marginRight: 6,\n                    display: 'inline-block',\n                    transform: `rotate(${groupAngle}deg)`,\n                    transition: 'transform 0.4s ease',\n                  }}\n                >\n                  &gt;\n                </span>\n                <span style={{ fontFamily: 'Inter_700Bold, Inter, Arial, sans-serif', fontWeight: 700, fontSize: 16, letterSpacing: 0.1 }}>{group.name}</span>\n              </div>\n              {expandedGroups[group.id] && group.children.length > 0 && (\n                <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 4 }}>\n                  {group.children.map(sub => {\n                    const subSpin = spinSubs[sub.id] || 0;\n                    const subAngle = expandedSubs[sub.id] ? (subSpin * 360 + 90) : (subSpin * 360);\n                    return (\n                    <li key={sub.id}>\n                      <div style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', userSelect: 'none' }} onClick={() => toggleSub(sub.id)}>\n                        <span\n                          style={{\n                            color: '#222',\n                            fontSize: 15,\n                            fontWeight: 600,\n                            marginRight: 6,\n                            display: 'inline-block',\n                            transform: `rotate(${subAngle}deg)`,\n                            transition: 'transform 0.4s ease',\n                          }}\n                        >\n                          &gt;\n                        </span>\n                        <span style={{ fontWeight: 600, fontSize: 15 }}>{sub.name}</span>\n                      </div>\n                      {expandedSubs[sub.id] && sub.children.length > 0 && (\n                        <ul style={{ listStyle: 'none', paddingLeft: 16, marginTop: 2 }}>\n                          {sub.children.map(project => (\n                            <li key={project.id}>\n                              <button\n                                style={{\n                                  background: 'none',\n                                  border: 'none',\n                                  padding: 0,\n                                  cursor: 'pointer',\n                                  color: '#1976d2',\n                                  fontFamily: 'Inter_400Regular, Inter, Arial, sans-serif',\n                                  fontSize: 15,\n                                  letterSpacing: 0.1,\n                                  display: 'flex',\n                                  alignItems: 'center',\n                                  width: '100%',\n                                  justifyContent: 'space-between',\n                                }}\n                                onClick={() => onSelectProject && onSelectProject(project)}\n                              >\n                                <span>{project.name}</span>\n                                <span style={{ color: '#222', fontSize: 18, marginLeft: 8, display: 'inline-flex', alignItems: 'center' }}>&gt;</span>\n                              </button>\n                            </li>\n                          ))}\n                        </ul>\n                      )}\n                    </li>\n                  );\n                  })}\n                </ul>\n              )}\n            </li>\n          );\n          })}\n        </ul>\n      )}\n    </div>\n  );\n}\n\nexport default ProjectSidebar;\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/SignatureModal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/UserEditModal.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'isMsBygg' and 'isNew'. Either include them or remove the dependency array. If 'setEmail' needs the current value of 'isNew', you can also switch to useReducer instead of useState and read 'isNew' in the reducer.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [visible, member, isNew, isMsBygg]","fix":{"range":[2693,2710],"text":"[visible, member, isNew, isMsBygg]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\n\nexport default function UserEditModal({ visible, member, companyId, onClose, onSave, saving, isNew, errorMessage }) {\n  const [firstName, setFirstName] = useState('');\n  const [lastName, setLastName] = useState('');\n  const [email, setEmail] = useState('');\n  const [password, setPassword] = useState('');\n  const [role, setRole] = useState('user'); // 'admin' | 'user'\n  const [showPassword, setShowPassword] = useState(false);\n\n  const normalizeName = (value) => {\n    if (!value) return '';\n    const trimmed = String(value).replace(/\\s+/g, ' ').trim();\n    if (!trimmed) return '';\n    return trimmed\n      .split(' ')\n      .map(part => part ? part.charAt(0).toUpperCase() + part.slice(1).toLowerCase() : '')\n      .join(' ');\n  };\n\n  const isMsBygg = String(companyId || '').trim() === 'MS Byggsystem';\n\n  const rawEmail = String(email || '').trim();\n  const emailIsValid = rawEmail.length > 0 && /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(rawEmail);\n  const requiredFilledForCreate = () => {\n    if (!isNew) return true;\n    return String(firstName || '').trim().length > 0\n      && String(lastName || '').trim().length > 0\n      && emailIsValid\n      && String(password || '').length > 0\n      && String(role || '').length > 0;\n  };\n\n  const firstNameMissing = isNew && String(firstName || '').trim().length === 0;\n  const lastNameMissing = isNew && String(lastName || '').trim().length === 0;\n  const emailMissing = isNew && !emailIsValid;\n  const passwordMissing = isNew && String(password || '').length === 0;\n  const roleMissing = isNew && String(role || '').length === 0;\n\n  const generateTempPassword = () => {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=';\n    let out = '';\n    for (let i = 0; i < 12; i += 1) {\n      out += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    setPassword(out);\n    setShowPassword(true);\n  };\n\n  useEffect(() => {\n    if (!visible) return;\n    const dn = String(member?.displayName || '').trim();\n    const parts = dn ? dn.split(' ') : [];\n    setFirstName(parts.slice(0, parts.length - 1).join(' ') || (member?.firstName || ''));\n    setLastName(parts.length > 1 ? parts.slice(-1).join(' ') : (member?.lastName || ''));\n    setEmail(isNew ? '' : (member?.email || ''));\n    const isSuperMember = !!(member && (member.role === 'superadmin' || member.superadmin));\n    const adminGuess = !!(member && (member.isAdmin || member.admin || member.role === 'admin' || member.access === 'admin' || isSuperMember));\n    if (isSuperMember && isMsBygg) setRole('superadmin');\n    else setRole(adminGuess ? 'admin' : 'user');\n    setPassword('');\n  }, [visible, member]);\n\n  if (!visible) return null;\n\n  return (\n    <div onClick={onClose} style={{ position: 'fixed', left: 0, top: 0, width: '100%', height: '100%', background: 'rgba(0,0,0,0.35)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1200 }}>\n      <div onClick={e => e.stopPropagation()} style={{ width: 420, maxWidth: 'calc(100% - 40px)', background: '#fff', borderRadius: 8, padding: 18, boxShadow: '0 8px 24px rgba(0,0,0,0.2)' }}>\n        <h4 style={{ margin: '0 0 8px 0' }}>{isNew ? 'Lägg till ny användare' : 'Redigera användare'}</h4>\n        <div style={{ marginBottom: 8 }}>\n          <label style={{ display: 'block', fontSize: 13, marginBottom: 4 }}>Förnamn{isNew && <span style={{ color: '#e53935', marginLeft: 6 }}>*</span>}</label>\n          <input\n            value={firstName}\n            onChange={e => setFirstName(normalizeName(e.target.value))}\n            aria-required={isNew}\n            style={{ width: '100%', padding: 8, borderRadius: 6, border: `1px solid ${firstNameMissing ? '#e53935' : '#ddd'}`, boxSizing: 'border-box' }}\n          />\n        </div>\n        <div style={{ marginBottom: 8 }}>\n          <label style={{ display: 'block', fontSize: 13, marginBottom: 4 }}>Efternamn{isNew && <span style={{ color: '#e53935', marginLeft: 6 }}>*</span>}</label>\n          <input\n            value={lastName}\n            onChange={e => setLastName(normalizeName(e.target.value))}\n            aria-required={isNew}\n            style={{ width: '100%', padding: 8, borderRadius: 6, border: `1px solid ${lastNameMissing ? '#e53935' : '#ddd'}`, boxSizing: 'border-box' }}\n          />\n        </div>\n        <div style={{ marginBottom: 8 }}>\n          <label style={{ display: 'block', fontSize: 13, marginBottom: 4 }}>E-post{isNew && <span style={{ color: '#e53935', marginLeft: 6 }}>*</span>}</label>\n          <input\n            value={email}\n            onChange={e => setEmail(e.target.value)}\n            aria-required={isNew}\n            style={{ width: '100%', padding: 8, borderRadius: 6, border: `1px solid ${emailMissing ? '#e53935' : '#ddd'}`, boxSizing: 'border-box' }}\n          />\n          {emailMissing && rawEmail.length > 0 ? (\n            <div style={{ color: '#e53935', fontSize: 12, marginTop: 4 }}>\n              Ogiltig e-postadress. Använd formatet namn@foretag.se\n            </div>\n          ) : null}\n        </div>\n\n        <div style={{ marginBottom: 8 }}>\n          <label style={{ display: 'block', fontSize: 13, marginBottom: 4 }}>Lösenord</label>\n          <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n            <input\n              type={showPassword ? 'text' : 'password'}\n              value={password}\n              onChange={e => setPassword(e.target.value)}\n              placeholder={isNew ? 'Välj lösenord' : 'Fyll i för att byta lösenord'}\n              aria-required={isNew}\n              style={{ width: '100%', padding: 8, borderRadius: 6, border: `1px solid ${passwordMissing ? '#e53935' : '#ddd'}`, boxSizing: 'border-box' }}\n            />\n            <button\n              type=\"button\"\n              onClick={() => setShowPassword(prev => !prev)}\n              style={{ padding: '6px 10px', borderRadius: 6, border: '1px solid #ddd', background: '#fff', cursor: 'pointer' }}\n            >\n              {showPassword ? 'Dölj' : 'Visa'}\n            </button>\n            {!isNew && (\n              <button\n                type=\"button\"\n                onClick={generateTempPassword}\n                style={{ padding: '6px 10px', borderRadius: 6, border: '1px solid #1976D2', background: '#E3F2FD', cursor: 'pointer', color: '#1976D2', fontSize: 12 }}\n              >\n                Nytt lösenord\n              </button>\n            )}\n          </div>\n        </div>\n\n        <div style={{ marginBottom: 12 }}>\n          <label style={{ display: 'block', fontSize: 13, marginBottom: 6 }}>Behörighet{isNew && <span style={{ color: '#e53935', marginLeft: 6 }}>*</span>}</label>\n          <select\n            value={role}\n            onChange={e => setRole(e.target.value)}\n            aria-required={isNew}\n            style={{ width: '100%', padding: 8, borderRadius: 6, border: `1px solid ${roleMissing ? '#e53935' : '#ddd'}` }}\n          >\n            {isMsBygg && <option value=\"superadmin\">Superadmin</option>}\n            <option value=\"admin\">Admin</option>\n            <option value=\"user\">Användare</option>\n          </select>\n        </div>\n\n        {errorMessage ? (\n          <div style={{ color: '#D32F2F', fontSize: 12, marginBottom: 8 }}>\n            {errorMessage}\n          </div>\n        ) : null}\n\n        <div style={{ display: 'flex', gap: 8, justifyContent: 'flex-end' }}>\n          <button\n            disabled={saving || !requiredFilledForCreate()}\n            onClick={async () => {\n              if (typeof onSave === 'function') {\n                await onSave({ firstName, lastName, email, role, password });\n              }\n            }}\n            style={{\n              backgroundColor: '#1976D2',\n              color: '#fff',\n              padding: '8px 10px',\n              borderRadius: 6,\n              border: 'none',\n              opacity: (saving || !requiredFilledForCreate()) ? 0.5 : 1,\n              cursor: (saving || !requiredFilledForCreate()) ? 'not-allowed' : 'pointer'\n            }}\n          >{saving ? 'Sparar...' : 'Spara'}</button>\n          <button disabled={saving} onClick={() => onClose && onClose()} style={{ padding: '8px 10px', borderRadius: 6, border: '1px solid #ddd', background: '#fff' }}>Avbryt</button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/external-link.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":15,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { openBrowserAsync } from 'expo-web-browser';\nimport { Linking, Platform, Text, TouchableOpacity } from 'react-native';\n\ntype Props = { href: string; children?: any; style?: any };\n\nexport function ExternalLink({ href, children, style }: Props) {\n  const handlePress = async () => {\n    try {\n      if (Platform.OS === 'web') {\n        window.open(href, '_blank');\n      } else {\n        // prefer in-app browser when available\n        try {\n          await openBrowserAsync(href);\n        } catch(e) {\n          await Linking.openURL(href);\n        }\n      }\n    } catch {\n      try { await Linking.openURL(href); } catch {}\n    }\n  };\n  return (\n    <TouchableOpacity onPress={handlePress} style={style} accessibilityRole=\"link\">\n      {children ? children : <Text style={{ color: '#1976D2' }}>{href}</Text>}\n    </TouchableOpacity>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/fetchProjectControls.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/firebase.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":45,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":11},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":238,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":238,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":241,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":241,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":262,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":262,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":267,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":267,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":318,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":318,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":334,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":334,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":347,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":347,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":359,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":359,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":382,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":382,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":395,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":395,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":434,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":434,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'inner' is defined but never used. Allowed unused caught errors must match /^_/u.","line":442,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":442,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":448,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":448,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":462,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":462,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":474,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":474,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":495,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":495,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":505,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":505,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":518,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":518,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":566,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":566,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":589,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":589,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":592,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":592,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":605,"column":116,"nodeType":"Identifier","messageId":"unusedVar","endLine":605,"endColumn":117},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":620,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":620,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":623,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":623,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":627,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":627,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":632,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":632,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":643,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":643,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":665,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":665,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":703,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":703,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":716,"column":116,"nodeType":"Identifier","messageId":"unusedVar","endLine":716,"endColumn":117},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":730,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":730,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":750,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":750,"endColumn":22},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":752,"column":74,"nodeType":"Identifier","messageId":"unusedVar","endLine":752,"endColumn":75},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":773,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":773,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":775,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":775,"endColumn":69},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":780,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":780,"endColumn":62},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":791,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":791,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":821,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":821,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":845,"column":95,"nodeType":"Identifier","messageId":"unusedVar","endLine":845,"endColumn":96},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":860,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":860,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":872,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":872,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":877,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":877,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":894,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":894,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":925,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":925,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":947,"column":93,"nodeType":"Identifier","messageId":"unusedVar","endLine":947,"endColumn":94},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":962,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":962,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":977,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":977,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":981,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":981,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1007,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1007,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1019,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1019,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1022,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1022,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1043,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1043,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1055,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1055,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1058,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1058,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1070,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1070,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1082,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1082,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1100,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1100,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1112,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1112,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1300,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":1300,"endColumn":13},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1425,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":1425,"endColumn":12},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1446,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1446,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1462,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1462,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1558,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1558,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1571,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1571,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1582,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1582,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1620,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1620,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1633,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1633,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1646,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1646,"endColumn":16},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1696,"column":90,"nodeType":"Identifier","messageId":"unusedVar","endLine":1696,"endColumn":91},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":1710,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":1710,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":71,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\n// components/firebase.js\n\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { initializeApp } from \"firebase/app\";\nimport { getAuth, getReactNativePersistence, initializeAuth, signInWithEmailAndPassword } from \"firebase/auth\";\nimport { addDoc, collection, collectionGroup, deleteDoc, doc, getDoc, getDocs, getDocsFromServer, getFirestore, limit, onSnapshot, orderBy, query, serverTimestamp, setDoc, updateDoc, where } from \"firebase/firestore\";\nimport { getFunctions, httpsCallable } from 'firebase/functions';\nimport { getDownloadURL, getStorage, ref as storageRef } from 'firebase/storage';\nimport { Alert, Platform } from 'react-native';\n\n// Firebase-konfiguration för DigitalKontroll\nconst firebaseConfig = {\n  apiKey: \"AIzaSyDI7SzOdfwV6wx0Igs8-Kdb8Zhuxwm7BWk\",\n  authDomain: \"digitalkontroll-8fd05.firebaseapp.com\",\n  projectId: \"digitalkontroll-8fd05\",\n  storageBucket: \"digitalkontroll-8fd05.firebasestorage.app\",\n  messagingSenderId: \"753073457092\",\n  appId: \"1:753073457092:web:937d55d391cbe78be40691\",\n  measurementId: \"G-EF1JRB9Y2E\"\n};\n\n// Initiera Firebase\nconst app = initializeApp(firebaseConfig);\n\n// Storage (for branding assets like company logos)\nexport const storage = getStorage(app);\n\n// Initiera autentisering & Firestore\n// Webb: använd standard getAuth. Native: använd initializeAuth med AsyncStorage-persistens\nlet auth;\nif (Platform.OS === 'web') {\n  auth = getAuth(app);\n} else {\n  auth = initializeAuth(app, {\n    persistence: getReactNativePersistence(AsyncStorage),\n  });\n}\nexport { auth };\nexport const db = getFirestore(app);\n// Functions client\nlet _functionsClient = null;\ntry {\n  _functionsClient = getFunctions(app);\n} catch (e) {\n  _functionsClient = null;\n}\nexport const functionsClient = _functionsClient;\n\n// Emulator connection disabled - using production Firebase\n// If running in a browser on localhost, connect the Functions client to the emulator\n/*\ntry {\n  if (typeof window !== 'undefined' && window.location && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {\n    try {\n      if (functionsClient && typeof connectFunctionsEmulator === 'function') {\n        // default emulator port used by firebase emulators: 5001\n        connectFunctionsEmulator(functionsClient, 'localhost', 5001);\n        console.log('[firebase] connected functions client to emulator at localhost:5001');\n      }\n    } catch (e) { console.warn('[firebase] could not connect functions emulator', e); }\n  }\n} catch(e) {}\n\n// Also connect Firestore and Auth clients to local emulators when running on localhost\ntry {\n  if (typeof window !== 'undefined' && window.location && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {\n    try {\n      if (typeof connectFirestoreEmulator === 'function' && db) {\n        // Firestore emulator in this project configured to 8085\n        connectFirestoreEmulator(db, 'localhost', 8085);\n        console.log('[firebase] connected firestore client to emulator at localhost:8085');\n      }\n    } catch (e) { console.warn('[firebase] could not connect firestore emulator', e); }\n    try {\n      if (typeof connectAuthEmulator === 'function' && auth) {\n        // Auth emulator default port 9099\n        try { connectAuthEmulator(auth, 'http://localhost:9099', { disableWarnings: true }); } catch(e) { connectAuthEmulator(auth, 'http://localhost:9099'); }\n        console.log('[firebase] connected auth client to emulator at http://localhost:9099');\n      }\n    } catch (e) { console.warn('[firebase] could not connect auth emulator', e); }\n  }\n} catch(e) {}\n*/\n\n// Callable wrappers\nexport async function createUserRemote({ companyId, email, displayName, role }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'createUser');\n  const payload = { companyId, email, displayName };\n  if (role !== undefined) payload.role = role;\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function deleteUserRemote({ companyId, uid }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'deleteUser');\n  const res = await fn({ companyId, uid });\n  return res && res.data ? res.data : res;\n}\n\nexport async function updateUserRemote({ companyId, uid, displayName, email, role, password }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'updateUser');\n  const payload = { companyId, uid };\n  if (displayName !== undefined) payload.displayName = displayName;\n  if (email !== undefined) payload.email = email;\n  if (role !== undefined) payload.role = role;\n  if (password !== undefined) payload.password = password;\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function adminFetchCompanyMembers(companyId) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'adminFetchCompanyMembers');\n  const res = await fn({ companyId });\n  return res && res.data ? res.data : res;\n}\n\nexport async function provisionCompanyRemote({ companyId, companyName }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'provisionCompany');\n  const res = await fn({ companyId, companyName });\n  return res && res.data ? res.data : res;\n}\n\nexport async function setSuperadminRemote({ email, uid }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'setSuperadmin');\n  const res = await fn({ email, uid });\n  return res && res.data ? res.data : res;\n}\n\nexport async function setCompanyStatusRemote({ companyId, enabled, deleted }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'setCompanyStatus');\n  const payload = { companyId };\n  if (enabled !== undefined) payload.enabled = enabled;\n  if (deleted !== undefined) payload.deleted = deleted;\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function setCompanyUserLimitRemote({ companyId, userLimit }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'setCompanyUserLimit');\n  const payload = { companyId, userLimit };\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function setCompanyNameRemote({ companyId, companyName }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'setCompanyName');\n  const payload = { companyId, companyName };\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function purgeCompanyRemote({ companyId }) {\n  if (!functionsClient) throw new Error('Functions client not initialized');\n  const fn = httpsCallable(functionsClient, 'purgeCompany');\n  const payload = { companyId };\n  const res = await fn(payload);\n  return res && res.data ? res.data : res;\n}\n\nexport async function fetchAdminAuditForCompany(companyId, limitCount = 50) {\n  if (!db) throw new Error('Firestore not initialized');\n  const q = query(\n    collection(db, 'admin_audit'),\n    where('companyId', '==', companyId)\n  );\n  const snap = await getDocs(q);\n  const items = [];\n  snap.forEach((docSnap) => {\n    const data = docSnap.data() || {};\n    items.push({ id: docSnap.id, ...data });\n  });\n  // Sortera senaste först på klientsidan för att undvika composite index-krav\n  items.sort((a, b) => {\n    const ta = a && a.ts && typeof a.ts.toMillis === 'function' ? a.ts.toMillis() : 0;\n    const tb = b && b.ts && typeof b.ts.toMillis === 'function' ? b.ts.toMillis() : 0;\n    return tb - ta;\n  });\n  if (limitCount && items.length > limitCount) {\n    return items.slice(0, limitCount);\n  }\n  return items;\n}\n\n// Global admin audit fetcher. If companyId is provided, filters on that company,\n// otherwise returns latest events across all companies.\nexport async function fetchAdminAuditEvents({ companyId = null, limitCount = 100 } = {}) {\n  if (!db) throw new Error('Firestore not initialized');\n  const baseCol = collection(db, 'admin_audit');\n  let q;\n  if (companyId) {\n    // Endast filter på companyId här; sortering sker i klienten för att\n    // undvika krav på composite-index (companyId + ts).\n    q = query(baseCol, where('companyId', '==', companyId));\n  } else {\n    q = query(baseCol, orderBy('ts', 'desc'), limit(limitCount));\n  }\n  const snap = await getDocs(q);\n  const items = [];\n  snap.forEach((docSnap) => {\n    const data = docSnap.data() || {};\n    items.push({ id: docSnap.id, ...data });\n  });\n  // Säkerställ konsekvent sortering (senaste först) även i filtrerat läge\n  items.sort((a, b) => {\n    const ta = a && a.ts && typeof a.ts.toMillis === 'function' ? a.ts.toMillis() : 0;\n    const tb = b && b.ts && typeof b.ts.toMillis === 'function' ? b.ts.toMillis() : 0;\n    return tb - ta;\n  });\n  if (limitCount && items.length > limitCount) {\n    return items.slice(0, limitCount);\n  }\n  return items;\n}\n\nasync function getAuthDebugSnapshot() {\n  const snap = {\n    projectId: firebaseConfig?.projectId || null,\n    uid: auth?.currentUser?.uid || null,\n    email: auth?.currentUser?.email || null,\n    claimsCompanyId: null,\n    storedCompanyId: null,\n  };\n  try {\n    if (auth?.currentUser?.getIdTokenResult) {\n      const tokenRes = await auth.currentUser.getIdTokenResult(false).catch((e) => null);\n      snap.claimsCompanyId = tokenRes?.claims?.companyId || null;\n    }\n  } catch(e) {}\n  try {\n    snap.storedCompanyId = await AsyncStorage.getItem('dk_companyId');\n  } catch(e) {}\n  return snap;\n}\n\nasync function resolveCompanyId(preferredCompanyId, payload) {\n  // Prefer explicit override first.\n  // In onboarding / role changes it's common that custom claims are stale until\n  // the client refreshes its token; using the override avoids querying the wrong company.\n  if (preferredCompanyId) return preferredCompanyId;\n\n  // Next prefer payload-provided companyId.\n  if (payload && payload.companyId) return payload.companyId;\n\n  // Finally fall back to authenticated user's companyId claim when available.\n  try {\n    const user = auth && auth.currentUser;\n    if (user && user.getIdTokenResult) {\n      const tokenRes = await user.getIdTokenResult(false).catch((e) => null);\n      const claims = tokenRes && tokenRes.claims ? tokenRes.claims : {};\n      if (claims && claims.companyId) return claims.companyId;\n    }\n  } catch(e) {}\n\n  try {\n    const stored = await AsyncStorage.getItem('dk_companyId');\n    if (stored) return stored;\n  } catch(e) {}\n  return null;\n}\n\n// Sanitize objects for Firestore: Firestore does not allow nested arrays (arrays inside arrays).\n// Convert any nested array values into an object map with numeric keys so writes succeed.\nfunction sanitizeForFirestore(value) {\n  // Ensure no nested arrays exist anywhere in the data structure.\n  // Firestore rejects nested arrays (arrays that contain arrays anywhere inside them).\n  // Strategy:\n  // - Walk the value recursively.\n  // - If an array is found that contains another array anywhere in its subtree,\n  //   convert that array into an object keyed by index (so Firestore accepts it).\n  // - Otherwise keep arrays as arrays but ensure their elements are sanitized.\n  function containsArray(v) {\n    if (!v) return false;\n    if (Array.isArray(v)) return true;\n    if (typeof v === 'object') {\n      for (const k of Object.keys(v)) if (containsArray(v[k])) return true;\n    }\n    return false;\n  }\n\n  function _walk(v) {\n    if (Array.isArray(v)) {\n      // If any element (recursively) contains an array, convert the whole array to an object\n      // keyed by index to avoid nested arrays anywhere.\n      const hasNested = v.some(el => containsArray(el));\n      if (hasNested) {\n        const obj = {};\n        for (let i = 0; i < v.length; i++) obj[i] = _walk(v[i]);\n        return obj;\n      }\n      // Safe to keep as array; sanitize elements.\n      return v.map(el => _walk(el));\n    }\n    if (v && typeof v === 'object' && !(v instanceof Date)) {\n      const out = {};\n      for (const k of Object.keys(v)) out[k] = _walk(v[k]);\n      return out;\n    }\n    return v;\n  }\n\n  try {\n    return _walk(value);\n  } catch(e) {\n    console.warn('[firebase] sanitizeForFirestore failed, falling back to JSON stringify', e);\n    // As a last resort, stringify the whole payload so setDoc won't throw nested-array errors.\n    try {\n      return { __json: JSON.stringify(value) };\n    } catch(e) {\n      return null;\n    }\n  }\n}\n\n// Helpers for syncing hierarchy per company\nexport async function fetchHierarchy(companyId) {\n  if (!companyId) return [];\n  try {\n    const ref = doc(db, 'foretag', companyId, 'hierarki', 'state');\n    const snap = await getDoc(ref);\n    if (snap.exists()) {\n      const data = snap.data();\n      return Array.isArray(data.items) ? data.items : [];\n    }\n  } catch(e) {\n    // Silent fail -> caller can fall back to local storage\n  }\n  return [];\n}\n\nexport async function saveHierarchy(companyId, items) {\n  if (!companyId) return false;\n  try {\n    const ref = doc(db, 'foretag', companyId, 'hierarki', 'state');\n    // write items with server timestamp\n    await setDoc(ref, { items, updatedAt: serverTimestamp() }, { merge: true });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\n// Company profile: name, logoUrl, etc.\nexport async function fetchCompanyProfile(companyId) {\n  if (!companyId) return null;\n  try {\n    const ref = doc(db, 'foretag', companyId, 'profil', 'public');\n    const snap = await getDoc(ref);\n    if (snap.exists()) return snap.data();\n  } catch(e) {}\n  return null;\n}\n\n// Fetch a flat list of companies (foretag). Returns array of { id, profile }\nexport async function fetchCompanies() {\n  try {\n    // Firestore rules do not allow listing /foretag docs directly, but\n    // profiles under /foretag/{company}/profil/{docId} are world-readable.\n    // Use a collection group on \"profil\" and then map each \"public\" doc\n    // back to its company id.\n    const baseRef = collectionGroup(db, 'profil');\n    const snap = await getDocs(baseRef);\n    const out = [];\n\n    snap.forEach((d) => {\n      try {\n        if (!d || d.id !== 'public') return; // only use the public profile docs\n        const profilCol = d.ref.parent; // .../foretag/{company}/profil\n        const companyDoc = profilCol && profilCol.parent; // .../foretag/{company}\n        const companyId = companyDoc && companyDoc.id ? companyDoc.id : null;\n        if (!companyId) return;\n        out.push({ id: companyId, profile: d.data() || null });\n      } catch (e) {\n        // Ignore individual mapping errors; continue with others\n      }\n    });\n\n    // Sort by display name if available, otherwise by id\n    out.sort((a, b) => {\n      const an = String((a.profile && (a.profile.companyName || a.profile.name)) || a.id || '').toLowerCase();\n      const bn = String((b.profile && (b.profile.companyName || b.profile.name)) || b.id || '').toLowerCase();\n      return an.localeCompare(bn, undefined, { sensitivity: 'base' });\n    });\n\n    return out;\n  } catch (e) {\n    return [];\n  }\n}\n\n// Resolve the company logo URL from profile.public.logoUrl.\n// Supports both https(s) URLs and gs:// storage URLs.\nexport async function resolveCompanyLogoUrl(companyId) {\n  if (!companyId) return null;\n  const profile = await fetchCompanyProfile(companyId);\n  const logoUrl = profile?.logoUrl || null;\n  if (!logoUrl) return null;\n\n  // If a gs:// URL is stored, convert it to an HTTPS download URL.\n  if (typeof logoUrl === 'string' && logoUrl.trim().toLowerCase().startsWith('gs://')) {\n    try {\n      const raw = logoUrl.trim();\n      const match = raw.match(/^gs:\\/\\/([^\\/]+)\\/(.+)$/i);\n      const bucket = match && match[1] ? String(match[1]) : '';\n      const fullPath = match && match[2] ? String(match[2]) : '';\n      if (!fullPath) return null;\n\n      // Some environments are picky about ref-from-gs:// URLs. Use bucket+path explicitly.\n      // Also handle common mismatch between provided bucket domains.\n      const bucketCandidates = [];\n      if (bucket) {\n        bucketCandidates.push(bucket);\n        if (bucket.toLowerCase().endsWith('.firebasestorage.app')) {\n          bucketCandidates.push(bucket.replace(/\\.firebasestorage\\.app$/i, '.appspot.com'));\n        }\n      }\n\n      for (const b of bucketCandidates.length > 0 ? bucketCandidates : ['']) {\n        try {\n          // On web prefer the public GCS URL (avoids tokenized REST calls that sometimes 403 in browsers)\n          if (Platform && Platform.OS === 'web' && b) {\n            try {\n              const publicUrl = 'https://storage.googleapis.com/' + b + '/' + encodeURI(fullPath.replace(/^\\/+/, ''));\n              return publicUrl;\n            } catch (e) {\n              // fall back to SDK below\n            }\n          }\n          const st = b ? getStorage(app, `gs://${b}`) : storage;\n          const r = storageRef(st, fullPath);\n          const https = await getDownloadURL(r);\n          if (https) return https;\n        } catch (inner) {\n          // fall through and try other bucket candidates\n        }\n      }\n\n      return null;\n    } catch(e) {\n      return null;\n    }\n  }\n\n  return logoUrl;\n}\n\nexport async function saveCompanyProfile(companyId, profile) {\n  if (!companyId) return false;\n  try {\n    const ref = doc(db, 'foretag', companyId, 'profil', 'public');\n    await setDoc(ref, profile, { merge: true });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\n// User profile helpers\nexport async function fetchUserProfile(uid) {\n  if (!uid) return null;\n  try {\n    const ref = doc(db, 'users', uid);\n    const snap = await getDoc(ref);\n    if (snap.exists()) return snap.data();\n  } catch(e) {}\n  return null;\n}\n\n// Company member directory (scoped under foretag/{companyId}/members/{uid})\n// Used for listing admins and other roles inside a company.\nexport async function upsertCompanyMember({ companyId: companyIdOverride, uid, displayName, email, role }) {\n  try {\n    if (!uid) return false;\n    const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\n    if (!companyId) return false;\n    const ref = doc(db, 'foretag', companyId, 'members', uid);\n    await setDoc(ref, {\n      uid,\n      companyId,\n      displayName: displayName || null,\n      email: email || null,\n      role: role || null,\n      updatedAt: serverTimestamp(),\n    }, { merge: true });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\nexport async function fetchCompanyMembers(companyIdOverride, { role } = {}) {\n  async function attemptRead({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n\n    const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\n    if (!companyId) return { ok: true, out: [], err: null, permissionDenied: false, companyId: null };\n\n    try {\n      const baseRef = collection(db, 'foretag', companyId, 'members');\n      const q = role ? query(baseRef, where('role', '==', role)) : query(baseRef);\n      // Prefer server to avoid stale/empty cache on fresh logins.\n      let snap;\n      try {\n        snap = await getDocsFromServer(q);\n      } catch(e) {\n        snap = await getDocs(q);\n      }\n      const out = [];\n      snap.forEach(d => out.push({ id: d.id, ...d.data() }));\n      out.sort((a, b) => String(a.displayName || a.email || '').localeCompare(String(b.displayName || b.email || ''), undefined, { sensitivity: 'base' }));\n      return {\n        ok: true,\n        out,\n        err: null,\n        permissionDenied: false,\n        companyId,\n        meta: {\n          size: snap?.size ?? out.length,\n          fromCache: snap?.metadata?.fromCache ?? null,\n        }\n      };\n    } catch (e) {\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      return { ok: false, out: [], err: e, permissionDenied, companyId, meta: null };\n    }\n  }\n\n  try {\n    const first = await attemptRead({ forceTokenRefresh: false });\n    if (first.ok) return first.out;\n\n    if (first.permissionDenied) {\n      const second = await attemptRead({ forceTokenRefresh: true });\n      if (second.ok) return second.out;\n\n      // Persist debug info so we can inspect on the client via existing debug UI.\n      try {\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n        let arr = rawArr ? JSON.parse(rawArr) : [];\n        const debug = await getAuthDebugSnapshot();\n        const entry = {\n          fn: 'fetchCompanyMembers',\n          code: second.err?.code || first.err?.code || null,\n          err: (second.err && second.err.message) ? second.err.message : ((first.err && first.err.message) ? first.err.message : String(second.err || first.err)),\n          ts: new Date().toISOString(),\n          role: role || null,\n          resolvedCompanyId: second.companyId || first.companyId || null,\n          auth: debug,\n        };\n        arr.push(entry);\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n      } catch(e) {}\n\n      return [];\n    }\n\n    // Log any non-permission errors too (e.g. failed-precondition, offline, etc)\n    try {\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      let arr = rawArr ? JSON.parse(rawArr) : [];\n      const debug = await getAuthDebugSnapshot();\n      const entry = {\n        fn: 'fetchCompanyMembers',\n        code: first.err?.code || null,\n        err: (first.err && first.err.message) ? first.err.message : String(first.err),\n        ts: new Date().toISOString(),\n        role: role || null,\n        resolvedCompanyId: first.companyId || null,\n        meta: first.meta || null,\n        auth: debug,\n      };\n      arr.push(entry);\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n    } catch(e) {}\n\n    return [];\n  } catch(e) {\n    return [];\n  }\n}\n\n// Realtime subscription for company members (used for ansvarig picker).\n// Returns an unsubscribe function.\nexport function subscribeCompanyMembers(companyIdOverride, { role, onData, onError } = {}) {\n  let unsub = null;\n  (async () => {\n    try {\n      const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\n      if (!companyId) {\n        try { if (typeof onData === 'function') onData([], { size: 0, fromCache: null, companyId: null }); } catch(e) {}\n        return;\n      }\n      const baseRef = collection(db, 'foretag', companyId, 'members');\n      const q = role ? query(baseRef, where('role', '==', role)) : query(baseRef);\n      unsub = onSnapshot(\n        q,\n        (snap) => {\n          const out = [];\n          snap.forEach(d => out.push({ id: d.id, ...d.data() }));\n          out.sort((a, b) => String(a.displayName || a.email || '').localeCompare(String(b.displayName || b.email || ''), undefined, { sensitivity: 'base' }));\n          try {\n            if (typeof onData === 'function') {\n              onData(out, { size: snap.size, fromCache: snap.metadata?.fromCache ?? null, companyId });\n            }\n          } catch(e) {}\n        },\n        (err) => {\n          try { if (typeof onError === 'function') onError(err); } catch(e) {}\n        }\n      );\n    } catch(e) {\n      try { if (typeof onError === 'function') onError(e); } catch(e) {}\n    }\n  })();\n\n  return () => {\n    try { if (typeof unsub === 'function') unsub(); } catch(e) {}\n  };\n}\n\n// Save or update a user's profile document (client-side safe helper)\nexport async function saveUserProfile(uid, data) {\n  if (!uid) return false;\n  try {\n    const ref = doc(db, 'users', uid);\n    await setDoc(ref, data, { merge: true });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\nexport async function signInEmailPassword(email, password) {\n  return signInWithEmailAndPassword(auth, email, password);\n}\n\n// Log user actions (egenkontroller, skyddsronder) with company context\nexport async function logUserAction({ uid, email, companyId, type, payload }) {\n  try {\n    const ref = collection(db, 'logs');\n    await addDoc(ref, {\n      uid: uid || null,\n      email: email || null,\n      companyId: companyId || null,\n      type, // e.g. 'egenkontroll' | 'skyddsrond'\n      payload: payload || {},\n      ts: serverTimestamp(),\n    });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\n// Company-scoped activity feed (for dashboard \"Senaste aktivitet\")\n// Storage: foretag/{companyId}/activity\n// Event shape example:\n// { type: 'login', uid, email, displayName, ts }\nexport async function logCompanyActivity(event, companyIdOverride) {\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, event || null);\n    if (!companyId) return false;\n    const ref = collection(db, 'foretag', companyId, 'activity');\n    const payload = Object.assign({}, event || {}, {\n      companyId,\n      ts: serverTimestamp(),\n    });\n    await addDoc(ref, sanitizeForFirestore(payload));\n    return true;\n  } catch(e) {\n    // Record last Firestore error for debugging (permission-denied, etc)\n    try {\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      let arr = rawArr ? JSON.parse(rawArr) : [];\n      const debug = await getAuthDebugSnapshot();\n      const entry = {\n        fn: 'logCompanyActivity',\n        code: e?.code || null,\n        err: (e && e.message) ? e.message : String(e),\n        ts: new Date().toISOString(),\n        companyIdOverride: companyIdOverride || null,\n        eventType: event?.type || null,\n        auth: debug,\n      };\n      arr.push(entry);\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n    } catch(e) {}\n    return false;\n  }\n}\n\n// Realtime subscription for company activity feed.\n// Returns an unsubscribe function.\nexport function subscribeCompanyActivity(companyIdOverride, { onData, onError, limitCount = 25 } = {}) {\n  let unsub = null;\n  (async () => {\n    try {\n      const companyId = await resolveCompanyId(companyIdOverride, { companyId: companyIdOverride });\n      if (!companyId) {\n        try { if (typeof onData === 'function') onData([], { size: 0, fromCache: null, companyId: null }); } catch(e) {}\n        return;\n      }\n      const baseRef = collection(db, 'foretag', companyId, 'activity');\n      const q = query(baseRef, orderBy('ts', 'desc'), limit(Math.max(1, Math.min(100, Number(limitCount) || 25))));\n      unsub = onSnapshot(\n        q,\n        (snap) => {\n          const out = [];\n          snap.forEach(d => out.push({ id: d.id, ...d.data() }));\n          try {\n            if (typeof onData === 'function') {\n              onData(out, { size: snap.size, fromCache: snap.metadata?.fromCache ?? null, companyId });\n            }\n          } catch(e) {}\n        },\n        (err) => {\n          // Record last Firestore error for debugging\n          (async () => {\n            try {\n              const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n              let arr = rawArr ? JSON.parse(rawArr) : [];\n              const debug = await getAuthDebugSnapshot();\n              const entry = {\n                fn: 'subscribeCompanyActivity',\n                code: err?.code || null,\n                err: (err && err.message) ? err.message : String(err),\n                ts: new Date().toISOString(),\n                companyIdOverride: companyIdOverride || null,\n                auth: debug,\n              };\n              arr.push(entry);\n              await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n              await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n            } catch(e) {}\n          })();\n          try { if (typeof onError === 'function') onError(err); } catch(e) {}\n        }\n      );\n    } catch(e) {\n      // Record last Firestore error for debugging\n      (async () => {\n        try {\n          const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n          let arr = rawArr ? JSON.parse(rawArr) : [];\n          const debug = await getAuthDebugSnapshot();\n          const entry = {\n            fn: 'subscribeCompanyActivity',\n            code: e?.code || null,\n            err: (e && e.message) ? e.message : String(e),\n            ts: new Date().toISOString(),\n            companyIdOverride: companyIdOverride || null,\n            auth: debug,\n          };\n          arr.push(entry);\n          await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n          await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n        } catch(e) {}\n      })();\n      try { if (typeof onError === 'function') onError(e); } catch(e) {}\n    }\n  })();\n\n  return () => {\n    try { if (typeof unsub === 'function') unsub(); } catch(e) {}\n  };\n}\n\n// Controls persistence helpers\nexport async function saveControlToFirestore(control, companyIdOverride) {\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (!control) return { ok: false, err: null, permissionDenied: false };\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n    const companyId = await resolveCompanyId(companyIdOverride, control);\n    if (!companyId) return { ok: false, err: null, permissionDenied: false };\n    const id = control.id || (new Date().getTime().toString());\n    const ref = doc(db, 'foretag', companyId, 'controls', id);\n    // Normalize project shape: some older local items use `projectId` instead of `project: { id }`\n    const projectObj = control.project || (control.projectId ? { id: control.projectId } : (control.project && control.project.id ? { id: control.project.id } : undefined));\n    const payload = Object.assign({}, control, {\n      companyId,\n      project: projectObj,\n      projectId: projectObj?.id || control.projectId || control.project?.id,\n      savedAt: serverTimestamp()\n    });\n    const safePayload = sanitizeForFirestore(payload);\n    try {\n      await setDoc(ref, safePayload, { merge: true });\n    } catch(e) {\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      return { ok: false, err: e, permissionDenied };\n    }\n    // Also persist a local copy so the native app shows the item immediately\n    try {\n      const raw = await AsyncStorage.getItem('completed_controls');\n      let arr = raw ? JSON.parse(raw) || [] : [];\n      // avoid duplicate by id\n      if (!arr.find(a => a && a.id === id)) {\n        arr.push({ ...control, id, savedAt: new Date().toISOString() });\n        await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\n      }\n    } catch(e) {\n      // ignore local persist failures\n    }\n    return { ok: true, err: null, permissionDenied: false };\n  }\n\n  try {\n    const first = await attemptWrite({ forceTokenRefresh: false });\n    if (first.ok) return true;\n    if (first.permissionDenied) {\n      // Very common: custom claims were just set but the client token hasn't refreshed yet.\n      const second = await attemptWrite({ forceTokenRefresh: true });\n      if (second.ok) return true;\n      throw second.err || first.err || new Error('permission-denied');\n    }\n    throw first.err;\n  } catch(e) {\n      // If Firestore rejects due to permission issues, persist locally and show a friendly alert\n      const isPermissionError = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      try {\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n        let arr = rawArr ? JSON.parse(rawArr) : [];\n        const debug = await getAuthDebugSnapshot();\n        let resolvedCompanyId = null;\n        try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, control); } catch(e) {}\n        const entry = {\n          fn: 'saveControlToFirestore',\n          code: e?.code || null,\n          err: (e && e.message) ? e.message : String(e),\n          full: (e && e.stack) ? e.stack : String(e),\n          ts: new Date().toISOString(),\n          id: control && control.id ? control.id : null,\n          resolvedCompanyId,\n          auth: debug,\n        };\n        arr.push(entry);\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n        // keep single \"last\" key for compatibility\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n      } catch(e) {}\n\n      if (isPermissionError) {\n        // Save the control locally so the app doesn't lose data and can sync later\n        try {\n          const raw = await AsyncStorage.getItem('completed_controls');\n          let arr = raw ? JSON.parse(raw) || [] : [];\n          const id = control && control.id ? control.id : (new Date().getTime().toString());\n          if (!arr.find(a => a && a.id === id)) {\n            arr.push({ ...control, id, savedAt: new Date().toISOString() });\n            await AsyncStorage.setItem('completed_controls', JSON.stringify(arr));\n          }\n        } catch(e) {}\n\n        // Show friendly user-facing message and warn in console (avoid raw console.error to reduce noisy UI logs)\n        try {\n          Alert.alert('Sparat lokalt', 'Kontrollen sparades lokalt eftersom servern nekade skrivning. Appen kommer försöka synka senare.');\n        } catch(e) {}\n        console.warn('[firebase] saveControlToFirestore permission denied — saved locally');\n        return false;\n      }\n\n      // Fallback for other error types\n      console.error('[firebase] saveControlToFirestore error', e);\n      return false;\n    }\n}\n\nexport async function saveDraftToFirestore(draft, companyIdOverride) {\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (!draft) return { ok: false, err: null, permissionDenied: false };\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n    const companyId = await resolveCompanyId(companyIdOverride, draft);\n    if (!companyId) return { ok: false, err: null, permissionDenied: false };\n    const id = draft.id || (new Date().getTime().toString());\n    const ref = doc(db, 'foretag', companyId, 'draft_controls', id);\n    const projectObj = draft.project || (draft.projectId ? { id: draft.projectId } : (draft.project && draft.project.id ? { id: draft.project.id } : undefined));\n    const payload = Object.assign({}, draft, {\n      companyId,\n      project: projectObj,\n      projectId: projectObj?.id || draft.projectId || draft.project?.id,\n      savedAt: serverTimestamp()\n    });\n    const safePayload = sanitizeForFirestore(payload);\n    try {\n      await setDoc(ref, safePayload, { merge: true });\n    } catch(e) {\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      return { ok: false, err: e, permissionDenied };\n    }\n    // Also persist a local copy so native app retains the draft\n    try {\n      const raw = await AsyncStorage.getItem('draft_controls');\n      let arr = raw ? JSON.parse(raw) || [] : [];\n      const idx = arr.findIndex(a => a && a.id === id);\n      if (idx !== -1) {\n        arr[idx] = { ...draft, id, savedAt: new Date().toISOString() };\n      } else {\n        arr.push({ ...draft, id, savedAt: new Date().toISOString() });\n      }\n      await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\n    } catch(e) {\n      // ignore local persist failures\n    }\n    return { ok: true, err: null, permissionDenied: false };\n  }\n\n  try {\n    const first = await attemptWrite({ forceTokenRefresh: false });\n    if (first.ok) return true;\n    if (first.permissionDenied) {\n      const second = await attemptWrite({ forceTokenRefresh: true });\n      if (second.ok) return true;\n      throw second.err || first.err || new Error('permission-denied');\n    }\n    throw first.err;\n  } catch(e) {\n      const isPermissionError = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      try {\n        const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n        let arr = rawArr ? JSON.parse(rawArr) : [];\n        const debug = await getAuthDebugSnapshot();\n        let resolvedCompanyId = null;\n        try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, draft); } catch(e) {}\n        const entry = {\n          fn: 'saveDraftToFirestore',\n          code: e?.code || null,\n          err: (e && e.message) ? e.message : String(e),\n          full: (e && e.stack) ? e.stack : String(e),\n          ts: new Date().toISOString(),\n          id: draft && draft.id ? draft.id : null,\n          resolvedCompanyId,\n          auth: debug,\n        };\n        arr.push(entry);\n        await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n        // keep single \"last\" key for compatibility\n        await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n      } catch(e) {}\n\n      if (isPermissionError) {\n        // Save the draft locally so user doesn't lose work\n        try {\n          const raw = await AsyncStorage.getItem('draft_controls');\n          let arr = raw ? JSON.parse(raw) || [] : [];\n          const id = draft && draft.id ? draft.id : (new Date().getTime().toString());\n          const idx = arr.findIndex(a => a && a.id === id);\n          if (idx !== -1) {\n            arr[idx] = { ...draft, id, savedAt: new Date().toISOString() };\n          } else {\n            arr.push({ ...draft, id, savedAt: new Date().toISOString() });\n          }\n          await AsyncStorage.setItem('draft_controls', JSON.stringify(arr));\n        } catch(e) {}\n\n        try {\n          Alert.alert('Sparat lokalt', 'Utkast sparades lokalt eftersom servern nekade skrivning. Appen kommer försöka synka senare.');\n        } catch(e) {}\n        console.warn('[firebase] saveDraftToFirestore permission denied — saved locally');\n        return false;\n      }\n\n      console.error('[firebase] saveDraftToFirestore error', e);\n      return false;\n    }\n}\n\n// Fetch controls for a single project from Firestore\nexport async function fetchControlsForProject(projectId, companyIdOverride) {\n  if (!projectId) return [];\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return [];\n    const out = [];\n\n    // Prefer querying on normalized projectId field\n    try {\n      const q1 = query(collection(db, 'foretag', companyId, 'controls'), where('projectId', '==', projectId));\n      const snap1 = await getDocs(q1);\n      snap1.forEach(docSnap => {\n        const d = docSnap.data() || {};\n        out.push(Object.assign({}, d, { id: docSnap.id }));\n      });\n    } catch(e) {}\n\n    // Backward compatibility: some items may have only project.id\n    try {\n      const q2 = query(collection(db, 'foretag', companyId, 'controls'), where('project.id', '==', projectId));\n      const snap2 = await getDocs(q2);\n      snap2.forEach(docSnap => {\n        if (!out.find(x => x && x.id === docSnap.id)) {\n          const d = docSnap.data() || {};\n          out.push(Object.assign({}, d, { id: docSnap.id }));\n        }\n      });\n    } catch(e) {}\n\n    return out;\n  } catch(e) {\n    return [];\n  }\n}\n\n// Fetch draft controls for a single project from Firestore\nexport async function fetchDraftControlsForProject(projectId, companyIdOverride) {\n  if (!projectId) return [];\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return [];\n    const out = [];\n\n    // Prefer querying on normalized projectId field\n    try {\n      const q1 = query(collection(db, 'foretag', companyId, 'draft_controls'), where('projectId', '==', projectId));\n      const snap1 = await getDocs(q1);\n      snap1.forEach(docSnap => {\n        const d = docSnap.data() || {};\n        out.push(Object.assign({}, d, { id: docSnap.id }));\n      });\n    } catch(e) {}\n\n    // Backward compatibility: some items may have only project.id\n    try {\n      const q2 = query(collection(db, 'foretag', companyId, 'draft_controls'), where('project.id', '==', projectId));\n      const snap2 = await getDocs(q2);\n      snap2.forEach(docSnap => {\n        if (!out.find(x => x && x.id === docSnap.id)) {\n          const d = docSnap.data() || {};\n          out.push(Object.assign({}, d, { id: docSnap.id }));\n        }\n      });\n    } catch(e) {}\n\n    return out;\n  } catch(e) {\n    return [];\n  }\n}\n\nexport async function deleteDraftControlFromFirestore(draftId, companyIdOverride) {\n  try {\n    if (!draftId) return false;\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return false;\n    await deleteDoc(doc(db, 'foretag', companyId, 'draft_controls', String(draftId)));\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\nexport async function deleteControlFromFirestore(controlId, companyIdOverride) {\n  try {\n    if (!controlId) return false;\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return false;\n    await deleteDoc(doc(db, 'foretag', companyId, 'controls', String(controlId)));\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\n// Byggdel-hierarki per företag\n// Storage: foretag/{companyId}/byggdel_hierarki/state\n// Shape: { momentsByGroup: { [huvudgrupp: string]: string[] }, updatedAt }\nexport async function fetchByggdelHierarchy(companyIdOverride) {\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return { momentsByGroup: {} };\n    const ref = doc(db, 'foretag', companyId, 'byggdel_hierarki', 'state');\n    const snap = await getDoc(ref);\n    if (!snap.exists()) return { momentsByGroup: {} };\n    const data = snap.data() || {};\n    const momentsByGroup = (data && typeof data.momentsByGroup === 'object' && data.momentsByGroup) ? data.momentsByGroup : {};\n    return { momentsByGroup };\n  } catch(e) {\n    return { momentsByGroup: {} };\n  }\n}\n\nexport async function saveByggdelHierarchy({ momentsByGroup }, companyIdOverride) {\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return false;\n    const ref = doc(db, 'foretag', companyId, 'byggdel_hierarki', 'state');\n    await setDoc(ref, { momentsByGroup: momentsByGroup || {}, updatedAt: serverTimestamp() }, { merge: true });\n    return true;\n  } catch(e) {\n    return false;\n  }\n}\n\n// Default kontrolltyper (globala standarder) som alltid finns tillgängliga.\n// Dessa kan kompletteras med företags-specifika kontrolltyper i\n// /foretag/{companyId}/kontrolltyper.\nexport const DEFAULT_CONTROL_TYPES = [\n  { key: 'arbetsberedning', name: 'Arbetsberedning', icon: 'construct-outline', color: '#1976D2', order: 10, builtin: true },\n  { key: 'egenkontroll', name: 'Egenkontroll', icon: 'checkmark-done-outline', color: '#388E3C', order: 20, builtin: true },\n  { key: 'fuktmatning', name: 'Fuktmätning', icon: 'water-outline', color: '#0288D1', order: 30, builtin: true },\n  { key: 'mottagningskontroll', name: 'Mottagningskontroll', icon: 'checkbox-outline', color: '#7B1FA2', order: 40, builtin: true },\n  { key: 'riskbedomning', name: 'Riskbedömning', icon: 'warning-outline', color: '#FFD600', order: 50, builtin: true },\n  { key: 'skyddsrond', name: 'Skyddsrond', icon: 'shield-half-outline', color: '#388E3C', order: 60, builtin: true },\n];\n\nexport async function fetchCompanyControlTypes(companyIdOverride) {\n  const base = DEFAULT_CONTROL_TYPES.slice();\n  const companyId = await resolveCompanyId(companyIdOverride, null);\n  if (!companyId) return base;\n  try {\n    const colRef = collection(db, 'foretag', companyId, 'kontrolltyper');\n    const snap = await getDocs(colRef);\n    const extras = [];\n    snap.forEach((docSnap) => {\n      try {\n        const data = docSnap.data() || {};\n        const key = String(data.key || docSnap.id || data.name || '').trim() || `ct_${docSnap.id}`;\n        // Bygg en patch som bara innehåller de fält som faktiskt finns på dokumentet\n        // så att vi inte råkar skriva över standardvärden (namn/ikon/färg) när en\n        // override bara vill sätta t.ex. `hidden: true`.\n        const patch = { key, builtin: false, id: docSnap.id };\n        if (Object.prototype.hasOwnProperty.call(data, 'name') || Object.prototype.hasOwnProperty.call(data, 'title')) {\n          const name = String(data.name || data.title || key).trim();\n          if (name) patch.name = name;\n        }\n        if (Object.prototype.hasOwnProperty.call(data, 'icon')) {\n          const icon = String(data.icon || '').trim();\n          if (icon) patch.icon = icon;\n        }\n        if (Object.prototype.hasOwnProperty.call(data, 'color')) {\n          const color = String(data.color || '').trim();\n          if (color) patch.color = color;\n        }\n        if (Object.prototype.hasOwnProperty.call(data, 'order') && typeof data.order === 'number' && Number.isFinite(data.order)) {\n          patch.order = data.order;\n        }\n        if (Object.prototype.hasOwnProperty.call(data, 'hidden')) {\n          patch.hidden = !!data.hidden;\n        }\n        extras.push(patch);\n      } catch (_e) {}\n    });\n    if (!extras.length) return base;\n    const byKey = new Map();\n    base.forEach((t) => { byKey.set(String(t.key || t.name).toLowerCase(), t); });\n    // Overlay företags-specifika overrides ovanpå defaulttyperna i stället\n    // för att ersätta dem helt. På så sätt kan en override som bara sätter\n    // t.ex. `hidden: true` återanvända defaultens namn, ikon och färg.\n    extras.forEach((t) => {\n      const k = String(t.key || t.name).toLowerCase();\n      const existing = byKey.get(k) || {};\n      byKey.set(k, { ...existing, ...t });\n    });\n    const merged = Array.from(byKey.values());\n    merged.sort((a, b) => {\n      const ao = typeof a.order === 'number' ? a.order : 9999;\n      const bo = typeof b.order === 'number' ? b.order : 9999;\n      if (ao !== bo) return ao - bo;\n      const an = String(a.name || '').toLowerCase();\n      const bn = String(b.name || '').toLowerCase();\n      return an.localeCompare(bn, 'sv');\n    });\n    return merged;\n  } catch (_e) {\n    return base;\n  }\n}\n\n// Skapa en ny företags-specifik kontrolltyp under /foretag/{companyId}/kontrolltyper.\n// Minimal payload: { name }. Optionellt: { key, icon, color, order }.\nexport async function createCompanyControlType(payload, companyIdOverride) {\n  if (!payload || !payload.name) throw new Error('Namn på kontrolltyp saknas.');\n  const companyId = await resolveCompanyId(companyIdOverride, payload);\n  if (!companyId) throw new Error('Kunde inte avgöra företag för kontrolltypen.');\n  const name = String(payload.name || '').trim();\n  if (!name) throw new Error('Namn på kontrolltyp saknas.');\n  const keyRaw = String(payload.key || '').trim();\n  const key = keyRaw || name.toLowerCase().replace(/[^a-z0-9]+/gi, '-');\n  const icon = String(payload.icon || '').trim() || 'document-text-outline';\n  const color = String(payload.color || '').trim() || '#455A64';\n  const order = (typeof payload.order === 'number' && Number.isFinite(payload.order)) ? payload.order : null;\n  try {\n    const colRef = collection(db, 'foretag', companyId, 'kontrolltyper');\n    const docRef = await addDoc(colRef, sanitizeForFirestore({\n      key,\n      name,\n      icon,\n      color,\n      ...(order !== null ? { order } : {}),\n      createdAt: serverTimestamp(),\n    }));\n    return { id: docRef.id, key, name, icon, color, order };\n  } catch (e) {\n    throw new Error(e?.message || 'Kunde inte skapa kontrolltyp.');\n  }\n}\n\n// Uppdatera en befintlig företags-specifik kontrolltyp.\n// Payload ska innehålla antingen { id } eller { key } och valfria fält att uppdatera: { name, icon, color, order, hidden }.\nexport async function updateCompanyControlType(payload, companyIdOverride) {\n  const companyId = await resolveCompanyId(companyIdOverride, payload);\n  if (!companyId) throw new Error('Kunde inte avgöra företag för kontrolltypen.');\n  let docId = String(payload?.id || '').trim();\n  if (!docId) {\n    const keyRaw = String(payload?.key || '').trim();\n    if (!keyRaw) throw new Error('ID eller nyckel för kontrolltyp saknas.');\n    // Normalisera docId från key på samma sätt som createCompanyControlType gör för key.\n    docId = keyRaw.toLowerCase().replace(/[^a-z0-9]+/gi, '-');\n    if (!docId) throw new Error('Ogiltig nyckel för kontrolltyp.');\n  }\n\n  const patch = {};\n  if (Object.prototype.hasOwnProperty.call(payload, 'name')) {\n    const name = String(payload.name || '').trim();\n    if (!name) throw new Error('Namn på kontrolltyp saknas.');\n    patch.name = name;\n  }\n  if (Object.prototype.hasOwnProperty.call(payload, 'icon')) {\n    patch.icon = String(payload.icon || '').trim() || 'document-text-outline';\n  }\n  if (Object.prototype.hasOwnProperty.call(payload, 'color')) {\n    patch.color = String(payload.color || '').trim() || '#455A64';\n  }\n  if (Object.prototype.hasOwnProperty.call(payload, 'order')) {\n    if (typeof payload.order === 'number' && Number.isFinite(payload.order)) {\n      patch.order = payload.order;\n    }\n  }\n  if (Object.prototype.hasOwnProperty.call(payload, 'hidden')) {\n    patch.hidden = !!payload.hidden;\n  }\n\n  if (Object.keys(patch).length === 0) return true;\n\n  patch.updatedAt = serverTimestamp();\n\n  try {\n    const ref = doc(db, 'foretag', companyId, 'kontrolltyper', docId);\n    await setDoc(ref, sanitizeForFirestore(patch), { merge: true });\n    return true;\n  } catch (e) {\n    throw new Error(e?.message || 'Kunde inte uppdatera kontrolltyp.');\n  }\n}\n\n// Radera en företags-specifik kontrolltyp.\nexport async function deleteCompanyControlType(payload, companyIdOverride) {\n  const companyId = await resolveCompanyId(companyIdOverride, payload);\n  if (!companyId) throw new Error('Kunde inte avgöra företag för kontrolltypen.');\n  const docId = String(payload?.id || '').trim();\n  if (!docId) throw new Error('ID för kontrolltyp saknas.');\n  try {\n    const ref = doc(db, 'foretag', companyId, 'kontrolltyper', docId);\n    await deleteDoc(ref);\n    return true;\n  } catch (e) {\n    throw new Error(e?.message || 'Kunde inte radera kontrolltyp.');\n  }\n}\n\nexport async function fetchCompanyMallar(companyIdOverride) {\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return [];\n    const snap = await getDocs(collection(db, 'foretag', companyId, 'mallar'));\n    const out = [];\n    snap.forEach(docSnap => {\n      const d = docSnap.data() || {};\n      out.push(Object.assign({}, d, { id: docSnap.id }));\n    });\n    out.sort((a, b) => {\n      const at = String(a && (a.title ?? '')).trim();\n      const bt = String(b && (b.title ?? '')).trim();\n      return at.localeCompare(bt, 'sv');\n    });\n    return out;\n  } catch (e) {\n    return [];\n  }\n}\n\nexport async function createCompanyMall({ title, description, controlType, layout, version }, companyIdOverride) {\n  const companyId = await resolveCompanyId(companyIdOverride, null);\n  if (!companyId) {\n    const err = new Error('no_company');\n    err.code = 'no_company';\n    throw err;\n  }\n  const t = String(title || '').trim();\n  const desc = String(description || '').trim();\n  const ct = String(controlType || '').trim();\n  const layoutData = layout || null;\n  const versionNumber = Number.isFinite(Number(version)) && Number(version) > 0 ? Number(version) : 1;\n  let createdBy = null;\n  try {\n    const u = auth && auth.currentUser ? auth.currentUser : null;\n    if (u) {\n      createdBy = {\n        uid: u.uid || null,\n        email: u.email || null,\n        displayName: u.displayName || null,\n      };\n    }\n  } catch (_e) {\n    createdBy = null;\n  }\n  if (!t) {\n    const err = new Error('invalid-argument');\n    err.code = 'invalid-argument';\n    throw err;\n  }\n\n  const colRef = collection(db, 'foretag', companyId, 'mallar');\n  const payload = {\n    title: t,\n    description: desc,\n    controlType: ct || null,\n    layout: layoutData,\n    createdBy: createdBy || null,\n    hidden: false,\n    version: versionNumber,\n    createdAt: serverTimestamp(),\n  };\n  const docRef = await addDoc(colRef, payload);\n  return docRef.id;\n}\n\n// Uppdatera en företagsmall (merge)\n// Exempel: updateCompanyMall({ id, patch: { hidden: true } })\nexport async function updateCompanyMall({ id, patch }, companyIdOverride) {\n  const companyId = await resolveCompanyId(companyIdOverride, null);\n  if (!companyId) {\n    const err = new Error('no_company');\n    err.code = 'no_company';\n    throw err;\n  }\n  const mallId = String(id || '').trim();\n  if (!mallId) {\n    const err = new Error('invalid-argument');\n    err.code = 'invalid-argument';\n    throw err;\n  }\n\n  const safePatch = patch && typeof patch === 'object' ? { ...patch } : {};\n  safePatch.updatedAt = serverTimestamp();\n\n  const ref = doc(db, 'foretag', companyId, 'mallar', mallId);\n  await updateDoc(ref, safePatch);\n  return true;\n}\n\nexport async function deleteCompanyMall({ id }, companyIdOverride) {\n  const companyId = await resolveCompanyId(companyIdOverride, null);\n  if (!companyId) {\n    const err = new Error('no_company');\n    err.code = 'no_company';\n    throw err;\n  }\n  const mallId = String(id || '').trim();\n  if (!mallId) {\n    const err = new Error('invalid-argument');\n    err.code = 'invalid-argument';\n    throw err;\n  }\n\n  await deleteDoc(doc(db, 'foretag', companyId, 'mallar', mallId));\n  return true;\n}\n\n// Byggdel mall-register per företag\n// Data model: foretag/{companyId}/byggdel_mallar/{mallId} with fields:\n// { huvudgrupp: string, moment: string, name: string, createdAt, updatedAt }\nexport async function fetchByggdelMallar(companyIdOverride) {\n  try {\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) return [];\n    const out = [];\n\n    // Avoid multi-field orderBy here: it can require a composite index.\n    // Fetch all mall docs and sort client-side for predictable UI ordering.\n    const snap = await getDocs(collection(db, 'foretag', companyId, 'byggdel_mallar'));\n    snap.forEach(docSnap => {\n      const d = docSnap.data() || {};\n      out.push(Object.assign({}, d, { id: docSnap.id }));\n    });\n\n    out.sort((a, b) => {\n      const ag = String(a && (a.huvudgrupp ?? '')).trim();\n      const bg = String(b && (b.huvudgrupp ?? '')).trim();\n      if (ag !== bg) return ag.localeCompare(bg, 'sv');\n\n      const am = String(a && (a.moment ?? '')).trim();\n      const bm = String(b && (b.moment ?? '')).trim();\n      if (am !== bm) return am.localeCompare(bm, 'sv');\n\n      const an = String(a && (a.name ?? '')).trim();\n      const bn = String(b && (b.name ?? '')).trim();\n      return an.localeCompare(bn, 'sv');\n    });\n\n    return out;\n  } catch(e) {\n    return [];\n  }\n}\n\nexport async function createByggdelMall({ huvudgrupp, moment, name }, companyIdOverride) {\n  function normalizeMallNameLower(raw) {\n    const s = String(raw || '').trim();\n    if (!s) return '';\n    return s.replace(/\\s+/g, ' ').toLowerCase();\n  }\n\n  function makeMallNameKey(nameLower) {\n    const s = String(nameLower || '').trim();\n    if (!s) return '';\n    // Convert to a stable Firestore doc id\n    // - remove diacritics (åäö -> aao)\n    // - keep [a-z0-9-]\n    let base = s;\n    try {\n      base = base.normalize('NFKD').replace(/[\\u0300-\\u036f]/g, '');\n    } catch(e) {\n      // normalize may not exist in some environments; fall back\n      base = s;\n    }\n    base = base\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-+/, '')\n      .replace(/-+$/, '')\n      .replace(/-+/g, '-');\n    return base || '';\n  }\n\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) {\n      const err = new Error('no_company');\n      err.code = 'no_company';\n      throw err;\n    }\n    const hg = String(huvudgrupp || '').trim();\n    const mm = String(moment || '').trim();\n    const nm = String(name || '').trim();\n    if (!hg || !mm || !nm) {\n      const err = new Error('invalid-argument');\n      err.code = 'invalid-argument';\n      throw err;\n    }\n\n    const nmLower = normalizeMallNameLower(nm);\n    const nameKey = makeMallNameKey(nmLower);\n    if (!nmLower || !nameKey) {\n      const err = new Error('invalid-argument');\n      err.code = 'invalid-argument';\n      throw err;\n    }\n\n    const colRef = collection(db, 'foretag', companyId, 'byggdel_mallar');\n\n    // Uniqueness per company (case-insensitive)\n    // Must also cover older docs that may not have nameLower.\n    const allSnap = await getDocs(colRef);\n    let hasDuplicate = false;\n    allSnap.forEach(docSnap => {\n      const d = docSnap.data() || {};\n      const existingLower = normalizeMallNameLower(d.nameLower || d.name || '');\n      if (existingLower && existingLower === nmLower) hasDuplicate = true;\n    });\n    if (hasDuplicate) {\n      const err = new Error('already-exists');\n      err.code = 'already-exists';\n      throw err;\n    }\n\n    const docRef = doc(db, 'foretag', companyId, 'byggdel_mallar', nameKey);\n    const existingById = await getDoc(docRef);\n    if (existingById.exists()) {\n      const err = new Error('already-exists');\n      err.code = 'already-exists';\n      throw err;\n    }\n\n    const payload = {\n      huvudgrupp: hg,\n      moment: mm,\n      name: nm,\n      nameLower: nmLower,\n      nameKey,\n      points: [],\n      sections: [],\n      createdAt: serverTimestamp(),\n      updatedAt: serverTimestamp(),\n    };\n\n    try {\n      await setDoc(docRef, payload, { merge: false });\n      return docRef.id;\n    } catch(e) {\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      if (permissionDenied) {\n        const err = e || new Error('permission-denied');\n        err.code = err.code || 'permission-denied';\n        err.__permissionDenied = true;\n        throw err;\n      }\n      throw e;\n    }\n  }\n\n  try {\n    return await attemptWrite({ forceTokenRefresh: false });\n  } catch(e) {\n    const isPermissionError = !!(e && (e.__permissionDenied === true || e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n    if (isPermissionError) {\n      try {\n        return await attemptWrite({ forceTokenRefresh: true });\n      } catch(e2) {\n        e = e2 || e;\n      }\n    }\n\n    // Store debug info for troubleshooting (same pattern as other writes)\n    try {\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      let arr = rawArr ? JSON.parse(rawArr) : [];\n      const debug = await getAuthDebugSnapshot();\n      let resolvedCompanyId = null;\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\n      const entry = {\n        fn: 'createByggdelMall',\n        code: e?.code || null,\n        err: (e && e.message) ? e.message : String(e),\n        full: (e && e.stack) ? e.stack : String(e),\n        ts: new Date().toISOString(),\n        resolvedCompanyId,\n        auth: debug,\n      };\n      arr.push(entry);\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n    } catch(e) {}\n\n    throw e;\n  }\n}\n\nexport async function deleteByggdelMall({ mallId }, companyIdOverride) {\n  async function attemptDelete({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) {\n      const err = new Error('no_company');\n      err.code = 'no_company';\n      throw err;\n    }\n\n    const id = String(mallId || '').trim();\n    if (!id) {\n      const err = new Error('invalid-argument');\n      err.code = 'invalid-argument';\n      throw err;\n    }\n\n    await deleteDoc(doc(db, 'foretag', companyId, 'byggdel_mallar', id));\n    return true;\n  }\n\n  try {\n    return await attemptDelete({ forceTokenRefresh: false });\n  } catch(e) {\n    const permissionDenied = !!(e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n    if (permissionDenied) {\n      try {\n        return await attemptDelete({ forceTokenRefresh: true });\n      } catch(e2) {\n        e = e2 || e;\n      }\n    }\n\n    try {\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      let arr = rawArr ? JSON.parse(rawArr) : [];\n      const debug = await getAuthDebugSnapshot();\n      let resolvedCompanyId = null;\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\n      const entry = {\n        fn: 'deleteByggdelMall',\n        code: e?.code || null,\n        err: (e && e.message) ? e.message : String(e),\n        full: (e && e.stack) ? e.stack : String(e),\n        ts: new Date().toISOString(),\n        resolvedCompanyId,\n        auth: debug,\n      };\n      arr.push(entry);\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n    } catch(e) {}\n\n    throw e;\n  }\n}\n\n// Update a Byggdel mall document (merge)\n// Example: updateByggdelMall({ mallId, patch: { points: ['...'] } })\nexport async function updateByggdelMall({ mallId, patch }, companyIdOverride) {\n  async function attemptWrite({ forceTokenRefresh } = { forceTokenRefresh: false }) {\n    if (forceTokenRefresh) {\n      try {\n        if (auth?.currentUser?.getIdToken) await auth.currentUser.getIdToken(true);\n      } catch(e) {}\n    }\n    const companyId = await resolveCompanyId(companyIdOverride, null);\n    if (!companyId) {\n      const err = new Error('no_company');\n      err.code = 'no_company';\n      throw err;\n    }\n    const id = String(mallId || '').trim();\n    if (!id) {\n      const err = new Error('invalid-argument');\n      err.code = 'invalid-argument';\n      throw err;\n    }\n\n    const safePatch = sanitizeForFirestore(patch || {});\n    const ref = doc(db, 'foretag', companyId, 'byggdel_mallar', id);\n    try {\n      await setDoc(ref, Object.assign({}, safePatch || {}, { updatedAt: serverTimestamp() }), { merge: true });\n      return true;\n    } catch(e) {\n      const permissionDenied = (e && (e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n      if (permissionDenied) {\n        const err = e || new Error('permission-denied');\n        err.code = err.code || 'permission-denied';\n        err.__permissionDenied = true;\n        throw err;\n      }\n      throw e;\n    }\n  }\n\n  try {\n    const ok = await attemptWrite({ forceTokenRefresh: false });\n    return ok;\n  } catch(e) {\n    const isPermissionError = !!(e && (e.__permissionDenied === true || e.code === 'permission-denied' || (e.message && e.message.toLowerCase().includes('permission'))));\n    if (isPermissionError) {\n      try {\n        return await attemptWrite({ forceTokenRefresh: true });\n      } catch(e2) {\n        e = e2 || e;\n      }\n    }\n\n    try {\n      const rawArr = await AsyncStorage.getItem('dk_last_fs_errors');\n      let arr = rawArr ? JSON.parse(rawArr) : [];\n      const debug = await getAuthDebugSnapshot();\n      let resolvedCompanyId = null;\n      try { resolvedCompanyId = await resolveCompanyId(companyIdOverride, null); } catch(e) {}\n      const entry = {\n        fn: 'updateByggdelMall',\n        code: e?.code || null,\n        err: (e && e.message) ? e.message : String(e),\n        full: (e && e.stack) ? e.stack : String(e),\n        ts: new Date().toISOString(),\n        mallId: String(mallId || '').trim() || null,\n        resolvedCompanyId,\n        auth: debug,\n      };\n      arr.push(entry);\n      await AsyncStorage.setItem('dk_last_fs_errors', JSON.stringify(arr));\n      await AsyncStorage.setItem('dk_last_fs_error', JSON.stringify(entry));\n    } catch(e) {}\n\n    throw e;\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/formatPersonName.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/haptic-tab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/hello-wave.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/parallax-scroll-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/pdfExport.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'companyName' is assigned a value but never used.","line":103,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"companyName"},"fix":{"range":[4373,4423],"text":""},"desc":"Remove unused variable 'companyName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":192,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":192,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Minimal PDF export scaffold for controls with a shared header\n// Uses \"Mätplats\" terminology per request\n\nexport function buildControlPdfHtml({ control, project, company }) {\n  const title = control?.type || 'Kontroll';\n  const date = control?.date || '';\n  const companyName = company?.name || 'FÖRETAG AB';\n  const companyLogoUrl = company?.logoUrl || '';\n  const companyLogoBase64 = company?.logoBase64 || null;\n\n  // Fält för Fuktmätning\n  const device = control?.device || '';\n  const serial = control?.serial || '';\n  const calibrationDate = control?.calibrationDate || '';\n  const location = control?.location || '';\n  const material = control?.material || '';\n  const method = control?.method || '';\n  const reference = control?.reference || '';\n  const measurements = Array.isArray(control?.measurements) ? control.measurements : [];\n\n  const logoSrcFallback = 'assets/images/foretag_ab.png';\n  const logoImgTag = companyLogoBase64\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:48px; display:block;\"/>`\n    : (companyLogoUrl\n      ? `<img src=\"${companyLogoUrl}\" style=\"height:48px; display:block;\"/>`\n      : `<img src=\"${logoSrcFallback}\" style=\"height:48px; display:block;\"/>`);\n  const headerHtml = `\n    <table style=\"width:100%; border-collapse:collapse;\">\n      <tr>\n        <td style=\"vertical-align:middle; width:40%;\">\n          ${logoImgTag}\n          <div style=\"font-weight:700; color:#263238; margin-top:6px;\">${companyName}</div>\n        </td>\n        <td style=\"text-align:right; vertical-align:middle; width:60%;\">\n          <div style=\"font-size:22px; font-weight:800; color:#263238;\">${title}</div>\n          <div style=\"color:#666; margin-top:4px;\">Datum: ${date}</div>\n          <div style=\"color:#666;\">Projekt: ${project?.id || ''} - ${project?.name || ''}</div>\n        </td>\n      </tr>\n    </table>\n    <div style=\"height:8px\"></div>\n    <div style=\"width:100%; height:2px; background:#000; margin:6px 0 16px 0;\"></div>\n  `;\n\n  const fuktMetaHtml = `\n    <h3 style=\"color:#263238;\">Mätinstrument</h3>\n    <div>Instrument: ${escapeHtml(device)} | Serienummer: ${escapeHtml(serial)} | Kalibrering: ${escapeHtml(calibrationDate)}</div>\n    <h3 style=\"color:#263238; margin-top:12px;\">Mätplats</h3>\n    <div>Plats/rum: ${escapeHtml(location)} | Material: ${escapeHtml(material)}</div>\n    <div>Metod: ${escapeHtml(method)} | Referens: ${escapeHtml(reference)}</div>\n  `;\n\n  const rows = measurements.map((m, i) => `\n    <tr>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${i + 1}</td>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.position || '')}</td>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.depth || '')}</td>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.temp || '')}</td>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.value || '')} ${escapeHtml(m.unit || '')}</td>\n      <td style=\"padding:6px; border:1px solid #E3E6E8;\">${escapeHtml(m.note || '')}</td>\n    </tr>\n  `).join('');\n\n  const tableHtml = `\n    <h3 style=\"color:#263238; margin-top:16px;\">Mätpunkter</h3>\n    <table style=\"width:100%; border-collapse:collapse; font-size:12px;\">\n      <thead>\n        <tr style=\"background:#F7FAFC;\">\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">#</th>\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Position</th>\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Djup (mm)</th>\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Temp (°C)</th>\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Värde</th>\n          <th style=\"padding:6px; border:1px solid #E3E6E8;\">Anteckning</th>\n        </tr>\n      </thead>\n      <tbody>${rows}</tbody>\n    </table>\n  `;\n\n  return `\n    <html>\n      <head>\n        <meta charset=\"utf-8\" />\n        <style>\n          body { font-family: Arial, sans-serif; color:#222; }\n          h3 { margin: 8px 0; }\n        </style>\n      </head>\n      <body>\n        ${headerHtml}\n        ${fuktMetaHtml}\n        ${tableHtml}\n      </body>\n    </html>\n  `;\n}\n\n// Build HTML for Mottagningskontroll (report-style layout matching mock)\nexport function buildMottagningsPdfHtml({ control, project, company }) {\n  const title = 'Mottagningskontroll';\n  const date = control?.date || control?.savedAt || '';\n  const companyName = company?.name || 'FÖRETAG AB';\n  const companyLogoUrl = company?.logoUrl || '';\n  const companyLogoBase64 = company?.logoBase64 || null;\n\n  const projectLine = `${project?.id ? project.id + ' - ' : ''}${project?.name || ''}`;\n  const participants = Array.isArray(control?.localParticipants) ? control.localParticipants : (Array.isArray(control?.participants) ? control.participants : []);\n  const weather = control?.selectedWeather || control?.weather || '';\n  const materialDesc = control?.materialDesc || control?.material || '';\n  const photos = Array.isArray(control?.mottagningsPhotos) ? control.mottagningsPhotos : (Array.isArray(control?.photos) ? control.photos : []);\n  const signatures = Array.isArray(control?.mottagningsSignatures) ? control.mottagningsSignatures : [];\n  const checklist = Array.isArray(control?.checklist) ? control.checklist : (Array.isArray(control?.points) ? control.points : []);\n\n  // Logo selection: prefer provided base64, then URL/path, then bundled asset\n  const logoSrcFallback = 'assets/images/foretag_ab.png';\n  const logoImgTagHeader = companyLogoBase64\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:48px; display:block;\"/>`\n    : (companyLogoUrl ? `<img src=\"${companyLogoUrl}\" style=\"height:48px; display:block;\"/>` : `<img src=\"${logoSrcFallback}\" style=\"height:48px; display:block;\"/>`);\n  const logoImgTagSmall = companyLogoBase64\n    ? `<img src=\"data:image/png;base64,${companyLogoBase64}\" style=\"height:24px; display:block;\"/>`\n    : (companyLogoUrl ? `<img src=\"${companyLogoUrl}\" style=\"height:24px; display:block;\"/>` : `<img src=\"${logoSrcFallback}\" style=\"height:24px; display:block;\"/>`);\n\n  const headerHtml = `\n    <div style=\"width:100%;\">\n      <!-- Top: company logo -->\n      <div style=\"display:flex; align-items:center; justify-content:flex-start;\">\n        <div style=\"width:160px;\">${logoImgTagHeader}</div>\n      </div>\n\n      <!-- Horizontal marking under logo (thin black line) -->\n      <div style=\"height:8px\"></div>\n      <div style=\"width:100%; height:2px; background:#000; margin:6px 0 10px 0;\"></div>\n\n      <!-- Title with vector icon below marking -->\n      <div style=\"display:flex; align-items:center; gap:12px; margin-top:8px;\">\n        <div style=\"width:44px; height:44px; border-radius:8px; background:transparent; display:flex; align-items:center; justify-content:center;\">\n          <svg width=\"26\" height=\"26\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n            <rect x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"4\" fill=\"none\" stroke=\"#7B1FA2\" stroke-width=\"2\"/>\n            <path d=\"M7 12l3 3 7-7\" fill=\"none\" stroke=\"#7B1FA2\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n          </svg>\n        </div>\n        <div style=\"font-size:28px; font-weight:800; color:#222;\">${title}</div>\n      </div>\n    </div>\n  `;\n\n    const metaHtml = `\n      <div style=\"background:#f1f1f1; border-radius:8px; padding:12px; margin-top:8px; border:1px solid #e6e6e6;\">\n        <div style=\"font-weight:800; padding:6px 8px; background:rgba(0,0,0,0.03); border-radius:6px;\">PROJEKT ${escapeHtml(projectLine)}</div>\n        <table style=\"width:100%; margin-top:10px; border-collapse:collapse;\">\n          <tr>\n            <td style=\"vertical-align:top; padding:8px; width:160px; font-weight:700; color:#333;\">Datum för kontroll:</td>\n            <td style=\"padding:8px; color:#333;\">${escapeHtml(date || '')}</td>\n          </tr>\n          <tr>\n            <td style=\"vertical-align:top; padding:8px; font-weight:700; color:#333;\">Deltagare:</td>\n            <td style=\"padding:8px; color:#333;\">${participants.length ? participants.map(p => `<div style=\"margin-bottom:6px; display:flex; align-items:center; gap:8px;\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z\" fill=\"#666\"/></svg><span>${escapeHtml(typeof p === 'string' ? p : (p.name || p.company || ''))}</span></div>`).join('') : '<i>Inga deltagare</i>'}</td>\n          </tr>\n          <tr>\n            <td style=\"vertical-align:top; padding:8px; font-weight:700; color:#333;\">Väder:</td>\n            <td style=\"padding:8px; color:#333;\">${escapeHtml(weather || '—')}</td>\n          </tr>\n        </table>\n      </div>\n    `;\n\n  // Summary of deviations (prominent box) — helpful to quickly see issues\n  let deviationSummaryHtml = '';\n  try {\n    let totalDeviations = 0;\n    const sectionSummaries = [];\n    if (Array.isArray(checklist) && checklist.length > 0) {\n      checklist.forEach((section) => {\n        const statuses = Array.isArray(section.statuses) ? section.statuses : [];\n        const count = statuses.filter(s => String(s || '').toLowerCase() === 'avvikelse').length;\n        if (count > 0) {\n          totalDeviations += count;\n          const label = section.label || section.title || '';\n          sectionSummaries.push(`<div style=\"margin-bottom:6px;\"><strong>${escapeHtml(label || 'Sektion')}</strong>: ${count} avvikelse${count>1 ? 'r' : ''}</div>`);\n        }\n      });\n    }\n    if (totalDeviations > 0) {\n      deviationSummaryHtml = `\n        <div style=\"margin-top:12px; padding:12px; border-radius:8px; border:2px solid #FFD600; background:#FFF8E1;\">\n          <div style=\"font-weight:800; color:#B85C00; font-size:16px; margin-bottom:8px;\">Sammanställning — Avvikelser: ${totalDeviations}</div>\n          <div style=\"font-size:13px; color:#333;\">${sectionSummaries.join('')}</div>\n        </div>\n      `;\n    }\n  } catch(e) {\n    deviationSummaryHtml = '';\n  }\n\n  // Checklist rendering (modern cards)\n  let checklistHtml = '';\n  if (Array.isArray(checklist) && checklist.length > 0) {\n    checklistHtml = checklist.map(section => {\n      const secLabel = escapeHtml(section.label || section.title || '');\n      const items = Array.isArray(section.points || section.items) ? (section.points || section.items) : [];\n      const statuses = Array.isArray(section.statuses) ? section.statuses : [];\n      const list = items.map((it, idx) => {\n          const status = statuses && statuses[idx] ? String(statuses[idx]).toLowerCase() : '';\n          let checkSvg = `<div style=\"width:20px; height:20px; border:1px solid #ccc; border-radius:4px;\"></div>`;\n          if (status === 'ok' || status === 'true') {\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#2e7d32\"/><path d=\"M7 12l3 3 7-7\" fill=\"none\" stroke=\"#fff\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;\n          } else if (status === 'avvikelse' || status === 'avvikelse' ) {\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><polygon points=\"12,2 22,20 2,20\" fill=\"#FFD600\" stroke=\"#111\" stroke-width=\"1\"/><text x=\"12\" y=\"15\" font-size=\"12\" font-weight=\"700\" fill=\"#111\" text-anchor=\"middle\">!</text></svg>`;\n          } else if (status === 'ejaktuell' || status === 'ej aktuell' || status === 'notapplicable' || status === 'na') {\n            checkSvg = `<svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ffffff\" stroke=\"#bbb\" stroke-width=\"1\"/><path d=\"M8 8 L16 16 M16 8 L8 16\" stroke=\"#444\" stroke-width=\"1.8\" stroke-linecap=\"round\"/></svg>`;\n          }\n          return `<div style=\"display:flex; align-items:center; gap:12px; margin-bottom:8px;\"><div style=\"width:28px; text-align:center;\">${checkSvg}</div><div style=\"flex:1; font-size:14px;\">${escapeHtml(it)}</div></div>`;\n        }).join('');\n      return `<div style=\"border:1px solid #e6e9eb; border-radius:8px; padding:12px; margin-bottom:12px; background:#fff\">` + (secLabel ? `<div style=\"font-weight:700; margin-bottom:8px;\">${secLabel}</div>` : '') + list + `</div>`;\n    }).join('');\n  } else {\n    checklistHtml = '<div>Inga kontrollpunkter sparade.</div>';\n  }\n\n  // Photos grid + caption\n  let photosHtml = '';\n  const photoCaption = escapeHtml(control?.photoCaption || control?.photoNote || materialDesc || 'Material leverans inspekterad och dokumenterad');\n  if (Array.isArray(photos) && photos.length > 0) {\n    const cells = photos.map(ph => {\n      const src = ph && ph.uri ? ph.uri : ph || '';\n      return `<div style=\"width:33%; padding:8px; box-sizing:border-box;\">\n                <div style=\"width:100%; height:120px; border-radius:6px; border:1px solid #eee; background:#fafafa; display:flex; align-items:center; justify-content:center; overflow:hidden;\">\n                  ${src ? `<img src=\"${src}\" style=\"width:100%; height:100%; object-fit:cover; display:block;\"/>` : `<div style=\"color:#bbb; font-size:12px;\">Ingen bild</div>`}\n                </div>\n              </div>`;\n    }).join('');\n    photosHtml = `<div style=\"display:flex; flex-wrap:wrap; margin-top:8px;\">${cells}</div>`;\n    photosHtml += `<div style=\"text-align:center; color:#555; font-size:12px; margin-top:8px; font-style:italic;\">${photoCaption}</div>`;\n  } else photosHtml = '<div>Inga bifogade bilder.</div>';\n\n  // Signatures\n  const signaturesHtml = (Array.isArray(signatures) && signatures.length > 0) ? signatures.map(s => `\n    <div style=\"display:inline-block; width:33%; vertical-align:top; text-align:center; padding:8px;\">\n      <div style=\"height:64px; display:flex; align-items:center; justify-content:center;\">\n        ${s.uri ? `<img src=\"${s.uri}\" style=\"max-height:64px; display:block; margin:0 auto;\"/>` : (s.strokes ? '<div style=\"height:64px;\"></div>' : '')}\n      </div>\n      <div style=\"height:1px; border-bottom:1px dashed #ddd; margin:10px 20px 6px 20px;\"></div>\n      <div style=\"margin-top:6px; font-weight:700; color:#333; font-size:13px;\">${escapeHtml(s.name || '')}</div>\n    </div>\n  `).join('') : '<div>Inga signaturer</div>';\n\n  const footerHtml = `\n    <div style=\"width:100%; margin-top:28px; padding-top:12px; border-top:1px solid #eee; display:flex; align-items:center; justify-content:space-between;\">\n      <div style=\"color:#444; font-size:13px;\">Kontrollen är utförd med <strong>DigitalKontroll</strong></div>\n      <div style=\"display:flex; align-items:center; gap:12px;\">\n        <div style=\"height:28px;\">${logoImgTagSmall}</div>\n        <div style=\"color:#777; font-size:12px;\">www.digitalkontroll.se | info@digitalkontroll.se | 08-123 456 78</div>\n      </div>\n    </div>\n  `;\n\n  return `\n    <html>\n      <head>\n        <meta charset=\"utf-8\" />\n        <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" />\n        <style>\n          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:16px; }\n          h2 { margin:10px 0; color:#263238; }\n          .card { background:#fff; border:1px solid #eef2f4; border-radius:10px; padding:12px; }\n        </style>\n      </head>\n      <body>\n        ${headerHtml}\n        ${metaHtml}\n        ${deviationSummaryHtml}\n\n        <h2>Kontrollpunkter</h2>\n        ${checklistHtml}\n\n        <h2>Bifogade bilder</h2>\n        ${photosHtml}\n\n        <h2>Signaturer</h2>\n        <div style=\"display:flex; gap:8px; margin-top:8px;\">${signaturesHtml}</div>\n\n        ${footerHtml}\n      </body>\n    </html>\n  `;\n}\n\n// Dispatcher: choose builder based on control type\nexport function buildPdfHtmlForControl({ control, project, company }) {\n  if (!control || !control.type) return buildControlPdfHtml({ control, project, company });\n  switch ((control.type || '').toString()) {\n    case 'Mottagningskontroll':\n      return buildMottagningsPdfHtml({ control, project, company });\n    default:\n      return buildControlPdfHtml({ control, project, company });\n  }\n}\n\nfunction escapeHtml(s) {\n  return String(s || '')\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/projectBus.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":18,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Simple in-memory event bus for cross-screen project updates.\n// Avoids passing non-serializable callbacks through React Navigation params.\n\nconst projectUpdatedListeners = new Set();\n\nexport function onProjectUpdated(listener) {\n  if (typeof listener !== 'function') return () => {};\n  projectUpdatedListeners.add(listener);\n  return () => {\n    projectUpdatedListeners.delete(listener);\n  };\n}\n\nexport function emitProjectUpdated(updatedProject) {\n  for (const listener of projectUpdatedListeners) {\n    try {\n      listener(updatedProject);\n    } catch(e) {\n      // ignore\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/themed-text.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/themed-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ui/collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ui/icon-symbol.ios.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/components/ui/icon-symbol.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/hooks/use-color-scheme.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/hooks/use-color-scheme.web.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/hooks/use-theme-color.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/hooks/useBackgroundSync.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":49,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":20},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":57,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":76},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":76,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":81,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":85},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":83,"column":108,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":109},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":87,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":99,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":26},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":104,"column":80,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":81},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":106,"column":110,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":111},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":110,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":111,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":16}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'onStatus'. Either include it or remove the dependency array.","line":123,"column":6,"nodeType":"ArrayExpression","endLine":123,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [companyId, onStatus]","fix":{"range":[4689,4700],"text":"[companyId, onStatus]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import AsyncStorage from '@react-native-async-storage/async-storage';\nimport NetInfo from '@react-native-community/netinfo';\nimport { useEffect, useRef, useState } from 'react';\nimport { saveControlToFirestore, saveDraftToFirestore, saveHierarchy } from '../components/firebase';\n\nexport default function useBackgroundSync(companyId, opts = {}) {\n  const { onStatus } = opts;\n  const [status, setStatus] = useState('idle'); // idle | pending | syncing | synced | error | offline\n  const attemptsRef = useRef(0);\n  const backoffTimer = useRef(null);\n\n  useEffect(() => {\n    let mounted = true;\n    const unsubscribe = NetInfo.addEventListener(async (state) => {\n      const online = !!(state.isConnected && (state.isInternetReachable ?? true));\n      if (!mounted) return;\n      if (!online) {\n        setStatus('offline');\n        if (onStatus) onStatus('offline');\n        return;\n      }\n      // online -> try to sync\n      try {\n        const raw = await AsyncStorage.getItem('hierarchy_local');\n        if (!raw) {\n          setStatus('synced');\n          if (onStatus) onStatus('synced');\n          return;\n        }\n        const parsed = JSON.parse(raw);\n        if (!parsed || !Array.isArray(parsed) || parsed.length === 0) {\n          // nothing to sync\n          await AsyncStorage.removeItem('hierarchy_local');\n          setStatus('synced');\n          if (onStatus) onStatus('synced');\n          return;\n        }\n        // attempt sync with retries/backoff\n        setStatus('syncing');\n        if (onStatus) onStatus('syncing');\n        let ok = false;\n        attemptsRef.current = 0;\n        while (attemptsRef.current < 5 && !ok) {\n          attemptsRef.current += 1;\n          try {\n            const res = await saveHierarchy(companyId, parsed);\n            ok = res === true || (res && res.ok === true);\n            if (ok) break;\n          } catch(e) {\n            // ignore, will backoff\n          }\n          // exponential backoff\n          const waitMs = Math.min(30000, 500 * Math.pow(2, attemptsRef.current));\n          await new Promise(r => backoffTimer.current = setTimeout(r, waitMs));\n        }\n        if (ok) {\n          try { await AsyncStorage.removeItem('hierarchy_local'); } catch(e) {}\n          setStatus('synced');\n          if (onStatus) onStatus('synced');\n        } else {\n          setStatus('error');\n          if (onStatus) onStatus('error');\n        }\n        // Additionally attempt to sync any locally stored controls (completed and drafts)\n        try {\n          // Sync completed controls\n          const rawCompleted = await AsyncStorage.getItem('completed_controls');\n          if (rawCompleted) {\n            let completedArr = JSON.parse(rawCompleted) || [];\n            if (Array.isArray(completedArr) && completedArr.length > 0) {\n              const remaining = [];\n              for (const ctl of completedArr) {\n                try {\n                  const res = await saveControlToFirestore(ctl);\n                  if (!res) remaining.push(ctl);\n                } catch(e) {\n                  remaining.push(ctl);\n                }\n              }\n              if (remaining.length === 0) {\n                try { await AsyncStorage.removeItem('completed_controls'); } catch(e) {}\n              } else {\n                try { await AsyncStorage.setItem('completed_controls', JSON.stringify(remaining)); } catch(e) {}\n              }\n            }\n          }\n        } catch(e) {}\n        try {\n          // Sync draft controls\n          const rawDrafts = await AsyncStorage.getItem('draft_controls');\n          if (rawDrafts) {\n            let draftArr = JSON.parse(rawDrafts) || [];\n            if (Array.isArray(draftArr) && draftArr.length > 0) {\n              const remainingDrafts = [];\n              for (const d of draftArr) {\n                try {\n                  const res = await saveDraftToFirestore(d);\n                  if (!res) remainingDrafts.push(d);\n                } catch(e) {\n                  remainingDrafts.push(d);\n                }\n              }\n              if (remainingDrafts.length === 0) {\n                try { await AsyncStorage.removeItem('draft_controls'); } catch(e) {}\n              } else {\n                try { await AsyncStorage.setItem('draft_controls', JSON.stringify(remainingDrafts)); } catch(e) {}\n              }\n            }\n          }\n        } catch(e) {}\n      } catch(e) {\n        setStatus('error');\n        if (onStatus) onStatus('error');\n      }\n    });\n\n    return () => {\n      mounted = false;\n      unsubscribe();\n      if (backoffTimer.current) clearTimeout(backoffTimer.current);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [companyId]);\n\n  return { status };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/add-user.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":85,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":139,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":139,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'_err' is not defined.","line":140,"column":31,"nodeType":"Identifier","messageId":"undef","endLine":140,"endColumn":35}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/*\n  scripts/add-user.js\n\n  Skapar eller hämtar en Firebase Auth-användare, sätter custom claims och skriver users/{uid}.\n\n  Usage:\n    node scripts/add-user.js --serviceAccount=./konton/demo-service.json --email=user@company.com --company=my-company --role=user --admin=false --password=Secret123!\n\n  Notes:\n    - Om --password utelämnas skapas ett slumpat lösenord och skrivs ut.\n    - Sätter claims: { companyId, admin }\n*/\n\nconst fs = require('fs');\nconst path = require('path');\nconst admin = require('firebase-admin');\nconst formatPersonName = require('./lib/formatPersonName');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nfunction toBool(value, fallback) {\n  if (value === undefined || value === null || value === '') return fallback;\n  const v = String(value).trim().toLowerCase();\n  if (['true', '1', 'yes', 'y'].includes(v)) return true;\n  if (['false', '0', 'no', 'n'].includes(v)) return false;\n  return fallback;\n}\n\nfunction randomPassword() {\n  // enkel, men tillräcklig för onboarding (kan bytas av användaren)\n  const base = Math.random().toString(36).slice(-10);\n  return `${base}A!`;\n}\n\nasync function main() {\n  const args = parseArgs();\n\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n  if (!serviceAccount) {\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\n    process.exit(1);\n  }\n\n  const email = args.email;\n  const company = args.company;\n  if (!email || !company) {\n    console.error('Usage: node scripts/add-user.js --serviceAccount=./konton/XXX.json --email=user@company.com --company=my-company --role=user --admin=false [--password=Secret123!]');\n    process.exit(1);\n  }\n\n  const role = (args.role || 'user').trim();\n  const isAdmin = toBool(args.admin, role === 'admin');\n  const password = (args.password && String(args.password).trim()) || randomPassword();\n  const firstName = (args.firstName || args.firstname || '').trim();\n  const lastName = (args.lastName || args.lastname || '').trim();\n  const displayNameArg = (args.displayName || args.displayname || '').trim();\n  const desiredDisplayName = formatPersonName(displayNameArg || [firstName, lastName].filter(Boolean).join(' ').trim());\n\n  const saPath = path.resolve(serviceAccount);\n  if (!fs.existsSync(saPath)) {\n    console.error('Service account file not found:', saPath);\n    process.exit(1);\n  }\n\n  const sa = require(saPath);\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\n\n  const auth = admin.auth();\n  const db = admin.firestore();\n\n  try {\n    // Create or get user\n    let userRecord;\n    try {\n      userRecord = await auth.getUserByEmail(email);\n      console.log('User already exists:', userRecord.uid);\n    } catch(e) {\n      userRecord = await auth.createUser({\n        email,\n        password,\n        emailVerified: true,\n        displayName: desiredDisplayName || formatPersonName(email.split('@')[0])\n      });\n      console.log('Created user:', userRecord.uid);\n      console.log('Password (new user):', password);\n    }\n\n    // Best-effort: update displayName if we have a better one\n    if (desiredDisplayName && desiredDisplayName !== userRecord.displayName) {\n      try {\n        await auth.updateUser(userRecord.uid, { displayName: desiredDisplayName });\n        userRecord = await auth.getUser(userRecord.uid);\n        console.log('Updated displayName:', userRecord.displayName);\n      } catch(e) {\n        console.warn('Could not update displayName:', e?.message || e);\n      }\n    }\n\n    const effectiveRole = isAdmin ? 'admin' : role;\n    const claims = { companyId: company, admin: isAdmin, role: effectiveRole };\n    await auth.setCustomUserClaims(userRecord.uid, claims);\n    console.log('Set custom claims:', claims);\n\n    await db.collection('users').doc(userRecord.uid).set({\n      companyId: company,\n      role: effectiveRole,\n      email,\n      displayName: userRecord.displayName || formatPersonName(email.split('@')[0]),\n      firstName: firstName || null,\n      lastName: lastName || null,\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n      createdAt: admin.firestore.FieldValue.serverTimestamp()\n    }, { merge: true });\n\n    // Also write to company-scoped members directory for in-app dropdowns (ansvarig)\n    await db.collection('foretag').doc(company).collection('members').doc(userRecord.uid).set({\n      uid: userRecord.uid,\n      companyId: company,\n      role: effectiveRole,\n      email,\n      displayName: userRecord.displayName || formatPersonName(email.split('@')[0]),\n      firstName: firstName || null,\n      lastName: lastName || null,\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\n    }, { merge: true });\n\n    console.log('Wrote users/{uid} document');\n    console.log('Done.');\n    process.exit(0);\n  } catch(e) {\n      console.error('Error:', _err);\n    process.exit(1);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/create-demo-user.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":54,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/*\n  scripts/create-demo-user.js\n  Usage:\n    node scripts/create-demo-user.js --serviceAccount=./konton/demo-service.json --email=demo@demo.local --password=Demo12345! --company=demo-company\n  Or set GOOGLE_APPLICATION_CREDENTIALS env var and omit --serviceAccount\n*/\nconst fs = require('fs');\nconst path = require('path');\nconst admin = require('firebase-admin');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nasync function main() {\n  const args = parseArgs();\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n  if (!serviceAccount) {\n    console.error('Service account JSON path required via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\n    process.exit(1);\n  }\n\n  const saPath = path.resolve(serviceAccount);\n  if (!fs.existsSync(saPath)) {\n    console.error('Service account file not found:', saPath);\n    process.exit(1);\n  }\n\n  const sa = require(saPath);\n\n  admin.initializeApp({\n    credential: admin.credential.cert(sa)\n  });\n\n  const email = args.email || 'demo@demo.local';\n  const password = args.password || 'Demo12345!';\n  const company = args.company || 'demo-company';\n\n  const auth = admin.auth();\n  const db = admin.firestore();\n\n  // Create or get user\n  let userRecord;\n  try {\n    try {\n      userRecord = await auth.getUserByEmail(email);\n      console.log('User already exists:', userRecord.uid);\n    } catch(e) {\n      userRecord = await auth.createUser({ email, password, emailVerified: true, displayName: 'Demo Admin' });\n      console.log('Created user:', userRecord.uid);\n    }\n\n    // Set custom claims\n    const claims = { admin: true, role: 'admin', companyId: company };\n    await auth.setCustomUserClaims(userRecord.uid, claims);\n    console.log('Set custom claims:', claims);\n\n    // Create users/{uid} doc\n    const userDocRef = db.collection('users').doc(userRecord.uid);\n    await userDocRef.set({\n      companyId: company,\n      role: 'admin',\n      displayName: userRecord.displayName || 'Demo Admin',\n      email: userRecord.email,\n      createdAt: admin.firestore.FieldValue.serverTimestamp()\n    }, { merge: true });\n    console.log('Wrote users/{uid} document');\n\n    // Seed basic company structure and a template (if not exists)\n    const companyRef = db.collection('foretag').doc(company);\n    const companySnap = await companyRef.get();\n    if (!companySnap.exists) {\n      await companyRef.set({ name: 'Demo Company', createdAt: admin.firestore.FieldValue.serverTimestamp() });\n      console.log('Created foretag/{company}');\n    }\n\n    // Seed company members directory\n    await companyRef.collection('members').doc(userRecord.uid).set({\n      uid: userRecord.uid,\n      companyId: company,\n      role: 'admin',\n      displayName: userRecord.displayName || 'Demo Admin',\n      email: userRecord.email,\n      createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n    }, { merge: true });\n\n    // Seed a simple mall-template collection\n    const templatesRef = companyRef.collection('mallar');\n    const templatesSnap = await templatesRef.limit(1).get();\n    if (templatesSnap.empty) {\n      await templatesRef.add({ title: 'Tom mall', description: 'Bas-mall att kopiera vid onboarding', createdAt: admin.firestore.FieldValue.serverTimestamp(), items: [] });\n      console.log('Added a mall-template');\n    }\n\n    // Seed demo hierarchy\n    const hierRef = companyRef.collection('hierarki').doc('state');\n    const hierSnap = await hierRef.get();\n    if (!hierSnap.exists) {\n      const demoHierarchy = [\n        { id: 'main1', name: 'Demo Projekt', expanded: false, children: [ { id: 'P-0001', name: 'Demo Projekt 1', type: 'project', status: 'ongoing', createdAt: new Date().toISOString() } ] }\n      ];\n      await hierRef.set({ items: demoHierarchy, createdAt: admin.firestore.FieldValue.serverTimestamp() });\n      console.log('Seeded demo hierarchy for company');\n    }\n\n    console.log('Done. Demo user ready.');\n    process.exit(0);\n  } catch (err) {\n    console.error('Error:', err);\n    process.exit(1);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/eslint_fix_unused_e.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/fix_underscore_catch_tracked.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/import-companies-users.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":205,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":205,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":220,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":220,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/*\n  scripts/import-companies-users.js\n\n  Importerar flera företag + användare (admin/user) från en CSV (export från Excel).\n\n  Varför:\n    - Återanvändbar onboarding utan att klicka i Firestore manuellt\n    - Sätter Auth claims + skriver users/{uid} + foretag/{companyId}/members/{uid}\n    - Skapar grundstruktur för företaget (foretag-doc + minst en mall) om den saknas\n\n  Usage:\n    node scripts/import-companies-users.js --serviceAccount=./konton/demo-service.json --file=./data/import.csv\n\n  Valfritt:\n    --delimiter=;           (Excel i Sverige använder ofta semikolon)\n    --dryRun=true           (skriver inget, loggar bara)\n\n  CSV format (rekommenderat med header):\n    companyId;companyName;email;firstName;lastName;role;admin;password;logoUrl;enabledControlTypes\n\n  Exempelrad:\n    ms-bygg;MS Byggsystem;anna@msbygg.se;Anna;Andersson;admin;true;BytMig123!;https://...;Arbetsberedning,Egenkontroll\n\n  Notes:\n    - logoUrl är valfritt; bäst är att du själv lägger in den vid behov.\n    - enabledControlTypes skrivs till foretag/{companyId}/profil/public.enabledControlTypes (valfritt)\n*/\n\nconst fs = require('fs');\nconst path = require('path');\nconst admin = require('firebase-admin');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nfunction toBool(value, fallback) {\n  if (value === undefined || value === null || value === '') return fallback;\n  const v = String(value).trim().toLowerCase();\n  if (['true', '1', 'yes', 'y', 'ja'].includes(v)) return true;\n  if (['false', '0', 'no', 'n', 'nej'].includes(v)) return false;\n  return fallback;\n}\n\nfunction randomPassword() {\n  const base = Math.random().toString(36).slice(-10);\n  return `${base}A!`;\n}\n\nfunction splitEnabledTypes(raw) {\n  const s = (raw ?? '').trim();\n  if (!s) return null;\n  return s.split(',').map(x => x.trim()).filter(Boolean);\n}\n\nfunction guessDelimiter(firstLine) {\n  const semi = (firstLine.match(/;/g) || []).length;\n  const comma = (firstLine.match(/,/g) || []).length;\n  return semi > comma ? ';' : ',';\n}\n\nfunction parseCsv(text, delimiter) {\n  // Minimal CSV parser (supports quotes)\n  const rows = [];\n  let row = [];\n  let cur = '';\n  let inQuotes = false;\n\n  for (let i = 0; i < text.length; i++) {\n    const ch = text[i];\n\n    if (inQuotes) {\n      if (ch === '\"') {\n        const next = text[i + 1];\n        if (next === '\"') {\n          cur += '\"';\n          i++;\n        } else {\n          inQuotes = false;\n        }\n      } else {\n        cur += ch;\n      }\n      continue;\n    }\n\n    if (ch === '\"') {\n      inQuotes = true;\n      continue;\n    }\n\n    if (ch === delimiter) {\n      row.push(cur);\n      cur = '';\n      continue;\n    }\n\n    if (ch === '\\n') {\n      row.push(cur);\n      cur = '';\n      // skip empty/comment-only lines\n      const joined = row.join('').trim();\n      if (joined && !joined.startsWith('#')) rows.push(row);\n      row = [];\n      continue;\n    }\n\n    if (ch === '\\r') continue;\n\n    cur += ch;\n  }\n\n  if (cur.length || row.length) {\n    row.push(cur);\n    const joined = row.join('').trim();\n    if (joined && !joined.startsWith('#')) rows.push(row);\n  }\n\n  return rows;\n}\n\nfunction normalizeHeaderKey(k) {\n  return String(k || '')\n    .trim()\n    .toLowerCase()\n    .replace(/\\s+/g, '')\n    .replace(/[_-]/g, '');\n}\n\nfunction getCell(row, idx) {\n  const v = row[idx];\n  return v === undefined || v === null ? '' : String(v).trim();\n}\n\nasync function ensureCompanyBase(db, companyId, companyName, dryRun) {\n  const companyRef = db.collection('foretag').doc(companyId);\n  if (!dryRun) {\n    await companyRef.set(\n      {\n        name: companyName || companyId,\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      },\n      { merge: true }\n    );\n  }\n\n  // Ensure at least one template exists\n  const templatesRef = companyRef.collection('mallar');\n  if (!dryRun) {\n    const snap = await templatesRef.limit(1).get();\n    if (snap.empty) {\n      await templatesRef.add({\n        title: 'Tom mall',\n        description: 'Bas-mall att kopiera vid onboarding',\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\n        items: [],\n      });\n    }\n  }\n\n  return companyRef;\n}\n\nasync function upsertCompanyProfile(db, companyId, patch, dryRun) {\n  if (!patch || Object.keys(patch).length === 0) return;\n  const ref = db.doc(`foretag/${companyId}/profil/public`);\n  if (dryRun) return;\n  await ref.set(\n    {\n      ...patch,\n      updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n    },\n    { merge: true }\n  );\n}\n\nasync function upsertUserAndMembership({ auth, db, companyId, companyName, rowData, dryRun, createdPasswords }) {\n  const email = (rowData.email || '').trim();\n  if (!email) return;\n\n  const firstName = (rowData.firstName || '').trim();\n  const lastName = (rowData.lastName || '').trim();\n  const formatPersonName = require('./lib/formatPersonName');\n  const displayName = formatPersonName((rowData.displayName || '').trim() || [firstName, lastName].filter(Boolean).join(' ').trim());\n\n  const roleRaw = (rowData.role || 'user').trim().toLowerCase();\n  const isAdmin = toBool(rowData.admin, roleRaw === 'admin');\n  const effectiveRole = isAdmin ? 'admin' : (roleRaw || 'user');\n\n  const password = (rowData.password || '').trim() || randomPassword();\n\n  let userRecord;\n  let created = false;\n\n  if (!dryRun) {\n    try {\n      userRecord = await auth.getUserByEmail(email);\n    } catch(e) {\n      userRecord = await auth.createUser({\n        email,\n        password,\n        emailVerified: true,\n        displayName: displayName || formatPersonName(email.split('@')[0]),\n      });\n      created = true;\n      createdPasswords.push({ email, password, companyId });\n    }\n\n    if (displayName && displayName !== userRecord.displayName) {\n      try {\n        await auth.updateUser(userRecord.uid, { displayName });\n        userRecord = await auth.getUser(userRecord.uid);\n      } catch(e) {\n        // ignore\n      }\n    }\n\n    const claims = { companyId, admin: isAdmin, role: effectiveRole };\n    await auth.setCustomUserClaims(userRecord.uid, claims);\n\n    await db.collection('users').doc(userRecord.uid).set(\n      {\n        companyId,\n        role: effectiveRole,\n        email,\n        displayName: userRecord.displayName || displayName || formatPersonName(email.split('@')[0]),\n        firstName: firstName || null,\n        lastName: lastName || null,\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      },\n      { merge: true }\n    );\n\n    await db.collection('foretag').doc(companyId).collection('members').doc(userRecord.uid).set(\n      {\n        uid: userRecord.uid,\n        companyId,\n        role: effectiveRole,\n        email,\n        displayName: userRecord.displayName || displayName || formatPersonName(email.split('@')[0]),\n        firstName: firstName || null,\n        lastName: lastName || null,\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\n      },\n      { merge: true }\n    );\n  }\n\n  const action = dryRun ? '[dryRun]' : created ? '[created]' : '[updated]';\n  console.log(\n    '%s user=%s role=%s company=%s (%s)',\n    action,\n    email,\n    effectiveRole,\n    companyId,\n    companyName || companyId\n  );\n}\n\nasync function main() {\n  const args = parseArgs();\n\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n  if (!serviceAccount) {\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\n    process.exit(1);\n  }\n\n  const file = args.file || args.path;\n  if (!file) {\n    console.error('Usage: node scripts/import-companies-users.js --serviceAccount=./konton/XXX.json --file=./data/import.csv [--delimiter=;] [--dryRun=true]');\n    process.exit(1);\n  }\n\n  const dryRun = toBool(args.dryRun, false);\n\n  const saPath = path.resolve(serviceAccount);\n  if (!fs.existsSync(saPath)) {\n    console.error('Service account file not found:', saPath);\n    process.exit(1);\n  }\n\n  const filePath = path.resolve(file);\n  if (!fs.existsSync(filePath)) {\n    console.error('CSV file not found:', filePath);\n    process.exit(1);\n  }\n\n  const sa = require(saPath);\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\n\n  const db = admin.firestore();\n  const auth = admin.auth();\n\n  const raw = fs.readFileSync(filePath, 'utf8');\n  const firstLine = raw.split(/\\r?\\n/).find(l => String(l).trim().length > 0) || '';\n  const delimiter = (args.delimiter || '').trim() || guessDelimiter(firstLine);\n\n  const rows = parseCsv(raw, delimiter);\n  if (rows.length === 0) {\n    console.error('No rows found in file');\n    process.exit(1);\n  }\n\n  // Header\n  const header = rows[0].map(normalizeHeaderKey);\n  const hasHeader = header.includes('companyid') && header.includes('email');\n\n  const startIdx = hasHeader ? 1 : 0;\n  const createdPasswords = [];\n\n  const colIndex = (key) => {\n    const k = normalizeHeaderKey(key);\n    return header.indexOf(k);\n  };\n\n  const idx = hasHeader\n    ? {\n        companyId: colIndex('companyId'),\n        companyName: colIndex('companyName'),\n        email: colIndex('email'),\n        firstName: colIndex('firstName'),\n        lastName: colIndex('lastName'),\n        displayName: colIndex('displayName'),\n        role: colIndex('role'),\n        admin: colIndex('admin'),\n        password: colIndex('password'),\n        logoUrl: colIndex('logoUrl'),\n        enabledControlTypes: colIndex('enabledControlTypes'),\n      }\n    : {\n        // Fallback (utan header):\n        // 0 companyId, 1 companyName, 2 email, 3 firstName, 4 lastName, 5 role, 6 admin, 7 password\n        companyId: 0,\n        companyName: 1,\n        email: 2,\n        firstName: 3,\n        lastName: 4,\n        role: 5,\n        admin: 6,\n        password: 7,\n        displayName: -1,\n        logoUrl: -1,\n        enabledControlTypes: -1,\n      };\n\n  const seenCompanies = new Set();\n\n  for (let r = startIdx; r < rows.length; r++) {\n    const row = rows[r];\n\n    const companyId = getCell(row, idx.companyId);\n    if (!companyId) continue;\n\n    const companyName = idx.companyName >= 0 ? getCell(row, idx.companyName) : '';\n\n    if (!seenCompanies.has(companyId)) {\n      seenCompanies.add(companyId);\n      console.log('%s company=%s name=%s', dryRun ? '[dryRun]' : '[upsert]', companyId, companyName || companyId);\n\n      await ensureCompanyBase(db, companyId, companyName || companyId, dryRun);\n\n      const profilePatch = {};\n      // name i profil/public används för PDF-branding\n      profilePatch.name = companyName || companyId;\n\n      const logoUrl = idx.logoUrl >= 0 ? getCell(row, idx.logoUrl) : '';\n      if (logoUrl) profilePatch.logoUrl = logoUrl;\n\n      const enabledRaw = idx.enabledControlTypes >= 0 ? getCell(row, idx.enabledControlTypes) : '';\n      const enabled = splitEnabledTypes(enabledRaw);\n      if (enabled) profilePatch.enabledControlTypes = enabled;\n\n      await upsertCompanyProfile(db, companyId, profilePatch, dryRun);\n    }\n\n    const rowData = {\n      email: getCell(row, idx.email),\n      firstName: idx.firstName >= 0 ? getCell(row, idx.firstName) : '',\n      lastName: idx.lastName >= 0 ? getCell(row, idx.lastName) : '',\n      displayName: idx.displayName >= 0 ? getCell(row, idx.displayName) : '',\n      role: idx.role >= 0 ? getCell(row, idx.role) : 'user',\n      admin: idx.admin >= 0 ? getCell(row, idx.admin) : '',\n      password: idx.password >= 0 ? getCell(row, idx.password) : '',\n    };\n\n    await upsertUserAndMembership({ auth, db, companyId, companyName, rowData, dryRun, createdPasswords });\n  }\n\n  if (createdPasswords.length) {\n    console.log('\\nCreated users/passwords (save these somewhere safe):');\n    createdPasswords.forEach(x => console.log(`- ${x.email} (company=${x.companyId}) password=${x.password}`));\n  }\n\n  console.log('\\nDone.');\n  process.exit(0);\n}\n\nmain().catch((err) => {\n  console.error('Fatal error:', err);\n  process.exit(1);\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/lib/formatPersonName.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/list-foretag.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/migrate-normalize-displayname.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":100,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":100,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/*\n  scripts/migrate-normalize-displayname.js\n\n  Normalizes `displayName` for Firebase Auth users and corresponding\n  Firestore documents (`users/{uid}` and `foretag/{company}/members/{uid}`).\n\n  Usage:\n    node scripts/migrate-normalize-displayname.js --serviceAccount=./konton/demo-service.json [--dryRun=true]\n\n  WARNING: This script updates Auth displayName and Firestore documents.\n  Use --dryRun=true to preview changes first.\n*/\n\nconst fs = require('fs');\nconst path = require('path');\nconst admin = require('firebase-admin');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nfunction toBool(v, fallback) {\n  if (v === undefined) return fallback;\n  const s = String(v).trim().toLowerCase();\n  if (['true','1','yes','y'].includes(s)) return true;\n  if (['false','0','no','n'].includes(s)) return false;\n  return fallback;\n}\n\nconst formatPersonName = require('./lib/formatPersonName');\n\nasync function main() {\n  const args = parseArgs();\n  const sa = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n  const dryRun = toBool(args.dryRun, true);\n\n  if (!sa) {\n    console.error('Provide --serviceAccount or set GOOGLE_APPLICATION_CREDENTIALS');\n    process.exit(1);\n  }\n\n  const saPath = path.resolve(sa);\n  if (!fs.existsSync(saPath)) {\n    console.error('Service account file not found:', saPath);\n    process.exit(1);\n  }\n\n  const saJson = require(saPath);\n  admin.initializeApp({ credential: admin.credential.cert(saJson) });\n  const auth = admin.auth();\n  const db = admin.firestore();\n\n  console.log('[migrate] dryRun=%s serviceAccount=%s', dryRun, saPath);\n\n  let nextPageToken = undefined;\n  let total = 0;\n  let changed = 0;\n  try {\n    do {\n      const res = await auth.listUsers(1000, nextPageToken);\n      nextPageToken = res.pageToken;\n      for (const user of res.users) {\n        total++;\n        const uid = user.uid;\n        const email = (user.email || '').trim();\n        const current = (user.displayName || '').trim();\n        const source = current || email || uid;\n        const normalized = formatPersonName(source);\n\n        if (!normalized || normalized === current) continue;\n\n        console.log('[migrate] WILL UPDATE uid=%s email=%s old=%s new=%s', uid, email, current || '<empty>', normalized);\n        changed++;\n\n        if (!dryRun) {\n          try {\n            await auth.updateUser(uid, { displayName: normalized });\n          } catch(e) {\n            console.warn('[migrate] auth.updateUser failed for uid=%s: %s', uid, e?.message || e);\n          }\n\n          try {\n            await db.collection('users').doc(uid).set({ displayName: normalized, updatedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\n          } catch(e) {\n            console.warn('[migrate] users doc update failed for uid=%s: %s', uid, e?.message || e);\n          }\n\n          // Try to find companyId from custom claims or users doc\n          let companyId = (user.customClaims && user.customClaims.companyId) || null;\n          if (!companyId) {\n            try {\n              const udoc = await db.collection('users').doc(uid).get();\n              if (udoc.exists) companyId = udoc.data()?.companyId || null;\n            } catch(e) {}\n          }\n          if (companyId) {\n            try {\n              await db.collection('foretag').doc(companyId).collection('members').doc(uid).set({ displayName: normalized, updatedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\n            } catch(e) {\n              console.warn('[migrate] member doc update failed for uid=%s company=%s: %s', uid, companyId, e?.message || e);\n            }\n          }\n        }\n      }\n    } while (nextPageToken);\n\n    console.log('[migrate] scanned=%d will-change=%d', total, changed);\n    if (dryRun) console.log('[migrate] dry run complete — no changes applied. Re-run with --dryRun=false to apply.');\n    else console.log('[migrate] migration applied.');\n  } catch(e) {\n    console.error('[migrate] fatal error:', e);\n    process.exit(1);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/provision-company.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":56,"column":124,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":125}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/*\n  scripts/provision-company.js\n  Usage:\n    node scripts/provision-company.js --serviceAccount=./konton/demo-service.json --company=my-company --adminEmail=owner@company.com --adminPassword=Secret123!\n*/\nconst fs = require('fs');\nconst path = require('path');\nconst admin = require('firebase-admin');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nasync function main() {\n  const args = parseArgs();\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n  if (!serviceAccount) {\n    console.error('Provide service account via --serviceAccount or GOOGLE_APPLICATION_CREDENTIALS');\n    process.exit(1);\n  }\n  const saPath = path.resolve(serviceAccount);\n  if (!fs.existsSync(saPath)) { console.error('Service account file not found:', saPath); process.exit(1); }\n  const sa = require(saPath);\n\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\n  const db = admin.firestore();\n  const auth = admin.auth();\n  const formatPersonName = require('./lib/formatPersonName');\n\n  const company = args.company;\n  if (!company) { console.error('--company is required'); process.exit(1); }\n\n  const adminEmail = args.adminEmail;\n  const adminPassword = args.adminPassword || Math.random().toString(36).slice(-8);\n\n  try {\n    // create company doc\n    const companyRef = db.collection('foretag').doc(company);\n    await companyRef.set({ name: company, createdAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\n    console.log('Created or updated company doc:', company);\n\n    // create default templates\n    const templatesRef = companyRef.collection('mallar');\n    await templatesRef.add({ title: 'Tom mall', description: 'Bas-mall att kopiera vid onboarding', createdAt: admin.firestore.FieldValue.serverTimestamp(), items: [] });\n    console.log('Added default template');\n\n    // create admin user if email provided\n    if (adminEmail) {\n      let userRecord;\n      try { userRecord = await auth.getUserByEmail(adminEmail); console.log('Admin user exists:', userRecord.uid); } catch(e) {\n        userRecord = await auth.createUser({ email: adminEmail, password: adminPassword, displayName: formatPersonName(adminEmail.split('@')[0]) });\n        console.log('Created admin user:', userRecord.uid);\n      }\n      await auth.setCustomUserClaims(userRecord.uid, { admin: true, role: 'admin', companyId: company });\n      await db.collection('users').doc(userRecord.uid).set({ companyId: company, role: 'admin', email: adminEmail, createdAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });\n      // Also write to company-scoped members directory for in-app dropdowns (ansvarig)\n      await companyRef.collection('members').doc(userRecord.uid).set({\n        uid: userRecord.uid,\n        companyId: company,\n        role: 'admin',\n        email: adminEmail,\n        displayName: userRecord.displayName || formatPersonName(adminEmail.split('@')[0]),\n        createdAt: admin.firestore.FieldValue.serverTimestamp(),\n        updatedAt: admin.firestore.FieldValue.serverTimestamp(),\n      }, { merge: true });\n      console.log('Provisioned admin user and claims. Password (if created):', adminPassword);\n    }\n\n    console.log('Provisioning complete.');\n    process.exit(0);\n  } catch (err) {\n    console.error('Error provisioning:', err);\n    process.exit(1);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/read-hierarchy.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":41,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":12},{"ruleId":"no-undef","severity":2,"message":"'_e' is not defined.","line":42,"column":47,"nodeType":"Identifier","messageId":"undef","endLine":42,"endColumn":49}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\nconst admin = require('firebase-admin');\nconst fs = require('fs');\nconst path = require('path');\n\nfunction parseArgs() {\n  const args = {};\n  process.argv.slice(2).forEach(a => {\n    const m = a.match(/^--([^=]+)=(.*)$/);\n    if (m) args[m[1]] = m[2];\n  });\n  return args;\n}\n\nasync function main() {\n  const args = parseArgs();\n  const serviceAccount = args.serviceAccount || process.env.GOOGLE_APPLICATION_CREDENTIALS || './konton/demo-service.json';\n  const company = args.company;\n  if (!company) {\n    console.error('--company is required');\n    process.exit(1);\n  }\n  const saPath = path.resolve(serviceAccount);\n  if (!fs.existsSync(saPath)) {\n    console.error('Service account not found:', saPath);\n    process.exit(1);\n  }\n  const sa = require(saPath);\n  admin.initializeApp({ credential: admin.credential.cert(sa) });\n  const db = admin.firestore();\n  try {\n    const ref = db.collection('foretag').doc(company).collection('hierarki').doc('state');\n    const snap = await ref.get();\n    if (!snap.exists) {\n      console.log('No hierarchy document for company:', company);\n      process.exit(0);\n    }\n    const data = snap.data();\n    console.log('Hierarchy for', company, JSON.stringify(data.items, null, 2));\n    process.exit(0);\n  } catch(e) {\n    console.error('Error reading hierarchy:', _e);\n    process.exit(1);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/replace-catch.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/replace_catch_tracked.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/replace_catch_tracked_safe.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'path' is assigned a value but never used.","line":2,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":11,"suggestions":[{"messageId":"removeVar","data":{"varName":"path"},"fix":{"range":[26,55],"text":""},"desc":"Remove unused variable 'path'."}]},{"ruleId":"no-undef","severity":2,"message":"'Buffer' is not defined.","line":30,"column":10,"nodeType":"Identifier","messageId":"undef","endLine":30,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\nconst path = require('path');\nconst cp = require('child_process');\nfunction unquoteGitPath(s){\n  if(!s) return s;\n  if(s[0]==='\"' && s[s.length-1]==='\"'){\n    s = s.slice(1,-1);\n  }\n  // replace octal escapes like \\303\\244 with bytes\n  const parts = s.split('\\\\');\n  if(parts.length===1) return s;\n  let bytes = [];\n  for(let i=0;i<parts.length;i++){\n    if(i===0){\n      // leading part\n      for(const ch of parts[0]) bytes.push(ch.charCodeAt(0));\n    } else {\n      const oct = parts[i].slice(0,3);\n      if(/^[0-7]{3}$/.test(oct)){\n        bytes.push(parseInt(oct,8));\n        const rest = parts[i].slice(3);\n        for(const ch of rest) bytes.push(ch.charCodeAt(0));\n      } else {\n        // not an octal escape, put back the backslash and part\n        bytes.push(92); // '\\'\n        for(const ch of parts[i]) bytes.push(ch.charCodeAt(0));\n      }\n    }\n  }\n  return Buffer.from(bytes).toString('utf8');\n}\ntry{\n  const files = cp.execSync('git ls-files \"*.js\" \"*.jsx\" \"*.ts\" \"*.tsx\"',{encoding:'utf8'})\n    .split(/\\r?\\n/).filter(Boolean);\n  files.forEach(f0=>{\n    const f = unquoteGitPath(f0);\n    try{\n      const s = fs.readFileSync(f,'utf8');\n      const ns = s.replace(/catch\\(\\s*\\(\\)\\s*=>/g,'catch((e) =>');\n      if(ns!==s){ fs.writeFileSync(f,ns,'utf8'); console.log('Updated',f); }\n    }catch(err){ console.error('ERR',f,err.message); }\n  });\n}catch(err){ console.error('fatal',err.message); process.exit(1); }\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/replace_underscore_more.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/replace_underscore_paren.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/reset-project.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/revert_unused_e_catches.js","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'edits' is assigned a value but never used.","line":25,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"edits"},"fix":{"range":[748,765],"text":""},"desc":"Remove unused variable 'edits'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"const fs = require('fs');\nconst cp = require('child_process');\nfunction listFiles(){\n  return cp.execSync('git ls-files \"*.js\" \"*.jsx\" \"*.ts\" \"*.tsx\"',{encoding:'utf8'})\n    .split(/\\r?\\n/).filter(Boolean).map(s=> (s[0]==='\"' && s[s.length-1]==='\"')?s.slice(1,-1):s);\n}\nfunction findMatchingBrace(src, start){\n  // start points at index of '{'\n  let depth = 0;\n  for(let i=start;i<src.length;i++){\n    if(src[i]==='{') depth++;\n    else if(src[i]==='}'){\n      depth--;\n      if(depth===0) return i;\n    }\n  }\n  return -1;\n}\nfunction processFile(path){\n  let s = fs.readFileSync(path,'utf8');\n  let changed = false;\n  // regex to find catch with e param (various forms)\n  const re = /catch\\s*\\(\\s*(?:\\(?\\s*e\\s*\\)?)([^)]*)\\)\\s*(?:=>)?/g;\n  let m;\n  const edits = [];\n  while((m=re.exec(s))!==null){\n    const idx = m.index;\n    const after = re.lastIndex;\n    // determine body start\n    let bodyStart = after;\n    // skip spaces\n    while(bodyStart < s.length && /[\\s]/.test(s[bodyStart])) bodyStart++;\n    if(s[bodyStart]==='='){\n      // arrow function '=>' case, move past =>\n      if(s.substr(bodyStart,2)==='=>' ){\n        bodyStart += 2;\n        while(bodyStart < s.length && /[\\s]/.test(s[bodyStart])) bodyStart++;\n      }\n    }\n    if(s[bodyStart]==='{'){\n      const end = findMatchingBrace(s, bodyStart);\n      if(end===-1) continue;\n      const body = s.slice(bodyStart, end+1);\n      if(!/\\b e\\b|\\be\\.|\\be\\?\\.|\\be\\(/.test(body) && !/\\be\\s*[^=]/.test(body)){\n        // e not used in body -> replace param 'e' with '_e'\n        // replace only the first 'e' after 'catch('\n        const before = s.slice(0, idx);\n        const segment = s.slice(idx, after);\n        const newSegment = segment.replace(/\\bcatch\\s*\\(\\s*\\(?\\s*e\\s*\\)?/,'catch(_e');\n        s = before + newSegment + s.slice(after);\n        changed = true;\n        // move regex pointer forward to avoid infinite loop\n        re.lastIndex = idx + newSegment.length + (s.length - (after));\n      }\n    } else {\n      // expression body, check until semicolon or newline\n      const endPos = s.indexOf('\\n', bodyStart) === -1 ? s.length : s.indexOf('\\n', bodyStart);\n      const body = s.slice(bodyStart, endPos);\n      if(!/\\be\\b|\\be\\.|\\be\\?\\./.test(body)){\n        const before = s.slice(0, idx);\n        const segment = s.slice(idx, after);\n        const newSegment = segment.replace(/\\bcatch\\s*\\(\\s*\\(?\\s*e\\s*\\)?/,'catch(_e');\n        s = before + newSegment + s.slice(after);\n        changed = true;\n        re.lastIndex = idx + newSegment.length;\n      }\n    }\n  }\n  if(changed){ fs.writeFileSync(path, s, 'utf8'); console.log('Patched', path); }\n}\ntry{\n  const files = listFiles();\n  files.forEach(processFile);\n  console.log('Done');\n}catch(err){ console.error(err.message); process.exit(1); }\n","usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/seed-hierarchy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/seed-testdata.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/set-company-claim.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/marcusskogh/MS Byggsystem/05 - Projekt/Digitalkontroll/Kod/Digitalkontroll/scripts/set-enabled-control-types.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
