rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isCompanyMember(company) {
      return request.auth != null
        && (
          request.auth.token.companyId == company
          || (
            exists(/databases/$(database)/documents/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == company
          )
        );
    }

    function isGlobalAdmin() {
      return request.auth != null
        && (
          // Token-baserade superadmins
          request.auth.token.globalAdmin == true ||
          request.auth.token.superadmin == true ||
          request.auth.token.role == 'superadmin' ||
          // Admin i MS Byggsystem
          (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin')) ||
          // Whitelist specifika superadmin-mail för robusthet
          request.auth.token.email == 'marcus@msbyggsystem.se' ||
          request.auth.token.email == 'marcus.skogh@msbyggsystem.se' ||
          request.auth.token.email == 'marcus.skogh@msbyggsystem'
        );
    }

    // Allow read for hierarchy; writes only when authenticated and token.companyId matches path
    match /foretag/{company}/hierarki/state {
      allow read: if true;
      allow write: if isCompanyMember(company);
    }
    
    // Backup documents for hierarchy (automatic backups before saves)
    match /foretag/{company}/hierarki/{backupId} {
      allow read: if isCompanyMember(company) && backupId.matches('backup_.*');
      allow create, update: if isCompanyMember(company) && backupId.matches('backup_.*');
      allow delete: if isCompanyMember(company) && backupId.matches('backup_.*');
    }

    // Controls (completed)
    match /foretag/{company}/controls/{controlId} {
      allow read, write: if isCompanyMember(company);
    }

    // Controls (drafts)
    match /foretag/{company}/draft_controls/{draftId} {
      allow read, write: if isCompanyMember(company);
    }

    // Company profile (public by convention)
    match /foretag/{company}/profil/{docId} {
      allow read: if true;
      // Only allow creation of a new company profile by callers that are authorized to create companies.
      // This requires either a superadmin claim or being an admin in MS Byggsystem.
      allow create: if request.auth != null && !exists(/databases/$(database)/documents/foretag/$(company)/profil/$(docId))
        && request.resource.data.companyName is string
        && (
          // superadmin claim
          (request.auth.token.superadmin == true) || (request.auth.token.role == 'superadmin')
          // or admin inside MS Byggsystem
          || (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin'))
        );
      // Allow updates both for members of the company and for global superadmins / MS Byggsystem-admins.
      allow update, delete: if isCompanyMember(company)
        || (
          request.auth != null && (
            (request.auth.token.superadmin == true) || (request.auth.token.role == 'superadmin')
            || (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin'))
          )
        );
    }

    // Allow collection group queries on any "profil" subcollection (used to list companies
    // by reading their public profiles). Read-only; writes are still governed by the more
    // specific /foretag/{company}/profil/{docId} rule above.
    match /{path=**}/profil/{docId} {
      allow read: if true;
    }

    // Byggdel mall-register (company-scoped)
    match /foretag/{company}/byggdel_mallar/{mallId} {
      allow read, write: if isCompanyMember(company);
    }

    // Byggdel hierarki (company-scoped)
    match /foretag/{company}/byggdel_hierarki/state {
      allow read, write: if isCompanyMember(company);
    }

    // Företags-specifika kontrolltyper (company-scoped)
    // Används av adminvyn "Kontrolltyper" samt vid skapande av nya kontrollpunkter.
    // Läsning tillåts både för medlemmar i företaget och för globala admins
    // (superadmin eller MS Byggsystem-admin) så att centrala admins kan se
    // vilka kontrolltyper som används hos alla företag.
    match /foretag/{company}/kontrolltyper/{typeId} {
      allow read: if isCompanyMember(company)
        || (
          request.auth != null && (
            // Token-baserade superadmins
            request.auth.token.superadmin == true ||
            request.auth.token.role == 'superadmin' ||
            // Admin i MS Byggsystem
            (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin')) ||
            // Whitelist specifika superadmin-mail för robusthet
            request.auth.token.email == 'marcus@msbyggsystem.se' ||
            request.auth.token.email == 'marcus.skogh@msbyggsystem.se' ||
            request.auth.token.email == 'marcus.skogh@msbyggsystem'
          )
        );
      // Skriv-rättigheter lämnas företags-lokala; bara medlemmar kan ändra
      // sina egna företags kontrolltyper.
      allow write: if isCompanyMember(company);
    }

    // Företags-specifika mallar (company-scoped)
    // Används av adminvyn "Mallar" för att skapa och hantera mallar per kontrolltyp.
    match /foretag/{company}/mallar/{mallId} {
      allow read, write: if isCompanyMember(company);
    }

    // Företags-specifika kontrolltyp-mappar (company-scoped)
    // Används för att organisera mallar per kontrolltyp i mappar.
    match /foretag/{company}/kontrolltyp_mappar/{folderId} {
      allow read, write: if isCompanyMember(company);
    }

    // Kontaktregister (company-scoped)
    // Varje företag har sitt eget register: foretag/{company}/kontakter/{contactId}
    // Globala admins (superadmin/MS Byggsystem-admin) ska kunna hantera kontakter för alla företag.
    match /foretag/{company}/kontakter/{contactId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // Leverantörer (company-scoped)
    // Varje företag har sitt eget register: foretag/{company}/leverantorer/{supplierId}
    // Globala admins (superadmin/MS Byggsystem-admin) ska kunna hantera leverantörer för alla företag.
    match /foretag/{company}/leverantorer/{supplierId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // Company members directory (company-scoped)
    // Used for listing admins/roles in the app without enabling cross-company user queries.
    match /foretag/{company}/members/{uid} {
      allow read: if isCompanyMember(company);
      allow create, update: if request.auth != null
        && request.auth.uid == uid
        && isCompanyMember(company);
      allow delete: if false;
    }

    // Company activity feed (company-scoped)
    // Used by dashboard "Senaste aktivitet" (e.g. login events)
    match /foretag/{company}/activity/{eventId} {
      allow read, write: if isCompanyMember(company);
    }

    // Global admin audit log (read-only for superadmins / MS Byggsystem-admins)
    match /admin_audit/{eventId} {
      allow read: if request.auth != null && (
        // Token-baserade superadmins
        request.auth.token.superadmin == true ||
        request.auth.token.role == 'superadmin' ||
        // Admin i MS Byggsystem
        (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin')) ||
        // Whitelist specifika superadmin-mail så att läsrätt inte bryts om companyId-claimen skulle peka på annat företag.
        request.auth.token.email == 'marcus@msbyggsystem.se' ||
        request.auth.token.email == 'marcus.skogh@msbyggsystem.se' ||
        request.auth.token.email == 'marcus.skogh@msbyggsystem'
      );
      allow write: if false; // only server-side (admin SDK) writes
    }

    // Allow users to read/write their own profile doc
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      // Users may update their own profile, but may NOT change companyId client-side.
      allow create: if request.auth != null
        && request.auth.uid == uid
        && request.auth.token.companyId != null
        && request.resource.data.companyId == request.auth.token.companyId;
      allow update: if request.auth != null
        && request.auth.uid == uid
        && request.resource.data.companyId == resource.data.companyId;
      allow delete: if false;
    }

    // Project phase navigation (company-scoped, project-specific)
    // Used for storing custom navigation structures for each project phase
    match /foretag/{company}/projects/{projectId}/phaseNavigation/{phaseKey} {
      allow read, write: if isCompanyMember(company);
    }

    // Phase navigation (company-wide, not per project)
    // Used for storing custom navigation structures shared across all projects in a company
    match /foretag/{company}/phaseNavigation/{phaseKey} {
      allow read: if isCompanyMember(company) || isGlobalAdmin();
      allow write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // Project phase data (company-scoped, project-specific)
    // Used for storing phase-specific data like completions, progress, etc.
    match /foretag/{company}/projects/{projectId}/phaseData/{phaseKey} {
      allow read, write: if isCompanyMember(company);
    }

    // Project phase data subcollections (company-scoped, project-specific)
    // Needed for storing richer phase-specific data under a phase doc, e.g.:
    // foretag/{company}/projects/{projectId}/phaseData/kalkylskede/fragaSvar/{docId}
    match /foretag/{company}/projects/{projectId}/phaseData/{phaseKey}/{document=**} {
      allow read, write: if isCompanyMember(company);
    }

    // Project organisation (company-scoped, project-specific)
    // Used by "Organisation och roller" (Översikt) for custom groups and members.
    // Collection: foretag/{company}/project_organisation/{projectId}
    match /foretag/{company}/project_organisation/{projectId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // Project timeline (company-scoped, project-specific)
    // Used by "Tidsplan och viktiga datum" (Översikt) for custom dates and site visits.
    // Collection: foretag/{company}/project_timeline/{projectId}
    match /foretag/{company}/project_timeline/{projectId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // Projects (company-scoped)
    // Firestore is the source of truth for which projects exist and how they map to SharePoint.
    // Collection: foretag/{company}/projects/{projectId}
    match /foretag/{company}/projects/{projectId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // SharePoint navigation configuration per company
    // Used by adminvyn "SharePoint Navigation" och av vänsterpanelen på startsidan.
    // Medlemmar i företaget får hantera sin egen navigation, och globala admins
    // (superadmin / MS Byggsystem-admin) får hantera alla företags navigation.
    match /foretag/{company}/sharepoint_navigation/{docId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }

    // SharePoint site metadata per company (visibility/role)
    // Digitalkontroll owns which sites are visible in the left panel.
    // Collection: foretag/{company}/sharepoint_sites/{siteId}
    match /foretag/{company}/sharepoint_sites/{siteId} {
      allow read: if isCompanyMember(company) || isGlobalAdmin();
      // Writes should be system-controlled (cloud functions / global admins).
      allow create, update, delete: if isGlobalAdmin();
    }

    // SharePoint system configuration per company (base/workspace sites)
    // This must be hidden from company admins/users.
    match /foretag/{company}/sharepoint_system/{docId} {
      allow read, write: if isGlobalAdmin();
    }

    // SharePoint project metadata (company-scoped)
    // Used for phase/structure indicators per SharePoint-backed project folder.
    // Collection: foretag/{company}/sharepoint_project_metadata/{docId}
    match /foretag/{company}/sharepoint_project_metadata/{docId} {
      allow read, write: if isCompanyMember(company) || isGlobalAdmin();
    }
  }
}
