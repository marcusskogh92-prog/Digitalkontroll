rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isCompanyMember(company) {
      return request.auth != null
        && (
          request.auth.token.companyId == company
          || (
            exists(/databases/$(database)/documents/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == company
          )
        );
    }

    // Allow read for hierarchy; writes only when authenticated and token.companyId matches path
    match /foretag/{company}/hierarki/state {
      allow read: if true;
      allow write: if isCompanyMember(company);
    }

    // Controls (completed)
    match /foretag/{company}/controls/{controlId} {
      allow read, write: if isCompanyMember(company);
    }

    // Controls (drafts)
    match /foretag/{company}/draft_controls/{draftId} {
      allow read, write: if isCompanyMember(company);
    }

    // Company profile (public by convention)
    match /foretag/{company}/profil/{docId} {
      allow read: if true;
      // Only allow creation of a new company profile by callers that are authorized to create companies.
      // This requires either a superadmin claim or being an admin in MS Byggsystem.
      allow create: if request.auth != null && !exists(/databases/$(database)/documents/foretag/$(company)/profil/$(docId))
        && request.resource.data.companyName is string
        && (
          // superadmin claim
          (request.auth.token.superadmin == true) || (request.auth.token.role == 'superadmin')
          // or admin inside MS Byggsystem
          || (request.auth.token.companyId == 'MS Byggsystem' && (request.auth.token.admin == true || request.auth.token.role == 'admin'))
        );
      allow update, delete: if isCompanyMember(company);
    }

    // Byggdel mall-register (company-scoped)
    match /foretag/{company}/byggdel_mallar/{mallId} {
      allow read, write: if isCompanyMember(company);
    }

    // Byggdel hierarki (company-scoped)
    match /foretag/{company}/byggdel_hierarki/state {
      allow read, write: if isCompanyMember(company);
    }

    // Company members directory (company-scoped)
    // Used for listing admins/roles in the app without enabling cross-company user queries.
    match /foretag/{company}/members/{uid} {
      allow read: if isCompanyMember(company);
      allow create, update: if request.auth != null
        && request.auth.uid == uid
        && isCompanyMember(company);
      allow delete: if false;
    }

    // Company activity feed (company-scoped)
    // Used by dashboard "Senaste aktivitet" (e.g. login events)
    match /foretag/{company}/activity/{eventId} {
      allow read, write: if isCompanyMember(company);
    }

    // Allow users to read/write their own profile doc
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      // Users may update their own profile, but may NOT change companyId client-side.
      allow create: if request.auth != null
        && request.auth.uid == uid
        && request.auth.token.companyId != null
        && request.resource.data.companyId == request.auth.token.companyId;
      allow update: if request.auth != null
        && request.auth.uid == uid
        && request.resource.data.companyId == resource.data.companyId;
      allow delete: if false;
    }
  }
}
